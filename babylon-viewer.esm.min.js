function e$z(e,t,i,s){var r,n=arguments.length,a=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(n<3?r(a):n>3?r(t,i,a):r(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a}"function"==typeof SuppressedError&&SuppressedError;const t$1k={},i$1j={};function s$v(e){const s=e.getClassName();if(t$1k[s])return t$1k[s];t$1k[s]={};const r=t$1k[s];let n=e,a=s;for(;a;){const e=i$1j[a];for(const t in e)r[t]=e[t];let t,s=false;do{if(t=Object.getPrototypeOf(n),!t.getClassName){s=true;break}if(t.getClassName()!==a)break;n=t;}while(t);if(s)break;a=t.getClassName(),n=t;}return r}function r$1U(e,t){return (s,r)=>{const n=function(e){const t=e.getClassName();return i$1j[t]||(i$1j[t]={}),i$1j[t]}(s);n[r]||(n[r]={type:e,sourceName:t});}}function n$1W(e,t=null){return function(e,t=null){return (i,s)=>{const r=t||"_"+s;Object.defineProperty(i,s,{get:function(){return this[r]},set:function(t){"function"==typeof this[r]?.equals&&this[r].equals(t)||this[r]!==t&&(this[r]=t,i[e].apply(this));},enumerable:true,configurable:true});}}(e,t)}function a$$(e){return r$1U(0,e)}function o$19(e){return r$1U(1,e)}function h$c(e){return r$1U(2,e)}function l$r(e){return r$1U(3,e)}function c$o(e){return r$1U(4,e)}function u$s(e){return r$1U(5,e)}function d$u(e){return r$1U(6,e)}function _$j(e){return r$1U(8,e)}function f$z(e){return r$1U(9,e)}function p$p(e){return r$1U(12,e)}function g$j(e,t,i,s){const r=i.value;i.value=(...i)=>{let n=r;if("undefined"!=typeof _native&&_native[t]){const e=_native[t];n=s?(...t)=>s(...t)?e(...t):r(...t):e;}return e[t]=n,n(...i)};}function m$q(e,t=null){return (i,s)=>{const r=s,n=t||"";Object.defineProperty(i,n,{get:function(){return this[r].value},set:function(t){"function"==typeof this[r]?.value?.equals&&this[r].value.equals(t)||this[r].value!==t&&(this[r].value=t,i[e].apply(this));},enumerable:true,configurable:true});}}g$j.filter=function(e){return (t,i,s)=>g$j(t,i,s,e)};const T$g="undefined"!=typeof WeakRef;let E$m=class E{constructor(e,t=false,i,s){this.initialize(e,t,i,s);}initialize(e,t=false,i,s){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=s,this}};let A$f=class A{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=false,this.unregisterOnNextCall=false,this._remove=null;}remove(e=false){this._remove&&this._remove(e);}};let R$g=class R{static FromPromise(e,t){const i=new R;return e.then((e=>{i.notifyObservers(e);})).catch((e=>{if(!t)throw e;t.notifyObservers(e);})),i}get observers(){return this._observers}constructor(e,t=false){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=false,this._eventState=new E$m(0),e&&(this._onObserverAdded=e);}add(e,t=-1,i=false,s=null,r=false){if(!e)return null;const n=new A$f(e,t,s);n.unregisterOnNextCall=r,i?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),this._hasNotified&&this.notifyIfTriggered&&void 0!==this._lastNotifiedValue&&this.notifyObserver(n,this._lastNotifiedValue);const a=T$g?new WeakRef(this):{deref:()=>this};return n._remove=(e=false)=>{const t=a.deref();t&&(e?t.remove(n):t._remove(n));},n}addOnce(e){return this.add(e,void 0,void 0,void 0,true)}remove(e){if(!e)return  false;e._remove=null;return  -1!==this._observers.indexOf(e)&&(this._deferUnregister(e),true)}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const s=this._observers[i];if(!s._willBeUnregistered&&(s.callback===e&&(!t||t===s.scope)))return this._deferUnregister(s),true}return  false}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=false,e._willBeUnregistered=true,setTimeout((()=>{this._remove(e);}),0));}_remove(e,t=true){if(!e)return  false;const i=this._observers.indexOf(e);return  -1!==i&&(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),true)}makeObserverTopPriority(e){this._remove(e,false),this._observers.unshift(e);}makeObserverBottomPriority(e){this._remove(e,false),this._observers.push(e);}notifyObservers(e,t=-1,i,s,r){if(this.notifyIfTriggered&&(this._hasNotified=true,this._lastNotifiedValue=e),!this._observers.length)return  true;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=s,n.skipNextObservers=false,n.lastReturnValue=e,n.userInfo=r;for(const i of this._observers)if(!i._willBeUnregistered&&(i.mask&t&&(i.unregisterOnNextCall&&this._deferUnregister(i),i.scope?n.lastReturnValue=i.callback.apply(i.scope,[e,n]):n.lastReturnValue=i.callback(e,n)),n.skipNextObservers))return  false;return  true}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=true,this._lastNotifiedValue=t),e._willBeUnregistered)return;const s=this._eventState;s.mask=i,s.skipNextObservers=false,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,s);}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null);}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState();}cleanLastNotifiedState(){this._hasNotified=false,this._lastNotifiedValue=void 0;}clone(){const e=new R;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return  true;return  false}};const b$f=1/2.2,S$d=2.2,x$d=.001;function M$d(e,t){const i=[];for(let s=0;s<e;++s)i.push(t());return i}function y$e(e,t){return M$d(e,t)}const I$f=["push","splice","pop","shift","unshift"];function C$e(e,t){const i=I$f.map((i=>function(e,t,i){const s=e[t];if("function"!=typeof s)return null;const r=function(){const s=e.length,n=r.previous.apply(e,arguments);return i(t,s),n};return s.next=r,r.previous=s,e[t]=r,()=>{const i=r.previous;if(!i)return;const s=r.next;s?(i.next=s,s.previous=i):(i.next=void 0,e[t]=i),r.next=void 0,r.previous=void 0;}}(e,i,t)));return ()=>{for(const e of i)e?.();}}const v$d={};function P$9(e,t){v$d[e]=t;}function O$g(e){return v$d[e]}let D$9=class D{static SetMatrixPrecision(e){if(D.MatrixTrackPrecisionChange=false,e&&!D.MatrixUse64Bits&&D.MatrixTrackedMatrices)for(let e=0;e<D.MatrixTrackedMatrices.length;++e){const t=D.MatrixTrackedMatrices[e],i=t._m;t._m=new Array(16);for(let e=0;e<16;++e)t._m[e]=i[e];}D.MatrixUse64Bits=e,D.MatrixCurrentType=D.MatrixUse64Bits?Array:Float32Array,D.MatrixTrackedMatrices=null;}};D$9.MatrixUse64Bits=false,D$9.MatrixTrackPrecisionChange=true,D$9.MatrixCurrentType=Float32Array,D$9.MatrixTrackedMatrices=[];let L$7=class L{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}};function F$8(e,t,i=1401298e-51){return Math.abs(e-t)<=i}function w$8(e,t){return e===t?e:Math.random()*(t-e)+e}function N$c(e,t,i){return e+(t-e)*i}function B$7(e,t,i,s,r){const n=r*r,a=r*n;return e*(2*a-3*n+1)+i*(-2*a+3*n)+t*(a-2*n+r)+s*(a-n)}function U$5(e,t=0,i=1){return Math.min(i,Math.max(t,e))}function k$7(e){return e-=2*Math.PI*Math.floor((e+Math.PI)/(2*Math.PI))}function G$4(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}function V$8(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(0===e)return  -1/0;let t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t;}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}function H$5(e,t){return e-Math.floor(e/t)*t}function z$7(e,t){let i=H$5(t-e,360);return i>180&&(i-=360),i}function X$4(e,t,i){let s=0;return s=Math.abs(t-e)<=i?t:e+Math.sign(t-e)*i,s}function W$4(e,t){const i=e%t;return 0===i?t:W$4(t,i)}L$7.Instances=[],L$7.OnEnginesDisposedObservable=new R$g,L$7._LastCreatedScene=null,L$7.UseFallbackTexture=true,L$7.FallbackTexture="";var Y$5=Object.freeze({__proto__:null,Clamp:U$5,DeltaAngle:z$7,Denormalize:function(e,t,i){return e*(i-t)+t},ExtractAsInt:function(e){return parseInt(e.toString().replace(/\W/g,""))},Hermite:B$7,Hermite1stDerivative:function(e,t,i,s,r){const n=r*r;return 6*(n-r)*e+(3*n-4*r+1)*t+6*(-n+r)*i+(3*n-2*r)*s},HighestCommonFactor:W$4,ILog2:V$8,InverseLerp:function(e,t,i){let s=0;return s=e!=t?U$5((i-e)/(t-e)):0,s},Lerp:N$c,LerpAngle:function(e,t,i){let s=H$5(t-e,360);return s>180&&(s-=360),e+s*U$5(i)},MoveTowards:X$4,MoveTowardsAngle:function(e,t,i){const s=z$7(e,t);let r=0;return r=-i<s&&s<i?t:X$4(e,t=e+s,i),r},Normalize:function(e,t,i){return (e-t)/(i-t)},NormalizeRadians:k$7,OutsideRange:function(e,t,i,s=1401298e-51){return e<t-s||e>i+s},PercentToRange:function(e,t,i){return (i-t)*e+t},PingPong:function(e,t){const i=H$5(e,2*t);return t-Math.abs(i-t)},RandomRange:w$8,RangeToPercent:function(e,t,i){return (e-t)/(i-t)},Repeat:H$5,SmoothStep:function(e,t,i){let s=U$5(i);return s=-2*s*s*s+3*s*s,t*s+e*(1-s)},ToHex:G$4,WithinEpsilon:F$8});let K$5=class K{};function j$5(e){e.updateFlag=K$5._UpdateFlagSeed++;}function Q$6(e,t,i,s=0){const r=e.asArray(),n=t.asArray(),a=r[0],o=r[1],h=r[2],l=r[3],c=r[4],u=r[5],d=r[6],_=r[7],f=r[8],p=r[9],g=r[10],m=r[11],T=r[12],E=r[13],A=r[14],R=r[15],b=n[0],S=n[1],x=n[2],M=n[3],y=n[4],I=n[5],C=n[6],v=n[7],P=n[8],O=n[9],D=n[10],L=n[11],F=n[12],w=n[13],N=n[14],B=n[15];i[s]=a*b+o*y+h*P+l*F,i[s+1]=a*S+o*I+h*O+l*w,i[s+2]=a*x+o*C+h*D+l*N,i[s+3]=a*M+o*v+h*L+l*B,i[s+4]=c*b+u*y+d*P+_*F,i[s+5]=c*S+u*I+d*O+_*w,i[s+6]=c*x+u*C+d*D+_*N,i[s+7]=c*M+u*v+d*L+_*B,i[s+8]=f*b+p*y+g*P+m*F,i[s+9]=f*S+p*I+g*O+m*w,i[s+10]=f*x+p*C+g*D+m*N,i[s+11]=f*M+p*v+g*L+m*B,i[s+12]=T*b+E*y+A*P+R*F,i[s+13]=T*S+E*I+A*O+R*w,i[s+14]=T*x+E*C+A*D+R*N,i[s+15]=T*M+E*v+A*L+R*B;}function q$5(e,t,i,s=0){Q$6(e,t,i.asArray(),s),j$5(i);}function Z$3(e,t){const i=J$5(e,t.asArray());return i&&j$5(t),i}function J$5(e,t){const i=e.asArray(),s=i[0],r=i[1],n=i[2],a=i[3],o=i[4],h=i[5],l=i[6],c=i[7],u=i[8],d=i[9],_=i[10],f=i[11],p=i[12],g=i[13],m=i[14],T=i[15],E=_*T-m*f,A=d*T-g*f,R=d*m-g*_,b=u*T-p*f,S=u*m-_*p,x=u*g-p*d,M=+(h*E-l*A+c*R),y=-(o*E-l*b+c*S),I=+(o*A-h*b+c*x),C=-(o*R-h*S+l*x),v=s*M+r*y+n*I+a*C;if(0===v)return  false;const P=1/v,O=l*T-m*c,D=h*T-g*c,L=h*m-g*l,F=o*T-p*c,w=o*m-p*l,N=o*g-p*h,B=l*f-_*c,U=h*f-d*c,k=h*_-d*l,G=o*f-u*c,V=o*_-u*l,H=o*d-u*h,z=-(r*E-n*A+a*R),X=+(s*E-n*b+a*S),W=-(s*A-r*b+a*x),Y=+(s*R-r*S+n*x),K=+(r*O-n*D+a*L),j=-(s*O-n*F+a*w),Q=+(s*D-r*F+a*N),q=-(s*L-r*w+n*N),Z=-(r*B-n*U+a*k),J=+(s*B-n*G+a*V),$=-(s*U-r*G+a*H),ee=+(s*k-r*V+n*H);return t[0]=M*P,t[1]=z*P,t[2]=K*P,t[3]=Z*P,t[4]=y*P,t[5]=X*P,t[6]=j*P,t[7]=J*P,t[8]=I*P,t[9]=W*P,t[10]=Q*P,t[11]=$*P,t[12]=C*P,t[13]=Y*P,t[14]=q*P,t[15]=ee*P,true}K$5._UpdateFlagSeed=0;const $$5=e=>parseInt(e.toString().replace(/\W/g,""));let ee$4=class ee{constructor(e=0,t=0){this.x=e,this.y=t;}toString(){return `{X: ${this.x} Y: ${this.y}}`}getClassName(){return "Vector2"}getHashCode(){let e=$$5(this.x);return e=397*e^$$5(this.y),e}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return ee.FromArrayToRef(e,t,this),this}asArray(){return [this.x,this.y]}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}setAll(e){return this.copyFromFloats(e,e)}add(e){return new ee(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addInPlaceFromFloats(e,t){return this.x+=e,this.y+=t,this}addVector3(e){return new ee(this.x+e.x,this.y+e.y)}subtract(e){return new ee(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new ee(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new ee(this.x*e,this.y*t)}divide(e){return new ee(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.x,e.y)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.x,e.y)}minimizeInPlaceFromFloats(e,t){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this}maximizeInPlaceFromFloats(e,t){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this}subtractFromFloats(e,t){return new ee(this.x-e,this.y-t)}subtractFromFloatsToRef(e,t,i){return i.x=this.x-e,i.y=this.y-t,i}negate(){return new ee(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){return new ee(this.x*e,this.y*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=.001){return e&&F$8(this.x,e.x,t)&&F$8(this.y,e.y,t)}equalsToFloats(e,t){return this.x===e&&this.y===t}floor(){return new ee(Math.floor(this.x),Math.floor(this.y))}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e}fract(){return new ee(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e}rotate(e){return this.rotateToRef(e,new ee)}rotateToRef(e,t){const i=Math.cos(e),s=Math.sin(e);return t.x=i*this.x-s*this.y,t.y=s*this.x+i*this.y,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new ee;return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t&&(e.x=this.x,e.y=this.y),this.scaleToRef(1/t,e)}clone(){return new ee(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new ee(0,0)}static One(){return new ee(1,1)}static Random(e=0,t=1){return new ee(w$8(e,t),w$8(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(w$8(e,t),w$8(e,t))}static get ZeroReadOnly(){return ee._ZeroReadOnly}static FromArray(e,t=0){return new ee(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static FromFloatsToRef(e,t,i){return i.copyFromFloats(e,t),i}static CatmullRom(e,t,i,s,r){const n=r*r,a=r*n,o=.5*(2*t.x+(-e.x+i.x)*r+(2*e.x-5*t.x+4*i.x-s.x)*n+(-e.x+3*t.x-3*i.x+s.x)*a),h=.5*(2*t.y+(-e.y+i.y)*r+(2*e.y-5*t.y+4*i.y-s.y)*n+(-e.y+3*t.y-3*i.y+s.y)*a);return new ee(o,h)}static ClampToRef(e,t,i,s){return s.x=U$5(e.x,t.x,i.x),s.y=U$5(e.y,t.y,i.y),s}static Clamp(e,t,i){const s=U$5(e.x,t.x,i.x),r=U$5(e.y,t.y,i.y);return new ee(s,r)}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+r,c=a-n,u=e.x*o+i.x*h+t.x*l+s.x*c,d=e.y*o+i.y*h+t.y*l+s.y*c;return new ee(u,d)}static Hermite1stDerivative(e,t,i,s,r){return this.Hermite1stDerivativeToRef(e,t,i,s,r,new ee)}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;return n.x=6*(a-r)*e.x+(3*a-4*r+1)*t.x+6*(-a+r)*i.x+(3*a-2*r)*s.x,n.y=6*(a-r)*e.y+(3*a-4*r+1)*t.y+6*(-a+r)*i.y+(3*a-2*r)*s.y,n}static Lerp(e,t,i){return ee.LerpToRef(e,t,i,new ee)}static LerpToRef(e,t,i,s){return s.x=e.x+(t.x-e.x)*i,s.y=e.y+(t.y-e.y)*i,s}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){return ee.NormalizeToRef(e,new ee)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,s=e.y<t.y?e.y:t.y;return new ee(i,s)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,s=e.y>t.y?e.y:t.y;return new ee(i,s)}static Transform(e,t){return ee.TransformToRef(e,t,new ee)}static TransformToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+s[12],n=e.x*s[1]+e.y*s[5]+s[13];return i.x=r,i.y=n,i}static PointInTriangle(e,t,i,s){const r=.5*(-i.y*s.x+t.y*(-i.x+s.x)+t.x*(i.y-s.y)+i.x*s.y),n=r<0?-1:1,a=(t.y*s.x-t.x*s.y+(s.y-t.y)*e.x+(t.x-s.x)*e.y)*n,o=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*n;return a>0&&o>0&&a+o<2*r*n}static Distance(e,t){return Math.sqrt(ee.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y;return i*i+s*s}static Center(e,t){return ee.CenterToRef(e,t,new ee)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const s=ee.DistanceSquared(t,i);if(0===s)return ee.Distance(e,t);const r=i.subtract(t),n=Math.max(0,Math.min(1,ee.Dot(e.subtract(t),r)/s)),a=t.add(r.multiplyByFloats(n,n));return ee.Distance(e,a)}};ee$4._V8PerformanceHack=new ee$4(.5,.5),ee$4._ZeroReadOnly=ee$4.Zero(),Object.defineProperties(ee$4.prototype,{dimension:{value:[2]},rank:{value:1}});let te$4=class te{get x(){return this._x}set x(e){this._x=e,this._isDirty=true;}get y(){return this._y}set y(e){this._y=e,this._isDirty=true;}get z(){return this._z}set z(e){this._z=e,this._isDirty=true;}constructor(e=0,t=0,i=0){this._isDirty=true,this._x=e,this._y=t,this._z=i;}toString(){return `{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return "Vector3"}getHashCode(){let e=$$5(this._x);return e=397*e^$$5(this._y),e=397*e^$$5(this._z),e}asArray(){return [this._x,this._y,this._z]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return te.FromArrayToRef(e,t,this),this}toQuaternion(){return se$5.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._isDirty=true,this}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=true,this}add(e){return new te(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._isDirty=true,t}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=true,this}subtract(e){return new te(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new te(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,s){return s._x=this._x-e,s._y=this._y-t,s._z=this._z-i,s._isDirty=true,s}negate(){return new te(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=true,this}negateToRef(e){return e._x=-1*this._x,e._y=-1*this._y,e._z=-1*this._z,e._isDirty=true,e}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=true,this}scale(e){return new te(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._isDirty=true,t}getNormalToRef(e){const t=this.length();let i=Math.acos(this._y/t);const s=Math.atan2(this._z,this._x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const r=t*Math.sin(i)*Math.cos(s),n=t*Math.cos(i),a=t*Math.sin(i)*Math.sin(s);return e.set(r,n,a),e}applyRotationQuaternionToRef(e,t){const i=this._x,s=this._y,r=this._z,n=e._x,a=e._y,o=e._z,h=e._w,l=2*(a*r-o*s),c=2*(o*i-n*r),u=2*(n*s-a*i);return t._x=i+h*l+a*u-o*c,t._y=s+h*c+o*l-n*u,t._z=r+h*u+n*c-a*l,t._isDirty=true,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new te)}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._isDirty=true,t}projectOnPlane(e,t){return this.projectOnPlaneToRef(e,t,new te)}projectOnPlaneToRef(e,t,i){const s=e.normal,r=e.d,n=ne$5.Vector3[0];this.subtractToRef(t,n),n.normalize();const a=te.Dot(n,s);if(Math.abs(a)<1e-10)i.setAll(1/0);else {const e=-(te.Dot(t,s)+r)/a,o=n.scaleInPlace(e);t.addToRef(o,i);}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=.001){return e&&F$8(this._x,e._x,t)&&F$8(this._y,e._y,t)&&F$8(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=true,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t._x=this._x*e._x,t._y=this._y*e._y,t._z=this._z*e._z,t._isDirty=true,t}multiplyByFloats(e,t,i){return new te(this._x*e,this._y*t,this._z*i)}divide(e){return new te(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t._x=this._x/e._x,t._y=this._y/e._y,t._z=this._z/e._z,t._isDirty=true,t}divideInPlace(e){return this._x=this._x/e._x,this._y=this._y/e._y,this._z=this._z/e._z,this._isDirty=true,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!F$8(t,i,e))return  true;const s=Math.abs(this._z);return !F$8(t,s,e)||!F$8(i,s,e)}get isNonUniform(){const e=Math.abs(this._x);if(e!==Math.abs(this._y))return  true;return e!==Math.abs(this._z)}floorToRef(e){return e._x=Math.floor(this._x),e._y=Math.floor(this._y),e._z=Math.floor(this._z),e._isDirty=true,e}floor(){return new te(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fractToRef(e){return e._x=this._x-Math.floor(this._x),e._y=this._y-Math.floor(this._y),e._z=this._z-Math.floor(this._z),e._isDirty=true,e}fract(){return new te(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if("xyz"===(e=e.toLowerCase()))return this;const t=ne$5.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(ne$5.Matrix[0]),te.TransformCoordinatesToRef(this,ne$5.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,ne$5.Vector3[0]),ne$5.Vector3[0].rotateByQuaternionToRef(e,ne$5.Vector3[0]),t.addToRef(ne$5.Vector3[0],i),i}cross(e){return te.CrossToRef(this,e,new te)}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new te)}normalizeToRef(e){const t=this.length();return 0===t||1===t?(e._x=this._x,e._y=this._y,e._z=this._z,e._isDirty=true,e):this.scaleToRef(1/t,e)}clone(){return new te(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=true,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=true,this}static GetClipFactor(e,t,i,s){const r=te.Dot(e,i);return (r-s)/(r-te.Dot(t,i))}static GetAngleBetweenVectors(e,t,i){const s=e.normalizeToRef(ne$5.Vector3[1]),r=t.normalizeToRef(ne$5.Vector3[2]);let n=te.Dot(s,r);n=U$5(n,-1,1);const a=Math.acos(n),o=ne$5.Vector3[3];return te.CrossToRef(s,r,o),te.Dot(o,i)>0?isNaN(a)?0:a:isNaN(a)?-Math.PI:-Math.acos(n)}static GetAngleBetweenVectorsOnPlane(e,t,i){ne$5.Vector3[0].copyFrom(e);const s=ne$5.Vector3[0];ne$5.Vector3[1].copyFrom(t);const r=ne$5.Vector3[1];ne$5.Vector3[2].copyFrom(i);const n=ne$5.Vector3[2],a=ne$5.Vector3[3],o=ne$5.Vector3[4];s.normalize(),r.normalize(),n.normalize(),te.CrossToRef(n,s,a),te.CrossToRef(a,n,o);return k$7(Math.atan2(te.Dot(r,a),te.Dot(r,o)))}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const s=ae$5.Vector3[0];return t.subtractToRef(e,s),i._y=Math.atan2(s.x,s.z)||0,i._x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,i._z=0,i._isDirty=true,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=te.Zero();return te.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,s){i=U$5(i,0,1);const r=ne$5.Vector3[0],n=ne$5.Vector3[1];r.copyFrom(e);const a=r.length();r.normalizeFromLength(a),n.copyFrom(t);const o=n.length();n.normalizeFromLength(o);const h=te.Dot(r,n);let l,c;if(h<.999){const e=Math.acos(h),t=1/Math.sin(e);l=Math.sin((1-i)*e)*t,c=Math.sin(i*e)*t;}else l=1-i,c=i;return r.scaleInPlace(l),n.scaleInPlace(c),s.copyFrom(r).addInPlace(n),s.scaleInPlace(N$c(a,o,i)),s}static SmoothToRef(e,t,i,s,r){return te.SlerpToRef(e,t,0===s?1:i/s,r),r}static FromArray(e,t=0){return new te(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return te.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=true,i}static FromFloatArrayToRef(e,t,i){return te.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,s){return s.copyFromFloats(e,t,i),s}static Zero(){return new te(0,0,0)}static One(){return new te(1,1,1)}static Up(){return new te(0,1,0)}static get UpReadOnly(){return te._UpReadOnly}static get DownReadOnly(){return te._DownReadOnly}static get RightReadOnly(){return te._RightReadOnly}static get LeftReadOnly(){return te._LeftReadOnly}static get LeftHandedForwardReadOnly(){return te._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return te._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return te._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return te._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return te._ZeroReadOnly}static get OneReadOnly(){return te._OneReadOnly}static Down(){return new te(0,-1,0)}static Forward(e=false){return new te(0,0,e?-1:1)}static Backward(e=false){return new te(0,0,e?1:-1)}static Right(){return new te(1,0,0)}static Left(){return new te(-1,0,0)}static Random(e=0,t=1){return new te(w$8(e,t),w$8(e,t),w$8(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(w$8(e,t),w$8(e,t),w$8(e,t))}static TransformCoordinates(e,t){const i=te.Zero();return te.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return te.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],o=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],l=1/(e*n[3]+t*n[7]+i*n[11]+n[15]);return r._x=a*l,r._y=o*l,r._z=h*l,r._isDirty=true,r}static TransformNormal(e,t){const i=te.Zero();return te.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,s,r){const n=s.m;return r._x=e*n[0]+t*n[4]+i*n[8],r._y=e*n[1]+t*n[5]+i*n[9],r._z=e*n[2]+t*n[6]+i*n[10],r._isDirty=true,r}static CatmullRom(e,t,i,s,r){const n=r*r,a=r*n,o=.5*(2*t._x+(-e._x+i._x)*r+(2*e._x-5*t._x+4*i._x-s._x)*n+(-e._x+3*t._x-3*i._x+s._x)*a),h=.5*(2*t._y+(-e._y+i._y)*r+(2*e._y-5*t._y+4*i._y-s._y)*n+(-e._y+3*t._y-3*i._y+s._y)*a),l=.5*(2*t._z+(-e._z+i._z)*r+(2*e._z-5*t._z+4*i._z-s._z)*n+(-e._z+3*t._z-3*i._z+s._z)*a);return new te(o,h,l)}static Clamp(e,t,i){const s=new te;return te.ClampToRef(e,t,i,s),s}static ClampToRef(e,t,i,s){let r=e._x;r=r>i._x?i._x:r,r=r<t._x?t._x:r;let n=e._y;n=n>i._y?i._y:n,n=n<t._y?t._y:n;let a=e._z;return a=a>i._z?i._z:a,a=a<t._z?t._z:a,s.copyFromFloats(r,n,a),s}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e);}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+r,c=a-n,u=e._x*o+i._x*h+t._x*l+s._x*c,d=e._y*o+i._y*h+t._y*l+s._y*c,_=e._z*o+i._z*h+t._z*l+s._z*c;return new te(u,d,_)}static Hermite1stDerivative(e,t,i,s,r){const n=new te;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;return n._x=6*(a-r)*e._x+(3*a-4*r+1)*t._x+6*(-a+r)*i._x+(3*a-2*r)*s._x,n._y=6*(a-r)*e._y+(3*a-4*r+1)*t._y+6*(-a+r)*i._y+(3*a-2*r)*s._y,n._z=6*(a-r)*e._z+(3*a-4*r+1)*t._z+6*(-a+r)*i._z+(3*a-2*r)*s._z,n._isDirty=true,n}static Lerp(e,t,i){const s=new te(0,0,0);return te.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){return s._x=e._x+(t._x-e._x)*i,s._y=e._y+(t._y-e._y)*i,s._z=e._z+(t._z-e._z)*i,s._isDirty=true,s}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){const i=new te;return te.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const s=e._y*t._z-e._z*t._y,r=e._z*t._x-e._x*t._z,n=e._x*t._y-e._y*t._x;return i.copyFromFloats(s,r,n),i}static Normalize(e){const t=te.Zero();return te.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,s){const r=new te;return te.ProjectToRef(e,t,i,s,r),r}static ProjectToRef(e,t,i,s,r){const n=s.width,a=s.height,o=s.x,h=s.y,l=ne$5.Matrix[1],c=L$7.LastCreatedEngine?.isNDCHalfZRange,u=c?1:.5,d=c?0:.5;re$5.FromValuesToRef(n/2,0,0,0,0,-a/2,0,0,0,0,u,0,o+n/2,a/2+h,d,1,l);const _=ne$5.Matrix[0];return t.multiplyToRef(i,_),_.multiplyToRef(l,_),te.TransformCoordinatesToRef(e,_,r),r}static Reflect(e,t){return this.ReflectToRef(e,t,new te)}static ReflectToRef(e,t,i){const s=ae$5.Vector3[0];return s.copyFrom(t).scaleInPlace(2*te.Dot(e,t)),i.copyFrom(e).subtractInPlace(s)}static UnprojectFromTransform(e,t,i,s,r){return this.Unproject(e,t,i,s,r,re$5.IdentityReadOnly)}static Unproject(e,t,i,s,r,n){const a=new te;return te.UnprojectToRef(e,t,i,s,r,n,a),a}static UnprojectToRef(e,t,i,s,r,n,a){return te.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,s,r,n,a),a}static UnprojectFloatsToRef(e,t,i,s,r,n,a,o,h){const l=ne$5.Matrix[0];n.multiplyToRef(a,l),l.multiplyToRef(o,l),l.invert();const c=ne$5.Vector3[0];return c.x=e/s*2-1,c.y=-(t/r*2-1),L$7.LastCreatedEngine?.isNDCHalfZRange?c.z=i:c.z=2*i-1,te.TransformCoordinatesToRef(c,l,h),h}static Minimize(e,t){const i=new te;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new te;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(te.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,s=e._y-t._y,r=e._z-t._z;return i*i+s*s+r*r}static ProjectOnTriangleToRef(e,t,i,s,r){const n=ne$5.Vector3[0],a=ne$5.Vector3[1],o=ne$5.Vector3[2],h=ne$5.Vector3[3],l=ne$5.Vector3[4];i.subtractToRef(t,n),s.subtractToRef(t,a),s.subtractToRef(i,o);const c=n.length(),u=a.length(),d=o.length();if(c<x$d||u<x$d||d<x$d)return r.copyFrom(t),te.Distance(e,t);e.subtractToRef(t,l),te.CrossToRef(n,a,h);const _=h.length();if(_<x$d)return r.copyFrom(t),te.Distance(e,t);h.normalizeFromLength(_);let f=l.length();if(f<x$d)return r.copyFrom(t),0;l.normalizeFromLength(f);const p=te.Dot(h,l),g=ne$5.Vector3[5],m=ne$5.Vector3[6];g.copyFrom(h).scaleInPlace(-f*p),m.copyFrom(e).addInPlace(g);const T=ne$5.Vector3[4],E=ne$5.Vector3[5],A=ne$5.Vector3[7],R=ne$5.Vector3[8];T.copyFrom(n).scaleInPlace(1/c),R.copyFrom(a).scaleInPlace(1/u),T.addInPlace(R).scaleInPlace(-1),E.copyFrom(n).scaleInPlace(-1/c),R.copyFrom(o).scaleInPlace(1/d),E.addInPlace(R).scaleInPlace(-1),A.copyFrom(o).scaleInPlace(-1/d),R.copyFrom(a).scaleInPlace(-1/u),A.addInPlace(R).scaleInPlace(-1);const b=ne$5.Vector3[9];let S;b.copyFrom(m).subtractInPlace(t),te.CrossToRef(T,b,R),S=te.Dot(R,h);const M=S;b.copyFrom(m).subtractInPlace(i),te.CrossToRef(E,b,R),S=te.Dot(R,h);const y=S;b.copyFrom(m).subtractInPlace(s),te.CrossToRef(A,b,R),S=te.Dot(R,h);const I=S,C=ne$5.Vector3[10];let v,P;M>0&&y<0?(C.copyFrom(n),v=t,P=i):y>0&&I<0?(C.copyFrom(o),v=i,P=s):(C.copyFrom(a).scaleInPlace(-1),v=s,P=t);const O=ne$5.Vector3[9],D=ne$5.Vector3[4];v.subtractToRef(m,R),P.subtractToRef(m,O),te.CrossToRef(R,O,D);if(!(te.Dot(D,h)<0))return r.copyFrom(m),Math.abs(f*p);const L=ne$5.Vector3[5];te.CrossToRef(C,D,L),L.normalize();const F=ne$5.Vector3[9];F.copyFrom(v).subtractInPlace(m);const w=F.length();if(w<x$d)return r.copyFrom(v),te.Distance(e,v);F.normalizeFromLength(w);const N=te.Dot(L,F),B=ne$5.Vector3[7];B.copyFrom(m).addInPlace(L.scaleInPlace(w*N)),R.copyFrom(B).subtractInPlace(v),f=C.length(),C.normalizeFromLength(f);let k=te.Dot(R,C)/Math.max(f,x$d);return k=U$5(k,0,1),B.copyFrom(v).addInPlace(C.scaleInPlace(k*f)),r.copyFrom(B),te.Distance(e,B)}static Center(e,t){return te.CenterToRef(e,t,te.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const s=new te;return te.RotationFromAxisToRef(e,t,i,s),s}static RotationFromAxisToRef(e,t,i,s){const r=ne$5.Quaternion[0];return se$5.RotationQuaternionFromAxisToRef(e,t,i,r),r.toEulerAnglesToRef(s),s}};te$4._V8PerformanceHack=new te$4(.5,.5,.5),te$4._UpReadOnly=te$4.Up(),te$4._DownReadOnly=te$4.Down(),te$4._LeftHandedForwardReadOnly=te$4.Forward(false),te$4._RightHandedForwardReadOnly=te$4.Forward(true),te$4._LeftHandedBackwardReadOnly=te$4.Backward(false),te$4._RightHandedBackwardReadOnly=te$4.Backward(true),te$4._RightReadOnly=te$4.Right(),te$4._LeftReadOnly=te$4.Left(),te$4._ZeroReadOnly=te$4.Zero(),te$4._OneReadOnly=te$4.One(),Object.defineProperties(te$4.prototype,{dimension:{value:[3]},rank:{value:1}});let ie$5=class ie{get x(){return this._x}set x(e){this._x=e,this._isDirty=true;}get y(){return this._y}set y(e){this._y=e,this._isDirty=true;}get z(){return this._z}set z(e){this._z=e,this._isDirty=true;}get w(){return this._w}set w(e){this._w=e,this._isDirty=true;}constructor(e=0,t=0,i=0,s=0){this._isDirty=true,this._x=e,this._y=t,this._z=i,this._w=s;}toString(){return `{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return "Vector4"}getHashCode(){let e=$$5(this._x);return e=397*e^$$5(this._y),e=397*e^$$5(this._z),e=397*e^$$5(this._w),e}asArray(){return [this._x,this._y,this._z,this._w]}toArray(e,t){return void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return ie.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e._x,this.y+=e._y,this.z+=e._z,this.w+=e._w,this}addInPlaceFromFloats(e,t,i,s){return this.x+=e,this.y+=t,this.z+=i,this.w+=s,this}add(e){return new ie(this._x+e.x,this._y+e.y,this._z+e.z,this._w+e.w)}addToRef(e,t){return t.x=this._x+e.x,t.y=this._y+e.y,t.z=this._z+e.z,t.w=this._w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new ie(this._x-e.x,this._y-e.y,this._z-e.z,this._w-e.w)}subtractToRef(e,t){return t.x=this._x-e.x,t.y=this._y-e.y,t.z=this._z-e.z,t.w=this._w-e.w,t}subtractFromFloats(e,t,i,s){return new ie(this._x-e,this._y-t,this._z-i,this._w-s)}subtractFromFloatsToRef(e,t,i,s,r){return r.x=this._x-e,r.y=this._y-t,r.z=this._z-i,r.w=this._w-s,r}negate(){return new ie(-this._x,-this._y,-this._z,-this._w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.x=-this._x,e.y=-this._y,e.z=-this._z,e.w=-this._w,e}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new ie(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t.x=this._x*e,t.y=this._y*e,t.z=this._z*e,t.w=this._w*e,t}scaleAndAddToRef(e,t){return t.x+=this._x*e,t.y+=this._y*e,t.z+=this._z*e,t.w+=this._w*e,t}equals(e){return e&&this._x===e.x&&this._y===e.y&&this._z===e.z&&this._w===e.w}equalsWithEpsilon(e,t=.001){return e&&F$8(this._x,e.x,t)&&F$8(this._y,e.y,t)&&F$8(this._z,e.z,t)&&F$8(this._w,e.w,t)}equalsToFloats(e,t,i,s){return this._x===e&&this._y===t&&this._z===i&&this._w===s}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new ie(this._x*e.x,this._y*e.y,this._z*e.z,this._w*e.w)}multiplyToRef(e,t){return t.x=this._x*e.x,t.y=this._y*e.y,t.z=this._z*e.z,t.w=this._w*e.w,t}multiplyByFloats(e,t,i,s){return new ie(this._x*e,this._y*t,this._z*i,this._w*s)}divide(e){return new ie(this._x/e.x,this._y/e.y,this._z/e.z,this._w/e.w)}divideToRef(e,t){return t.x=this._x/e.x,t.y=this._y/e.y,t.z=this._z/e.z,t.w=this._w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this._x&&(this.x=e.x),e.y<this._y&&(this.y=e.y),e.z<this._z&&(this.z=e.z),e.w<this._w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this._x&&(this.x=e.x),e.y>this._y&&(this.y=e.y),e.z>this._z&&(this.z=e.z),e.w>this._w&&(this.w=e.w),this}minimizeInPlaceFromFloats(e,t,i,s){return this.x=Math.min(e,this._x),this.y=Math.min(t,this._y),this.z=Math.min(i,this._z),this.w=Math.min(s,this._w),this}maximizeInPlaceFromFloats(e,t,i,s){return this.x=Math.max(e,this._x),this.y=Math.max(t,this._y),this.z=Math.max(i,this._z),this.w=Math.max(s,this._w),this}floorToRef(e){return e.x=Math.floor(this._x),e.y=Math.floor(this._y),e.z=Math.floor(this._z),e.w=Math.floor(this._w),e}floor(){return new ie(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z),Math.floor(this._w))}fractToRef(e){return e.x=this._x-Math.floor(this._x),e.y=this._y-Math.floor(this._y),e.z=this._z-Math.floor(this._z),e.w=this._w-Math.floor(this._w),e}fract(){return new ie(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z),this._w-Math.floor(this._w))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new ie)}normalizeToRef(e){const t=this.length();return 0===t||1===t?(e.x=this._x,e.y=this._y,e.z=this._z,e.w=this._w,e):this.scaleToRef(1/t,e)}toVector3(){return new te$4(this._x,this._y,this._z)}clone(){return new ie(this._x,this._y,this._z,this._w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this._x*e.x+this._y*e.y+this._z*e.z+this._w*e.w}static FromArray(e,t){return t||(t=0),new ie(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return ie.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,s,r){return r.x=e,r.y=t,r.z=i,r.w=s,r}static Zero(){return new ie(0,0,0,0)}static One(){return new ie(1,1,1,1)}static Random(e=0,t=1){return new ie(w$8(e,t),w$8(e,t),w$8(e,t),w$8(e,t))}static RandomToRef(e=0,t=1,i){return i.x=w$8(e,t),i.y=w$8(e,t),i.z=w$8(e,t),i.w=w$8(e,t),i}static Clamp(e,t,i){return ie.ClampToRef(e,t,i,new ie)}static ClampToRef(e,t,i,s){return s.x=U$5(e.x,t.x,i.x),s.y=U$5(e.y,t.y,i.y),s.z=U$5(e.z,t.z,i.z),s.w=U$5(e.w,t.w,i.w),s}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e);}static get ZeroReadOnly(){return ie._ZeroReadOnly}static Normalize(e){return ie.NormalizeToRef(e,new ie)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=new ie;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new ie;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(ie.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z,n=e.w-t.w;return i*i+s*s+r*r+n*n}static Center(e,t){return ie.CenterToRef(e,t,new ie)}static CenterToRef(e,t,i){return i.x=(e.x+t.x)/2,i.y=(e.y+t.y)/2,i.z=(e.z+t.z)/2,i.w=(e.w+t.w)/2,i}static TransformCoordinates(e,t){return ie.TransformCoordinatesToRef(e,t,new ie)}static TransformCoordinatesToRef(e,t,i){return ie.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],o=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],l=e*n[3]+t*n[7]+i*n[11]+n[15];return r.x=a,r.y=o,r.z=h,r.w=l,r}static TransformNormal(e,t){return ie.TransformNormalToRef(e,t,new ie)}static TransformNormalToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+e.z*s[8],n=e.x*s[1]+e.y*s[5]+e.z*s[9],a=e.x*s[2]+e.y*s[6]+e.z*s[10];return i.x=r,i.y=n,i.z=a,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,s,r,n){const a=r.m;return n.x=e*a[0]+t*a[4]+i*a[8],n.y=e*a[1]+t*a[5]+i*a[9],n.z=e*a[2]+t*a[6]+i*a[10],n.w=s,n}static FromVector3(e,t=0){return new ie(e._x,e._y,e._z,t)}static Dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}};ie$5._V8PerformanceHack=new ie$5(.5,.5,.5,.5),ie$5._ZeroReadOnly=ie$5.Zero(),Object.defineProperties(ie$5.prototype,{dimension:{value:[4]},rank:{value:1}});let se$5=class se{get x(){return this._x}set x(e){this._x=e,this._isDirty=true;}get y(){return this._y}set y(e){this._y=e,this._isDirty=true;}get z(){return this._z}set z(e){this._z=e,this._isDirty=true;}get w(){return this._w}set w(e){this._w=e,this._isDirty=true;}constructor(e=0,t=0,i=0,s=1){this._isDirty=true,this._x=e,this._y=t,this._z=i,this._w=s;}toString(){return `{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return "Quaternion"}getHashCode(){let e=$$5(this._x);return e=397*e^$$5(this._y),e=397*e^$$5(this._z),e=397*e^$$5(this._w),e}asArray(){return [this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return se.FromArrayToRef(e,t,this)}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=.001){return e&&F$8(this._x,e._x,t)&&F$8(this._y,e._y,t)&&F$8(this._z,e._z,t)&&F$8(this._w,e._w,t)}isApprox(e,t=.001){return e&&(F$8(this._x,e._x,t)&&F$8(this._y,e._y,t)&&F$8(this._z,e._z,t)&&F$8(this._w,e._w,t)||F$8(this._x,-e._x,t)&&F$8(this._y,-e._y,t)&&F$8(this._z,-e._z,t)&&F$8(this._w,-e._w,t))}clone(){return new se(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=true,this}copyFromFloats(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this._isDirty=true,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.copyFromFloats(e,e,e,e)}add(e){return new se(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=true,this}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._w=this._w+e._w,t._isDirty=true,t}addInPlaceFromFloats(e,t,i,s){return this._x+=e,this._y+=t,this._z+=i,this._w+=s,this._isDirty=true,this}subtractToRef(e,t){return t._x=this._x-e._x,t._y=this._y-e._y,t._z=this._z-e._z,t._w=this._w-e._w,t._isDirty=true,t}subtractFromFloats(e,t,i,s){return this.subtractFromFloatsToRef(e,t,i,s,new se)}subtractFromFloatsToRef(e,t,i,s,r){return r._x=this._x-e,r._y=this._y-t,r._z=this._z-i,r._w=this._w-s,r._isDirty=true,r}subtract(e){return new se(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=true,this}scale(e){return new se(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=true,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=true,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=true,t}multiply(e){const t=new se(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,s=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,r=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,n=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,s,r,n),t}multiplyInPlace(e){return this.multiplyToRef(e,this)}multiplyByFloats(e,t,i,s){return this._x*=e,this._y*=t,this._z*=i,this._w*=s,this._isDirty=true,this}divide(e){throw new ReferenceError("Can not divide a quaternion")}divideToRef(e,t){throw new ReferenceError("Can not divide a quaternion")}divideInPlace(e){throw new ReferenceError("Can not divide a quaternion")}minimizeInPlace(){throw new ReferenceError("Can not minimize a quaternion")}minimizeInPlaceFromFloats(){throw new ReferenceError("Can not minimize a quaternion")}maximizeInPlace(){throw new ReferenceError("Can not maximize a quaternion")}maximizeInPlaceFromFloats(){throw new ReferenceError("Can not maximize a quaternion")}negate(){return this.negateToRef(new se)}negateInPlace(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._isDirty=true,this}negateToRef(e){return e._x=-this._x,e._y=-this._y,e._z=-this._z,e._w=-this._w,e._isDirty=true,e}equalsToFloats(e,t,i,s){return this._x===e&&this._y===t&&this._z===i&&this._w===s}floorToRef(e){throw new ReferenceError("Can not floor a quaternion")}floor(){throw new ReferenceError("Can not floor a quaternion")}fractToRef(e){throw new ReferenceError("Can not fract a quaternion")}fract(){throw new ReferenceError("Can not fract a quaternion")}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=true,this}conjugate(){return new se(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return 0==t||1==t||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return 0==e||1==e||this.scaleInPlace(1/e),this}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new se(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){const e=te$4.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,s=this._y,r=this._w,n=s*t-i*r;if(n<-0.4999999)e._y=2*Math.atan2(s,r),e._x=Math.PI/2,e._z=0,e._isDirty=true;else if(n>.4999999)e._y=2*Math.atan2(s,r),e._x=-Math.PI/2,e._z=0,e._isDirty=true;else {const a=r*r,o=t*t,h=i*i,l=s*s;e._z=Math.atan2(2*(i*s+t*r),-o-h+l+a),e._x=Math.asin(-2*n),e._y=Math.atan2(2*(t*i+s*r),o-h-l+a),e._isDirty=true;}return e}toAlphaBetaGammaToRef(e){const t=this._z,i=this._x,s=this._y,r=this._w,n=Math.sqrt(i*i+s*s),a=Math.sqrt(t*t+r*r),o=2*Math.atan2(n,a),h=2*Math.atan2(t,r),l=2*Math.atan2(s,i),c=(h+l)/2,u=(h-l)/2;return e.set(u,o,c),e}toRotationMatrix(e){return re$5.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return se.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}toAxisAngle(){const e=te$4.Zero();return {axis:e,angle:this.toAxisAngleToRef(e)}}toAxisAngleToRef(e){let t=0;const i=Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z),s=this._w;return i>0?(t=2*Math.atan2(i,s),e.set(this._x/i,this._y/i,this._z/i)):(t=0,e.set(1,0,0)),t}static FromRotationMatrix(e){const t=new se;return se.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,s=i[0],r=i[4],n=i[8],a=i[1],o=i[5],h=i[9],l=i[2],c=i[6],u=i[10],d=s+o+u;let _;return d>0?(_=.5/Math.sqrt(d+1),t._w=.25/_,t._x=(c-h)*_,t._y=(n-l)*_,t._z=(a-r)*_,t._isDirty=true):s>o&&s>u?(_=2*Math.sqrt(1+s-o-u),t._w=(c-h)/_,t._x=.25*_,t._y=(r+a)/_,t._z=(n+l)/_,t._isDirty=true):o>u?(_=2*Math.sqrt(1+o-s-u),t._w=(n-l)/_,t._x=(r+a)/_,t._y=.25*_,t._z=(h+c)/_,t._isDirty=true):(_=2*Math.sqrt(1+u-s-o),t._w=(a-r)/_,t._x=(n+l)/_,t._y=(h+c)/_,t._z=.25*_,t._isDirty=true),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const s=se.Dot(e,t);return 1-s*s<=i}static SmoothToRef(e,t,i,s,r){let n=0===s?1:i/s;return n=U$5(n,0,1),se.SlerpToRef(e,t,n,r),r}static Zero(){return new se(0,0,0,0)}static Inverse(e){return new se(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new se(0,0,0,1)}static IsIdentity(e){return e&&0===e._x&&0===e._y&&0===e._z&&1===e._w}static RotationAxis(e,t){return se.RotationAxisToRef(e,t,new se)}static RotationAxisToRef(e,t,i){i._w=Math.cos(t/2);const s=Math.sin(t/2)/e.length();return i._x=e._x*s,i._y=e._y*s,i._z=e._z*s,i._isDirty=true,i}static FromArray(e,t){return t||(t=0),new se(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=true,i}static FromFloatsToRef(e,t,i,s,r){return r.copyFromFloats(e,t,i,s),r}static FromEulerAngles(e,t,i){const s=new se;return se.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerAnglesToRef(e,t,i,s){return se.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerVector(e){const t=new se;return se.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return se.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,s=.001){const r=te$4.Dot(e,t)+1;return r<s?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(te$4.CrossToRef(e,t,ae$5.Vector3[0]),i.set(ae$5.Vector3[0].x,ae$5.Vector3[0].y,ae$5.Vector3[0].z,r)),i.normalize()}static RotationYawPitchRoll(e,t,i){const s=new se;return se.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){const r=.5*i,n=.5*t,a=.5*e,o=Math.sin(r),h=Math.cos(r),l=Math.sin(n),c=Math.cos(n),u=Math.sin(a),d=Math.cos(a);return s._x=d*l*h+u*c*o,s._y=u*c*h-d*l*o,s._z=d*c*o-u*l*h,s._w=d*c*h+u*l*o,s._isDirty=true,s}static RotationAlphaBetaGamma(e,t,i){const s=new se;return se.RotationAlphaBetaGammaToRef(e,t,i,s),s}static RotationAlphaBetaGammaToRef(e,t,i,s){const r=.5*(i+e),n=.5*(i-e),a=.5*t;return s._x=Math.cos(n)*Math.sin(a),s._y=Math.sin(n)*Math.sin(a),s._z=Math.sin(r)*Math.cos(a),s._w=Math.cos(r)*Math.cos(a),s._isDirty=true,s}static RotationQuaternionFromAxis(e,t,i){const s=new se(0,0,0,0);return se.RotationQuaternionFromAxisToRef(e,t,i,s),s}static RotationQuaternionFromAxisToRef(e,t,i,s){const r=ne$5.Matrix[0];return e=e.normalizeToRef(ne$5.Vector3[0]),t=t.normalizeToRef(ne$5.Vector3[1]),i=i.normalizeToRef(ne$5.Vector3[2]),re$5.FromXYZAxesToRef(e,t,i,r),se.FromRotationMatrixToRef(r,s),s}static FromLookDirectionLH(e,t){const i=new se;return se.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const s=ne$5.Matrix[0];return re$5.LookDirectionLHToRef(e,t,s),se.FromRotationMatrixToRef(s,i),i}static FromLookDirectionRH(e,t){const i=new se;return se.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const s=ne$5.Matrix[0];return re$5.LookDirectionRHToRef(e,t,s),se.FromRotationMatrixToRef(s,i)}static Slerp(e,t,i){const s=se.Identity();return se.SlerpToRef(e,t,i,s),s}static SlerpToRef(e,t,i,s){let r,n,a=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,o=false;if(a<0&&(o=true,a=-a),a>.999999)n=1-i,r=o?-i:i;else {const e=Math.acos(a),t=1/Math.sin(e);n=Math.sin((1-i)*e)*t,r=o?-Math.sin(i*e)*t:Math.sin(i*e)*t;}return s._x=n*e._x+r*t._x,s._y=n*e._y+r*t._y,s._z=n*e._z+r*t._z,s._w=n*e._w+r*t._w,s._isDirty=true,s}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+r,c=a-n,u=e._x*o+i._x*h+t._x*l+s._x*c,d=e._y*o+i._y*h+t._y*l+s._y*c,_=e._z*o+i._z*h+t._z*l+s._z*c,f=e._w*o+i._w*h+t._w*l+s._w*c;return new se(u,d,_,f)}static Hermite1stDerivative(e,t,i,s,r){const n=new se;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;return n._x=6*(a-r)*e._x+(3*a-4*r+1)*t._x+6*(-a+r)*i._x+(3*a-2*r)*s._x,n._y=6*(a-r)*e._y+(3*a-4*r+1)*t._y+6*(-a+r)*i._y+(3*a-2*r)*s._y,n._z=6*(a-r)*e._z+(3*a-4*r+1)*t._z+6*(-a+r)*i._z+(3*a-2*r)*s._z,n._w=6*(a-r)*e._w+(3*a-4*r+1)*t._w+6*(-a+r)*i._w+(3*a-2*r)*s._w,n._isDirty=true,n}static Normalize(e){const t=se.Zero();return se.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Clamp(e,t,i){const s=new se;return se.ClampToRef(e,t,i,s),s}static ClampToRef(e,t,i,s){return s.copyFromFloats(U$5(e.x,t.x,i.x),U$5(e.y,t.y,i.y),U$5(e.z,t.z,i.z),U$5(e.w,t.w,i.w))}static Random(e=0,t=1){return new se(w$8(e,t),w$8(e,t),w$8(e,t),w$8(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(w$8(e,t),w$8(e,t),w$8(e,t),w$8(e,t))}static Minimize(){throw new ReferenceError("Quaternion.Minimize does not make sense")}static Maximize(){throw new ReferenceError("Quaternion.Maximize does not make sense")}static Distance(e,t){return Math.sqrt(se.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z,n=e.w-t.w;return i*i+s*s+r*r+n*n}static Center(e,t){return se.CenterToRef(e,t,se.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}};se$5._V8PerformanceHack=new se$5(.5,.5,.5,.5),Object.defineProperties(se$5.prototype,{dimension:{value:[4]},rank:{value:1}});let re$5=class re{static get Use64Bits(){return D$9.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=K$5._UpdateFlagSeed++,this._isIdentity=false,this._isIdentity3x2=false,this._isIdentityDirty=true,this._isIdentity3x2Dirty=true;}_updateIdentityStatus(e,t=false,i=false,s=true){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=!this._isIdentity&&t,this._isIdentity3x2Dirty=!this._isIdentity3x2&&s;}constructor(){this._isIdentity=false,this._isIdentityDirty=true,this._isIdentity3x2=true,this._isIdentity3x2Dirty=true,this.updateFlag=-1,D$9.MatrixTrackPrecisionChange&&D$9.MatrixTrackedMatrices.push(this),this._m=new D$9.MatrixCurrentType(16),this.markAsUpdated();}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=false;const e=this._m;this._isIdentity=1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15];}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=false,1!==this._m[0]||1!==this._m[5]||1!==this._m[15]||0!==this._m[1]||0!==this._m[2]||0!==this._m[3]||0!==this._m[4]||0!==this._m[6]||0!==this._m[7]||0!==this._m[8]||0!==this._m[9]||0!==this._m[10]||0!==this._m[11]||0!==this._m[12]||0!==this._m[13]||0!==this._m[14]?this._isIdentity3x2=false:this._isIdentity3x2=true),this._isIdentity3x2}determinant(){if(true===this._isIdentity)return 1;const e=this._m,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],a=e[5],o=e[6],h=e[7],l=e[8],c=e[9],u=e[10],d=e[11],_=e[12],f=e[13],p=e[14],g=e[15],m=u*g-p*d,T=c*g-f*d,E=c*p-f*u,A=l*g-_*d,R=l*p-u*_,b=l*f-_*c;return t*+(a*m-o*T+h*E)+i*-(n*m-o*A+h*R)+s*+(n*T-a*A+h*b)+r*-(n*E-a*R+o*b)}toString(){return `{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}\n${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}\n${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}\n${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(e=null,t=0){if(!e)return this._m;const i=this._m;for(let s=0;s<16;s++)e[t+s]=i[s];return this}asArray(){return this._m}fromArray(e,t=0){return re.FromArrayToRef(e,t,this)}copyFromFloats(...e){return re.FromArrayToRef(e,0,this)}set(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=e[i];return this.markAsUpdated(),this}setAll(e){const t=this._m;for(let i=0;i<16;i++)t[i]=e;return this.markAsUpdated(),this}invert(){return this.invertToRef(this),this}reset(){return re.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(false),this}add(e){const t=new re;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,s=t._m,r=e.m;for(let e=0;e<16;e++)s[e]=i[e]+r[e];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;return t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[3],t[4]+=i[4],t[5]+=i[5],t[6]+=i[6],t[7]+=i[7],t[8]+=i[8],t[9]+=i[9],t[10]+=i[10],t[11]+=i[11],t[12]+=i[12],t[13]+=i[13],t[14]+=i[14],t[15]+=i[15],this.markAsUpdated(),this}addInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]+=i[e];return this.markAsUpdated(),this}addInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]+=e[i];return this.markAsUpdated(),this}subtract(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]-=i[e];return this.markAsUpdated(),this}subtractToRef(e,t){const i=this._m,s=e.m,r=t._m;for(let e=0;e<16;e++)r[e]=i[e]-s[e];return t.markAsUpdated(),t}subtractInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]-=i[e];return this.markAsUpdated(),this}subtractFromFloats(...e){return this.subtractFromFloatsToRef(...e,new re)}subtractFromFloatsToRef(...e){const t=e.pop(),i=this._m,s=t._m,r=e;for(let e=0;e<16;e++)s[e]=i[e]-r[e];return t.markAsUpdated(),t}invertToRef(e){return  true===this._isIdentity?(re.IdentityToRef(e),e):(J$5(this,e.asArray())?e.markAsUpdated():e.copyFrom(this),e)}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new te$4(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return re.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]),this}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){return function(e,t,i=0){const s=e.asArray();t[i]=s[0],t[i+1]=s[1],t[i+2]=s[2],t[i+3]=s[3],t[i+4]=s[4],t[i+5]=s[5],t[i+6]=s[6],t[i+7]=s[7],t[i+8]=s[8],t[i+9]=s[9],t[i+10]=s[10],t[i+11]=s[11],t[i+12]=s[12],t[i+13]=s[13],t[i+14]=s[14],t[i+15]=s[15];}(this,e,t),this}multiply(e){const t=new re;return this.multiplyToRef(e,t),t}multiplyInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]*=i[e];return this.markAsUpdated(),this}multiplyByFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e[i];return this.markAsUpdated(),this}multiplyByFloatsToRef(...e){const t=e.pop(),i=this._m,s=t._m,r=e;for(let e=0;e<16;e++)s[e]=i[e]*r[e];return t.markAsUpdated(),t}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){return Q$6(this,e,t,i),this}divide(e){return this.divideToRef(e,new re)}divideToRef(e,t){const i=this._m,s=e.m,r=t._m;for(let e=0;e<16;e++)r[e]=i[e]/s[e];return t.markAsUpdated(),t}divideInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]/=i[e];return this.markAsUpdated(),this}minimizeInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]=Math.min(t[e],i[e]);return this.markAsUpdated(),this}minimizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}maximizeInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]=Math.min(t[e],i[e]);return this.markAsUpdated(),this}maximizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}negate(){return this.negateToRef(new re)}negateInPlace(){const e=this._m;for(let t=0;t<16;t++)e[t]=-e[t];return this.markAsUpdated(),this}negateToRef(e){const t=this._m,i=e._m;for(let e=0;e<16;e++)i[e]=-t[e];return e.markAsUpdated(),e}equals(e){const t=e;if(!t)return  false;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,s=t.m;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]&&i[3]===s[3]&&i[4]===s[4]&&i[5]===s[5]&&i[6]===s[6]&&i[7]===s[7]&&i[8]===s[8]&&i[9]===s[9]&&i[10]===s[10]&&i[11]===s[11]&&i[12]===s[12]&&i[13]===s[13]&&i[14]===s[14]&&i[15]===s[15]}equalsWithEpsilon(e,t=0){const i=this._m,s=e.m;for(let e=0;e<16;e++)if(!F$8(i[e],s[e],t))return  false;return  true}equalsToFloats(...e){const t=this._m;for(let i=0;i<16;i++)if(t[i]!=e[i])return  false;return  true}floor(){return this.floorToRef(new re)}floorToRef(e){const t=this._m,i=e._m;for(let e=0;e<16;e++)i[e]=Math.floor(t[e]);return e.markAsUpdated(),e}fract(){return this.fractToRef(new re)}fractToRef(e){const t=this._m,i=e._m;for(let e=0;e<16;e++)i[e]=t[e]-Math.floor(t[e]);return e.markAsUpdated(),e}clone(){const e=new re;return e.copyFrom(this),e}getClassName(){return "Matrix"}getHashCode(){let e=$$5(this._m[0]);for(let t=1;t<16;t++)e=397*e^$$5(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new se$5,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,s,r=true){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),true;const n=this._m;if(i&&i.copyFromFloats(n[12],n[13],n[14]),(e=e||ne$5.Vector3[0]).x=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),e.y=Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),e.z=Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]),s){const t=(r?s.absoluteScaling.x:s.scaling.x)<0?-1:1,i=(r?s.absoluteScaling.y:s.scaling.y)<0?-1:1,n=(r?s.absoluteScaling.z:s.scaling.z)<0?-1:1;e.x*=t,e.y*=i,e.z*=n;}else this.determinant()<=0&&(e.y*=-1);if(0===e._x||0===e._y||0===e._z)return t&&t.copyFromFloats(0,0,0,1),false;if(t){const i=1/e._x,s=1/e._y,r=1/e._z;re.FromValuesToRef(n[0]*i,n[1]*i,n[2]*i,0,n[4]*s,n[5]*s,n[6]*s,0,n[8]*r,n[9]*r,n[10]*r,0,0,0,0,1,ne$5.Matrix[0]),se$5.FromRotationMatrixToRef(ne$5.Matrix[0],t);}return  true}getRow(e){if(e<0||e>3)return null;const t=4*e;return new ie$5(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){const i=4*e;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3];}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new re;return re.TransposeToRef(this,e),e}transposeToRef(e){return re.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,s,r){if(e<0||e>3)return this;const n=4*e;return this._m[n+0]=t,this._m[n+1]=i,this._m[n+2]=s,this._m[n+3]=r,this.markAsUpdated(),this}scale(e){const t=new re;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}scaleInPlace(e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e;return this.markAsUpdated(),this}toNormalMatrix(e){const t=ne$5.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return re.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new re;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=ne$5.Vector3[0];if(!this.decompose(t))return re.IdentityToRef(e),e;const i=this._m,s=1/t._x,r=1/t._y,n=1/t._z;return re.FromValuesToRef(i[0]*s,i[1]*s,i[2]*s,0,i[4]*r,i[5]*r,i[6]*r,0,i[8]*n,i[9]*n,i[10]*n,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new re;return re.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let s=0;s<16;s++)i._m[s]=e[s+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,s){return s._m[0]=e[0+t]*i,s._m[1]=e[1+t]*i,s._m[2]=e[2+t]*i,s._m[3]=e[3+t]*i,s._m[4]=e[4+t]*i,s._m[5]=e[5+t]*i,s._m[6]=e[6+t]*i,s._m[7]=e[7+t]*i,s._m[8]=e[8+t]*i,s._m[9]=e[9+t]*i,s._m[10]=e[10+t]*i,s._m[11]=e[11+t]*i,s._m[12]=e[12+t]*i,s._m[13]=e[13+t]*i,s._m[14]=e[14+t]*i,s._m[15]=e[15+t]*i,s.markAsUpdated(),s}static get IdentityReadOnly(){return re._IdentityReadOnly}static FromValuesToRef(e,t,i,s,r,n,a,o,h,l,c,u,d,_,f,p,g){const m=g._m;m[0]=e,m[1]=t,m[2]=i,m[3]=s,m[4]=r,m[5]=n,m[6]=a,m[7]=o,m[8]=h,m[9]=l,m[10]=c,m[11]=u,m[12]=d,m[13]=_,m[14]=f,m[15]=p,g.markAsUpdated();}static FromValues(e,t,i,s,r,n,a,o,h,l,c,u,d,_,f,p){const g=new re,m=g._m;return m[0]=e,m[1]=t,m[2]=i,m[3]=s,m[4]=r,m[5]=n,m[6]=a,m[7]=o,m[8]=h,m[9]=l,m[10]=c,m[11]=u,m[12]=d,m[13]=_,m[14]=f,m[15]=p,g.markAsUpdated(),g}static Compose(e,t,i){const s=new re;return re.ComposeToRef(e,t,i,s),s}static ComposeToRef(e,t,i,s){const r=s._m,n=t._x,a=t._y,o=t._z,h=t._w,l=n+n,c=a+a,u=o+o,d=n*l,_=n*c,f=n*u,p=a*c,g=a*u,m=o*u,T=h*l,E=h*c,A=h*u,R=e._x,b=e._y,S=e._z;return r[0]=(1-(p+m))*R,r[1]=(_+A)*R,r[2]=(f-E)*R,r[3]=0,r[4]=(_-A)*b,r[5]=(1-(d+m))*b,r[6]=(g+T)*b,r[7]=0,r[8]=(f+E)*S,r[9]=(g-T)*S,r[10]=(1-(d+p))*S,r[11]=0,r[12]=i._x,r[13]=i._y,r[14]=i._z,r[15]=1,s.markAsUpdated(),s}static Identity(){const e=re.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(true),e}static IdentityToRef(e){return re.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(true),e}static Zero(){const e=re.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(false),e}static RotationX(e){const t=new re;return re.RotationXToRef(e,t),t}static Invert(e){const t=new re;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return re.FromValuesToRef(1,0,0,0,0,s,i,0,0,-i,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationY(e){const t=new re;return re.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return re.FromValuesToRef(s,0,-i,0,0,1,0,0,i,0,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationZ(e){const t=new re;return re.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return re.FromValuesToRef(s,i,0,0,-i,s,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationAxis(e,t){const i=new re;return re.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const s=Math.sin(-t),r=Math.cos(-t),n=1-r;e=e.normalizeToRef(ne$5.Vector3[0]);const a=i._m;return a[0]=e._x*e._x*n+r,a[1]=e._x*e._y*n-e._z*s,a[2]=e._x*e._z*n+e._y*s,a[3]=0,a[4]=e._y*e._x*n+e._z*s,a[5]=e._y*e._y*n+r,a[6]=e._y*e._z*n-e._x*s,a[7]=0,a[8]=e._z*e._x*n-e._y*s,a[9]=e._z*e._y*n+e._x*s,a[10]=e._z*e._z*n+r,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i,s=false){const r=te$4.Dot(t,e),n=i._m;if(r<-0.999)n[0]=-1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s?1:-1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=s?-1:1,n[11]=0;else {const i=te$4.Cross(t,e),s=1/(1+r);n[0]=i._x*i._x*s+r,n[1]=i._y*i._x*s-i._z,n[2]=i._z*i._x*s+i._y,n[3]=0,n[4]=i._x*i._y*s+i._z,n[5]=i._y*i._y*s+r,n[6]=i._z*i._y*s-i._x,n[7]=0,n[8]=i._x*i._z*s-i._y,n[9]=i._y*i._z*s+i._x,n[10]=i._z*i._z*s+r,n[11]=0;}return n[12]=0,n[13]=0,n[14]=0,n[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const s=new re;return re.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){return se$5.RotationYawPitchRollToRef(e,t,i,ne$5.Quaternion[0]),ne$5.Quaternion[0].toRotationMatrix(s),s}static Scaling(e,t,i){const s=new re;return re.ScalingToRef(e,t,i,s),s}static ScalingToRef(e,t,i,s){return re.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,s),s._updateIdentityStatus(1===e&&1===t&&1===i),s}static Translation(e,t,i){const s=new re;return re.TranslationToRef(e,t,i,s),s}static TranslationToRef(e,t,i,s){return re.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,s),s._updateIdentityStatus(0===e&&0===t&&0===i),s}static Lerp(e,t,i){const s=new re;return re.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){const r=s._m,n=e.m,a=t.m;for(let e=0;e<16;e++)r[e]=n[e]*(1-i)+a[e]*i;return s.markAsUpdated(),s}static DecomposeLerp(e,t,i){const s=new re;return re.DecomposeLerpToRef(e,t,i,s),s}static DecomposeLerpToRef(e,t,i,s){const r=ne$5.Vector3[0],n=ne$5.Quaternion[0],a=ne$5.Vector3[1];e.decompose(r,n,a);const o=ne$5.Vector3[2],h=ne$5.Quaternion[1],l=ne$5.Vector3[3];t.decompose(o,h,l);const c=ne$5.Vector3[4];te$4.LerpToRef(r,o,i,c);const u=ne$5.Quaternion[2];se$5.SlerpToRef(n,h,i,u);const d=ne$5.Vector3[5];return te$4.LerpToRef(a,l,i,d),re.ComposeToRef(c,u,d,s),s}static LookAtLH(e,t,i){const s=new re;return re.LookAtLHToRef(e,t,i,s),s}static LookAtLHToRef(e,t,i,s){const r=ne$5.Vector3[0],n=ne$5.Vector3[1],a=ne$5.Vector3[2];t.subtractToRef(e,a),a.normalize(),te$4.CrossToRef(i,a,r);const o=r.lengthSquared();0===o?r.x=1:r.normalizeFromLength(Math.sqrt(o)),te$4.CrossToRef(a,r,n),n.normalize();const h=-te$4.Dot(r,e),l=-te$4.Dot(n,e),c=-te$4.Dot(a,e);return re.FromValuesToRef(r._x,n._x,a._x,0,r._y,n._y,a._y,0,r._z,n._z,a._z,0,h,l,c,1,s),s}static LookAtRH(e,t,i){const s=new re;return re.LookAtRHToRef(e,t,i,s),s}static LookAtRHToRef(e,t,i,s){const r=ne$5.Vector3[0],n=ne$5.Vector3[1],a=ne$5.Vector3[2];e.subtractToRef(t,a),a.normalize(),te$4.CrossToRef(i,a,r);const o=r.lengthSquared();0===o?r.x=1:r.normalizeFromLength(Math.sqrt(o)),te$4.CrossToRef(a,r,n),n.normalize();const h=-te$4.Dot(r,e),l=-te$4.Dot(n,e),c=-te$4.Dot(a,e);return re.FromValuesToRef(r._x,n._x,a._x,0,r._y,n._y,a._y,0,r._z,n._z,a._z,0,h,l,c,1,s),s}static LookDirectionLH(e,t){const i=new re;return re.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const s=ne$5.Vector3[0];s.copyFrom(e),s.scaleInPlace(-1);const r=ne$5.Vector3[1];return te$4.CrossToRef(t,s,r),re.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,s._x,s._y,s._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new re;return re.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const s=ne$5.Vector3[2];return te$4.CrossToRef(t,e,s),re.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,s,r){const n=new re;return re.OrthoLHToRef(e,t,i,s,n,r),n}static OrthoLHToRef(e,t,i,s,r,n){const a=2/e,o=2/t,h=2/(s-i),l=-(s+i)/(s-i);return re.FromValuesToRef(a,0,0,0,0,o,0,0,0,0,h,0,0,0,l,1,r),n&&r.multiplyToRef(oe$5,r),r._updateIdentityStatus(1===a&&1===o&&1===h&&0===l),r}static OrthoOffCenterLH(e,t,i,s,r,n,a){const o=new re;return re.OrthoOffCenterLHToRef(e,t,i,s,r,n,o,a),o}static OrthoOffCenterLHToRef(e,t,i,s,r,n,a,o){const h=2/(t-e),l=2/(s-i),c=2/(n-r),u=-(n+r)/(n-r),d=(e+t)/(e-t),_=(s+i)/(i-s);return re.FromValuesToRef(h,0,0,0,0,l,0,0,0,0,c,0,d,_,u,1,a),o&&a.multiplyToRef(oe$5,a),a.markAsUpdated(),a}static ObliqueOffCenterLHToRef(e,t,i,s,r,n,a,o,h,l,c){const u=-a*Math.cos(o),d=-a*Math.sin(o);return re.TranslationToRef(0,0,-h,ne$5.Matrix[1]),re.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,ne$5.Matrix[0]),ne$5.Matrix[1].multiplyToRef(ne$5.Matrix[0],ne$5.Matrix[0]),re.TranslationToRef(0,0,h,ne$5.Matrix[1]),ne$5.Matrix[0].multiplyToRef(ne$5.Matrix[1],ne$5.Matrix[0]),re.OrthoOffCenterLHToRef(e,t,i,s,r,n,l,c),ne$5.Matrix[0].multiplyToRef(l,l),l}static OrthoOffCenterRH(e,t,i,s,r,n,a){const o=new re;return re.OrthoOffCenterRHToRef(e,t,i,s,r,n,o,a),o}static OrthoOffCenterRHToRef(e,t,i,s,r,n,a,o){return re.OrthoOffCenterLHToRef(e,t,i,s,r,n,a,o),a._m[10]*=-1,a}static ObliqueOffCenterRHToRef(e,t,i,s,r,n,a,o,h,l,c){const u=a*Math.cos(o),d=a*Math.sin(o);return re.TranslationToRef(0,0,h,ne$5.Matrix[1]),re.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,ne$5.Matrix[0]),ne$5.Matrix[1].multiplyToRef(ne$5.Matrix[0],ne$5.Matrix[0]),re.TranslationToRef(0,0,-h,ne$5.Matrix[1]),ne$5.Matrix[0].multiplyToRef(ne$5.Matrix[1],ne$5.Matrix[0]),re.OrthoOffCenterRHToRef(e,t,i,s,r,n,l,c),ne$5.Matrix[0].multiplyToRef(l,l),l}static PerspectiveLH(e,t,i,s,r,n=0){const a=new re,o=2*i/e,h=2*i/t,l=(s+i)/(s-i),c=-2*s*i/(s-i),u=Math.tan(n);return re.FromValuesToRef(o,0,0,0,0,h,0,u,0,0,l,1,0,0,c,0,a),r&&a.multiplyToRef(oe$5,a),a._updateIdentityStatus(false),a}static PerspectiveFovLH(e,t,i,s,r,n=0,a=false){const o=new re;return re.PerspectiveFovLHToRef(e,t,i,s,o,true,r,n,a),o}static PerspectiveFovLHToRef(e,t,i,s,r,n=true,a,o=0,h=false){const l=i,c=s,u=1/Math.tan(.5*e),d=n?u/t:u,_=n?u:u*t,f=h&&0===l?-1:0!==c?(c+l)/(c-l):1,p=h&&0===l?2*c:0!==c?-2*c*l/(c-l):-2*l,g=Math.tan(o);return re.FromValuesToRef(d,0,0,0,0,_,0,g,0,0,f,1,0,0,p,0,r),a&&r.multiplyToRef(oe$5,r),r._updateIdentityStatus(false),r}static PerspectiveFovReverseLHToRef(e,t,i,s,r,n=true,a,o=0){const h=1/Math.tan(.5*e),l=n?h/t:h,c=n?h:h*t,u=Math.tan(o);return re.FromValuesToRef(l,0,0,0,0,c,0,u,0,0,-i,1,0,0,1,0,r),a&&r.multiplyToRef(oe$5,r),r._updateIdentityStatus(false),r}static PerspectiveFovRH(e,t,i,s,r,n=0,a=false){const o=new re;return re.PerspectiveFovRHToRef(e,t,i,s,o,true,r,n,a),o}static PerspectiveFovRHToRef(e,t,i,s,r,n=true,a,o=0,h=false){const l=i,c=s,u=1/Math.tan(.5*e),d=n?u/t:u,_=n?u:u*t,f=h&&0===l?1:0!==c?-(c+l)/(c-l):-1,p=h&&0===l?2*c:0!==c?-2*c*l/(c-l):-2*l,g=Math.tan(o);return re.FromValuesToRef(d,0,0,0,0,_,0,g,0,0,f,-1,0,0,p,0,r),a&&r.multiplyToRef(oe$5,r),r._updateIdentityStatus(false),r}static PerspectiveFovReverseRHToRef(e,t,i,s,r,n=true,a,o=0){const h=1/Math.tan(.5*e),l=n?h/t:h,c=n?h:h*t,u=Math.tan(o);return re.FromValuesToRef(l,0,0,0,0,c,0,u,0,0,-i,-1,0,0,-1,0,r),a&&r.multiplyToRef(oe$5,r),r._updateIdentityStatus(false),r}static GetFinalMatrix(e,t,i,s,r,n){const a=e.width,o=e.height,h=e.x,l=e.y,c=re.FromValues(a/2,0,0,0,0,-o/2,0,0,0,0,n-r,0,h+a/2,o/2+l,r,1),u=new re;return t.multiplyToRef(i,u),u.multiplyToRef(s,u),u.multiplyToRef(c,u)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return D$9.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return D$9.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new re;return re.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=e.m,s=i[0],r=i[4],n=i[8],a=i[12],o=i[1],h=i[5],l=i[9],c=i[13],u=i[2],d=i[6],_=i[10],f=i[14],p=i[3],g=i[7],m=i[11],T=i[15],E=t._m;return E[0]=s,E[1]=r,E[2]=n,E[3]=a,E[4]=o,E[5]=h,E[6]=l,E[7]=c,E[8]=u,E[9]=d,E[10]=_,E[11]=f,E[12]=p,E[13]=g,E[14]=m,E[15]=T,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new re;return re.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,s=e.normal.y,r=e.normal.z,n=-2*i,a=-2*s,o=-2*r;return re.FromValuesToRef(n*i+1,a*i,o*i,0,n*s,a*s+1,o*s,0,n*r,a*r,o*r+1,0,n*e.d,a*e.d,o*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,s){return re.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,s),s}static FromQuaternionToRef(e,t){const i=e._x*e._x,s=e._y*e._y,r=e._z*e._z,n=e._x*e._y,a=e._z*e._w,o=e._z*e._x,h=e._y*e._w,l=e._y*e._z,c=e._x*e._w;return t._m[0]=1-2*(s+r),t._m[1]=2*(n+a),t._m[2]=2*(o-h),t._m[3]=0,t._m[4]=2*(n-a),t._m[5]=1-2*(r+i),t._m[6]=2*(l+c),t._m[7]=0,t._m[8]=2*(o+h),t._m[9]=2*(l-c),t._m[10]=1-2*(s+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}};re$5._IdentityReadOnly=re$5.Identity(),Object.defineProperties(re$5.prototype,{dimension:{value:[4,4]},rank:{value:2}});let ne$5=class ne{};ne$5.Vector3=y$e(11,te$4.Zero),ne$5.Matrix=y$e(2,re$5.Identity),ne$5.Quaternion=y$e(3,se$5.Zero);let ae$5=class ae{};ae$5.Vector2=y$e(3,ee$4.Zero),ae$5.Vector3=y$e(13,te$4.Zero),ae$5.Vector4=y$e(3,ie$5.Zero),ae$5.Quaternion=y$e(3,se$5.Zero),ae$5.Matrix=y$e(8,re$5.Identity),P$9("BABYLON.Vector2",ee$4),P$9("BABYLON.Vector3",te$4),P$9("BABYLON.Vector4",ie$5),P$9("BABYLON.Matrix",re$5);const oe$5=re$5.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1),he$5={};function le$4(e,t=false){if(!t||!he$5[e])return he$5[e]=true,`${e} needs to be imported before as it contains a side-effect required by your code.`}let ce$4=class ce{static Eval(e,t){return e=e.match(/\([^()]*\)/g)?e.replace(/\([^()]*\)/g,(e=>(e=e.slice(1,e.length-1),ce._HandleParenthesisContent(e,t)))):ce._HandleParenthesisContent(e,t),"true"===e||"false"!==e&&ce.Eval(e,t)}static _HandleParenthesisContent(e,t){let i;t=t||(e=>"true"===e);const s=e.split("||");for(const e in s)if(Object.prototype.hasOwnProperty.call(s,e)){let r=ce._SimplifyNegation(s[e].trim());const n=r.split("&&");if(n.length>1)for(let e=0;e<n.length;++e){const s=ce._SimplifyNegation(n[e].trim());if(i="true"!==s&&"false"!==s?"!"===s[0]?!t(s.substring(1)):t(s):"true"===s,!i){r="false";break}}if(i||"true"===r){i=true;break}i="true"!==r&&"false"!==r?"!"===r[0]?!t(r.substring(1)):t(r):"true"===r;}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,(e=>(e=e.replace(/[\s]/g,(()=>""))).length%2?"!":"")),"!true"===(e=e.trim())?e="false":"!false"===e&&(e="true"),e}};let ue$4=class ue{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>ue.HasTags(e),e.addTags=t=>ue.AddTagsTo(e,t),e.removeTags=t=>ue.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>ue.MatchesQuery(e,t);}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery;}static HasTags(e){if(!e._tags)return  false;const t=e._tags;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return  true;return  false}static GetTags(e,t=true){if(!e._tags)return null;if(t){const t=[];for(const i in e._tags)Object.prototype.hasOwnProperty.call(e._tags,i)&&true===e._tags[i]&&t.push(i);return t.join(" ")}return e._tags}static AddTagsTo(e,t){if(!t)return;if("string"!=typeof t)return;const i=t.split(" ");for(const t of i)ue._AddTagTo(e,t);}static _AddTagTo(e,t){""!==(t=t.trim())&&"true"!==t&&"false"!==t&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(ue.EnableFor(e),e._tags[t]=true));}static RemoveTagsFrom(e,t){if(!ue.HasTags(e))return;const i=t.split(" ");for(const t in i)ue._RemoveTagFrom(e,i[t]);}static _RemoveTagFrom(e,t){delete e._tags[t];}static MatchesQuery(e,t){return void 0===t||(""===t?ue.HasTags(e):ce$4.Eval(t,(t=>ue.HasTags(e)&&e._tags[t])))}};function de$3(e){return Math.pow(e,S$d)}function _e$3(e){return e<=.04045?.0773993808*e:Math.pow(.947867299*(e+.055),2.4)}function fe$3(e){return Math.pow(e,b$f)}function pe$3(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let ge$3=class ge{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i;}toString(){return "{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return "Color3"}getHashCode(){let e=255*this.r|0;return e=397*e^255*this.g,e=397*e^255*this.b,e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return ge.FromArrayToRef(e,t,this),this}toColor4(e=1){return new me$3(this.r,this.g,this.b,e)}asArray(){return [this.r,this.g,this.b]}toLuminance(){return .3*this.r+.59*this.g+.11*this.b}multiply(e){return new ge(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyByFloats(e,t,i){return new ge(this.r*e,this.g*t,this.b*i)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.r,e.g,e.b)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.r,e.g,e.b)}minimizeInPlaceFromFloats(e,t,i){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this}maximizeInPlaceFromFloats(e,t,i){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.equalsToFloats(e,t,i)}equalsToFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}equalsWithEpsilon(e,t=.001){return F$8(this.r,e.r,t)&&F$8(this.g,e.g,t)&&F$8(this.b,e.b,t)}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}scale(e){return new ge(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t}clampToRef(e=0,t=1,i){return i.r=U$5(this.r,e,t),i.g=U$5(this.g,e,t),i.b=U$5(this.b,e,t),i}add(e){return new ge(this.r+e.r,this.g+e.g,this.b+e.b)}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addInPlaceFromFloats(e,t,i){return this.r+=e,this.g+=t,this.b+=i,this}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t}subtract(e){return new ge(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this}subtractFromFloats(e,t,i){return new ge(this.r-e,this.g-t,this.b-i)}subtractFromFloatsToRef(e,t,i,s){return s.r=this.r-e,s.g=this.g-t,s.b=this.b-i,s}clone(){return new ge(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this.r=this.g=this.b=e,this}toHexString(){const e=Math.round(255*this.r),t=Math.round(255*this.g),i=Math.round(255*this.b);return "#"+G$4(e)+G$4(t)+G$4(i)}fromHexString(e){return "#"!==e.substring(0,1)||7!==e.length||(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255),this}toHSV(){return this.toHSVToRef(new ge)}toHSVToRef(e){const t=this.r,i=this.g,s=this.b,r=Math.max(t,i,s),n=Math.min(t,i,s);let a=0,o=0;const h=r,l=r-n;return 0!==r&&(o=l/r),r!=n&&(r==t?(a=(i-s)/l,i<s&&(a+=6)):r==i?a=(s-t)/l+2:r==s&&(a=(t-i)/l+4),a*=60),e.r=a,e.g=o,e.b=h,e}toLinearSpace(e=false){const t=new ge;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=false){return t?(e.r=_e$3(this.r),e.g=_e$3(this.g),e.b=_e$3(this.b)):(e.r=de$3(this.r),e.g=de$3(this.g),e.b=de$3(this.b)),this}toGammaSpace(e=false){const t=new ge;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=false){return t?(e.r=pe$3(this.r),e.g=pe$3(this.g),e.b=pe$3(this.b)):(e.r=fe$3(this.r),e.g=fe$3(this.g),e.b=fe$3(this.b)),this}static HSVtoRGBToRef(e,t,i,s){const r=i*t,n=e/60,a=r*(1-Math.abs(n%2-1));let o=0,h=0,l=0;n>=0&&n<=1?(o=r,h=a):n>=1&&n<=2?(o=a,h=r):n>=2&&n<=3?(h=r,l=a):n>=3&&n<=4?(h=a,l=r):n>=4&&n<=5?(o=a,l=r):n>=5&&n<=6&&(o=r,l=a);const c=i-r;return s.r=o+c,s.g=h+c,s.b=l+c,s}static FromHSV(e,t,i){const s=new ge(0,0,0);return ge.HSVtoRGBToRef(e,t,i,s),s}static FromHexString(e){return new ge(0,0,0).fromHexString(e)}static FromArray(e,t=0){return new ge(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2];}static FromInts(e,t,i){return new ge(e/255,t/255,i/255)}static Lerp(e,t,i){const s=new ge(0,0,0);return ge.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i;}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+r,c=a-n,u=e.r*o+i.r*h+t.r*l+s.r*c,d=e.g*o+i.g*h+t.g*l+s.g*c,_=e.b*o+i.b*h+t.b*l+s.b*c;return new ge(u,d,_)}static Hermite1stDerivative(e,t,i,s,r){const n=ge.Black();return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;n.r=6*(a-r)*e.r+(3*a-4*r+1)*t.r+6*(-a+r)*i.r+(3*a-2*r)*s.r,n.g=6*(a-r)*e.g+(3*a-4*r+1)*t.g+6*(-a+r)*i.g+(3*a-2*r)*s.g,n.b=6*(a-r)*e.b+(3*a-4*r+1)*t.b+6*(-a+r)*i.b+(3*a-2*r)*s.b;}static Red(){return new ge(1,0,0)}static Green(){return new ge(0,1,0)}static Blue(){return new ge(0,0,1)}static Black(){return new ge(0,0,0)}static get BlackReadOnly(){return ge._BlackReadOnly}static White(){return new ge(1,1,1)}static Purple(){return new ge(.5,0,.5)}static Magenta(){return new ge(1,0,1)}static Yellow(){return new ge(1,1,0)}static Gray(){return new ge(.5,.5,.5)}static Teal(){return new ge(0,1,1)}static Random(){return new ge(Math.random(),Math.random(),Math.random())}};ge$3._V8PerformanceHack=new ge$3(.5,.5,.5),ge$3._BlackReadOnly=ge$3.Black(),Object.defineProperties(ge$3.prototype,{dimension:{value:[3]},rank:{value:1}});let me$3=class me{constructor(e=0,t=0,i=0,s=1){this.r=e,this.g=t,this.b=i,this.a=s;}asArray(){return [this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3],this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new me(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}addInPlaceFromFloats(e,t,i,s){return this.r+=e,this.g+=t,this.b+=i,this.a+=s,this}subtract(e){return new me(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}subtractFromFloats(e,t,i,s){return new me(this.r-e,this.g-t,this.b-i,this.a-s)}subtractFromFloatsToRef(e,t,i,s,r){return r.r=this.r-e,r.g=this.g-t,r.b=this.b-i,r.a=this.a-s,r}scale(e){return new me(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,t}clampToRef(e=0,t=1,i){return i.r=U$5(this.r,e,t),i.g=U$5(this.g,e,t),i.b=U$5(this.b,e,t),i.a=U$5(this.a,e,t),i}multiply(e){return new me(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this.a*=e.a,this}multiplyByFloats(e,t,i,s){return new me(this.r*e,this.g*t,this.b*i,this.a*s)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.r=Math.min(this.r,e.r),this.g=Math.min(this.g,e.g),this.b=Math.min(this.b,e.b),this.a=Math.min(this.a,e.a),this}maximizeInPlace(e){return this.r=Math.max(this.r,e.r),this.g=Math.max(this.g,e.g),this.b=Math.max(this.b,e.b),this.a=Math.max(this.a,e.a),this}minimizeInPlaceFromFloats(e,t,i,s){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this.a=Math.min(s,this.a),this}maximizeInPlaceFromFloats(e,t,i,s){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this.a=Math.max(s,this.a),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}equalsWithEpsilon(e,t=.001){return F$8(this.r,e.r,t)&&F$8(this.g,e.g,t)&&F$8(this.b,e.b,t)&&F$8(this.a,e.a,t)}equalsToFloats(e,t,i,s){return this.r===e&&this.g===t&&this.b===i&&this.a===s}toString(){return "{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return "Color4"}getHashCode(){let e=255*this.r|0;return e=397*e^255*this.g,e=397*e^255*this.b,e=397*e^255*this.a,e}clone(){return (new me).copyFrom(this)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.r=this.g=this.b=this.a=e,this}toHexString(e=false){const t=Math.round(255*this.r),i=Math.round(255*this.g),s=Math.round(255*this.b);if(e)return "#"+G$4(t)+G$4(i)+G$4(s);const r=Math.round(255*this.a);return "#"+G$4(t)+G$4(i)+G$4(s)+G$4(r)}fromHexString(e){return "#"!==e.substring(0,1)||9!==e.length&&7!==e.length||(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,9===e.length&&(this.a=parseInt(e.substring(7,9),16)/255)),this}toLinearSpace(e=false){const t=new me;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=false){return t?(e.r=_e$3(this.r),e.g=_e$3(this.g),e.b=_e$3(this.b)):(e.r=de$3(this.r),e.g=de$3(this.g),e.b=de$3(this.b)),e.a=this.a,this}toGammaSpace(e=false){const t=new me;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=false){return t?(e.r=pe$3(this.r),e.g=pe$3(this.g),e.b=pe$3(this.b)):(e.r=fe$3(this.r),e.g=fe$3(this.g),e.b=fe$3(this.b)),e.a=this.a,this}static FromHexString(e){return "#"!==e.substring(0,1)||9!==e.length&&7!==e.length?new me(0,0,0,0):new me(0,0,0,1).fromHexString(e)}static Lerp(e,t,i){return me.LerpToRef(e,t,i,new me)}static LerpToRef(e,t,i,s){return s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i,s.a=e.a+(t.a-e.a)*i,s}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,h=-2*a+3*n,l=a-2*n+r,c=a-n,u=e.r*o+i.r*h+t.r*l+s.r*c,d=e.g*o+i.g*h+t.g*l+s.g*c,_=e.b*o+i.b*h+t.b*l+s.b*c,f=e.a*o+i.a*h+t.a*l+s.a*c;return new me(u,d,_,f)}static Hermite1stDerivative(e,t,i,s,r){const n=new me;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;n.r=6*(a-r)*e.r+(3*a-4*r+1)*t.r+6*(-a+r)*i.r+(3*a-2*r)*s.r,n.g=6*(a-r)*e.g+(3*a-4*r+1)*t.g+6*(-a+r)*i.g+(3*a-2*r)*s.g,n.b=6*(a-r)*e.b+(3*a-4*r+1)*t.b+6*(-a+r)*i.b+(3*a-2*r)*s.b,n.a=6*(a-r)*e.a+(3*a-4*r+1)*t.a+6*(-a+r)*i.a+(3*a-2*r)*s.a;}static FromColor3(e,t=1){return new me(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new me(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3];}static FromInts(e,t,i,s){return new me(e/255,t/255,i/255,s/255)}static CheckColors4(e,t){if(e.length===3*t){const t=[];for(let i=0;i<e.length;i+=3){const s=i/3*4;t[s]=e[i],t[s+1]=e[i+1],t[s+2]=e[i+2],t[s+3]=1;}return t}return e}};me$3._V8PerformanceHack=new me$3(.5,.5,.5,.5),Object.defineProperties(me$3.prototype,{dimension:{value:[4]},rank:{value:1}});let Te$3=class Te{};Te$3.Color3=M$d(3,ge$3.Black),Te$3.Color4=M$d(3,(()=>new me$3(0,0,0,0))),P$9("BABYLON.Color3",ge$3),P$9("BABYLON.Color4",me$3);const Ee$3=function(e,t,i,r={}){const n=e();ue$4&&ue$4.HasTags(t)&&ue$4.AddTagsTo(n,ue$4.GetTags(t,true));const a=s$v(n),o={};for(const e in a){const s=a[e],h=t[e],l=s.type;if(null!=h&&("uniqueId"!==e||Ae$3.AllowLoadingUniqueId))switch(l){case 0:case 6:case 9:case 11:n[e]=h;break;case 1:r.cloneTexturesOnlyOnce&&o[h.uniqueId]?n[e]=o[h.uniqueId]:(n[e]=i||h.isRenderTarget?h:h.clone(),o[h.uniqueId]=n[e]);break;case 2:case 3:case 4:case 5:case 7:case 8:case 10:case 12:n[e]=i?h:h.clone();}}return n};let Ae$3=class Ae{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const s=e.animations[i];t.animations.push(s.serialize());}}}static Serialize(e,t){t||(t={}),ue$4&&(t.tags=ue$4.GetTags(e));const i=s$v(e);for(const s in i){const r=i[s],n=r.sourceName||s,a=r.type,o=e[s];if(null!=o&&("uniqueId"!==s||Ae.AllowLoadingUniqueId))switch(a){case 0:Array.isArray(o)?t[n]=o.slice():t[n]=o;break;case 1:case 3:case 7:case 9:t[n]=o.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:t[n]=o.asArray();break;case 6:case 11:t[n]=o.id;}}return t}static ParseProperties(e,t,i,r){r||(r="");const n=s$v(t);for(const s in n){const a=n[s],o=e[a.sourceName||s],h=a.type;if(null!=o&&("uniqueId"!==s||Ae.AllowLoadingUniqueId)){const e=t;switch(h){case 0:e[s]=o;break;case 1:i&&(e[s]=Ae._TextureParser(o,i,r));break;case 2:e[s]=ge$3.FromArray(o);break;case 3:e[s]=Ae._FresnelParametersParser(o);break;case 4:e[s]=ee$4.FromArray(o);break;case 5:e[s]=te$4.FromArray(o);break;case 6:i&&(e[s]=i.getLastMeshById(o));break;case 7:e[s]=Ae._ColorCurvesParser(o);break;case 8:e[s]=me$3.FromArray(o);break;case 9:e[s]=Ae._ImageProcessingConfigurationParser(o);break;case 10:e[s]=se$5.FromArray(o);break;case 11:i&&(e[s]=i.getCameraById(o));break;case 12:e[s]=re$5.FromArray(o);}}}}static Parse(e,t,i,s=null){const r=e();return ue$4&&ue$4.AddTagsTo(r,t.tags),Ae.ParseProperties(t,r,i,s),r}static Clone(e,t,i={}){return Ee$3(e,t,false,i)}static Instanciate(e,t){return Ee$3(e,t,true)}};Ae$3.AllowLoadingUniqueId=false,Ae$3._ImageProcessingConfigurationParser=e=>{throw le$4("ImageProcessingConfiguration")},Ae$3._FresnelParametersParser=e=>{throw le$4("FresnelParameters")},Ae$3._ColorCurvesParser=e=>{throw le$4("ColorCurves")},Ae$3._TextureParser=(e,t,i)=>{throw le$4("Texture")};let Re$3=class Re{constructor(){this._doNotSerialize=false,this._isDisposed=false,this._sceneRootNodesIndex=-1,this._isEnabled=true,this._isParentEnabled=true,this._isReady=true,this._onEnabledStateChangedObservable=new R$g,this._onClonedObservable=new R$g,this._inheritVisibility=false,this._isVisible=true;}};let be$3=class be{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t;}static Construct(e,t,i,s){const r=this._NodeConstructors[e];return r?r(t,i,s):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e);}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return !!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e;}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){const t=this._parentNode._children.indexOf(this);-1!==t&&this._parentNode._children.splice(t,1),e||this._nodeDataStorage._isDisposed||this._addToSceneRootNodes();}this._parentNode=e,this._isDirty=true,this._parentNode&&(void 0!==this._parentNode._children&&null!==this._parentNode._children||(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState();}get parent(){return this._parentNode}get inheritVisibility(){return this._nodeDataStorage._inheritVisibility}set inheritVisibility(e){this._nodeDataStorage._inheritVisibility=e;}get isVisible(){return !(this.inheritVisibility&&this._parentNode&&!this._parentNode.isVisible)&&this._nodeDataStorage._isVisible}set isVisible(e){this._nodeDataStorage._isVisible=e;}_serializeAsParent(e){e.parentId=this.uniqueId;}_addToSceneRootNodes(){ -1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this));}_removeFromSceneRootNodes(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1;}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e;}getClassName(){return "Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e);}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null,i=true){this._isDirty=false,this._nodeDataStorage=new Re$3,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new R$g,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=re$5.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=true,this._animationPropertiesOverride=null,this._isNode=true,this.onDisposeObservable=new R$g,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||L$7.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache(),i&&this._addToSceneRootNodes();}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=false){return  -1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce((()=>{this._behaviors.includes(e)&&e.attach(this);})):e.attach(this),this._behaviors.push(e)),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return  -1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=false,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={};}updateCache(e){!e&&this.isSynchronized()||this._updateCache();}_getActionManagerForTrigger(e,t=true){return this.parent?this.parent._getActionManagerForTrigger(e,false):null}_updateCache(e){}_isSynchronized(){return  true}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId);}isSynchronizedWithParent(){return !this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}isSynchronized(){return !(this._parentNode&&!this.isSynchronizedWithParent())&&this._isSynchronized()}isReady(e=false){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=true,this}isEnabled(e=true){return  false===e?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}_syncParentEnabledState(){if(this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children)for(const e of this._children)e._syncParentEnabledState();}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e));}isDescendantOf(e){return !!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}_getDescendants(e,t=false,i){if(this._children)for(let s=0;s<this._children.length;s++){const r=this._children[s];i&&!i(r)||e.push(r),t||r._getDescendants(e,false,i);}}getDescendants(e,t){const i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,(e=>(!t||t(e))&&void 0!==e.cullingStrategy)),i}getChildren(e,t=true){return this.getDescendants(t,e)}_setReady(e){e!==this._nodeDataStorage._isReady&&(e?(this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=true):this._nodeDataStorage._isReady=false);}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=be._AnimationRangeFactory(e,t,i);for(let s=0,r=this.animations.length;s<r;s++)this.animations[s]&&this.animations[s].createRange(e,t,i);}}deleteAnimationRange(e,t=true){for(let i=0,s=this.animations.length;i<s;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null;}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const s=Ae$3.Clone((()=>new be(e,this.getScene())),this);if(t&&(s.parent=t),!i){const t=this.getDescendants(true);for(let i=0;i<t.length;i++){const r=t[i];r.clone(e+"."+r.name,s);}}return s}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,s){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.push(s);}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=re$5.Identity()),this._worldMatrix}dispose(e,t=false){if(this._nodeDataStorage._isDisposed=true,!e){const i=this.getDescendants(true);for(const s of i)s.dispose(e,t);}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const e of this._behaviors)e.detach();this._behaviors.length=0,this.metadata=null;}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let i=0;i<t.ranges.length;i++){const s=t.ranges[i];e.createAnimationRange(s.name,s.from,s.to);}}getHierarchyBoundingVectors(e=true,t=null){let i,s;this.getScene().incrementRenderId(),this.computeWorldMatrix(true);const r=this;if(r.getBoundingInfo&&r.subMeshes){const e=r.getBoundingInfo();i=e.boundingBox.minimumWorld.clone(),s=e.boundingBox.maximumWorld.clone();}else i=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new te$4(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const e=this.getDescendants(false);for(const r of e){const e=r;if(e.computeWorldMatrix(true),t&&!t(e))continue;if(!e.getBoundingInfo||0===e.getTotalVertices())continue;const n=e.getBoundingInfo().boundingBox,a=n.minimumWorld,o=n.maximumWorld;te$4.CheckExtends(a,i,s),te$4.CheckExtends(o,i,s);}}return {min:i,max:s}}};function Se$2(){return "undefined"!=typeof window}function xe$3(){return "undefined"!=typeof navigator}function Me$3(){return "undefined"!=typeof document}function ye$3(e){let t="",i=e.firstChild;for(;i;)3===i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t}be$3._AnimationRangeFactory=(e,t,i)=>{throw le$4("AnimationRange")},be$3._NodeConstructors={},e$z([a$$()],be$3.prototype,"name",void 0),e$z([a$$()],be$3.prototype,"id",void 0),e$z([a$$()],be$3.prototype,"uniqueId",void 0),e$z([a$$()],be$3.prototype,"state",void 0),e$z([a$$()],be$3.prototype,"metadata",void 0);let Ie$2=class Ie{static _CheckLimit(e,t){let i=Ie._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},Ie._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){const i=Ie._LogLimitOutputs[e];if(!i||!Ie.MessageLimitReached)return;const s=this._Levels[t];i.current===i.limit&&Ie[s.name](Ie.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,s.name??""));}static _AddLogEntry(e){Ie._LogCache=e+Ie._LogCache,Ie.OnNewCacheEntry&&Ie.OnNewCacheEntry(e);}static _FormatMessage(e){const t=e=>e<10?"0"+e:""+e,i=new Date;return "["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){const s=Array.isArray(t)?t[0]:t;if(void 0!==i&&!Ie._CheckLimit(s,i))return;const r=Ie._FormatMessage(s),n=this._Levels[e],a=Array.isArray(t)?t.slice(1):[];n.logFunc&&n.logFunc("BJS - "+r,...a);const o=`<div style='color:${n.color}'>${r}</div><br>`;Ie._AddLogEntry(o),Ie._GenerateLimitMessage(s,e);}static get LogCache(){return Ie._LogCache}static ClearLogCache(){Ie._LogCache="",Ie._LogLimitOutputs={},Ie.errorsCount=0;}static set LogLevels(e){Ie.Log=Ie._LogDisabled,Ie.Warn=Ie._LogDisabled,Ie.Error=Ie._LogDisabled;const t=[Ie.MessageLogLevel,Ie.WarningLogLevel,Ie.ErrorLogLevel];for(const i of t)if((e&i)===i){const e=this._Levels[i];Ie[e.name]=Ie._LogEnabled.bind(Ie,i);}}};Ie$2.NoneLogLevel=0,Ie$2.MessageLogLevel=1,Ie$2.WarningLogLevel=2,Ie$2.ErrorLogLevel=4,Ie$2.AllLogLevel=7,Ie$2.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",Ie$2._LogCache="",Ie$2._LogLimitOutputs={},Ie$2._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],Ie$2.errorsCount=0,Ie$2.Log=Ie$2._LogEnabled.bind(Ie$2,Ie$2.MessageLogLevel),Ie$2.Warn=Ie$2._LogEnabled.bind(Ie$2,Ie$2.WarningLogLevel),Ie$2.Error=Ie$2._LogEnabled.bind(Ie$2,Ie$2.ErrorLogLevel);const Ce$3=(e,t,i)=>e?e.getClassName&&"Mesh"===e.getClassName()?null:!e.getClassName||"SubMesh"!==e.getClassName()&&"PhysicsBody"!==e.getClassName()?e.clone?e.clone():Array.isArray(e)?e.slice():i&&"object"==typeof e?{...e}:null:e.clone(t):null;let ve$3=class ve{static DeepCopy(e,t,i,s,r=false){const n=function(e){const t=[];do{const i=Object.getOwnPropertyNames(e);for(const e of i) -1===t.indexOf(e)&&t.push(e);}while(e=Object.getPrototypeOf(e));return t}(e);for(const a of n){if("_"===a[0]&&(!s||-1===s.indexOf(a)))continue;if(a.endsWith("Observable"))continue;if(i&&-1!==i.indexOf(a))continue;const n=e[a],o=typeof n;if("function"!==o)try{if("object"===o)if(n instanceof Uint8Array)t[a]=Uint8Array.from(n);else if(n instanceof Array){if(t[a]=[],n.length>0)if("object"==typeof n[0])for(let e=0;e<n.length;e++){const i=Ce$3(n[e],t,r);-1===t[a].indexOf(i)&&t[a].push(i);}else t[a]=n.slice(0);}else t[a]=Ce$3(n,t,r);else t[a]=n;}catch(e){Ie$2.Warn(e.message);}}}};let Pe$2=class Pe{static get Now(){return Se$2()&&window.performance&&window.performance.now?window.performance.now():Date.now()}};let Oe$3=class Oe{constructor(){this._xhr="undefined"!=typeof _native&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest,this._requestURL="";}static get IsCustomRequestAvailable(){return Object.keys(Oe.CustomRequestHeaders).length>0||Oe.CustomRequestModifiers.length>0}get requestURL(){return this._requestURL}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in Oe.CustomRequestHeaders){const t=Oe.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t);}}_shouldSkipRequestModifications(e){return Oe.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e;}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e;}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e;}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i);}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i);}abort(){this._xhr.abort();}send(e){Oe.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e);}open(e,t){for(const e of Oe.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;t=e(this._xhr,t)||t;}t=(t=t.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,true);}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t);}getResponseHeader(e){return this._xhr.getResponseHeader(e)}};Oe$3.CustomRequestHeaders={},Oe$3.CustomRequestModifiers=new Array,Oe$3.SkipRequestModificationForBabylonCDN=true;let De$2=class De{};De$2.FilesToLoad={};let Le$2=class Le extends Error{};Le$2._setPrototypeOf=Object.setPrototypeOf||((e,t)=>(e.__proto__=t,e));const Fe$2={MeshInvalidPositionsError:0,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};let we$3=class we extends Le$2{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",Le$2._setPrototypeOf(this,we.prototype);}};let Ne$1=class Ne extends Le$2{constructor(e="Operation aborted"){super(e),this.name="AbortError",Le$2._setPrototypeOf(this,Ne.prototype);}};const Be$2=e=>{if("undefined"!=typeof TextDecoder)return (new TextDecoder).decode(e);let t="";for(let i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t},Ue$2=e=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i,s,r,n,a,o,h,l="",c=0;const u=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);for(;c<u.length;)i=u[c++],s=c<u.length?u[c++]:Number.NaN,r=c<u.length?u[c++]:Number.NaN,n=i>>2,a=(3&i)<<4|s>>4,o=(15&s)<<2|r>>6,h=63&r,isNaN(s)?o=h=64:isNaN(r)&&(h=64),l+=t.charAt(n)+t.charAt(a)+t.charAt(o)+t.charAt(h);return l},ke$2=e=>atob(e);let Ge$1=class Ge{constructor(){this.children=[];}isValid(e){return  true}process(e,t,i){let s="";if(this.line){let i=this.line;const r=t.processor;if(r){r.lineProcessor&&(i=r.lineProcessor(i,t.isFragment,t.processingContext));const s=t.processor?.attributeKeywordName??"attribute",n=t.isFragment&&t.processor?.varyingFragmentKeywordName?t.processor?.varyingFragmentKeywordName:!t.isFragment&&t.processor?.varyingVertexKeywordName?t.processor?.varyingVertexKeywordName:"varying";if(!t.isFragment&&r.attributeProcessor&&this.line.startsWith(s))i=r.attributeProcessor(this.line,e,t.processingContext);else if(r.varyingProcessor&&(r.varyingCheck?.(this.line,t.isFragment)||!r.varyingCheck&&this.line.startsWith(n)))i=r.varyingProcessor(this.line,t.isFragment,e,t.processingContext);else if(r.uniformProcessor&&r.uniformRegexp&&r.uniformRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(i=r.uniformProcessor(this.line,t.isFragment,e,t.processingContext));else if(r.uniformBufferProcessor&&r.uniformBufferRegexp&&r.uniformBufferRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(i=r.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=true);else if(r.textureProcessor&&r.textureRegexp&&r.textureRegexp.test(this.line))i=r.textureProcessor(this.line,t.isFragment,e,t.processingContext);else if((r.uniformProcessor||r.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer){/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?r.uniformProcessor&&(i=r.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):r.uniformBufferProcessor&&(i=r.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=true);}t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=false,r.endOfUniformBufferProcessor&&(i=r.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)));}s+=i+"\n";}for(const r of this.children)s+=r.process(e,t,i);return this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true",i[this.additionalDefineKey]=e[this.additionalDefineKey]),s}};let Ve$2=class Ve{constructor(){this._lines=[];}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||"\r"===t)continue;if("#"===t[0]){this._lines.push(t);continue}const e=t.trim();if(!e)continue;if(e.startsWith("//")){this._lines.push(t);continue}const i=e.indexOf(";");if(-1===i)this._lines.push(e);else if(i===e.length-1)e.length>1&&this._lines.push(e);else {const e=t.split(";");for(let t=0;t<e.length;t++){let i=e[t];i&&(i=i.trim(),i&&this._lines.push(i+(t!==e.length-1?";":"")));}}}}};let He$2=class He extends Ge$1{process(e,t,i){for(let s=0;s<this.children.length;s++){const r=this.children[s];if(r.isValid(e))return r.process(e,t,i)}return ""}};let ze$2=class ze extends Ge$1{isValid(e){return this.testExpression.isTrue(e)}};let Xe$1=class Xe{isTrue(e){return  true}static postfixToInfix(e){const t=[];for(const i of e)if(void 0===Xe._OperatorPriority[i])t.push(i);else {const e=t[t.length-1],s=t[t.length-2];t.length-=2,t.push(`(${s}${i}${e})`);}return t[t.length-1]}static infixToPostfix(e){const t=Xe._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!(e.includes("&&")||e.includes("||")||e.includes(")")||e.includes("(")))return [e];const i=[];let s=-1;const r=()=>{l=l.trim(),""!==l&&(i.push(l),l="");},n=e=>{s<Xe._Stack.length-1&&(Xe._Stack[++s]=e);},a=()=>Xe._Stack[s],o=()=>-1===s?"!!INVALID EXPRESSION!!":Xe._Stack[s--];let h=0,l="";for(;h<e.length;){const t=e.charAt(h),c=h<e.length-1?e.substring(h,2+h):"";if("("===t)l="",n(t);else if(")"===t){for(r();-1!==s&&"("!==a();)i.push(o());o();}else if(Xe._OperatorPriority[c]>1){for(r();-1!==s&&Xe._OperatorPriority[a()]>=Xe._OperatorPriority[c];)i.push(o());n(c),h++;}else l+=t;h++;}for(r();-1!==s;)"("===a()?o():i.push(o());return Xe._InfixToPostfixCache.size>=Xe.InfixToPostfixCacheLimitSize&&Xe.ClearCache(),Xe._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(Xe._InfixToPostfixCache.entries()).sort(((e,t)=>e[1].accessTime-t[1].accessTime));for(let t=0;t<Xe.InfixToPostfixCacheCleanupSize;t++)Xe._InfixToPostfixCache.delete(e[t][0]);}};Xe$1.InfixToPostfixCacheLimitSize=5e4,Xe$1.InfixToPostfixCacheCleanupSize=25e3,Xe$1._InfixToPostfixCache=new Map,Xe$1._OperatorPriority={")":0,"(":1,"||":2,"&&":3},Xe$1._Stack=["","","","","","","","","","","","","","","","","","","",""];let We$1=class We extends Xe$1{constructor(e,t=false){super(),this.define=e,this.not=t;}isTrue(e){let t=void 0!==e[this.define];return this.not&&(t=!t),t}};let Ye$1=class Ye extends Xe$1{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}};let Ke$1=class Ke extends Xe$1{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}};let je$1=class je extends Xe$1{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i;}toString(){return `${this.define} ${this.operand} ${this.testValue}`}isTrue(e){let t=false;const i=parseInt(null!=e[this.define]?e[this.define]:this.define),s=parseInt(null!=e[this.testValue]?e[this.testValue]:this.testValue);if(isNaN(i)||isNaN(s))return  false;switch(this.operand){case ">":t=i>s;break;case "<":t=i<s;break;case "<=":t=i<=s;break;case ">=":t=i>=s;break;case "==":t=i===s;break;case "!=":t=i!==s;}return t}};let Qe$1=class Qe{};Qe$1.AUTOSAMPLERSUFFIX="Sampler",Qe$1.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS",Qe$1.ALPHA_DISABLE=0,Qe$1.ALPHA_ADD=1,Qe$1.ALPHA_COMBINE=2,Qe$1.ALPHA_SUBTRACT=3,Qe$1.ALPHA_MULTIPLY=4,Qe$1.ALPHA_MAXIMIZED=5,Qe$1.ALPHA_ONEONE=6,Qe$1.ALPHA_PREMULTIPLIED=7,Qe$1.ALPHA_PREMULTIPLIED_PORTERDUFF=8,Qe$1.ALPHA_INTERPOLATE=9,Qe$1.ALPHA_SCREENMODE=10,Qe$1.ALPHA_ONEONE_ONEONE=11,Qe$1.ALPHA_ALPHATOCOLOR=12,Qe$1.ALPHA_REVERSEONEMINUS=13,Qe$1.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,Qe$1.ALPHA_ONEONE_ONEZERO=15,Qe$1.ALPHA_EXCLUSION=16,Qe$1.ALPHA_LAYER_ACCUMULATE=17,Qe$1.ALPHA_MIN=18,Qe$1.ALPHA_MAX=19,Qe$1.ALPHA_DUAL_SRC0_ADD_SRC1xDST=20,Qe$1.ALPHA_EQUATION_ADD=0,Qe$1.ALPHA_EQUATION_SUBSTRACT=1,Qe$1.ALPHA_EQUATION_REVERSE_SUBTRACT=2,Qe$1.ALPHA_EQUATION_MAX=3,Qe$1.ALPHA_EQUATION_MIN=4,Qe$1.ALPHA_EQUATION_DARKEN=5,Qe$1.DELAYLOADSTATE_NONE=0,Qe$1.DELAYLOADSTATE_LOADED=1,Qe$1.DELAYLOADSTATE_LOADING=2,Qe$1.DELAYLOADSTATE_NOTLOADED=4,Qe$1.NEVER=512,Qe$1.ALWAYS=519,Qe$1.LESS=513,Qe$1.EQUAL=514,Qe$1.LEQUAL=515,Qe$1.GREATER=516,Qe$1.GEQUAL=518,Qe$1.NOTEQUAL=517,Qe$1.KEEP=7680,Qe$1.ZERO=0,Qe$1.REPLACE=7681,Qe$1.INCR=7682,Qe$1.DECR=7683,Qe$1.INVERT=5386,Qe$1.INCR_WRAP=34055,Qe$1.DECR_WRAP=34056,Qe$1.TEXTURE_CLAMP_ADDRESSMODE=0,Qe$1.TEXTURE_WRAP_ADDRESSMODE=1,Qe$1.TEXTURE_MIRROR_ADDRESSMODE=2,Qe$1.TEXTURE_CREATIONFLAG_STORAGE=1,Qe$1.TEXTUREFORMAT_ALPHA=0,Qe$1.TEXTUREFORMAT_LUMINANCE=1,Qe$1.TEXTUREFORMAT_LUMINANCE_ALPHA=2,Qe$1.TEXTUREFORMAT_RGB=4,Qe$1.TEXTUREFORMAT_RGBA=5,Qe$1.TEXTUREFORMAT_RED=6,Qe$1.TEXTUREFORMAT_R=6,Qe$1.TEXTUREFORMAT_R16_UNORM=33322,Qe$1.TEXTUREFORMAT_RG16_UNORM=33324,Qe$1.TEXTUREFORMAT_RGB16_UNORM=32852,Qe$1.TEXTUREFORMAT_RGBA16_UNORM=32859,Qe$1.TEXTUREFORMAT_R16_SNORM=36760,Qe$1.TEXTUREFORMAT_RG16_SNORM=36761,Qe$1.TEXTUREFORMAT_RGB16_SNORM=36762,Qe$1.TEXTUREFORMAT_RGBA16_SNORM=36763,Qe$1.TEXTUREFORMAT_RG=7,Qe$1.TEXTUREFORMAT_RED_INTEGER=8,Qe$1.TEXTUREFORMAT_R_INTEGER=8,Qe$1.TEXTUREFORMAT_RG_INTEGER=9,Qe$1.TEXTUREFORMAT_RGB_INTEGER=10,Qe$1.TEXTUREFORMAT_RGBA_INTEGER=11,Qe$1.TEXTUREFORMAT_BGRA=12,Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8=13,Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT=14,Qe$1.TEXTUREFORMAT_DEPTH16=15,Qe$1.TEXTUREFORMAT_DEPTH24=16,Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,Qe$1.TEXTUREFORMAT_STENCIL8=19,Qe$1.TEXTUREFORMAT_UNDEFINED=4294967295,Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,Qe$1.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,Qe$1.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,Qe$1.TEXTURETYPE_UNSIGNED_BYTE=0,Qe$1.TEXTURETYPE_UNSIGNED_INT=0,Qe$1.TEXTURETYPE_FLOAT=1,Qe$1.TEXTURETYPE_HALF_FLOAT=2,Qe$1.TEXTURETYPE_BYTE=3,Qe$1.TEXTURETYPE_SHORT=4,Qe$1.TEXTURETYPE_UNSIGNED_SHORT=5,Qe$1.TEXTURETYPE_INT=6,Qe$1.TEXTURETYPE_UNSIGNED_INTEGER=7,Qe$1.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,Qe$1.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,Qe$1.TEXTURETYPE_UNSIGNED_INT_24_8=12,Qe$1.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,Qe$1.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,Qe$1.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,Qe$1.TEXTURETYPE_UNDEFINED=16,Qe$1.TEXTURE_2D=3553,Qe$1.TEXTURE_2D_ARRAY=35866,Qe$1.TEXTURE_CUBE_MAP=34067,Qe$1.TEXTURE_CUBE_MAP_ARRAY=3735928559,Qe$1.TEXTURE_3D=32879,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE=1,Qe$1.TEXTURE_NEAREST_NEAREST=1,Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE=2,Qe$1.TEXTURE_LINEAR_LINEAR=2,Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE=3,Qe$1.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,Qe$1.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,Qe$1.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,Qe$1.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,Qe$1.TEXTURE_NEAREST_LINEAR=7,Qe$1.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,Qe$1.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,Qe$1.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,Qe$1.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,Qe$1.TEXTURE_LINEAR_NEAREST=12,Qe$1.TEXTURE_EXPLICIT_MODE=0,Qe$1.TEXTURE_SPHERICAL_MODE=1,Qe$1.TEXTURE_PLANAR_MODE=2,Qe$1.TEXTURE_CUBIC_MODE=3,Qe$1.TEXTURE_PROJECTION_MODE=4,Qe$1.TEXTURE_SKYBOX_MODE=5,Qe$1.TEXTURE_INVCUBIC_MODE=6,Qe$1.TEXTURE_EQUIRECTANGULAR_MODE=7,Qe$1.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,Qe$1.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,Qe$1.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,Qe$1.TEXTURE_FILTERING_QUALITY_HIGH=64,Qe$1.TEXTURE_FILTERING_QUALITY_MEDIUM=16,Qe$1.TEXTURE_FILTERING_QUALITY_LOW=8,Qe$1.SCALEMODE_FLOOR=1,Qe$1.SCALEMODE_NEAREST=2,Qe$1.SCALEMODE_CEILING=3,Qe$1.MATERIAL_TextureDirtyFlag=1,Qe$1.MATERIAL_LightDirtyFlag=2,Qe$1.MATERIAL_FresnelDirtyFlag=4,Qe$1.MATERIAL_AttributesDirtyFlag=8,Qe$1.MATERIAL_MiscDirtyFlag=16,Qe$1.MATERIAL_PrePassDirtyFlag=32,Qe$1.MATERIAL_ImageProcessingDirtyFlag=64,Qe$1.MATERIAL_AllDirtyFlag=127,Qe$1.MATERIAL_TriangleFillMode=0,Qe$1.MATERIAL_WireFrameFillMode=1,Qe$1.MATERIAL_PointFillMode=2,Qe$1.MATERIAL_PointListDrawMode=3,Qe$1.MATERIAL_LineListDrawMode=4,Qe$1.MATERIAL_LineLoopDrawMode=5,Qe$1.MATERIAL_LineStripDrawMode=6,Qe$1.MATERIAL_TriangleStripDrawMode=7,Qe$1.MATERIAL_TriangleFanDrawMode=8,Qe$1.MATERIAL_ClockWiseSideOrientation=0,Qe$1.MATERIAL_CounterClockWiseSideOrientation=1,Qe$1.MATERIAL_DIFFUSE_MODEL_E_OREN_NAYAR=0,Qe$1.MATERIAL_DIFFUSE_MODEL_BURLEY=1,Qe$1.MATERIAL_DIFFUSE_MODEL_LAMBERT=2,Qe$1.MATERIAL_DIFFUSE_MODEL_LEGACY=3,Qe$1.MATERIAL_DIELECTRIC_SPECULAR_MODEL_GLTF=0,Qe$1.MATERIAL_DIELECTRIC_SPECULAR_MODEL_OPENPBR=1,Qe$1.MATERIAL_CONDUCTOR_SPECULAR_MODEL_GLTF=0,Qe$1.MATERIAL_CONDUCTOR_SPECULAR_MODEL_OPENPBR=1,Qe$1.ACTION_NothingTrigger=0,Qe$1.ACTION_OnPickTrigger=1,Qe$1.ACTION_OnLeftPickTrigger=2,Qe$1.ACTION_OnRightPickTrigger=3,Qe$1.ACTION_OnCenterPickTrigger=4,Qe$1.ACTION_OnPickDownTrigger=5,Qe$1.ACTION_OnDoublePickTrigger=6,Qe$1.ACTION_OnPickUpTrigger=7,Qe$1.ACTION_OnPickOutTrigger=16,Qe$1.ACTION_OnLongPressTrigger=8,Qe$1.ACTION_OnPointerOverTrigger=9,Qe$1.ACTION_OnPointerOutTrigger=10,Qe$1.ACTION_OnEveryFrameTrigger=11,Qe$1.ACTION_OnIntersectionEnterTrigger=12,Qe$1.ACTION_OnIntersectionExitTrigger=13,Qe$1.ACTION_OnKeyDownTrigger=14,Qe$1.ACTION_OnKeyUpTrigger=15,Qe$1.PARTICLES_BILLBOARDMODE_Y=2,Qe$1.PARTICLES_BILLBOARDMODE_ALL=7,Qe$1.PARTICLES_BILLBOARDMODE_STRETCHED=8,Qe$1.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,Qe$1.MESHES_CULLINGSTRATEGY_STANDARD=0,Qe$1.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,Qe$1.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,Qe$1.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,Qe$1.SCENELOADER_NO_LOGGING=0,Qe$1.SCENELOADER_MINIMAL_LOGGING=1,Qe$1.SCENELOADER_SUMMARY_LOGGING=2,Qe$1.SCENELOADER_DETAILED_LOGGING=3,Qe$1.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,Qe$1.PREPASS_POSITION_TEXTURE_TYPE=1,Qe$1.PREPASS_VELOCITY_TEXTURE_TYPE=2,Qe$1.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,Qe$1.PREPASS_COLOR_TEXTURE_TYPE=4,Qe$1.PREPASS_DEPTH_TEXTURE_TYPE=5,Qe$1.PREPASS_NORMAL_TEXTURE_TYPE=6,Qe$1.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,Qe$1.PREPASS_WORLD_NORMAL_TEXTURE_TYPE=8,Qe$1.PREPASS_LOCAL_POSITION_TEXTURE_TYPE=9,Qe$1.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE=10,Qe$1.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE=11,Qe$1.PREPASS_ALBEDO_TEXTURE_TYPE=12,Qe$1.PREPASS_NORMALIZED_VIEW_DEPTH_TEXTURE_TYPE=13,Qe$1.BUFFER_CREATIONFLAG_READ=1,Qe$1.BUFFER_CREATIONFLAG_WRITE=2,Qe$1.BUFFER_CREATIONFLAG_READWRITE=3,Qe$1.BUFFER_CREATIONFLAG_UNIFORM=4,Qe$1.BUFFER_CREATIONFLAG_VERTEX=8,Qe$1.BUFFER_CREATIONFLAG_INDEX=16,Qe$1.BUFFER_CREATIONFLAG_STORAGE=32,Qe$1.BUFFER_CREATIONFLAG_INDIRECT=64,Qe$1.RENDERPASS_MAIN=0,Qe$1.INPUT_ALT_KEY=18,Qe$1.INPUT_CTRL_KEY=17,Qe$1.INPUT_META_KEY1=91,Qe$1.INPUT_META_KEY2=92,Qe$1.INPUT_META_KEY3=93,Qe$1.INPUT_SHIFT_KEY=16,Qe$1.SNAPSHOTRENDERING_STANDARD=0,Qe$1.SNAPSHOTRENDERING_FAST=1,Qe$1.PERSPECTIVE_CAMERA=0,Qe$1.ORTHOGRAPHIC_CAMERA=1,Qe$1.FOVMODE_VERTICAL_FIXED=0,Qe$1.FOVMODE_HORIZONTAL_FIXED=1,Qe$1.RIG_MODE_NONE=0,Qe$1.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,Qe$1.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,Qe$1.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,Qe$1.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,Qe$1.RIG_MODE_STEREOSCOPIC_INTERLACED=14,Qe$1.RIG_MODE_VR=20,Qe$1.RIG_MODE_CUSTOM=22,Qe$1.MAX_SUPPORTED_UV_SETS=6,Qe$1.GL_ALPHA_EQUATION_ADD=32774,Qe$1.GL_ALPHA_EQUATION_MIN=32775,Qe$1.GL_ALPHA_EQUATION_MAX=32776,Qe$1.GL_ALPHA_EQUATION_SUBTRACT=32778,Qe$1.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,Qe$1.GL_ALPHA_FUNCTION_SRC=768,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,Qe$1.GL_ALPHA_FUNCTION_SRC_ALPHA=770,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,Qe$1.GL_ALPHA_FUNCTION_DST_ALPHA=772,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,Qe$1.GL_ALPHA_FUNCTION_DST_COLOR=774,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,Qe$1.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,Qe$1.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,Qe$1.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,Qe$1.GL_ALPHA_FUNCTION_SRC1_COLOR=35065,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_COLOR=35066,Qe$1.GL_ALPHA_FUNCTION_SRC1_ALPHA=34185,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_ALPHA=35067,Qe$1.SnippetUrl="https://snippet.babylonjs.com",Qe$1.FOGMODE_NONE=0,Qe$1.FOGMODE_EXP=1,Qe$1.FOGMODE_EXP2=2,Qe$1.FOGMODE_LINEAR=3,Qe$1.BYTE=5120,Qe$1.UNSIGNED_BYTE=5121,Qe$1.SHORT=5122,Qe$1.UNSIGNED_SHORT=5123,Qe$1.INT=5124,Qe$1.UNSIGNED_INT=5125,Qe$1.FLOAT=5126,Qe$1.PositionKind="position",Qe$1.NormalKind="normal",Qe$1.TangentKind="tangent",Qe$1.UVKind="uv",Qe$1.UV2Kind="uv2",Qe$1.UV3Kind="uv3",Qe$1.UV4Kind="uv4",Qe$1.UV5Kind="uv5",Qe$1.UV6Kind="uv6",Qe$1.ColorKind="color",Qe$1.ColorInstanceKind="instanceColor",Qe$1.MatricesIndicesKind="matricesIndices",Qe$1.MatricesWeightsKind="matricesWeights",Qe$1.MatricesIndicesExtraKind="matricesIndicesExtra",Qe$1.MatricesWeightsExtraKind="matricesWeightsExtra",Qe$1.ANIMATIONTYPE_FLOAT=0,Qe$1.ANIMATIONTYPE_VECTOR3=1,Qe$1.ANIMATIONTYPE_QUATERNION=2,Qe$1.ANIMATIONTYPE_MATRIX=3,Qe$1.ANIMATIONTYPE_COLOR3=4,Qe$1.ANIMATIONTYPE_COLOR4=7,Qe$1.ANIMATIONTYPE_VECTOR2=5,Qe$1.ANIMATIONTYPE_SIZE=6,Qe$1.ShadowMinZ=0,Qe$1.ShadowMaxZ=1e4;const qe$1={};function Ze$1(e,t,i=""){return i+(t?t+"\n":"")+e}function Je$1(e,t,i,s,r,n,a){const o=a||qe$1.loadFile;if(o){return o(e,t,i,s,r,n)}throw le$4("FileTools")}function $e$1(e,t,i,s){if(e)return t?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,i?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,void(s?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS);{let e="";return t&&(e+="#define IS_NDC_HALF_ZRANGE"),i&&(e&&(e+="\n"),e+="#define USE_REVERSE_DEPTHBUFFER"),s&&(e&&(e+="\n"),e+="#define USE_EXACT_SRGB_CONVERSIONS"),e}}function et$1(e,t,i=false,s){switch(e){case Qe$1.TEXTURETYPE_BYTE:{const e=(new Int8Array(t));return s&&e.set(new Int8Array(s)),e}case Qe$1.TEXTURETYPE_UNSIGNED_BYTE:{const e=(new Uint8Array(t));return s&&e.set(new Uint8Array(s)),e}case Qe$1.TEXTURETYPE_SHORT:{const e=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(i?t/2:t);return s&&e.set(new Int16Array(s)),e}case Qe$1.TEXTURETYPE_UNSIGNED_SHORT:case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:case Qe$1.TEXTURETYPE_HALF_FLOAT:{const e=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(i?t/2:t);return s&&e.set(new Uint16Array(s)),e}case Qe$1.TEXTURETYPE_INT:{const e=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(i?t/4:t);return s&&e.set(new Int32Array(s)),e}case Qe$1.TEXTURETYPE_UNSIGNED_INTEGER:case Qe$1.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:case Qe$1.TEXTURETYPE_UNSIGNED_INT_24_8:case Qe$1.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:case Qe$1.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:case Qe$1.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV:{const e=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(i?t/4:t);return s&&e.set(new Uint32Array(s)),e}case Qe$1.TEXTURETYPE_FLOAT:{const e=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(i?t/4:t);return s&&e.set(new Float32Array(s)),e}}const r=(new Uint8Array(t));return s&&r.set(new Uint8Array(s)),r}const tt$1=/defined\s*?\((.+?)\)/g,it$1=/defined\s*?\[(.+?)\]/g,st$1=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,rt$1=/__decl__/,nt$1=/light\{X\}.(\w*)/g,at$1=/\{X\}/g,ot$1=[],ht$1=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;function lt$1(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext);}function ct$1(e,t,i,s){t.processor?.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),gt$1(e,t,(e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e,t.defines));const r=function(e,t,i){let s=function(e,t){if(t.processor?.noPrecision)return e;const i=t.shouldUseHighPrecisionShader;-1===e.indexOf("precision highp float")?e=i?"precision highp float;\n"+e:"precision mediump float;\n"+e:i||(e=e.replace("precision highp float","precision mediump float"));return e}(e,t);if(!t.processor)return s;if(0===t.processor.shaderLanguage&&-1!==s.indexOf("#version 3")&&(s=s.replace("#version 300 es",""),!t.processor.parseGLES3))return s;const r=t.defines,n=function(e,t){const i=e.defines,s={};for(const e of i){const t=e.replace("#define","").replace(";","").trim().split(" ");s[t[0]]=t.length>1?t[1]:"";}0===e.processor?.shaderLanguage&&(s.GL_ES="true");return s.__VERSION__=e.version,s[e.platformName]="true",$e$1(s,t?.isNDCHalfZRange,t?.useReverseDepthBuffer,t?.useExactSrgbConversions),s}(t,i);t.processor.preProcessor&&(s=t.processor.preProcessor(s,r,n,t.isFragment,t.processingContext));const a={};s=function(e,t,i,s){const r=new Ge$1,n=new Ve$2;return n.lineIndex=-1,n.lines=e.split("\n"),pt$1(n,r),r.process(t,i,s)}(s,n,t,a),t.processor.postProcessor&&(s=t.processor.postProcessor(s,r,t.isFragment,t.processingContext,i?{drawBuffersExtensionDisabled:!i.getCaps().drawBuffersExtension}:{},n,a));i?._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s));return s}(e,t,s);i(r,e);}));}function ut$1(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}}function dt$1(e){const t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new We$1(t[1].trim(),"!"===e[0]);const i=["==","!=",">=","<=","<",">"];let s="",r=0;for(s of i)if(r=e.indexOf(s),r>-1)break;if(-1===r)return new We$1(e);const n=e.substring(0,r).trim(),a=e.substring(r+s.length).trim();return new je$1(n,s,a)}function _t$1(e,t){const i=new ze$2,s=e.substring(0,t);let r=e.substring(t);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),i.testExpression="#ifdef"===s?new We$1(r):"#ifndef"===s?new We$1(r,true):function(e){e=e.replace(tt$1,"defined[$1]");const t=Xe$1.infixToPostfix(e),i=[];for(const e of t)if("||"!==e&&"&&"!==e)i.push(e);else if(i.length>=2){let t=i[i.length-1],s=i[i.length-2];i.length-=2;const r="&&"==e?new Ke$1:new Ye$1;"string"==typeof t&&(t=t.replace(it$1,"defined($1)")),"string"==typeof s&&(s=s.replace(it$1,"defined($1)")),r.leftOperand="string"==typeof s?dt$1(s):s,r.rightOperand="string"==typeof t?dt$1(t):t,i.push(r);}let s=i[i.length-1];return "string"==typeof s&&(s=s.replace(it$1,"defined($1)")),"string"==typeof s?dt$1(s):s}(r),i}function ft$1(e,t,i,s){let r=e.currentLine;for(;pt$1(e,i);){r=e.currentLine;const s=r.substring(0,5).toLowerCase();if("#else"===s){const i=new Ge$1;return t.children.push(i),void pt$1(e,i)}if("#elif"===s){const e=_t$1(r,5);t.children.push(e),i=e;}}}function pt$1(e,t,i){for(;e.canRead;){e.lineIndex++;const i=e.currentLine;if(i.indexOf("#")>=0){const s=ht$1.exec(i);if(s&&s.length){switch(s[0]){case "#ifdef":{const s=new He$2;t.children.push(s);const r=_t$1(i,6);s.children.push(r),ft$1(e,s,r);break}case "#else":case "#elif":return  true;case "#endif":return  false;case "#ifndef":{const s=new He$2;t.children.push(s);const r=_t$1(i,7);s.children.push(r),ft$1(e,s,r);break}case "#if":{const s=new He$2,r=_t$1(i,3);t.children.push(s),s.children.push(r),ft$1(e,s,r);break}}continue}}const s=new Ge$1;if(s.line=i,t.children.push(s),"#"===i[0]&&"d"===i[1]){const e=i.replace(";","").split(" ");s.additionalDefineKey=e[1],3===e.length&&(s.additionalDefineValue=e[2]);}}return  false}function gt$1(e,t,i){let s;for(ot$1.length=0;null!==(s=st$1.exec(e));)ot$1.push(s);let r=String(e),n=[e],a=false;for(const e of ot$1){let s=e[1];if(-1!==s.indexOf("__decl__")&&(s=s.replace(rt$1,""),t.supportsUniformBuffers&&(s=s.replace("Vertex","Ubo").replace("Fragment","Ubo")),s+="Declaration"),!t.includesShadersStore[s]){const e=t.shadersRepository+"ShadersInclude/"+s+".fx";return void mt$1.loadFile(e,(e=>{t.includesShadersStore[s]=e,gt$1(n.join(""),t,i);}))}{let i=t.includesShadersStore[s];if(e[2]){const t=e[3].split(",");for(let e=0;e<t.length;e+=2){const s=new RegExp(t[e],"g"),r=t[e+1];i=i.replace(s,r);}}if(e[4]){const s=e[5];if(-1!==s.indexOf("..")){const e=s.split(".."),r=parseInt(e[0]);let n=parseInt(e[1]),a=i.slice(0);i="",isNaN(n)&&(n=t.indexParameters[e[1]]);for(let e=r;e<n;e++)t.supportsUniformBuffers||(a=a.replace(nt$1,((e,t)=>t+"{X}"))),i+=a.replace(at$1,e.toString())+"\n";}else t.supportsUniformBuffers||(i=i.replace(nt$1,((e,t)=>t+"{X}"))),i=i.replace(at$1,s);}const r=[];for(const t of n){const s=t.split(e[0]);for(let e=0;e<s.length-1;e++)r.push(s[e]),r.push(i);r.push(s[s.length-1]);}n=r,a=a||i.indexOf("#include<")>=0||i.indexOf("#include <")>=0;}}ot$1.length=0,r=n.join(""),a?gt$1(r.toString(),t,i):i(r);}const mt$1={loadFile:(e,t,i,s,r,n)=>{throw le$4("FileTools")}};let Tt$1=[];let Et$1=class Et{static SetImmediate(e){0===Tt$1.length&&setTimeout((()=>{const e=Tt$1;Tt$1=[];for(const t of e)t();}),1),Tt$1.push(e);}};function At$1(e,t,i){try{if(e())return t(),!0}catch(e){return i?.(e),true}return  false}const Rt$1=(e,t,i,s=16,r=3e4,n=true,a)=>{if(n&&At$1(e,t,i))return null;const o=setInterval((()=>{At$1(e,t,i)?clearInterval(o):(r-=s)<0&&(clearInterval(o),i?.(new Error("Operation timed out after maximum retries. "+(a||"")),true));}),s);return ()=>clearInterval(o)};let bt$1=class bt{static GetShadersRepository(e=0){return 0===e?bt.ShadersRepository:bt.ShadersRepositoryWGSL}static GetShadersStore(e=0){return 0===e?bt.ShadersStore:bt.ShadersStoreWGSL}static GetIncludesShadersStore(e=0){return 0===e?bt.IncludesShadersStore:bt.IncludesShadersStoreWGSL}};bt$1.ShadersRepository="src/Shaders/",bt$1.ShadersStore={},bt$1.IncludesShadersStore={},bt$1.ShadersRepositoryWGSL="src/ShadersWGSL/",bt$1.ShadersStoreWGSL={},bt$1.IncludesShadersStoreWGSL={};let St$1=class St{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=false;}get isAsync(){return this.isParallelCompiled}get isReady(){return !!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program);}setEngine(e){this.engine=e;}_fillEffectInformation(e,t,i,s,r,n,a,o){const h=this.engine;if(h.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let l;for(this.engine.getUniforms(this,i).forEach(((e,t)=>{s[i[t]]=e;})),this._uniforms=s,l=0;l<r.length;l++){null==e.getUniform(r[l])&&(r.splice(l,1),l--);}r.forEach(((e,t)=>{n[e]=t;}));for(const e of h.getAttributes(this,a))o.push(e);}dispose(){this._uniforms={},this._isDisposed=true;}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return (void 0===i||i!==s)&&(this._valueCache[e]=s,true)}_cacheFloat2(e,t,i){let s=this._valueCache[e];if(!s||2!==s.length)return s=[t,i],this._valueCache[e]=s,true;let r=false;return s[0]!==t&&(s[0]=t,r=true),s[1]!==i&&(s[1]=i,r=true),r}_cacheFloat3(e,t,i,s){let r=this._valueCache[e];if(!r||3!==r.length)return r=[t,i,s],this._valueCache[e]=r,true;let n=false;return r[0]!==t&&(r[0]=t,n=true),r[1]!==i&&(r[1]=i,n=true),r[2]!==s&&(r[2]=s,n=true),n}_cacheFloat4(e,t,i,s,r){let n=this._valueCache[e];if(!n||4!==n.length)return n=[t,i,s,r],this._valueCache[e]=n,true;let a=false;return n[0]!==t&&(n[0]=t,a=true),n[1]!==i&&(n[1]=i,a=true),n[2]!==s&&(n[2]=s,a=true),n[3]!==r&&(n[3]=r,a=true),a}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t);}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null));}setInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null));}setInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null));}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t);}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t);}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t);}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t);}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t);}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null));}setUInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setUInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null));}setUInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setUInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null));}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t);}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t);}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t);}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t);}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t);}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t);}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t);}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t);}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t));}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null));}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t);}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t);}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t);}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null));}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null));}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null));}setFloat3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setFloat3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null));}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null));}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null));}setFloat4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setFloat4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null));}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null));}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null));}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null));}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}};const xt$1=new WeakMap,Mt$1={_webGLVersion:2,cachedPipelines:{}};function yt$1(e){let t=xt$1.get(e);if(!t){if(!e)return Mt$1;t={_webGLVersion:e.TEXTURE_BINDING_3D?2:1,_context:e,parallelShaderCompile:e.getExtension("KHR_parallel_shader_compile")||void 0,cachedPipelines:{}},xt$1.set(e,t);}return t}function It$1(e){xt$1.delete(e);}function Ct$1(e,t,i,s,r,n){const a=yt$1(s);n||(n=a._createShaderProgramInjection??Pt$1);return n(e,Lt$1(t,"vertex",s,a._contextWasLost),Lt$1(i,"fragment",s,a._contextWasLost),s,r,a.validateShaderPrograms)}function vt$1(e,t,i,s,r,n=null,a){const o=yt$1(r);a||(a=o._createShaderProgramInjection??Pt$1);const h=o._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"";return a(e,Dt$1(t,"vertex",s,h,r,o._contextWasLost),Dt$1(i,"fragment",s,h,r,o._contextWasLost),r,n,o.validateShaderPrograms)}function Pt$1(e,t,i,s,r=null,n){const a=s.createProgram();if(e.program=a,!a)throw new Error("Unable to create program");return s.attachShader(a,t),s.attachShader(a,i),s.linkProgram(a),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||Ot$1(e,s,n),a}function Ot$1(e,t,i){const s=e.context,r=e.vertexShader,n=e.fragmentShader,a=e.program;if(!s.getProgramParameter(a,s.LINK_STATUS)){if(!t.getShaderParameter(r,t.COMPILE_STATUS)){const i=t.getShaderInfoLog(r);if(i)throw e.vertexCompilationError=i,new Error("VERTEX SHADER "+i)}if(!t.getShaderParameter(n,t.COMPILE_STATUS)){const i=t.getShaderInfoLog(n);if(i)throw e.fragmentCompilationError=i,new Error("FRAGMENT SHADER "+i)}const i=s.getProgramInfoLog(a);if(i)throw e.programLinkError=i,new Error(i)}if(i){s.validateProgram(a);if(!s.getProgramParameter(a,s.VALIDATE_STATUS)){const t=s.getProgramInfoLog(a);if(t)throw e.programValidationError=t,new Error(t)}}s.deleteShader(r),s.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0);}function Dt$1(e,t,i,s,r,n){return Lt$1(Ze$1(e,i,s),t,r,n)}function Lt$1(e,t,i,s){const r=i.createShader("vertex"===t?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!r){let e=i.NO_ERROR,r=i.NO_ERROR;for(;(r=i.getError())!==i.NO_ERROR;)e=r;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${e}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${s}`)}return i.shaderSource(r,e),i.compileShader(r),r}function Ft$1(e){const t=e._name,i=e.context;if(t&&i){const e=yt$1(i),s=e.cachedPipelines[t];s?.dispose(),delete e.cachedPipelines[t];}}function wt$1(e,t,i,s,r,n){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement){return void s(ye$3(e))}if("source:"===e.substring(0,7))return void s(e.substring(7));if("base64:"===e.substring(0,7)){return void s(window.atob(e.substring(7)))}const a=bt$1.GetShadersStore(r);if(a[e+t+"Shader"])return void s(a[e+t+"Shader"]);if(i&&a[e+i+"Shader"])return void s(a[e+i+"Shader"]);let o;if(o="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:bt$1.GetShadersRepository(r)+e,!(n=n||Je$1))throw new Error("loadFileInjection is not defined");n(o+"."+t.toLowerCase()+".fx",s);}let Nt$1=class Nt{static get ShadersRepository(){return bt$1.ShadersRepository}static set ShadersRepository(e){bt$1.ShadersRepository=e;}get isDisposed(){return this._isDisposed}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new R$g),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,s=null,r,n=null,a=null,o=null,h=null,l,c="",u=0,d){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new R$g,this.onErrorObservable=new R$g,this._onBindObservable=null,this._isDisposed=false,this._refCount=1,this._bonesComputationForcedToCPU=false,this._uniformBuffersNames={},this._multiTarget=false,this._samplers={},this._isReady=false,this._compilationError="",this._allFallbacksProcessed=false,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._disableParallelShaderCompilation=false,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this._onReleaseEffectsObserver=null,this.name=e,this._key=c;const _=this._key.replace(/\r/g,"").replace(/\n/g,"|");let f;if(t.attributes){const e=t;if(this._engine=i,this._attributesNames=e.attributes,this._uniformsNames=e.uniformsNames.concat(e.samplers),this._samplerList=e.samplers.slice(),this.defines=e.defines,this.onError=e.onError,this.onCompiled=e.onCompiled,this._fallbacks=e.fallbacks,this._indexParameters=e.indexParameters,this._transformFeedbackVaryings=e.transformFeedbackVaryings||null,this._multiTarget=!!e.multiTarget,this._shaderLanguage=e.shaderLanguage??0,this._disableParallelShaderCompilation=!!e.disableParallelShaderCompilation,e.uniformBuffersNames){this._uniformBuffersNamesList=e.uniformBuffersNames.slice();for(let t=0;t<e.uniformBuffersNames.length;t++)this._uniformBuffersNames[e.uniformBuffersNames[t]]=t;}this._processFinalCode=e.processFinalCode??null,this._processCodeAfterIncludes=e.processCodeAfterIncludes??void 0,d=e.extraInitializationsAsync,f=e.existingPipelineContext;}else this._engine=r,this.defines=null==n?"":n,this._uniformsNames=i.concat(s),this._samplerList=s?s.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=u,this.onError=h,this.onCompiled=o,this._indexParameters=l,this._fallbacks=a;"WEBGL2"===this._engine.shaderPlatformName&&(f=function(e,t){return yt$1(t).cachedPipelines[e]}(_,this._engine._gl)??f),this._attributeLocationByName={},this.uniqueId=Nt._UniqueIdSeed++,f?(this._pipelineContext=f,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCodeAsync(null,false,null,d),this._onReleaseEffectsObserver=this._engine.onReleaseEffectsObservable.addOnce((()=>{this._onReleaseEffectsObserver=null,this.isDisposed||this.dispose(true);}));}async _processShaderCodeAsync(e=null,t=false,i=null,s){s&&await s(),this._processingContext=i||this._engine._getShaderProcessingContext(this._shaderLanguage,false);!function(e,t,i,s,r,n,a){let o,h;const l=Se$2()?n?.getHostDocument():null;o="string"==typeof t?t:t.vertexSource?"source:"+t.vertexSource:t.vertexElement?l?.getElementById(t.vertexElement)||t.vertexElement:t.vertex||t,h="string"==typeof t?t:t.fragmentSource?"source:"+t.fragmentSource:t.fragmentElement?l?.getElementById(t.fragmentElement)||t.fragmentElement:t.fragment||t;const c=[void 0,void 0],u=()=>{if(c[0]&&c[1]){e.isFragment=true;const[o,h]=c;ct$1(h,e,((n,h)=>{a&&(a._fragmentSourceCodeBeforeMigration=h),i&&(n=i("fragment",n));const l=ut$1(o,n,e);e=null;const c=function(e,t,i,s){return i?{vertexSourceCode:(1===s?"//":"")+"#define SHADER_NAME vertex:"+(i.vertexElement||i.vertex||i.spectorName||i)+"\n"+e,fragmentSourceCode:(1===s?"//":"")+"#define SHADER_NAME fragment:"+(i.fragmentElement||i.fragment||i.spectorName||i)+"\n"+t}:{vertexSourceCode:e,fragmentSourceCode:t}}(l.vertexCode,l.fragmentCode,t,r);s?.(c.vertexSourceCode,c.fragmentSourceCode);}),n);}};wt$1(o,"Vertex","",(t=>{lt$1(e),ct$1(t,e,((e,s)=>{a&&(a._rawVertexSourceCode=t,a._vertexSourceCodeBeforeMigration=s),i&&(e=i("vertex",e)),c[0]=e,u();}),n);}),r),wt$1(h,"Fragment","Pixel",(e=>{a&&(a._rawFragmentSourceCode=e),c[1]=e,u();}),r);}({defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:false,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:bt$1.GetShadersRepository(this._shaderLanguage),includesShadersStore:bt$1.GetIncludesShadersStore(this._shaderLanguage),version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes},this.name,this._processFinalCode,((e,i)=>{this._vertexSourceCode=e,this._fragmentSourceCode=i,this._prepareEffect(t);}),this._shaderLanguage,this._engine,this);}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return  false}}_isReadyInternal(){return !!this._engine.isDisposed||(!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady)}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}async whenCompiledAsync(){return await new Promise((e=>{this.executeWhenCompiled(e);}))}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add((t=>{e(t);})),this._pipelineContext&&!this._pipelineContext.isAsync||this._checkIsReady(null));}_checkIsReady(e){Rt$1((()=>this._isReadyInternal()||this._isDisposed),(()=>{}),(t=>{this._processCompilationErrors(t,e);}),16,12e4,true,` - Effect: ${"string"==typeof this.name?this.name:this.key}`);}get vertexSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._pipelineContext?._getVertexShaderCode()??this._vertexSourceCode}get fragmentSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._pipelineContext?._getFragmentShaderCode()??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return {platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split("\n"),addGlobalDefines:false,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!(!this._vertexSourceCodeOverride||!this._fragmentSourceCodeOverride)}}}_rebuildProgram(e,t,i,s){this._isReady=false,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(e,t)=>{s&&s(t);},this.onCompiled=()=>{const e=this.getEngine().scenes;if(e)for(let t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(Qe$1.MATERIAL_AllDirtyFlag);this._pipelineContext._handlesSpectorRebuildCallback?.(i);},this._fallbacks=null,this._prepareEffect();}_onRenderingStateCompiled(e){if(this._pipelineContext=e,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let e=0;e<this._attributesNames.length;e++){const t=this._attributesNames[e];this._attributeLocationByName[t]=this._attributes[e];}this._engine.bindSamplers(this),this._compilationError="",this._isReady=true,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),Nt.AutomaticallyClearCodeCache&&this.clearCodeCache();}_prepareEffect(e=false){const t=this._pipelineContext;this._isReady=false;try{const i=!(!this._vertexSourceCodeOverride||!this._fragmentSourceCodeOverride),s=i?null:this.defines,r=i?this._vertexSourceCodeOverride:this._vertexSourceCode,n=i?this._fragmentSourceCodeOverride:this._fragmentSourceCode,a=this._engine;this._pipelineContext=((e,t,i,s)=>{try{const r=e.context?yt$1(e.context):null;r&&(r.disableParallelShaderCompile=e.disableParallelCompilation);const n=e.existingPipelineContext||t(e.shaderProcessingContext);return n._name=e.name,e.name&&r&&(r.cachedPipelines[e.name]=n),i(n,e.vertex,e.fragment,!!e.createAsRaw,"","",e.rebuildRebind,e.defines,e.transformFeedbackVaryings,"",(()=>{s(n,(()=>{e.onRenderingStateCompiled?.(n);}));})),n}catch(e){throw Ie$2.Error("Error compiling effect"),e}})({existingPipelineContext:e?t:null,vertex:r,fragment:n,context:"WEBGL2"===a.shaderPlatformName||"WEBGL1"===a.shaderPlatformName?a._gl:void 0,rebuildRebind:(e,t,i,s)=>this._rebuildProgram(e,t,i,s),defines:s,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:i,disableParallelCompilation:this._disableParallelShaderCompilation,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:i=>{t&&!e&&this._engine._deletePipelineContext(t),i&&this._onRenderingStateCompiled(i);}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContextAsync.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(t);}catch(e){this._processCompilationErrors(e,t);}}_getShaderCodeAndErrorLine(e,t,i){const s=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let r=null;if(t&&e){const n=t.match(s);if(n&&2===n.length){const t=parseInt(n[1]),s=e.split("\n",-1);s.length>=t&&(r=`Offending line [${t}] in ${i?"fragment":"vertex"} code: ${s[t-1]}`);}}return [e,r]}_processCompilationErrors(e,t=null){this._compilationError=e.message;const i=this._attributesNames,s=this._fallbacks;if(Ie$2.Error("Unable to compile effect:"),Ie$2.Error(`Uniforms: ${this._uniformsNames.join(" ")}`),Ie$2.Error(`Attributes: ${i.join(" ")}`),Ie$2.Error("Defines:\n"+this.defines),Nt.LogShaderCodeOnCompilationError){let e=null,t=null,i=null;this._pipelineContext?._getVertexShaderCode()&&([i,e]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,false),i&&(Ie$2.Error("Vertex code:"),Ie$2.Error(i))),this._pipelineContext?._getFragmentShaderCode()&&([i,t]=this._getShaderCodeAndErrorLine(this._pipelineContext?._getFragmentShaderCode(),this._compilationError,true),i&&(Ie$2.Error("Fragment code:"),Ie$2.Error(i))),e&&Ie$2.Error(e),t&&Ie$2.Error(t);}Ie$2.Error("Error: "+this._compilationError);const r=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this._engine.onEffectErrorObservable.notifyObservers({effect:this,errors:this._compilationError});};t&&(this._pipelineContext=t,this._isReady=true,r()),s?(this._pipelineContext=null,s.hasMoreFallbacks?(this._allFallbacksProcessed=false,Ie$2.Error("Trying next fallback."),this.defines=s.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=true,r(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=true,t||r());}get isSupported(){return ""===this._compilationError}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e);}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e);}setTextureArray(e,t){const i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){const s=this._samplerList.indexOf(e);for(let e=1;e<t.length;e++){const t=i+(e-1).toString();this._samplerList.splice(s+e,0,t);}let r=0;for(const e of this._samplerList)this._samplers[e]=r,r+=1;}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e);}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];void 0===i||Nt._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(Nt._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t));}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t);}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,s){return this._pipelineContext.setInt3(e,t,i,s),this}setInt4(e,t,i,s,r){return this._pipelineContext.setInt4(e,t,i,s,r),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,s){return this._pipelineContext.setUInt3(e,t,i,s),this}setUInt4(e,t,i,s,r){return this._pipelineContext.setUInt4(e,t,i,s,r),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,s){return this._pipelineContext.setFloat3(e,t,i,s),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,s,r){return this._pipelineContext.setFloat4(e,t,i,s,r),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}clearCodeCache(){this._vertexSourceCode="",this._fragmentSourceCode="",this._fragmentSourceCodeBeforeMigration="",this._vertexSourceCodeBeforeMigration="";}dispose(e=false){if(e)this._refCount=0;else {if(Nt.PersistentMode)return;this._refCount--;}this._refCount>0||this._isDisposed||(this._onReleaseEffectsObserver&&(this._engine.onReleaseEffectsObservable.remove(this._onReleaseEffectsObserver),this._onReleaseEffectsObserver=null),this._pipelineContext&&Ft$1(this._pipelineContext),this._engine._releaseEffect(this),this.clearCodeCache(),this._isDisposed=true);}static RegisterShader(e,t,i,s=0){t&&(bt$1.GetShadersStore(s)[`${e}PixelShader`]=t),i&&(bt$1.GetShadersStore(s)[`${e}VertexShader`]=i);}static ResetCache(){Nt._BaseCache={};}};Nt$1.LogShaderCodeOnCompilationError=true,Nt$1.PersistentMode=false,Nt$1.AutomaticallyClearCodeCache=false,Nt$1._UniqueIdSeed=0,Nt$1._BaseCache={},Nt$1.ShadersStore=bt$1.ShadersStore,Nt$1.IncludesShadersStore=bt$1.IncludesShadersStore;let Bt$1=class Bt{constructor(e=true){this._isDepthTestDirty=false,this._isDepthMaskDirty=false,this._isDepthFuncDirty=false,this._isCullFaceDirty=false,this._isCullDirty=false,this._isZOffsetDirty=false,this._isFrontFaceDirty=false,e&&this.reset();}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=true);}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=true);}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=true);}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=true);}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=true);}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=true);}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=true);}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=true);}reset(){this._depthMask=true,this._depthTest=true,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=true,this._isDepthMaskDirty=true,this._isDepthFuncDirty=false,this._isCullFaceDirty=false,this._isCullDirty=false,this._isZOffsetDirty=true,this._isFrontFaceDirty=false;}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=false),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=false),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=false),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=false),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=false),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=false),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=false));}};let Ut$1=class Ut{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=true);}get backFunc(){return this._func}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._isStencilFuncDirty=true);}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=true);}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=true);}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=true);}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=true);}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=true);}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._isStencilOpDirty=true);}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._isStencilOpDirty=true);}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._isStencilOpDirty=true);}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=true);}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=true);}constructor(e=true){this._isStencilTestDirty=false,this._isStencilMaskDirty=false,this._isStencilFuncDirty=false,this._isStencilOpDirty=false,this.useStencilGlobalOnly=false,e&&this.reset();}reset(){this.stencilMaterial=void 0,this.stencilGlobal?.reset(),this._isStencilTestDirty=true,this._isStencilMaskDirty=true,this._isStencilFuncDirty=true,this._isStencilOpDirty=true;}apply(e){if(!e)return;const t=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.backFunc=t?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backOpStencilFail=t?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=t?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=t?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=false),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=false),this._isStencilFuncDirty&&(e.stencilFuncSeparate(e.FRONT,this.func,this.funcRef,this.funcMask),e.stencilFuncSeparate(e.BACK,this.backFunc,this.funcRef,this.funcMask),this._isStencilFuncDirty=false),this._isStencilOpDirty&&(e.stencilOpSeparate(e.FRONT,this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),e.stencilOpSeparate(e.BACK,this.backOpStencilFail,this.backOpDepthFail,this.backOpStencilDepthPass),this._isStencilOpDirty=false));}};let kt$1=class kt{constructor(){this.reset();}reset(){this.enabled=false,this.mask=255,this.funcRef=1,this.funcMask=255,this.func=kt.ALWAYS,this.opStencilFail=kt.KEEP,this.opDepthFail=kt.KEEP,this.opStencilDepthPass=kt.REPLACE,this.backFunc=kt.ALWAYS,this.backOpStencilFail=kt.KEEP,this.backOpDepthFail=kt.KEEP,this.backOpStencilDepthPass=kt.REPLACE;}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e;}get stencilBackFunc(){return this.backFunc}set stencilBackFunc(e){this.backFunc=e;}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e;}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e;}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e;}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e;}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e;}get stencilBackOpStencilFail(){return this.backOpStencilFail}set stencilBackOpStencilFail(e){this.backOpStencilFail=e;}get stencilBackOpDepthFail(){return this.backOpDepthFail}set stencilBackOpDepthFail(e){this.backOpDepthFail=e;}get stencilBackOpStencilDepthPass(){return this.backOpStencilDepthPass}set stencilBackOpStencilDepthPass(e){this.backOpStencilDepthPass=e;}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e;}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e;}};kt$1.ALWAYS=Qe$1.ALWAYS,kt$1.KEEP=Qe$1.KEEP,kt$1.REPLACE=Qe$1.REPLACE;let Gt$1=class Gt{constructor(e){this._supportBlendParametersPerTarget=e,this._blendFunctionParameters=new Array(32),this._blendEquationParameters=new Array(16),this._blendConstants=new Array(4),this._isBlendConstantsDirty=false,this._alphaBlend=Array(8).fill(false),this._numTargetEnabled=0,this._isAlphaBlendDirty=false,this._isBlendFunctionParametersDirty=false,this._isBlendEquationParametersDirty=false,this.reset();}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._numTargetEnabled>0}setAlphaBlend(e,t=0){this._alphaBlend[t]!==e&&(e?this._numTargetEnabled++:this._numTargetEnabled--,this._alphaBlend[t]=e,this._isAlphaBlendDirty=true);}setAlphaBlendConstants(e,t,i,s){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===s||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=s,this._isBlendConstantsDirty=true);}setAlphaBlendFunctionParameters(e,t,i,s,r=0){const n=4*r;this._blendFunctionParameters[n+0]===e&&this._blendFunctionParameters[n+1]===t&&this._blendFunctionParameters[n+2]===i&&this._blendFunctionParameters[n+3]===s||(this._blendFunctionParameters[n+0]=e,this._blendFunctionParameters[n+1]=t,this._blendFunctionParameters[n+2]=i,this._blendFunctionParameters[n+3]=s,this._isBlendFunctionParametersDirty=true);}setAlphaEquationParameters(e,t,i=0){const s=2*i;this._blendEquationParameters[s+0]===e&&this._blendEquationParameters[s+1]===t||(this._blendEquationParameters[s+0]=e,this._blendEquationParameters[s+1]=t,this._isBlendEquationParametersDirty=true);}reset(){this._alphaBlend.fill(false),this._numTargetEnabled=0,this._blendFunctionParameters.fill(null),this._blendEquationParameters.fill(null),this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=true,this._isBlendFunctionParametersDirty=false,this._isBlendEquationParametersDirty=false,this._isBlendConstantsDirty=false;}apply(e,t=1){if(!this.isDirty)return;if(this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=false),1===t||!this._supportBlendParametersPerTarget)return this._isAlphaBlendDirty&&(this._alphaBlend[0]?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=false),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=false),void(this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=false));const i=e;if(this._isAlphaBlendDirty){for(let s=0;s<t;s++){const t=s<this._numTargetEnabled?s:0;this._alphaBlend[t]?i.enableIndexed(e.BLEND,s):i.disableIndexed(e.BLEND,s);}this._isAlphaBlendDirty=false;}if(this._isBlendFunctionParametersDirty){for(let e=0;e<t;e++){const t=e<this._numTargetEnabled?4*e:0;i.blendFuncSeparateIndexed(e,this._blendFunctionParameters[t+0],this._blendFunctionParameters[t+1],this._blendFunctionParameters[t+2],this._blendFunctionParameters[t+3]);}this._isBlendFunctionParametersDirty=false;}if(this._isBlendEquationParametersDirty){for(let e=0;e<t;e++){const t=e<this._numTargetEnabled?2*e:0;i.blendEquationSeparateIndexed(e,this._blendEquationParameters[t+0],this._blendEquationParameters[t+1]);}this._isBlendEquationParametersDirty=false;}}setAlphaMode(e,t){let i=Qe$1.GL_ALPHA_EQUATION_ADD;switch(e){case Qe$1.ALPHA_DISABLE:break;case Qe$1.ALPHA_PREMULTIPLIED:this.setAlphaBlendFunctionParameters(1,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,1,1,t);break;case Qe$1.ALPHA_PREMULTIPLIED_PORTERDUFF:this.setAlphaBlendFunctionParameters(1,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,1,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,t);break;case Qe$1.ALPHA_COMBINE:this.setAlphaBlendFunctionParameters(Qe$1.GL_ALPHA_FUNCTION_SRC_ALPHA,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,1,1,t);break;case Qe$1.ALPHA_ONEONE:this.setAlphaBlendFunctionParameters(1,1,0,1,t);break;case Qe$1.ALPHA_ADD:this.setAlphaBlendFunctionParameters(Qe$1.GL_ALPHA_FUNCTION_SRC_ALPHA,1,0,1,t);break;case Qe$1.ALPHA_SUBTRACT:this.setAlphaBlendFunctionParameters(0,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR,1,1,t),i=Qe$1.GL_ALPHA_EQUATION_SUBTRACT;break;case Qe$1.ALPHA_MULTIPLY:this.setAlphaBlendFunctionParameters(Qe$1.GL_ALPHA_FUNCTION_DST_COLOR,0,1,1,t);break;case Qe$1.ALPHA_MAXIMIZED:this.setAlphaBlendFunctionParameters(Qe$1.GL_ALPHA_FUNCTION_SRC_ALPHA,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR,1,1,t);break;case Qe$1.ALPHA_INTERPOLATE:this.setAlphaBlendFunctionParameters(Qe$1.GL_ALPHA_FUNCTION_CONSTANT_COLOR,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR,Qe$1.GL_ALPHA_FUNCTION_CONSTANT_ALPHA,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA,t);break;case Qe$1.ALPHA_SCREENMODE:this.setAlphaBlendFunctionParameters(1,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR,1,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,t);break;case Qe$1.ALPHA_ONEONE_ONEONE:this.setAlphaBlendFunctionParameters(1,1,1,1,t);break;case Qe$1.ALPHA_ALPHATOCOLOR:this.setAlphaBlendFunctionParameters(Qe$1.GL_ALPHA_FUNCTION_DST_ALPHA,1,0,0,t);break;case Qe$1.ALPHA_REVERSEONEMINUS:this.setAlphaBlendFunctionParameters(Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,t);break;case Qe$1.ALPHA_SRC_DSTONEMINUSSRCALPHA:this.setAlphaBlendFunctionParameters(1,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,1,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,t);break;case Qe$1.ALPHA_ONEONE_ONEZERO:this.setAlphaBlendFunctionParameters(1,1,1,0,t);break;case Qe$1.ALPHA_EXCLUSION:this.setAlphaBlendFunctionParameters(Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR,0,1,t);break;case Qe$1.ALPHA_LAYER_ACCUMULATE:this.setAlphaBlendFunctionParameters(Qe$1.GL_ALPHA_FUNCTION_SRC_ALPHA,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,1,Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA,t);break;case Qe$1.ALPHA_MIN:this.setAlphaBlendFunctionParameters(1,1,1,1,t),i=Qe$1.GL_ALPHA_EQUATION_MIN;break;case Qe$1.ALPHA_MAX:this.setAlphaBlendFunctionParameters(1,1,1,1,t),i=Qe$1.GL_ALPHA_EQUATION_MAX;break;case Qe$1.ALPHA_DUAL_SRC0_ADD_SRC1xDST:this.setAlphaBlendFunctionParameters(1,Qe$1.GL_ALPHA_FUNCTION_SRC1_COLOR,0,1,t);}this.setAlphaEquationParameters(i,i,t);}};let Vt$1=class Vt{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e;}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e;}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e;}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e;}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e;}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e;}constructor(){this.samplingMode=-1,this._useMipMaps=true,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0;}setParameters(e=Qe$1.TEXTURE_WRAP_ADDRESSMODE,t=Qe$1.TEXTURE_WRAP_ADDRESSMODE,i=Qe$1.TEXTURE_WRAP_ADDRESSMODE,s=1,r=Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=s,this.samplingMode=r,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}};var Ht$1;!function(e){e[e.Unknown=0]="Unknown",e[e.Url=1]="Url",e[e.Temp=2]="Temp",e[e.Raw=3]="Raw",e[e.Dynamic=4]="Dynamic",e[e.RenderTarget=5]="RenderTarget",e[e.MultiRenderTarget=6]="MultiRenderTarget",e[e.Cube=7]="Cube",e[e.CubeRaw=8]="CubeRaw",e[e.CubePrefiltered=9]="CubePrefiltered",e[e.Raw3D=10]="Raw3D",e[e.Raw2DArray=11]="Raw2DArray",e[e.DepthStencil=12]="DepthStencil",e[e.CubeRawRGBD=13]="CubeRawRGBD",e[e.Depth=14]="Depth";}(Ht$1||(Ht$1={}));class zt extends Vt$1{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e;}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e;}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=false){super(),this.isReady=false,this.isCube=false,this.is3D=false,this.is2DArray=false,this.isMultiview=false,this.url="",this.generateMipMaps=false,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new R$g,this.onErrorObservable=new R$g,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=false,this._invertVScale=false,this._associatedChannel=-1,this._source=0,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=false,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=false,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=false,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=false,this._linearSpecularLOD=false,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=false,this._dynamicTextureSource=null,this._autoMSAAManagement=false,this._engine=e,this._source=t,this._uniqueId=zt._Counter++,i||(this._hardwareTexture=e._createHardwareTexture());}incrementReferences(){this._references++;}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i;}_rebuild(){if(this.isReady=false,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const e=this.onRebuildCallback(this),t=t=>{t._swapAndDie(this,false),this.isReady=e.isReady;};return void(e.isAsync?e.proxy.then(t):t(e.proxy))}let e;switch(this.source){case 2:break;case 1:return void(e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(e=>{e._swapAndDie(this,false),this.isReady=true;}),null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer));case 3:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),e._swapAndDie(this,false),this.isReady=true;break;case 10:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,false),this.isReady=true;break;case 11:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,false),this.isReady=true;break;case 4:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,false),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,true);break;case 7:return void(e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(()=>{e._swapAndDie(this,false),this.isReady=true;}),null,this.format,this._extension,false,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null));case 8:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,false),this.isReady=true;break;case 13:return;case 9:return e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(e=>{e&&e._swapAndDie(this,false),this.isReady=true;}),null,this.format,this._extension),void(e._sphericalPolynomial=this._sphericalPolynomial)}}_swapAndDie(e,t=true){this._hardwareTexture?.setUsage(e._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const i=this._engine.getLoadedTexturesCache();let s=i.indexOf(this);-1!==s&&i.splice(s,1),s=i.indexOf(e),-1===s&&i.push(e);}dispose(){this._references--,0===this._references&&(this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null);}}zt._Counter=0;const Xt$1=new Map;function Wt$1(e,t){((function(e){return Xt$1.delete(e)}))(e)&&Ie$2.Warn(`Extension with the name '${e}' already exists`),Xt$1.set(e,t);}function Yt$1(e,t){"image/ktx"!==t&&"image/ktx2"!==t||(e=".ktx"),Xt$1.has(e)||(e.endsWith(".ies")&&Wt$1(".ies",(async()=>await Promise.resolve().then(function(){return iesTextureLoaderSK5XZdbF_esm_min}).then((e=>new e._IESTextureLoader)))),e.endsWith(".dds")&&Wt$1(".dds",(async()=>await Promise.resolve().then(function(){return ddsTextureLoader3Y_V94PT_esm_min}).then((e=>new e._DDSTextureLoader)))),e.endsWith(".basis")&&Wt$1(".basis",(async()=>await Promise.resolve().then(function(){return basisTextureLoaderIArbJ2PB_esm_min}).then((e=>new e._BasisTextureLoader)))),e.endsWith(".env")&&Wt$1(".env",(async()=>await Promise.resolve().then(function(){return envTextureLoaderDCq6gy_r_esm_min}).then((e=>new e._ENVTextureLoader)))),e.endsWith(".hdr")&&Wt$1(".hdr",(async()=>await Promise.resolve().then(function(){return hdrTextureLoaderCF2CBpx6_esm_min}).then((e=>new e._HDRTextureLoader)))),(e.endsWith(".ktx")||e.endsWith(".ktx2"))&&(Wt$1(".ktx",(async()=>await Promise.resolve().then(function(){return ktxTextureLoaderMXoviPI_esm_min}).then((e=>new e._KTXTextureLoader)))),Wt$1(".ktx2",(async()=>await Promise.resolve().then(function(){return ktxTextureLoaderMXoviPI_esm_min}).then((e=>new e._KTXTextureLoader))))),e.endsWith(".tga")&&Wt$1(".tga",(async()=>await Promise.resolve().then(function(){return tgaTextureLoaderBjuFwILe_esm_min}).then((e=>new e._TGATextureLoader)))),e.endsWith(".exr")&&Wt$1(".exr",(async()=>await Promise.resolve().then(function(){return exrTextureLoaderDverv0f3_esm_min}).then((e=>new e._ExrTextureLoader)))));const i=Xt$1.get(e);return i?Promise.resolve(i(t)):null}function Kt(e,t){if(Se$2()){const{requestAnimationFrame:i}=t||window;if("function"==typeof i)return i(e)}else if("function"==typeof requestAnimationFrame)return requestAnimationFrame(e);return setTimeout(e,16)}class jt{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(e){return this._shaderProcessor}_resetAlphaMode(){this._alphaMode.fill(-1),this._alphaEquation.fill(-1);}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null;}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,this._depthCullingState.depthFunc=e?Qe$1.GEQUAL:Qe$1.LEQUAL);}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=true,this._colorWrite=e);}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(e){if(e)return this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,void(this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS);{let e="";return this.isNDCHalfZRange&&(e+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(e&&(e+="\n"),e+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(e&&(e+="\n"),e+="#define USE_EXACT_SRGB_CONVERSIONS"),e}}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild();}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild();}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._prepareEffect();}Nt$1.ResetCache();}_rebuildGraphicsResources(){this.wipeCaches(true),this._rebuildEffects(),this._rebuildComputeEffects?.(),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(true);}_flagContextRestored(){Ie$2.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=false;}_restoreEngineAfterContextLost(e){setTimeout((()=>{this._clearEmptyResources();const t=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,s=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;e(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=s,this._stencilState.stencilTest=r,this._flagContextRestored();}),0);}get isDisposed(){return this._isDisposed}get snapshotRendering(){return  false}set snapshotRendering(e){}get snapshotRenderingMode(){return Qe$1.SNAPSHOTRENDERING_STANDARD}set snapshotRenderingMode(e){}getClassName(){return "AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,Qe$1.TEXTUREFORMAT_RGBA,false,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,Qe$1.TEXTUREFORMAT_RGBA,false,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,Qe$1.TEXTUREFORMAT_RGBA,false,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,Qe$1.TEXTUREFORMAT_RGBA,Qe$1.TEXTURETYPE_UNSIGNED_BYTE,false,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE);}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(e){if(!e)return this._activeRenderLoops.length=0,void this._cancelFrame();const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),0==this._activeRenderLoops.length&&this._cancelFrame());}_cancelFrame(){if(0!==this._frameHandler){const e=this._frameHandler;if(this._frameHandler=0,Se$2()){const{cancelAnimationFrame:t}=this.getHostWindow()||window;if("function"==typeof t)return t(e)}else if("function"==typeof cancelAnimationFrame)return cancelAnimationFrame(e);return clearTimeout(e)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this);}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this);}get maxFPS(){return this._maxFPS}set maxFPS(e){this._maxFPS=e,void 0!==e&&(this._minFrameTime=e<=0?Number.MAX_VALUE:1e3/e);}_isOverFrameTime(e){if(!e||void 0===this._maxFPS)return  false;const t=e-this._lastFrameTime;return this._lastFrameTime=e,this._renderAccumulator+=t,this._renderAccumulator<this._minFrameTime||(this._renderAccumulator-=this._minFrameTime,this._renderAccumulator>this._minFrameTime&&(this._renderAccumulator=this._minFrameTime),false)}_processFrame(e){if(this._frameHandler=0,!this._contextWasLost&&!this._isOverFrameTime(e)){let e=true;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=false),e&&(this.beginFrame(),this.skipFrameRender||this._renderViews()||this._renderFrame(),this.endFrame());}}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()));}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){(0, this._activeRenderLoops[e])();}}_renderViews(){return  false}_queueNewFrame(e,t){return Kt(e,t)}runRenderLoop(e){ -1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),1===this._activeRenderLoops.length&&0===this._frameHandler&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())));}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e;}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e;}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e;}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}getHostWindow(){return Se$2()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=true;}_rebuildTextures(){for(const e of this.scenes)e._rebuildTextures();for(const e of this._virtualScenes)e._rebuildTextures();}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);-1!==t&&this._renderTargetWrapperCache.splice(t,1);}get currentViewport(){return this._cachedViewport}setViewport(e,t,i){const s=t||this.getRenderWidth(),r=i||this.getRenderHeight(),n=e.x||0,a=e.y||0;this._cachedViewport=e,this._viewport(n*s,a*r,s*e.width,r*e.height);}createCanvasImage(){return document.createElement("img")}createCanvasPath2D(e){return new Path2D(e)}get description(){let e=this.name+this.version;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}_createTextureBase(e,t,i,s,r=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,n=null,a=null,o,h,l=null,c=null,u=null,d=null,_,f,p){const g="data:"===(e=e||"").substring(0,5),m="blob:"===e.substring(0,5),T=g&&-1!==e.indexOf(";base64,"),E=c||new zt(this,1);E!==c&&(E.label=e.substring(0,60));const A=e;!this._transformTextureUrl||T||c||l||(e=this._transformTextureUrl(e)),A!==e&&(E._originalUrl=A);const R=e.lastIndexOf(".");let b=d||(R>-1?e.substring(R).toLowerCase():"");b.indexOf("?")>-1&&(b=b.split("?")[0]);const S=Yt$1(b,_);s&&s.addPendingData(E),E.url=e,E.generateMipMaps=!t,E.samplingMode=r,E.invertY=i,E._useSRGBBuffer=this._getUseSRGBBuffer(!!p,t),this._doNotHandleContextLost||(E._buffer=l);let x=null;n&&!c&&(x=E.onLoadedObservable.add(n)),c||this._internalTexturesCache.push(E);const M=(i,c)=>{s&&s.removePendingData(E),e===A?(x&&E.onLoadedObservable.remove(x),L$7.UseFallbackTexture&&e!==L$7.FallbackTexture&&this._createTextureBase(L$7.FallbackTexture,t,E.invertY,s,r,null,a,o,h,l,E),i=(i||"Unknown error")+(L$7.UseFallbackTexture?" - Fallback texture was used":""),E.onErrorObservable.notifyObservers({message:i,exception:c}),a&&a(i,c)):(Ie$2.Warn(`Failed to load ${e}, falling back to ${A}`),this._createTextureBase(A,t,E.invertY,s,r,n,a,o,h,l,E,u,d,_,f,p));};if(S){const t=async e=>{(await S).loadData(e,E,((e,t,i,n,a,h)=>{h?M("TextureLoader failed to load data"):o(E,b,s,{width:e,height:t},E.invertY,!i,n,(()=>(a(),false)),r);}),f);};l?l instanceof ArrayBuffer?t(new Uint8Array(l)):ArrayBuffer.isView(l)?t(l):a&&a("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,(e=>{t(new Uint8Array(e));}),void 0,s?s.offlineProvider:void 0,true,((e,t)=>{M("Unable to load "+(e&&e.responseURL,t));}));}else {const i=e=>{m&&!this._doNotHandleContextLost&&(E._buffer=e),o(E,b,s,e,E.invertY,t,false,h,r);};!g||T?l&&("string"==typeof l.decoding||l.close)?i(l):jt._FileToolsLoadImage(e||"",i,M,s?s.offlineProvider:null,_,E.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):"string"==typeof l||l instanceof ArrayBuffer||ArrayBuffer.isView(l)||l instanceof Blob?jt._FileToolsLoadImage(l,i,M,s?s.offlineProvider:null,_,E.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):l&&i(l);}return E}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuildAfterContextLost();}get _shouldUseHighPrecisionShader(){return !(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:Me$3()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0;}getCaps(){return this._caps}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1;}get name(){return this._name}set name(e){this._name=e;}static get NpmPackage(){return "babylonjs@8.33.4"}static get Version(){return "8.33.4"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize();}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e;}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(e,t,i){this._colorWrite=true,this._colorWriteChanged=true,this._depthCullingState=new Bt$1,this._stencilStateComposer=new Ut$1,this._stencilState=new kt$1,this._alphaState=new Gt$1(false),this._alphaMode=Array(8).fill(-1),this._alphaEquation=Array(8).fill(-1),this._activeRequests=[],this._badOS=false,this._badDesktopOS=false,this._compatibilityMode=true,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=false,this.onCanvasBlurObservable=new R$g,this.onCanvasFocusObservable=new R$g,this.onNewSceneAddedObservable=new R$g,this.onResizeObservable=new R$g,this.onCanvasPointerOutObservable=new R$g,this.onEffectErrorObservable=new R$g,this.disablePerformanceMonitorInBackground=false,this.disableVertexArrayObjects=false,this._frameId=0,this.hostInformation={isMobile:false},this.isFullscreen=false,this.enableOfflineSupport=false,this.disableManifestCheck=false,this.disableContextMenu=true,this.currentRenderPassId=Qe$1.RENDERPASS_MAIN,this.isPointerLock=false,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=false,this._useReverseDepthBuffer=false,this.isNDCHalfZRange=false,this.hasOriginBottomLeft=true,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=false,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new R$g,this.renderEvenInBackground=true,this.preventCacheWipeBetweenFrames=false,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=false,this._boundRenderFunction=e=>this._renderLoop(e),this._lastFrameTime=0,this._renderAccumulator=0,this.skipFrameRender=false,this.onBeforeShaderCompilationObservable=new R$g,this.onAfterShaderCompilationObservable=new R$g,this.onBeginFrameObservable=new R$g,this.onEndFrameObservable=new R$g,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=true,this.onContextLostObservable=new R$g,this.onContextRestoredObservable=new R$g,this._name="",this.premultipliedAlpha=true,this.adaptToDeviceRatio=false,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=false,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=false,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new R$g,this.onReleaseEffectsObservable=new R$g,L$7.Instances.push(this),this.startTime=Pe$2.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,D$9.SetMatrixPrecision(!!t.useLargeWorldRendering||!!t.useHighPrecisionMatrix),xe$3()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=i??false,t.antialias=e??t.antialias,t.deterministicLockstep=t.deterministicLockstep??false,t.lockstepMaxSteps=t.lockstepMaxSteps??4,t.timeStep=t.timeStep??1/60,t.stencil=t.stencil??true,this._audioContext=t.audioEngineOptions?.audioContext??null,this._audioDestination=t.audioEngineOptions?.audioDestination??null,this.premultipliedAlpha=t.premultipliedAlpha??true,this._doNotHandleContextLost=!!t.doNotHandleContextLost,this._isStencilEnable=!!t.stencil,this.useExactSrgbConversions=t.useExactSrgbConversions??false;const s=Se$2()&&window.devicePixelRatio||1,r=t.limitDeviceRatio||s;i=i||t.adaptToDeviceRatio||false,this._hardwareScalingLevel=i?1/Math.min(r,s):1,this._lastDevicePixelRatio=s,this._creationOptions=t;}resize(e=false){let t,i;if(this.adaptToDeviceRatio){const e=Se$2()&&window.devicePixelRatio||1,t=this._lastDevicePixelRatio/e;this._lastDevicePixelRatio=e,this._hardwareScalingLevel*=t;}if(Se$2()&&Me$3())if(this._renderingCanvas){const e=this._renderingCanvas.getBoundingClientRect?.();t=this._renderingCanvas.clientWidth||e?.width||this._renderingCanvas.width*this._hardwareScalingLevel||100,i=this._renderingCanvas.clientHeight||e?.height||this._renderingCanvas.height*this._hardwareScalingLevel||100;}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e);}setSize(e,t,i=false){if(!this._renderingCanvas)return  false;if(e|=0,t|=0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)return  false;if(this._renderingCanvas.width=e,this._renderingCanvas.height=t,this.scenes){for(let e=0;e<this.scenes.length;e++){const t=this.scenes[e];for(let e=0;e<t.cameras.length;e++){t.cameras[e]._currentRenderId=0;}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this);}return  true}createRawTexture(e,t,i,s,r,n,a,o,h,l,c){throw le$4("engine.rawTexture")}createRawCubeTexture(e,t,i,s,r,n,a,o){throw le$4("engine.rawTexture")}createRawTexture3D(e,t,i,s,r,n,a,o,h,l,c){throw le$4("engine.rawTexture")}createRawTexture2DArray(e,t,i,s,r,n,a,o,h,l,c){throw le$4("engine.rawTexture")}_sharedInit(e){this._renderingCanvas=e;}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=-1!==e.indexOf("Mobile")||-1!==e.indexOf("Mac")&&Me$3()&&"ontouchend"in document;},this._checkForMobile(),Se$2()&&window.addEventListener("resize",this._checkForMobile));}createVideoElement(e){return document.createElement("video")}_reportDrawCall(e=1){this._drawCalls?.addCount(e,false);}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return 1e3*this._timeStep}_createImageBitmapFromSource(e,t){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(e){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(e,t){if("undefined"==typeof document)return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return jt._CreateCanvas(e,t)}static _FileToolsLoadImage(e,t,i,s,r,n,a){throw le$4("FileTools")}_loadFile(e,t,i,s,r,n){const a=Je$1(e,t,i,s,r,n);return this._activeRequests.push(a),a.onCompleteObservable.add((()=>{const e=this._activeRequests.indexOf(a);-1!==e&&this._activeRequests.splice(e,1);})),a}static _FileToolsLoadFile(e,t,i,s,r,n){if(qe$1.loadFile)return qe$1.loadFile(e,t,i,s,r,n);throw le$4("FileTools")}dispose(){for(this.releaseEffects(),this._isDisposed=true,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();this.releaseComputeEffects?.(),Nt$1.ResetCache();for(const e of this._activeRequests)e.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),this.onEffectErrorObservable.clear(),Se$2()&&window.removeEventListener("resize",this._checkForMobile);const e=L$7.Instances.indexOf(this);e>=0&&L$7.Instances.splice(e,1),L$7.Instances.length||(L$7.OnEnginesDisposedObservable.notifyObservers(this),L$7.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear();}static DefaultLoadingScreenFactory(e){throw le$4("LoadingScreen")}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<L$7.Instances.length;i++){const s=L$7.Instances[i];for(let i=0;i<s.scenes.length;i++)s.scenes[i].markAllMaterialsAsDirty(e,t);}}}jt._RenderPassIdCounter=0,jt._RescalePostProcessFactory=null,jt.CollisionsEpsilon=.001,jt.QueueNewFrame=Kt;const Qt$1=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);let qt$1=class qt extends we$3{constructor(e,t){super(e,Fe$2.LoadFileError),this.name="LoadFileError",Le$2._setPrototypeOf(this,qt.prototype),t instanceof Oe$3?this.request=t:this.file=t;}};class Zt extends we$3{constructor(e,t){super(e,Fe$2.RequestFileError),this.request=t,this.name="RequestFileError",Le$2._setPrototypeOf(this,Zt.prototype);}}class Jt extends we$3{constructor(e,t){super(e,Fe$2.ReadFileError),this.file=t,this.name="ReadFileError",Le$2._setPrototypeOf(this,Jt.prototype);}}const $t$1={DefaultRetryStrategy:class{static ExponentialBackoff(e=3,t=500){return (i,s,r)=>0!==s.status||r>=e||-1!==i.indexOf("file:")?-1:Math.pow(2,r)*t}}.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:e=>e,ScriptBaseUrl:"",ScriptPreprocessUrl:e=>e,CleanUrl:e=>e=e.replace(/#/gm,"%23")},ei=(e,t)=>{if((!e||0!==e.indexOf("data:"))&&$t$1.CorsBehavior)if("string"==typeof $t$1.CorsBehavior||$t$1.CorsBehavior instanceof String)t.crossOrigin=$t$1.CorsBehavior;else {const i=$t$1.CorsBehavior(e);i&&(t.crossOrigin=i);}},ti=(e,t,i,s,r="",n,a=L$7.LastCreatedEngine)=>{if("undefined"==typeof HTMLImageElement&&!a?._features.forceBitmapOverHTMLImageElement)return i("LoadImage is only supported in web or BabylonNative environments."),null;let o,h=false;e instanceof ArrayBuffer||ArrayBuffer.isView(e)?"undefined"!=typeof Blob&&"undefined"!=typeof URL?(o=URL.createObjectURL(new Blob([e],{type:r})),h=true):o=`data:${r};base64,`+Ue$2(e):e instanceof Blob?(o=URL.createObjectURL(e),h=true):(o=$t$1.CleanUrl(e),o=$t$1.PreprocessUrl(o));const l=t=>{if(i){const s=o||e.toString();i(`Error while trying to load image: ${0===s.indexOf("http")||s.length<=128?s:s.slice(0,128)+"..."}`,t);}};if(a?._features.forceBitmapOverHTMLImageElement)return si(o,(s=>{a.createImageBitmap(new Blob([s],{type:r}),{premultiplyAlpha:"none",...n}).then((e=>{t(e),h&&URL.revokeObjectURL(o);})).catch((t=>{i&&i("Error while trying to load image: "+e,t);}));}),void 0,s||void 0,true,((e,t)=>{l(t);})),null;const c=new Image;ei(o,c);const u=[],d=()=>{for(const e of u)e.target.removeEventListener(e.name,e.handler);u.length=0;};u.push({target:c,name:"load",handler:()=>{d(),t(c),h&&c.src&&URL.revokeObjectURL(c.src);}}),u.push({target:c,name:"error",handler:e=>{d(),l(e),h&&c.src&&URL.revokeObjectURL(c.src);}}),u.push({target:document,name:"securitypolicyviolation",handler:e=>{if(e.blockedURI!==c.src||"report"===e.disposition)return;d();const t=new Error(`CSP violation of policy ${e.effectiveDirective} ${e.blockedURI}. Current policy is ${e.originalPolicy}`);L$7.UseFallbackTexture=false,l(t),h&&c.src&&URL.revokeObjectURL(c.src),c.src="";}}),(()=>{for(const e of u)e.target.addEventListener(e.name,e.handler);})();const _="blob:"===o.substring(0,5),f="data:"===o.substring(0,5),p=()=>{_||f||!Oe$3.IsCustomRequestAvailable?c.src=o:si(o,((e,t,i)=>{const s=new Blob([e],{type:!r&&i?i:r}),n=URL.createObjectURL(s);h=!0,c.src=n;}),void 0,s||void 0,true,((e,t)=>{l(t);}));},g=()=>{s&&s.loadImage(o,c);};if(!_&&!f&&s&&s.enableTexturesOffline)s.open(g,p);else {if(-1!==o.indexOf("file:")){const e=decodeURIComponent(o.substring(5).toLowerCase());if(De$2.FilesToLoad[e]&&"undefined"!=typeof URL){try{let t;try{t=URL.createObjectURL(De$2.FilesToLoad[e]);}catch(i){t=URL.createObjectURL(De$2.FilesToLoad[e]);}c.src=t,h=!0;}catch(e){c.src="";}return c}}p();}return c},ii=(e,t,i,s,r)=>{const n=new FileReader,a={onCompleteObservable:new R$g,abort:()=>n.abort()};return n.onloadend=()=>a.onCompleteObservable.notifyObservers(a),r&&(n.onerror=()=>{r(new Jt(`Unable to read ${e.name}`,e));}),n.onload=e=>{t(e.target.result);},i&&(n.onprogress=i),s?n.readAsArrayBuffer(e):n.readAsText(e),a},si=(e,t,i,s,r,n,a)=>{if(e.name)return ii(e,t,i,r,n?e=>{n(void 0,e);}:void 0);const o=e;if(-1!==o.indexOf("file:")){let e=decodeURIComponent(o.substring(5).toLowerCase());0===e.indexOf("./")&&(e=e.substring(2));const s=De$2.FilesToLoad[e];if(s)return ii(s,t,i,r,n?e=>n(void 0,new qt$1(e.message,e.file)):void 0)}const{match:h,type:l}=hi(o);if(h){const e={onCompleteObservable:new R$g,abort:()=>()=>{}};try{const e=r?li(o):ci(o);t(e,void 0,l);}catch(e){n?n(void 0,e):Ie$2.Error(e.message||"Failed to parse the Data URL");}return Et$1.SetImmediate((()=>{e.onCompleteObservable.notifyObservers(e);})),e}return ri(o,((e,i)=>{t(e,i?.responseURL,i?.getResponseHeader("content-type"));}),i,s,r,n?e=>{n(e.request,new qt$1(e.message,e.request));}:void 0,a)},ri=(e,t,i,s,r,n,a)=>{null!==s&&(s??=L$7.LastCreatedScene?.offlineProvider),e=$t$1.CleanUrl(e),e=$t$1.PreprocessUrl(e);const o=$t$1.BaseUrl+e;let h=false;const l={onCompleteObservable:new R$g,abort:()=>h=true},c=()=>{let e,s=new Oe$3,c=null;const u=()=>{s&&(i&&s.removeEventListener("progress",i),e&&s.removeEventListener("readystatechange",e),s.removeEventListener("loadend",d));};let d=()=>{u(),l.onCompleteObservable.notifyObservers(l),l.onCompleteObservable.clear(),i=void 0,e=null,d=null,n=void 0,a=void 0,t=void 0;};l.abort=()=>{h=true,d&&d(),s&&s.readyState!==(XMLHttpRequest.DONE||4)&&s.abort(),null!==c&&(clearTimeout(c),c=null),s=null;};const _=e=>{const t=e.message||"Unknown error";n&&s?n(new Zt(t,s)):Ie$2.Error(t);},f=l=>{if(s){if(s.open("GET",o),a)try{a(s);}catch(e){return void _(e)}r&&(s.responseType="arraybuffer"),i&&s.addEventListener("progress",i),d&&s.addEventListener("loadend",d),e=()=>{if(!h&&s&&s.readyState===(XMLHttpRequest.DONE||4)){if(e&&s.removeEventListener("readystatechange",e),s.status>=200&&s.status<300||0===s.status&&(!Se$2()||ai())){const e=r?s.response:s.responseText;if(null!==e){try{t&&t(e,s);}catch(e){_(e);}return}}const i=$t$1.DefaultRetryStrategy;if(i){const e=i(o,s,l);if(-1!==e)return u(),s=new Oe$3,void(c=setTimeout((()=>f(l+1)),e))}const a=new Zt("Error status: "+s.status+" "+s.statusText+" - Unable to load "+o,s);n&&n(a);}},s.addEventListener("readystatechange",e),s.send();}};f(0);};if(s&&s.enableSceneOffline&&!e.startsWith("blob:")){const a=e=>{e&&e.status>400?n&&n(e):c();},o=()=>{s&&s.loadFile($t$1.BaseUrl+e,(e=>{!h&&t&&t(e),l.onCompleteObservable.notifyObservers(l);}),i?e=>{!h&&i&&i(e);}:void 0,a,r);};s.open(o,a);}else c();return l},ni=e=>{const{match:t,type:i}=hi(e);if(t)return i||void 0;const s=e.lastIndexOf(".");switch(e.substring(s+1).toLowerCase()){case "glb":return "model/gltf-binary";case "bin":return "application/octet-stream";case "gltf":return "model/gltf+json";case "jpg":case "jpeg":return "image/jpeg";case "png":return "image/png";case "webp":return "image/webp";case "ktx":return "image/ktx";case "ktx2":return "image/ktx2";case "avif":return "image/avif";default:return}},ai=()=>"undefined"!=typeof location&&"file:"===location.protocol,oi=e=>Qt$1.test(e),hi=e=>{const t=Qt$1.exec(e);if(null===t||0===t.length)return {match:false,type:""};return {match:true,type:t[0].replace("data:","").replace(";base64,","")}};function li(e){return (e=>{const t=ke$2(e),i=t.length,s=new Uint8Array(new ArrayBuffer(i));for(let e=0;e<i;e++)s[e]=t.charCodeAt(e);return s.buffer})(e.split(",")[1])}const ci=e=>ke$2(e.split(",")[1]);let ui;jt._FileToolsLoadImage=ti,qe$1.loadFile=si,mt$1.loadFile=si;((e,t,i,s,r,n,a,o,h,l)=>{ui={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:i.DefaultRetryStrategy,BaseUrl:i.BaseUrl,CorsBehavior:i.CorsBehavior,PreprocessUrl:i.PreprocessUrl,IsBase64DataUrl:s,IsFileURL:r,LoadFile:n,LoadImage:a,ReadFile:o,RequestFile:h,SetCorsBehavior:l},Object.defineProperty(ui,"DefaultRetryStrategy",{get:function(){return i.DefaultRetryStrategy},set:function(e){i.DefaultRetryStrategy=e;}}),Object.defineProperty(ui,"BaseUrl",{get:function(){return i.BaseUrl},set:function(e){i.BaseUrl=e;}}),Object.defineProperty(ui,"PreprocessUrl",{get:function(){return i.PreprocessUrl},set:function(e){i.PreprocessUrl=e;}}),Object.defineProperty(ui,"CorsBehavior",{get:function(){return i.CorsBehavior},set:function(e){i.CorsBehavior=e;}});})(li,ci,$t$1,oi,ai,si,ti,ii,ri,ei);class di{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=O$g(e);if(t)return t;Ie$2.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let s=window||this;for(let e=0,t=i.length;e<t;e++)s=s[i[e]];return "function"!=typeof s?null:s}}function _i(){return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return ("x"===e?t:3&t|8).toString(16)}))}function fi(e){let t=1;do{t*=2;}while(t<e);return t===e}function pi(e,t,i){return e*(1-i)+t*i}function gi(e){const t=mi(e),i=Ti(e);return t-e>e-i?i:t}function mi(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Ti(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)-(e>>1)}function Ei(e,t,i=Qe$1.SCALEMODE_NEAREST){let s;switch(i){case Qe$1.SCALEMODE_FLOOR:s=Ti(e);break;case Qe$1.SCALEMODE_NEAREST:s=gi(e);break;case Qe$1.SCALEMODE_CEILING:default:s=mi(e);}return Math.min(s,t)}di.RegisteredExternalClasses={};class Ai{static get BaseUrl(){return $t$1.BaseUrl}static set BaseUrl(e){$t$1.BaseUrl=e;}static get CleanUrl(){return $t$1.CleanUrl}static set CleanUrl(e){$t$1.CleanUrl=e;}static IsAbsoluteUrl(e){return 0===e.indexOf("//")||-1!==e.indexOf("://")&&(-1!==e.indexOf(".")&&(-1!==e.indexOf("/")&&(!(e.indexOf(":")>e.indexOf("/"))&&(e.indexOf("://")<e.indexOf(".")||(0===e.indexOf("data:")||0===e.indexOf("blob:"))))))}static set ScriptBaseUrl(e){$t$1.ScriptBaseUrl=e;}static get ScriptBaseUrl(){return $t$1.ScriptBaseUrl}static set CDNBaseUrl(e){Ai.ScriptBaseUrl=e,Ai.AssetBaseUrl=e;}static set ScriptPreprocessUrl(e){$t$1.ScriptPreprocessUrl=e;}static get ScriptPreprocessUrl(){return $t$1.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return $t$1.DefaultRetryStrategy}static set DefaultRetryStrategy(e){$t$1.DefaultRetryStrategy=e;}static get CorsBehavior(){return $t$1.CorsBehavior}static set CorsBehavior(e){$t$1.CorsBehavior=e;}static get UseFallbackTexture(){return L$7.UseFallbackTexture}static set UseFallbackTexture(e){L$7.UseFallbackTexture=e;}static get RegisteredExternalClasses(){return di.RegisteredExternalClasses}static set RegisteredExternalClasses(e){di.RegisteredExternalClasses=e;}static get fallbackTexture(){return L$7.FallbackTexture}static set fallbackTexture(e){L$7.FallbackTexture=e;}static FetchToRef(e,t,i,s,r,n){const a=4*((Math.abs(e)*i%i|0)+(Math.abs(t)*s%s|0)*i);n.r=r[a]/255,n.g=r[a+1]/255,n.b=r[a+2]/255,n.a=r[a+3]/255;}static Mix(e,t,i){return 0}static Instantiate(e){return di.Instantiate(e)}static SetImmediate(e){Et$1.SetImmediate(e);}static IsExponentOfTwo(e){return  true}static FloatRound(e){return Math.fround(e)}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=false){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return 180*e/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const s=this.ToRadians(e),r=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(r)+i*Math.sin(s),(1-i)*Math.cos(r)+i*Math.cos(s)))}static MakeArray(e,t){return  true===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null}static GetPointerPrefix(e){return Se$2()&&!window.PointerEvent?"mouse":"pointer"}static SetCorsBehavior(e,t){ei(e,t);}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e;}static get PreprocessUrl(){return $t$1.PreprocessUrl}static set PreprocessUrl(e){$t$1.PreprocessUrl=e;}static LoadImage(e,t,i,s,r,n){return ti(e,t,i,s,r,n)}static LoadFile(e,t,i,s,r,n){return si(e,t,i,s,r,n)}static async LoadFileAsync(e,t=true){return await new Promise(((i,s)=>{si(e,(e=>{i(e);}),void 0,void 0,t,((e,t)=>{s(t);}));}))}static GetAssetUrl(e){if(!e)return "";if(Ai.AssetBaseUrl&&e.startsWith(Ai._DefaultAssetsUrl)){const t="/"===Ai.AssetBaseUrl[Ai.AssetBaseUrl.length-1]?Ai.AssetBaseUrl.substring(0,Ai.AssetBaseUrl.length-1):Ai.AssetBaseUrl;return e.replace(Ai._DefaultAssetsUrl,t)}return e}static GetBabylonScriptURL(e,t){if(!e)return "";if(Ai.ScriptBaseUrl&&e.startsWith(Ai._DefaultCdnUrl)){const t="/"===Ai.ScriptBaseUrl[Ai.ScriptBaseUrl.length-1]?Ai.ScriptBaseUrl.substring(0,Ai.ScriptBaseUrl.length-1):Ai.ScriptBaseUrl;e=e.replace(Ai._DefaultCdnUrl,t);}return e=Ai.ScriptPreprocessUrl(e),t&&!Ai.IsAbsoluteUrl(e)&&(e=Ai.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,i,s){e=Ai.GetBabylonScriptURL(e),Ai.LoadScript(e,t,i);}static async LoadBabylonScriptAsync(e){return e=Ai.GetBabylonScriptURL(e),await Ai.LoadScriptAsync(e)}static LoadScript(e,t,i,s,r=false){if("function"==typeof importScripts){try{importScripts(e),t&&t();}catch(t){i?.(`Unable to load script '${e}' in worker`,t);}return}if(!Se$2())return void i?.(`Cannot load script '${e}' outside of a window or a worker`);const n=document.getElementsByTagName("head")[0],a=document.createElement("script");r?(a.setAttribute("type","module"),a.innerText=e):(a.setAttribute("type","text/javascript"),a.setAttribute("src",e)),s&&(a.id=s),a.onload=()=>{t&&t();},a.onerror=t=>{i&&i(`Unable to load script '${e}'`,t);},n.appendChild(a);}static async LoadScriptAsync(e,t){return await new Promise(((i,s)=>{this.LoadScript(e,(()=>{i();}),((e,t)=>{s(t||new Error(e));}),t);}))}static ReadFileAsDataURL(e,t,i){const s=new FileReader,r={onCompleteObservable:new R$g,abort:()=>s.abort()};return s.onloadend=()=>{r.onCompleteObservable.notifyObservers(r);},s.onload=e=>{t(e.target.result);},s.onprogress=i,s.readAsDataURL(e),r}static ReadFile(e,t,i,s,r){return ii(e,t,i,s,r)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,s){ve$3.DeepCopy(e,t,i,s);}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return  false;return  true}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.addEventListener(s.name,s.handler,false);try{window.parent&&window.parent.addEventListener(s.name,s.handler,!1);}catch(e){}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.removeEventListener(s.name,s.handler);try{e.parent&&e.parent.removeEventListener(s.name,s.handler);}catch(e){}}}static async DumpFramebuffer(e,t,i,s,r="image/png",n,a){throw le$4("DumpTools")}static DumpData(e,t,i,s,r="image/png",n,a=false,o=false,h){throw le$4("DumpTools")}static async DumpDataAsync(e,t,i,s="image/png",r,n=false,a=false,o){throw le$4("DumpTools")}static _IsOffScreenCanvas(e){return void 0!==e.convertToBlob}static ToBlob(e,t,i="image/png",s){Ai._IsOffScreenCanvas(e)||e.toBlob||(e.toBlob=function(e,t,i){setTimeout((()=>{const s=atob(this.toDataURL(t,i).split(",")[1]),r=s.length,n=new Uint8Array(r);for(let e=0;e<r;e++)n[e]=s.charCodeAt(e);e(new Blob([n]));}));}),Ai._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:s}).then((e=>t(e))):e.toBlob((function(e){t(e);}),i,s);}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const e=new Date;t="screenshot_"+((e.getFullYear()+"-"+(e.getMonth()+1)).slice(2)+"-"+e.getDate()+"_"+e.getHours()+"-"+("0"+e.getMinutes()).slice(-2))+".png";}Ai.Download(e,t);}else if(e&&"undefined"!=typeof URL){const t=URL.createObjectURL(e),i=window.open("");if(!i)return;const s=i.document.createElement("img");s.onload=function(){URL.revokeObjectURL(t);},s.src=t,i.document.body.appendChild(s);}}static EncodeScreenshotCanvasData(e,t,i="image/png",s,r){if("string"!=typeof s&&t){if(t){if(Ai._IsOffScreenCanvas(e))return void e.convertToBlob({type:i,quality:r}).then((e=>{const i=new FileReader;i.readAsDataURL(e),i.onloadend=()=>{const e=i.result;t(e);};}));const s=e.toDataURL(i,r);t(s);}}else this.ToBlob(e,(function(e){e&&Ai.DownloadBlob(e,s),t&&t("");}),i,r);}static Download(e,t){if("undefined"==typeof URL)return;const i=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=i,s.download=t,s.addEventListener("click",(()=>{s.parentElement&&s.parentElement.removeChild(s);})),s.click(),window.URL.revokeObjectURL(i);}static BackCompatCameraNoPreventDefault(e){return "boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]}static CreateScreenshot(e,t,i,s,r="image/png",n=false,a){throw le$4("ScreenshotTools")}static async CreateScreenshotAsync(e,t,i,s="image/png",r){throw le$4("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,s,r="image/png",n=1,a=false,o,h=false,l=false,c=true,u,d){throw le$4("ScreenshotTools")}static async CreateScreenshotUsingRenderTargetAsync(e,t,i,s="image/png",r=1,n=false,a,o=false,h=false,l=true,c,u){throw le$4("ScreenshotTools")}static RandomId(){return _i()}static IsBase64(e){return oi(e)}static DecodeBase64(e){return li(e)}static get errorsCount(){return Ie$2.errorsCount}static Log(e){Ie$2.Log(e);}static Warn(e){Ie$2.Warn(e);}static Error(e){Ie$2.Error(e);}static get LogCache(){return Ie$2.LogCache}static ClearLogCache(){Ie$2.ClearLogCache();}static set LogLevels(e){Ie$2.LogLevels=e;}static set PerformanceLogLevel(e){return (e&Ai.PerformanceUserMarkLogLevel)===Ai.PerformanceUserMarkLogLevel?(Ai.StartPerformanceCounter=Ai._StartUserMark,void(Ai.EndPerformanceCounter=Ai._EndUserMark)):(e&Ai.PerformanceConsoleLogLevel)===Ai.PerformanceConsoleLogLevel?(Ai.StartPerformanceCounter=Ai._StartPerformanceConsole,void(Ai.EndPerformanceCounter=Ai._EndPerformanceConsole)):(Ai.StartPerformanceCounter=Ai._StartPerformanceCounterDisabled,void(Ai.EndPerformanceCounter=Ai._EndPerformanceCounterDisabled))}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=true){if(!Ai._Performance){if(!Se$2())return;Ai._Performance=window.performance;}t&&Ai._Performance.mark&&Ai._Performance.mark(e+"-Begin");}static _EndUserMark(e,t=true){t&&Ai._Performance.mark&&(Ai._Performance.mark(e+"-End"),Ai._Performance.measure(e,e+"-Begin",e+"-End"));}static _StartPerformanceConsole(e,t=true){t&&(Ai._StartUserMark(e,t),console.time&&console.time(e));}static _EndPerformanceConsole(e,t=true){t&&(Ai._EndUserMark(e,t),console.timeEnd(e));}static get Now(){return Pe$2.Now}static GetClassName(e,t=false){let i=null;if(!t&&e.getClassName)i=e.getClassName();else {if(e instanceof Object){i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__;}i||(i=typeof e);}return i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=false){let i=null,s=null;if(!t&&e.getClassName)i=e.getClassName();else {if(e instanceof Object){const r=t?e:Object.getPrototypeOf(e);i=r.constructor.__bjsclassName__,s=r.constructor.__bjsmoduleName__;}i||(i=typeof e);}return i?(null!=s?s+".":"")+i:null}static async DelayAsync(e){await new Promise((t=>{setTimeout((()=>{t();}),e);}));}static IsSafari(){return !!xe$3()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}Ai.AssetBaseUrl="",Ai.UseCustomRequestHeaders=false,Ai.CustomRequestHeaders=Oe$3.CustomRequestHeaders,Ai.GetDOMTextContent=ye$3,Ai._DefaultCdnUrl="https://cdn.babylonjs.com",Ai._DefaultAssetsUrl="https://assets.babylonjs.com/core",Ai.GetAbsoluteUrl="object"==typeof document?e=>{const t=document.createElement("a");return t.href=e,t.href}:"function"==typeof URL&&"object"==typeof location?e=>new URL(e,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},Ai.NoneLogLevel=Ie$2.NoneLogLevel,Ai.MessageLogLevel=Ie$2.MessageLogLevel,Ai.WarningLogLevel=Ie$2.WarningLogLevel,Ai.ErrorLogLevel=Ie$2.ErrorLogLevel,Ai.AllLogLevel=Ie$2.AllLogLevel,Ai.IsWindowObjectExist=Se$2,Ai.PerformanceNoneLogLevel=0,Ai.PerformanceUserMarkLogLevel=1,Ai.PerformanceConsoleLogLevel=2,Ai.StartPerformanceCounter=Ai._StartPerformanceCounterDisabled,Ai.EndPerformanceCounter=Ai._EndPerformanceCounterDisabled;class Ri{constructor(e,t,i,s=0){this.iterations=e,this.index=s-1,this._done=false,this._fn=t,this._successCallback=i;}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop());}breakLoop(){this._done=true,this._successCallback();}static Run(e,t,i,s=0){const r=new Ri(e,t,i,s);return r.executeNext(),r}static SyncAsyncForLoop(e,t,i,s,r,n=0){return Ri.Run(Math.ceil(e/t),(s=>{r&&r()?s.breakLoop():setTimeout((()=>{for(let n=0;n<t;++n){const a=s.index*t+n;if(a>=e)break;if(i(a),r&&r()){s.breakLoop();break}}s.executeNext();}),n);}),s)}}function bi(e,t,i){try{const s=e.next();s.done?t(s):s.value?s.value.then((()=>{s.value=void 0,t(s);}),i):t(s);}catch(e){i(e);}}function Si(e=25){let t;return (i,s,r)=>{const n=performance.now();void 0===t||n-t>e?(t=n,setTimeout((()=>{bi(i,s,r);}),0)):bi(i,s,r);}}function xi(e,t,i,s,r){const n=()=>{let r;const a=e=>{e.done?i(e.value):void 0===r?r=true:n();};do{r=void 0,t(e,a,s),void 0===r&&(r=false);}while(r)};n();}function Mi(e,t){let i;return xi(e,bi,(e=>i=e),(e=>{throw e})),i}async function yi(e,t,i){return await new Promise(((i,s)=>{xi(e,t,i,s);}))}Ai.Mix=pi,Ai.IsExponentOfTwo=fi,L$7.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";class Ii{constructor(e){this.length=0,this.data=new Array(e),this._id=Ii._GlobalId++;}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2);}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t]);}sort(e){this.data.sort(e);}reset(){this.length=0;}dispose(){this.reset(),this.data&&(this.data.length=0);}concat(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t];}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return  -1!==this.indexOf(e)}}Ii._GlobalId=0;class Ci extends Ii{constructor(){super(...arguments),this._duplicateId=0;}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId;}pushNoDuplicate(e){return (!e.__smartArrayFlags||e.__smartArrayFlags[this._id]!==this._duplicateId)&&(this.push(e),true)}reset(){super.reset(),this._duplicateId++;}concatWithNoDuplicate(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i);}}}}class vi{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s;}toGlobal(e,t){return new vi(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new vi(this.x,this.y,this.width,this.height)}}class Pi{constructor(e,t,i,s){this.normal=new te$4(e,t,i),this.d=s;}asArray(){return [this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new Pi(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return "Plane"}getHashCode(){let e=this.normal.getHashCode();return e=397*e^this.d,e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=Pi._TmpMatrix;e.invertToRef(t);const i=t.m,s=this.normal.x,r=this.normal.y,n=this.normal.z,a=this.d,o=s*i[0]+r*i[1]+n*i[2]+a*i[3],h=s*i[4]+r*i[5]+n*i[6]+a*i[7],l=s*i[8]+r*i[9]+n*i[10]+a*i[11],c=s*i[12]+r*i[13]+n*i[14]+a*i[15];return new Pi(o,h,l,c)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const s=t.x-e.x,r=t.y-e.y,n=t.z-e.z,a=i.x-e.x,o=i.y-e.y,h=i.z-e.z,l=r*h-n*o,c=n*a-s*h,u=s*o-r*a,d=Math.sqrt(l*l+c*c+u*u);let _;return _=0!==d?1/d:0,this.normal.x=l*_,this.normal.y=c*_,this.normal.z=u*_,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return te$4.Dot(this.normal,e)<=t}signedDistanceTo(e){return te$4.Dot(e,this.normal)+this.d}static FromArray(e){return new Pi(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const s=new Pi(0,0,0,0);return s.copyFromPoints(e,t,i),s}static FromPositionAndNormal(e,t){const i=new Pi(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const s=-(t.x*e.x+t.y*e.y+t.z*e.z);return te$4.Dot(i,t)+s}}Pi._TmpMatrix=re$5.Identity();class Oi{static GetPlanes(e){const t=[];for(let e=0;e<6;e++)t.push(new Pi(0,0,0,0));return Oi.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize();}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize();}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize();}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize();}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize();}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize();}static GetPlanesToRef(e,t){Oi.GetNearPlaneToRef(e,t[0]),Oi.GetFarPlaneToRef(e,t[1]),Oi.GetLeftPlaneToRef(e,t[2]),Oi.GetRightPlaneToRef(e,t[3]),Oi.GetTopPlaneToRef(e,t[4]),Oi.GetBottomPlaneToRef(e,t[5]);}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return  false;return  true}}class Di extends be$3{get position(){return this._position}set position(e){this._position=e;}set upVector(e){this._upVector=e;}get upVector(){return this._upVector}get screenArea(){let e=0,t=0;if(this.mode===Di.PERSPECTIVE_CAMERA)this.fovMode===Di.FOVMODE_VERTICAL_FIXED?(t=2*this.minZ*Math.tan(this.fov/2),e=this.getEngine().getAspectRatio(this)*t):(e=2*this.minZ*Math.tan(this.fov/2),t=e/this.getEngine().getAspectRatio(this));else {const i=this.getEngine().getRenderWidth()/2,s=this.getEngine().getRenderHeight()/2;e=(this.orthoRight??i)-(this.orthoLeft??-i),t=(this.orthoTop??s)-(this.orthoBottom??-s);}return e*t}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e;}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e;}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e;}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e;}get orthoTop(){return this._orthoTop}setFocalLength(e,t=36){this.fov=2*Math.atan(t/(2*e));}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e;}get mode(){return this._mode}get hasMoved(){return this._hasMoved}constructor(e,t,i,s=true){super(e,i,false),this._position=te$4.Zero(),this._upVector=te$4.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=Di.PERSPECTIVE_CAMERA,this.isIntermediate=false,this.viewport=new vi(0,0,1,1),this.layerMask=268435455,this.fovMode=Di.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=Di.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new R$g,this.onProjectionMatrixChangedObservable=new R$g,this.onAfterCheckInputsObservable=new R$g,this.onRestoreStateObservable=new R$g,this.isRigCamera=false,this._hasMoved=false,this._rigCameras=new Array,this._skipRendering=false,this._projectionMatrix=new re$5,this._postProcesses=new Array,this._activeMeshes=new Ii(256),this._globalPosition=te$4.Zero(),this._computedViewMatrix=re$5.Identity(),this._doNotComputeProjectionMatrix=false,this._transformMatrix=re$5.Zero(),this._refreshFrustumPlanes=true,this._absoluteRotation=se$5.Identity(),this._isCamera=true,this._isLeftCamera=false,this._isRightCamera=false,this.getScene().addCamera(this),s&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`);}storeState(){return this._stateStored=true,this._storedFov=this.fov,this}hasStateStored(){return !!this._stateStored}_restoreStateValues(){return !!this._stateStored&&(this.fov=this._storedFov,true)}restoreState(){return !!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),true)}getClassName(){return "Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x;}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return  -1!==this._activeMeshes.indexOf(e)}isReady(e=false){if(e)for(const e of this._postProcesses)if(e&&!e.isReady())return  false;return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0;}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector);}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return !!super._isSynchronized()&&(this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent())}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return  false;const t=this.getEngine();return this.mode===Di.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._hasMoved=false,this._checkInputs(),this.cameraRigMode!==Di.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix();}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this);}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let e=0,t=this._rigCameras.length;e<t;e++){const t=this._rigCameras[e],i=t._rigPostProcess;if(i){"pass"===i.getEffectName()&&(t.isIntermediate=0===this._postProcesses.length),t._postProcesses=this._postProcesses.slice(0).concat(i),i.markTextureDirty();}else t._postProcesses=this._postProcesses.slice(0);}}attachPostProcess(e,t=null){return !e.isReusable()&&this._postProcesses.indexOf(e)>-1?(Ie$2.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams();}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return re$5.Identity()}getViewMatrix(e){return !e&&this._isSynchronizedViewMatrix()||(this._hasMoved=true,this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=true,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=true,void 0!==e&&(this._projectionMatrix=e);}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=false;}getProjectionMatrix(e){if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=true;const t=this.getEngine(),i=this.getScene(),s=t.useReverseDepthBuffer;if(this.mode===Di.PERSPECTIVE_CAMERA){let e;this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),e=i.useRightHandedSystem?re$5.PerspectiveFovRHToRef:re$5.PerspectiveFovLHToRef,e(this.fov,t.getAspectRatio(this),s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===Di.FOVMODE_VERTICAL_FIXED,t.isNDCHalfZRange,this.projectionPlaneTilt,s);}else {const e=t.getRenderWidth()/2,r=t.getRenderHeight()/2;i.useRightHandedSystem?this.oblique?re$5.ObliqueOffCenterRHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):re$5.OrthoOffCenterRHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange):this.oblique?re$5.ObliqueOffCenterLHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):re$5.OrthoOffCenterLHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=this.oblique?.angle,this._cache.obliqueLength=this.oblique?.length,this._cache.obliqueOffset=this.oblique?.offset,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight();}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){return (this.radius||(this.target?te$4.Distance(this.position,this.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?Oi.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Oi.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=false);}isInFrustum(e,t=false){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let t=false;for(const i of this.rigCameras)i._updateFrustumPlanes(),t=t||e.isInFrustum(i._frustumPlanes);return t}return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw le$4("Ray")}getForwardRayToRef(e,t=100,i,s){throw le$4("Ray")}dispose(e,t=false){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose();}if(this._parentContainer){const e=this._parentContainer.cameras.indexOf(this);e>-1&&this._parentContainer.cameras.splice(e,1),this._parentContainer=null;}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==Di.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else {let e=this._postProcesses.length;for(;--e>=0;){const t=this._postProcesses[e];t&&t.dispose(this);}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t);}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose();}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=Ai.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==Di.RIG_MODE_NONE){const e=this.createRigCamera(this.name+"_L",0);e&&(e._isLeftCamera=true);const t=this.createRigCamera(this.name+"_R",1);t&&(t._isRightCamera=true),e&&t&&(this._rigCameras.push(e),this._rigCameras.push(t));}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update();}}_setRigMode(e){}_getVRProjectionMatrix(){return re$5.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,true,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=Ai.ToRadians(t/.0637));}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===Di.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport);}_setupInputs(){}serialize(){const e=Ae$3.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),Ae$3.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=Ae$3.Clone(Di.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=te$4.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){te$4.TransformNormalToRef(e,this.getWorldMatrix(),t);}static GetConstructorFromName(e,t,i,s=0,r=true){const n=be$3.Construct(e,t,i,{interaxial_distance:s,isStereoscopicSideBySide:r});return n||(()=>Di._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,s=Di.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),r=Ae$3.Parse(s,e,t);if(void 0!==e.parentId&&(r._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r.inputs&&(r.inputs.parse(e),r._setupInputs()),e.upVector&&(r.upVector=te$4.FromArray(e.upVector)),r.setPosition&&(r.position.copyFromFloats(0,0,0),r.setPosition(te$4.FromArray(e.position))),e.target&&r.setTarget&&r.setTarget(te$4.FromArray(e.target)),e.cameraRigMode){const t=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};r.setCameraRigMode(e.cameraRigMode,t);}if(e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],s=O$g("BABYLON.Animation");s&&r.animations.push(s.Parse(i));}be$3.ParseAnimationRanges(r,e,t);}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&r.setEnabled(e.isEnabled),r}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}Di._CreateDefaultParsedCamera=(e,t)=>{throw le$4("UniversalCamera")},Di.PERSPECTIVE_CAMERA=Qe$1.PERSPECTIVE_CAMERA,Di.ORTHOGRAPHIC_CAMERA=Qe$1.ORTHOGRAPHIC_CAMERA,Di.FOVMODE_VERTICAL_FIXED=Qe$1.FOVMODE_VERTICAL_FIXED,Di.FOVMODE_HORIZONTAL_FIXED=Qe$1.FOVMODE_HORIZONTAL_FIXED,Di.RIG_MODE_NONE=Qe$1.RIG_MODE_NONE,Di.RIG_MODE_STEREOSCOPIC_ANAGLYPH=Qe$1.RIG_MODE_STEREOSCOPIC_ANAGLYPH,Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=Qe$1.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL,Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=Qe$1.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,Di.RIG_MODE_STEREOSCOPIC_OVERUNDER=Qe$1.RIG_MODE_STEREOSCOPIC_OVERUNDER,Di.RIG_MODE_STEREOSCOPIC_INTERLACED=Qe$1.RIG_MODE_STEREOSCOPIC_INTERLACED,Di.RIG_MODE_VR=Qe$1.RIG_MODE_VR,Di.RIG_MODE_CUSTOM=Qe$1.RIG_MODE_CUSTOM,Di.ForceAttachControlToAlwaysPreventDefault=false,e$z([u$s("position")],Di.prototype,"_position",void 0),e$z([u$s("upVector")],Di.prototype,"_upVector",void 0),e$z([a$$()],Di.prototype,"orthoLeft",null),e$z([a$$()],Di.prototype,"orthoRight",null),e$z([a$$()],Di.prototype,"orthoBottom",null),e$z([a$$()],Di.prototype,"orthoTop",null),e$z([a$$()],Di.prototype,"fov",void 0),e$z([a$$()],Di.prototype,"projectionPlaneTilt",void 0),e$z([a$$()],Di.prototype,"minZ",void 0),e$z([a$$()],Di.prototype,"maxZ",void 0),e$z([a$$()],Di.prototype,"inertia",void 0),e$z([a$$()],Di.prototype,"mode",null),e$z([a$$()],Di.prototype,"layerMask",void 0),e$z([a$$()],Di.prototype,"fovMode",void 0),e$z([a$$()],Di.prototype,"cameraRigMode",void 0),e$z([a$$()],Di.prototype,"interaxialDistance",void 0),e$z([a$$()],Di.prototype,"isStereoscopicSideBySide",void 0);class Li{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=false,this.uniqueId=Li._Counter++;}}function Fi(e,t,i,s){switch(t){case Qe$1.BYTE:{let t=e.getInt8(i);return s&&(t=Math.max(t/127,-1)),t}case Qe$1.UNSIGNED_BYTE:{let t=e.getUint8(i);return s&&(t/=255),t}case Qe$1.SHORT:{let t=e.getInt16(i,true);return s&&(t=Math.max(t/32767,-1)),t}case Qe$1.UNSIGNED_SHORT:{let t=e.getUint16(i,true);return s&&(t/=65535),t}case Qe$1.INT:return e.getInt32(i,true);case Qe$1.UNSIGNED_INT:return e.getUint32(i,true);case Qe$1.FLOAT:return e.getFloat32(i,true);default:throw new Error(`Invalid component type ${t}`)}}function wi(e,t,i,s,r){switch(t){case Qe$1.BYTE:s&&(r=Math.round(127*r)),e.setInt8(i,r);break;case Qe$1.UNSIGNED_BYTE:s&&(r=Math.round(255*r)),e.setUint8(i,r);break;case Qe$1.SHORT:s&&(r=Math.round(32767*r)),e.setInt16(i,r,true);break;case Qe$1.UNSIGNED_SHORT:s&&(r=Math.round(65535*r)),e.setUint16(i,r,true);break;case Qe$1.INT:e.setInt32(i,r,true);break;case Qe$1.UNSIGNED_INT:e.setUint32(i,r,true);break;case Qe$1.FLOAT:e.setFloat32(i,r,true);break;default:throw new Error(`Invalid component type ${t}`)}}function Ni(e){switch(e){case Qe$1.BYTE:case Qe$1.UNSIGNED_BYTE:return 1;case Qe$1.SHORT:case Qe$1.UNSIGNED_SHORT:return 2;case Qe$1.INT:case Qe$1.UNSIGNED_INT:case Qe$1.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}function Bi(e){switch(e){case Qe$1.BYTE:return Int8Array;case Qe$1.UNSIGNED_BYTE:return Uint8Array;case Qe$1.SHORT:return Int16Array;case Qe$1.UNSIGNED_SHORT:return Uint16Array;case Qe$1.INT:return Int32Array;case Qe$1.UNSIGNED_INT:return Uint32Array;case Qe$1.FLOAT:return Float32Array;default:throw new Error(`Invalid component type '${e}'`)}}function Ui(e,t,i,s,r,n,a,o){const h=new Array(s),l=new Array(s);if(e instanceof Array){let r=t/4;const a=i/4;for(let t=0;t<n;t+=s){for(let t=0;t<s;t++)h[t]=l[t]=e[r+t];o(l,t);for(let t=0;t<s;t++)h[t]!==l[t]&&(e[r+t]=l[t]);r+=a;}}else {const c=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),u=Ni(r);for(let e=0;e<n;e+=s){for(let e=0,i=t;e<s;e++,i+=u)h[e]=l[e]=Fi(c,r,i,a);o(l,e);for(let e=0,i=t;e<s;e++,i+=u)h[e]!==l[e]&&wi(c,r,i,a,l[e]);t+=i;}}}function ki(e,t,i,s,r,n,a,o){const h=t*Ni(i),l=a*t;if(i!==Qe$1.FLOAT||r!==h){const a=new Float32Array(l);return Ui(e,s,r,t,i,l,n,((e,i)=>{for(let s=0;s<t;s++)a[i+s]=e[s];})),a}if(!(e instanceof Array||e instanceof Float32Array)||0!==s||e.length!==l){if(e instanceof Array){const t=s/4;return e.slice(t,t+l)}if(e instanceof ArrayBuffer)return new Float32Array(e,s,l);{const t=e.byteOffset+s;return 3&t&&(Ie$2.Warn("Float array must be aligned to 4-bytes border"),o=true),o?new Float32Array(e.buffer.slice(t,t+l*Float32Array.BYTES_PER_ELEMENT)):new Float32Array(e.buffer,t,l)}}return o?e.slice():e}function Gi(e,t,i,s,r,n,a){const o=Ni(i),h=Bi(i),l=n*t;if(Array.isArray(e)){if(3&s||3&r)throw new Error("byteOffset and byteStride must be a multiple of 4 for number[] data.");const a=s/4,o=r/4;if(a+(n-1)*o+t>e.length)throw new Error("Last accessed index is out of bounds.");if(o<t)throw new Error("Data stride cannot be smaller than the component size.");if(o!==t){const n=new h(l);return Ui(e,s,r,t,i,l,false,((e,i)=>{for(let s=0;s<t;s++)n[i+s]=e[s];})),n}return new h(e.slice(a,a+l))}let c,u=s;e instanceof ArrayBuffer?c=e:(c=e.buffer,u+=e.byteOffset);if(u+(n-1)*r+t*o>c.byteLength)throw new Error("Last accessed byte is out of bounds.");const d=t*o;if(r<d)throw new Error("Byte stride cannot be smaller than the component's byte size.");if(r!==d){const e=new h(l);return Ui(c,u,r,t,i,l,false,((i,s)=>{for(let r=0;r<t;r++)e[s+r]=i[r];})),e}return 1!==o&&u&o-1&&(Ie$2.Warn("Array must be aligned to border of element size. Data will be copied."),a=true),a?new h(c.slice(u,u+l*o)):new h(c,u,l)}Li._Counter=0;class Vi{get isDisposed(){return this._isDisposed}constructor(e,t,i,s=0,r=false,n=false,a=false,o,h){this._isAlreadyOwned=false,this._isDisposed=false,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=n,this._divisor=o||1,this._label=h,t instanceof Li?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=a?s:s*Float32Array.BYTES_PER_ELEMENT,r||this.create();}createVertexBuffer(e,t,i,s,r,n=false,a){const o=n?t:t*Float32Array.BYTES_PER_ELEMENT,h=s?n?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new Hi(this._engine,this,e,this._updatable,true,h,void 0===r?this._instanced:r,o,i,void 0,void 0,true,this._divisor||a)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label));}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else {if(!this._buffer)return;if(this._buffer.capacity>0)return void(this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label));Ie$2.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null;}}update(e){this.create(e);}updateDirectly(e,t,i,s=false){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,s?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),this._data=0===t&&void 0===i?e:null);}_increaseReferences(){this._buffer&&(this._isAlreadyOwned?this._buffer.references++:this._isAlreadyOwned=true);}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=true,this._data=null,this._buffer=null);}}class Hi{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=0!=e;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode());}get _maxVerticesCount(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,s,r,n,a,o,h,l,c=false,u=false,d=1,_=false){this._isDisposed=false;let f=false;if(this.engine=e,"object"==typeof s&&null!==s?(f=s.updatable??false,r=s.postponeInternalCreation,n=s.stride,a=s.instanced,o=s.offset,h=s.size,l=s.type,c=s.normalized??false,u=s.useBytes??false,d=s.divisor??1,_=s.takeBufferOwnership??false,this._label=s.label):f=!!s,t instanceof Vi?(this._buffer=t,this._ownsBuffer=_):(this._buffer=new Vi(e,t,f,n,r,a,u,d,this._label),this._ownsBuffer=true),this.uniqueId=Hi._Counter++,this._kind=i,void 0===l){const e=this.getData();this.type=e?Hi.GetDataType(e):Hi.FLOAT;}else this.type=l;const p=Ni(this.type);u?(this._size=h||(n?n/p:Hi.DeduceStride(i)),this.byteStride=n||this._buffer.byteStride||this._size*p,this.byteOffset=o||0):(this._size=h||n||Hi.DeduceStride(i),this.byteStride=n?n*p:this._buffer.byteStride||this._size*p,this.byteOffset=(o||0)*p),this.normalized=c,this._instanced=void 0!==a&&a,this._instanceDivisor=a?d:0,this._alignBuffer(),this._computeHashCode();}_computeHashCode(){this.hashCode=(this.type-5120|0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12);}_rebuild(){this._buffer?._rebuild();}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();return i?ki(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Ni(this.type)}getOffset(){return this.byteOffset/Ni(this.type)}getSize(e=false){return e?this._size*Ni(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer();}update(e){this._buffer.update(e),this._alignBuffer();}updateDirectly(e,t,i=false){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer();}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=true;}forEach(e,t){Ui(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,((e,i)=>{for(let s=0;s<this._size;s++)t(e[s],i+s);}));}_alignBuffer(){}static DeduceStride(e){switch(e){case Hi.UVKind:case Hi.UV2Kind:case Hi.UV3Kind:case Hi.UV4Kind:case Hi.UV5Kind:case Hi.UV6Kind:return 2;case Hi.NormalKind:case Hi.PositionKind:return 3;case Hi.ColorKind:case Hi.ColorInstanceKind:case Hi.MatricesIndicesKind:case Hi.MatricesIndicesExtraKind:case Hi.MatricesWeightsKind:case Hi.MatricesWeightsExtraKind:case Hi.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?Hi.BYTE:e instanceof Uint8Array?Hi.UNSIGNED_BYTE:e instanceof Int16Array?Hi.SHORT:e instanceof Uint16Array?Hi.UNSIGNED_SHORT:e instanceof Int32Array?Hi.INT:e instanceof Uint32Array?Hi.UNSIGNED_INT:Hi.FLOAT}static GetTypeByteLength(e){return Ni(e)}static ForEach(e,t,i,s,r,n,a,o){Ui(e,t,i,s,r,n,a,((e,t)=>{for(let i=0;i<s;i++)o(e[i],t+i);}));}static GetFloatData(e,t,i,s,r,n,a,o){return ki(e,t,i,s,r,n,a,o)}}Hi._Counter=0,Hi.BYTE=Qe$1.BYTE,Hi.UNSIGNED_BYTE=Qe$1.UNSIGNED_BYTE,Hi.SHORT=Qe$1.SHORT,Hi.UNSIGNED_SHORT=Qe$1.UNSIGNED_SHORT,Hi.INT=Qe$1.INT,Hi.UNSIGNED_INT=Qe$1.UNSIGNED_INT,Hi.FLOAT=Qe$1.FLOAT,Hi.PositionKind=Qe$1.PositionKind,Hi.NormalKind=Qe$1.NormalKind,Hi.TangentKind=Qe$1.TangentKind,Hi.UVKind=Qe$1.UVKind,Hi.UV2Kind=Qe$1.UV2Kind,Hi.UV3Kind=Qe$1.UV3Kind,Hi.UV4Kind=Qe$1.UV4Kind,Hi.UV5Kind=Qe$1.UV5Kind,Hi.UV6Kind=Qe$1.UV6Kind,Hi.ColorKind=Qe$1.ColorKind,Hi.ColorInstanceKind=Qe$1.ColorInstanceKind,Hi.MatricesIndicesKind=Qe$1.MatricesIndicesKind,Hi.MatricesWeightsKind=Qe$1.MatricesWeightsKind,Hi.MatricesIndicesExtraKind=Qe$1.MatricesIndicesExtraKind,Hi.MatricesWeightsExtraKind=Qe$1.MatricesWeightsExtraKind;class zi{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0,this._internalSubMeshId=0;}}class Xi{constructor(e,t,i){this.vectors=M$d(8,te$4.Zero),this.center=te$4.Zero(),this.centerWorld=te$4.Zero(),this.extendSize=te$4.Zero(),this.extendSizeWorld=te$4.Zero(),this.directions=M$d(3,te$4.Zero),this.vectorsWorld=M$d(8,te$4.Zero),this.minimumWorld=te$4.Zero(),this.maximumWorld=te$4.Zero(),this.minimum=te$4.Zero(),this.maximum=te$4.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i);}reConstruct(e,t,i){const s=e.x,r=e.y,n=e.z,a=t.x,o=t.y,h=t.z,l=this.vectors;this.minimum.copyFromFloats(s,r,n),this.maximum.copyFromFloats(a,o,h),l[0].copyFromFloats(s,r,n),l[1].copyFromFloats(a,o,h),l[2].copyFromFloats(a,r,n),l[3].copyFromFloats(s,o,n),l[4].copyFromFloats(s,r,h),l[5].copyFromFloats(a,o,n),l[6].copyFromFloats(s,o,h),l[7].copyFromFloats(a,r,h),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||re$5.IdentityReadOnly,this._update(this._worldMatrix);}scale(e){const t=Xi._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),s=i.length();i.normalizeFromLength(s);const r=s*e,n=i.scaleInPlace(.5*r),a=this.center.subtractToRef(n,t[1]),o=this.center.addToRef(n,t[2]);return this.reConstruct(a,o,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,s=this.directions,r=this.vectorsWorld,n=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let e=0;e<8;++e)r[e].copyFrom(n[e]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center);}else {t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let s=0;s<8;++s){const a=r[s];te$4.TransformCoordinatesToRef(n[s],e,a),t.minimizeInPlace(a),i.maximizeInPlace(a);}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5);}te$4.FromArrayToRef(e.m,0,s[0]),te$4.FromArrayToRef(e.m,4,s[1]),te$4.FromArrayToRef(e.m,8,s[2]),this._worldMatrix=e;}isInFrustum(e){return Xi.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return Xi.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,s=t.x,r=t.y,n=t.z,a=i.x,o=i.y,h=i.z,l=e.x,c=e.y,u=e.z,d=-1e-3;return !(a-l<d||d>l-s)&&(!(o-c<d||d>c-r)&&!(h-u<d||d>u-n))}intersectsSphere(e){return Xi.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,s=this.maximumWorld,r=i.x,n=i.y,a=i.z,o=s.x,h=s.y,l=s.z,c=e.x,u=e.y,d=e.z,_=t.x,f=t.y,p=t.z;return !(o<c||r>_)&&(!(h<u||n>f)&&!(l<d||a>p))}dispose(){this._drawWrapperFront?.dispose(),this._drawWrapperBack?.dispose();}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,s){const r=Xi._TmpVector3[0];te$4.ClampToRef(i,e,t,r);return te$4.DistanceSquared(i,r)<=s*s}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const s=t[i];for(let t=0;t<8;++t)if(s.dotCoordinate(e[t])<0)return  false}return  true}static IsInFrustum(e,t){for(let i=0;i<6;++i){let s=true;const r=t[i];for(let t=0;t<8;++t)if(r.dotCoordinate(e[t])>=0){s=false;break}if(s)return  false}return  true}}Xi._TmpVector3=M$d(3,te$4.Zero);class Wi{constructor(e,t,i){this.center=te$4.Zero(),this.centerWorld=te$4.Zero(),this.minimum=te$4.Zero(),this.maximum=te$4.Zero(),this.reConstruct(e,t,i);}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const s=te$4.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=.5*s,this._update(i||re$5.IdentityReadOnly);}scale(e){const t=this.radius*e,i=Wi._TmpVector3,s=i[0].setAll(t),r=this.center.subtractToRef(s,i[1]),n=this.center.addToRef(s,i[2]);return this.reConstruct(r,n,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else {te$4.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=Wi._TmpVector3[0];te$4.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius;}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let s=0;s<6;s++)if(e[s].dotCoordinate(t)<=-i)return  false;return  true}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return  false;return  true}intersectsPoint(e){const t=te$4.DistanceSquared(this.centerWorld,e);return !(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=te$4.DistanceSquared(e.centerWorld,t.centerWorld),s=e.radiusWorld+t.radiusWorld;return !(s*s<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const s=new Wi(this._TmpVector3[0],this._TmpVector3[2]);return s._worldMatrix=i||re$5.Identity(),s}}Wi._TmpVector3=M$d(3,te$4.Zero);const Yi={min:0,max:0},Ki={min:0,max:0},ji=(e,t,i)=>{const s=te$4.Dot(t.centerWorld,e),r=Math.abs(te$4.Dot(t.directions[0],e))*t.extendSize.x+Math.abs(te$4.Dot(t.directions[1],e))*t.extendSize.y+Math.abs(te$4.Dot(t.directions[2],e))*t.extendSize.z;i.min=s-r,i.max=s+r;},Qi=(e,t,i)=>(ji(e,t,Yi),ji(e,i,Ki),!(Yi.min>Ki.max||Ki.min>Yi.max));class qi{constructor(e,t,i){this._isLocked=false,this.boundingBox=new Xi(e,t,i),this.boundingSphere=new Wi(e,t,i);}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i);}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e;}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e));}centerOn(e,t){const i=qi._TmpVector3[0].copyFrom(e).subtractInPlace(t),s=qi._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=te$4.Minimize(this.minimum,e),i=te$4.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=ae$5.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=ae$5.Vector3[0];return te$4.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),te$4.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=Qe$1.MESHES_CULLINGSTRATEGY_STANDARD){if((t===Qe$1.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION||t===Qe$1.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY)&&this.boundingSphere.isCenterInFrustum(e))return  true;if(!this.boundingSphere.isInFrustum(e))return  false;return !(t!==Qe$1.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY&&t!==Qe$1.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY)||this.boundingBox.isInFrustum(e)}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,qi._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return !!this.boundingSphere.centerWorld&&(!!this.boundingSphere.intersectsPoint(e)&&!!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!Wi.Intersects(this.boundingSphere,e.boundingSphere))return  false;if(!Xi.Intersects(this.boundingBox,e.boundingBox))return  false;if(!t)return  true;const i=this.boundingBox,s=e.boundingBox;return !!Qi(i.directions[0],i,s)&&(!!Qi(i.directions[1],i,s)&&(!!Qi(i.directions[2],i,s)&&(!!Qi(s.directions[0],i,s)&&(!!Qi(s.directions[1],i,s)&&(!!Qi(s.directions[2],i,s)&&(!!Qi(te$4.Cross(i.directions[0],s.directions[0]),i,s)&&(!!Qi(te$4.Cross(i.directions[0],s.directions[1]),i,s)&&(!!Qi(te$4.Cross(i.directions[0],s.directions[2]),i,s)&&(!!Qi(te$4.Cross(i.directions[1],s.directions[0]),i,s)&&(!!Qi(te$4.Cross(i.directions[1],s.directions[1]),i,s)&&(!!Qi(te$4.Cross(i.directions[1],s.directions[2]),i,s)&&(!!Qi(te$4.Cross(i.directions[2],s.directions[0]),i,s)&&(!!Qi(te$4.Cross(i.directions[2],s.directions[1]),i,s)&&!!Qi(te$4.Cross(i.directions[2],s.directions[2]),i,s))))))))))))))}}qi._TmpVector3=M$d(2,te$4.Zero);class Zi{static extractMinAndMaxIndexed(e,t,i,s,r,n){for(let a=i;a<i+s;a++){const i=3*t[a],s=e[i],o=e[i+1],h=e[i+2];r.minimizeInPlaceFromFloats(s,o,h),n.maximizeInPlaceFromFloats(s,o,h);}}static extractMinAndMax(e,t,i,s,r,n){for(let a=t,o=t*s;a<t+i;a++,o+=s){const t=e[o],i=e[o+1],s=e[o+2];r.minimizeInPlaceFromFloats(t,i,s),n.maximizeInPlaceFromFloats(t,i,s);}}}function Ji(e,t,i,s=null,r){const n=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new te$4(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r||(r=3),Zi.extractMinAndMax(e,t,i,r,n,a),s&&(n.x-=n.x*s.x+s.y,n.y-=n.y*s.x+s.y,n.z-=n.z*s.x+s.y,a.x+=a.x*s.x+s.y,a.y+=a.y*s.x+s.y,a.z+=a.z*s.x+s.y),{minimum:n,maximum:a}}e$z([g$j.filter(((...[e,t])=>!Array.isArray(e)&&!Array.isArray(t)))],Zi,"extractMinAndMaxIndexed",null),e$z([g$j.filter(((...[e])=>!Array.isArray(e)))],Zi,"extractMinAndMax",null);class $i{static GetEffect(e){return void 0===e.getPipelineContext?e.effect:e}constructor(e,t=true){this._wasPreviouslyReady=false,this._forceRebindOnNextCall=true,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext());}setEffect(e,t,i=true){this.effect=e,void 0!==t&&(this.defines=t),i&&this.drawContext?.reset();}dispose(e=false){if(this.effect){const t=this.effect;e?t.dispose():Et$1.SetImmediate((()=>{t.getEngine().onEndFrameObservable.addOnce((()=>{t.dispose();}));})),this.effect=null;}this.drawContext?.dispose();}}class es{get materialDefines(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:this._getDrawWrapper()?.defines}set materialDefines(e){(this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,true)).defines=e;}_getDrawWrapper(e,t=false){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return !i&&t&&(this._drawWrappers[e]=i=new $i(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=true,i=false){t&&this._drawWrappers[e]?.dispose(i),this._drawWrappers[e]=void 0;}get effect(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:this._getDrawWrapper()?.effect??null}get _drawWrapper(){return this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,true)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e;}setEffect(e,t=null,i,s=true){const r=this._drawWrapper;r.setEffect(e,t,s),void 0!==i&&(r.materialContext=i),e||(r.defines=null,r.materialContext=void 0);}resetDrawCache(e,t=false){if(this._drawWrappers){if(void 0!==e)return void this._removeDrawWrapper(e,true,t);for(const e of this._drawWrappers)e?.dispose(t);}this._drawWrappers=[];}static AddToMesh(e,t,i,s,r,n,a,o=true){return new es(e,t,i,s,r,n,a,o)}constructor(e,t,i,s,r,n,a,o=true,h=true){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=s,this.indexCount=r,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=false,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=n,this._renderingMesh=a||n,h&&n.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=n.subMeshes.length-1,o&&(this.refreshBoundingInfo(),n.computeWorldMatrix(true));}get IsGlobal(){return 0===this.verticesStart&&this.verticesCount===this._mesh.getTotalVertices()&&0===this.indexStart&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){const e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=true){const t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId)??this._renderingMesh.material;if(!t)return e&&this._mesh.getScene()._hasDefaultMaterial?this._mesh.getScene().defaultMaterial:null;if(this._isMultiMaterial(t)){const e=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==e&&(this._currentMaterial=e,this.resetDrawCache()),e}return t}_isMultiMaterial(e){return void 0!==e.getSubMaterial}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(Hi.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(0===this.indexStart&&this.indexCount===t.length){const e=this._renderingMesh.getBoundingInfo();i={minimum:e.minimum.clone(),maximum:e.maximum.clone()};}else i=function(e,t,i,s,r=null){const n=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new te$4(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return Zi.extractMinAndMaxIndexed(e,t,i,s,n,a),r&&(n.x-=n.x*r.x+r.y,n.y-=n.y*r.x+r.y,n.z-=n.z*r.x+r.y,a.x+=a.x*r.x+r.y,a.y+=a.y*r.x+r.y,a.z+=a.z*r.x+r.y),{minimum:n,maximum:a}}(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new qi(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return !!t&&t.isInFrustum(e,this._mesh.cullingStrategy)}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return !!t&&t.isCompletelyInFrustum(e)}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=6*Math.floor(this.indexCount/3),s=this.verticesStart+this.verticesCount>65535?new Uint32Array(i):new Uint16Array(i);let r=0;if(0===e.length)for(let e=this.indexStart;e<this.indexStart+this.indexCount;e+=3)s[r++]=e,s[r++]=e+1,s[r++]=e+1,s[r++]=e+2,s[r++]=e+2,s[r++]=e;else for(let t=this.indexStart;t<this.indexStart+this.indexCount;t+=3)s[r++]=e[t],s[r++]=e[t+1],s[r++]=e[t+1],s[r++]=e[t+2],s[r++]=e[t+2],s[r++]=e[t];this._linesIndexBuffer=t.createIndexBuffer(s),this._linesIndexCount=s.length;}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return !!t&&e.intersectsBox(t.boundingBox)}intersects(e,t,i,s,r){const n=this.getMaterial();if(!n)return null;let a=3,o=false;switch(n.fillMode){case Qe$1.MATERIAL_PointListDrawMode:case Qe$1.MATERIAL_LineLoopDrawMode:case Qe$1.MATERIAL_LineStripDrawMode:case Qe$1.MATERIAL_TriangleFanDrawMode:return null;case Qe$1.MATERIAL_TriangleStripDrawMode:a=1,o=true;}return n.fillMode===Qe$1.MATERIAL_LineListDrawMode?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,s):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,s):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,s,r):this._intersectTriangles(e,t,i,a,o,s,r)}_intersectLines(e,t,i,s,r){let n=null;for(let a=this.indexStart;a<this.indexStart+this.indexCount;a+=2){const o=t[i[a]],h=t[i[a+1]],l=e.intersectionSegment(o,h,s);if(!(l<0)&&((r||!n||l<n.distance)&&(n=new zi(null,null,l),n.faceId=a/2,r)))break}return n}_intersectUnIndexedLines(e,t,i,s,r){let n=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=2){const a=t[i],o=t[i+1],h=e.intersectionSegment(a,o,s);if(!(h<0)&&((r||!n||h<n.distance)&&(n=new zi(null,null,h),n.faceId=i/2,r)))break}return n}_intersectTriangles(e,t,i,s,r,n,a){let o=null,h=-1;for(let l=this.indexStart;l<this.indexStart+this.indexCount-(3-s);l+=s){h++;const s=i[l],c=i[l+1],u=i[l+2];if(r&&4294967295===u){l+=2;continue}const d=t[s],_=t[c],f=t[u];if(!d||!_||!f)continue;if(a&&!a(d,_,f,e,s,c,u))continue;const p=e.intersectsTriangle(d,_,f);if(p){if(p.distance<0)continue;if((n||!o||p.distance<o.distance)&&(o=p,o.faceId=h,n))break}}return o}_intersectUnIndexedTriangles(e,t,i,s,r){let n=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){const a=t[i],o=t[i+1],h=t[i+2];if(r&&!r(a,o,h,e,-1,-1,-1))continue;const l=e.intersectsTriangle(a,o,h);if(l){if(l.distance<0)continue;if((s||!n||l.distance<n.distance)&&(n=l,n.faceId=i/3,s))break}}return n}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null);}clone(e,t){const i=new es(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,false);if(!this.IsGlobal){const e=this.getBoundingInfo();if(!e)return i;i._boundingInfo=new qi(e.minimum,e.maximum);}return i}dispose(e=false){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1),this.resetDrawCache(void 0,e);}getClassName(){return "SubMesh"}static CreateFromIndices(e,t,i,s,r,n=true){let a=Number.MAX_VALUE,o=-Number.MAX_VALUE;const h=(r||s).getIndices();for(let e=t;e<t+i;e++){const t=h[e];t<a&&(a=t),t>o&&(o=t);}return new es(e,a,o-a+1,t,i,s,r,n)}}class ts{}class is{constructor(){var e;this.uniqueId=0,this.metadata={},this._applyTo=(e=this._applyToCoroutine.bind(this),(...t)=>Mi(e(...t))),this.uniqueId=is._UniqueIdGenerator,is._UniqueIdGenerator++;}set(e,t){switch(e.length||Ie$2.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case Hi.PositionKind:this.positions=e;break;case Hi.NormalKind:this.normals=e;break;case Hi.TangentKind:this.tangents=e;break;case Hi.UVKind:this.uvs=e;break;case Hi.UV2Kind:this.uvs2=e;break;case Hi.UV3Kind:this.uvs3=e;break;case Hi.UV4Kind:this.uvs4=e;break;case Hi.UV5Kind:this.uvs5=e;break;case Hi.UV6Kind:this.uvs6=e;break;case Hi.ColorKind:this.colors=e;break;case Hi.MatricesIndicesKind:this.matricesIndices=e;break;case Hi.MatricesWeightsKind:this.matricesWeights=e;break;case Hi.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case Hi.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;}}applyToMesh(e,t){return this._applyTo(e,t,false),this}applyToGeometry(e,t){return this._applyTo(e,t,false),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=false,i){if(this.positions&&(e.setVerticesData(Hi.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(Hi.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(Hi.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(Hi.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(Hi.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(Hi.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(Hi.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(Hi.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(Hi.UV6Kind,this.uvs6,t),i&&(yield)),this.colors){const s=this.positions&&this.colors.length===this.positions.length?3:4;e.setVerticesData(Hi.ColorKind,this.colors,t,s),this.hasVertexAlpha&&void 0!==e.hasVertexAlpha&&(e.hasVertexAlpha=true),i&&(yield);}if(this.matricesIndices&&(e.setVerticesData(Hi.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(Hi.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(Hi.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(Hi.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){const t=e;t.subMeshes=[];for(const e of this.materialInfos)new es(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,t);}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(Hi.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(Hi.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(Hi.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(Hi.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(Hi.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(Hi.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(Hi.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(Hi.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(Hi.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(Hi.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(Hi.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(Hi.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(Hi.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(Hi.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,s=e.length){const r=ae$5.Vector3[0],n=ae$5.Vector3[1];for(let a=i;a<i+s;a+=3)te$4.FromArrayToRef(e,a,r),te$4.TransformCoordinatesToRef(r,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z;}static _TransformVector3Normals(e,t,i=0,s=e.length){const r=ae$5.Vector3[0],n=ae$5.Vector3[1];for(let a=i;a<i+s;a+=3)te$4.FromArrayToRef(e,a,r),te$4.TransformNormalToRef(r,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z;}static _TransformVector4Normals(e,t,i=0,s=e.length){const r=ae$5.Vector4[0],n=ae$5.Vector4[1];for(let a=i;a<i+s;a+=4)ie$5.FromArrayToRef(e,a,r),ie$5.TransformNormalToRef(r,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z,e[a+3]=n.w;}static _FlipFaces(e,t=0,i=e.length){for(let s=t;s<t+i;s+=3){const t=e[s+1];e[s+1]=e[s+2],e[s+2]=t;}}transform(e){const t=e.determinant()<0;return this.positions&&is._TransformVector3Coordinates(this.positions,e),this.normals&&is._TransformVector3Normals(this.normals,e),this.tangents&&is._TransformVector4Normals(this.tangents,e),t&&this.indices&&is._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return [this];const e=[];for(const t of this.materialInfos){const i=new is;if(this.positions&&(i.positions=this.positions.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.normals&&(i.normals=this.normals.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.tangents&&(i.tangents=this.tangents.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.colors&&(i.colors=this.colors.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.uvs&&(i.uvs=this.uvs.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs2&&(i.uvs2=this.uvs2.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs3&&(i.uvs3=this.uvs3.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs4&&(i.uvs4=this.uvs4.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs5&&(i.uvs5=this.uvs5.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs6&&(i.uvs6=this.uvs6.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.indices){i.indices=[];for(let e=t.indexStart;e<t.indexStart+t.indexCount;e++)i.indices.push(this.indices[e]-t.verticesStart);}const s=new ts;s.indexStart=0,s.indexCount=i.indices?i.indices.length:0,s.materialIndex=t.materialIndex,s.verticesStart=0,s.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[s],e.push(i);}return e}merge(e,t=false,i=false,s=false,r=false){const n=Array.isArray(e)?e.map((e=>({vertexData:e}))):[{vertexData:e}];return Mi(this._mergeCoroutine(void 0,n,t,false,i,s,r))}*_mergeCoroutine(e,t,i=false,s,r,n=false,a=false){this._validate();let o=t.map((e=>e.vertexData)),h=this;if(a)for(const e of o)e&&(e._validate(),!this.normals&&e.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&e.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&e.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&e.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&e.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&e.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&e.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&e.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&e.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&e.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&e.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&e.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&e.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(const e of o)if(e)if(a)this.normals&&!e.normals&&(e.normals=new Float32Array(e.positions.length)),this.tangents&&!e.tangents&&(e.tangents=new Float32Array(e.positions.length/3*4)),this.uvs&&!e.uvs&&(e.uvs=new Float32Array(e.positions.length/3*2)),this.uvs2&&!e.uvs2&&(e.uvs2=new Float32Array(e.positions.length/3*2)),this.uvs3&&!e.uvs3&&(e.uvs3=new Float32Array(e.positions.length/3*2)),this.uvs4&&!e.uvs4&&(e.uvs4=new Float32Array(e.positions.length/3*2)),this.uvs5&&!e.uvs5&&(e.uvs5=new Float32Array(e.positions.length/3*2)),this.uvs6&&!e.uvs6&&(e.uvs6=new Float32Array(e.positions.length/3*2)),this.colors&&!e.colors&&(e.colors=new Float32Array(e.positions.length/3*4),e.colors.fill(1)),this.matricesIndices&&!e.matricesIndices&&(e.matricesIndices=new Float32Array(e.positions.length/3*4)),this.matricesWeights&&!e.matricesWeights&&(e.matricesWeights=new Float32Array(e.positions.length/3*4)),this.matricesIndicesExtra&&!e.matricesIndicesExtra&&(e.matricesIndicesExtra=new Float32Array(e.positions.length/3*4)),this.matricesWeightsExtra&&!e.matricesWeightsExtra&&(e.matricesWeightsExtra=new Float32Array(e.positions.length/3*4));else if(e._validate(),!this.normals!=!e.normals||!this.tangents!=!e.tangents||!this.uvs!=!e.uvs||!this.uvs2!=!e.uvs2||!this.uvs3!=!e.uvs3||!this.uvs4!=!e.uvs4||!this.uvs5!=!e.uvs5||!this.uvs6!=!e.uvs6||!this.colors!=!e.colors||!this.matricesIndices!=!e.matricesIndices||!this.matricesWeights!=!e.matricesWeights||!this.matricesIndicesExtra!=!e.matricesIndicesExtra||!this.matricesWeightsExtra!=!e.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");if(n){let i=0,s=0,r=0;const n=[];let a=null;const l=[];for(const t of this.splitBasedOnMaterialID())l.push({vertexData:t,transform:e});for(const e of t)if(e.vertexData)for(const t of e.vertexData.splitBasedOnMaterialID())l.push({vertexData:t,transform:e.transform});l.sort(((e,t)=>{const i=e.vertexData.materialInfos?e.vertexData.materialInfos[0].materialIndex:0,s=t.vertexData.materialInfos?t.vertexData.materialInfos[0].materialIndex:0;return i>s?1:i===s?0:-1}));for(const e of l){const t=e.vertexData;if(i=t.materialInfos?t.materialInfos[0].materialIndex:0,a&&a.materialIndex===i)a.indexCount+=t.indices.length,a.verticesCount+=t.positions.length/3;else {const e=new ts;e.materialIndex=i,e.indexStart=s,e.indexCount=t.indices.length,e.verticesStart=r,e.verticesCount=t.positions.length/3,n.push(e),a=e;}s+=t.indices.length,r+=t.positions.length/3;}const c=l.splice(0,1)[0];h=c.vertexData,e=c.transform,o=l.map((e=>e.vertexData)),t=l,this.materialInfos=n;}const l=o.reduce(((e,t)=>e+(t.indices?.length??0)),h.indices?.length??0);let c=r||o.some((e=>e.indices===h.indices))?h.indices?.slice():h.indices;if(l>0){let r=c?.length??0;if(c||(c=new Array(l)),c.length!==l){if(Array.isArray(c))c.length=l;else {const e=i||c instanceof Uint32Array?new Uint32Array(l):new Uint16Array(l);e.set(c),c=e;}e&&e.determinant()<0&&is._FlipFaces(c,0,r);}let n=h.positions?h.positions.length/3:0;for(const{vertexData:e,transform:i}of t)if(e.indices){for(let t=0;t<e.indices.length;t++)c[r+t]=e.indices[t]+n;i&&i.determinant()<0&&is._FlipFaces(c,r,e.indices.length),n+=e.positions.length/3,r+=e.indices.length,s&&(yield);}}return this.indices=c,this.positions=is._MergeElement(Hi.PositionKind,h.positions,e,t.map((e=>[e.vertexData.positions,e.transform]))),s&&(yield),h.normals&&(this.normals=is._MergeElement(Hi.NormalKind,h.normals,e,t.map((e=>[e.vertexData.normals,e.transform]))),s&&(yield)),h.tangents&&(this.tangents=is._MergeElement(Hi.TangentKind,h.tangents,e,t.map((e=>[e.vertexData.tangents,e.transform]))),s&&(yield)),h.uvs&&(this.uvs=is._MergeElement(Hi.UVKind,h.uvs,e,t.map((e=>[e.vertexData.uvs,e.transform]))),s&&(yield)),h.uvs2&&(this.uvs2=is._MergeElement(Hi.UV2Kind,h.uvs2,e,t.map((e=>[e.vertexData.uvs2,e.transform]))),s&&(yield)),h.uvs3&&(this.uvs3=is._MergeElement(Hi.UV3Kind,h.uvs3,e,t.map((e=>[e.vertexData.uvs3,e.transform]))),s&&(yield)),h.uvs4&&(this.uvs4=is._MergeElement(Hi.UV4Kind,h.uvs4,e,t.map((e=>[e.vertexData.uvs4,e.transform]))),s&&(yield)),h.uvs5&&(this.uvs5=is._MergeElement(Hi.UV5Kind,h.uvs5,e,t.map((e=>[e.vertexData.uvs5,e.transform]))),s&&(yield)),h.uvs6&&(this.uvs6=is._MergeElement(Hi.UV6Kind,h.uvs6,e,t.map((e=>[e.vertexData.uvs6,e.transform]))),s&&(yield)),h.colors&&(this.colors=is._MergeElement(Hi.ColorKind,h.colors,e,t.map((e=>[e.vertexData.colors,e.transform]))),(void 0!==h.hasVertexAlpha||t.some((e=>void 0!==e.vertexData.hasVertexAlpha)))&&(this.hasVertexAlpha=h.hasVertexAlpha||t.some((e=>e.vertexData.hasVertexAlpha))),s&&(yield)),h.matricesIndices&&(this.matricesIndices=is._MergeElement(Hi.MatricesIndicesKind,h.matricesIndices,e,t.map((e=>[e.vertexData.matricesIndices,e.transform]))),s&&(yield)),h.matricesWeights&&(this.matricesWeights=is._MergeElement(Hi.MatricesWeightsKind,h.matricesWeights,e,t.map((e=>[e.vertexData.matricesWeights,e.transform]))),s&&(yield)),h.matricesIndicesExtra&&(this.matricesIndicesExtra=is._MergeElement(Hi.MatricesIndicesExtraKind,h.matricesIndicesExtra,e,t.map((e=>[e.vertexData.matricesIndicesExtra,e.transform]))),s&&(yield)),h.matricesWeightsExtra&&(this.matricesWeightsExtra=is._MergeElement(Hi.MatricesWeightsExtraKind,h.matricesWeightsExtra,e,t.map((e=>[e.vertexData.matricesWeightsExtra,e.transform])))),this}static _MergeElement(e,t,i,s){const r=s.filter((e=>null!==e[0]&&void 0!==e[0]));if(!t&&0==r.length)return t;if(!t)return this._MergeElement(e,r[0][0],r[0][1],r.slice(1));const n=r.reduce(((e,t)=>e+t[0].length),t.length),a=e===Hi.PositionKind?is._TransformVector3Coordinates:e===Hi.NormalKind?is._TransformVector3Normals:e===Hi.TangentKind?is._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const e=new Float32Array(n);e.set(t),i&&a(e,i,0,t.length);let s=t.length;for(const[t,i]of r)e.set(t,s),i&&a(e,i,s,t.length),s+=t.length;return e}{const e=new Array(n);for(let i=0;i<t.length;i++)e[i]=t[i];i&&a(e,i,0,t.length);let s=t.length;for(const[t,i]of r){for(let i=0;i<t.length;i++)e[s+i]=t[i];i&&a(e,i,s,t.length),s+=t.length;}return e}}_validate(){if(!this.positions)throw new we$3("Positions are required",Fe$2.MeshInvalidPositionsError);const e=(e,t)=>{const i=Hi.DeduceStride(e);if(t.length%i!==0)throw new Error("The "+e+"s array count must be a multiple of "+i);return t.length/i},t=e(Hi.PositionKind,this.positions),i=(i,s)=>{const r=e(i,s);if(r!==t)throw new Error("The "+i+"s element count ("+r+") does not match the positions count ("+t+")")};this.normals&&i(Hi.NormalKind,this.normals),this.tangents&&i(Hi.TangentKind,this.tangents),this.uvs&&i(Hi.UVKind,this.uvs),this.uvs2&&i(Hi.UV2Kind,this.uvs2),this.uvs3&&i(Hi.UV3Kind,this.uvs3),this.uvs4&&i(Hi.UV4Kind,this.uvs4),this.uvs5&&i(Hi.UV5Kind,this.uvs5),this.uvs6&&i(Hi.UV6Kind,this.uvs6),this.colors&&i(Hi.ColorKind,this.colors),this.matricesIndices&&i(Hi.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(Hi.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(Hi.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(Hi.MatricesWeightsExtraKind,this.matricesWeightsExtra);}clone(){const e=this.serialize();return is.Parse(e)}serialize(){const e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors),e.hasVertexAlpha=this.hasVertexAlpha),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndicesExpanded=true),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtraExpanded=true),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=this.indices?Array.from(this.indices):[],this.materialInfos){e.materialInfos=[];for(const t of this.materialInfos){const i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i);}}return e}static ExtractFromMesh(e,t,i){return is._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return is._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const s=new is;if(e.isVerticesDataPresent(Hi.PositionKind)&&(s.positions=e.getVerticesData(Hi.PositionKind,t,i)),e.isVerticesDataPresent(Hi.NormalKind)&&(s.normals=e.getVerticesData(Hi.NormalKind,t,i)),e.isVerticesDataPresent(Hi.TangentKind)&&(s.tangents=e.getVerticesData(Hi.TangentKind,t,i)),e.isVerticesDataPresent(Hi.UVKind)&&(s.uvs=e.getVerticesData(Hi.UVKind,t,i)),e.isVerticesDataPresent(Hi.UV2Kind)&&(s.uvs2=e.getVerticesData(Hi.UV2Kind,t,i)),e.isVerticesDataPresent(Hi.UV3Kind)&&(s.uvs3=e.getVerticesData(Hi.UV3Kind,t,i)),e.isVerticesDataPresent(Hi.UV4Kind)&&(s.uvs4=e.getVerticesData(Hi.UV4Kind,t,i)),e.isVerticesDataPresent(Hi.UV5Kind)&&(s.uvs5=e.getVerticesData(Hi.UV5Kind,t,i)),e.isVerticesDataPresent(Hi.UV6Kind)&&(s.uvs6=e.getVerticesData(Hi.UV6Kind,t,i)),e.isVerticesDataPresent(Hi.ColorKind)){const r=e.geometry||e,n=r.getVertexBuffer(Hi.ColorKind),a=r.getVerticesData(Hi.ColorKind,t,i);if(3===n.getSize()){const e=new Float32Array(4*a.length/3);for(let t=0,i=0;t<a.length;t+=3,i+=4)e[i]=a[t],e[i+1]=a[t+1],e[i+2]=a[t+2],e[i+3]=1;s.colors=e;}else {if(4!==n.getSize())throw new Error(`Unexpected number of color components: ${n.getSize()}`);s.colors=a;}}return e.isVerticesDataPresent(Hi.MatricesIndicesKind)&&(s.matricesIndices=e.getVerticesData(Hi.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(Hi.MatricesWeightsKind)&&(s.matricesWeights=e.getVerticesData(Hi.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(Hi.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=e.getVerticesData(Hi.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(Hi.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=e.getVerticesData(Hi.MatricesWeightsExtraKind,t,i)),s.indices=e.getIndices(t,i),s}static CreateRibbon(e){throw le$4("ribbonBuilder")}static CreateBox(e){throw le$4("boxBuilder")}static CreateTiledBox(e){throw le$4("tiledBoxBuilder")}static CreateTiledPlane(e){throw le$4("tiledPlaneBuilder")}static CreateSphere(e){throw le$4("sphereBuilder")}static CreateCylinder(e){throw le$4("cylinderBuilder")}static CreateTorus(e){throw le$4("torusBuilder")}static CreateLineSystem(e){throw le$4("linesBuilder")}static CreateDashedLines(e){throw le$4("linesBuilder")}static CreateGround(e){throw le$4("groundBuilder")}static CreateTiledGround(e){throw le$4("groundBuilder")}static CreateGroundFromHeightMap(e){throw le$4("groundBuilder")}static CreatePlane(e){throw le$4("planeBuilder")}static CreateDisc(e){throw le$4("discBuilder")}static CreatePolygon(e,t,i,s,r,n,a){throw le$4("polygonBuilder")}static CreateIcoSphere(e){throw le$4("icoSphereBuilder")}static CreatePolyhedron(e){throw le$4("polyhedronBuilder")}static CreateCapsule(e={orientation:te$4.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw le$4("capsuleBuilder")}static CreateTorusKnot(e){throw le$4("torusKnotBuilder")}static ComputeNormals(e,t,i,s){let r=0,n=0,a=0,o=0,h=0,l=0,c=0,u=0,d=0,_=0,f=0,p=0,g=0,m=0,T=0,E=0,A=0,R=0,b=0,S=0,x=false,M=false,y=false,I=false,C=1,v=0,P=null;s&&(x=!!s.facetNormals,M=!!s.facetPositions,y=!!s.facetPartitioning,C=true===s.useRightHandedSystem?-1:1,v=s.ratio||0,I=!!s.depthSort,P=s.distanceTo,I&&void 0===P&&(P=te$4.Zero()));let O=0,D=0,L=0,F=0;for(y&&s&&s.bbSize&&(O=s.subDiv.X*v/s.bbSize.x,D=s.subDiv.Y*v/s.bbSize.y,L=s.subDiv.Z*v/s.bbSize.z,F=s.subDiv.max*s.subDiv.max,s.facetPartitioning.length=0),r=0;r<e.length;r++)i[r]=0;const w=t.length/3|0;for(r=0;r<w;r++){if(p=3*t[3*r],g=p+1,m=p+2,T=3*t[3*r+1],E=T+1,A=T+2,R=3*t[3*r+2],b=R+1,S=R+2,n=e[p]-e[T],a=e[g]-e[E],o=e[m]-e[A],h=e[R]-e[T],l=e[b]-e[E],c=e[S]-e[A],u=C*(a*c-o*l),d=C*(o*h-n*c),_=C*(n*l-a*h),f=Math.sqrt(u*u+d*d+_*_),f=0===f?1:f,u/=f,d/=f,_/=f,x&&s&&(s.facetNormals[r].x=u,s.facetNormals[r].y=d,s.facetNormals[r].z=_),M&&s&&(s.facetPositions[r].x=(e[p]+e[T]+e[R])/3,s.facetPositions[r].y=(e[g]+e[E]+e[b])/3,s.facetPositions[r].z=(e[m]+e[A]+e[S])/3),y&&s){const t=Math.floor((s.facetPositions[r].x-s.bInfo.minimum.x*v)*O),i=Math.floor((s.facetPositions[r].y-s.bInfo.minimum.y*v)*D),n=Math.floor((s.facetPositions[r].z-s.bInfo.minimum.z*v)*L),a=Math.floor((e[p]-s.bInfo.minimum.x*v)*O),o=Math.floor((e[g]-s.bInfo.minimum.y*v)*D),h=Math.floor((e[m]-s.bInfo.minimum.z*v)*L),l=Math.floor((e[T]-s.bInfo.minimum.x*v)*O),c=Math.floor((e[E]-s.bInfo.minimum.y*v)*D),u=Math.floor((e[A]-s.bInfo.minimum.z*v)*L),d=Math.floor((e[R]-s.bInfo.minimum.x*v)*O),_=Math.floor((e[b]-s.bInfo.minimum.y*v)*D),f=Math.floor((e[S]-s.bInfo.minimum.z*v)*L),x=a+s.subDiv.max*o+F*h,M=l+s.subDiv.max*c+F*u,y=d+s.subDiv.max*_+F*f,I=t+s.subDiv.max*i+F*n;s.facetPartitioning[I]=s.facetPartitioning[I]?s.facetPartitioning[I]:[],s.facetPartitioning[x]=s.facetPartitioning[x]?s.facetPartitioning[x]:[],s.facetPartitioning[M]=s.facetPartitioning[M]?s.facetPartitioning[M]:[],s.facetPartitioning[y]=s.facetPartitioning[y]?s.facetPartitioning[y]:[],s.facetPartitioning[x].push(r),M!=x&&s.facetPartitioning[M].push(r),y!=M&&y!=x&&s.facetPartitioning[y].push(r),I!=x&&I!=M&&I!=y&&s.facetPartitioning[I].push(r);}if(I&&s&&s.facetPositions){const e=s.depthSortedFacets[r];e.ind=3*r,e.sqDistance=te$4.DistanceSquared(s.facetPositions[r],P);}i[p]+=u,i[g]+=d,i[m]+=_,i[T]+=u,i[E]+=d,i[A]+=_,i[R]+=u,i[b]+=d,i[S]+=_;}for(r=0;r<i.length/3;r++)u=i[3*r],d=i[3*r+1],_=i[3*r+2],f=Math.sqrt(u*u+d*d+_*_),f=0===f?1:f,u/=f,d/=f,_/=f,i[3*r]=u,i[3*r+1]=d,i[3*r+2]=_;}static _ComputeSides(e,t,i,s,r,n,a){const o=i.length,h=s.length;let l,c;switch(e=e||is.DEFAULTSIDE){case is.FRONTSIDE:break;case is.BACKSIDE:for(l=0;l<o;l+=3){const e=i[l];i[l]=i[l+2],i[l+2]=e;}for(c=0;c<h;c++)s[c]=-s[c];break;case is.DOUBLESIDE:{const e=t.length,u=e/3;for(let i=0;i<e;i++)t[e+i]=t[i];for(l=0;l<o;l+=3)i[l+o]=i[l+2]+u,i[l+1+o]=i[l+1]+u,i[l+2+o]=i[l]+u;for(c=0;c<h;c++)s[h+c]=-s[c];const d=r.length;let _=0;for(_=0;_<d;_++)r[_+d]=r[_];for(n=n||new ie$5(0,0,1,1),a=a||new ie$5(0,0,1,1),_=0,l=0;l<d/2;l++)r[_]=n.x+(n.z-n.x)*r[_],r[_+1]=n.y+(n.w-n.y)*r[_+1],r[_+d]=a.x+(a.z-a.x)*r[_+d],r[_+d+1]=a.y+(a.w-a.y)*r[_+d+1],_+=2;break}}}static Parse(e){const t=new is,i=e.positions;i&&t.set(i,Hi.PositionKind);const s=e.normals;s&&t.set(s,Hi.NormalKind);const r=e.tangents;r&&t.set(r,Hi.TangentKind);const n=e.uvs;n&&t.set(n,Hi.UVKind);const a=e.uvs2;a&&t.set(a,Hi.UV2Kind);const o=e.uvs3;o&&t.set(o,Hi.UV3Kind);const h=e.uvs4;h&&t.set(h,Hi.UV4Kind);const l=e.uvs5;l&&t.set(l,Hi.UV5Kind);const c=e.uvs6;c&&t.set(c,Hi.UV6Kind);const u=e.colors;u&&(t.set(me$3.CheckColors4(u,i.length/3),Hi.ColorKind),void 0!==e.hasVertexAlpha&&(t.hasVertexAlpha=e.hasVertexAlpha));const d=e.matricesIndices;d&&t.set(d,Hi.MatricesIndicesKind);const _=e.matricesWeights;_&&t.set(_,Hi.MatricesWeightsKind);const f=e.indices;f&&(t.indices=f);const p=e.materialInfos;if(p){t.materialInfos=[];for(const e of p){const i=new ts;i.indexCount=e.indexCount,i.indexStart=e.indexStart,i.verticesCount=e.verticesCount,i.verticesStart=e.verticesStart,i.materialIndex=e.materialIndex,t.materialInfos.push(i);}}return t}static ImportVertexData(e,t){const i=is.Parse(e);t.setAllVerticesData(i,e.updatable);}}is.FRONTSIDE=0,is.BACKSIDE=1,is.DOUBLESIDE=2,is.DEFAULTSIDE=0,is._UniqueIdGenerator=0,e$z([g$j.filter(((...[e])=>!Array.isArray(e)))],is,"_TransformVector3Coordinates",null),e$z([g$j.filter(((...[e])=>!Array.isArray(e)))],is,"_TransformVector3Normals",null),e$z([g$j.filter(((...[e])=>!Array.isArray(e)))],is,"_TransformVector4Normals",null),e$z([g$j.filter(((...[e])=>!Array.isArray(e)))],is,"_FlipFaces",null);class ss{static get ForceFullSceneLoadingForIncremental(){return ss._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){ss._ForceFullSceneLoadingForIncremental=e;}static get ShowLoadingScreen(){return ss._ShowLoadingScreen}static set ShowLoadingScreen(e){ss._ShowLoadingScreen=e;}static get loggingLevel(){return ss._LoggingLevel}static set loggingLevel(e){ss._LoggingLevel=e;}static get CleanBoneMatrixWeights(){return ss._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){ss._CleanBoneMatrixWeights=e;}}ss._ForceFullSceneLoadingForIncremental=false,ss._ShowLoadingScreen=true,ss._CleanBoneMatrixWeights=false,ss._LoggingLevel=Qe$1.SCENELOADER_NO_LOGGING;class rs{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(true,null);}static CreateGeometryForMesh(e){const t=new rs(rs.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,s=false,r=null){this.delayLoadState=Qe$1.DELAYLOADSTATE_NONE,this._totalVertices=0,this._isDisposed=false,this._extend={minimum:new te$4(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),maximum:new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},this._indexBufferIsUpdatable=false,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=false,this._scene=t||L$7.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=s,i?this.setAllVerticesData(i,s):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),r&&(this.applyToMesh(r),r.computeWorldMatrix(true)));}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===Qe$1.DELAYLOADSTATE_LOADED||this.delayLoadState===Qe$1.DELAYLOADSTATE_NONE}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return  false;return  true}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer"));const e=new Set;for(const t in this._vertexBuffers)e.add(this._vertexBuffers[t].getWrapperBuffer());e.forEach((e=>{e._rebuild();}));}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate();}setVerticesData(e,t,i=false,s){i&&Array.isArray(t)&&(t=new Float32Array(t));const r=new Hi(this._engine,t,e,{updatable:i,postponeInternalCreation:0===this._meshes.length,stride:s,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(r);}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects();}setVerticesBuffer(e,t=null,i=true){const s=e.getKind();this._vertexBuffers[s]&&i&&this._vertexBuffers[s].dispose(),e._buffer&&e._ownsBuffer&&e._buffer._increaseReferences(),this._vertexBuffers[s]=e;const r=this._meshes,n=r.length;if(s===Hi.PositionKind){this._totalVertices=t??e._maxVerticesCount,this._updateExtend(this.useBoundingInfoFromGeometry&&this._boundingInfo?null:e.getFloatData(this._totalVertices)),this._resetPointsArrayCache();const i=this._extend&&this._extend.minimum||new te$4(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s=this._extend&&this._extend.maximum||new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let e=0;e<n;e++){const t=r[e];t.buildBoundingInfo(i,s),t._createGlobalSubMesh(t.isUnIndexed),t.computeWorldMatrix(true),t.synchronizeInstances();}}this._notifyUpdate(s);}updateVerticesDataDirectly(e,t,i,s=false){const r=this.getVertexBuffer(e);r&&(r.updateDirectly(t,i,s),this._notifyUpdate(e));}updateVerticesData(e,t,i=false){const s=this.getVertexBuffer(e);s&&(s.update(t),e===Hi.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e));}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const e=this._meshes;for(const t of e){t.hasBoundingInfo?t.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):t.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const e=t.subMeshes;for(const t of e)t.refreshBoundingInfo();}}}_bind(e,t,i,s){if(!e)return;void 0===t&&(t=this._indexBuffer);const r=this.getVertexBuffers();if(!r)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!s)return void this._engine.bindBuffers(r,t,e,i);const n=s||this._vertexArrayObjects,a=this._engine;n[e.key]||(n[e.key]=a.recordVertexArrayObject(r,t,e,i)),a.bindVertexArrayObject(n[e.key],t);}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const s=this.getVertexBuffer(e);return s?s.getFloatData(this._totalVertices,i||t&&1!==this._meshes.length):null}copyVerticesData(e,t){const i=this.getVertexBuffer(e);if(!i)return;t[e]||=new Float32Array(this._totalVertices*i.getSize());const s=i.getData();s&&function(e,t,i,s,r,n,a,o){const h=t*Ni(i),l=a*t;if(o.length!==l)throw new Error("Output length is not valid");if(i===Qe$1.FLOAT&&r===h)if(e instanceof Array){const t=s/4;o.set(e,t);}else if(e instanceof ArrayBuffer){const t=new Float32Array(e,s,l);o.set(t);}else {const t=e.byteOffset+s;if(3&t)return Ie$2.Warn("Float array must be aligned to 4-bytes border"),void o.set(new Float32Array(e.buffer.slice(t,t+l*Float32Array.BYTES_PER_ELEMENT)));const i=new Float32Array(e.buffer,t,l);o.set(i);}else Ui(e,s,r,t,i,l,n,((e,i)=>{for(let s=0;s<t;s++)o[i+s]=e[s];}));}(s,i.getSize(),i.type,i.byteOffset,i.byteStride,i.normalized,this._totalVertices,t[e]);}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return !!t&&t.isUpdatable()}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=false){if(this._indexBuffer)if(this._indexBufferIsUpdatable){const s=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),s)for(const e of this._meshes)e._createGlobalSubMesh(true);}else this.setIndices(e,null,true);}setIndexBuffer(e,t,i,s=null){this._indices=[],this._indexBufferIsUpdatable=false,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,e.is32Bits=null===s?t>65535:s;for(const e of this._meshes)e._createGlobalSubMesh(true),e.synchronizeInstances();this._notifyUpdate();}setIndices(e,t=null,i=false,s=false){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i,"Geometry_"+this.id+"_IndexBuffer")),null!=t&&(this._totalVertices=t);for(const e of this._meshes)e._createGlobalSubMesh(!s),e.synchronizeInstances();this._notifyUpdate();}getTotalIndices(){return this.isReady()?void 0!==this._totalIndices?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return t||e&&1!==this._meshes.length?i.slice():i}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){e&&this._vertexArrayObjects&&this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key]);}releaseForMesh(e,t){const i=this._meshes,s=i.indexOf(e);-1!==s&&(i.splice(s,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,0===i.length&&t&&this.dispose());}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo);}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else {if(!e&&!(e=this.getVerticesData(Hi.PositionKind)))return;this._extend=Ji(e,0,this._totalVertices,this.boundingBias,3);}}_applyToMesh(e){for(const t in this._vertexBuffers){const i=this._vertexBuffers[t];i._buffer.getBuffer()||i.create(),t===Hi.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());}!this._indexBuffer&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer")),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances();}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const e of this._meshes)e._markSubMeshesAsAttributesDirty();}load(e,t){this.delayLoadState!==Qe$1.DELAYLOADSTATE_LOADING&&(this.isReady()?t&&t():(this.delayLoadState=Qe$1.DELAYLOADSTATE_LOADING,this._queueLoad(e,t)));}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,(i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=Qe$1.DELAYLOADSTATE_LOADED,this._delayInfo=[],e.removePendingData(this);const s=this._meshes,r=s.length;for(let e=0;e<r;e++)this._applyToMesh(s[e]);t&&t();}),void 0,true));}toLeftHanded(){const e=this.getIndices(false);if(null!=e&&e.length>0){for(let t=0;t<e.length;t+=3){const i=e[t+0];e[t+0]=e[t+2],e[t+2]=i;}this.setIndices(e);}const t=this.getVerticesData(Hi.PositionKind,false);if(null!=t&&t.length>0){for(let e=0;e<t.length;e+=3)t[e+2]=-t[e+2];this.setVerticesData(Hi.PositionKind,t,false);}const i=this.getVerticesData(Hi.NormalKind,false);if(null!=i&&i.length>0){for(let e=0;e<i.length;e+=3)i[e+2]=-i[e+2];this.setVerticesData(Hi.NormalKind,i,false);}}_resetPointsArrayCache(){this._positions=null;}_generatePointsArray(){if(this._positions)return  true;const e=this.getVerticesData(Hi.PositionKind);if(!e||0===e.length)return  false;for(let t=3*this._positionsCache.length,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=te$4.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,true}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject();}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const e in this._vertexBuffers)this._vertexBuffers[e].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=Qe$1.DELAYLOADSTATE_NONE,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const e=this._parentContainer.geometries.indexOf(this);e>-1&&this._parentContainer.geometries.splice(e,1),this._parentContainer=null;}this._isDisposed=true;}copy(e){const t=new rs(e,this._scene),i=this.getIndices(void 0,true);i&&t.setIndices(i);let s,r=false;for(s in this._vertexBuffers){const e=this.getVertexBuffer(s),i=e.getData();if(!i)continue;const n=e.isUpdatable(),a=e.getSize(),{type:o,byteOffset:h,byteStride:l,normalized:c}=e;r=r||n;const u=Gi(i,a,o,h,l,this._totalVertices,true),d=new Hi(this._engine,u,s,{updatable:n,useBytes:false,stride:a,size:a,offset:0,type:o,normalized:c,takeBufferOwnership:true});t.setVerticesBuffer(d,this._totalVertices);}for(s in t._updatable=r,t.delayLoadState=this.delayLoadState,t.delayLoadingFile=this.delayLoadingFile,t._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)t._delayInfo=t._delayInfo||[],t._delayInfo.push(s);return t._boundingInfo=new qi(this._extend.minimum,this._extend.maximum),t}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,ue$4&&ue$4.HasTags(this)&&(e.tags=ue$4.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null);}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(Hi.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(Hi.PositionKind)),this.isVertexBufferUpdatable(Hi.PositionKind)&&(e.positionsUpdatable=true)),this.isVerticesDataPresent(Hi.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(Hi.NormalKind)),this.isVertexBufferUpdatable(Hi.NormalKind)&&(e.normalsUpdatable=true)),this.isVerticesDataPresent(Hi.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(Hi.TangentKind)),this.isVertexBufferUpdatable(Hi.TangentKind)&&(e.tangentsUpdatable=true)),this.isVerticesDataPresent(Hi.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(Hi.UVKind)),this.isVertexBufferUpdatable(Hi.UVKind)&&(e.uvsUpdatable=true)),this.isVerticesDataPresent(Hi.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(Hi.UV2Kind)),this.isVertexBufferUpdatable(Hi.UV2Kind)&&(e.uvs2Updatable=true)),this.isVerticesDataPresent(Hi.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(Hi.UV3Kind)),this.isVertexBufferUpdatable(Hi.UV3Kind)&&(e.uvs3Updatable=true)),this.isVerticesDataPresent(Hi.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(Hi.UV4Kind)),this.isVertexBufferUpdatable(Hi.UV4Kind)&&(e.uvs4Updatable=true)),this.isVerticesDataPresent(Hi.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(Hi.UV5Kind)),this.isVertexBufferUpdatable(Hi.UV5Kind)&&(e.uvs5Updatable=true)),this.isVerticesDataPresent(Hi.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(Hi.UV6Kind)),this.isVertexBufferUpdatable(Hi.UV6Kind)&&(e.uvs6Updatable=true)),this.isVerticesDataPresent(Hi.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(Hi.ColorKind)),this.isVertexBufferUpdatable(Hi.ColorKind)&&(e.colorsUpdatable=true)),this.isVerticesDataPresent(Hi.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(Hi.MatricesIndicesKind)),e.matricesIndicesExpanded=true,this.isVertexBufferUpdatable(Hi.MatricesIndicesKind)&&(e.matricesIndicesUpdatable=true)),this.isVerticesDataPresent(Hi.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(Hi.MatricesWeightsKind)),this.isVertexBufferUpdatable(Hi.MatricesWeightsKind)&&(e.matricesWeightsUpdatable=true)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return Ai.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),s=e.geometryUniqueId,r=e.geometryId;if(s||r){const e=s?this._GetGeometryByLoadedUniqueId(s,i):i.getGeometryById(r);e&&e.applyToMesh(t);}else if(e instanceof ArrayBuffer){const i=t._binaryInfo;if(i.positionsAttrDesc&&i.positionsAttrDesc.count>0){const s=new Float32Array(e,i.positionsAttrDesc.offset,i.positionsAttrDesc.count);t.setVerticesData(Hi.PositionKind,s,false);}if(i.normalsAttrDesc&&i.normalsAttrDesc.count>0){const s=new Float32Array(e,i.normalsAttrDesc.offset,i.normalsAttrDesc.count);t.setVerticesData(Hi.NormalKind,s,false);}if(i.tangetsAttrDesc&&i.tangetsAttrDesc.count>0){const s=new Float32Array(e,i.tangetsAttrDesc.offset,i.tangetsAttrDesc.count);t.setVerticesData(Hi.TangentKind,s,false);}if(i.uvsAttrDesc&&i.uvsAttrDesc.count>0){const s=new Float32Array(e,i.uvsAttrDesc.offset,i.uvsAttrDesc.count);t.setVerticesData(Hi.UVKind,s,false);}if(i.uvs2AttrDesc&&i.uvs2AttrDesc.count>0){const s=new Float32Array(e,i.uvs2AttrDesc.offset,i.uvs2AttrDesc.count);t.setVerticesData(Hi.UV2Kind,s,false);}if(i.uvs3AttrDesc&&i.uvs3AttrDesc.count>0){const s=new Float32Array(e,i.uvs3AttrDesc.offset,i.uvs3AttrDesc.count);t.setVerticesData(Hi.UV3Kind,s,false);}if(i.uvs4AttrDesc&&i.uvs4AttrDesc.count>0){const s=new Float32Array(e,i.uvs4AttrDesc.offset,i.uvs4AttrDesc.count);t.setVerticesData(Hi.UV4Kind,s,false);}if(i.uvs5AttrDesc&&i.uvs5AttrDesc.count>0){const s=new Float32Array(e,i.uvs5AttrDesc.offset,i.uvs5AttrDesc.count);t.setVerticesData(Hi.UV5Kind,s,false);}if(i.uvs6AttrDesc&&i.uvs6AttrDesc.count>0){const s=new Float32Array(e,i.uvs6AttrDesc.offset,i.uvs6AttrDesc.count);t.setVerticesData(Hi.UV6Kind,s,false);}if(i.colorsAttrDesc&&i.colorsAttrDesc.count>0){const s=new Float32Array(e,i.colorsAttrDesc.offset,i.colorsAttrDesc.count);t.setVerticesData(Hi.ColorKind,s,false,i.colorsAttrDesc.stride);}if(i.matricesIndicesAttrDesc&&i.matricesIndicesAttrDesc.count>0){const s=new Int32Array(e,i.matricesIndicesAttrDesc.offset,i.matricesIndicesAttrDesc.count),r=[];for(let e=0;e<s.length;e++){const t=s[e];r.push(255&t),r.push((65280&t)>>8),r.push((16711680&t)>>16),r.push(t>>24&255);}t.setVerticesData(Hi.MatricesIndicesKind,r,false);}if(i.matricesIndicesExtraAttrDesc&&i.matricesIndicesExtraAttrDesc.count>0){const s=new Int32Array(e,i.matricesIndicesExtraAttrDesc.offset,i.matricesIndicesExtraAttrDesc.count),r=[];for(let e=0;e<s.length;e++){const t=s[e];r.push(255&t),r.push((65280&t)>>8),r.push((16711680&t)>>16),r.push(t>>24&255);}t.setVerticesData(Hi.MatricesIndicesExtraKind,r,false);}if(i.matricesWeightsAttrDesc&&i.matricesWeightsAttrDesc.count>0){const s=new Float32Array(e,i.matricesWeightsAttrDesc.offset,i.matricesWeightsAttrDesc.count);t.setVerticesData(Hi.MatricesWeightsKind,s,false);}if(i.indicesAttrDesc&&i.indicesAttrDesc.count>0){const s=new Int32Array(e,i.indicesAttrDesc.offset,i.indicesAttrDesc.count);t.setIndices(s,null);}if(i.subMeshesAttrDesc&&i.subMeshesAttrDesc.count>0){const s=new Int32Array(e,i.subMeshesAttrDesc.offset,5*i.subMeshesAttrDesc.count);t.subMeshes=[];for(let e=0;e<i.subMeshesAttrDesc.count;e++){const i=s[5*e+0],r=s[5*e+1],n=s[5*e+2],a=s[5*e+3],o=s[5*e+4];es.AddToMesh(i,r,n,a,o,t);}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(Hi.PositionKind,e.positions,e.positions._updatable||e.positionsUpdatable),t.setVerticesData(Hi.NormalKind,e.normals,e.normals._updatable||e.normalsUpdatable),e.tangents&&t.setVerticesData(Hi.TangentKind,e.tangents,e.tangents._updatable||e.tangentsUpdatable),e.uvs&&t.setVerticesData(Hi.UVKind,e.uvs,e.uvs._updatable||e.uvsUpdatable),e.uvs2&&t.setVerticesData(Hi.UV2Kind,e.uvs2,e.uvs2._updatable||e.uvs2Updatable),e.uvs3&&t.setVerticesData(Hi.UV3Kind,e.uvs3,e.uvs3._updatable||e.uvs3Updatable),e.uvs4&&t.setVerticesData(Hi.UV4Kind,e.uvs4,e.uvs4._updatable||e.uvs4Updatable),e.uvs5&&t.setVerticesData(Hi.UV5Kind,e.uvs5,e.uvs5._updatable||e.uvs5Updatable),e.uvs6&&t.setVerticesData(Hi.UV6Kind,e.uvs6,e.uvs6._updatable||e.uvs6Updatable),e.colors&&t.setVerticesData(Hi.ColorKind,me$3.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded||e.matricesIndicesExpanded)delete e.matricesIndices._isExpanded,delete e.matricesIndicesExpanded,t.setVerticesData(Hi.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable||e.matricesIndicesUpdatable);else {const i=[];for(let t=0;t<e.matricesIndices.length;t++){const s=e.matricesIndices[t];i.push(255&s),i.push((65280&s)>>8),i.push((16711680&s)>>16),i.push(s>>24&255);}t.setVerticesData(Hi.MatricesIndicesKind,i,e.matricesIndices._updatable||e.matricesIndicesUpdatable);}if(e.matricesIndicesExtra)if(e.matricesIndicesExtraExpanded||e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,delete e.matricesIndicesExtraExpanded,t.setVerticesData(Hi.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable||e.matricesIndicesExtraUpdatable);else {const i=[];for(let t=0;t<e.matricesIndicesExtra.length;t++){const s=e.matricesIndicesExtra[t];i.push(255&s),i.push((65280&s)>>8),i.push((16711680&s)>>16),i.push(s>>24&255);}t.setVerticesData(Hi.MatricesIndicesExtraKind,i,e.matricesIndicesExtra._updatable||e.matricesIndicesExtraUpdatable);}e.matricesWeights&&(rs._CleanMatricesWeights(e,t),t.setVerticesData(Hi.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(Hi.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null);}if(e.subMeshes){t.subMeshes=[];for(let i=0;i<e.subMeshes.length;i++){const s=e.subMeshes[i];es.AddToMesh(s.materialIndex,s.verticesStart,s.verticesCount,s.indexStart,s.indexCount,t);}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=false),t.computeWorldMatrix(true),i.onMeshImportedObservable.notifyObservers(t);}static _CleanMatricesWeights(e,t){const i=.001;if(!ss.CleanBoneMatrixWeights)return;let s=0;if(!(e.skeletonId>-1))return;{const i=t.getScene().getLastSkeletonById(e.skeletonId);if(!i)return;s=i.bones.length;}const r=t.getVerticesData(Hi.MatricesIndicesKind),n=t.getVerticesData(Hi.MatricesIndicesExtraKind),a=e.matricesWeights,o=e.matricesWeightsExtra,h=e.numBoneInfluencer,l=a.length;for(let e=0;e<l;e+=4){let t=0,l=-1;for(let s=0;s<4;s++){const r=a[e+s];t+=r,r<i&&l<0&&(l=s);}if(o)for(let s=0;s<4;s++){const r=o[e+s];t+=r,r<i&&l<0&&(l=s+4);}if((l<0||l>h-1)&&(l=h-1),t>i){const i=1/t;for(let t=0;t<4;t++)a[e+t]*=i;if(o)for(let t=0;t<4;t++)o[e+t]*=i;}else l>=4?(o[e+l-4]=1-t,n[e+l-4]=s):(a[e+l]=1-t,r[e+l]=s);}t.setVerticesData(Hi.MatricesIndicesKind,r),e.matricesWeightsExtra&&t.setVerticesData(Hi.MatricesIndicesExtraKind,n);}static Parse(e,t,i){const s=new rs(e.id,t,void 0,e.updatable);return s._loadedUniqueId=e.uniqueId,ue$4&&ue$4.AddTagsTo(s,e.tags),e.delayLoadingFile?(s.delayLoadState=Qe$1.DELAYLOADSTATE_NOTLOADED,s.delayLoadingFile=i+e.delayLoadingFile,s._boundingInfo=new qi(te$4.FromArray(e.boundingBoxMinimum),te$4.FromArray(e.boundingBoxMaximum)),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(Hi.UVKind),e.hasUVs2&&s._delayInfo.push(Hi.UV2Kind),e.hasUVs3&&s._delayInfo.push(Hi.UV3Kind),e.hasUVs4&&s._delayInfo.push(Hi.UV4Kind),e.hasUVs5&&s._delayInfo.push(Hi.UV5Kind),e.hasUVs6&&s._delayInfo.push(Hi.UV6Kind),e.hasColors&&s._delayInfo.push(Hi.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(Hi.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(Hi.MatricesWeightsKind),s._delayLoadingFunction=is.ImportVertexData):is.ImportVertexData(e,s),t.pushGeometry(s,true),s}}class ns extends be$3{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=0!==(this._billboardMode&ns.BILLBOARDMODE_USE_POSITION));}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e);}constructor(e,t=null,i=true){super(e,t,false),this._forward=new te$4(0,0,1),this._up=new te$4(0,1,0),this._right=new te$4(1,0,0),this._position=te$4.Zero(),this._rotation=te$4.Zero(),this._rotationQuaternion=null,this._scaling=te$4.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=false,this._billboardMode=ns.BILLBOARDMODE_NONE,this.scalingDeterminant=1,this._infiniteDistance=false,this.ignoreNonUniformScaling=false,this.reIntegrateRotationIntoRotationQuaternion=false,this._poseMatrix=null,this._localMatrix=re$5.Zero(),this._usePivotMatrix=false,this._absolutePosition=te$4.Zero(),this._absoluteScaling=te$4.Zero(),this._absoluteRotationQuaternion=se$5.Identity(),this._pivotMatrix=re$5.Identity(),this._postMultiplyPivotMatrix=false,this._isWorldMatrixFrozen=false,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new R$g,this._nonUniformScaling=false,i&&this.getScene().addTransformNode(this);}getClassName(){return "TransformNode"}get position(){return this._position}set position(e){this._position=e,this._markAsDirtyInternal();}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._markAsDirtyInternal();}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._markAsDirtyInternal();}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._markAsDirtyInternal();}_markAsDirtyInternal(){this._isDirty||(this._isDirty=true,this.customMarkAsDirty&&this.customMarkAsDirty());}get forward(){return te$4.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return te$4.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return te$4.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=re$5.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return this._billboardMode===e.billboardMode&&this._billboardMode===ns.BILLBOARDMODE_NONE&&(!e.pivotMatrixUpdated&&(!this._infiniteDistance&&(!this._position._isDirty&&(!this._scaling._isDirty&&!(this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)))))}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=false,e.billboardMode=-1,e.infiniteDistance=false,e.useBillboardPosition=false;}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,false)}setPivotMatrix(e,t=true){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=true,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=re$5.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,true);s&&i&&i(this,s);for(const e of this.getChildTransformNodes(true))e.instantiateHierarchy(s,t,i);return s}freezeWorldMatrix(e=null,t=false){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||se$5.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(true)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=false,this.computeWorldMatrix(true)),this._isDirty=false,this._isWorldMatrixFrozen=true,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=false,this.computeWorldMatrix(true),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,s;if(void 0===e.x){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],s=arguments[2];}else t=e.x,i=e.y,s=e.z;if(this.parent){const e=ae$5.Matrix[0];this.parent.getWorldMatrix().invertToRef(e),te$4.TransformCoordinatesFromFloatsToRef(t,i,s,e,this.position);}else this.position.x=t,this.position.y=i,this.position.z=s;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=te$4.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=ae$5.Matrix[0];return this._localMatrix.invertToRef(e),te$4.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(true),this.position=te$4.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,s=0,r=0){const n=ns._LookAtVectorCache,a=0===r?this.position:this.getAbsolutePosition();if(e.subtractToRef(a,n),this.setDirection(n,t,i,s),1===r&&this.parent)if(this.rotationQuaternion){const e=ae$5.Matrix[0];this.rotationQuaternion.toRotationMatrix(e);const t=ae$5.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.invert(),e.multiplyToRef(t,e),this.rotationQuaternion.fromRotationMatrix(e);}else {const e=ae$5.Quaternion[0];se$5.FromEulerVectorToRef(this.rotation,e);const t=ae$5.Matrix[0];e.toRotationMatrix(t);const i=ae$5.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(i),i.invert(),t.multiplyToRef(i,t),e.fromRotationMatrix(t),e.toEulerAnglesToRef(this.rotation);}return this}getDirection(e){const t=te$4.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return te$4.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,s=0){const r=-Math.atan2(e.z,e.x)+Math.PI/2,n=Math.sqrt(e.x*e.x+e.z*e.z),a=-Math.atan2(e.y,n);return this.rotationQuaternion?se$5.RotationYawPitchRollToRef(r+t,a+i,s,this.rotationQuaternion):(this.rotation.x=a+i,this.rotation.y=r+t,this.rotation.z=s),this}setPivotPoint(e,t=0){0==this.getScene().getRenderId()&&this.computeWorldMatrix(true);const i=this.getWorldMatrix();if(1==t){const t=ae$5.Matrix[0];i.invertToRef(t),e=te$4.TransformCoordinates(e,t);}return this.setPivotMatrix(re$5.Translation(-e.x,-e.y,-e.z),true)}getPivotPoint(){const e=te$4.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=te$4.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),te$4.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=false,i=false){if(!e&&!this.parent)return this;const s=ae$5.Quaternion[0],r=ae$5.Vector3[0],n=ae$5.Vector3[1],a=ae$5.Matrix[1];re$5.IdentityToRef(a);const o=ae$5.Matrix[0];this.computeWorldMatrix(true);let h=this.rotationQuaternion;return h||(h=ns._TmpRotation,se$5.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,h)),re$5.ComposeToRef(this.scaling,h,this.position,o),this.parent&&o.multiplyToRef(this.parent.computeWorldMatrix(true),o),e&&(e.computeWorldMatrix(true).invertToRef(a),o.multiplyToRef(a,o)),o.decompose(n,s,r,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(n),this.position.copyFrom(r),this.parent=e,i&&this.setPivotMatrix(re$5.Identity()),this}addChild(e,t=false){return e.setParent(this,t),this}removeChild(e,t=false){return e.parent!==this||e.setParent(null,t),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,true)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(true),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=false){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=e?this._currentParentWhenAttachingToBone:null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){let s;if(e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),i&&0!==i){if(this.parent){const i=this.parent.getWorldMatrix(),s=ae$5.Matrix[0];i.invertToRef(s),e=te$4.TransformNormal(e,s),i.determinant()<0&&(t*=-1);}s=se$5.RotationAxisToRef(e,t,ns._RotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion);}else s=se$5.RotationAxisToRef(e,t,ns._RotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=se$5.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const s=ae$5.Vector3[0],r=ae$5.Vector3[1],n=ae$5.Vector3[2],a=ae$5.Quaternion[0],o=ae$5.Matrix[0],h=ae$5.Matrix[1],l=ae$5.Matrix[2],c=ae$5.Matrix[3];return e.subtractToRef(this.position,s),re$5.TranslationToRef(s.x,s.y,s.z,o),re$5.TranslationToRef(-s.x,-s.y,-s.z,h),re$5.RotationAxisToRef(t,i,l),h.multiplyToRef(l,c),c.multiplyToRef(o,c),c.decompose(r,a,n),this.position.addInPlace(n),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const s=e.scale(t);if(i&&0!==i)this.setAbsolutePosition(this.getAbsolutePosition().add(s));else {const e=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(e);}return this}addRotation(e,t,i){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=ae$5.Quaternion[1],se$5.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));const r=ae$5.Quaternion[0];return se$5.RotationYawPitchRollToRef(t,e,i,r),s.multiplyInPlace(r),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==ns.BILLBOARDMODE_NONE}computeWorldMatrix(e=false,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const s=this._cache;s.pivotMatrixUpdated=false,s.billboardMode=this.billboardMode,s.infiniteDistance=this.infiniteDistance,s.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=false,this._position._isDirty=false,this._rotation._isDirty=false,this._scaling._isDirty=false;const r=this._getEffectiveParent(),n=ns._TmpScaling;let a,o=this._position;if(this._infiniteDistance&&!this.parent&&t){const e=t.getWorldMatrix(),i=new te$4(e.m[12],e.m[13],e.m[14]);o=ns._TmpTranslation,o.copyFromFloats(this._position.x+i.x,this._position.y+i.y,this._position.z+i.z);}if(n.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant),this._rotationQuaternion){if(this._rotationQuaternion._isDirty=false,a=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion){this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(se$5.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0));}}else a=ns._TmpRotation,se$5.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,a);if(this._usePivotMatrix){const e=ae$5.Matrix[1];re$5.ScalingToRef(n.x,n.y,n.z,e);const t=ae$5.Matrix[0];a.toRotationMatrix(t),this._pivotMatrix.multiplyToRef(e,ae$5.Matrix[4]),ae$5.Matrix[4].multiplyToRef(t,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z);}else re$5.ComposeToRef(n,a,o,this._localMatrix);if(r&&r.getWorldMatrix){if(e&&r.computeWorldMatrix(e),this.billboardMode){if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),e.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),ae$5.Matrix[7]);}else ae$5.Matrix[7].copyFrom(r.getWorldMatrix());const e=ae$5.Vector3[5],t=ae$5.Vector3[6],i=ae$5.Quaternion[0];ae$5.Matrix[7].decompose(t,i,e),re$5.ScalingToRef(t.x,t.y,t.z,ae$5.Matrix[7]),ae$5.Matrix[7].setTranslation(e),ns.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(i,e),this._localMatrix.setTranslation(e)),this._localMatrix.multiplyToRef(ae$5.Matrix[7],this._worldMatrix);}else if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),this._localMatrix.multiplyToRef(e.getFinalMatrix(),ae$5.Matrix[6]),ae$5.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix);}else this._localMatrix.multiplyToRef(r.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent();}else this._worldMatrix.copyFrom(this._localMatrix);if(t&&this.billboardMode)if(s.useBillboardPosition){const e=ae$5.Vector3[0];this._worldMatrix.getTranslationToRef(e);const i=t.globalPosition;this._worldMatrix.invertToRef(ae$5.Matrix[1]);const s=ae$5.Vector3[1];te$4.TransformCoordinatesToRef(i,ae$5.Matrix[1],s),s.normalize();const r=-Math.atan2(s.z,s.x)+Math.PI/2,n=Math.sqrt(s.x*s.x+s.z*s.z),a=-Math.atan2(s.y,n);if(se$5.RotationYawPitchRollToRef(r,a,0,ae$5.Quaternion[0]),(this.billboardMode&ns.BILLBOARDMODE_ALL)!==ns.BILLBOARDMODE_ALL){const e=ae$5.Vector3[1];ae$5.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&ns.BILLBOARDMODE_X)!==ns.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&ns.BILLBOARDMODE_Y)!==ns.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&ns.BILLBOARDMODE_Z)!==ns.BILLBOARDMODE_Z&&(e.z=0),re$5.RotationYawPitchRollToRef(e.y,e.x,e.z,ae$5.Matrix[0]);}else re$5.FromQuaternionToRef(ae$5.Quaternion[0],ae$5.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(ae$5.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(ae$5.Vector3[0]);}else {const e=ae$5.Vector3[0];this._worldMatrix.getTranslationToRef(e),ae$5.Matrix[1].copyFrom(t.getViewMatrix());const i=this.getScene().useRightHandedSystem;if(i&&ae$5.Matrix[1].multiplyToRef(ns._TmpRHRestore,ae$5.Matrix[1]),ae$5.Matrix[1].setTranslationFromFloats(0,0,0),ae$5.Matrix[1].invertToRef(ae$5.Matrix[0]),(this.billboardMode&ns.BILLBOARDMODE_ALL)!==ns.BILLBOARDMODE_ALL){ae$5.Matrix[0].decompose(void 0,ae$5.Quaternion[0],void 0);const e=ae$5.Vector3[1];ae$5.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&ns.BILLBOARDMODE_X)!==ns.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&ns.BILLBOARDMODE_Y)!==ns.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&ns.BILLBOARDMODE_Z)!==ns.BILLBOARDMODE_Z&&(e.z=0),i&&(e.y+=Math.PI),re$5.RotationYawPitchRollToRef(e.y,e.x,e.z,ae$5.Matrix[0]);}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(ae$5.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(ae$5.Vector3[0]);}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(false):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(true):r&&r._nonUniformScaling?this._updateNonUniformScalingState(r._nonUniformScaling):this._updateNonUniformScalingState(false),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=false,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=re$5.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=true,this._worldMatrix}resetLocalMatrix(e=true){if(this.computeWorldMatrix(),e){const e=this.getChildren();for(let t=0;t<e.length;++t){const i=e[t];if(i){i.computeWorldMatrix();const e=ae$5.Matrix[0];i._localMatrix.multiplyToRef(this._localMatrix,e);const t=ae$5.Quaternion[0];e.decompose(i.scaling,t,i.position),i.rotationQuaternion?i.rotationQuaternion.copyFrom(t):t.toEulerAnglesToRef(i.rotation);}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=se$5.Identity()),this._worldMatrix=re$5.Identity();}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),te$4.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const s=Ae$3.Clone((()=>new ns(e,this.getScene())),this);if(s.name=e,s.id=e,t&&(s.parent=t),!i){const t=this.getDescendants(true);for(let i=0;i<t.length;i++){const r=t[i];r.clone&&r.clone(e+"."+r.name,s);}}return s}serialize(e){const t=Ae$3.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),Ae$3.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t}static Parse(e,t,i){const s=Ae$3.Parse((()=>new ns(e.name,t)),e,t,i);if(e.localMatrix?s.setPreTransformMatrix(re$5.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(re$5.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s._waitingParsedUniqueId=e.uniqueId,void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=O$g("BABYLON.Animation");r&&s.animations.push(r.Parse(i));}be$3.ParseAnimationRanges(s,e,t);}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),s}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,(e=>(!t||t(e))&&e instanceof ns)),i}dispose(e,t=false){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const e=this._parentContainer.transformNodes.indexOf(this);e>-1&&this._parentContainer.transformNodes.splice(e,1),this._parentContainer=null;}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const e=this.getChildTransformNodes(true);for(const t of e)t.parent=null,t.computeWorldMatrix(true);}super.dispose(e,t);}normalizeToUnitCube(e=true,t=false,i){let s=null,r=null;t&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const n=this.getHierarchyBoundingVectors(e,i),a=n.max.subtract(n.min),o=Math.max(a.x,a.y,a.z);if(0===o)return this;const h=1/o;return this.scaling.scaleInPlace(h),t&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&s&&this.rotation.copyFrom(s)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=true);}}var as,os,hs;ns.BILLBOARDMODE_NONE=0,ns.BILLBOARDMODE_X=1,ns.BILLBOARDMODE_Y=2,ns.BILLBOARDMODE_Z=4,ns.BILLBOARDMODE_ALL=7,ns.BILLBOARDMODE_USE_POSITION=128,ns.BillboardUseParentOrientation=false,ns._TmpRotation=se$5.Zero(),ns._TmpScaling=te$4.Zero(),ns._TmpTranslation=te$4.Zero(),ns._TmpRHRestore=re$5.Scaling(1,1,-1),ns._LookAtVectorCache=new te$4(0,0,0),ns._RotationAxisCache=new se$5,e$z([u$s("position")],ns.prototype,"_position",void 0),e$z([u$s("rotation")],ns.prototype,"_rotation",void 0),e$z([(as="rotationQuaternion",r$1U(10,as))],ns.prototype,"_rotationQuaternion",void 0),e$z([u$s("scaling")],ns.prototype,"_scaling",void 0),e$z([a$$("billboardMode")],ns.prototype,"_billboardMode",void 0),e$z([a$$()],ns.prototype,"scalingDeterminant",void 0),e$z([a$$("infiniteDistance")],ns.prototype,"_infiniteDistance",void 0),e$z([a$$()],ns.prototype,"ignoreNonUniformScaling",void 0),e$z([a$$()],ns.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class ls{constructor(){this.hit=false,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null;}getNormal(e=false,t=true){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(Hi.NormalKind))return null;let i,s=this.pickedMesh.getIndices();0===s?.length&&(s=null);const r=ae$5.Vector3[0],n=ae$5.Vector3[1],a=ae$5.Vector3[2];if(t){const e=this.pickedMesh.getVerticesData(Hi.NormalKind);let t=s?te$4.FromArrayToRef(e,3*s[3*this.faceId],r):r.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),o=s?te$4.FromArrayToRef(e,3*s[3*this.faceId+1],n):n.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),h=s?te$4.FromArrayToRef(e,3*s[3*this.faceId+2],a):a.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]);t=t.scale(this.bu),o=o.scale(this.bv),h=h.scale(1-this.bu-this.bv),i=new te$4(t.x+o.x+h.x,t.y+o.y+h.y,t.z+o.z+h.z);}else {const e=this.pickedMesh.getVerticesData(Hi.PositionKind),t=s?te$4.FromArrayToRef(e,3*s[3*this.faceId],r):r.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),o=s?te$4.FromArrayToRef(e,3*s[3*this.faceId+1],n):n.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),h=s?te$4.FromArrayToRef(e,3*s[3*this.faceId+2],a):a.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]),l=t.subtract(o),c=h.subtract(o);i=te$4.Cross(l,c);}const o=(e,t)=>{if(-1!==this.thinInstanceIndex){const i=e.thinInstanceGetWorldMatrices()[this.thinInstanceIndex];i&&te$4.TransformNormalToRef(t,i,t);}let i=e.getWorldMatrix();e.nonUniformScaling&&(ae$5.Matrix[0].copyFrom(i),i=ae$5.Matrix[0],i.setTranslationFromFloats(0,0,0),i.invert(),i.transposeToRef(ae$5.Matrix[1]),i=ae$5.Matrix[1]),te$4.TransformNormalToRef(t,i,t);};if(e&&o(this.pickedMesh,i),this.ray){const t=ae$5.Vector3[0].copyFrom(i);e||o(this.pickedMesh,t),te$4.Dot(t,this.ray.direction)>0&&i.negateInPlace();}return i.normalize(),i}getTextureCoordinates(e=Hi.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let s=ee$4.FromArray(i,2*t[3*this.faceId]),r=ee$4.FromArray(i,2*t[3*this.faceId+1]),n=ee$4.FromArray(i,2*t[3*this.faceId+2]);return s=s.scale(this.bu),r=r.scale(this.bv),n=n.scale(1-this.bu-this.bv),new ee$4(s.x+r.x+n.x,s.y+r.y+n.y)}}class cs{constructor(e,t,i=false,s,r=false,n){this._uniformNames=[],this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||r,this._dynamic=i,this._name=s??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=false,this._trackUBOsInFrame=false,(void 0===n&&this._engine._features.trackUbosInFrame||true===n)&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=false,this._currentFrameId=0,this._trackUBOsInFrame=true),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform);}get useUbo(){return !this._noUBO}get isSync(){return !this._needSync}isDynamic(){return this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}getUniformNames(){return this._uniformNames}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!==0){const e=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const i=this._uniformLocationPointer-e;for(let e=0;e<i;e++)this._data.push(0);}}addUniform(e,t,i=0){if(i>0&&"number"==typeof t&&(this._uniformArraySizes[e]={strideSize:t,arraySize:i}),void 0!==this._uniformLocations[e])return;if(this._uniformNames.push(e),this._noUBO)return;let s;if(i>0){if(t instanceof Array)throw "addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),16==t)t*=i;else {t=t*i+(4-t)*i;}s=[];for(let e=0;e<t;e++)s.push(0);}else {if(t instanceof Array)s=t,t=s.length;else {s=[];for(let e=0;e<t;e++)s.push(0);}this._fillAlignment(t);}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let e=0;e<t;e++)this._data.push(s[e]);this._needSync=true;}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()));}addFloat2(e,t,i){const s=[t,i];this.addUniform(e,s);}addFloat3(e,t,i,s){const r=[t,i,s];this.addUniform(e,r);}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i);}addColor4(e,t,i){const s=[t.r,t.g,t.b,i];this.addUniform(e,s);}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i);}addMatrix3x3(e){this.addUniform(e,12);}addMatrix2x2(e){this.addUniform(e,8);}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=true);}_getNamesDebug(){const e=[];let t=0;for(const i in this._uniformLocations)if(e.push(i),10===++t)break;return e.join(",")}_rebuild(){!this._noUBO&&this._bufferData&&(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()),this._trackUBOsInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=false));}_rebuildAfterContextLost(){this._trackUBOsInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild();}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}set name(e){this._name=e;}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return  false;return  true}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i];}update(){if(!this._noUBO)if(this.bindUniformBuffer(),this._buffer)if(this._dynamic||this._needSync){if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=false,void(this._createBufferOnWrite=this._trackUBOsInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(cs._UpdatedUbosInFrame[this._name]||(cs._UpdatedUbosInFrame[this._name]=0),cs._UpdatedUbosInFrame[this._name]++),this._needSync=false,this._createBufferOnWrite=this._trackUBOsInFrame;}else this._createBufferOnWrite=this._trackUBOsInFrame;else this.create();}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=false,this._needSync=true):this._rebuild();}_checkNewFrame(){this._trackUBOsInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=false,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1);}updateUniform(e,t,i){this._checkNewFrame();let s=this._uniformLocations[e];if(void 0===s){if(this._buffer)return void Ie$2.Error("Cannot add an uniform after UBO has been created. uniformName="+e);this.addUniform(e,i),s=this._uniformLocations[e];}if(this._buffer||this.create(),this._dynamic)for(let e=0;e<i;e++)this._bufferData[s+e]=t[e];else {let e=false;for(let r=0;r<i;r++)(16===i&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[s+r]!==Math.fround(t[r]))&&(e=true,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+r]=t[r]);this._needSync=this._needSync||e;}}updateUniformArray(e,t,i){this._checkNewFrame();const s=this._uniformLocations[e];if(void 0===s)return void Ie$2.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();const r=this._uniformArraySizes[e];if(this._dynamic)for(let e=0;e<i;e++)this._bufferData[s+e]=t[e];else {let e=false,n=0,a=0;for(let o=0;o<i;o++)if(this._bufferData[s+4*a+n]!==Ai.FloatRound(t[o])&&(e=true,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+4*a+n]=t[o]),n++,n===r.strideSize){for(;n<4;n++)this._bufferData[s+4*a+n]=0;n=0,a++;}this._needSync=this._needSync||e;}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],s=t.updateFlag;return (void 0===i||i!==s)&&(this._valueCache[e]=s,true)}_updateMatrix3x3ForUniform(e,t){for(let e=0;e<3;e++)cs._TempBuffer[4*e]=t[3*e],cs._TempBuffer[4*e+1]=t[3*e+1],cs._TempBuffer[4*e+2]=t[3*e+2],cs._TempBuffer[4*e+3]=0;this.updateUniform(e,cs._TempBuffer,12);}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t);}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t);}_updateMatrix2x2ForUniform(e,t){for(let e=0;e<2;e++)cs._TempBuffer[4*e]=t[2*e],cs._TempBuffer[4*e+1]=t[2*e+1],cs._TempBuffer[4*e+2]=0,cs._TempBuffer[4*e+3]=0;this.updateUniform(e,cs._TempBuffer,8);}_updateFloatForEffect(e,t,i=""){this._currentEffect.setFloat(e+i,t);}_updateFloatForUniform(e,t){cs._TempBuffer[0]=t,this.updateUniform(e,cs._TempBuffer,1);}_updateFloat2ForEffect(e,t,i,s=""){this._currentEffect.setFloat2(e+s,t,i);}_updateFloat2ForUniform(e,t,i){cs._TempBuffer[0]=t,cs._TempBuffer[1]=i,this.updateUniform(e,cs._TempBuffer,2);}_updateFloat3ForEffect(e,t,i,s,r=""){this._currentEffect.setFloat3(e+r,t,i,s);}_updateFloat3ForUniform(e,t,i,s){cs._TempBuffer[0]=t,cs._TempBuffer[1]=i,cs._TempBuffer[2]=s,this.updateUniform(e,cs._TempBuffer,3);}_updateFloat4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setFloat4(e+n,t,i,s,r);}_updateFloat4ForUniform(e,t,i,s,r){cs._TempBuffer[0]=t,cs._TempBuffer[1]=i,cs._TempBuffer[2]=s,cs._TempBuffer[3]=r,this.updateUniform(e,cs._TempBuffer,4);}_updateFloatArrayForEffect(e,t,i=""){switch(this._uniformArraySizes[e]?.strideSize){case 2:this._currentEffect.setFloatArray2(e+i,t);break;case 3:this._currentEffect.setFloatArray3(e+i,t);break;case 4:this._currentEffect.setFloatArray4(e+i,t);break;default:this._currentEffect.setFloatArray(e+i,t);}}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length);}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t);}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length);}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t);}_updateIntArrayForUniform(e,t){cs._TempBufferInt32View.set(t),this.updateUniformArray(e,cs._TempBuffer,t.length);}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t);}_updateUIntArrayForUniform(e,t){cs._TempBufferUInt32View.set(t),this.updateUniformArray(e,cs._TempBuffer,t.length);}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t);}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16);}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t);}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length);}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t);}_updateVector3ForUniform(e,t){cs._TempBuffer[0]=t.x,cs._TempBuffer[1]=t.y,cs._TempBuffer[2]=t.z,this.updateUniform(e,cs._TempBuffer,3);}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t);}_updateVector4ForUniform(e,t){cs._TempBuffer[0]=t.x,cs._TempBuffer[1]=t.y,cs._TempBuffer[2]=t.z,cs._TempBuffer[3]=t.w,this.updateUniform(e,cs._TempBuffer,4);}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t);}_updateColor3ForUniform(e,t){cs._TempBuffer[0]=t.r,cs._TempBuffer[1]=t.g,cs._TempBuffer[2]=t.b,this.updateUniform(e,cs._TempBuffer,3);}_updateColor4ForEffect(e,t,i,s=""){this._currentEffect.setColor4(e+s,t,i);}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t);}_updateColor4ForUniform(e,t,i){cs._TempBuffer[0]=t.r,cs._TempBuffer[1]=t.g,cs._TempBuffer[2]=t.b,cs._TempBuffer[3]=i,this.updateUniform(e,cs._TempBuffer,4);}_updateDirectColor4ForUniform(e,t){cs._TempBuffer[0]=t.r,cs._TempBuffer[1]=t.g,cs._TempBuffer[2]=t.b,cs._TempBuffer[3]=t.a,this.updateUniform(e,cs._TempBuffer,4);}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t);}_updateIntForUniform(e,t){cs._TempBufferInt32View[0]=t,this.updateUniform(e,cs._TempBuffer,1);}_updateInt2ForEffect(e,t,i,s=""){this._currentEffect.setInt2(e+s,t,i);}_updateInt2ForUniform(e,t,i){cs._TempBufferInt32View[0]=t,cs._TempBufferInt32View[1]=i,this.updateUniform(e,cs._TempBuffer,2);}_updateInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setInt3(e+r,t,i,s);}_updateInt3ForUniform(e,t,i,s){cs._TempBufferInt32View[0]=t,cs._TempBufferInt32View[1]=i,cs._TempBufferInt32View[2]=s,this.updateUniform(e,cs._TempBuffer,3);}_updateInt4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setInt4(e+n,t,i,s,r);}_updateInt4ForUniform(e,t,i,s,r){cs._TempBufferInt32View[0]=t,cs._TempBufferInt32View[1]=i,cs._TempBufferInt32View[2]=s,cs._TempBufferInt32View[3]=r,this.updateUniform(e,cs._TempBuffer,4);}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t);}_updateUIntForUniform(e,t){cs._TempBufferUInt32View[0]=t,this.updateUniform(e,cs._TempBuffer,1);}_updateUInt2ForEffect(e,t,i,s=""){this._currentEffect.setUInt2(e+s,t,i);}_updateUInt2ForUniform(e,t,i){cs._TempBufferUInt32View[0]=t,cs._TempBufferUInt32View[1]=i,this.updateUniform(e,cs._TempBuffer,2);}_updateUInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setUInt3(e+r,t,i,s);}_updateUInt3ForUniform(e,t,i,s){cs._TempBufferUInt32View[0]=t,cs._TempBufferUInt32View[1]=i,cs._TempBufferUInt32View[2]=s,this.updateUniform(e,cs._TempBuffer,3);}_updateUInt4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setUInt4(e+n,t,i,s,r);}_updateUInt4ForUniform(e,t,i,s,r){cs._TempBufferUInt32View[0]=t,cs._TempBufferUInt32View[1]=i,cs._TempBufferUInt32View[2]=s,cs._TempBufferUInt32View[3]=r,this.updateUniform(e,cs._TempBuffer,4);}setTexture(e,t){this._currentEffect.setTexture(e,t);}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t);}bindTexture(e,t){this._currentEffect._bindTexture(e,t);}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update();}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t;}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName);}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0;}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t){if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=false,this._currentEffect=void 0,this._buffers.length>1&&this._buffers[t][1]&&this._bufferData.set(this._buffers[t][1]),this._valueCache={},this._currentFrameId=this._engine.frameId,true}return  false}has(e){return void 0!==this._uniformLocations[e]}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._trackUBOsInFrame&&this._buffers)for(let e=0;e<this._buffers.length;++e){const t=this._buffers[e][0];this._engine._releaseBuffer(t);}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null);}}cs._UpdatedUbosInFrame={},cs._MAX_UNIFORM_SIZE=256,cs._TempBuffer=new Float32Array(cs._MAX_UNIFORM_SIZE),cs._TempBufferInt32View=new Int32Array(cs._TempBuffer.buffer),cs._TempBufferUInt32View=new Uint32Array(cs._TempBuffer.buffer);class us{constructor(){this._checkCollisions=false,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new te$4(0,0,0),this._diffPositionForCollisions=new te$4(0,0,0),this._collisionResponse=true;}}!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD",e[e.BONE=2]="BONE";}(os||(os={}));class ds{}ds.X=new te$4(1,0,0),ds.Y=new te$4(0,1,0),ds.Z=new te$4(0,0,1),function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z";}(hs||(hs={}));class _s{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=false,this.facetParameters={},this.bbSize=te$4.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=false,this.facetDepthSortEnabled=false;}}class fs{constructor(){this._hasVertexAlpha=false,this._useVertexColors=true,this._numBoneInfluencers=4,this._applyFog=true,this._receiveShadows=false,this._facetData=new _s,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=true,this._isActive=false,this._onlyForInstances=false,this._isActiveIntermediate=false,this._onlyForInstancesIntermediate=false,this._actAsRegularMesh=false,this._currentLOD=new Map,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=false,this._meshCollisionData=new us,this._enableDistantPicking=false,this._rawBoundingInfo=null,this._sideOrientationHint=false,this._wasActiveLastFrame=false;}}class ps extends ns{static get BILLBOARDMODE_NONE(){return ns.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return ns.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return ns.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return ns.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return ns.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return ns.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e;}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e;}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e;}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e;}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e;}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager());}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty());}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return !!super._updateNonUniformScalingState(e)&&(this._markSubMeshesAsMiscDirty(),true)}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e;}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e);}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e);}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(1===t&&1!==e||1!==t&&1===e)&&this._markSubMeshesAsDirty((e=>{e.markAsMiscDirty(),e.markAsPrePassDirty();}));}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e;}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e;}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._setMaterial(e);}_setMaterial(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(void 0,null==e),this._unBindEffect()));}getMaterialForRenderPass(e){return this._internalAbstractMeshDataInfo._materialForRenderPass?.[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]);const i=this._internalAbstractMeshDataInfo._materialForRenderPass[e];i?.meshMap?.[this.uniqueId]&&(i.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this);}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty());}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty());}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty());}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty());}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty());}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty());}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e;}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources());}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e;}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e;}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e;}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e;}get lightSources(){return this._lightSources}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty();}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,false),this._internalAbstractMeshDataInfo=new fs,this._waitingMaterialId=null,this._waitingMorphTargetManagerId=null,this.cullingStrategy=ps.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new R$g,this.onCollisionPositionChangeObservable=new R$g,this.onMaterialChangedObservable=new R$g,this.definedFacingForward=true,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isPickable=true,this.isNearPickable=false,this.isNearGrabbable=false,this.showSubMeshesBoundingBox=false,this.isBlocker=false,this.enablePointerMoveEvents=false,this.outlineColor=ge$3.Red(),this.outlineWidth=.02,this.overlayColor=ge$3.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=true,this.useOctreeForPicking=true,this.useOctreeForCollisions=true,this.alwaysSelectAsActiveMesh=false,this.doNotSyncBoundingInfo=false,this.actionManager=null,this.ellipsoid=new te$4(.5,1,.5),this.ellipsoidOffset=new te$4(0,0,0),this.edgesWidth=1,this.edgesColor=new me$3(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=true,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=false,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new R$g,this._onCollisionPositionChange=(e,t,i=null)=>{t.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>jt.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),i&&this.onCollideObservable.notifyObservers(i),this.onCollisionPositionChangeObservable.notifyObservers(this.position);},(t=this.getScene()).addMesh(this),this._resyncLightSources(),this._uniformBuffer=new cs(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case 2:this.doNotSyncBoundingInfo=true;case 1:this.alwaysSelectAsActiveMesh=true,this.isPickable=false;}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create();}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update();}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return "AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+("InstancedMesh"===this.getClassName()?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==ns.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=true){if(this.actionManager&&(t||this.actionManager.isRecursive)){if(!e)return this.actionManager;if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}return this.parent?this.parent._getActionManagerForTrigger(e,false):null}_rebuild(e=false){if(this.onRebuildObservable.notifyObservers(this),null!==this._occlusionQuery&&(this._occlusionQuery=null),this.subMeshes){for(const e of this.subMeshes)e._rebuild();this.resetDrawCache();}}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty();}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let s=false;if(-1===i){if(!t)return;this._lightSources.push(e);}else {if(t)return;s=true,this._lightSources.splice(i,1);}this._markSubMeshesAsLightDirty(s);}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null);}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);-1!==i&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t));}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const s=t._drawWrappers[i];s&&s.defines&&s.defines.markAllAsDirty&&e(s.defines);}}_markSubMeshesAsLightDirty(e=false){this._markSubMeshesAsDirty((t=>t.markAsLightDirty(e)));}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty((e=>e.markAsAttributesDirty()));}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty((e=>e.markAsMiscDirty()));}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,super.markAsDirty(e),this._isDirty=true,this}resetDrawCache(e,t=false){if(this.subMeshes)for(const i of this.subMeshes)i.resetDrawCache(e,t);}get isBlocked(){return  false}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,s){return this}updateVerticesData(e,t,i,s){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return  false}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=false,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){return this.rawBoundingInfo??this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return null!==this._boundingInfo}buildBoundingInfo(e,t,i){return this._boundingInfo=new qi(e,t,i),this._boundingInfo}normalizeToUnitCube(e=true,t=false,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(Hi.MatricesIndicesKind)&&this.isVerticesDataPresent(Hi.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,true}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===ns.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return  false}get hasInstances(){return  false}get hasThinInstances(){return  false}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const s=new re$5;(this.rotationQuaternion?this.rotationQuaternion:se$5.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(s);const r=te$4.Zero(),n=this.definedFacingForward?-1:1;return te$4.TransformCoordinatesFromFloatsToRef(e*n,t,i*n,s,r),r}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const s=this.definedFacingForward?1:-1;return new te$4(e*s,t,i*s)}_refreshBoundingInfo(e,t){if(e){const i=Ji(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new qi(i.minimum,i.maximum);}if(this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(e);this._updateBoundingInfo();}_refreshBoundingInfoDirect(e){if(this._boundingInfo?this._boundingInfo.reConstruct(e.minimum,e.maximum):this._boundingInfo=new qi(e.minimum,e.maximum),this.subMeshes)for(let e=0;e<this.subMeshes.length;e++)this.subMeshes[e].refreshBoundingInfo(null);this._updateBoundingInfo();}static _ApplySkeleton(e,t,i,s,r,n,a){!function(e,t,i,s,r,n,a){const o=ae$5.Vector3[0],h=ae$5.Matrix[0],l=ae$5.Matrix[1],c=t===Hi.NormalKind?te$4.TransformNormalFromFloatsToRef:te$4.TransformCoordinatesFromFloatsToRef;for(let t=0,u=0;t<e.length;t+=3,u+=4){let d,_;for(h.reset(),d=0;d<4;d++)_=r[u+d],_>0&&(re$5.FromFloat32ArrayToRefScaled(i,Math.floor(16*s[u+d]),_,l),h.addToSelf(l));if(n&&a)for(d=0;d<4;d++)_=a[u+d],_>0&&(re$5.FromFloat32ArrayToRefScaled(i,Math.floor(16*n[u+d]),_,l),h.addToSelf(l));c(e[t],e[t+1],e[t+2],h,o),o.toArray(e,t);}}(e,t,i,s,r,n,a);}_getData(e,t,i=Hi.PositionKind){const s=e.cache,r=e=>{if(s){const t=s._vertexData||={};return t[e]||this.copyVerticesData(e,t),t[e]}return this.getVerticesData(e)};if(t||=r(i),!t)return null;if(s?(s._outputData?s._outputData.set(t):s._outputData=new Float32Array(t),t=s._outputData):(e.applyMorph&&this.morphTargetManager||e.applySkeleton&&this.skeleton)&&(t=t.slice()),e.applyMorph&&this.morphTargetManager&&function(e,t,i){let s=null;switch(t){case Hi.PositionKind:s=e=>e.getPositions();break;case Hi.NormalKind:s=e=>e.getNormals();break;case Hi.TangentKind:s=e=>e.getTangents();break;case Hi.UVKind:s=e=>e.getUVs();break;case Hi.UV2Kind:s=e=>e.getUV2s();break;case Hi.ColorKind:s=e=>e.getColors();break;default:return}for(let t=0;t<e.length;t++){let r=e[t];for(let n=0;n<i.numTargets;n++){const a=i.getTarget(n),o=a.influence;if(0!==o){const i=s(a);i&&(r+=(i[t]-e[t])*o);}}e[t]=r;}}(t,i,this.morphTargetManager),e.applySkeleton&&this.skeleton){const e=r(Hi.MatricesIndicesKind),s=r(Hi.MatricesWeightsKind);if(s&&e){const n=this.numBoneInfluencers>4,a=n?r(Hi.MatricesIndicesExtraKind):null,o=n?r(Hi.MatricesWeightsExtraKind):null,h=this.skeleton.getTransformMatrices(this);ps._ApplySkeleton(t,i,h,e,s,a,o);}}if(false!==e.updatePositionsArray&&i===Hi.PositionKind){const e=this._internalAbstractMeshDataInfo._positions||[],i=e.length;if(e.length=t.length/3,i<e.length)for(let t=i;t<e.length;t++)e[t]=new te$4;for(let i=0,s=0;i<e.length;i++,s+=3)e[i].copyFromFloats(t[s],t[s+1],t[s+2]);this._internalAbstractMeshDataInfo._positions=e;}return t}getNormalsData(e=false,t=false){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:false},null,Hi.NormalKind)}getPositionData(e=false,t=false,i=null){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:false},i,Hi.PositionKind)}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new qi(te$4.Zero(),te$4.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const s=this.subMeshes[i];(t>1||!s.IsGlobal)&&s.updateBoundingInfo(e);}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=true);}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=false,i){const s=this.getBoundingInfo(),r=e.getBoundingInfo();if(s.intersects(r,t))return  true;if(i)for(const i of this.getChildMeshes())if(i.intersectsMesh(e,t,true))return  true;return  false}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e;}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e,t=true){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId,t),this}_collideForSubMesh(e,t,i){if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const i=e.verticesStart,s=e.verticesStart+e.verticesCount;for(let r=i;r<s;r++)e._lastColliderWorldVertices.push(te$4.TransformCoordinates(this._positions[r],t));}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),e.getMaterial()?.fillMode===Qe$1.MATERIAL_TriangleStripDrawMode),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),s=i.length;for(let r=0;r<s;r++){const n=i.data[r];s>1&&!n._checkCollision(e)||this._collideForSubMesh(n,t,e);}return this}_shouldConvertRHS(){return  false}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=ae$5.Matrix[0],i=ae$5.Matrix[1];return re$5.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return  false}intersects(e,t,i,s=false,r,n=false){const a=new ls,o=this.getClassName(),h="InstancedLinesMesh"===o||"LinesMesh"===o||"GreasedLineMesh"===o?this.intersectionThreshold:0,l=this.getBoundingInfo();if(!this.subMeshes)return a;if(!(n||e.intersectsSphere(l.boundingSphere,h)&&e.intersectsBox(l.boundingBox,h)))return a;if(s)return a.hit=!n,a.pickedMesh=n?null:this,a.distance=n?0:te$4.Distance(e.origin,l.boundingSphere.center),a.subMeshId=0,a;if(!this._generatePointsArray())return a;let c=null;const u=this._scene.getIntersectingSubMeshCandidates(this,e),d=u.length;let _=false;for(let e=0;e<d;e++){const t=u.data[e].getMaterial();if(t&&(t.fillMode==Qe$1.MATERIAL_TriangleStripDrawMode||t.fillMode==Qe$1.MATERIAL_TriangleFillMode||t.fillMode==Qe$1.MATERIAL_WireFrameFillMode||t.fillMode==Qe$1.MATERIAL_PointFillMode||t.fillMode==Qe$1.MATERIAL_LineListDrawMode)){_=true;break}}if(!_)return a.hit=true,a.pickedMesh=this,a.distance=te$4.Distance(e.origin,l.boundingSphere.center),a.subMeshId=-1,a;for(let s=0;s<d;s++){const r=u.data[s];if(d>1&&!n&&!r.canIntersects(e))continue;const a=r.intersects(e,this._positions,this.getIndices(),t,i);if(a&&(t||!c||a.distance<c.distance)&&(c=a,c.subMeshId=r._id,c._internalSubMeshId=s,t))break}if(c){const t=r??this.getWorldMatrix(),i=ae$5.Vector3[0],s=ae$5.Vector3[1];te$4.TransformCoordinatesToRef(e.origin,t,i),e.direction.scaleToRef(c.distance,s);const n=te$4.TransformNormal(s,t).addInPlace(i);return a.hit=true,a.distance=te$4.Distance(i,n),a.pickedPoint=n,a.pickedMesh=this,a.bu=c.bu||0,a.bv=c.bv||0,a.subMeshFaceId=c.faceId,a.faceId=c.faceId+u.data[c._internalSubMeshId].indexStart/(-1!==this.getClassName().indexOf("LinesMesh")?2:3),a.subMeshId=c.subMeshId,a}return a}clone(e,t,i){return null}releaseSubMeshes(e=false){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose(e);else this.subMeshes=[];return this}dispose(e,t=false){let i;const s=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),s.freeActiveMeshes(),s.freeRenderingGroups(),s.renderingManager.maintainStateBetweenFrames&&s.renderingManager.restoreDispachedFlags(),void 0!==this.actionManager&&null!==this.actionManager&&(this.actionManager.disposeWhenUnowned&&!this._scene.meshes.some((e=>e!==this&&e.actionManager===this.actionManager))&&this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const e=this._intersectionsInProgress[i],t=e._intersectionsInProgress.indexOf(this);e._intersectionsInProgress.splice(t,1);}this._intersectionsInProgress.length=0;const r=s.lights;for(const e of r){let t=e.includedOnlyMeshes.indexOf(this);-1!==t&&e.includedOnlyMeshes.splice(t,1),t=e.excludedMeshes.indexOf(this),-1!==t&&e.excludedMeshes.splice(t,1);const i=e.getShadowGenerators();if(i){const e=i.values();for(let i=e.next();true!==i.done;i=e.next()){const e=i.value.getShadowMap();e&&e.renderList&&(t=e.renderList.indexOf(this),-1!==t&&e.renderList.splice(t,1));}}}"InstancedMesh"===this.getClassName()&&"InstancedLinesMesh"===this.getClassName()||this.releaseSubMeshes(true);const n=s.getEngine();if(null!==this._occlusionQuery&&(this.isOcclusionQueryInProgress=false,n.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),n.wipeCaches(),s.removeMesh(this),this._parentContainer){const e=this._parentContainer.meshes.indexOf(this);e>-1&&this._parentContainer.meshes.splice(e,1),this._parentContainer=null;}if(t&&this.material&&("MultiMaterial"===this.material.getClassName()?this.material.dispose(false,true,true):this.material.dispose(false,true)),!e)for(i=0;i<s.particleSystems.length;i++)s.particleSystems[i].emitter===this&&(s.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t);}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=te$4.Zero(),e.facetPositions[t]=te$4.Zero();return e.facetDataEnabled=true,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(Hi.PositionKind),i=this.getIndices(),s=this.getVerticesData(Hi.NormalKind),r=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=true,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else {let t=false;for(let e=0;e<i.length;e++)if(i[e]>65535){t=true;break}e.depthSortedIndices=t?new Uint32Array(i):new Uint16Array(i);}if(e.facetDepthSortFunction=function(e,t){return t.sqDistance-e.sqDistance},!e.facetDepthSortFrom){const t=this.getScene().activeCamera;e.facetDepthSortFrom=t?t.position:te$4.Zero();}e.depthSortedFacets=[];for(let t=0;t<e.facetNb;t++){const i={ind:3*t,sqDistance:0};e.depthSortedFacets.push(i);}e.invertedMatrix=re$5.Identity(),e.facetDepthSortOrigin=te$4.Zero();}e.bbSize.x=r.maximum.x-r.minimum.x>x$d?r.maximum.x-r.minimum.x:x$d,e.bbSize.y=r.maximum.y-r.minimum.y>x$d?r.maximum.y-r.minimum.y:x$d,e.bbSize.z=r.maximum.z-r.minimum.z>x$d?r.maximum.z-r.minimum.z:x$d;let n=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(n=n>e.bbSize.z?n:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/n),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/n),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/n),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=r,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(true),this._worldMatrix.invertToRef(e.invertedMatrix),te$4.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,s&&is.ComputeNormals(t,i,s,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const t=e.depthSortedIndices.length/3|0;for(let s=0;s<t;s++){const t=e.depthSortedFacets[s].ind;e.depthSortedIndices[3*s]=i[t],e.depthSortedIndices[3*s+1]=i[t+1],e.depthSortedIndices[3*s+2]=i[t+2];}this.updateIndices(e.depthSortedIndices,void 0,true);}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=te$4.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],s=this.getWorldMatrix();return te$4.TransformCoordinatesToRef(i,s,t),this}getFacetNormal(e){const t=te$4.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return te$4.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const s=this.getBoundingInfo(),r=this._internalAbstractMeshDataInfo._facetData,n=Math.floor((e-s.minimum.x*r.partitioningBBoxRatio)*r.subDiv.X*r.partitioningBBoxRatio/r.bbSize.x),a=Math.floor((t-s.minimum.y*r.partitioningBBoxRatio)*r.subDiv.Y*r.partitioningBBoxRatio/r.bbSize.y),o=Math.floor((i-s.minimum.z*r.partitioningBBoxRatio)*r.subDiv.Z*r.partitioningBBoxRatio/r.bbSize.z);return n<0||n>r.subDiv.max||a<0||a>r.subDiv.max||o<0||o>r.subDiv.max?null:r.facetPartitioning[n+r.subDiv.max*a+r.subDiv.max*r.subDiv.max*o]}getClosestFacetAtCoordinates(e,t,i,s,r=false,n=true){const a=this.getWorldMatrix(),o=ae$5.Matrix[5];a.invertToRef(o);const h=ae$5.Vector3[8];te$4.TransformCoordinatesFromFloatsToRef(e,t,i,o,h);const l=this.getClosestFacetAtLocalCoordinates(h.x,h.y,h.z,s,r,n);return s&&te$4.TransformCoordinatesFromFloatsToRef(s.x,s.y,s.z,a,s),l}getClosestFacetAtLocalCoordinates(e,t,i,s,r=false,n=true){let a=null,o=0,h=0,l=0,c=0,u=0,d=0,_=0,f=0;const p=this.getFacetLocalPositions(),g=this.getFacetLocalNormals(),m=this.getFacetsAtLocalCoordinates(e,t,i);if(!m)return null;let T,E,A,R=Number.MAX_VALUE,b=R;for(let S=0;S<m.length;S++)T=m[S],E=g[T],A=p[T],c=(e-A.x)*E.x+(t-A.y)*E.y+(i-A.z)*E.z,(!r||r&&n&&c>=0||r&&!n&&c<=0)&&(c=E.x*A.x+E.y*A.y+E.z*A.z,u=-(E.x*e+E.y*t+E.z*i-c)/(E.x*E.x+E.y*E.y+E.z*E.z),d=e+E.x*u,_=t+E.y*u,f=i+E.z*u,o=d-e,h=_-t,l=f-i,b=o*o+h*h+l*l,b<R&&(R=b,a=T,s&&(s.x=d,s.y=_,s.z=f)));return a}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=false,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters={},e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=false){return this}createNormals(e){const t=this.getVerticesData(Hi.PositionKind),i=this.getIndices();let s;return s=this.isVerticesDataPresent(Hi.NormalKind)?this.getVerticesData(Hi.NormalKind):[],is.ComputeNormals(t,i,s,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(Hi.NormalKind,s,e),this}async optimizeIndicesAsync(){const e=this.getIndices();if(!e)return this;const{OptimizeIndices:t}=await Promise.resolve().then(function(){return mesh_vertexData_functionsD0Kx5Kh7_esm_min});return t(e),this.setIndices(e,this.getTotalVertices()),this}alignWithNormal(e,t){t||(t=ds.Y);const i=ae$5.Vector3[0],s=ae$5.Vector3[1];return te$4.CrossToRef(t,e,s),te$4.CrossToRef(e,s,i),this.rotationQuaternion?se$5.RotationQuaternionFromAxisToRef(i,e,s,this.rotationQuaternion):te$4.RotationFromAxisToRef(i,e,s,this.rotation),this}_checkOcclusionQuery(){return  false}disableEdgesRendering(){throw le$4("EdgesRenderer")}enableEdgesRendering(e,t,i){throw le$4("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter((e=>e.emitter===this))}}ps.OCCLUSION_TYPE_NONE=0,ps.OCCLUSION_TYPE_OPTIMISTIC=1,ps.OCCLUSION_TYPE_STRICT=2,ps.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,ps.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,ps.CULLINGSTRATEGY_STANDARD=Qe$1.MESHES_CULLINGSTRATEGY_STANDARD,ps.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=Qe$1.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,ps.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=Qe$1.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION,ps.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=Qe$1.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY,e$z([g$j.filter(((...[e,t,i,s,r])=>!(Array.isArray(e)||Array.isArray(t)||Array.isArray(i)||Array.isArray(s)||Array.isArray(r))))],ps,"_ApplySkeleton",null),P$9("BABYLON.AbstractMesh",ps);class gs{constructor(){this.reset();}reset(){this.enabled=false,this.mask=255,this.funcRef=1,this.funcMask=255,this.func=Qe$1.ALWAYS,this.opStencilFail=Qe$1.KEEP,this.opDepthFail=Qe$1.KEEP,this.opStencilDepthPass=Qe$1.REPLACE,this.backFunc=Qe$1.ALWAYS,this.backOpStencilFail=Qe$1.KEEP,this.backOpDepthFail=Qe$1.KEEP,this.backOpStencilDepthPass=Qe$1.REPLACE;}get func(){return this._func}set func(e){this._func=e;}get backFunc(){return this._backFunc}set backFunc(e){this._backFunc=e;}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e;}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e;}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e;}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e;}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e;}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail=e;}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail=e;}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass=e;}get mask(){return this._mask}set mask(e){this._mask=e;}get enabled(){return this._enabled}set enabled(e){this._enabled=e;}getClassName(){return "MaterialStencilState"}copyTo(e){Ae$3.Clone((()=>e),this);}serialize(){return Ae$3.Serialize(this)}parse(e,t,i){Ae$3.Parse((()=>this),e,t,i);}}e$z([a$$()],gs.prototype,"func",null),e$z([a$$()],gs.prototype,"backFunc",null),e$z([a$$()],gs.prototype,"funcRef",null),e$z([a$$()],gs.prototype,"funcMask",null),e$z([a$$()],gs.prototype,"opStencilFail",null),e$z([a$$()],gs.prototype,"opDepthFail",null),e$z([a$$()],gs.prototype,"opStencilDepthPass",null),e$z([a$$()],gs.prototype,"backOpStencilFail",null),e$z([a$$()],gs.prototype,"backOpDepthFail",null),e$z([a$$()],gs.prototype,"backOpStencilDepthPass",null),e$z([a$$()],gs.prototype,"mask",null),e$z([a$$()],gs.prototype,"enabled",null);class ms{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}function Ts(e){ -1===e.indexOf("vClipPlane")&&e.push("vClipPlane"),-1===e.indexOf("vClipPlane2")&&e.push("vClipPlane2"),-1===e.indexOf("vClipPlane3")&&e.push("vClipPlane3"),-1===e.indexOf("vClipPlane4")&&e.push("vClipPlane4"),-1===e.indexOf("vClipPlane5")&&e.push("vClipPlane5"),-1===e.indexOf("vClipPlane6")&&e.push("vClipPlane6");}function Es(e,t,i){const s=!!(e.clipPlane??t.clipPlane),r=!!(e.clipPlane2??t.clipPlane2),n=!!(e.clipPlane3??t.clipPlane3),a=!!(e.clipPlane4??t.clipPlane4),o=!!(e.clipPlane5??t.clipPlane5),h=!!(e.clipPlane6??t.clipPlane6);s&&i.push("#define CLIPPLANE"),r&&i.push("#define CLIPPLANE2"),n&&i.push("#define CLIPPLANE3"),a&&i.push("#define CLIPPLANE4"),o&&i.push("#define CLIPPLANE5"),h&&i.push("#define CLIPPLANE6");}function As(e,t,i){let s=t.clipPlane??i.clipPlane;Rs(e,"vClipPlane",s),s=t.clipPlane2??i.clipPlane2,Rs(e,"vClipPlane2",s),s=t.clipPlane3??i.clipPlane3,Rs(e,"vClipPlane3",s),s=t.clipPlane4??i.clipPlane4,Rs(e,"vClipPlane4",s),s=t.clipPlane5??i.clipPlane5,Rs(e,"vClipPlane5",s),s=t.clipPlane6??i.clipPlane6,Rs(e,"vClipPlane6",s);}function Rs(e,t,i){i&&e.setFloat4(t,i.normal.x,i.normal.y,i.normal.z,i.d);}ms.FALLOFF_DEFAULT=0,ms.FALLOFF_PHYSICAL=1,ms.FALLOFF_GLTF=2,ms.FALLOFF_STANDARD=3,ms.LIGHTMAP_DEFAULT=0,ms.LIGHTMAP_SPECULAR=1,ms.LIGHTMAP_SHADOWSONLY=2,ms.INTENSITYMODE_AUTOMATIC=0,ms.INTENSITYMODE_LUMINOUSPOWER=1,ms.INTENSITYMODE_LUMINOUSINTENSITY=2,ms.INTENSITYMODE_ILLUMINANCE=3,ms.INTENSITYMODE_LUMINANCE=4,ms.LIGHTTYPEID_POINTLIGHT=0,ms.LIGHTTYPEID_DIRECTIONALLIGHT=1,ms.LIGHTTYPEID_SPOTLIGHT=2,ms.LIGHTTYPEID_HEMISPHERICLIGHT=3,ms.LIGHTTYPEID_RECT_AREALIGHT=4,ms.LIGHTTYPEID_CLUSTERED_CONTAINER=5;class bs{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get BaseWeightTextureEnabled(){return this._BaseWeightTextureEnabled}static set BaseWeightTextureEnabled(e){this._BaseWeightTextureEnabled!==e&&(this._BaseWeightTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get BaseDiffuseRoughnessTextureEnabled(){return this._BaseDiffuseRoughnessTextureEnabled}static set BaseDiffuseRoughnessTextureEnabled(e){this._BaseDiffuseRoughnessTextureEnabled!==e&&(this._BaseDiffuseRoughnessTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_FresnelDirtyFlag));}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get TranslucencyIntensityTextureEnabled(){return this._TranslucencyIntensityTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get TranslucencyColorTextureEnabled(){return this._TranslucencyColorTextureEnabled}static set TranslucencyColorTextureEnabled(e){this._TranslucencyColorTextureEnabled!==e&&(this._TranslucencyColorTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,jt.MarkAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}}bs._DiffuseTextureEnabled=true,bs._BaseWeightTextureEnabled=true,bs._BaseDiffuseRoughnessTextureEnabled=true,bs._DetailTextureEnabled=true,bs._DecalMapEnabled=true,bs._AmbientTextureEnabled=true,bs._OpacityTextureEnabled=true,bs._ReflectionTextureEnabled=true,bs._EmissiveTextureEnabled=true,bs._SpecularTextureEnabled=true,bs._BumpTextureEnabled=true,bs._LightmapTextureEnabled=true,bs._RefractionTextureEnabled=true,bs._ColorGradingTextureEnabled=true,bs._FresnelEnabled=true,bs._ClearCoatTextureEnabled=true,bs._ClearCoatBumpTextureEnabled=true,bs._ClearCoatTintTextureEnabled=true,bs._SheenTextureEnabled=true,bs._AnisotropicTextureEnabled=true,bs._ThicknessTextureEnabled=true,bs._RefractionIntensityTextureEnabled=true,bs._TranslucencyIntensityTextureEnabled=true,bs._TranslucencyColorTextureEnabled=true,bs._IridescenceTextureEnabled=true;class Ss{constructor(e,t){this.width=e,this.height=t;}toString(){return `{W: ${this.width}, H: ${this.height}}`}getClassName(){return "Size"}getHashCode(){let e=0|this.width;return e=397*e^this.height,e}copyFrom(e){this.width=e.width,this.height=e.height;}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new Ss(this.width*e,this.height*t)}clone(){return new Ss(this.width,this.height)}equals(e){return !!e&&(this.width===e.width&&this.height===e.height)}get surface(){return this.width*this.height}static Zero(){return new Ss(0,0)}add(e){return new Ss(this.width+e.width,this.height+e.height)}subtract(e){return new Ss(this.width-e.width,this.height-e.height)}scale(e){return new Ss(this.width*e,this.height*e)}static Lerp(e,t,i){const s=e.width+(t.width-e.width)*i,r=e.height+(t.height-e.height)*i;return new Ss(s,r)}}class xs{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e;}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e;}get coordinatesMode(){return 0}get isCube(){return !!this._texture&&this._texture.isCube}set isCube(e){this._texture&&(this._texture.isCube=e);}get is3D(){return !!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e);}get is2DArray(){return !!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e);}getClassName(){return "ThinTexture"}static _IsRenderTargetWrapper(e){return void 0!==e?.shareDepth}constructor(e){this._wrapU=Qe$1.TEXTURE_WRAP_ADDRESSMODE,this._wrapV=Qe$1.TEXTURE_WRAP_ADDRESSMODE,this.wrapR=Qe$1.TEXTURE_WRAP_ADDRESSMODE,this.anisotropicFilteringLevel=4,this.delayLoadState=Qe$1.DELAYLOADSTATE_NONE,this._texture=null,this._engine=null,this._cachedSize=Ss.Zero(),this._cachedBaseSize=Ss.Zero(),this._initialSamplingMode=Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,this._texture=xs._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine(),this.wrapU=this._texture._cachedWrapU??this.wrapU,this.wrapV=this._texture._cachedWrapV??this.wrapV,this.wrapR=this._texture._cachedWrapR??this.wrapR);}isReady(){return this.delayLoadState===Qe$1.DELAYLOADSTATE_NOTLOADED?(this.delayLoad(),false):!!this._texture&&this._texture.isReady}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return this.isReady()&&this._texture?this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize):(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e,t=false){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture,this._texture.generateMipMaps&&t);}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null);}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null);}}class Ms extends xs{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>e.hasTexture(this))));}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>e.hasTexture(this))));}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>e.hasTexture(this))));}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>e.hasTexture(this))));}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e;}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e;}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e;}get is3D(){return !!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e);}get is2DArray(){return !!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e);}get gammaSpace(){return this._texture?(null===this._texture._gammaSpace&&(this._texture._gammaSpace=this._gammaSpace),this._texture._gammaSpace&&!this._texture._useSRGBBuffer):this._gammaSpace}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e;}else {if(this._gammaSpace===e)return;this._gammaSpace=e;}this.getScene()?.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>e.hasTexture(this)));}get isRGBD(){return null!=this._texture&&this._texture._isRGBD}set isRGBD(e){e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),this.getScene()?.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>e.hasTexture(this))));}get noMipmap(){return  false}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e);}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e);}get linearSpecularLOD(){return !!this._texture&&this._texture._linearSpecularLOD}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e);}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e);}get uid(){return this._uid||(this._uid=_i()),this._uid}toString(){return this.name}getClassName(){return "BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e);}get isBlocking(){return  true}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=false,this._getAlphaFromRGB=false,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=true,this._coordinatesMode=Qe$1.TEXTURE_EXPLICIT_MODE,this.wrapR=Qe$1.TEXTURE_WRAP_ADDRESSMODE,this.anisotropicFilteringLevel=Ms.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=false,this._gammaSpace=true,this.invertZ=false,this.lodLevelInAlpha=false,this._dominantDirection=null,this.isRenderTarget=false,this._prefiltered=false,this._forceSerialize=false,this.animations=[],this.onDisposeObservable=new R$g,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=false,e?Ms._IsScene(e)?this._scene=e:this._engine=e:this._scene=L$7.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null;}getScene(){return this._scene}_getEngine(){return this._engine}getTextureMatrix(){return re$5.IdentityReadOnly}getReflectionTextureMatrix(){return re$5.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return !this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return  false}_getFromCache(e,t,i,s,r,n){const a=this._getEngine();if(!a)return null;const o=a._getUseSRGBBuffer(!!r,t),h=a.getLoadedTexturesCache();for(let a=0;a<h.length;a++){const l=h[a];if(!(void 0!==r&&o!==l._useSRGBBuffer||void 0!==s&&s!==l.invertY||l.url!==e||l.generateMipMaps!==!t||i&&i!==l.samplingMode||void 0!==n&&n!==l.isCube))return l.incrementReferences(),l}return null}_rebuild(e=false){}clone(){return null}get textureType(){return this._texture&&void 0!==this._texture.type?this._texture.type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE}get textureFormat(){return this._texture&&void 0!==this._texture.format?this._texture.format:Qe$1.TEXTUREFORMAT_RGBA}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}readPixels(e=0,t=0,i=null,s=true,r=false,n=0,a=0,o=Number.MAX_VALUE,h=Number.MAX_VALUE){if(!this._texture)return null;const l=this._getEngine();if(!l)return null;const c=this.getSize();let u=c.width,d=c.height;0!==t&&(u/=Math.pow(2,t),d/=Math.pow(2,t),u=Math.round(u),d=Math.round(d)),o=Math.min(u,o),h=Math.min(d,h);try{return this._texture.isCube?l._readTexturePixels(this._texture,o,h,e,t,i,s,r,n,a):l._readTexturePixels(this._texture,o,h,-1,t,i,s,r,n,a)}catch(e){return null}}_readPixelsSync(e=0,t=0,i=null,s=true,r=false){if(!this._texture)return null;const n=this.getSize();let a=n.width,o=n.height;const h=this._getEngine();if(!h)return null;0!=t&&(a/=Math.pow(2,t),o/=Math.pow(2,t),a=Math.round(a),o=Math.round(o));try{return this._texture.isCube?h._readTexturePixelsSync(this._texture,a,o,e,t,i,s,r):h._readTexturePixelsSync(this._texture,a,o,-1,t,i,s,r)}catch(e){return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const e=this._parentContainer.textures.indexOf(this);e>-1&&this._parentContainer.textures.splice(e,1),this._parentContainer=null;}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose();}serialize(e=false){if(!this.name&&!e)return null;const t=Ae$3.Serialize(this);return Ae$3.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(0!==i)for(let s=0;s<e.length;s++){const r=e[s];if(r.isReady())0===--i&&t();else {const e=r.onLoadObservable;e?e.addOnce((()=>{0===--i&&t();})):0===--i&&t();}}else t();}static _IsScene(e){return "Scene"===e.getClassName()}}function ys(e,t,i=false){const s=t.width,r=t.height;if(e instanceof Float32Array){let t=e.byteLength/e.BYTES_PER_ELEMENT;const i=new Uint8Array(t);for(;--t>=0;){let s=e[t];s<0?s=0:s>1&&(s=1),i[t]=255*s;}e=i;}const n=document.createElement("canvas");n.width=s,n.height=r;const a=n.getContext("2d");if(!a)return null;const o=a.createImageData(s,r);if(o.data.set(e),a.putImageData(o,0,0),i){const e=document.createElement("canvas");e.width=s,e.height=r;const t=e.getContext("2d");return t?(t.translate(0,r),t.scale(1,-1),t.drawImage(n,0,0),e.toDataURL("image/png")):null}return n.toDataURL("image/png")}Ms.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,e$z([a$$()],Ms.prototype,"uniqueId",void 0),e$z([a$$()],Ms.prototype,"name",void 0),e$z([a$$()],Ms.prototype,"displayName",void 0),e$z([a$$()],Ms.prototype,"metadata",void 0),e$z([a$$("hasAlpha")],Ms.prototype,"_hasAlpha",void 0),e$z([a$$("getAlphaFromRGB")],Ms.prototype,"_getAlphaFromRGB",void 0),e$z([a$$()],Ms.prototype,"level",void 0),e$z([a$$("coordinatesIndex")],Ms.prototype,"_coordinatesIndex",void 0),e$z([a$$()],Ms.prototype,"optimizeUVAllocation",void 0),e$z([a$$("coordinatesMode")],Ms.prototype,"_coordinatesMode",void 0),e$z([a$$()],Ms.prototype,"wrapU",null),e$z([a$$()],Ms.prototype,"wrapV",null),e$z([a$$()],Ms.prototype,"wrapR",void 0),e$z([a$$()],Ms.prototype,"anisotropicFilteringLevel",void 0),e$z([a$$()],Ms.prototype,"isCube",null),e$z([a$$()],Ms.prototype,"is3D",null),e$z([a$$()],Ms.prototype,"is2DArray",null),e$z([a$$()],Ms.prototype,"gammaSpace",null),e$z([a$$()],Ms.prototype,"invertZ",void 0),e$z([a$$()],Ms.prototype,"lodLevelInAlpha",void 0),e$z([a$$()],Ms.prototype,"lodGenerationOffset",null),e$z([a$$()],Ms.prototype,"lodGenerationScale",null),e$z([a$$()],Ms.prototype,"linearSpecularLOD",null),e$z([o$19()],Ms.prototype,"irradianceTexture",null),e$z([a$$()],Ms.prototype,"isRenderTarget",void 0);class Is extends Ms{static _CreateVideoTexture(e,t,i,s=false,r=false,n=Is.TRILINEAR_SAMPLINGMODE,a={},o,h=Qe$1.TEXTUREFORMAT_RGBA){throw le$4("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e;}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,s,r=Is.TRILINEAR_SAMPLINGMODE,n=null,a=null,o=null,h=false,l,c,u,d,_){let f;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=false,this.inspectableCustomProperties=null,this._noMipmap=false,this._invertY=false,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=false,this._cachedIdentity3x2=true,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=false,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new R$g,this._isBlocking=true,this.name=e||"",this.url=e;let p=false,g=null,m=true;"object"==typeof i&&null!==i?(f=i.noMipmap??false,s=i.invertY??true,r=i.samplingMode??Is.TRILINEAR_SAMPLINGMODE,n=i.onLoad??null,a=i.onError??null,o=i.buffer??null,h=i.deleteBuffer??false,l=i.format,c=i.mimeType,u=i.loaderOptions,d=i.creationFlags,p=i.useSRGBBuffer??false,g=i.internalTexture??null,m=i.gammaSpace??m,_=i.forcedExtension??_):f=!!i,this._gammaSpace=m,this._noMipmap=f,this._invertY=void 0===s||s,this._initialSamplingMode=r,this._buffer=o,this._deleteBuffer=h,this._mimeType=c,this._loaderOptions=u,this._creationFlags=d,this._useSRGBBuffer=p,this._forcedExtension=_,void 0!==l&&(this._format=l);const T=this.getScene(),E=this._getEngine();if(!E)return;E.onBeforeTextureInitObservable.notifyObservers(this);const A=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),null!==this._texture._cachedWrapU&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),null!==this._texture._cachedWrapV&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),null!==this._texture._cachedWrapR&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),n&&n(),!this.isBlocking&&T&&T.resetCachedMaterial();},b=(e,t)=>{this._loadingError=true,this._errorObject={message:e,exception:t},a&&a(e,t),Is.OnTextureLoadErrorObservable.notifyObservers(this);};if(!this.url&&!g)return this._delayedOnLoad=A,void(this._delayedOnError=b);if(this._texture=g??this._getFromCache(this.url,f,r,this._invertY,p,this.isCube),this._texture)if(this._texture.isReady)Et$1.SetImmediate((()=>A()));else {const e=this._texture.onLoadedObservable.add(A);this._texture.onErrorObservable.add((t=>{b(t.message,t.exception),this._texture?.onLoadedObservable.remove(e);}));}else if(T&&T.useDelayedTextureLoading)this.delayLoadState=Qe$1.DELAYLOADSTATE_NOTLOADED,this._delayedOnLoad=A,this._delayedOnError=b;else {try{this._texture=E.createTexture(this.url,f,this._invertY,T,r,A,b,this._buffer,void 0,this._format,this._forcedExtension,c,u,d,p);}catch(e){throw b("error loading",e),e}h&&(this._buffer=null);}}updateURL(e,t=null,i,s){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>e.hasTexture(this)))),this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=s,this.delayLoadState=Qe$1.DELAYLOADSTATE_NOTLOADED;const r=this._delayedOnLoad;this._delayedOnLoad=()=>{r?r():this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),i&&i();},this.delayLoad();}delayLoad(){if(this.delayLoadState!==Qe$1.DELAYLOADSTATE_NOTLOADED)return;const e=this.getScene();if(!e)return;let t=this.url;!t&&(this.name.indexOf("://")>0||this.name.startsWith("data:"))&&(t=this.name),this.delayLoadState=Qe$1.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(t,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?Et$1.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(t,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null;}_prepareRowForTextureGeneration(e,t,i,s){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,te$4.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,s),s.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,s.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,s.z+=this.wRotationCenter;}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,this._cachedTextureMatrix&&this._rowGenerationMatrix||(this._cachedTextureMatrix=re$5.Zero(),this._rowGenerationMatrix=new re$5,this._t0=te$4.Zero(),this._t1=te$4.Zero(),this._t2=te$4.Zero()),re$5.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(re$5.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,ae$5.Matrix[0]),re$5.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,ae$5.Matrix[1]),re$5.ScalingToRef(this._cachedUScale,this._cachedVScale,0,ae$5.Matrix[2]),re$5.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,ae$5.Matrix[3]),ae$5.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(ae$5.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(ae$5.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(ae$5.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),re$5.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();if(!t)return this._cachedTextureMatrix;const i=this._cachedIdentity3x2;return this._cachedIdentity3x2=this._cachedTextureMatrix.isIdentityAs3x2(),this.optimizeUVAllocation&&i!==this._cachedIdentity3x2&&t.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>e.hasTexture(this))),this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode){if(this.coordinatesMode!==Is.PROJECTION_MODE)return this._cachedReflectionTextureMatrix;if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=re$5.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=re$5.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case Is.PLANAR_MODE:re$5.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break;case Is.PROJECTION_MODE:{re$5.FromValuesToRef(.5,0,0,0,0,-0.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const t=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=t.updateFlag,t.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:re$5.IdentityToRef(this._cachedReflectionTextureMatrix);}return t&&e.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>e.hasTexture(this))),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return Ae$3.Clone((()=>new Is(this._texture?this._texture.url:null,this.getScene(),e)),this)}serialize(){const e=this.name;Is.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const t=super.serialize(Is._SerializeInternalTextureUniqueId);if(!t)return null;if(Is.SerializeBuffers||Is.ForceSerializeBuffers)if("string"==typeof this._buffer&&this._buffer.startsWith("data:"))t.base64String=this._buffer,t.name=t.name.replace("data:","");else if(this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array){const e=this.mimeType||"image/png";t.base64String=`data:${e};base64,${Ue$2(this._buffer)}`;}else (Is.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(t.base64String=!this._engine||this._engine._features.supportSyncTextureRead?function(e,t=0,i=0){const s=e.getInternalTexture();if(!s)return null;const r=e._readPixelsSync(t,i);return r?ys(r,e.getSize(),s.invertY):null}(this):async function(e,t=0,i=0){const s=e.getInternalTexture();if(!s)return null;const r=await e.readPixels(t,i);return r?ys(r,e.getSize(),s.invertY):null}(this));return t.invertY=this._invertY,t.samplingMode=this.samplingMode,t._creationFlags=this._creationFlags,t._useSRGBBuffer=this._useSRGBBuffer,Is._SerializeInternalTextureUniqueId&&(t.internalTextureUniqueId=this._texture?.uniqueId),t.internalTextureLabel=this._texture?.label,t.noMipmap=this._noMipmap,this.name=e,t}getClassName(){return "Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null;}static Parse(e,t,i){if(e.customType){const s=di.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&s.updateSamplingMode&&s._samplingMode&&s._samplingMode!==e.samplingMode&&s.updateSamplingMode(e.samplingMode),s}if(e.isCube&&!e.isRenderTarget)return Is._CubeTextureParser(e,t,i);const s=void 0!==e.internalTextureUniqueId;if(!e.name&&!e.isRenderTarget&&!s)return null;let r;if(s){const i=t.getEngine().getLoadedTexturesCache();for(const t of i)if(t.uniqueId===e.internalTextureUniqueId){r=t;break}}const n=t=>{if(t&&t._texture&&(t._texture._cachedWrapU=null,t._texture._cachedWrapV=null,t._texture._cachedWrapR=null),e.samplingMode){const i=e.samplingMode;t&&t.samplingMode!==i&&t.updateSamplingMode(i);}if(t&&e.animations)for(let i=0;i<e.animations.length;i++){const s=e.animations[i],r=O$g("BABYLON.Animation");r&&t.animations.push(r.Parse(s));}t&&t._texture&&(s&&!r&&t._texture._setUniqueId(e.internalTextureUniqueId),t._texture.label=e.internalTextureLabel);},a=Ae$3.Parse((()=>{let s=true;if(e.noMipmap&&(s=false),e.mirrorPlane){const i=Is._CreateMirror(e.name,e.renderTargetSize,t,s);return i._waitingRenderList=e.renderList,i.mirrorPlane=Pi.FromArray(e.mirrorPlane),n(i),i}if(e.isRenderTarget&&!e.base64String){let i=null;if(e.isCube){if(t.reflectionProbes)for(let i=0;i<t.reflectionProbes.length;i++){const s=t.reflectionProbes[i];if(s.name===e.name)return s.cubeTexture}}else i=Is._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,s,e._creationFlags??0),i._waitingRenderList=e.renderList;return n(i),i}if(e.isVideo){const r=Is._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),t,s,e.invertY,e.samplingMode,e.settings||{});return n(r),r}{let a;if(e.base64String&&!r)a=Is.CreateFromBase64String(e.base64String,e.base64String,t,!s,e.invertY,e.samplingMode,(()=>{n(a);}),e._creationFlags??0,e._useSRGBBuffer??false),a.name=e.name;else {let o;o=e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?e.name:i+e.name,e.url&&(e.url.startsWith("data:")||Is.UseSerializedUrlIfAny)&&(o=e.url);const h={noMipmap:!s,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{n(a);},internalTexture:r};a=new Is(o,t,h);}return a}}),e,t);return a}static CreateFromBase64String(e,t,i,s,r,n=Is.TRILINEAR_SAMPLINGMODE,a=null,o=null,h=Qe$1.TEXTUREFORMAT_RGBA,l,c){return new Is("data:"+t,i,s,r,n,a,o,e,false,h,void 0,void 0,l,c)}static LoadFromDataString(e,t,i,s=false,r,n=true,a=Is.TRILINEAR_SAMPLINGMODE,o=null,h=null,l=Qe$1.TEXTUREFORMAT_RGBA,c,u){return "data:"!==e.substring(0,5)&&(e="data:"+e),new Is(e,i,r,n,a,o,h,t,s,l,void 0,void 0,c,u)}}function Cs(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const e=i.activeCamera;e.mode===Qe$1.ORTHOGRAPHIC_CAMERA&&Ie$2.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(e.maxZ+1)/Math.LN2));}}Is.SerializeBuffers=true,Is.ForceSerializeBuffers=false,Is.OnTextureLoadErrorObservable=new R$g,Is._SerializeInternalTextureUniqueId=false,Is._CubeTextureParser=(e,t,i)=>{throw le$4("CubeTexture")},Is._CreateMirror=(e,t,i,s)=>{throw le$4("MirrorTexture")},Is._CreateRenderTargetTexture=(e,t,i,s,r)=>{throw le$4("RenderTargetTexture")},Is.NEAREST_SAMPLINGMODE=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Is.NEAREST_NEAREST_MIPLINEAR=Qe$1.TEXTURE_NEAREST_NEAREST_MIPLINEAR,Is.BILINEAR_SAMPLINGMODE=Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,Is.LINEAR_LINEAR_MIPNEAREST=Qe$1.TEXTURE_LINEAR_LINEAR_MIPNEAREST,Is.TRILINEAR_SAMPLINGMODE=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,Is.LINEAR_LINEAR_MIPLINEAR=Qe$1.TEXTURE_LINEAR_LINEAR_MIPLINEAR,Is.NEAREST_NEAREST_MIPNEAREST=Qe$1.TEXTURE_NEAREST_NEAREST_MIPNEAREST,Is.NEAREST_LINEAR_MIPNEAREST=Qe$1.TEXTURE_NEAREST_LINEAR_MIPNEAREST,Is.NEAREST_LINEAR_MIPLINEAR=Qe$1.TEXTURE_NEAREST_LINEAR_MIPLINEAR,Is.NEAREST_LINEAR=Qe$1.TEXTURE_NEAREST_LINEAR,Is.NEAREST_NEAREST=Qe$1.TEXTURE_NEAREST_NEAREST,Is.LINEAR_NEAREST_MIPNEAREST=Qe$1.TEXTURE_LINEAR_NEAREST_MIPNEAREST,Is.LINEAR_NEAREST_MIPLINEAR=Qe$1.TEXTURE_LINEAR_NEAREST_MIPLINEAR,Is.LINEAR_LINEAR=Qe$1.TEXTURE_LINEAR_LINEAR,Is.LINEAR_NEAREST=Qe$1.TEXTURE_LINEAR_NEAREST,Is.EXPLICIT_MODE=Qe$1.TEXTURE_EXPLICIT_MODE,Is.SPHERICAL_MODE=Qe$1.TEXTURE_SPHERICAL_MODE,Is.PLANAR_MODE=Qe$1.TEXTURE_PLANAR_MODE,Is.CUBIC_MODE=Qe$1.TEXTURE_CUBIC_MODE,Is.PROJECTION_MODE=Qe$1.TEXTURE_PROJECTION_MODE,Is.SKYBOX_MODE=Qe$1.TEXTURE_SKYBOX_MODE,Is.INVCUBIC_MODE=Qe$1.TEXTURE_INVCUBIC_MODE,Is.EQUIRECTANGULAR_MODE=Qe$1.TEXTURE_EQUIRECTANGULAR_MODE,Is.FIXED_EQUIRECTANGULAR_MODE=Qe$1.TEXTURE_FIXED_EQUIRECTANGULAR_MODE,Is.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=Qe$1.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE,Is.CLAMP_ADDRESSMODE=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,Is.WRAP_ADDRESSMODE=Qe$1.TEXTURE_WRAP_ADDRESSMODE,Is.MIRROR_ADDRESSMODE=Qe$1.TEXTURE_MIRROR_ADDRESSMODE,Is.UseSerializedUrlIfAny=false,e$z([a$$()],Is.prototype,"url",void 0),e$z([a$$()],Is.prototype,"uOffset",void 0),e$z([a$$()],Is.prototype,"vOffset",void 0),e$z([a$$()],Is.prototype,"uScale",void 0),e$z([a$$()],Is.prototype,"vScale",void 0),e$z([a$$()],Is.prototype,"uAng",void 0),e$z([a$$()],Is.prototype,"vAng",void 0),e$z([a$$()],Is.prototype,"wAng",void 0),e$z([a$$()],Is.prototype,"uRotationCenter",void 0),e$z([a$$()],Is.prototype,"vRotationCenter",void 0),e$z([a$$()],Is.prototype,"wRotationCenter",void 0),e$z([a$$()],Is.prototype,"homogeneousRotationInUVTransform",void 0),e$z([a$$()],Is.prototype,"isBlocking",null),P$9("BABYLON.Texture",Is),Ae$3._TextureParser=Is.Parse;const vs={r:0,g:0,b:0},Ps={NUM_MORPH_INFLUENCERS:0,NORMAL:false,TANGENT:false,UV:false,UV2:false,COLOR:false};function Os(e,t,i,s=false){i&&e.fogEnabled&&(!t||t.applyFog)&&e.fogMode!==Qe$1.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),s?(e.fogColor.toLinearSpaceToRef(vs,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",vs)):i.setColor3("vFogColor",e.fogColor));}function Ds(e,t,i,s,r,n,a,o,h,l){const c=e.numMaxInfluencers||e.numInfluencers;return c<=0?0:(t.push("#define MORPHTARGETS"),e.hasPositions&&t.push("#define MORPHTARGETTEXTURE_HASPOSITIONS"),e.hasNormals&&t.push("#define MORPHTARGETTEXTURE_HASNORMALS"),e.hasTangents&&t.push("#define MORPHTARGETTEXTURE_HASTANGENTS"),e.hasUVs&&t.push("#define MORPHTARGETTEXTURE_HASUVS"),e.hasUV2s&&t.push("#define MORPHTARGETTEXTURE_HASUV2S"),e.hasColors&&t.push("#define MORPHTARGETTEXTURE_HASCOLORS"),e.supportsPositions&&r&&t.push("#define MORPHTARGETS_POSITION"),e.supportsNormals&&n&&t.push("#define MORPHTARGETS_NORMAL"),e.supportsTangents&&a&&t.push("#define MORPHTARGETS_TANGENT"),e.supportsUVs&&o&&t.push("#define MORPHTARGETS_UV"),e.supportsUV2s&&h&&t.push("#define MORPHTARGETS_UV2"),e.supportsColors&&l&&t.push("#define MORPHTARGETS_COLOR"),t.push("#define NUM_MORPH_INFLUENCERS "+c),e.isUsingTextureForTargets&&t.push("#define MORPHTARGETS_TEXTURE"),Ps.NUM_MORPH_INFLUENCERS=c,Ps.NORMAL=n,Ps.TANGENT=a,Ps.UV=o,Ps.UV2=h,Ps.COLOR=l,Ls(i,s,Ps,r),c)}function Ls(e,t,i,s=true){const r=i.NUM_MORPH_INFLUENCERS;if(r>0&&L$7.LastCreatedEngine){const n=L$7.LastCreatedEngine.getCaps().maxVertexAttribs,a=t.morphTargetManager;if(a?.isUsingTextureForTargets)return;const o=a&&a.supportsPositions&&s,h=a&&a.supportsNormals&&i.NORMAL,l=a&&a.supportsTangents&&i.TANGENT,c=a&&a.supportsUVs&&i.UV1,u=a&&a.supportsUV2s&&i.UV2,d=a&&a.supportsColors&&i.VERTEXCOLOR;for(let i=0;i<r;i++)o&&e.push(Qe$1.PositionKind+i),h&&e.push(Qe$1.NormalKind+i),l&&e.push(Qe$1.TangentKind+i),c&&e.push(Qe$1.UVKind+"_"+i),u&&e.push(Qe$1.UV2Kind+"_"+i),d&&e.push(Qe$1.ColorKind+i),e.length>n&&Ie$2.Error("Cannot add more vertex attributes for mesh "+t.name);}}function Fs(e,t=false){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"));}function ws(e,t){const i=e.morphTargetManager;e&&i&&t.setFloatArray("morphTargetInfluences",i.influences);}function Ns(e,t){t.bindToEffect(e,"Scene");}function Bs(e,t,i,s,r=null,n=false,a=false,o=false,h=false,l=false,c=false,u=0){if(e.texturesEnabled&&r&&bs.ReflectionTextureEnabled){if(i.updateMatrix("reflectionMatrix",r.getReflectionTextureMatrix()),i.updateFloat2("vReflectionInfos",r.level*e.iblIntensity,u),o&&r.boundingBoxSize){const e=r;i.updateVector3("vReflectionPosition",e.boundingBoxPosition),i.updateVector3("vReflectionSize",e.boundingBoxSize);}if(n){const e=r.getSize().width;i.updateFloat2("vReflectionFilteringInfo",e,Math.log2(e));}if(l&&!t.USEIRRADIANCEMAP){const e=r.sphericalPolynomial;if(t.USESPHERICALFROMREFLECTIONMAP&&e)if(t.SPHERICAL_HARMONICS){const t=e.preScaledHarmonics;i.updateVector3("vSphericalL00",t.l00),i.updateVector3("vSphericalL1_1",t.l1_1),i.updateVector3("vSphericalL10",t.l10),i.updateVector3("vSphericalL11",t.l11),i.updateVector3("vSphericalL2_2",t.l2_2),i.updateVector3("vSphericalL2_1",t.l2_1),i.updateVector3("vSphericalL20",t.l20),i.updateVector3("vSphericalL21",t.l21),i.updateVector3("vSphericalL22",t.l22);}else i.updateFloat3("vSphericalX",e.x.x,e.x.y,e.x.z),i.updateFloat3("vSphericalY",e.y.x,e.y.y,e.y.z),i.updateFloat3("vSphericalZ",e.z.x,e.z.y,e.z.z),i.updateFloat3("vSphericalXX_ZZ",e.xx.x-e.zz.x,e.xx.y-e.zz.y,e.xx.z-e.zz.z),i.updateFloat3("vSphericalYY_ZZ",e.yy.x-e.zz.x,e.yy.y-e.zz.y,e.yy.z-e.zz.z),i.updateFloat3("vSphericalZZ",e.zz.x,e.zz.y,e.zz.z),i.updateFloat3("vSphericalXY",e.xy.x,e.xy.y,e.xy.z),i.updateFloat3("vSphericalYZ",e.yz.x,e.yz.y,e.yz.z),i.updateFloat3("vSphericalZX",e.zx.x,e.zx.y,e.zx.z);}else h&&t.USEIRRADIANCEMAP&&t.USE_IRRADIANCE_DOMINANT_DIRECTION&&i.updateVector3("vReflectionDominantDirection",r.irradianceTexture._dominantDirection);a&&i.updateFloat3("vReflectionMicrosurfaceInfos",r.getSize().width,r.lodGenerationScale,r.lodGenerationOffset);}c&&i.updateColor3("vReflectionColor",s);}function Us(e,t,i,s=null,r=false){if(s&&bs.ReflectionTextureEnabled){t.LODBASEDMICROSFURACE?i.setTexture("reflectionSampler",s):(i.setTexture("reflectionSampler",s._lodTextureMid||s),i.setTexture("reflectionSamplerLow",s._lodTextureLow||s),i.setTexture("reflectionSamplerHigh",s._lodTextureHigh||s)),t.USEIRRADIANCEMAP&&i.setTexture("irradianceSampler",s.irradianceTexture);const n=e.iblCdfGenerator;r&&n&&i.setTexture("icdfSampler",n.getIcdfTexture());}}function ks(e,t,i){t._needUVs=true,t[i]=true,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=true):t[i+"DIRECTUV"]=0;}function Gs(e,t,i){const s=e.getTextureMatrix();t.updateMatrix(i+"Matrix",s);}function Vs(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced");}function Hs(e,t,i){var s;if(t&&e&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=false),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const r=e.skeleton;if(r.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const i=r.getTransformMatrixTexture(e);t.setTexture("boneSampler",i),t.setFloat("boneTextureWidth",4*(r.bones.length+1));}else {const n=r.getTransformMatrices(e);n&&(t.setMatrices("mBones",n),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(Qe$1.PREPASS_VELOCITY_TEXTURE_TYPE)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=n.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),s=n,i.previousBones[e.uniqueId].set(s)));}}}function zs(e,t,i,s,r,n=true){e._bindLight(t,i,s,r,n);}function Xs(e,t,i,s,r=4){const n=Math.min(t.lightSources.length,r);for(let r=0;r<n;r++){zs(t.lightSources[r],r,e,i,"boolean"==typeof s?s:s.SPECULARTERM,t.receiveShadows);}}function Ws(e,t,i,s){i.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,t),e.push(Qe$1.MatricesIndicesKind),e.push(Qe$1.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(Qe$1.MatricesIndicesExtraKind),e.push(Qe$1.MatricesWeightsExtraKind)));}function Ys(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&Fs(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(Qe$1.ColorInstanceKind);}function Ks(e,t,i=4,s=0){let r=0;for(let n=0;n<i&&e["LIGHT"+n];n++)n>0&&(r=s+n,t.addFallback(r,"LIGHT"+n)),e.SHADOWS||(e["SHADOW"+n]&&t.addFallback(s,"SHADOW"+n),e["SHADOWPCF"+n]&&t.addFallback(s,"SHADOWPCF"+n),e["SHADOWPCSS"+n]&&t.addFallback(s,"SHADOWPCSS"+n),e["SHADOWPOISSON"+n]&&t.addFallback(s,"SHADOWPOISSON"+n),e["SHADOWESM"+n]&&t.addFallback(s,"SHADOWESM"+n),e["SHADOWCLOSEESM"+n]&&t.addFallback(s,"SHADOWCLOSEESM"+n));return r++}function js(e,t,i,s,r,n,a,o=false,h=false,l,c){if(a._areMiscDirty){a.LOGARITHMICDEPTH=i,a.POINTSIZE=s,a.FOG=r&&function(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==Qe$1.FOGMODE_NONE}(e,t),a.NONUNIFORMSCALING=e.nonUniformScaling,a.ALPHATEST=n,a.DECAL_AFTER_DETAIL=o,a.USE_VERTEX_PULLING=h;const u=l?.geometry?.getIndexBuffer();a.VERTEX_PULLING_USE_INDEX_BUFFER=!!u,a.VERTEX_PULLING_INDEX_BUFFER_32BITS=!!u&&u.is32Bits,a.VERTEXOUTPUT_INVARIANT=!!c;}}function Qs(e,t,i,s,r=4,n=false){if(!i._areLightsDirty)return i._needNormals;let a=0;const o={needNormals:i._needNormals,needRebuild:false,lightmapMode:false,shadowEnabled:false,specularEnabled:false};if(e.lightsEnabled&&!n)for(const n of t.lightSources)if(Zs(e,t,n,a,i,s,o),a++,a===r)break;i.SPECULARTERM=o.specularEnabled,i.SHADOWS=o.shadowEnabled;const h=Math.max(r,i.MAXLIGHTCOUNT||0);for(let e=a;e<h;e++) void 0!==i["LIGHT"+e]&&(i["LIGHT"+e]=false,i["HEMILIGHT"+e]=false,i["POINTLIGHT"+e]=false,i["DIRLIGHT"+e]=false,i["SPOTLIGHT"+e]=false,i["AREALIGHT"+e]=false,i["CLUSTLIGHT"+e]=false,i["SHADOW"+e]=false,i["SHADOWCSM"+e]=false,i["SHADOWCSMDEBUG"+e]=false,i["SHADOWCSMNUM_CASCADES"+e]=false,i["SHADOWCSMUSESHADOWMAXZ"+e]=false,i["SHADOWCSMNOBLEND"+e]=false,i["SHADOWCSM_RIGHTHANDED"+e]=false,i["SHADOWPCF"+e]=false,i["SHADOWPCSS"+e]=false,i["SHADOWPOISSON"+e]=false,i["SHADOWESM"+e]=false,i["SHADOWCLOSEESM"+e]=false,i["SHADOWCUBE"+e]=false,i["SHADOWLOWQUALITY"+e]=false,i["SHADOWMEDIUMQUALITY"+e]=false);i.MAXLIGHTCOUNT=r;const l=e.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(o.needRebuild=true),i.SHADOWFLOAT=o.shadowEnabled&&(l.textureFloatRender&&l.textureFloatLinearFiltering||l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=o.lightmapMode,o.needRebuild&&i.rebuild(),o.needNormals}function qs(e,t,i,s=false,r=Qe$1.TEXTURE_FILTERING_QUALITY_LOW,n=false){if(t&&bs.ReflectionTextureEnabled){if(!t.isReadyOrNotBlocking())return  false;i._needNormals=true,i.REFLECTION=true,i.GAMMAREFLECTION=t.gammaSpace,i.RGBDREFLECTION=t.isRGBD,i.LODINREFLECTIONALPHA=t.lodLevelInAlpha,i.LINEARSPECULARREFLECTION=t.linearSpecularLOD,i.USEIRRADIANCEMAP=false;const a=e.getEngine();switch(s&&r>0?(i.NUM_SAMPLES=""+r,a._features.needTypeSuffixInShaderConstants&&(i.NUM_SAMPLES=i.NUM_SAMPLES+"u"),i.REALTIME_FILTERING=true,e.iblCdfGenerator&&(i.IBL_CDF_FILTERING=true)):i.REALTIME_FILTERING=false,i.INVERTCUBICMAP=t.coordinatesMode===Is.INVCUBIC_MODE,i.REFLECTIONMAP_3D=t.isCube,i.REFLECTIONMAP_OPPOSITEZ=i.REFLECTIONMAP_3D&&e.useRightHandedSystem?!t.invertZ:t.invertZ,i.REFLECTIONMAP_CUBIC=false,i.REFLECTIONMAP_EXPLICIT=false,i.REFLECTIONMAP_PLANAR=false,i.REFLECTIONMAP_PROJECTION=false,i.REFLECTIONMAP_SKYBOX=false,i.REFLECTIONMAP_SPHERICAL=false,i.REFLECTIONMAP_EQUIRECTANGULAR=false,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false,t.coordinatesMode){case Is.EXPLICIT_MODE:i.REFLECTIONMAP_EXPLICIT=true;break;case Is.PLANAR_MODE:i.REFLECTIONMAP_PLANAR=true;break;case Is.PROJECTION_MODE:i.REFLECTIONMAP_PROJECTION=true;break;case Is.SKYBOX_MODE:i.REFLECTIONMAP_SKYBOX=true;break;case Is.SPHERICAL_MODE:i.REFLECTIONMAP_SPHERICAL=true;break;case Is.EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR=true;break;case Is.FIXED_EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=true;break;case Is.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=true;break;case Is.CUBIC_MODE:case Is.INVCUBIC_MODE:default:i.REFLECTIONMAP_CUBIC=true,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!!t.boundingBoxSize;}t.coordinatesMode!==Is.SKYBOX_MODE&&(t.irradianceTexture?(i.USEIRRADIANCEMAP=true,i.USESPHERICALFROMREFLECTIONMAP=false,i.USESPHERICALINVERTEX=false,t.irradianceTexture._dominantDirection&&(i.USE_IRRADIANCE_DOMINANT_DIRECTION=true)):t.isCube&&(i.USESPHERICALFROMREFLECTIONMAP=true,i.USEIRRADIANCEMAP=false,i.USE_IRRADIANCE_DOMINANT_DIRECTION=false,i.USESPHERICALINVERTEX=n));}else i.REFLECTION=false,i.REFLECTIONMAP_3D=false,i.REFLECTIONMAP_SPHERICAL=false,i.REFLECTIONMAP_PLANAR=false,i.REFLECTIONMAP_CUBIC=false,i.USE_LOCAL_REFLECTIONMAP_CUBIC=false,i.REFLECTIONMAP_PROJECTION=false,i.REFLECTIONMAP_SKYBOX=false,i.REFLECTIONMAP_EXPLICIT=false,i.REFLECTIONMAP_EQUIRECTANGULAR=false,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false,i.INVERTCUBICMAP=false,i.USESPHERICALFROMREFLECTIONMAP=false,i.USEIRRADIANCEMAP=false,i.USE_IRRADIANCE_DOMINANT_DIRECTION=false,i.USESPHERICALINVERTEX=false,i.REFLECTIONMAP_OPPOSITEZ=false,i.LODINREFLECTIONALPHA=false,i.GAMMAREFLECTION=false,i.RGBDREFLECTION=false,i.LINEARSPECULARREFLECTION=false;return  true}function Zs(e,t,i,s,r,n,a){switch(a.needNormals=true,void 0===r["LIGHT"+s]&&(a.needRebuild=true),r["LIGHT"+s]=true,r["SPOTLIGHT"+s]=false,r["HEMILIGHT"+s]=false,r["POINTLIGHT"+s]=false,r["DIRLIGHT"+s]=false,r["AREALIGHT"+s]=false,r["CLUSTLIGHT"+s]=false,i.prepareLightSpecificDefines(r,s),r["LIGHT_FALLOFF_PHYSICAL"+s]=false,r["LIGHT_FALLOFF_GLTF"+s]=false,r["LIGHT_FALLOFF_STANDARD"+s]=false,i.falloffType){case ms.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+s]=true;break;case ms.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+s]=true;break;case ms.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+s]=true;}if(n&&!i.specular.equalsFloats(0,0,0)&&(a.specularEnabled=true),r["SHADOW"+s]=false,r["SHADOWCSM"+s]=false,r["SHADOWCSMDEBUG"+s]=false,r["SHADOWCSMNUM_CASCADES"+s]=false,r["SHADOWCSMUSESHADOWMAXZ"+s]=false,r["SHADOWCSMNOBLEND"+s]=false,r["SHADOWCSM_RIGHTHANDED"+s]=false,r["SHADOWPCF"+s]=false,r["SHADOWPCSS"+s]=false,r["SHADOWPOISSON"+s]=false,r["SHADOWESM"+s]=false,r["SHADOWCLOSEESM"+s]=false,r["SHADOWCUBE"+s]=false,r["SHADOWLOWQUALITY"+s]=false,r["SHADOWMEDIUMQUALITY"+s]=false,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const t=i.getShadowGenerator(e.activeCamera)??i.getShadowGenerator();if(t){const e=t.getShadowMap();e&&e.renderList&&e.renderList.length>0&&(a.shadowEnabled=true,t.prepareDefines(r,s));}}i.lightmapMode!=ms.LIGHTMAP_DEFAULT?(a.lightmapMode=true,r["LIGHTMAPEXCLUDED"+s]=true,r["LIGHTMAPNOSPECULAR"+s]=i.lightmapMode==ms.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+s]=false,r["LIGHTMAPNOSPECULAR"+s]=false);}function Js(e,t,i,s,r,n=null,a=false){let o=function(e,t){let i=false;if(e.activeCamera){const s=t.CAMERA_ORTHOGRAPHIC?1:0,r=t.CAMERA_PERSPECTIVE?1:0,n=e.activeCamera.mode===Qe$1.ORTHOGRAPHIC_CAMERA?1:0,a=e.activeCamera.mode===Qe$1.PERSPECTIVE_CAMERA?1:0;(s^n||r^a)&&(t.CAMERA_ORTHOGRAPHIC=1===n,t.CAMERA_PERSPECTIVE=1===a,i=true);}return i}(e,s);false!==n&&(o=function(e,t,i){let s=false;const r=!!(e.clipPlane??t.clipPlane),n=!!(e.clipPlane2??t.clipPlane2),a=!!(e.clipPlane3??t.clipPlane3),o=!!(e.clipPlane4??t.clipPlane4),h=!!(e.clipPlane5??t.clipPlane5),l=!!(e.clipPlane6??t.clipPlane6);return i.CLIPPLANE!==r&&(i.CLIPPLANE=r,s=true),i.CLIPPLANE2!==n&&(i.CLIPPLANE2=n,s=true),i.CLIPPLANE3!==a&&(i.CLIPPLANE3=a,s=true),i.CLIPPLANE4!==o&&(i.CLIPPLANE4=o,s=true),i.CLIPPLANE5!==h&&(i.CLIPPLANE5=h,s=true),i.CLIPPLANE6!==l&&(i.CLIPPLANE6=l,s=true),s}(i,e,s)),s.DEPTHPREPASS!==!t.getColorWrite()&&(s.DEPTHPREPASS=!s.DEPTHPREPASS,o=true),s.INSTANCES!==r&&(s.INSTANCES=r,o=true),s.THIN_INSTANCES!==a&&(s.THIN_INSTANCES=a,o=true),o&&s.markAsUnprocessed();}function $s(e,t,i,s,r=false,n=true,a=true){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return  false;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(Qe$1.NormalKind),t._needNormals&&e.isVerticesDataPresent(Qe$1.TangentKind)&&(t.TANGENT=true);for(let i=1;i<=Qe$1.MAX_SUPPORTED_UV_SETS;++i)t["UV"+i]=!!t._needUVs&&e.isVerticesDataPresent(`uv${1===i?"":i}`);if(i){const i=e.useVertexColors&&e.isVerticesDataPresent(Qe$1.ColorKind);t.VERTEXCOLOR=i,t.VERTEXALPHA=e.hasVertexAlpha&&i&&n;}return e.isVerticesDataPresent(Qe$1.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=true),s&&function(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=void 0!==t.BONETEXTURE;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=true;else {t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=!i&&void 0;const s=e.getScene().prePassRenderer;if(s&&s.enabled){const i=-1===s.excludedSkinnedMesh.indexOf(e);t.BONES_VELOCITY_ENABLED=i;}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,void 0!==t.BONETEXTURE&&(t.BONETEXTURE=false);}(e,t),r&&function(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_UV2=i.supportsUV2s&&t.UV2,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS_POSITION=i.supportsPositions,t.MORPHTARGETS_COLOR=i.supportsColors,t.MORPHTARGETTEXTURE_HASUVS=i.hasUVs,t.MORPHTARGETTEXTURE_HASUV2S=i.hasUV2s,t.MORPHTARGETTEXTURE_HASTANGENTS=i.hasTangents,t.MORPHTARGETTEXTURE_HASNORMALS=i.hasNormals,t.MORPHTARGETTEXTURE_HASPOSITIONS=i.hasPositions,t.MORPHTARGETTEXTURE_HASCOLORS=i.hasColors,t.NUM_MORPH_INFLUENCERS=i.numMaxInfluencers||i.numInfluencers,t.MORPHTARGETS=t.NUM_MORPH_INFLUENCERS>0,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=false,t.MORPHTARGETS_UV2=false,t.MORPHTARGETS_TANGENT=false,t.MORPHTARGETS_NORMAL=false,t.MORPHTARGETS_POSITION=false,t.MORPHTARGETS_COLOR=false,t.MORPHTARGETTEXTURE_HASUVS=false,t.MORPHTARGETTEXTURE_HASUV2S=false,t.MORPHTARGETTEXTURE_HASTANGENTS=false,t.MORPHTARGETTEXTURE_HASNORMALS=false,t.MORPHTARGETTEXTURE_HASPOSITIONS=false,t.MORPHTARGETTEXTURE_HAS_COLORS=false,t.MORPHTARGETS=false,t.NUM_MORPH_INFLUENCERS=0);}(e,t),a&&function(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!(!i||!i.isEnabled);}(e,t),true}function er$1(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=null!==e.activeCamera.outputRenderTarget&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed();}}function tr$1(e,t,i){const s=t.ORDER_INDEPENDENT_TRANSPARENCY,r=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,s===t.ORDER_INDEPENDENT_TRANSPARENCY&&r===t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS||t.markAsUnprocessed();}function ir$1(e,t,i){const s=t.PREPASS;if(!t._arePrePassDirty)return;const r=[{type:Qe$1.PREPASS_POSITION_TEXTURE_TYPE,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:Qe$1.PREPASS_LOCAL_POSITION_TEXTURE_TYPE,define:"PREPASS_LOCAL_POSITION",index:"PREPASS_LOCAL_POSITION_INDEX"},{type:Qe$1.PREPASS_VELOCITY_TEXTURE_TYPE,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:Qe$1.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE,define:"PREPASS_VELOCITY_LINEAR",index:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:Qe$1.PREPASS_REFLECTIVITY_TEXTURE_TYPE,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:Qe$1.PREPASS_IRRADIANCE_TEXTURE_TYPE,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:Qe$1.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:Qe$1.PREPASS_DEPTH_TEXTURE_TYPE,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:Qe$1.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE,define:"PREPASS_SCREENSPACE_DEPTH",index:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:Qe$1.PREPASS_NORMAL_TEXTURE_TYPE,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"},{type:Qe$1.PREPASS_WORLD_NORMAL_TEXTURE_TYPE,define:"PREPASS_WORLD_NORMAL",index:"PREPASS_WORLD_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=true,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount,t.PREPASS_NORMAL_WORLDSPACE=e.prePassRenderer.generateNormalsInWorldSpace,t.PREPASS_COLOR=true,t.PREPASS_COLOR_INDEX=0;for(let i=0;i<r.length;i++){const s=e.prePassRenderer.getIndex(r[i].type);-1!==s?(t[r[i].define]=true,t[r[i].index]=s):t[r[i].define]=false;}}else {t.PREPASS=false;for(let e=0;e<r.length;e++)t[r[e].define]=false;}t.PREPASS!=s&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty());}function sr$1(e,t,i,s,r=null,n=false,a=false,o=false){r&&r.push("Light"+e),n||(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightWidth"+e,"vLightHeight"+e,"vLightFalloff"+e,"vLightGround"+e,"vSliceData"+e,"vSliceRanges"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowTexture"+e),i.push("depthTexture"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),s&&(i.push("projectionLightTexture"+e),t.push("textureProjectionMatrix"+e)),a&&i.push("iesLightTexture"+e),o&&(i.push("lightDataTexture"+e),i.push("tileMaskTexture"+e)));}function rr$1(e,t,i){const s=["vReflectionMicrosurfaceInfos","vReflectionDominantDirection","reflectionMatrix","vReflectionInfos","vReflectionPosition","vReflectionSize","vReflectionColor","vReflectionFilteringInfo"];i&&s.push("vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22"),e.push(...s);t.push("reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","icdfSampler");}function nr$1(e,t,i,s=4){let r,n;if(e.uniformsNames){const a=e;r=a.uniformsNames,n=a.uniformBuffersNames,t=a.samplers,i=a.defines,s=a.maxSimultaneousLights||0;}else r=e,t||(t=[]);for(let e=0;e<s&&i["LIGHT"+e];e++)sr$1(e,r,t,i["PROJECTEDLIGHTTEXTURE"+e],n,false,i["IESLIGHTTEXTURE"+e],i["CLUSTLIGHT"+e]);i.NUM_MORPH_INFLUENCERS&&(r.push("morphTargetInfluences"),r.push("morphTargetCount")),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"));}function ar$1(e,t=false,i=false,s=false,r=false,n=false){e.addUniform("vReflectionInfos",2),e.addUniform("reflectionMatrix",16),t&&e.addUniform("vReflectionMicrosurfaceInfos",3),i&&(e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3)),s&&(e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionDominantDirection",3)),n&&e.addUniform("vReflectionColor",3),r&&(e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3));}function or$1(e){return void 0===e.getPipelineContext}let hr$1=class hr{get useVertexPulling(){return this._useVertexPulling}set useVertexPulling(e){this._useVertexPulling!==e&&(this._useVertexPulling=e,this.markAsDirty(hr.MiscDirtyFlag));}get _supportGlowLayer(){return  false}set _glowModeEnabled(e){}get shaderLanguage(){return this._shaderLanguage}get canRenderToMRT(){return  false}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,1!==t&&1!==e||this.markAsDirty(hr.MiscDirtyFlag+hr.PrePassDirtyFlag);}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(hr.TextureDirtyFlag));}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(hr.TextureDirtyFlag));}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty());}atomicMaterialsUpdate(e){this.blockDirtyMechanism=true;try{e(this);}finally{this.blockDirtyMechanism=false;}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=false,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e);}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new R$g),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e);}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new R$g),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new R$g),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode[0]!==e&&(this._alphaMode[0]=e,this.markAsDirty(hr.TextureDirtyFlag));}get alphaMode(){return this._alphaMode[0]}get alphaModes(){return this._alphaMode}setAlphaMode(e,t=0){this._alphaMode[t]!==e&&(this._alphaMode[t]=e,this.markAsDirty(hr.TextureDirtyFlag));}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=true));}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return  false}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(hr.MiscDirtyFlag));}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case hr.WireFrameFillMode:case hr.LineListDrawMode:case hr.LineLoopDrawMode:case hr.LineStripDrawMode:return  true}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?hr.WireFrameFillMode:hr.TriangleFillMode;}get pointsCloud(){switch(this._fillMode){case hr.PointFillMode:case hr.PointListDrawMode:return  true}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?hr.PointFillMode:hr.TriangleFillMode;}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(hr.MiscDirtyFlag));}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&Ie$2.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty();}get isVertexOutputInvariant(){return this._isVertexOutputInvariant}set isVertexOutputInvariant(e){this._isVertexOutputInvariant!==e&&(this._isVertexOutputInvariant=e,this._markAllSubMeshesAsMiscDirty());}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e;}constructor(e,t,i,s=false){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=true,this._shaderLanguage=0,this._forceGLSL=false,this._useVertexPulling=false,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=false,this.checkReadyOnlyOnce=false,this.state="",this._alpha=1,this._backFaceCulling=true,this._cullBackFaces=true,this._blockDirtyMechanism=false,this.sideOrientation=null,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=false,this._storeEffectOnSubMeshes=false,this.animations=null,this.onDisposeObservable=new R$g,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=[Qe$1.ALPHA_COMBINE],this._needDepthPrePass=false,this.disableDepthWrite=false,this.disableColorWrite=false,this.forceDepthWrite=false,this.depthFunction=0,this.separateCullingPass=false,this._fogEnabled=true,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new gs,this._isVertexOutputInvariant=hr.ForceVertexOutputInvariant,this._useUBO=false,this._fillMode=hr.TriangleFillMode,this._cachedDepthWriteState=false,this._cachedColorWriteState=false,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=false,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._transparencyMode=null,this.name=e;const r=t||L$7.LastCreatedScene;r&&(this._scene=r,this._dirtyCallbacks={},this._forceGLSL=s,this._dirtyCallbacks[Qe$1.MATERIAL_TextureDirtyFlag]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[Qe$1.MATERIAL_LightDirtyFlag]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[Qe$1.MATERIAL_FresnelDirtyFlag]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[Qe$1.MATERIAL_AttributesDirtyFlag]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[Qe$1.MATERIAL_MiscDirtyFlag]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[Qe$1.MATERIAL_PrePassDirtyFlag]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[Qe$1.MATERIAL_AllDirtyFlag]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||Ai.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new $i(this._scene.getEngine(),false),this._drawWrapper.materialContext=this._materialContext,this._uniformBuffer=new cs(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,this._createUniformBuffer(),i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),hr.OnEventObservable.notifyObservers(this,1));}_createUniformBuffer(){const e=this.getScene().getEngine();this._uniformBuffer?.dispose(),e.isWebGPU&&!this._forceGLSL?(this._uniformBuffer=new cs(e,void 0,void 0,this.name,true),this._shaderLanguage=1):this._uniformBuffer=new cs(this._scene.getEngine(),void 0,void 0,this.name),this._uniformBufferLayoutBuilt=false;}toString(e){return "Name: "+this.name}getClassName(){return "Material"}get _isMaterial(){return  true}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=true;}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=false;}isReady(e,t){return  true}isReadyForSubMesh(e,t,i){const s=t.materialDefines;return !!s&&(this._eventInfo.isReadyForSubMesh=true,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh)}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}_getEffectiveOrientation(e){return null!==this.sideOrientation?this.sideOrientation:e.sideOrientation}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._markAllSubMeshesAsTexturesAndMiscDirty());}get _hasTransparencyMode(){return null!=this._transparencyMode}get _transparencyModeIsBlend(){return this._transparencyMode===hr.MATERIAL_ALPHABLEND||this._transparencyMode===hr.MATERIAL_ALPHATESTANDBLEND}get _transparencyModeIsTest(){return this._transparencyMode===hr.MATERIAL_ALPHATEST||this._transparencyMode===hr.MATERIAL_ALPHATESTANDBLEND}get _disableAlphaBlending(){return this._transparencyMode===hr.MATERIAL_OPAQUE||this._transparencyMode===hr.MATERIAL_ALPHATEST}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:!this._disableAlphaBlending&&this.alpha<1}needAlphaBlendingForMesh(e){return this._hasTransparencyMode?this._transparencyModeIsBlend:e.visibility<1||!this._disableAlphaBlending&&(e.hasVertexAlpha||this.needAlphaBlending())}needAlphaTesting(){return !!this._hasTransparencyMode&&this._transparencyModeIsTest}needAlphaTestingForMesh(e){return this._hasTransparencyMode?this._transparencyModeIsTest:!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=false){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const t of i.subMeshes)if(t.getMaterial()===this)for(const i of t._drawWrappers)i&&this._materialContext===i.materialContext&&(i._wasPreviouslyReady=false,i._wasPreviouslyUsingInstances=null,i._forceRebindOnNextCall=e);e&&this.markAsDirty(hr.AllDirtyFlag);}_preBind(e,t=null){const i=this._scene.getEngine(),s=(null==t?this.sideOrientation:t)===hr.ClockWiseSideOrientation,r=e||this._getDrawWrapper();return or$1(r)&&r.materialContext&&(r.materialContext.useVertexPulling=this.useVertexPulling),i.enableEffect(r),i.setState(this.backFaceCulling,this.zOffset,false,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(8,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=true;}bindForSubMesh(e,t,i){const s=i._drawWrapper;this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),s._forceRebindOnNextCall=false;}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=true:e.setMatrix("view",this.getScene().getViewMatrix());}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=true:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()));}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=true:this._scene.bindEyePosition(e,t);}_afterBind(e,t=null,i){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=false,Ns(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),this._scene._cachedVisibility=e?e.visibility:1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const e=this._scene.getEngine();this._cachedDepthWriteState=e.getDepthWrite(),e.setDepthWrite(false);}if(this.disableColorWrite){const e=this._scene.getEngine();this._cachedColorWriteState=e.getColorWrite(),e.setColorWrite(false);}if(0!==this.depthFunction){const e=this._scene.getEngine();this._cachedDepthFunctionState=e.getDepthFunction()||0,e.setDepthFunction(this.depthFunction);}}unbind(){if(this._scene.getSceneUniformBuffer().unbindEffect(),this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),0!==this.depthFunction){this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState);}if(this.disableDepthWrite){this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState);}if(this.disableColorWrite){this._scene.getEngine().setColorWrite(this._cachedColorWriteState);}}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(256,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(512,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=false,this._eventInfo.texture=e,this._callbackPluginEventGeneric(1024,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const i={};if(this._serializePlugins(i),hr._ParsePlugins(i,e,this._scene,t),this.pluginManager)for(const t of this.pluginManager._plugins){const i=e.pluginManager.getPlugin(t.name);i&&t.copyTo(i);}}getBindedMeshes(){if(this.meshMap){const e=[];for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i);}return e}return this._scene.meshes.filter((e=>e.material===this))}forceCompilation(e,t,i,s){const r={clipPlane:false,useInstances:false,...i},n=this.getScene(),a=this.allowShaderHotSwapping;this.allowShaderHotSwapping=false;const o=()=>{if(!this._scene||!this._scene.getEngine())return;const i=n.clipPlane;if(r.clipPlane&&(n.clipPlane=new Pi(0,0,0,1)),this._storeEffectOnSubMeshes){let i=true,n=null;if(e.subMeshes){const t=new es(0,0,0,0,0,e,void 0,false,false);t.materialDefines&&(t.materialDefines._renderId=-1),this.isReadyForSubMesh(e,t,r.useInstances)||(t.effect&&t.effect.getCompilationError()&&t.effect.allFallbacksProcessed()?n=t.effect.getCompilationError():(i=false,setTimeout(o,16)));}i&&(this.allowShaderHotSwapping=a,n&&s&&s(n),t&&t(this));}else this.isReady()?(this.allowShaderHotSwapping=a,t&&t(this)):setTimeout(o,16);r.clipPlane&&(n.clipPlane=i);};o();}async forceCompilationAsync(e,t){return await new Promise(((i,s)=>{this.forceCompilation(e,(()=>{i();}),t,(e=>{s(e);}));}))}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(hr._DirtyCallbackArray.length=0,e&hr.ImageProcessingDirtyFlag&&hr._DirtyCallbackArray.push(hr._ImageProcessingDirtyCallBack),e&hr.TextureDirtyFlag&&hr._DirtyCallbackArray.push(hr._TextureDirtyCallBack),e&hr.LightDirtyFlag&&hr._DirtyCallbackArray.push(hr._LightsDirtyCallBack),e&hr.FresnelDirtyFlag&&hr._DirtyCallbackArray.push(hr._FresnelDirtyCallBack),e&hr.AttributesDirtyFlag&&hr._DirtyCallbackArray.push(hr._AttributeDirtyCallBack),e&hr.MiscDirtyFlag&&hr._DirtyCallbackArray.push(hr._MiscDirtyCallBack),e&hr.PrePassDirtyFlag&&hr._DirtyCallbackArray.push(hr._PrePassDirtyCallBack),hr._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(hr._RunDirtyCallBacks),this.getScene().resetCachedMaterial());}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const e of t.subMeshes)e.getMaterial()===this&&e.resetDrawCache();}_markAllSubMeshesAsDirty(e){const t=this.getScene();if(t.blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const i=t.meshes;for(const s of i)if(s.subMeshes)for(const i of s.subMeshes){if((i.getMaterial()||(t._hasDefaultMaterial?t.defaultMaterial:null))===this)for(const t of i._drawWrappers)t&&t.defines&&t.defines.markAllAsDirty&&this._materialContext===t.materialContext&&e(t.defines);}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty();}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(hr._AllDirtyCallBack);}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(hr._ImageProcessingDirtyCallBack);}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(hr._TextureDirtyCallBack);}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(hr._FresnelDirtyCallBack);}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(hr._FresnelAndMiscDirtyCallBack);}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(hr._LightsDirtyCallBack);}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(hr._AttributeDirtyCallBack);}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(hr._MiscDirtyCallBack);}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(hr._PrePassDirtyCallBack);}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(hr._TextureAndMiscDirtyCallBack);}_checkScenePerformancePriority(){if(0!==this._scene.performancePriority){this.checkReadyOnlyOnce=true;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce((()=>{this.checkReadyOnlyOnce=false;}));this.onDisposeObservable.add((()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e);}));}}setPrePassRenderer(e){return  false}dispose(e,t,i){const s=this.getScene();if(s.stopAnimation(this),s.freeProcessedMaterials(),s.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(2,this._eventInfo),this._parentContainer){const e=this._parentContainer.materials.indexOf(this);e>-1&&this._parentContainer.materials.splice(e,1),this._parentContainer=null;}if(true!==i)if(this.meshMap)for(const e in this.meshMap){const t=this.meshMap[e];this._disposeMeshResources(t);}else {const e=s.meshes;for(const t of e)this._disposeMeshResources(t);}this._uniformBuffer.dispose(),this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={});}_disposeMeshResources(e){if(!e)return;const t=e.geometry,i=e._internalAbstractMeshDataInfo._materialForRenderPass;if(this._storeEffectOnSubMeshes){if(e.subMeshes&&i)for(const s of e.subMeshes){const e=s._drawWrappers;for(let r=0;r<e.length;r++){const n=e[r]?.effect;if(!n)continue;i[r]===this&&(t?._releaseVertexArrayObject(n),s._removeDrawWrapper(r,true,true));}}}else t?._releaseVertexArrayObject(this._drawWrapper.effect);e.material!==this||e.sourceMesh||(e.material=null);}serialize(){const e=Ae$3.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)t.doNotSerialize||(e.plugins[t.getClassName()]=t.serialize());}static ParseAlphaMode(e,t){ void 0!==e._alphaMode?t._alphaMode=Array.isArray(e._alphaMode)?e._alphaMode:[e._alphaMode]:void 0!==e.alphaMode?t._alphaMode=Array.isArray(e.alphaMode)?e.alphaMode:[e.alphaMode]:t._alphaMode=[Qe$1.ALPHA_COMBINE];}static Parse(e,t,i){if(e.customType){if("BABYLON.PBRMaterial"===e.customType&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return Ie$2.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null}else e.customType="BABYLON.StandardMaterial";const s=Ai.Instantiate(e.customType).Parse(e,t,i);return s._loadedUniqueId=e.uniqueId,hr.ParseAlphaMode(e,s),s}static _ParsePlugins(e,t,i,s){if(e.plugins)for(const r in e.plugins){const n=e.plugins[r];let a=t.pluginManager?.getPlugin(n.name);if(!a){const e=Ai.Instantiate("BABYLON."+r);e&&(a=new e(t));}a?.parse(n,i,s);}}};hr$1.TriangleFillMode=Qe$1.MATERIAL_TriangleFillMode,hr$1.WireFrameFillMode=Qe$1.MATERIAL_WireFrameFillMode,hr$1.PointFillMode=Qe$1.MATERIAL_PointFillMode,hr$1.PointListDrawMode=Qe$1.MATERIAL_PointListDrawMode,hr$1.LineListDrawMode=Qe$1.MATERIAL_LineListDrawMode,hr$1.LineLoopDrawMode=Qe$1.MATERIAL_LineLoopDrawMode,hr$1.LineStripDrawMode=Qe$1.MATERIAL_LineStripDrawMode,hr$1.TriangleStripDrawMode=Qe$1.MATERIAL_TriangleStripDrawMode,hr$1.TriangleFanDrawMode=Qe$1.MATERIAL_TriangleFanDrawMode,hr$1.ClockWiseSideOrientation=Qe$1.MATERIAL_ClockWiseSideOrientation,hr$1.CounterClockWiseSideOrientation=Qe$1.MATERIAL_CounterClockWiseSideOrientation,hr$1.ImageProcessingDirtyFlag=Qe$1.MATERIAL_ImageProcessingDirtyFlag,hr$1.TextureDirtyFlag=Qe$1.MATERIAL_TextureDirtyFlag,hr$1.LightDirtyFlag=Qe$1.MATERIAL_LightDirtyFlag,hr$1.FresnelDirtyFlag=Qe$1.MATERIAL_FresnelDirtyFlag,hr$1.AttributesDirtyFlag=Qe$1.MATERIAL_AttributesDirtyFlag,hr$1.MiscDirtyFlag=Qe$1.MATERIAL_MiscDirtyFlag,hr$1.PrePassDirtyFlag=Qe$1.MATERIAL_PrePassDirtyFlag,hr$1.AllDirtyFlag=Qe$1.MATERIAL_AllDirtyFlag,hr$1.MATERIAL_OPAQUE=0,hr$1.MATERIAL_ALPHATEST=1,hr$1.MATERIAL_ALPHABLEND=2,hr$1.MATERIAL_ALPHATESTANDBLEND=3,hr$1.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,hr$1.MATERIAL_NORMALBLENDMETHOD_RNM=1,hr$1.LIGHTFALLOFF_PHYSICAL=0,hr$1.LIGHTFALLOFF_GLTF=1,hr$1.LIGHTFALLOFF_STANDARD=2,hr$1.OnEventObservable=new R$g,hr$1.ForceVertexOutputInvariant=false,hr$1._AllDirtyCallBack=e=>e.markAllAsDirty(),hr$1._ImageProcessingDirtyCallBack=e=>e.markAsImageProcessingDirty(),hr$1._TextureDirtyCallBack=e=>e.markAsTexturesDirty(),hr$1._FresnelDirtyCallBack=e=>e.markAsFresnelDirty(),hr$1._MiscDirtyCallBack=e=>e.markAsMiscDirty(),hr$1._PrePassDirtyCallBack=e=>e.markAsPrePassDirty(),hr$1._LightsDirtyCallBack=e=>e.markAsLightDirty(),hr$1._AttributeDirtyCallBack=e=>e.markAsAttributesDirty(),hr$1._FresnelAndMiscDirtyCallBack=e=>{hr$1._FresnelDirtyCallBack(e),hr$1._MiscDirtyCallBack(e);},hr$1._TextureAndMiscDirtyCallBack=e=>{hr$1._TextureDirtyCallBack(e),hr$1._MiscDirtyCallBack(e);},hr$1._DirtyCallbackArray=[],hr$1._RunDirtyCallBacks=e=>{for(const t of hr$1._DirtyCallbackArray)t(e);},e$z([a$$()],hr$1.prototype,"id",void 0),e$z([a$$()],hr$1.prototype,"uniqueId",void 0),e$z([a$$()],hr$1.prototype,"name",void 0),e$z([a$$()],hr$1.prototype,"metadata",void 0),e$z([a$$()],hr$1.prototype,"checkReadyOnEveryCall",void 0),e$z([a$$()],hr$1.prototype,"checkReadyOnlyOnce",void 0),e$z([a$$()],hr$1.prototype,"state",void 0),e$z([a$$("alpha")],hr$1.prototype,"_alpha",void 0),e$z([a$$("backFaceCulling")],hr$1.prototype,"_backFaceCulling",void 0),e$z([a$$("cullBackFaces")],hr$1.prototype,"_cullBackFaces",void 0),e$z([a$$()],hr$1.prototype,"sideOrientation",void 0),e$z([a$$()],hr$1.prototype,"_alphaMode",void 0),e$z([a$$()],hr$1.prototype,"_needDepthPrePass",void 0),e$z([a$$()],hr$1.prototype,"disableDepthWrite",void 0),e$z([a$$()],hr$1.prototype,"disableColorWrite",void 0),e$z([a$$()],hr$1.prototype,"forceDepthWrite",void 0),e$z([a$$()],hr$1.prototype,"depthFunction",void 0),e$z([a$$()],hr$1.prototype,"separateCullingPass",void 0),e$z([a$$("fogEnabled")],hr$1.prototype,"_fogEnabled",void 0),e$z([a$$()],hr$1.prototype,"pointSize",void 0),e$z([a$$()],hr$1.prototype,"zOffset",void 0),e$z([a$$()],hr$1.prototype,"zOffsetUnits",void 0),e$z([a$$()],hr$1.prototype,"pointsCloud",null),e$z([a$$()],hr$1.prototype,"fillMode",null),e$z([a$$()],hr$1.prototype,"useLogarithmicDepth",null),e$z([a$$()],hr$1.prototype,"_isVertexOutputInvariant",void 0),e$z([a$$()],hr$1.prototype,"transparencyMode",null);let lr$1=class lr extends hr$1{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e);}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,true),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=true;}_hookArray(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);return this._markAllSubMeshesAsTexturesDirty(),s};const i=e.splice;e.splice=(t,s)=>{const r=i.apply(e,[t,s]);return this._markAllSubMeshesAsTexturesDirty(),r};}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map((e=>e?e.getActiveTextures():[])))}hasTexture(e){if(super.hasTexture(e))return  true;for(let t=0;t<this.subMaterials.length;t++)if(this.subMaterials[t]?.hasTexture(e))return  true;return  false}getClassName(){return "MultiMaterial"}isReadyForSubMesh(e,t,i){for(let s=0;s<this.subMaterials.length;s++){const r=this.subMaterials[s];if(r){if(r._storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(e,t,i))return  false;continue}if(!r.isReady(e))return  false}}return  true}clone(e,t){const i=new lr(e,this.getScene());for(let s=0;s<this.subMaterials.length;s++){let r=null;const n=this.subMaterials[s];r=t&&n?n.clone(e+"-"+n.name):this.subMaterials[s],i.subMaterials.push(r);}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,ue$4&&(e.tags=ue$4.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null));}return e}dispose(e,t,i){const s=this.getScene();if(!s)return;if(i)for(let i=0;i<this.subMaterials.length;i++){const s=this.subMaterials[i];s&&s.dispose(e,t);}const r=s.multiMaterials.indexOf(this);r>=0&&s.multiMaterials.splice(r,1),super.dispose(e,t);}static ParseMultiMaterial(e,t){const i=new lr(e.name,t);if(i.id=e.id,i._loadedUniqueId=e.uniqueId,ue$4&&ue$4.AddTagsTo(i,e.tags),e.materialsUniqueIds)i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds;else for(const s of e.materials)i.subMaterials.push(t.getLastMaterialById(s));return i}};P$9("BABYLON.MultiMaterial",lr$1);let cr$1=class cr{};cr$1.NAME_EFFECTLAYER="EffectLayer",cr$1.NAME_LAYER="Layer",cr$1.NAME_LENSFLARESYSTEM="LensFlareSystem",cr$1.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",cr$1.NAME_PARTICLESYSTEM="ParticleSystem",cr$1.NAME_GAMEPAD="Gamepad",cr$1.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",cr$1.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",cr$1.NAME_PREPASSRENDERER="PrePassRenderer",cr$1.NAME_DEPTHRENDERER="DepthRenderer",cr$1.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",cr$1.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",cr$1.NAME_SPRITE="Sprite",cr$1.NAME_SUBSURFACE="SubSurface",cr$1.NAME_OUTLINERENDERER="Outline",cr$1.NAME_PROCEDURALTEXTURE="ProceduralTexture",cr$1.NAME_SHADOWGENERATOR="ShadowGenerator",cr$1.NAME_OCTREE="Octree",cr$1.NAME_PHYSICSENGINE="PhysicsEngine",cr$1.NAME_AUDIO="Audio",cr$1.NAME_FLUIDRENDERER="FluidRenderer",cr$1.NAME_IBLCDFGENERATOR="iblCDFGenerator",cr$1.NAME_CLUSTEREDLIGHTING="ClusteredLighting",cr$1.STEP_ISREADYFORMESH_EFFECTLAYER=0,cr$1.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,cr$1.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,cr$1.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,cr$1.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,cr$1.STEP_BEFORECAMERADRAW_PREPASS=0,cr$1.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,cr$1.STEP_BEFORECAMERADRAW_LAYER=2,cr$1.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,cr$1.STEP_BEFORERENDERTARGETDRAW_LAYER=1,cr$1.STEP_BEFORERENDERINGMESH_PREPASS=0,cr$1.STEP_BEFORERENDERINGMESH_OUTLINE=1,cr$1.STEP_AFTERRENDERINGMESH_PREPASS=0,cr$1.STEP_AFTERRENDERINGMESH_OUTLINE=1,cr$1.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,cr$1.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,cr$1.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,cr$1.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,cr$1.STEP_BEFORECLEAR_PREPASS=1,cr$1.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,cr$1.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,cr$1.STEP_AFTERRENDERTARGETDRAW_LAYER=1,cr$1.STEP_AFTERCAMERADRAW_PREPASS=0,cr$1.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,cr$1.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,cr$1.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,cr$1.STEP_AFTERCAMERADRAW_LAYER=4,cr$1.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,cr$1.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,cr$1.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,cr$1.STEP_AFTERRENDER_AUDIO=0,cr$1.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,cr$1.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,cr$1.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,cr$1.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,cr$1.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,cr$1.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,cr$1.STEP_GATHERACTIVECAMERARENDERTARGETS_CLUSTEREDLIGHTING=2,cr$1.STEP_POINTERMOVE_SPRITE=0,cr$1.STEP_POINTERDOWN_SPRITE=0,cr$1.STEP_POINTERUP_SPRITE=0;let ur$1=class ur extends Array{constructor(e){super(...e);}static Create(){return Object.create(ur.prototype)}registerStep(e,t,i){let s=0,r=Number.MAX_VALUE;for(;s<this.length;s++){if(r=this[s].index,e<r)break}this.splice(s,0,{index:e,component:t,action:i.bind(t)});}clear(){this.length=0;}};let dr$1=class dr{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t;}};let _r$1=class _r{constructor(){this.batchCache=new pr$1(this),this.batchCacheReplacementModeInFrozenMode=new pr$1(this),this.instancesBufferSize=2048;}};let fr$1=class fr{constructor(){this.renderPasses={};}};let pr$1=class pr{constructor(e){this.parent=e,this.mustReturn=false,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[];}};let gr$1=class gr{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null;}};let mr$1=class mr{constructor(){this._areNormalsFrozen=false,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=false,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null;}};const Tr$1={source:null,parent:null,doNotCloneChildren:false,clonePhysicsImpostor:true,cloneThinInstances:false};let Er$1=class Er extends ps{static _GetDefaultSideOrientation(e){return e||Er.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels();}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(Hi.PositionKind,this._internalMeshDataInfo._sourcePositions,true),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(Hi.NormalKind,this._internalMeshDataInfo._sourceNormals,true),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty());}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new R$g),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new R$g),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new R$g),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new R$g),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new R$g),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e);}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return (this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e;}get sideOrientation(){return this._internalMeshDataInfo._sideOrientation}set sideOrientation(e){this._internalMeshDataInfo._sideOrientation=e,this._internalAbstractMeshDataInfo._sideOrientationHint=this._scene.useRightHandedSystem&&e===Qe$1.MATERIAL_CounterClockWiseSideOrientation||!this._scene.useRightHandedSystem&&e===Qe$1.MATERIAL_ClockWiseSideOrientation;}get _effectiveSideOrientation(){return this._internalMeshDataInfo._effectiveSideOrientation}get overrideMaterialSideOrientation(){return this.sideOrientation}set overrideMaterialSideOrientation(e){this.sideOrientation=e,this.material&&(this.material.sideOrientation=null);}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e;}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){e&&(this.material&&null===this.material.sideOrientation||this._internalAbstractMeshDataInfo._sideOrientationHint)&&(e.sideOrientation=null),this._setMaterial(e);}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty());}get worldMatrixInstancedBuffer(){const e=this._instanceDataStorage.renderPasses[this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0];return e?e.instancesData:void 0}get previousWorldMatrixInstancedBuffer(){const e=this._instanceDataStorage.renderPasses[this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0];return e?e.instancesPreviousData:void 0}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e;}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e;}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e;}_copySource(e,t,i=true,s=false){const r=this.getScene();if(e._geometry&&e._geometry.applyToMesh(this),ve$3.DeepCopy(e,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=e,r.useClonedMeshMap&&(e._internalMeshDataInfo.meshMap||(e._internalMeshDataInfo.meshMap={}),e._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=e._originalBuilderSideOrientation,this._creationDataStorage=e._creationDataStorage,e._ranges){const t=e._ranges;for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&t[e]&&this.createAnimationRange(e,t[e].from,t[e].to);}if(e.metadata&&e.metadata.clone?this.metadata=e.metadata.clone():this.metadata=e.metadata,this._internalMetadata=e._internalMetadata,ue$4&&ue$4.HasTags(e)&&ue$4.AddTagsTo(this,ue$4.GetTags(e,true)),this.setEnabled(e.isEnabled(false)),this.parent=e.parent,this.setPivotMatrix(e.getPivotMatrix(),this._postMultiplyPivotMatrix),this.id=this.name+"."+e.id,this.material=e.material,!t){const r=e.getDescendants(true);for(let e=0;e<r.length;e++){const n=r[e];n._isMesh?(Tr$1.parent=this,Tr$1.doNotCloneChildren=t,Tr$1.clonePhysicsImpostor=i,Tr$1.cloneThinInstances=s,n.clone(this.name+"."+n.name,Tr$1)):n.clone&&n.clone(this.name+"."+n.name,this);}}if(e.morphTargetManager&&(this.morphTargetManager=e.morphTargetManager),r.getPhysicsEngine){const t=r.getPhysicsEngine();if(i&&t)if(1===t.getPluginVersion()){const i=t.getImpostorForPhysicsObject(e);i&&(this.physicsImpostor=i.clone(this));}else 2===t.getPluginVersion()&&e.physicsBody&&e.physicsBody.clone(this);}for(let t=0;t<r.particleSystems.length;t++){const i=r.particleSystems[t];i.emitter===e&&i.clone(i.name,this);}if(this.skeleton=e.skeleton,s&&(e._thinInstanceDataStorage.matrixData?(this.thinInstanceSetBuffer("matrix",new Float32Array(e._thinInstanceDataStorage.matrixData),16,!e._thinInstanceDataStorage.matrixBuffer.isUpdatable()),this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,this._thinInstanceDataStorage.instancesCount=e._thinInstanceDataStorage.instancesCount):this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,e._userThinInstanceBuffersStorage)){const t=e._userThinInstanceBuffersStorage;for(const e in t.data)this.thinInstanceSetBuffer(e,new Float32Array(t.data[e]),t.strides[e],!t.vertexBuffers?.[e]?.isUpdatable()),this._userThinInstanceBuffersStorage.sizes[e]=t.sizes[e];}this.refreshBoundingInfo(true,true),this.computeWorldMatrix(true);}constructor(e,t=null,i=null,s=null,r,n=true){super(e,t),this._internalMeshDataInfo=new mr$1,this.delayLoadState=Qe$1.DELAYLOADSTATE_NONE,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._thinInstanceDataStorage=new gr$1,this._shouldGenerateFlatShading=false,this._originalBuilderSideOrientation=Er.DEFAULTSIDE,this.ignoreCameraMaxZ=false,t=this.getScene(),this._instanceDataStorage=new fr$1,this._instanceDataStorage.engine=t.getEngine(),this._scene.useRightHandedSystem?this.sideOrientation=Qe$1.MATERIAL_ClockWiseSideOrientation:this.sideOrientation=Qe$1.MATERIAL_CounterClockWiseSideOrientation,this._onBeforeDraw=(e,t,i)=>{e&&i&&(this._uniformBuffer?this.transferToEffect(t):i.bindOnlyWorldMatrix(t));};let a=null,o=false;if(i&&void 0===i._addToSceneRootNodes){const e=i;a=e.parent??null,s=e.source??null,r=e.doNotCloneChildren??false,n=e.clonePhysicsImpostor??true,o=e.cloneThinInstances??false;}else a=i;s&&this._copySource(s,r,n,o),null!==a&&(this.parent=a),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=e=>{e.unregisterOnNextCall=true,this.isReady(true)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add((()=>{this.isReady(true)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this));})));},this.onMeshReadyObservable=new R$g(this._internalMeshDataInfo._onMeshReadyObserverAdded),s&&s.onClonedObservable.notifyObservers(this);}instantiateHierarchy(e=null,t,i){const s=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(true===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,true):this.createInstance("instance of "+(this.name||this.id));s.parent=e||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),i&&i(this,s);for(const e of this.getChildTransformNodes(true))"InstancedMesh"===e.getClassName()&&"Mesh"===s.getClassName()&&e.sourceMesh===this?e.instantiateHierarchy(s,{doNotInstantiate:t&&t.doNotInstantiate||false,newSourcedMesh:s},i):e.instantiateHierarchy(s,t,i);return s}getClassName(){return "Mesh"}get _isMesh(){return  true}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const e=this.getIndices(),i=this.getVerticesData(Hi.PositionKind);i&&e&&(t+=", flat shading: "+(i.length/3===e.length?"YES":"NO"));}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect();}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort(((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0));}addLODLevel(e,t){if(t&&t._masterMesh)return Ie$2.Warn("You cannot use a mesh as LOD level twice"),this;const i=new dr$1(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const s=t._LODLevels[i];if(s.distanceOrScreenCoverage===e)return s.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||0===i._LODLevels.length)return this;const s=t||this.getBoundingInfo().boundingSphere,r=e.mode===Di.ORTHOGRAPHIC_CAMERA?e.minZ:s.centerWorld.subtract(e.globalPosition).length();let n=r,a=1;if(i._useLODScreenCoverage){const t=e.screenArea;let i=s.radiusWorld*e.minZ/r;i=i*i*Math.PI,n=i/t,a=-1;}if(a*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>a*n)return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this;for(let e=0;e<i._LODLevels.length;e++){const t=i._LODLevels[e];if(a*t.distanceOrScreenCoverage<a*n){if(t.mesh){if(t.mesh.delayLoadState===Qe$1.DELAYLOADSTATE_NOTLOADED)return t.mesh._checkDelayState(),this;if(t.mesh.delayLoadState===Qe$1.DELAYLOADSTATE_LOADING)return this;t.mesh._preActivate(),t.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache);}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,t.mesh),t.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,s){if(!this._geometry)return null;let r=s?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e]?.getFloatData(this.instances.length+1,i||t&&1!==this._geometry.meshes.length);return r||(r=this._geometry.getVerticesData(e,t,i)),r}copyVerticesData(e,t){this._geometry&&this._geometry.copyVerticesData(e,t);}getVertexBuffer(e,t){return this._geometry?(t?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e])??this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){return this._geometry?!t&&void 0!==this._userInstancedBuffersStorage?.vertexBuffers[e]||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}isVertexBufferUpdatable(e,t){if(!this._geometry)return !!this._delayInfo&&-1!==this._delayInfo.indexOf(e);if(!t){const t=this._userInstancedBuffersStorage?.vertexBuffers[e];if(t)return t.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const e=[];if(this._delayInfo)for(const t of this._delayInfo)e.push(t);return e}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const e in this._userInstancedBuffersStorage.vertexBuffers) -1===t.indexOf(e)&&t.push(e);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return null!==this._masterMesh&&void 0!==this._masterMesh}isReady(e=false,t=false){if(this.delayLoadState===Qe$1.DELAYLOADSTATE_LOADING)return  false;if(!super.isReady(e))return  false;if(!this.subMeshes||0===this.subMeshes.length)return  true;if(!e)return  true;const i=this.getEngine(),s=this.getScene(),r=t||i.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const n=this.material||s.defaultMaterial;if(n)if(n._storeEffectOnSubMeshes)for(const e of this.subMeshes){const t=e.getMaterial();if(t)if(t._storeEffectOnSubMeshes){if(!t.isReadyForSubMesh(this,e,r))return  false}else if(!t.isReady(this,r))return  false}else if(!n.isReady(this,r))return  false;const a=i.currentRenderPassId;for(const e of this.lightSources){const t=e.getShadowGenerators();if(!t)continue;const s=t.values();for(let e=s.next();true!==e.done;e=s.next()){const t=e.value;if(t&&(!t.getShadowMap()?.renderList||t.getShadowMap()?.renderList&&-1!==t.getShadowMap()?.renderList?.indexOf(this))){const e=t.getShadowMap().renderPassIds??[i.currentRenderPassId];for(let s=0;s<e.length;++s){i.currentRenderPassId=e[s];for(const e of this.subMeshes)if(!t.isReady(e,r,e.getMaterial()?.needAlphaBlendingForMesh(this)??false))return i.currentRenderPassId=a,false}i.currentRenderPassId=a;}}}for(const e of this._internalMeshDataInfo._LODLevels)if(e.mesh&&!e.mesh.isReady(r))return  false;return  true}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=true,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=false,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e;}_getInstanceDataStorage(){const e=this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0;let t=this._instanceDataStorage.renderPasses[e];return t||(t=new _r$1,this._instanceDataStorage.renderPasses[e]=t),t}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._getInstanceDataStorage().visibleInstances=null),this}_preActivateForIntermediateRendering(e){const t=this._getInstanceDataStorage();return t.visibleInstances&&(t.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){const i=this._getInstanceDataStorage();return i.visibleInstances||(i.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId,intermediateDefaultRenderId:-1}),i.visibleInstances[t]||(void 0!==i.previousRenderId&&this._instanceDataStorage.isFrozen&&(i.visibleInstances[i.previousRenderId]=null),i.previousRenderId=t,i.visibleInstances[t]=new Array),i.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(false));}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()));}refreshBoundingInfo(e=false,t=false){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;i="object"==typeof e?e:{applySkeleton:e,applyMorph:t};const s=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getData(i,null,Hi.PositionKind),s),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const s=i.length;let r=false;if(e)r=true;else for(const e of this.subMeshes){if(e.indexStart+e.indexCount>s){r=true;break}if(e.verticesStart+e.verticesCount>t){r=true;break}}if(!r)return this.subMeshes[0]}return this.releaseSubMeshes(),new es(0,0,t,0,this.getTotalIndices()||(this.isUnIndexed?t:0),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,s=0;for(;i%3!=0;)i++;this.releaseSubMeshes();for(let r=0;r<e&&!(s>=t);r++)es.CreateFromIndices(0,s,r===e-1?t-s:i,this,void 0,false),s+=i;this.refreshBoundingInfo(),this.synchronizeInstances();}setVerticesData(e,t,i=false,s){if(this._geometry)this._geometry.setVerticesData(e,t,i,s);else {const s=new is;s.set(t,e);const r=this.getScene();new rs(rs.RandomId(),r,s,i,this);}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e);}markVerticesDataAsUpdatable(e,t=true){const i=this.getVertexBuffer(e);i&&i.isUpdatable()!==t&&this.setVerticesData(e,this.getVerticesData(e),t);}setVerticesBuffer(e,t=true){return this._geometry||(this._geometry=rs.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,s){return this._geometry?(s?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,false)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=true){const i=this.getVerticesData(Hi.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(Hi.PositionKind,i,false,false),t){const e=this.getIndices(),t=this.getVerticesData(Hi.NormalKind);if(!t)return this;is.ComputeNormals(i,e,t),this.updateVerticesData(Hi.NormalKind,t,false,false);}return this}makeGeometryUnique(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;const e=this._geometry,t=this._geometry.copy(rs.RandomId());return e.releaseForMesh(this,true),t.applyToMesh(this),this}setIndexBuffer(e,t,i,s=null){let r=this._geometry;r||(r=new rs(rs.RandomId(),this.getScene(),void 0,void 0,this)),r.setIndexBuffer(e,t,i,s);}setIndices(e,t=null,i=false,s=false){if(this._geometry)this._geometry.setIndices(e,t,i,s);else {const t=new is;t.indices=e;const s=this.getScene();new rs(rs.RandomId(),s,t,i,this);}return this}updateIndices(e,t,i=false){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,s=true){if(!this._geometry)return this;const r=this.getScene().getEngine();let n;if(this._unIndexed)if(this._getRenderingFillMode(i)===hr$1.WireFrameFillMode)n=e._getLinesIndexBuffer(this.getIndices(),r);else n=null;else switch(this._getRenderingFillMode(i)){case hr$1.PointFillMode:n=null;break;case hr$1.WireFrameFillMode:n=e._getLinesIndexBuffer(this.getIndices(),r);break;default:case hr$1.TriangleFillMode:n=this._geometry.getIndexBuffer();}return this._bindDirect(t,n,s)}_bindDirect(e,t,i=true){if(!this._geometry)return this;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e),i&&this._userInstancedBuffersStorage&&!this.hasThinInstances){if(this._instanceDataStorage.engine.isWebGPU&&this._userInstancedBuffersStorage.renderPasses&&this._userInstancedBuffersStorage.renderPasses[this._instanceDataStorage.engine.currentRenderPassId]){const e=this._userInstancedBuffersStorage.renderPasses[this._instanceDataStorage.engine.currentRenderPassId];for(const t in e)this._userInstancedBuffersStorage.vertexBuffers[t]=e[t];}this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects);}else this._geometry._bind(e,t);return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine(),r=s._currentMaterialContext,n=r&&r.useVertexPulling;return this._unIndexed&&t!==hr$1.WireFrameFillMode||t==hr$1.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==hr$1.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):n?s.drawArraysType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=false){const i=this._getInstanceDataStorage();if(this._instanceDataStorage.isFrozen){if(t)return i.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=false,i.batchCacheReplacementModeInFrozenMode.renderSelf[e]=true,i.batchCacheReplacementModeInFrozenMode;if(i.previousBatch)return i.previousBatch}const s=this.getScene(),r=s._isInIntermediateRendering(),n=r?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,a=i.batchCache;if(a.mustReturn=false,a.renderSelf[e]=t||!n&&this.isEnabled()&&this.isVisible,a.visibleInstances[e]=null,i.visibleInstances&&!t){const t=i.visibleInstances,n=s.getRenderId(),o=r?t.intermediateDefaultRenderId:t.defaultRenderId;a.visibleInstances[e]=t[n],!a.visibleInstances[e]&&o&&(a.visibleInstances[e]=t[o]);}return a.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!==a.visibleInstances[e]&&void 0!==a.visibleInstances[e],i.previousBatch=a,a}_updateInstancedBuffers(e,t,i,s,r,n){const a=t.visibleInstances[e._id],o=a?a.length:0,h=t.parent,l=this._instanceDataStorage;let c=h.instancesBuffer,u=h.instancesPreviousBuffer,d=0,_=0;const f=t.renderSelf[e._id],p=this._scene.floatingOriginOffset,g=!c||i!==h.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!h.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||l.isFrozen&&!g)_=(f?1:0)+o;else {const t=this.getWorldMatrix();if(f&&(this._scene.needsPreviousWorldMatrices&&(l.masterMeshPreviousWorldMatrix?(l.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,d),l.masterMeshPreviousWorldMatrix.copyFrom(t)):(l.masterMeshPreviousWorldMatrix=t.clone(),l.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,d))),t.copyToArray(h.instancesData,d),h.instancesData[d+12]-=p.x,h.instancesData[d+13]-=p.y,h.instancesData[d+14]-=p.z,d+=16,_++),a){if(Er.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&e.getMaterial()?.needAlphaBlendingForMesh(e.getRenderingMesh())){const e=this._scene.activeCamera.globalPosition;for(let t=0;t<a.length;t++){const i=a[t];i._distanceToCamera=te$4.Distance(i.getBoundingInfo().boundingSphere.centerWorld,e);}a.sort(((e,t)=>e._distanceToCamera>t._distanceToCamera?-1:e._distanceToCamera<t._distanceToCamera?1:0));}for(let e=0;e<a.length;e++){const t=a[e],i=t.getWorldMatrix();i.copyToArray(h.instancesData,d),this._scene.needsPreviousWorldMatrices&&(t._previousWorldMatrix?(t._previousWorldMatrix.copyToArray(h.instancesPreviousData,d),t._previousWorldMatrix.copyFrom(i)):(t._previousWorldMatrix=i.clone(),t._previousWorldMatrix.copyToArray(h.instancesPreviousData,d))),h.instancesData[d+12]-=p.x,h.instancesData[d+13]-=p.y,h.instancesData[d+14]-=p.z,d+=16,_++;}}}if(g){let e;if(c&&c.dispose(),u&&u.dispose(),c=new Vi(s,h.instancesData,true,16,false,true),h.instancesBuffer=c,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._instanceDataStorage.engine.isWebGPU){this._userInstancedBuffersStorage.renderPasses||(this._userInstancedBuffersStorage.renderPasses={});const t=this._instanceDataStorage.engine.currentRenderPassId;e=this._userInstancedBuffersStorage.renderPasses[t],e||(this._userInstancedBuffersStorage.renderPasses[t]=e={});}else e=this._userInstancedBuffersStorage.vertexBuffers;e.world0=c.createVertexBuffer("world0",0,4),e.world1=c.createVertexBuffer("world1",4,4),e.world2=c.createVertexBuffer("world2",8,4),e.world3=c.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(u=new Vi(s,h.instancesPreviousData,true,16,false,true),h.instancesPreviousBuffer=u,e.previousWorld0=u.createVertexBuffer("previousWorld0",0,4),e.previousWorld1=u.createVertexBuffer("previousWorld1",4,4),e.previousWorld2=u.createVertexBuffer("previousWorld2",8,4),e.previousWorld3=u.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject();}else this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||(c.updateDirectly(h.instancesData,0,_),!this._scene.needsPreviousWorldMatrices||this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.previousManualUpdate||u.updateDirectly(h.instancesPreviousData,0,_));this._processInstancedBuffers(a,f),n&&void 0!==r&&(this.getScene()._activeIndices.addCount(e.indexCount*_,false),s._currentDrawContext&&(s._currentDrawContext.useInstancing=true),this._bind(e,n,r),this._draw(e,r,_)),!this._scene.needsPreviousWorldMatrices||g||!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||this._instanceDataStorage.previousManualUpdate||u.updateDirectly(h.instancesData,0,_);}_renderWithInstances(e,t,i,s,r){const n=i.visibleInstances[e._id],a=n?n.length:0,o=i.parent,h=o.instancesBufferSize,l=16*(a+1)*4;for(;o.instancesBufferSize<l;)o.instancesBufferSize*=2;return o.instancesData&&h==o.instancesBufferSize||(o.instancesData=new Float32Array(o.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!o.instancesPreviousData||h!=o.instancesBufferSize)&&(o.instancesPreviousData=new Float32Array(o.instancesBufferSize/4)),this._updateInstancedBuffers(e,i,h,r,t,s),r.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,s){const r=this._thinInstanceDataStorage?.instancesCount??0;this.getScene()._activeIndices.addCount(e.indexCount*r,false),s._currentDrawContext&&(s._currentDrawContext.useInstancing=true),this._bind(e,i,t),this._draw(e,t,r),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,r):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,false)),s.unbindInstanceAttributes();}_processInstancedBuffers(e,t){}_processRendering(e,t,i,s,r,n,a,o){const h=this.getScene(),l=h.getEngine();if(s=this._getRenderingFillMode(s),n&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,s,i,l),this;if(n)this._renderWithInstances(t,s,r,i,l);else {l._currentDrawContext&&(l._currentDrawContext.useInstancing=false);let i=0;r.renderSelf[t._id]&&(a&&a(false,e.getWorldMatrix(),o),i++,this._draw(t,s,this._instanceDataStorage.overridenInstanceCount));const n=r.visibleInstances[t._id];if(n){const e=n.length;i+=e;for(let i=0;i<e;i++){const e=n[i].getWorldMatrix();a&&a(true,e,o),this._draw(t,s);}}h._activeIndices.addCount(t.indexCount*i,false);}return this}_rebuild(e=false){for(const t in this._instanceDataStorage.renderPasses){const i=this._instanceDataStorage.renderPasses[t];i.instancesBuffer&&(e&&i.instancesBuffer.dispose(),i.instancesBuffer=null);}if(this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null);}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={});}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e);}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=true;}}_unFreeze(){this._instanceDataStorage.isFrozen=false;for(const e in this._instanceDataStorage.renderPasses){this._instanceDataStorage.renderPasses[e].previousBatch=null;}}renderWithRenderPassId(e,t,i,s,r=true){const n=this._scene.getEngine(),a=n.currentRenderPassId;if(void 0!==e&&(n.currentRenderPassId=e),s)(!r||r&&s.isInFrustum(this._scene._frustumPlanes))&&this.render(s,!!t,i);else for(let e=0;e<this.subMeshes.length;e++){const s=this.subMeshes[e];(!r||r&&s.isInFrustum(this._scene._frustumPlanes))&&this.render(s,!!t,i);}return void 0!==e&&(n.currentRenderPassId=a),this}directRender(){if(!this.subMeshes)return this;for(const e of this.subMeshes)this.render(e,false);return this}render(e,t,i){const s=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=false:this._internalAbstractMeshDataInfo._isActive=false;const r=s.activeCameras?.length??0;if((r>1&&s.activeCamera===s.activeCameras[0]||r<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const n=this._getInstancesRenderList(e._id,!!i);if(n.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const a=s.getEngine();let o=0,h=null;this.ignoreCameraMaxZ&&s.activeCamera&&!s._isInIntermediateRendering()&&(o=s.activeCamera.maxZ,h=s.activeCamera,s.activeCamera.maxZ=0,s.updateTransformMatrix(true)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const l=e.getRenderingMesh(),c=n.hardwareInstancedRendering[e._id]||l.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,u=this._instanceDataStorage,d=e.getMaterial();if(!d)return h&&(h.maxZ=o,s.updateTransformMatrix(true)),this;if(u.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===d){if(d._storeEffectOnSubMeshes&&!e._drawWrapper?._wasPreviouslyReady||!d._storeEffectOnSubMeshes&&!d._getDrawWrapper()._wasPreviouslyReady)return h&&(h.maxZ=o,s.updateTransformMatrix(true)),this}else {if(d._storeEffectOnSubMeshes){if(!d.isReadyForSubMesh(this,e,c))return h&&(h.maxZ=o,s.updateTransformMatrix(true)),this}else if(!d.isReady(this,c))return h&&(h.maxZ=o,s.updateTransformMatrix(true)),this;this._internalMeshDataInfo._effectiveMaterial=d;}if(t){const e=this._internalMeshDataInfo._effectiveMaterial;if(1===e.alphaModes.length)a.setAlphaMode(e.alphaMode);else for(let t=0;t<e.alphaModes.length;t++){const i=e.alphaModes[t];a.setAlphaMode(void 0!==i?i:Qe$1.ALPHA_COMBINE,false,t);}}let _;_=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const f=_?.effect??null;for(const t of s._beforeRenderingMeshStage)t.action(this,e,n,f);if(!_||!f)return h&&(h.maxZ=o,s.updateTransformMatrix(true)),this;const p=i||this;let g;if(u.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this._internalMeshDataInfo._effectiveMaterial.sideOrientation&&!this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)g=this._internalMeshDataInfo._effectiveSideOrientation;else {const e=p._getWorldMatrixDeterminant();g=this._internalMeshDataInfo._effectiveMaterial._getEffectiveOrientation(this),e<0&&(g=g===hr$1.ClockWiseSideOrientation?hr$1.CounterClockWiseSideOrientation:hr$1.ClockWiseSideOrientation),this._internalMeshDataInfo._effectiveSideOrientation=g;}const m=this._internalMeshDataInfo._effectiveMaterial._preBind(_,this._internalMeshDataInfo._effectiveSideOrientation);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&a.setDepthWrite(true);const T=this._internalMeshDataInfo._effectiveMaterial,E=T.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),c||this._bind(e,f,E,false);const A=p.getWorldMatrix();T._storeEffectOnSubMeshes?T.bindForSubMesh(A,this,e):T.bind(A,this),!T.backFaceCulling&&T.separateCullingPass&&(a.setState(true,T.zOffset,false,!m,T.cullBackFaces,T.stencil,T.zOffsetUnits),this._processRendering(this,e,f,E,n,c,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),a.setState(true,T.zOffset,false,m,T.cullBackFaces,T.stencil,T.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,f,E,n,c,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const t of s._afterRenderingMeshStage)t.action(this,e,n,f);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),h&&(h.maxZ=o,s.updateTransformMatrix(true)),2!==s.performancePriority||u.isFrozen||this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(Hi.MatricesWeightsKind)&&(this.isVerticesDataPresent(Hi.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights());}_normalizeSkinFourWeights(){const e=this.getVerticesData(Hi.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const t=e[i]+e[i+1]+e[i+2]+e[i+3];if(0===t)e[i]=1;else {const s=1/t;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s;}}this.setVerticesData(Hi.MatricesWeightsKind,e);}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(Hi.MatricesWeightsExtraKind),t=this.getVerticesData(Hi.MatricesWeightsKind),i=t.length;for(let s=0;s<i;s+=4){let i=t[s]+t[s+1]+t[s+2]+t[s+3];if(i+=e[s]+e[s+1]+e[s+2]+e[s+3],0===i)t[s]=1;else {const r=1/i;t[s]*=r,t[s+1]*=r,t[s+2]*=r,t[s+3]*=r,e[s]*=r,e[s+1]*=r,e[s+2]*=r,e[s+3]*=r;}}this.setVerticesData(Hi.MatricesWeightsKind,t),this.setVerticesData(Hi.MatricesWeightsKind,e);}validateSkinning(){const e=this.getVerticesData(Hi.MatricesWeightsExtraKind),t=this.getVerticesData(Hi.MatricesWeightsKind);if(null===t||null==this.skeleton)return {skinned:false,valid:true,report:"not skinned"};const i=t.length;let s=0,r=0,n=0,a=0;const o=null===e?4:8,h=[];for(let e=0;e<=o;e++)h[e]=0;for(let l=0;l<i;l+=4){let i=t[l],c=i,u=0===c?0:1;for(let r=1;r<o;r++){const n=r<4?t[l+r]:e[l+r-4];n>i&&s++,0!==n&&u++,c+=n,i=n;}if(h[u]++,u>n&&(n=u),0===c)r++;else {const i=1/c;let s=0;for(let r=0;r<o;r++)s+=r<4?Math.abs(t[l+r]-t[l+r]*i):Math.abs(e[l+r-4]-e[l+r-4]*i);s>.001&&a++;}}const l=this.skeleton.bones.length,c=this.getVerticesData(Hi.MatricesIndicesKind),u=this.getVerticesData(Hi.MatricesIndicesExtraKind);let d=0;for(let e=0;e<i;e+=4)for(let t=0;t<o;t++){const i=t<4?c[e+t]:u[e+t-4];(i>=l||i<0)&&d++;}return {skinned:true,valid:0===r&&0===a&&0===d,report:"Number of Weights = "+i/4+"\nMaximum influences = "+n+"\nMissing Weights = "+r+"\nNot Sorted = "+s+"\nNot Normalized = "+a+"\nWeightCounts = ["+h+"]\nNumber of bones = "+l+"\nBad Bone Indices = "+d}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===Qe$1.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=Qe$1.DELAYLOADSTATE_LOADING,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return Ai.LoadFile(this.delayLoadingFile,(t=>{t instanceof ArrayBuffer?this._delayLoadingFunction(t,this):this._delayLoadingFunction(JSON.parse(t),this);for(const e of this.instances)e.refreshBoundingInfo(),e._syncSubMeshes();this.delayLoadState=Qe$1.DELAYLOADSTATE_LOADED,e.removePendingData(this);}),(()=>{}),e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState!==Qe$1.DELAYLOADSTATE_LOADING&&(!!super.isInFrustum(e)&&(this._checkDelayState(),true))}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const s=this.getScene().multiMaterials;for(i=s.length-1;i>-1;i--)if(s[i].id===e)return this.material=s[i],this;return this}getAnimatables(){const e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(Hi.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(Hi.PositionKind);const s=te$4.Zero();let r;for(r=0;r<i.length;r+=3)te$4.TransformCoordinatesFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).toArray(i,r);if(this.setVerticesData(Hi.PositionKind,i,this.getVertexBuffer(Hi.PositionKind).isUpdatable()),this.isVerticesDataPresent(Hi.NormalKind)){for(i=this.getVerticesData(Hi.NormalKind),r=0;r<i.length;r+=3)te$4.TransformNormalFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).normalize().toArray(i,r);this.setVerticesData(Hi.NormalKind,i,this.getVertexBuffer(Hi.NormalKind).isUpdatable());}if(this.isVerticesDataPresent(Hi.TangentKind)){for(i=this.getVerticesData(Hi.TangentKind),r=0;r<i.length;r+=4)te$4.TransformNormalFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).normalize().toArray(i,r);this.setVerticesData(Hi.TangentKind,i,this.getVertexBuffer(Hi.TangentKind).isUpdatable());}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=true,t=false){return t&&this.makeGeometryUnique(),this.bakeTransformIntoVertices(this.computeWorldMatrix(true)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions||this._geometry&&this._geometry._positions||null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return !!this._geometry&&this._geometry._generatePointsArray()}clone(e="",t=null,i,s=true){if(t&&void 0===t._addToSceneRootNodes){const i=t;return Tr$1.source=this,Tr$1.doNotCloneChildren=i.doNotCloneChildren,Tr$1.clonePhysicsImpostor=i.clonePhysicsImpostor,Tr$1.cloneThinInstances=i.cloneThinInstances,new Er(e,this.getScene(),Tr$1)}return new Er(e,this.getScene(),t,this,i,s)}dispose(e,t=false){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,true);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const e in i.meshMap){const t=i.meshMap[e];t&&(t._internalMeshDataInfo._source=null,i.meshMap[e]=void 0);}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0);}else {const e=this.getScene().meshes;for(const t of e){const e=t;e._internalMeshDataInfo&&e._internalMeshDataInfo._source&&e._internalMeshDataInfo._source===this&&(e._internalMeshDataInfo._source=null);}}i._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t);}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,s,r,n,a=false,o){const h=this.getScene();return Ai.LoadImage(e,(e=>{const o=e.width,h=e.height,l=this.getEngine().createCanvas(o,h).getContext("2d");l.drawImage(e,0,0);const c=l.getImageData(0,0,o,h).data;this.applyDisplacementMapFromBuffer(c,o,h,t,i,r,n,a),s&&s(this);}),o||(()=>{}),h.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,s,r,n,a,o=false){if(!this.isVerticesDataPresent(Hi.PositionKind)||!this.isVerticesDataPresent(Hi.NormalKind)||!this.isVerticesDataPresent(Hi.UVKind))return Ie$2.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const h=this.getVerticesData(Hi.PositionKind,true,true),l=this.getVerticesData(Hi.NormalKind),c=this.getVerticesData(Hi.UVKind);let u=te$4.Zero();const d=te$4.Zero(),_=ee$4.Zero();n=n||ee$4.Zero(),a=a||new ee$4(1,1);for(let o=0;o<h.length;o+=3){te$4.FromArrayToRef(h,o,u),te$4.FromArrayToRef(l,o,d),ee$4.FromArrayToRef(c,o/3*2,_);const f=4*((Math.abs(_.x*a.x+n.x%1)*(t-1)%t|0)+(Math.abs(_.y*a.y+n.y%1)*(i-1)%i|0)*t),p=.3*(e[f]/255)+.59*(e[f+1]/255)+.11*(e[f+2]/255);d.normalize(),d.scaleInPlace(s+(r-s)*p),u=u.add(d),u.toArray(h,o);}return is.ComputeNormals(h,this.getIndices(),l),o?(this.setVerticesData(Hi.PositionKind,h),this.setVerticesData(Hi.NormalKind,l),this.setVerticesData(Hi.UVKind,c)):(this.updateVerticesData(Hi.PositionKind,h),this.updateVerticesData(Hi.NormalKind,l)),this}_getFlattenedNormals(e,t){const i=new Float32Array(3*e.length);let s=0;const r=this.sideOrientation===(this._scene.useRightHandedSystem?Qe$1.MATERIAL_CounterClockWiseSideOrientation:Qe$1.MATERIAL_ClockWiseSideOrientation);for(let n=0;n<e.length;n+=3){const a=te$4.FromArray(t,3*e[n]),o=te$4.FromArray(t,3*e[n+1]),h=te$4.FromArray(t,3*e[n+2]),l=a.subtract(o),c=h.subtract(o),u=te$4.Normalize(te$4.Cross(l,c));r&&u.scaleInPlace(-1);for(let e=0;e<3;e++)i[s++]=u.x,i[s++]=u.y,i[s++]=u.z;}return i}_convertToUnIndexedMesh(e=false){const t=this.getVerticesDataKinds().filter((e=>!this.getVertexBuffer(e)?.getIsInstanced())),i=this.getIndices(),s={},r=(e,t)=>{const s=new Float32Array(i.length*t);let r=0;for(let n=0;n<i.length;n++)for(let a=0;a<t;a++)s[r++]=e[i[n]*t+a];return s},n=this.getBoundingInfo(),a=this.geometry?this.subMeshes.slice(0):[];for(const e of t)s[e]=this.getVerticesData(e);for(const n of t){const t=this.getVertexBuffer(n),a=t.getSize();if(e&&n===Hi.NormalKind){const e=this._getFlattenedNormals(i,s[Hi.PositionKind]);this.setVerticesData(Hi.NormalKind,e,t.isUpdatable(),a);}else this.setVerticesData(n,r(s[n],a),t.isUpdatable(),a);}if(this.morphTargetManager){for(let t=0;t<this.morphTargetManager.numTargets;t++){const s=this.morphTargetManager.getTarget(t),n=s.getPositions();s.setPositions(r(n,3));const a=s.getNormals();a&&s.setNormals(e?this._getFlattenedNormals(i,n):r(a,3));const o=s.getTangents();o&&s.setTangents(r(o,3));const h=s.getUVs();h&&s.setUVs(r(h,2));const l=s.getColors();l&&s.setColors(r(l,4));}this.morphTargetManager.synchronize();}for(let e=0;e<i.length;e++)i[e]=e;this.setIndices(i),this._unIndexed=true,this.releaseSubMeshes();for(const e of a){const t=e.getBoundingInfo();es.AddToMesh(e.materialIndex,e.indexStart,e.indexCount,e.indexStart,e.indexCount,this).setBoundingInfo(t);}return this.setBoundingInfo(n),this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(true)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=false){const t=is.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(Hi.NormalKind)&&t.normals){for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;this.setVerticesData(Hi.NormalKind,t.normals,this.isVertexBufferUpdatable(Hi.NormalKind));}if(t.indices){let e;for(i=0;i<t.indices.length;i+=3)e=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=e;this.setIndices(t.indices,null,this.isVertexBufferUpdatable(Hi.PositionKind),true);}return this}increaseVertices(e=1){const t=is.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,s=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,r=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,n=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(i&&s){t.indices=i,t.positions=s,r&&(t.uvs=r),n&&(t.normals=n);const a=e+1,o=[];for(let e=0;e<a+1;e++)o[e]=[];let h,l;const c=new te$4(0,0,0),u=new te$4(0,0,0),d=new ee$4(0,0),_=[],f=[],p=[];let g,m,T,E=s.length;r&&(m=r.length),n&&(T=n.length);for(let e=0;e<i.length;e+=3){f[0]=i[e],f[1]=i[e+1],f[2]=i[e+2];for(let e=0;e<3;e++)if(h=f[e],l=f[(e+1)%3],void 0===p[h]&&void 0===p[l]?(p[h]=[],p[l]=[]):(void 0===p[h]&&(p[h]=[]),void 0===p[l]&&(p[l]=[])),void 0===p[h][l]&&void 0===p[l][h]){p[h][l]=[],c.x=(s[3*l]-s[3*h])/a,c.y=(s[3*l+1]-s[3*h+1])/a,c.z=(s[3*l+2]-s[3*h+2])/a,n&&(u.x=(n[3*l]-n[3*h])/a,u.y=(n[3*l+1]-n[3*h+1])/a,u.z=(n[3*l+2]-n[3*h+2])/a),r&&(d.x=(r[2*l]-r[2*h])/a,d.y=(r[2*l+1]-r[2*h+1])/a),p[h][l].push(h);for(let e=1;e<a;e++)p[h][l].push(s.length/3),s[E++]=s[3*h]+e*c.x,s[E++]=s[3*h+1]+e*c.y,s[E++]=s[3*h+2]+e*c.z,n&&(n[T++]=n[3*h]+e*u.x,n[T++]=n[3*h+1]+e*u.y,n[T++]=n[3*h+2]+e*u.z),r&&(r[m++]=r[2*h]+e*d.x,r[m++]=r[2*h+1]+e*d.y);p[h][l].push(l),p[l][h]=[],g=p[h][l].length;for(let e=0;e<g;e++)p[l][h][e]=p[h][l][g-1-e];}o[0][0]=i[e],o[1][0]=p[i[e]][i[e+1]][1],o[1][1]=p[i[e]][i[e+2]][1];for(let t=2;t<a;t++){o[t][0]=p[i[e]][i[e+1]][t],o[t][t]=p[i[e]][i[e+2]][t],c.x=(s[3*o[t][t]]-s[3*o[t][0]])/t,c.y=(s[3*o[t][t]+1]-s[3*o[t][0]+1])/t,c.z=(s[3*o[t][t]+2]-s[3*o[t][0]+2])/t,n&&(u.x=(n[3*o[t][t]]-n[3*o[t][0]])/t,u.y=(n[3*o[t][t]+1]-n[3*o[t][0]+1])/t,u.z=(n[3*o[t][t]+2]-n[3*o[t][0]+2])/t),r&&(d.x=(r[2*o[t][t]]-r[2*o[t][0]])/t,d.y=(r[2*o[t][t]+1]-r[2*o[t][0]+1])/t);for(let e=1;e<t;e++)o[t][e]=s.length/3,s[E++]=s[3*o[t][0]]+e*c.x,s[E++]=s[3*o[t][0]+1]+e*c.y,s[E++]=s[3*o[t][0]+2]+e*c.z,n&&(n[T++]=n[3*o[t][0]]+e*u.x,n[T++]=n[3*o[t][0]+1]+e*u.y,n[T++]=n[3*o[t][0]+2]+e*u.z),r&&(r[m++]=r[2*o[t][0]]+e*d.x,r[m++]=r[2*o[t][0]+1]+e*d.y);}o[a]=p[i[e+1]][i[e+2]],_.push(o[0][0],o[1][0],o[1][1]);for(let e=1;e<a;e++){let t;for(t=0;t<e;t++)_.push(o[e][t],o[e+1][t],o[e+1][t+1]),_.push(o[e][t],o[e+1][t+1],o[e][t+1]);_.push(o[e][t],o[e+1][t],o[e+1][t+1]);}}t.indices=_,t.applyToMesh(this,this.isVertexBufferUpdatable(Hi.PositionKind));}else Ie$2.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");}forceSharedVertices(){const e=is.ExtractFromMesh(this),t=e.uvs,i=e.indices,s=e.positions,r=e.colors,n=e.matricesIndices,a=e.matricesWeights,o=e.matricesIndicesExtra,h=e.matricesWeightsExtra;if(void 0===i||void 0===s||null===i||null===s)Ie$2.Warn("VertexData contains empty entries");else {const l=[],c=[],u=[],d=[],_=[],f=[],p=[],g=[];let m=[],T=0;const E={};let A,R;for(let e=0;e<i.length;e+=3){R=[i[e],i[e+1],i[e+2]],m=[];for(let e=0;e<3;e++){m[e]="";for(let t=0;t<3;t++)Math.abs(s[3*R[e]+t])<1e-8&&(s[3*R[e]+t]=0),m[e]+=s[3*R[e]+t]+"|";}if(m[0]!=m[1]&&m[0]!=m[2]&&m[1]!=m[2])for(let e=0;e<3;e++){if(A=E[m[e]],void 0===A){E[m[e]]=T,A=T++;for(let t=0;t<3;t++)l.push(s[3*R[e]+t]);if(null!=r)for(let t=0;t<4;t++)d.push(r[4*R[e]+t]);if(null!=t)for(let i=0;i<2;i++)u.push(t[2*R[e]+i]);if(null!=n)for(let t=0;t<4;t++)_.push(n[4*R[e]+t]);if(null!=a)for(let t=0;t<4;t++)f.push(a[4*R[e]+t]);if(null!=o)for(let t=0;t<4;t++)p.push(o[4*R[e]+t]);if(null!=h)for(let t=0;t<4;t++)g.push(h[4*R[e]+t]);}c.push(A);}}const b=[];is.ComputeNormals(l,c,b),e.positions=l,e.indices=c,e.normals=b,null!=t&&(e.uvs=u),null!=r&&(e.colors=d),null!=n&&(e.matricesIndices=_),null!=a&&(e.matricesWeights=f),null!=o&&(e.matricesIndicesExtra=p),null!=a&&(e.matricesWeightsExtra=g),e.applyToMesh(this,this.isVertexBufferUpdatable(Hi.PositionKind));}}static _instancedMeshFactory(e,t){throw le$4("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw le$4("PhysicsImpostor")}createInstance(e){const t=Er._instancedMeshFactory(e,this);return t.parent=this.parent,t}synchronizeInstances(){for(let e=0;e<this.instances.length;e++){this.instances[e]._syncSubMeshes();}return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(Hi.PositionKind);if(!i||!t)return this;const s=[];for(let e=0;e<i.length;e+=3)s.push(te$4.FromArray(i,e));const r=[];return Ri.SyncAsyncForLoop(s.length,40,(e=>{const t=s.length-1-e,i=s[t];for(let e=0;e<t;++e){const n=s[e];if(i.equals(n)){r[t]=e;break}}}),(()=>{for(let e=0;e<t.length;++e)t[e]=r[t[e]]||t[e];const i=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=i,e&&e(this);})),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),ue$4&&ue$4.HasTags(this)&&(e.tags=ue$4.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(false),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.alwaysSelectAsActiveMesh=this.alwaysSelectAsActiveMesh,e.checkCollisions=this.checkCollisions,e.ellipsoid=this.ellipsoid.asArray(),e.ellipsoidOffset=this.ellipsoidOffset.asArray(),e.doNotSyncBoundingInfo=this.doNotSyncBoundingInfo,e.isBlocker=this.isBlocker,e.sideOrientation=this.sideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let t=0;t<this.subMeshes.length;t++){const i=this.subMeshes[t];e.subMeshes.push({materialIndex:i.materialIndex,verticesStart:i.verticesStart,verticesCount:i.verticesCount,indexStart:i.indexStart,indexCount:i.indexCount});}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(cr$1.NAME_PHYSICSENGINE)){const t=this.getPhysicsImpostor();t&&(e.physicsMass=t.getParam("mass"),e.physicsFriction=t.getParam("friction"),e.physicsRestitution=t.getParam("mass"),e.physicsImpostor=t.type);}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let t=0;t<this.instances.length;t++){const i=this.instances[t];if(i.doNotSerialize)continue;const s={name:i.name,id:i.id,isEnabled:i.isEnabled(false),isVisible:i.isVisible,isPickable:i.isPickable,checkCollisions:i.checkCollisions,position:i.position.asArray(),scaling:i.scaling.asArray()};if(i.parent&&i.parent._serializeAsParent(s),i.rotationQuaternion?s.rotationQuaternion=i.rotationQuaternion.asArray():i.rotation&&(s.rotation=i.rotation.asArray()),this.getScene()._getComponent(cr$1.NAME_PHYSICSENGINE)){const e=i.getPhysicsImpostor();e&&(s.physicsMass=e.getParam("mass"),s.physicsFriction=e.getParam("friction"),s.physicsRestitution=e.getParam("mass"),s.physicsImpostor=e.type);}i.metadata&&(s.metadata=i.metadata),i.actionManager&&(s.actions=i.actionManager.serialize(i.name)),e.instances.push(s),Ae$3.AppendSerializedAnimations(i,s),s.ranges=i.serializeAnimationRanges();}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const t={data:{},sizes:{},strides:{}};for(const e in this._userThinInstanceBuffersStorage.data)t.data[e]=Array.from(this._userThinInstanceBuffersStorage.data[e]),t.sizes[e]=this._userThinInstanceBuffersStorage.sizes[e],t.strides[e]=this._userThinInstanceBuffersStorage.strides[e];e.thinInstances.userThinInstance=t;}return Ae$3.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return Ie$2.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),s=i.getPositions();if(!s)return void Ie$2.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(Hi.PositionKind+t,s,false,3);const r=i.getNormals();r&&this.geometry.setVerticesData(Hi.NormalKind+t,r,false,3);const n=i.getTangents();n&&this.geometry.setVerticesData(Hi.TangentKind+t,n,false,3);const a=i.getUVs();a&&this.geometry.setVerticesData(Hi.UVKind+"_"+t,a,false,2);const o=i.getUV2s();o&&this.geometry.setVerticesData(Hi.UV2Kind+"_"+t,o,false,2);const h=i.getColors();h&&this.geometry.setVerticesData(Hi.ColorKind+t,h,false,4);}}else {let e=0;for(;this.geometry.isVerticesDataPresent(Hi.PositionKind+e);)this.geometry.removeVerticesData(Hi.PositionKind+e),this.geometry.isVerticesDataPresent(Hi.NormalKind+e)&&this.geometry.removeVerticesData(Hi.NormalKind+e),this.geometry.isVerticesDataPresent(Hi.TangentKind+e)&&this.geometry.removeVerticesData(Hi.TangentKind+e),this.geometry.isVerticesDataPresent(Hi.UVKind+e)&&this.geometry.removeVerticesData(Hi.UVKind+"_"+e),this.geometry.isVerticesDataPresent(Hi.UV2Kind+e)&&this.geometry.removeVerticesData(Hi.UV2Kind+"_"+e),this.geometry.isVerticesDataPresent(Hi.ColorKind+e)&&this.geometry.removeVerticesData(Hi.ColorKind+e),e++;}}static Parse(e,t,i){let s;if(s=e.type&&"LinesMesh"===e.type?Er._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?Er._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?Er._GoldbergMeshParser(e,t):e.type&&"GreasedLineMesh"===e.type?Er._GreasedLineMeshParser(e,t):e.type&&"TrailMesh"===e.type?Er._TrailMeshParser(e,t):new Er(e.name,t),s.id=e.id,s._waitingParsedUniqueId=e.uniqueId,ue$4&&ue$4.AddTagsTo(s,e.tags),s.position=te$4.FromArray(e.position),void 0!==e.metadata&&(s.metadata=e.metadata),e.rotationQuaternion?s.rotationQuaternion=se$5.FromArray(e.rotationQuaternion):e.rotation&&(s.rotation=te$4.FromArray(e.rotation)),s.scaling=te$4.FromArray(e.scaling),e.localMatrix?s.setPreTransformMatrix(re$5.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(re$5.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s.isVisible=e.isVisible,s.infiniteDistance=e.infiniteDistance,s.alwaysSelectAsActiveMesh=!!e.alwaysSelectAsActiveMesh,s.showBoundingBox=e.showBoundingBox,s.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(s.applyFog=e.applyFog),void 0!==e.pickable&&(s.isPickable=e.pickable),void 0!==e.alphaIndex&&(s.alphaIndex=e.alphaIndex),s.receiveShadows=e.receiveShadows,void 0!==e.billboardMode&&(s.billboardMode=e.billboardMode),void 0!==e.visibility&&(s.visibility=e.visibility),s.checkCollisions=e.checkCollisions,s.doNotSyncBoundingInfo=!!e.doNotSyncBoundingInfo,e.ellipsoid&&(s.ellipsoid=te$4.FromArray(e.ellipsoid)),e.ellipsoidOffset&&(s.ellipsoidOffset=te$4.FromArray(e.ellipsoidOffset)),null!=e.overrideMaterialSideOrientation&&(s.sideOrientation=e.overrideMaterialSideOrientation),void 0!==e.sideOrientation&&(s.sideOrientation=e.sideOrientation),void 0!==e.isBlocker&&(s.isBlocker=e.isBlocker),s._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(s._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(s._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(s.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(s.overlayColor=ge$3.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(s.renderOverlay=e.renderOverlay),s.isUnIndexed=!!e.isUnIndexed,s.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(s.delayLoadState=Qe$1.DELAYLOADSTATE_NOTLOADED,s.delayLoadingFile=i+e.delayLoadingFile,s.buildBoundingInfo(te$4.FromArray(e.boundingBoxMinimum),te$4.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(s._binaryInfo=e._binaryInfo),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(Hi.UVKind),e.hasUVs2&&s._delayInfo.push(Hi.UV2Kind),e.hasUVs3&&s._delayInfo.push(Hi.UV3Kind),e.hasUVs4&&s._delayInfo.push(Hi.UV4Kind),e.hasUVs5&&s._delayInfo.push(Hi.UV5Kind),e.hasUVs6&&s._delayInfo.push(Hi.UV6Kind),e.hasColors&&s._delayInfo.push(Hi.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(Hi.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(Hi.MatricesWeightsKind),s._delayLoadingFunction=rs._ImportGeometry,ss.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):rs._ImportGeometry(e,s),e.materialUniqueId?s._waitingMaterialId=e.materialUniqueId:e.materialId&&(s._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(s._waitingMorphTargetManagerId=e.morphTargetManagerId),void 0!==e.skeletonId&&null!==e.skeletonId&&(s.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(s.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=O$g("BABYLON.Animation");r&&s.animations.push(r.Parse(i));}be$3.ParseAnimationRanges(s,e,t);}if(e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?s.layerMask=Math.abs(parseInt(e.layerMask)):s.layerMask=268435455,e.physicsImpostor&&(s.physicsImpostor=Er._PhysicsImpostorParser(t,s,e)),e.lodMeshIds&&(s._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let i=0;i<e.instances.length;i++){const r=e.instances[i],n=s.createInstance(r.name);if(r.id&&(n.id=r.id),ue$4&&(r.tags?ue$4.AddTagsTo(n,r.tags):ue$4.AddTagsTo(n,e.tags)),n.position=te$4.FromArray(r.position),void 0!==r.metadata&&(n.metadata=r.metadata),void 0!==r.parentId&&(n._waitingParentId=r.parentId),void 0!==r.parentInstanceIndex&&(n._waitingParentInstanceIndex=r.parentInstanceIndex),void 0!==r.isEnabled&&null!==r.isEnabled&&n.setEnabled(r.isEnabled),void 0!==r.isVisible&&null!==r.isVisible&&(n.isVisible=r.isVisible),void 0!==r.isPickable&&null!==r.isPickable&&(n.isPickable=r.isPickable),r.rotationQuaternion?n.rotationQuaternion=se$5.FromArray(r.rotationQuaternion):r.rotation&&(n.rotation=te$4.FromArray(r.rotation)),n.scaling=te$4.FromArray(r.scaling),null!=r.checkCollisions&&null!=r.checkCollisions&&(n.checkCollisions=r.checkCollisions),null!=r.pickable&&null!=r.pickable&&(n.isPickable=r.pickable),null!=r.showBoundingBox&&null!=r.showBoundingBox&&(n.showBoundingBox=r.showBoundingBox),null!=r.showSubMeshesBoundingBox&&null!=r.showSubMeshesBoundingBox&&(n.showSubMeshesBoundingBox=r.showSubMeshesBoundingBox),null!=r.alphaIndex&&null!=r.showSubMeshesBoundingBox&&(n.alphaIndex=r.alphaIndex),r.physicsImpostor&&(n.physicsImpostor=Er._PhysicsImpostorParser(t,n,r)),void 0!==r.actions&&(n._waitingData.actions=r.actions),r.animations){for(let e=0;e<r.animations.length;e++){const t=r.animations[e],i=O$g("BABYLON.Animation");i&&n.animations.push(i.Parse(t));}be$3.ParseAnimationRanges(n,r,t),r.autoAnimate&&t.beginAnimation(n,r.autoAnimateFrom,r.autoAnimateTo,r.autoAnimateLoop,r.autoAnimateSpeed||1);}}if(e.thinInstances){const t=e.thinInstances;if(s.thinInstanceEnablePicking=!!t.enablePicking,t.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(t.matrixData),16,false),s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,s._thinInstanceDataStorage.instancesCount=t.instancesCount):s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,e.thinInstances.userThinInstance){const t=e.thinInstances.userThinInstance;for(const e in t.data)s.thinInstanceSetBuffer(e,new Float32Array(t.data[e]),t.strides[e],false),s._userThinInstanceBuffersStorage.sizes[e]=t.sizes[e];}}return s}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(Hi.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(Hi.PositionKind)||this.setVerticesData(Hi.PositionKind,t,true);}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(Hi.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(Hi.NormalKind)||this.setVerticesData(Hi.NormalKind,t,true);}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(Hi.PositionKind))return this;if(!this.isVerticesDataPresent(Hi.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(Hi.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(Hi.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e;}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(Hi.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let r=this.getVerticesData(Hi.NormalKind);if(t){if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));}const n=this.getVerticesData(Hi.MatricesIndicesKind),a=this.getVerticesData(Hi.MatricesWeightsKind);if(!a||!n)return this;const o=this.numBoneInfluencers>4,h=o?this.getVerticesData(Hi.MatricesIndicesExtraKind):null,l=o?this.getVerticesData(Hi.MatricesWeightsExtraKind):null,c=e.getTransformMatrices(this),u=te$4.Zero(),d=new re$5,_=new re$5;let f,p=0;for(let e=0;e<s.length;e+=3,p+=4){let g;for(f=0;f<4;f++)g=a[p+f],g>0&&(re$5.FromFloat32ArrayToRefScaled(c,Math.floor(16*n[p+f]),g,_),d.addToSelf(_));if(o)for(f=0;f<4;f++)g=l[p+f],g>0&&(re$5.FromFloat32ArrayToRefScaled(c,Math.floor(16*h[p+f]),g,_),d.addToSelf(_));te$4.TransformCoordinatesFromFloatsToRef(i._sourcePositions[e],i._sourcePositions[e+1],i._sourcePositions[e+2],d,u),u.toArray(s,e),t&&(te$4.TransformNormalFromFloatsToRef(i._sourceNormals[e],i._sourceNormals[e+1],i._sourceNormals[e+2],d,u),u.toArray(r,e)),d.reset();}return this.updateVerticesData(Hi.PositionKind,s),t&&this.updateVerticesData(Hi.NormalKind,r),this}static MinMax(e){let t=null,i=null;for(const s of e){const e=s.getBoundingInfo().boundingBox;t&&i?(t.minimizeInPlace(e.minimumWorld),i.maximizeInPlace(e.maximumWorld)):(t=e.minimumWorld.clone(),i=e.maximumWorld.clone());}return t&&i?{min:t,max:i}:{min:te$4.Zero(),max:te$4.Zero()}}static Center(e){const t=e instanceof Array?Er.MinMax(e):e;return te$4.Center(t.min,t.max)}static MergeMeshes(e,t=true,i,s,r,n){return Mi(Er._MergeMeshesCoroutine(e,t,i,s,r,n,false))}static async MergeMeshesAsync(e,t=true,i,s,r,n){return await yi(Er._MergeMeshesCoroutine(e,t,i,s,r,n,true),Si())}static*_MergeMeshesCoroutine(e,t=true,i,s,r,n,a){if(0===(e=e.filter(Boolean)).length)return null;let o;if(!i){let t=0;for(o=0;o<e.length;o++)if(t+=e[o].getTotalVertices(),t>=65536)return Ie$2.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}n&&(r=false);const h=new Array,l=new Array,c=new Array,u=e[0].sideOrientation;for(o=0;o<e.length;o++){const t=e[o];if(t.isAnInstance)return Ie$2.Warn("Cannot merge instance meshes."),null;if(u!==t.sideOrientation)return Ie$2.Warn("Cannot merge meshes with different sideOrientation values."),null;if(r&&c.push({start:0,count:t.getTotalIndices()}),n){const e=c.reduce(((e,t)=>Math.max(e,t.start+t.count)),0);if(t.material){const i=t.material;if(i instanceof lr$1){for(let e=0;e<i.subMaterials.length;e++)h.indexOf(i.subMaterials[e])<0&&h.push(i.subMaterials[e]);for(let s=0;s<t.subMeshes.length;s++)l.push(h.indexOf(i.subMaterials[t.subMeshes[s].materialIndex])),c.push({start:e+t.subMeshes[s].indexStart,count:t.subMeshes[s].indexCount});}else {h.indexOf(i)<0&&h.push(i);for(let s=0;s<t.subMeshes.length;s++)l.push(h.indexOf(i)),c.push({start:e+t.subMeshes[s].indexStart,count:t.subMeshes[s].indexCount});}}else for(let i=0;i<t.subMeshes.length;i++)l.push(0),c.push({start:e+t.subMeshes[i].indexStart,count:t.subMeshes[i].indexCount});}}const d=e[0],_=e=>{const t=e.computeWorldMatrix(true);return {vertexData:is.ExtractFromMesh(e,false,false),transform:t}},{vertexData:f,transform:p}=_(d);a&&(yield);const g=new Array(e.length-1);for(let t=1;t<e.length;t++)g[t-1]=_(e[t]),a&&(yield);const m=f._mergeCoroutine(p,g,i,a,!t);let T=m.next();for(;!T.done;)a&&(yield),T=m.next();const E=T.value;s||(s=new Er(d.name+"_merged",d.getScene()));const A=E._applyToCoroutine(s,void 0,a);let R=A.next();for(;!R.done;)a&&(yield),R=A.next();if(s.checkCollisions=d.checkCollisions,s.sideOrientation=d.sideOrientation,t)for(o=0;o<e.length;o++)e[o].dispose();if(r||n){for(s.releaseSubMeshes(),o=0;o<c.length;)es.CreateFromIndices(0,c[o].start,c[o].count,s,void 0,false),o++;for(const e of s.subMeshes)e.refreshBoundingInfo();s.computeWorldMatrix(true);}if(n){const e=new lr$1(d.name+"_merged",d.getScene());e.subMaterials=h;for(let e=0;e<s.subMeshes.length;e++)s.subMeshes[e].materialIndex=l[e];s.material=e;}else s.material=d.material;return s}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e);}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){const e=this.instances[this.instances.length-1];this.instances[t]=e,e._indexInSourceMeshInstanceArray=t;}e._indexInSourceMeshInstanceArray=-1,this.instances.pop();}}_shouldConvertRHS(){return this._scene.useRightHandedSystem&&this.sideOrientation===hr$1.CounterClockWiseSideOrientation}_getRenderingFillMode(e){const t=this.getScene();return t.forcePointsCloud?hr$1.PointFillMode:t.forceWireframe?hr$1.WireFrameFillMode:this.overrideRenderingFillMode??e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,s,r,n,a,o,h){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,s){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,s,r,n,a,o,h){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,s,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,s,r,n,a,o,h,l){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,s,r,n,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,s,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,s,r,n,a,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,s,r,n,a,o,h,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,s,r,n,a,o,h,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,s,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,s,r,n,a,o,h){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,s,r,n,a,o,h,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,s,r,n,a,o,h,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}};Er$1.FRONTSIDE=is.FRONTSIDE,Er$1.BACKSIDE=is.BACKSIDE,Er$1.DOUBLESIDE=is.DOUBLESIDE,Er$1.DEFAULTSIDE=is.DEFAULTSIDE,Er$1.NO_CAP=0,Er$1.CAP_START=1,Er$1.CAP_END=2,Er$1.CAP_ALL=3,Er$1.NO_FLIP=0,Er$1.FLIP_TILE=1,Er$1.ROTATE_TILE=2,Er$1.FLIP_ROW=3,Er$1.ROTATE_ROW=4,Er$1.FLIP_N_ROTATE_TILE=5,Er$1.FLIP_N_ROTATE_ROW=6,Er$1.CENTER=0,Er$1.LEFT=1,Er$1.RIGHT=2,Er$1.TOP=3,Er$1.BOTTOM=4,Er$1.INSTANCEDMESH_SORT_TRANSPARENT=false,Er$1._GroundMeshParser=(e,t)=>{throw le$4("GroundMesh")},Er$1._GoldbergMeshParser=(e,t)=>{throw le$4("GoldbergMesh")},Er$1._LinesMeshParser=(e,t)=>{throw le$4("LinesMesh")},Er$1._GreasedLineMeshParser=(e,t)=>{throw le$4("GreasedLineMesh")},Er$1._GreasedLineRibbonMeshParser=(e,t)=>{throw le$4("GreasedLineRibbonMesh")},Er$1._TrailMeshParser=(e,t)=>{throw le$4("TrailMesh")},P$9("BABYLON.Mesh",Er$1);let Ar$1=class Ar{};Ar$1.POINTERDOWN=1,Ar$1.POINTERUP=2,Ar$1.POINTERMOVE=4,Ar$1.POINTERWHEEL=8,Ar$1.POINTERPICK=16,Ar$1.POINTERTAP=32,Ar$1.POINTERDOUBLETAP=64;let Rr$1=class Rr{constructor(e,t){this.type=e,this.event=t;}};let br$1=class br extends Rr$1{constructor(e,t,i,s){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=false,this.localPosition=new ee$4(i,s);}};let Sr$1=class Sr extends Rr$1{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,s=null){super(e,t),this._pickInfo=i,this._inputManager=s;}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null);}};let xr$1=class xr{constructor(){this._zoomStopsAnimation=false,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=false,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0;}get name(){return "AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e;}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e;}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e;}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e;}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==Ar$1.POINTERDOWN?e.type===Ar$1.POINTERUP&&(this._isPointerDown=false):this._isPointerDown=true;})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{if(this._reachTargetAlpha())return;const e=Pe$2.Now;let t=0;null!=this._lastFrameTime&&(t=e-this._lastFrameTime),this._lastFrameTime=e,this._applyUserInteraction();const i=e-this._lastInteractionTime-this._idleRotationWaitTime,s=Math.max(Math.min(i/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*s,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(t/1e3));}));}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null,this._lastFrameTime=null;}resetLastInteractionTime(e){this._lastInteractionTime=e??Pe$2.Now;}_reachTargetAlpha(){return !(!this._attachedCamera||!this.targetAlpha)&&Math.abs(this._attachedCamera.alpha-this.targetAlpha)<x$d}_userIsZooming(){return !!this._attachedCamera&&0!==this._attachedCamera.inertialRadiusOffset}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return  false;let e=false;return this._lastFrameRadius===this._attachedCamera.radius&&0!==this._attachedCamera.inertialRadiusOffset&&(e=true),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Pe$2.Now);}_userIsMoving(){return !!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}};var Mr$1;!function(e){e[e.CW=0]="CW",e[e.CCW=1]="CCW";}(Mr$1||(Mr$1={}));let yr$1=class yr{static Interpolate(e,t,i,s,r){if(0===e)return 0;const n=1-3*s+3*t,a=3*s-6*t,o=3*t;let h=e;for(let t=0;t<5;t++){const t=h*h;h-=(n*(t*h)+a*t+o*h-e)*(1/(3*n*t+2*a*h+o)),h=Math.min(1,Math.max(0,h));}return 3*Math.pow(1-h,2)*h*i+3*(1-h)*Math.pow(h,2)*r+Math.pow(h,3)}};let Ir$1=class Ir{constructor(){this._easingMode=Ir.EASINGMODE_EASEIN;}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t;}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case Ir.EASINGMODE_EASEIN:return this.easeInCore(e);case Ir.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?.5*(1-this.easeInCore(2*(1-e)))+.5:.5*this.easeInCore(2*e)}};Ir$1.EASINGMODE_EASEIN=0,Ir$1.EASINGMODE_EASEOUT=1,Ir$1.EASINGMODE_EASEINOUT=2;let Cr$1=class Cr extends Ir$1{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}};let vr$1=class vr extends Ir$1{constructor(e=1){super(),this.amplitude=e;}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}};class Pr extends Ir$1{constructor(e=3,t=2){super(),this.bounces=e,this.bounciness=t;}easeInCore(e){const t=Math.max(0,this.bounces);let i=this.bounciness;i<=1&&(i=1.001);const s=Math.pow(i,t),r=1-i,n=(1-s)/r+.5*s,a=e*n,o=Math.log(-a*(1-i)+1)/Math.log(i),h=Math.floor(o),l=h+1,c=(1-Math.pow(i,h))/(r*n),u=.5*(c+(1-Math.pow(i,l))/(r*n)),d=e-u,_=u-c;return -Math.pow(1/i,t-h)/(_*_)*(d-_)*(d+_)}}class Or extends Ir$1{easeInCore(e){return e*e*e}}let Dr$1=class Dr extends Ir$1{constructor(e=3,t=3){super(),this.oscillations=e,this.springiness=t;}easeInCore(e){let t;const i=Math.max(0,this.oscillations),s=Math.max(0,this.springiness);return t=0==s?e:(Math.exp(s*e)-1)/(Math.exp(s)-1),t*Math.sin((6.283185307179586*i+1.5707963267948966)*e)}};class Lr extends Ir$1{constructor(e=2){super(),this.exponent=e;}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}let Fr$1=class Fr extends Ir$1{constructor(e=0,t=0,i=1,s=1){super(),this.x1=e,this.y1=t,this.x2=i,this.y2=s;}easeInCore(e){return yr$1.Interpolate(e,this.x1,this.y1,this.x2,this.y2)}};let wr$1=class wr{constructor(e,t,i){this.name=e,this.from=t,this.to=i;}clone(){return new wr(this.name,this.from,this.to)}};const Nr$1=Object.freeze(new se$5(0,0,0,0)),Br$1=Object.freeze(te$4.Zero()),Ur=Object.freeze(ee$4.Zero()),kr$1=Object.freeze(Ss.Zero()),Gr$1=Object.freeze(ge$3.Black()),Vr$1=Object.freeze(new me$3(0,0,0,0)),Hr={key:0,repeatCount:0,loopMode:2};let zr$1=class zr{static _PrepareAnimation(e,t,i,s,r,n,a,o){let h;if(!isNaN(parseFloat(r))&&isFinite(r)?h=zr.ANIMATIONTYPE_FLOAT:r instanceof se$5?h=zr.ANIMATIONTYPE_QUATERNION:r instanceof te$4?h=zr.ANIMATIONTYPE_VECTOR3:r instanceof ee$4?h=zr.ANIMATIONTYPE_VECTOR2:r instanceof ge$3?h=zr.ANIMATIONTYPE_COLOR3:r instanceof me$3?h=zr.ANIMATIONTYPE_COLOR4:r instanceof Ss&&(h=zr.ANIMATIONTYPE_SIZE),null==h)return null;const l=new zr(e,t,i,h,a),c=[{frame:0,value:r},{frame:s,value:n}];return l.setKeys(c),void 0!==o&&l.setEasingFunction(o),l}static CreateAnimation(e,t,i,s){const r=new zr(e+"Animation",e,i,t,zr.ANIMATIONLOOPMODE_CONSTANT);return r.setEasingFunction(s),r}static CreateAndStartAnimation(e,t,i,s,r,n,a,o,h,l,c){const u=zr._PrepareAnimation(e,i,s,r,n,a,o,h);return u?(t.getScene&&(c=t.getScene()),c?c.beginDirectAnimation(t,[u],0,r,u.loopMode!==zr.ANIMATIONLOOPMODE_CONSTANT,1,l):null):null}static CreateAndStartHierarchyAnimation(e,t,i,s,r,n,a,o,h,l,c){const u=zr._PrepareAnimation(e,s,r,n,a,o,h,l);if(!u)return null;return t.getScene().beginDirectHierarchyAnimation(t,i,[u],0,n,1===u.loopMode,1,c)}static CreateMergeAndStartAnimation(e,t,i,s,r,n,a,o,h,l){const c=zr._PrepareAnimation(e,i,s,r,n,a,o,h);return c?(t.animations.push(c),t.getScene().beginAnimation(t,0,r,1===c.loopMode,1,l)):null}static MakeAnimationAdditive(e,t,i,s=false,r){let n;n="object"==typeof t?t:{referenceFrame:t??0,range:i,cloneOriginalAnimation:s,clonedAnimationName:r};let a=e;if(n.cloneOriginalAnimation&&(a=e.clone(),a.name=n.clonedAnimationName||a.name),!a._keys.length)return a;const o=n.referenceFrame&&n.referenceFrame>=0?n.referenceFrame:0;let h=0;const l=a._keys[0];let c=a._keys.length-1;const u=a._keys[c],d={referenceValue:l.value,referencePosition:ae$5.Vector3[0],referenceQuaternion:ae$5.Quaternion[0],referenceScaling:ae$5.Vector3[1],keyPosition:ae$5.Vector3[2],keyQuaternion:ae$5.Quaternion[1],keyScaling:ae$5.Vector3[3]};let _=l.frame,f=u.frame;if(n.range){const e=a.getRange(n.range);e&&(_=e.from,f=e.to);}else _=n.fromFrame??_,f=n.toFrame??f;if(_!==l.frame&&(h=a.createKeyForFrame(_)),f!==u.frame&&(c=a.createKeyForFrame(f)),1===a._keys.length){const e=a._getKeyValue(a._keys[0]);d.referenceValue=e.clone?e.clone():e;}else if(o<=l.frame){const e=a._getKeyValue(l.value);d.referenceValue=e.clone?e.clone():e;}else if(o>=u.frame){const e=a._getKeyValue(u.value);d.referenceValue=e.clone?e.clone():e;}else {Hr.key=0;const e=a._interpolate(o,Hr);d.referenceValue=e.clone?e.clone():e;}a.dataType===zr.ANIMATIONTYPE_QUATERNION?d.referenceValue.normalize().conjugateInPlace():a.dataType===zr.ANIMATIONTYPE_MATRIX&&(d.referenceValue.decompose(d.referenceScaling,d.referenceQuaternion,d.referencePosition),d.referenceQuaternion.normalize().conjugateInPlace());let p=Number.MAX_VALUE;const g=n.clipKeys?[]:null;for(let e=h;e<=c;e++){let t=a._keys[e];if((g||n.cloneOriginalAnimation)&&(t={frame:t.frame,value:t.value.clone?t.value.clone():t.value,inTangent:t.inTangent,outTangent:t.outTangent,interpolation:t.interpolation,lockedTangent:t.lockedTangent},g&&(p===Number.MAX_VALUE&&(p=t.frame),t.frame-=p,g.push(t))),!e||a.dataType===zr.ANIMATIONTYPE_FLOAT||t.value!==l.value)switch(a.dataType){case zr.ANIMATIONTYPE_MATRIX:t.value.decompose(d.keyScaling,d.keyQuaternion,d.keyPosition),d.keyPosition.subtractInPlace(d.referencePosition),d.keyScaling.divideInPlace(d.referenceScaling),d.referenceQuaternion.multiplyToRef(d.keyQuaternion,d.keyQuaternion),re$5.ComposeToRef(d.keyScaling,d.keyQuaternion,d.keyPosition,t.value);break;case zr.ANIMATIONTYPE_QUATERNION:d.referenceValue.multiplyToRef(t.value,t.value);break;case zr.ANIMATIONTYPE_VECTOR2:case zr.ANIMATIONTYPE_VECTOR3:case zr.ANIMATIONTYPE_COLOR3:case zr.ANIMATIONTYPE_COLOR4:t.value.subtractToRef(d.referenceValue,t.value);break;case zr.ANIMATIONTYPE_SIZE:t.value.width-=d.referenceValue.width,t.value.height-=d.referenceValue.height;break;default:t.value-=d.referenceValue;}}return g&&a.setKeys(g,true),a}static TransitionTo(e,t,i,s,r,n,a,o=null){if(a<=0)return i[e]=t,o&&o(),null;const h=r*(a/1e3);n.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:h,value:t}]),i.animations||(i.animations=[]),i.animations.push(n);const l=s.beginAnimation(i,0,h,false);return l.onAnimationEnd=o,l}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return  true;return  false}constructor(e,t,i,s,r,n){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=s,this.loopMode=r,this.enableBlending=n,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this._coreAnimation=null,this.targetPropertyPath=t.split("."),this.dataType=s,this.loopMode=void 0===r?zr.ANIMATIONLOOPMODE_CYCLE:r,this.uniqueId=zr._UniqueIdGenerator++;}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let e=true;for(const i in this._ranges)e&&(t+=", ",e=false),t+=i;t+="}";}return t}addEvent(e){this._events.push(e),this._events.sort(((e,t)=>e.frame-t.frame));}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--);}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new wr$1(e,t,i));}deleteRange(e,t=true){const i=this._ranges[e];if(i){if(t){const e=i.from,t=i.to;for(let i=this._keys.length-1;i>=0;i--)this._keys[i].frame>=e&&this._keys[i].frame<=t&&this._keys.splice(i,1);}this._ranges[e]=null;}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e;}floatInterpolateFunction(e,t,i){return N$c(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,s,r){return B$7(e,t,i,s,r)}quaternionInterpolateFunction(e,t,i){return se$5.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,s,r){return se$5.Hermite(e,t,i,s,r).normalize()}vector3InterpolateFunction(e,t,i){return te$4.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,s,r){return te$4.Hermite(e,t,i,s,r)}vector2InterpolateFunction(e,t,i){return ee$4.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,s,r){return ee$4.Hermite(e,t,i,s,r)}sizeInterpolateFunction(e,t,i){return Ss.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return ge$3.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,s,r){return ge$3.Hermite(e,t,i,s,r)}color4InterpolateFunction(e,t,i){return me$3.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,s,r){return me$3.Hermite(e,t,i,s,r)}_getKeyValue(e){return "function"==typeof e?e():e}evaluate(e){return Hr.key=0,this._interpolate(e,Hr)}_interpolate(e,t,i=false){if(t.loopMode===zr.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const s=this._keys;let r;if(this._coreAnimation)r=this._coreAnimation._key;else {const n=s.length;for(r=t.key;r>=0&&e<s[r].frame;)--r;for(;r+1<=n-1&&e>=s[r+1].frame;)++r;if(t.key=r,r<0)return i?void 0:this._getKeyValue(s[0].value);if(r+1>n-1)return i?void 0:this._getKeyValue(s[n-1].value);this._key=r;}const n=s[r],a=s[r+1];if(i&&(e===n.frame||e===a.frame))return;const o=this._getKeyValue(n.value),h=this._getKeyValue(a.value);if(1===n.interpolation)return a.frame>e?o:h;const l=void 0!==n.outTangent&&void 0!==a.inTangent,c=a.frame-n.frame;let u=(e-n.frame)/c;const d=n.easingFunction||this.getEasingFunction();switch(d&&(u=d.ease(u)),this.dataType){case zr.ANIMATIONTYPE_FLOAT:{const e=l?this.floatInterpolateFunctionWithTangents(o,n.outTangent*c,h,a.inTangent*c,u):this.floatInterpolateFunction(o,h,u);switch(t.loopMode){case zr.ANIMATIONLOOPMODE_CYCLE:case zr.ANIMATIONLOOPMODE_CONSTANT:case zr.ANIMATIONLOOPMODE_YOYO:return e;case zr.ANIMATIONLOOPMODE_RELATIVE:case zr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return (t.offsetValue??0)*t.repeatCount+e}break}case zr.ANIMATIONTYPE_QUATERNION:{const e=l?this.quaternionInterpolateFunctionWithTangents(o,n.outTangent.scale(c),h,a.inTangent.scale(c),u):this.quaternionInterpolateFunction(o,h,u);switch(t.loopMode){case zr.ANIMATIONLOOPMODE_CYCLE:case zr.ANIMATIONLOOPMODE_CONSTANT:case zr.ANIMATIONLOOPMODE_YOYO:return e;case zr.ANIMATIONLOOPMODE_RELATIVE:case zr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||Nr$1).scale(t.repeatCount))}return e}case zr.ANIMATIONTYPE_VECTOR3:{const e=l?this.vector3InterpolateFunctionWithTangents(o,n.outTangent.scale(c),h,a.inTangent.scale(c),u):this.vector3InterpolateFunction(o,h,u);switch(t.loopMode){case zr.ANIMATIONLOOPMODE_CYCLE:case zr.ANIMATIONLOOPMODE_CONSTANT:case zr.ANIMATIONLOOPMODE_YOYO:return e;case zr.ANIMATIONLOOPMODE_RELATIVE:case zr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||Br$1).scale(t.repeatCount))}break}case zr.ANIMATIONTYPE_VECTOR2:{const e=l?this.vector2InterpolateFunctionWithTangents(o,n.outTangent.scale(c),h,a.inTangent.scale(c),u):this.vector2InterpolateFunction(o,h,u);switch(t.loopMode){case zr.ANIMATIONLOOPMODE_CYCLE:case zr.ANIMATIONLOOPMODE_CONSTANT:case zr.ANIMATIONLOOPMODE_YOYO:return e;case zr.ANIMATIONLOOPMODE_RELATIVE:case zr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||Ur).scale(t.repeatCount))}break}case zr.ANIMATIONTYPE_SIZE:switch(t.loopMode){case zr.ANIMATIONLOOPMODE_CYCLE:case zr.ANIMATIONLOOPMODE_CONSTANT:case zr.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(o,h,u);case zr.ANIMATIONLOOPMODE_RELATIVE:case zr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(o,h,u).add((t.offsetValue||kr$1).scale(t.repeatCount))}break;case zr.ANIMATIONTYPE_COLOR3:{const e=l?this.color3InterpolateFunctionWithTangents(o,n.outTangent.scale(c),h,a.inTangent.scale(c),u):this.color3InterpolateFunction(o,h,u);switch(t.loopMode){case zr.ANIMATIONLOOPMODE_CYCLE:case zr.ANIMATIONLOOPMODE_CONSTANT:case zr.ANIMATIONLOOPMODE_YOYO:return e;case zr.ANIMATIONLOOPMODE_RELATIVE:case zr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||Gr$1).scale(t.repeatCount))}break}case zr.ANIMATIONTYPE_COLOR4:{const e=l?this.color4InterpolateFunctionWithTangents(o,n.outTangent.scale(c),h,a.inTangent.scale(c),u):this.color4InterpolateFunction(o,h,u);switch(t.loopMode){case zr.ANIMATIONLOOPMODE_CYCLE:case zr.ANIMATIONLOOPMODE_CONSTANT:case zr.ANIMATIONLOOPMODE_YOYO:return e;case zr.ANIMATIONLOOPMODE_RELATIVE:case zr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||Vr$1).scale(t.repeatCount))}break}case zr.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case zr.ANIMATIONLOOPMODE_CYCLE:case zr.ANIMATIONLOOPMODE_CONSTANT:case zr.ANIMATIONLOOPMODE_YOYO:return zr.AllowMatricesInterpolation?this.matrixInterpolateFunction(o,h,u,t.workValue):o;case zr.ANIMATIONLOOPMODE_RELATIVE:case zr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return o}}return 0}matrixInterpolateFunction(e,t,i,s){return zr.AllowMatrixDecomposeForInterpolation?s?(re$5.DecomposeLerpToRef(e,t,i,s),s):re$5.DecomposeLerp(e,t,i):s?(re$5.LerpToRef(e,t,i,s),s):re$5.Lerp(e,t,i)}clone(){const e=new zr(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone());}}return e}setKeys(e,t=false){this._keys=t?e:e.slice(0);}createKeyForFrame(e){Hr.key=0;const t=this._interpolate(e,Hr,true);if(!t)return this._keys[Hr.key].frame===e?Hr.key:Hr.key+1;const i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(Hr.key+1,0,i),Hr.key+1}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let s=0;s<i.length;s++){const r=i[s],n={};switch(n.frame=r.frame,t){case zr.ANIMATIONTYPE_FLOAT:n.values=[r.value],void 0!==r.inTangent&&n.values.push(r.inTangent),void 0!==r.outTangent&&(void 0===r.inTangent&&n.values.push(void 0),n.values.push(r.outTangent)),void 0!==r.interpolation&&(void 0===r.inTangent&&n.values.push(void 0),void 0===r.outTangent&&n.values.push(void 0),n.values.push(r.interpolation));break;case zr.ANIMATIONTYPE_QUATERNION:case zr.ANIMATIONTYPE_MATRIX:case zr.ANIMATIONTYPE_VECTOR3:case zr.ANIMATIONTYPE_COLOR3:case zr.ANIMATIONTYPE_COLOR4:n.values=r.value.asArray(),null!=r.inTangent&&n.values.push(r.inTangent.asArray()),null!=r.outTangent&&(void 0===r.inTangent&&n.values.push(void 0),n.values.push(r.outTangent.asArray())),void 0!==r.interpolation&&(void 0===r.inTangent&&n.values.push(void 0),void 0===r.outTangent&&n.values.push(void 0),n.values.push(r.interpolation));}e.keys.push(n);}e.ranges=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.ranges.push(s);}return e}static _UniversalLerp(e,t,i){const s=e.constructor;return s.Lerp?s.Lerp(e,t,i):s.Slerp?s.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new zr(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,s=[];let r,n;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),n=0;n<e.keys.length;n++){const t=e.keys[n];let a,o,h;switch(i){case zr.ANIMATIONTYPE_FLOAT:r=t.values[0],t.values.length>=2&&(a=t.values[1]),t.values.length>=3&&(o=t.values[2]),t.values.length>=4&&(h=t.values[3]);break;case zr.ANIMATIONTYPE_QUATERNION:if(r=se$5.FromArray(t.values),t.values.length>=8){const e=se$5.FromArray(t.values.slice(4,8));e.equals(se$5.Zero())||(a=e);}if(t.values.length>=12){const e=se$5.FromArray(t.values.slice(8,12));e.equals(se$5.Zero())||(o=e);}t.values.length>=13&&(h=t.values[12]);break;case zr.ANIMATIONTYPE_MATRIX:r=re$5.FromArray(t.values),t.values.length>=17&&(h=t.values[16]);break;case zr.ANIMATIONTYPE_COLOR3:r=ge$3.FromArray(t.values),t.values[3]&&(a=ge$3.FromArray(t.values[3])),t.values[4]&&(o=ge$3.FromArray(t.values[4])),t.values[5]&&(h=t.values[5]);break;case zr.ANIMATIONTYPE_COLOR4:r=me$3.FromArray(t.values),t.values[4]&&(a=me$3.FromArray(t.values[4])),t.values[5]&&(o=me$3.FromArray(t.values[5])),t.values[6]&&(h=me$3.FromArray(t.values[6]));break;case zr.ANIMATIONTYPE_VECTOR3:default:r=te$4.FromArray(t.values),t.values[3]&&(a=te$4.FromArray(t.values[3])),t.values[4]&&(o=te$4.FromArray(t.values[4])),t.values[5]&&(h=t.values[5]);}const l={};l.frame=t.frame,l.value=r,null!=a&&(l.inTangent=a),null!=o&&(l.outTangent=o),null!=h&&(l.interpolation=h),s.push(l);}if(t.setKeys(s),e.ranges)for(n=0;n<e.ranges.length;n++)r=e.ranges[n],t.createRange(r.name,r.from,r.to);return t}static AppendSerializedAnimations(e,t){Ae$3.AppendSerializedAnimations(e,t);}static async ParseFromFileAsync(e,t){return await new Promise(((i,s)=>{const r=new Oe$3;r.addEventListener("readystatechange",(()=>{if(4==r.readyState)if(200==r.status){let t=JSON.parse(r.responseText);if(t.animations&&(t=t.animations),t.length){const e=[];for(const i of t)e.push(this.Parse(i));i(e);}else {const s=this.Parse(t);e&&(s.name=e),i(s);}}else s("Unable to load the animation");})),r.open("GET",t),r.send();}))}static async ParseFromSnippetAsync(e){return await new Promise(((t,i)=>{const s=new Oe$3;s.addEventListener("readystatechange",(()=>{if(4==s.readyState)if(200==s.status){const i=JSON.parse(JSON.parse(s.responseText).jsonPayload);if(i.animations){const s=JSON.parse(i.animations),r=[];for(const t of s.animations){const i=this.Parse(t);i.snippetId=e,r.push(i);}t(r);}else {const s=JSON.parse(i.animation),r=this.Parse(s);r.snippetId=e,t(r);}}else i("Unable to load the snippet "+e);})),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send();}))}};zr$1._UniqueIdGenerator=0,zr$1.AllowMatricesInterpolation=false,zr$1.AllowMatrixDecomposeForInterpolation=true,zr$1.SnippetUrl=Qe$1.SnippetUrl,zr$1.ANIMATIONTYPE_FLOAT=Qe$1.ANIMATIONTYPE_FLOAT,zr$1.ANIMATIONTYPE_VECTOR3=Qe$1.ANIMATIONTYPE_VECTOR3,zr$1.ANIMATIONTYPE_QUATERNION=Qe$1.ANIMATIONTYPE_QUATERNION,zr$1.ANIMATIONTYPE_MATRIX=Qe$1.ANIMATIONTYPE_MATRIX,zr$1.ANIMATIONTYPE_COLOR3=Qe$1.ANIMATIONTYPE_COLOR3,zr$1.ANIMATIONTYPE_COLOR4=Qe$1.ANIMATIONTYPE_COLOR4,zr$1.ANIMATIONTYPE_VECTOR2=Qe$1.ANIMATIONTYPE_VECTOR2,zr$1.ANIMATIONTYPE_SIZE=Qe$1.ANIMATIONTYPE_SIZE,zr$1.ANIMATIONLOOPMODE_RELATIVE=0,zr$1.ANIMATIONLOOPMODE_CYCLE=1,zr$1.ANIMATIONLOOPMODE_CONSTANT=2,zr$1.ANIMATIONLOOPMODE_YOYO=4,zr$1.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5,zr$1.CreateFromSnippetAsync=zr$1.ParseFromSnippetAsync,P$9("BABYLON.Animation",zr$1),be$3._AnimationRangeFactory=(e,t,i)=>new wr$1(e,t,i);class Xr{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=false,this._radiusIsAnimating=false,this._radiusBounceTransition=null,this._animatables=new Array;}get name(){return "Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add((e=>{if(e&&(e.computeWorldMatrix(true),e.getBoundingInfo)){const t=e.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=.05*t,this.upperRadiusTransitionRange=.05*t;}})):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver));}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange));}));}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null);}_isRadiusAtLimit(e){return !!this._attachedCamera&&(this._attachedCamera.radius===e&&!this._radiusIsAnimating)}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(Xr.EasingFunction.setEasingMode(Xr.EasingMode),this._radiusBounceTransition=zr$1.CreateAnimation("radius",zr$1.ANIMATIONTYPE_FLOAT,60,Xr.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=true;const t=zr$1.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,(()=>this._clearAnimationLocks()));t&&this._animatables.push(t);}_clearAnimationLocks(){this._radiusIsAnimating=false,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision);}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift();}}Xr.EasingFunction=new vr$1(.3),Xr.EasingMode=Ir$1.EASINGMODE_EASEOUT;class Wr{constructor(){this.onTargetFramingAnimationEndObservable=new R$g,this._mode=Wr.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=false,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=true,this._isPointerDown=false,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=false;}get name(){return "Framing"}set mode(e){this._mode=e;}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e;}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e;}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e;}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e;}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e;}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e;}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e;}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();Wr.EasingFunction.setEasingMode(Wr.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==Ar$1.POINTERDOWN?e.type===Ar$1.POINTERUP&&(this._isPointerDown=false):this._isPointerDown=true;})),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add((e=>{e&&e.getBoundingInfo&&this.zoomOnMesh(e,void 0,(()=>{this.onTargetFramingAnimationEndObservable.notifyObservers();}));})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._applyUserInteraction(),this._maintainCameraAboveGround();}));}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null;}zoomOnMesh(e,t=false,i=null){e.computeWorldMatrix(true);const s=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(s.minimumWorld,s.maximumWorld,t,i);}zoomOnMeshHierarchy(e,t=false,i=null){e.computeWorldMatrix(true);const s=e.getHierarchyBoundingVectors(true);this.zoomOnBoundingInfo(s.min,s.max,t,i);}zoomOnMeshesHierarchy(e,t=false,i=null){const s=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new te$4(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let t=0;t<e.length;t++){const i=e[t].getHierarchyBoundingVectors(true);te$4.CheckExtends(i.min,s,r),te$4.CheckExtends(i.max,s,r);}this.zoomOnBoundingInfo(s,r,t,i);}zoomOnBoundingInfo(e,t,i=false,s=null){let r;if(!this._attachedCamera)return  false;const n=e.y,a=n+(t.y-n)*this._positionScale,o=t.subtract(e).scale(.5);if(!isFinite(a))return  false;if(i)r=new te$4(0,a,0);else {const t=e.add(o);r=new te$4(t.x,a,t.z);}this._vectorTransition||(this._vectorTransition=zr$1.CreateAnimation("target",zr$1.ANIMATIONTYPE_VECTOR3,60,Wr.EasingFunction)),this._betaIsAnimating=true;let h=zr$1.TransitionTo("target",r,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);h&&this._animatables.push(h);let l=0;if(this._mode===Wr.FitFrustumSidesMode){const i=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=o.length()+this._attachedCamera.minZ),l=i;}else this._mode===Wr.IgnoreBoundsSizeMode&&(l=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&null===this._attachedCamera.lowerRadiusLimit&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const i=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/i,this._attachedCamera.wheelPrecision=100/l;}return this._radiusTransition||(this._radiusTransition=zr$1.CreateAnimation("radius",zr$1.ANIMATIONTYPE_FLOAT,60,Wr.EasingFunction)),h=zr$1.TransitionTo("radius",l,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,(()=>{this.stopAllAnimations(),s&&s(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState();})),h&&this._animatables.push(h),true}_calculateLowerRadiusFromModelBoundingSphere(e,t){const i=this._attachedCamera;if(!i)return 0;let s=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===Wr.IgnoreBoundsSizeMode&&(s=s<i.lowerRadiusLimit?i.lowerRadiusLimit:s),i.upperRadiusLimit&&(s=s>i.upperRadiusLimit?i.upperRadiusLimit:s),s}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=Pe$2.Now-this._lastInteractionTime,t=.5*Math.PI-this._defaultElevation,i=.5*Math.PI;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=true,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=zr$1.CreateAnimation("beta",zr$1.ANIMATIONTYPE_FLOAT,60,Wr.EasingFunction));const e=zr$1.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,(()=>{this._clearAnimationLocks(),this.stopAllAnimations();}));e&&this._animatables.push(e);}}_clearAnimationLocks(){this._betaIsAnimating=false;}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Pe$2.Now,this.stopAllAnimations(),this._clearAnimationLocks());}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift();}get isUserIsMoving(){return !!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}Wr.EasingFunction=new Lr,Wr.EasingMode=Ir$1.EASINGMODE_EASEINOUT,Wr.IgnoreBoundsSizeMode=0,Wr.FitFrustumSidesMode=1,be$3.AddNodeConstructor("TargetCamera",((e,t)=>()=>new jr(e,te$4.Zero(),t)));const Yr=re$5.Zero(),Kr=se$5.Identity();class jr extends Di{constructor(e,t,i,s=true){super(e,t,i,s),this.cameraDirection=new te$4(0,0,0),this.cameraRotation=new ee$4(0,0),this.updateUpVectorFromRotation=false,this.speed=2,this.noRotationConstraint=false,this.invertRotation=false,this.inverseRotationSpeed=.2,this._panningEpsilon=x$d,this._rotationEpsilon=x$d,this.lockedTarget=null,this._currentTarget=te$4.Zero(),this._initialFocalDistance=1,this._viewMatrix=re$5.Zero(),this._cameraTransformMatrix=re$5.Zero(),this._cameraRotationMatrix=re$5.Zero(),this._transformedReferencePoint=te$4.Zero(),this._deferredPositionUpdate=new te$4,this._deferredRotationQuaternionUpdate=new se$5,this._deferredRotationUpdate=new te$4,this._deferredUpdated=false,this._deferOnly=false,this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0,this._referencePoint=te$4.Forward(this.getScene().useRightHandedSystem),this.rotation=new te$4(0,this.getScene().useRightHandedSystem?Math.PI:0,0);}getFrontPosition(e){this.getWorldMatrix();const t=ae$5.Vector3[0],i=ae$5.Vector3[1];return i.set(0,0,this._scene.useRightHandedSystem?-1:1),this.getDirectionToRef(i,t),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition);}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return !!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),true)}_initCache(){super._initCache(),this._cache.lockedTarget=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new se$5(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion);}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return  false;const e=this._getLockedTargetPosition();return (this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=x$d),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),this.getScene().useRightHandedSystem?re$5.LookAtRHToRef(this.position,e,te$4.UpReadOnly,Yr):re$5.LookAtLHToRef(this.position,e,te$4.UpReadOnly,Yr),Yr.invert();const t=this.rotationQuaternion||Kr;se$5.FromRotationMatrixToRef(Yr,t),t.toEulerAnglesToRef(this.rotation),this.rotation.z=0;}get target(){return this.getTarget()}set target(e){this.setTarget(e);}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(ae$5.Matrix[0]),te$4.TransformNormalToRef(this.cameraDirection,ae$5.Matrix[0],ae$5.Vector3[0]),this._deferredPositionUpdate.addInPlace(ae$5.Vector3[0]),void(this._deferOnly?this._deferredUpdated=true:this.position.copyFrom(this._deferredPositionUpdate));this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=true:this.position.copyFrom(this._deferredPositionUpdate);}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;if(this._deferredUpdated=false,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i){if(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,!this.noRotationConstraint){const e=1.570796;this._deferredRotationUpdate.x>e&&(this._deferredRotationUpdate.x=e),this._deferredRotationUpdate.x<-1.570796&&(this._deferredRotationUpdate.x=-1.570796);}if(this._deferOnly?this._deferredUpdated=true:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion){this._deferredRotationUpdate.lengthSquared()&&(se$5.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=true:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate));}}const s=this.speed*this._panningEpsilon,r=this.speed*this._rotationEpsilon;t&&(Math.abs(this.cameraDirection.x)<s&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<s&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<s&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<r&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<r&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs();}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):re$5.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix);}_rotateUpVectorWithCameraRotationMatrix(){return te$4.TransformNormalToRef(te$4.UpReadOnly,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),te$4.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?ds.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(se$5.FromEulerVectorToRef(this.rotation,Kr),ds.Y.rotateByQuaternionToRef(Kr,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.getScene().useRightHandedSystem?re$5.LookAtRHToRef(e,t,i,this._viewMatrix):re$5.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent();}else this._globalPosition.copyFrom(e);}createRigCamera(e,t){if(this.cameraRigMode!==Di.RIG_MODE_NONE){const t=new jr(e,this.position.clone(),this.getScene());return t.isRigCamera=true,t.rigParent=this,this.cameraRigMode===Di.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new se$5),t._cameraRigParams={},t.rotationQuaternion=new se$5),t.mode=this.mode,t.orthoLeft=this.orthoLeft,t.orthoRight=this.orthoRight,t.orthoTop=this.orthoTop,t.orthoBottom=this.orthoBottom,t}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Di.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Di.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Di.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*s,t);break}case Di.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);}super._updateRigCameras();}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,jr._TargetFocalPoint),jr._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const i=jr._TargetFocalPoint.addInPlace(this.position);re$5.TranslationToRef(-i.x,-i.y,-i.z,jr._TargetTransformMatrix),jr._TargetTransformMatrix.multiplyToRef(re$5.RotationAxis(t.upVector,e),jr._RigCamTransformMatrix),re$5.TranslationToRef(i.x,i.y,i.z,jr._TargetTransformMatrix),jr._RigCamTransformMatrix.multiplyToRef(jr._TargetTransformMatrix,jr._RigCamTransformMatrix),te$4.TransformCoordinatesToRef(this.position,jr._RigCamTransformMatrix,t.position),t.setTarget(i);}getClassName(){return "TargetCamera"}}jr._RigCamTransformMatrix=new re$5,jr._TargetTransformMatrix=new re$5,jr._TargetFocalPoint=new te$4,e$z([a$$()],jr.prototype,"updateUpVectorFromRotation",void 0),e$z([u$s()],jr.prototype,"rotation",void 0),e$z([a$$()],jr.prototype,"speed",void 0),e$z([d$u("lockedTargetId")],jr.prototype,"lockedTarget",void 0);var Qr,qr={};class Zr{constructor(e){this.attachedToElement=false,this.attached={},this.camera=e,this.checkInputs=()=>{};}add(e){const t=e.getSimpleName();this.attached[t]?Ie$2.Warn("camera input of type "+t+" already exists on camera"):(this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault));}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e)return i.detachControl(),i.camera=null,delete this.attached[t],void this.rebuildInputCheck()}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck());}}_addCheckInputs(e){const t=this.checkInputs;return ()=>{t(),e();}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault);}attachElement(e=false){if(!this.attachedToElement){e=!Di.ForceAttachControlToAlwaysPreventDefault&&e,this.attachedToElement=true,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e);}}detachElement(e=false){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=false;}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)));}}clear(){this.attachedToElement&&this.detachElement(true),this.attached={},this.attachedToElement=false,this.checkInputs=()=>{};}serialize(e){const t={};for(const e in this.attached){const i=this.attached[e],s=Ae$3.Serialize(i);t[i.getClassName()]=s;}e.inputsmgr=t;}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const e in t){const i=qr[e];if(i){const s=t[e],r=Ae$3.Parse((()=>new i),s,null);this.add(r);}}}else for(const t in this.attached){const i=qr[this.attached[t].getClassName()];if(i){const s=Ae$3.Parse((()=>new i),e,null);this.remove(this.attached[t]),this.add(s);}}}}class Jr{constructor(){this._currentMousePointerIdDown=-1,this.buttons=[0,1,2];}attachControl(e){e=Ai.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let s=0,r=null;this._pointA=null,this._pointB=null,this._altKey=false,this._ctrlKey=false,this._metaKey=false,this._shiftKey=false,this._buttonsPressed=0,this._pointerInput=n=>{const a=n.event,o="touch"===a.pointerType;if(n.type!==Ar$1.POINTERMOVE&&-1===this.buttons.indexOf(a.button))return;const h=a.target;if(this._altKey=a.altKey,this._ctrlKey=a.ctrlKey,this._metaKey=a.metaKey,this._shiftKey=a.shiftKey,this._buttonsPressed=a.buttons,t.isPointerLock){const e=a.movementX,t=a.movementY;this.onTouch(null,e,t),this._pointA=null,this._pointB=null;}else {if(n.type!==Ar$1.POINTERDOWN&&n.type!==Ar$1.POINTERDOUBLETAP&&o&&this._pointA?.pointerId!==a.pointerId&&this._pointB?.pointerId!==a.pointerId)return;if(n.type!==Ar$1.POINTERDOWN||-1!==this._currentMousePointerIdDown&&!o)if(n.type===Ar$1.POINTERDOUBLETAP)this.onDoubleTap(a.pointerType);else if(n.type!==Ar$1.POINTERUP||this._currentMousePointerIdDown!==a.pointerId&&!o){if(n.type===Ar$1.POINTERMOVE)if(e||a.preventDefault(),this._pointA&&null===this._pointB){const e=a.clientX-this._pointA.x,t=a.clientY-this._pointA.y;this._pointA.x=a.clientX,this._pointA.y=a.clientY,this.onTouch(this._pointA,e,t);}else if(this._pointA&&this._pointB){const e=this._pointA.pointerId===a.pointerId?this._pointA:this._pointB;e.x=a.clientX,e.y=a.clientY;const t=this._pointA.x-this._pointB.x,i=this._pointA.y-this._pointB.y,o=t*t+i*i,h={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:a.pointerId,type:n.type};this.onMultiTouch(this._pointA,this._pointB,s,o,r,h),r=h,s=o;}}else {try{h?.releasePointerCapture(a.pointerId);}catch(e){}o||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==a.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==a.pointerId?this._pointB=null:this._pointA=this._pointB=null,(0!==s||r)&&(this.onMultiTouch(this._pointA,this._pointB,s,0,r,null),s=0,r=null),this._currentMousePointerIdDown=-1,this.onButtonUp(a),e||a.preventDefault();}else {try{h?.setPointerCapture(a.pointerId);}catch(e){}if(null===this._pointA)this._pointA={x:a.clientX,y:a.clientY,pointerId:a.pointerId,type:a.pointerType,button:a.button};else {if(null!==this._pointB)return;this._pointB={x:a.clientX,y:a.clientY,pointerId:a.pointerId,type:a.pointerType,button:a.button};} -1!==this._currentMousePointerIdDown||o||(this._currentMousePointerIdDown=a.pointerId),this.onButtonDown(a),e||(a.preventDefault(),i&&i.focus());}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ar$1.POINTERDOWN|Ar$1.POINTERUP|Ar$1.POINTERMOVE|Ar$1.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,s=0,r=null,this.onLostFocus();},this._contextMenuBind=e=>this.onContextMenu(e),i&&i.addEventListener("contextmenu",this._contextMenuBind,false);const n=this.camera.getScene().getEngine().getHostWindow();n&&Ai.RegisterTopRootEvents(n,[{name:"blur",handler:this._onLostFocus}]);}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&Ai.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}]);}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind);}this._onLostFocus=null;}this._altKey=false,this._ctrlKey=false,this._metaKey=false,this._shiftKey=false,this._buttonsPressed=0,this._currentMousePointerIdDown=-1;}getClassName(){return "BaseCameraPointersInput"}getSimpleName(){return "pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,s,r,n){}onContextMenu(e){e.preventDefault();}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}e$z([a$$()],Jr.prototype,"buttons",void 0);class $r extends Jr{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=false,this.pinchZoom=true,this.panningSensibility=1e3,this.multiTouchPanning=true,this.multiTouchPanAndZoom=true,this.pinchInwards=true,this._isPanClick=false,this._twoFingerActivityCount=0,this._isPinching=false;}getClassName(){return "ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(0!==this.panningSensibility&&e&&t){const i=t.x-e.x,s=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility;}}_computePinchZoom(e,t){const i=this.camera.radius||$r.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=.001*(t-e)*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2);}onTouch(e,t,i){0!==this.panningSensibility&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY);}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState();}onMultiTouch(e,t,i,s,r,n){0===i&&null===r||0===s&&null===n||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,s),this._computeMultiTouchPanning(r,n)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(s)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,s),this._isPinching=true):this._computeMultiTouchPanning(r,n)):this.multiTouchPanning?this._computeMultiTouchPanning(r,n):this.pinchZoom&&this._computePinchZoom(i,s));}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton;}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=false;}onLostFocus(){this._isPanClick=false,this._twoFingerActivityCount=0,this._isPinching=false;}}$r.MinimumRadiusForPinch=.001,e$z([a$$()],$r.prototype,"buttons",void 0),e$z([a$$()],$r.prototype,"angularSensibilityX",void 0),e$z([a$$()],$r.prototype,"angularSensibilityY",void 0),e$z([a$$()],$r.prototype,"pinchPrecision",void 0),e$z([a$$()],$r.prototype,"pinchDeltaPercentage",void 0),e$z([a$$()],$r.prototype,"useNaturalPinchZoom",void 0),e$z([a$$()],$r.prototype,"pinchZoom",void 0),e$z([a$$()],$r.prototype,"panningSensibility",void 0),e$z([a$$()],$r.prototype,"multiTouchPanning",void 0),e$z([a$$()],$r.prototype,"multiTouchPanAndZoom",void 0),qr.ArcRotateCameraPointersInput=$r;class en{}en.KEYDOWN=1,en.KEYUP=2;class tn{constructor(e,t){this.type=e,this.event=t;}}class sn extends tn{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e;}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=false;}}class rn{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=true,this.angularSpeed=.01,this._keys=new Array;}attachControl(e){e=Ai.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0;})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===en.KEYDOWN){if(this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode)){ -1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault());}}else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),i.preventDefault&&(e||i.preventDefault());}})));}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0;}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];-1!==this.keysLeft.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:-1!==this.keysUp.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:-1!==this.keysRight.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:-1!==this.keysDown.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:-1!==this.keysReset.indexOf(i)&&e.useInputToRestoreState&&e.restoreState();}}}getClassName(){return "ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return "keyboard"}}e$z([a$$()],rn.prototype,"keysUp",void 0),e$z([a$$()],rn.prototype,"keysDown",void 0),e$z([a$$()],rn.prototype,"keysLeft",void 0),e$z([a$$()],rn.prototype,"keysRight",void 0),e$z([a$$()],rn.prototype,"keysReset",void 0),e$z([a$$()],rn.prototype,"panningSensibility",void 0),e$z([a$$()],rn.prototype,"zoomingSensibility",void 0),e$z([a$$()],rn.prototype,"useAltToZoom",void 0),e$z([a$$()],rn.prototype,"angularSpeed",void 0),qr.ArcRotateCameraKeyboardMoveInput=rn,function(e){e[e.PointerMove=0]="PointerMove",e[e.PointerDown=1]="PointerDown",e[e.PointerUp=2]="PointerUp";}(Qr||(Qr={}));class nn{}nn.DOM_DELTA_PIXEL=0,nn.DOM_DELTA_LINE=1,nn.DOM_DELTA_PAGE=2;class an{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=false,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new te$4(0,0,0),this._globalOffset=new te$4(0,0,0),this._inertialPanning=te$4.Zero();}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const s=.01*e*this.wheelDeltaPercentage*t;return i=e>0?s/(1+this.wheelDeltaPercentage):s*(1+this.wheelDeltaPercentage),i}attachControl(e){e=Ai.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ar$1.POINTERWHEEL)return;const i=t.event;let s=0;const r=i.deltaMode===nn.DOM_DELTA_LINE?40:1,n=-i.deltaY*r;if(this.customComputeDeltaFromMouseWheel)s=this.customComputeDeltaFromMouseWheel(n,this,i);else if(this.wheelDeltaPercentage){if(s=this._computeDeltaFromMouseWheelLegacyEvent(n,this.camera.radius),s>0){let e=this.camera.radius,t=this.camera.inertialRadiusOffset+s;for(let i=0;i<20&&!(e<=t)&&!(Math.abs(t*this.camera.inertia)<.001);i++)e-=t,t*=this.camera.inertia;e=U$5(e,0,Number.MAX_VALUE),s=this._computeDeltaFromMouseWheelLegacyEvent(n,e);}}else s=n/(40*this.wheelPrecision);s&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(s)):this.camera.inertialRadiusOffset+=s),i.preventDefault&&(e||i.preventDefault());},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ar$1.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0);}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null);}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning));}getClassName(){return "ArcRotateCameraMouseWheelInput"}getSimpleName(){return "mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Pi.FromPositionAndNormal(e.target,t);}_getPosition(){const e=this.camera,t=e.getScene(),i=t.createPickingRay(t.pointerX,t.pointerY,re$5.Identity(),e,false);0===e.targetScreenOffset.x&&0===e.targetScreenOffset.y||(this._viewOffset.set(e.targetScreenOffset.x,e.targetScreenOffset.y,0),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),this._globalOffset=te$4.TransformNormal(this._viewOffset,e._cameraTransformMatrix),i.origin.addInPlace(this._globalOffset));let s=0;return this._hitPlane&&(s=i.intersectsPlane(this._hitPlane)??0),i.origin.addInPlace(i.direction.scaleInPlace(s))}_zoomToMouse(e){const t=this.camera,i=1-t.inertia;if(t.lowerRadiusLimit){const s=t.lowerRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i<s&&(e=(t.radius-s)*i-t.inertialRadiusOffset);}if(t.upperRadiusLimit){const s=t.upperRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i>s&&(e=(t.radius-s)*i-t.inertialRadiusOffset);}const s=e/i/t.radius,r=this._getPosition(),n=ae$5.Vector3[6];r.subtractToRef(t.target,n),n.scaleInPlace(s),n.scaleInPlace(i),this._inertialPanning.addInPlace(n),t.inertialRadiusOffset+=e;}_zeroIfClose(e){Math.abs(e.x)<x$d&&(e.x=0),Math.abs(e.y)<x$d&&(e.y=0),Math.abs(e.z)<x$d&&(e.z=0);}}e$z([a$$()],an.prototype,"wheelPrecision",void 0),e$z([a$$()],an.prototype,"zoomToMouseLocation",void 0),e$z([a$$()],an.prototype,"wheelDeltaPercentage",void 0),qr.ArcRotateCameraMouseWheelInput=an;class on extends Zr{constructor(e){super(e);}addMouseWheel(){return this.add(new an),this}addPointers(){return this.add(new $r),this}addKeyboard(){return this.add(new rn),this}}function hn(e){let t=Math.PI/2;return 0===e.x&&0===e.z||(t=Math.acos(e.x/Math.sqrt(Math.pow(e.x,2)+Math.pow(e.z,2)))),e.z<0&&(t=2*Math.PI-t),t}function ln(e,t){return Math.acos(e/t)}function cn(e,t){return isNaN(e)?t:e}be$3.AddNodeConstructor("ArcRotateCamera",((e,t)=>()=>new un(e,0,0,1,te$4.Zero(),t)));class un extends jr{get target(){return this._target}set target(e){this.setTarget(e);}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e);}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e);}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new re$5,this._upToYMatrix=new re$5,this._upVector=te$4.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp();}get upVector(){return this._upVector}setMatUp(){re$5.RotationAlignToRef(te$4.UpReadOnly,this._upVector,this._yToUpMatrix),re$5.RotationAlignToRef(this._upVector,te$4.UpReadOnly,this._upToYMatrix);}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e);}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e);}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e);}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e);}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return !!e&&e.useNaturalPinchZoom}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e);}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e);}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e);}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e);}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e);}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e);}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e);}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return !!e&&e.zoomToMouseLocation}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e);}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e);}get isInterpolating(){return this._isInterpolating}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return null!=this._bouncingBehavior}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new Xr,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null));}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return null!=this._framingBehavior}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Wr,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null));}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return null!=this._autoRotationBehavior}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new xr$1,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null));}constructor(e,t,i,s,r,n,a=true){super(e,te$4.Zero(),n,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.lowerTargetYLimit=-1/0,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=te$4.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=ee$4.Zero(),this.allowUpsideDown=true,this.useInputToRestoreState=true,this.restoreStateInterpolationFactor=0,this._currentInterpolationFactor=0,this._viewMatrix=new re$5,this.panningAxis=new te$4(1,1,0),this._transformedDirection=new te$4,this.mapPanning=false,this._isInterpolating=false,this.onMeshTargetChangedObservable=new R$g,this.checkCollisions=false,this.collisionRadius=new te$4(.5,.5,.5),this._previousPosition=te$4.Zero(),this._collisionVelocity=te$4.Zero(),this._newPosition=te$4.Zero(),this._computationVector=te$4.Zero(),this._goalAlpha=NaN,this._goalBeta=NaN,this._goalRadius=NaN,this._goalTarget=new te$4(NaN,NaN,NaN),this._goalTargetScreenOffset=new ee$4(NaN,NaN),this._onCollisionPositionChange=(e,t,i=null)=>{i?(this.setPosition(t),this.onCollide&&this.onCollide(i)):this._previousPosition.copyFrom(this._position);const s=Math.cos(this.alpha),r=Math.sin(this.alpha),n=Math.cos(this.beta);let a=Math.sin(this.beta);0===a&&(a=1e-4);const o=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*s*a,this.radius*n,this.radius*r*a),o.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let h=this.upVector;this.allowUpsideDown&&this.beta<0&&(h=h.clone(),h=h.negate()),this._computeViewMatrix(this._position,o,h),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=false;},this._target=te$4.Zero(),r&&this.setTarget(r),this.alpha=t,this.beta=i,this.radius=s,this.getViewMatrix(),this.inputs=new on(this),this.inputs.addKeyboard().addMouseWheel().addPointers();}_initCache(){super._initCache(),this._cache._target=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=ee$4.Zero();}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset);}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const e=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?e.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(e);}const e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return this.hasStateStored()&&this.restoreStateInterpolationFactor>x$d&&this.restoreStateInterpolationFactor<1?(this.interpolateTo(this._storedAlpha,this._storedBeta,this._storedRadius,this._storedTarget,this._storedTargetScreenOffset,this.restoreStateInterpolationFactor),true):!!super._restoreStateValues()&&(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,true)}stopInterpolation(){this._goalAlpha=NaN,this._goalBeta=NaN,this._goalRadius=NaN,this._goalTarget.set(NaN,NaN,NaN),this._goalTargetScreenOffset.set(NaN,NaN);}interpolateTo(e=this.alpha,t=this.beta,i=this.radius,s=this.target,r=this.targetScreenOffset,n){this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,null!=n?this._currentInterpolationFactor=n:0!==this.restoreStateInterpolationFactor?this._currentInterpolationFactor=this.restoreStateInterpolationFactor:this._currentInterpolationFactor=.1,this._goalAlpha=cn(e,this._goalAlpha),this._goalBeta=cn(t,this._goalBeta),this._goalRadius=cn(i,this._goalRadius),this._goalTarget.set(cn(s.x,this._goalTarget.x),cn(s.y,this._goalTarget.y),cn(s.z,this._goalTarget.z)),this._goalTargetScreenOffset.set(cn(r.x,this._goalTargetScreenOffset.x),cn(r.y,this._goalTargetScreenOffset.y)),this._goalAlpha=U$5(this._goalAlpha,this.lowerAlphaLimit??-1/0,this.upperAlphaLimit??1/0),this._goalBeta=U$5(this._goalBeta,this.lowerBetaLimit??-1/0,this.upperBetaLimit??1/0),this._goalRadius=U$5(this._goalRadius,this.lowerRadiusLimit??-1/0,this.upperRadiusLimit??1/0),this._goalTarget.y=U$5(this._goalTarget.y,this.lowerTargetYLimit??-1/0,1/0),this._isInterpolating=true;}_isSynchronizedViewMatrix(){return !!super._isSynchronizedViewMatrix()&&(this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset))}attachControl(e,t,i=true,s=2){const r=arguments;t=Ai.BackCompatCameraNoPreventDefault(r),this._useCtrlForPanning=i,this._panningMouseButton=s,"boolean"==typeof r[0]&&(r.length>1&&(this._useCtrlForPanning=r[1]),r.length>2&&(this._panningMouseButton=r[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0;};}detachControl(){this.inputs.detachElement(),this._reset&&this._reset();}_checkInputs(){if(this._collisionTriggered)return;this.inputs.checkInputs();let e=false;const t=this.speed*this._panningEpsilon,i=this.speed*this._rotationEpsilon;if(0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset){e=true;const t=this.invertRotation?-1:1,s=this._calculateHandednessMultiplier();let r=this.inertialAlphaOffset*s;this.beta<0&&(r*=-1),this.alpha+=r*t,this.beta+=this.inertialBetaOffset*t,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<i&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<i&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<i&&(this.inertialRadiusOffset=0);}if(0!==this.inertialPanningX||0!==this.inertialPanningY){e=true;const i=new te$4(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),i.multiplyInPlace(this.panningAxis),te$4.TransformNormalToRef(i,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){const e=this.upVector,t=te$4.CrossToRef(this._transformedDirection,e,this._transformedDirection);te$4.CrossToRef(e,t,this._transformedDirection);}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost)if(this.panningDistanceLimit){this._transformedDirection.addInPlace(this._target);te$4.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);}else {if(this.parent){const e=ae$5.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(e),e.transposeToRef(e),te$4.TransformCoordinatesToRef(this._transformedDirection,e,this._transformedDirection);}this._target.addInPlace(this._transformedDirection);}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<t&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<t&&(this.inertialPanningY=0);}if(e)this.stopInterpolation();else if(this._isInterpolating){let e=false;const t=this._scene.getEngine().getDeltaTime()/1e3,i=1-Math.pow(2,-t/this._currentInterpolationFactor),s=cn(this._goalRadius,this.radius);if(!isNaN(this._goalTarget.x)||!isNaN(this._goalTarget.y)||!isNaN(this._goalTarget.z)){const t=ae$5.Vector3[0].set(cn(this._goalTarget.x,this._target.x),cn(this._goalTarget.y,this._target.y),cn(this._goalTarget.z,this._target.z));te$4.LerpToRef(this.target,t,i,this._target),10*te$4.Distance(this.target,t)/s<x$d?(this._goalTarget.set(NaN,NaN,NaN),this.target.copyFrom(t),this.setTarget(this.target,false,true,true)):e=true;}if(!isNaN(this._goalAlpha)||!isNaN(this._goalBeta)){const t=se$5.RotationAlphaBetaGammaToRef(cn(this._goalAlpha,this.alpha),cn(this._goalBeta,this.beta),0,ae$5.Quaternion[0]),s=se$5.RotationAlphaBetaGammaToRef(this.alpha,this.beta,0,ae$5.Quaternion[1]),r=se$5.SlerpToRef(s,t,i,ae$5.Quaternion[2]);r.normalize();const n=r.toAlphaBetaGammaToRef(ae$5.Vector3[0]);if(this.alpha=n.x,this.beta=n.y,r.isApprox(t,2e-4)){this._goalAlpha=NaN,this._goalBeta=NaN;const e=t.toAlphaBetaGammaToRef(ae$5.Vector3[0]);this.alpha=e.x,this.beta=e.y;}else e=true;}if(isNaN(this._goalRadius)||(this.radius+=(s-this.radius)*i,Math.abs(s/this.radius-1)<x$d?(this._goalRadius=NaN,this.radius=s):e=true),!isNaN(this._goalTargetScreenOffset.x)||!isNaN(this._goalTargetScreenOffset.y)){const t=ae$5.Vector2[0].set(cn(this._goalTargetScreenOffset.x,this.targetScreenOffset.x),cn(this._goalTargetScreenOffset.y,this.targetScreenOffset.y));ee$4.LerpToRef(this.targetScreenOffset,t,i,this.targetScreenOffset),ee$4.Distance(this.targetScreenOffset,t)<x$d?(this._goalTargetScreenOffset.set(NaN,NaN),this.targetScreenOffset.copyFrom(t)):e=true;}this._isInterpolating=e;}this._checkLimits(),super._checkInputs();}_checkLimits(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),null!==this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),null!==this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0),this.target.y=Math.max(this.target.y,this.lowerTargetYLimit);}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||te$4.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),0===this.radius&&(this.radius=1e-4);const e=this.alpha;this.alpha=hn(this._computationVector),this.beta=ln(this._computationVector.y,this.radius);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=2*t*Math.PI,this._checkLimits();}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius());}setTarget(e,t=false,i=false,s=false){if(s=this.overrideCloneAlphaBetaRadius??s,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else {const t=e,s=this._getTargetPosition();if(s&&!i&&s.equals(t))return;this._targetHost=null,this._target=t,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null);}s||this.rebuildAnglesAndRadius();}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let s=Math.sin(this.beta);0===s&&(s=1e-4),0===this.radius&&(this.radius=1e-4);const r=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*s,this.radius*i,this.radius*t*s),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||te$4.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),r.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const e=this.getScene().collisionCoordinator;this._collider||(this._collider=e.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=true,e.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId);}else {this._position.copyFrom(this._newPosition);let e=this.upVector;this.allowUpsideDown&&s<0&&(e=e.negate()),this._computeViewMatrix(this._position,r,e),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y);}return this._currentTarget.copyFrom(r),this._viewMatrix}zoomOn(e,t=false){e=e||this.getScene().meshes;const i=Er$1.MinMax(e);let s=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);if(s=Math.max(Math.min(s,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=s*this.zoomOnFactor,this.mode===Di.ORTHOGRAPHIC_CAMERA){const e=this.getScene().getEngine().getAspectRatio(this),t=s*this.zoomOnFactor/2;this.orthoLeft=-t*e,this.orthoRight=t*e,this.orthoBottom=-t,this.orthoTop=t;}this.focusOn({min:i.min,max:i.max,distance:s},t);}focusOn(e,t=false){let i,s;if(void 0===e.min){const t=e||this.getScene().meshes;i=Er$1.MinMax(t),s=te$4.Distance(i.min,i.max);}else {i=e,s=e.distance;}this._target=Er$1.Center(i),t||(this.maxZ=2*s);}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case Di.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Di.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Di.RIG_MODE_STEREOSCOPIC_INTERLACED:case Di.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(0===t?1:-1);break;case Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(0===t?-1:1);}const s=new un(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return s._cameraRigParams={},s.isRigCamera=true,s.rigParent=this,s.upVector=this.upVector,s.mode=this.mode,s.orthoLeft=this.orthoLeft,s.orthoRight=this.orthoRight,s.orthoBottom=this.orthoBottom,s.orthoTop=this.orthoTop,s}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Di.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Di.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Di.RIG_MODE_STEREOSCOPIC_INTERLACED:case Di.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Di.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;}super._updateRigCameras();}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){const s=te$4.Distance(e,t),r=this.getScene().getEngine().getAspectRatio(this),n=Math.tan(this.fov/2),a=n*r,o=.5*s*i,h=o*Math.sqrt(1+1/(a*a)),l=o*Math.sqrt(1+1/(n*n));return Math.max(h,l)}dispose(){this.inputs.clear(),super.dispose();}getClassName(){return "ArcRotateCamera"}}e$z([a$$()],un.prototype,"alpha",void 0),e$z([a$$()],un.prototype,"beta",void 0),e$z([a$$()],un.prototype,"radius",void 0),e$z([a$$()],un.prototype,"overrideCloneAlphaBetaRadius",void 0),e$z([u$s("target")],un.prototype,"_target",void 0),e$z([d$u("targetHost")],un.prototype,"_targetHost",void 0),e$z([a$$()],un.prototype,"inertialAlphaOffset",void 0),e$z([a$$()],un.prototype,"inertialBetaOffset",void 0),e$z([a$$()],un.prototype,"inertialRadiusOffset",void 0),e$z([a$$()],un.prototype,"lowerAlphaLimit",void 0),e$z([a$$()],un.prototype,"upperAlphaLimit",void 0),e$z([a$$()],un.prototype,"lowerBetaLimit",void 0),e$z([a$$()],un.prototype,"upperBetaLimit",void 0),e$z([a$$()],un.prototype,"lowerRadiusLimit",void 0),e$z([a$$()],un.prototype,"upperRadiusLimit",void 0),e$z([a$$()],un.prototype,"lowerTargetYLimit",void 0),e$z([a$$()],un.prototype,"inertialPanningX",void 0),e$z([a$$()],un.prototype,"inertialPanningY",void 0),e$z([a$$()],un.prototype,"pinchToPanMaxDistance",void 0),e$z([a$$()],un.prototype,"panningDistanceLimit",void 0),e$z([u$s()],un.prototype,"panningOriginTarget",void 0),e$z([a$$()],un.prototype,"panningInertia",void 0),e$z([a$$()],un.prototype,"zoomToMouseLocation",null),e$z([a$$()],un.prototype,"zoomOnFactor",void 0),e$z([c$o()],un.prototype,"targetScreenOffset",void 0),e$z([a$$()],un.prototype,"allowUpsideDown",void 0),e$z([a$$()],un.prototype,"useInputToRestoreState",void 0),e$z([a$$()],un.prototype,"restoreStateInterpolationFactor",void 0),P$9("BABYLON.ArcRotateCamera",un);class dn extends be$3{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range);}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale();}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale();}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty());}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e);}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e);}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes();}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes();}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty());}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,false),this.diffuse=new ge$3(1,1,1),this.specular=new ge$3(1,1,1),this.falloffType=dn.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=dn.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=true,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._currentViewDepth=0,this._isLight=true,this.getScene().addLight(this),this._uniformBuffer=new cs(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes();}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,s,r=true){const n=e.toString();let a=false;if(this._uniformBuffer.bindToEffect(i,"Light"+n),this._renderId!==t.getRenderId()||this._lastUseSpecular!==s||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=s;const e=this.getScaledIntensity();this.transferToEffect(i,n),this.diffuse.scaleToRef(e,Te$3.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Te$3.Color3[0],this.range,n),s&&(this.specular.scaleToRef(e,Te$3.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Te$3.Color3[1],this.radius,n)),a=true;}if(this.transferTexturesToEffect(i,n),t.shadowsEnabled&&this.shadowEnabled&&r){const e=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();e&&(e.bindShadowLight(n,i),a=true);}a?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer();}getClassName(){return "Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric","Clustered"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes();}setEnabled(e){super.setEnabled(e),this._resyncMeshes();}getShadowGenerator(e=null){return null===this._shadowGenerators?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return te$4.Zero()}canAffectMesh(e){return !e||!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e))&&(!(this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e))&&((0===this.includeOnlyWithLayerMask||0!==(this.includeOnlyWithLayerMask&e.layerMask))&&!(0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask)))}dispose(e,t=false){if(this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();true!==t.done;t=e.next()){t.value.dispose();}this._shadowGenerators=null;}if(this.getScene().stopAnimation(this),this._parentContainer){const e=this._parentContainer.lights.indexOf(this);e>-1&&this._parentContainer.lights.splice(e,1),this._parentContainer=null;}for(const e of this.getScene().meshes)e._removeLightSource(this,true);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t);}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=dn.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const s=Ae$3.Clone(i,this);return e&&(s.name=e),t&&(s.parent=t),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){const e=Ae$3.Serialize(this);if(e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0){e.excludedMeshesIds=[];for(const t of this.excludedMeshes)e.excludedMeshesIds.push(t.id);}if(this.includedOnlyMeshes.length>0){e.includedOnlyMeshesIds=[];for(const t of this.includedOnlyMeshes)e.includedOnlyMeshesIds.push(t.id);}return Ae$3.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){const s=be$3.Construct("Light_Type_"+e,t,i);return s||null}static Parse(e,t){const i=dn.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const s=Ae$3.Parse(i,e,t);if(e.excludedMeshesIds&&(s._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(s.falloffType=e.falloffType),void 0!==e.lightmapMode&&(s.lightmapMode=e.lightmapMode),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=O$g("BABYLON.Animation");r&&s.animations.push(r.Parse(i));}be$3.ParseAnimationRanges(s,e,t);}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}_hookArrayForExcluded(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);for(const e of i)e._resyncLightSource(this);return s};const i=e.splice;e.splice=(t,s)=>{const r=i.apply(e,[t,s]);for(const e of r)e._resyncLightSource(this);return r};for(const t of e)t._resyncLightSource(this);}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);return this._resyncMeshes(),s};const i=e.splice;e.splice=(t,s)=>{const r=i.apply(e,[t,s]);return this._resyncMeshes(),r},this._resyncMeshes();}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this);}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes) -1!==e.lightSources.indexOf(this)&&e._markSubMeshesAsLightDirty();}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial();}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===dn.INTENSITYMODE_AUTOMATIC&&(i=t===dn.LIGHTTYPEID_DIRECTIONALLIGHT?dn.INTENSITYMODE_ILLUMINANCE:dn.INTENSITYMODE_LUMINOUSINTENSITY),t){case dn.LIGHTTYPEID_POINTLIGHT:case dn.LIGHTTYPEID_SPOTLIGHT:switch(i){case dn.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case dn.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case dn.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;}break;case dn.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case dn.INTENSITYMODE_ILLUMINANCE:e=1;break;case dn.INTENSITYMODE_LUMINANCE:{let t=this.radius;t=Math.max(t,.001);e=2*Math.PI*(1-Math.cos(t));break}}break;case dn.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;}return e}_reorderLightsInScene(){const e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=true),this.getScene().sortLightsByPriority();}_isReady(){return  true}}dn.FALLOFF_DEFAULT=ms.FALLOFF_DEFAULT,dn.FALLOFF_PHYSICAL=ms.FALLOFF_PHYSICAL,dn.FALLOFF_GLTF=ms.FALLOFF_GLTF,dn.FALLOFF_STANDARD=ms.FALLOFF_STANDARD,dn.LIGHTMAP_DEFAULT=ms.LIGHTMAP_DEFAULT,dn.LIGHTMAP_SPECULAR=ms.LIGHTMAP_SPECULAR,dn.LIGHTMAP_SHADOWSONLY=ms.LIGHTMAP_SHADOWSONLY,dn.INTENSITYMODE_AUTOMATIC=ms.INTENSITYMODE_AUTOMATIC,dn.INTENSITYMODE_LUMINOUSPOWER=ms.INTENSITYMODE_LUMINOUSPOWER,dn.INTENSITYMODE_LUMINOUSINTENSITY=ms.INTENSITYMODE_LUMINOUSINTENSITY,dn.INTENSITYMODE_ILLUMINANCE=ms.INTENSITYMODE_ILLUMINANCE,dn.INTENSITYMODE_LUMINANCE=ms.INTENSITYMODE_LUMINANCE,dn.LIGHTTYPEID_POINTLIGHT=ms.LIGHTTYPEID_POINTLIGHT,dn.LIGHTTYPEID_DIRECTIONALLIGHT=ms.LIGHTTYPEID_DIRECTIONALLIGHT,dn.LIGHTTYPEID_SPOTLIGHT=ms.LIGHTTYPEID_SPOTLIGHT,dn.LIGHTTYPEID_HEMISPHERICLIGHT=ms.LIGHTTYPEID_HEMISPHERICLIGHT,dn.LIGHTTYPEID_RECT_AREALIGHT=ms.LIGHTTYPEID_RECT_AREALIGHT,e$z([h$c()],dn.prototype,"diffuse",void 0),e$z([h$c()],dn.prototype,"specular",void 0),e$z([a$$()],dn.prototype,"falloffType",void 0),e$z([a$$()],dn.prototype,"intensity",void 0),e$z([a$$()],dn.prototype,"range",null),e$z([a$$()],dn.prototype,"intensityMode",null),e$z([a$$()],dn.prototype,"radius",null),e$z([a$$()],dn.prototype,"_renderPriority",void 0),e$z([n$1W("_reorderLightsInScene")],dn.prototype,"renderPriority",void 0),e$z([a$$("shadowEnabled")],dn.prototype,"_shadowEnabled",void 0),e$z([a$$("excludeWithLayerMask")],dn.prototype,"_excludeWithLayerMask",void 0),e$z([a$$("includeOnlyWithLayerMask")],dn.prototype,"_includeOnlyWithLayerMask",void 0),e$z([a$$("lightmapMode")],dn.prototype,"_lightmapMode",void 0);class _n extends dn{constructor(){super(...arguments),this._needProjectionMatrixCompute=true,this._viewMatrix=re$5.Identity(),this._projectionMatrix=re$5.Identity();}_setPosition(e){this._position=e;}get position(){return this._position}set position(e){this._setPosition(e);}_setDirection(e){this._direction=e;}get direction(){return this._direction}set direction(e){this._setDirection(e);}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute();}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute();}computeTransformedInformation(){return !(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition||(this.transformedPosition=te$4.Zero()),te$4.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=te$4.Zero()),te$4.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),true)}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=te$4.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=te$4.Cross(this.direction,ds.Y),t=te$4.Cross(e,this.direction);return te$4.RotationFromAxis(e,t,this.direction)}needCube(){return  false}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=true;}_initCache(){super._initCache(),this._cache.position=te$4.Zero();}_isSynchronized(){return !!this._cache.position.equals(this.position)}computeWorldMatrix(e){return !e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=re$5.Identity()),re$5.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=true,this._worldMatrix)}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e?.minZ||Qe$1.ShadowMinZ}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e?.maxZ||Qe$1.ShadowMaxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),this.parent&&this.parent.getWorldMatrix||(this.transformedPosition=null,this.transformedDirection=null);}getViewMatrix(e){const t=ae$5.Vector3[0];let i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),te$4.NormalizeToRef(this.getShadowDirection(e),t),1===Math.abs(te$4.Dot(t,te$4.Up()))&&(t.z=1e-13);const s=ae$5.Vector3[1];return i.addToRef(t,s),re$5.LookAtLHToRef(i,s,te$4.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}}e$z([u$s()],_n.prototype,"position",null),e$z([u$s()],_n.prototype,"direction",null),e$z([a$$()],_n.prototype,"shadowMinZ",null),e$z([a$$()],_n.prototype,"shadowMaxZ",null),be$3.AddNodeConstructor("Light_Type_1",((e,t)=>()=>new fn(e,te$4.Zero(),t)));class fn extends _n{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute();}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute();}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e;}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e;}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e;}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e;}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=true,this.autoCalcShadowZBounds=false,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t;}getClassName(){return "DirectionalLight"}getTypeID(){return dn.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i);}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&re$5.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange);}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const e=te$4.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let s=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let n=0;n<i.length;n++){const a=i[n];if(!a)continue;const o=a.getBoundingInfo().boundingBox;for(let i=0;i<o.vectorsWorld.length;i++)te$4.TransformCoordinatesToRef(o.vectorsWorld[i],t,e),e.x<this._orthoLeft&&(this._orthoLeft=e.x),e.y<this._orthoBottom&&(this._orthoBottom=e.y),e.x>this._orthoRight&&(this._orthoRight=e.x),e.y>this._orthoTop&&(this._orthoTop=e.y),this.autoCalcShadowZBounds&&(e.z<s&&(s=e.z),e.z>r&&(r=e.z));}this.autoCalcShadowZBounds&&(this._shadowMinZ=s,this._shadowMaxZ=r);}const r=this._orthoRight-this._orthoLeft,n=this._orthoTop-this._orthoBottom,a=void 0!==this.shadowMinZ?this.shadowMinZ:s?.minZ||Qe$1.ShadowMinZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:s?.maxZ||Qe$1.ShadowMaxZ,h=this.getScene().getEngine().useReverseDepthBuffer;re$5.OrthoOffCenterLHToRef(this._orthoLeft-r*this.shadowOrthoScale,this._orthoRight+r*this.shadowOrthoScale,this._orthoBottom-n*this.shadowOrthoScale,this._orthoTop+n*this.shadowOrthoScale,h?o:a,h?a:o,e,this.getScene().getEngine().isNDCHalfZRange);}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create();}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return !t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=true;}}e$z([a$$()],fn.prototype,"shadowFrustumSize",null),e$z([a$$()],fn.prototype,"shadowOrthoScale",null),e$z([a$$()],fn.prototype,"autoUpdateExtends",void 0),e$z([a$$()],fn.prototype,"autoCalcShadowZBounds",void 0),e$z([a$$("orthoLeft")],fn.prototype,"_orthoLeft",void 0),e$z([a$$("orthoRight")],fn.prototype,"_orthoRight",void 0),e$z([a$$("orthoTop")],fn.prototype,"_orthoTop",void 0),e$z([a$$("orthoBottom")],fn.prototype,"_orthoBottom",void 0),P$9("BABYLON.DirectionalLight",fn),be$3.AddNodeConstructor("Light_Type_3",((e,t)=>()=>new pn(e,te$4.Zero(),t)));class pn extends dn{constructor(e,t,i){super(e,i),this.groundColor=new ge$3(0,0,0),this.direction=t||te$4.Up();}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create();}getClassName(){return "HemisphericLight"}setDirectionToTarget(e){return this.direction=te$4.Normalize(e.subtract(te$4.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=te$4.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=te$4.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=re$5.Identity()),this._worldMatrix}getTypeID(){return dn.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=true;}}e$z([h$c()],pn.prototype,"groundColor",void 0),e$z([u$s()],pn.prototype,"direction",void 0),P$9("BABYLON.HemisphericLight",pn);class gn{constructor(){this._count=0,this._data={};}copyFrom(e){this.clear(),e.forEach(((e,t)=>this.add(e,t)));}get(e){const t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let i=this.get(e);return void 0!==i||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,true)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,true)}getAndRemove(e){const t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return !!this.contains(e)&&(delete this._data[e],--this._count,true)}clear(){this._data={},this._count=0;}get count(){return this._count}forEach(e){for(const t in this._data){e(t,this._data[t]);}}first(e){for(const t in this._data){const i=e(t,this._data[t]);if(i)return i}return null}}function mn(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative");}class Tn{constructor(){this._dirty=true,this._tempColor=new me$3(0,0,0,0),this._globalCurve=new me$3(0,0,0,0),this._highlightsCurve=new me$3(0,0,0,0),this._midtonesCurve=new me$3(0,0,0,0),this._shadowsCurve=new me$3(0,0,0,0),this._positiveCurve=new me$3(0,0,0,0),this._negativeCurve=new me$3(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0;}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=true;}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=true;}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=true;}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=true;}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=true;}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=true;}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=true;}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=true;}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=true;}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=true;}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=true;}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=true;}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=true;}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=true;}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=true;}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=true;}getClassName(){return "ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",r="vCameraColorCurveNegative"){e._dirty&&(e._dirty=false,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(s,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(r,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a));}_getColorGradingDataToRef(e,t,i,s,r){null!=e&&(e=Tn._Clamp(e,0,360),t=Tn._Clamp(t,-100,100),i=Tn._Clamp(i,-100,100),s=Tn._Clamp(s,-100,100),t=Tn._ApplyColorGradingSliderNonlinear(t),t*=.5,s=Tn._ApplyColorGradingSliderNonlinear(s),t<0&&(t*=-1,e=(e+180)%360),Tn._FromHSBToRef(e,t,50+.25*s,r),r.scaleToRef(2,r),r.a=1+.01*i);}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,s){let r=Tn._Clamp(e,0,360);const n=Tn._Clamp(t/100,0,1),a=Tn._Clamp(i/100,0,1);if(0===n)s.r=a,s.g=a,s.b=a;else {r/=60;const e=Math.floor(r),t=r-e,i=a*(1-n),o=a*(1-n*t),h=a*(1-n*(1-t));switch(e){case 0:s.r=a,s.g=h,s.b=i;break;case 1:s.r=o,s.g=a,s.b=i;break;case 2:s.r=i,s.g=a,s.b=h;break;case 3:s.r=i,s.g=o,s.b=a;break;case 4:s.r=h,s.g=i,s.b=a;break;default:s.r=a,s.g=i,s.b=o;}}s.a=1;}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return Ae$3.Clone((()=>new Tn),this)}serialize(){return Ae$3.Serialize(this)}static Parse(e){return Ae$3.Parse((()=>new Tn),e,null,null)}}Tn.PrepareUniforms=mn,e$z([a$$()],Tn.prototype,"_globalHue",void 0),e$z([a$$()],Tn.prototype,"_globalDensity",void 0),e$z([a$$()],Tn.prototype,"_globalSaturation",void 0),e$z([a$$()],Tn.prototype,"_globalExposure",void 0),e$z([a$$()],Tn.prototype,"_highlightsHue",void 0),e$z([a$$()],Tn.prototype,"_highlightsDensity",void 0),e$z([a$$()],Tn.prototype,"_highlightsSaturation",void 0),e$z([a$$()],Tn.prototype,"_highlightsExposure",void 0),e$z([a$$()],Tn.prototype,"_midtonesHue",void 0),e$z([a$$()],Tn.prototype,"_midtonesDensity",void 0),e$z([a$$()],Tn.prototype,"_midtonesSaturation",void 0),e$z([a$$()],Tn.prototype,"_midtonesExposure",void 0),Ae$3._ColorCurvesParser=Tn.Parse;class En{constructor(){this.colorCurves=new Tn,this._colorCurvesEnabled=false,this._colorGradingEnabled=false,this._colorGradingWithGreenDepth=true,this._colorGradingBGR=true,this._exposure=1,this._toneMappingEnabled=false,this._toneMappingType=En.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new me$3(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=En.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=false,this._ditheringEnabled=false,this._ditheringIntensity=1/255,this._skipFinalColorClamp=false,this._applyByPostProcess=false,this._isEnabled=true,this.outputTextureWidth=0,this.outputTextureHeight=0,this.onUpdateParameters=new R$g;}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters());}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters());}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters());}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters());}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters());}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters());}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters());}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters());}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters());}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e;}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e;}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters());}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters());}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters());}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters());}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters());}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters());}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters());}_updateParameters(){this.onUpdateParameters.notifyObservers(this);}getClassName(){return "ImageProcessingConfiguration"}prepareDefines(e,t=false){if(t!==this.applyByPostProcess||!this._isEnabled)return e.VIGNETTE=false,e.TONEMAPPING=0,e.CONTRAST=false,e.EXPOSURE=false,e.COLORCURVES=false,e.COLORGRADING=false,e.COLORGRADING3D=false,e.DITHER=false,e.IMAGEPROCESSING=false,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===En._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,this._toneMappingEnabled)switch(this._toneMappingType){case En.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case En.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1;}else e.TONEMAPPING=0;e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=false,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER;}isReady(){return !this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&Tn.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/(this.outputTextureWidth||e.getEngine().getRenderWidth()),s=1/(this.outputTextureHeight||e.getEngine().getRenderHeight());if(e.setFloat2("vInverseScreenSize",i,s),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const r=null!=t?t:s/i;let n=Math.tan(.5*this.vignetteCameraFov),a=n*r;const o=Math.sqrt(a*n);a=pi(a,o,this.vignetteStretch),n=pi(n,o,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,n,-a*this.vignetteCenterX,-n*this.vignetteCenterY);const h=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,h);}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const t=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(t-1)/t,.5/t,t,this.colorGradingTexture.level);}}clone(){return Ae$3.Clone((()=>new En),this)}serialize(){return Ae$3.Serialize(this)}static Parse(e){const t=Ae$3.Parse((()=>new En),e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}En.TONEMAPPING_STANDARD=0,En.TONEMAPPING_ACES=1,En.TONEMAPPING_KHR_PBR_NEUTRAL=2,En.PrepareUniforms=function(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&mn(e),t.DITHER&&e.push("ditherIntensity");},En.PrepareSamplers=function(e,t){t.COLORGRADING&&e.push("txColorTransform");},En._VIGNETTEMODE_MULTIPLY=0,En._VIGNETTEMODE_OPAQUE=1,e$z([function(e){return r$1U(7,e)}()],En.prototype,"colorCurves",void 0),e$z([a$$()],En.prototype,"_colorCurvesEnabled",void 0),e$z([o$19("colorGradingTexture")],En.prototype,"_colorGradingTexture",void 0),e$z([a$$()],En.prototype,"_colorGradingEnabled",void 0),e$z([a$$()],En.prototype,"_colorGradingWithGreenDepth",void 0),e$z([a$$()],En.prototype,"_colorGradingBGR",void 0),e$z([a$$()],En.prototype,"_exposure",void 0),e$z([a$$()],En.prototype,"_toneMappingEnabled",void 0),e$z([a$$()],En.prototype,"_toneMappingType",void 0),e$z([a$$()],En.prototype,"_contrast",void 0),e$z([a$$()],En.prototype,"vignetteStretch",void 0),e$z([a$$()],En.prototype,"vignetteCenterX",void 0),e$z([a$$()],En.prototype,"vignetteCenterY",void 0),e$z([a$$()],En.prototype,"vignetteWeight",void 0),e$z([_$j()],En.prototype,"vignetteColor",void 0),e$z([a$$()],En.prototype,"vignetteCameraFov",void 0),e$z([a$$()],En.prototype,"_vignetteBlendMode",void 0),e$z([a$$()],En.prototype,"_vignetteEnabled",void 0),e$z([a$$()],En.prototype,"_ditheringEnabled",void 0),e$z([a$$()],En.prototype,"_ditheringIntensity",void 0),e$z([a$$()],En.prototype,"_skipFinalColorClamp",void 0),e$z([a$$()],En.prototype,"_applyByPostProcess",void 0),e$z([a$$()],En.prototype,"_isEnabled",void 0),e$z([a$$()],En.prototype,"outputTextureWidth",void 0),e$z([a$$()],En.prototype,"outputTextureHeight",void 0),Ae$3._ImageProcessingConfigurationParser=En.Parse,P$9("BABYLON.ImageProcessingConfiguration",En);class An{constructor(e,t,i,s,r,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=s,this.sourceEvent=r,this.additionalData=n;}static CreateNew(e,t,i){const s=e.getScene();return new An(e,s.pointerX,s.pointerY,s.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,s){return new An(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,s)}static CreateNewFromScene(e,t){return new An(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,s){return new An(e,t.x,t.y,null,i,s)}}class Rn{constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new R$g,this._scene=e;}_prepareBuffers(){if(this._vertexBuffers[Hi.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[Hi.PositionKind]=new Hi(this._scene.getEngine(),e,Hi.PositionKind,false,false,2),this._buildIndexBuffer();}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e);}_rebuild(){const e=this._vertexBuffers[Hi.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer());}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return !!i&&(!(!(t=t||i._postProcesses.filter((e=>null!=e)))||0===t.length||!this._scene.postProcessesEnabled)&&(t[0].activate(i,e,null!=t),true))}directRender(e,t=null,i=false,s=0,r=0,n=false,a=e.length){const o=this._scene.getEngine();for(let h=0;h<a;h++){h<e.length-1?e[h+1].activate(this._scene.activeCamera||this._scene,t?.texture):(t?o.bindFramebuffer(t,s,void 0,void 0,i,r):n||o.restoreDefaultFramebuffer(),o._debugInsertMarker?.(`post process ${e[h].name} output`));const a=e[h],l=a.apply();l&&(a.onBeforeRenderObservable.notifyObservers(l),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,l),o.drawElementsType(Qe$1.MATERIAL_TriangleFillMode,0,6),a.onAfterRenderObservable.notifyObservers(l));}o.setDepthBuffer(true),o.setDepthWrite(true);}_finalizeFrame(e,t,i,s,r=false){const n=this._scene.activeCamera;if(!n)return;if(this.onBeforeRenderObservable.notifyObservers(this),0===(s=s||n._postProcesses.filter((e=>null!=e))).length||!this._scene.postProcessesEnabled)return;const a=this._scene.getEngine();for(let o=0,h=s.length;o<h;o++){const l=s[o];if(o<h-1?l._outputTexture=s[o+1].activate(n,t?.texture):(t?(a.bindFramebuffer(t,i,void 0,void 0,r),l._outputTexture=t):(a.restoreDefaultFramebuffer(),l._outputTexture=null),a._debugInsertMarker?.(`post process ${s[o].name} output`)),e)break;const c=l.apply();c&&(l.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,c),a.drawElementsType(Qe$1.MATERIAL_TriangleFillMode,0,6),l.onAfterRenderObservable.notifyObservers(c));}a.setDepthBuffer(true),a.setDepthWrite(true),a.setAlphaMode(Qe$1.ALPHA_DISABLE);}dispose(){const e=this._vertexBuffers[Hi.PositionKind];e&&(e.dispose(),this._vertexBuffers[Hi.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);}}const bn=new re$5,Sn=new re$5,xn=new re$5,Mn={getScene:()=>{},eyeAtCamera:true};function yn(e,t,i){const s=i.asArray(),r=t.asArray();for(let e=0;e<16;e++)s[e]=r[e];return s[12]-=e.x,s[13]-=e.y,s[14]-=e.z,i.markAsUpdated(),i}function In(e,t,i){return Z$3(t,Sn),yn(e,Sn,xn),Z$3(xn,i),i}function Cn(e,t,i){if(!Mn.eyeAtCamera)return In(e,t,i);const s=i.asArray(),r=t.asArray();for(let e=0;e<16;e++)s[e]=r[e];return s[12]=0,s[13]=0,s[14]=0,i.markAsUpdated(),i}function vn(e,t,i,s){return q$5(Cn(e,t,s),i,s),s}function Pn(e,t,i,s){return In(e,t,xn),q$5(xn,i,s),s}function On(e,t){bn.updateFlag=t.updateFlag;const i=Mn.getScene();if(!i)return t;const s=i.floatingOriginOffset;switch(e){case "world":return yn(s,t,bn);case "view":return Cn(s,t,bn);case "worldView":return function(e,t,i,s){return Z$3(i,Sn),q$5(t,Sn,xn),yn(e,xn,Sn),Cn(e,i,xn),q$5(Sn,xn,s),s}(s,t,i.getViewMatrix(),bn);case "viewProjection":return vn(s,i.getViewMatrix(),i.getProjectionMatrix(),bn);case "worldViewProjection":return function(e,t,i,s,r,n){return Z$3(i,Sn),q$5(t,Sn,xn),yn(e,xn,Sn),vn(e,s,r,xn),q$5(Sn,xn,n),n}(s,t,i.getTransformMatrix(),i.getViewMatrix(),i.getProjectionMatrix(),bn);default:return t}}const Dn=cs,Ln=Nt$1,Fn=Dn.prototype._updateMatrixForUniform,wn=Nt$1.prototype.setMatrix;class Nn{set opaqueSortCompareFn(e){this._opaqueSortCompareFn=e||Nn.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted;}set alphaTestSortCompareFn(e){this._alphaTestSortCompareFn=e||Nn.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted;}set transparentSortCompareFn(e){this._transparentSortCompareFn=e||Nn.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted;}constructor(e,t,i=null,s=null,r=null){this.index=e,this._opaqueSubMeshes=new Ii(256),this._transparentSubMeshes=new Ii(256),this._alphaTestSubMeshes=new Ii(256),this._depthOnlySubMeshes=new Ii(256),this._particleSystems=new Ii(256),this._spriteManagers=new Ii(256),this._empty=true,this._edgesRenderers=new Ci(16),this.disableDepthPrePass=false,this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=r;}render(e,t,i,s){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const r=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(r.setColorWrite(false),this._renderAlphaTest(this._depthOnlySubMeshes),r.setColorWrite(true)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=r.getStencilBuffer();if(r.setStencilBuffer(false),t&&this._renderSprites(),i&&this._renderParticles(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(r.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const e=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);e.length&&this._renderTransparent(e);}else this._renderTransparent(this._transparentSubMeshes);r.setAlphaMode(Qe$1.ALPHA_DISABLE);}if(r.setStencilBuffer(false),this._edgesRenderers.length){for(let e=0;e<this._edgesRenderers.length;e++)this._edgesRenderers.data[e].render();r.setAlphaMode(Qe$1.ALPHA_DISABLE);}r.setStencilBuffer(n);}_renderOpaqueSorted(e){Nn._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,false,this.disableDepthPrePass);}_renderAlphaTestSorted(e){Nn._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,false,this.disableDepthPrePass);}_renderTransparentSorted(e){Nn._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,true,this.disableDepthPrePass);}static _RenderSorted(e,t,i,s,r){let n,a=0;const o=i?i.globalPosition:Nn._ZeroVector;if(s)for(;a<e.length;a++)n=e.data[a],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=te$4.Distance(n.getBoundingInfo().boundingSphere.centerWorld,o);const h=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&h.sort(t);const l=h[0].getMesh().getScene();for(a=0;a<h.length;a++)if(n=h[a],!l._activeMeshesFrozenButKeepClipping||n.isInFrustum(l._frustumPlanes)){if(s){const e=n.getMaterial();if(e&&e.needDepthPrePass&&!r){const t=e.getScene().getEngine();t.setColorWrite(false),t.setAlphaMode(Qe$1.ALPHA_DISABLE),n.render(false),t.setColorWrite(true);}}n.render(s);}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:Nn.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),s=t.getMesh();return i.material&&s.material?i.material.uniqueId-s.material.uniqueId:i.uniqueId-s.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=true;}prepareSprites(){this._spriteManagers.reset();}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose();}dispatch(e,t,i){ void 0===t&&(t=e.getMesh()),void 0===i&&(i=e.getMaterial()),null!=i&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTestingForMesh(t)?(i.needDepthPrePass&&!this.disableDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&!this.disableDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=false);}dispatchSprites(e){this._spriteManagers.push(e),this._empty=false;}dispatchParticles(e){this._particleSystems.push(e),this._empty=false;}_renderParticles(e){if(0===this._particleSystems.length)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const s=this._particleSystems.data[i];if(0===(t&&t.layerMask&s.layerMask))continue;const r=s.emitter;r.position&&e&&-1===e.indexOf(r)||this._scene._activeParticles.addCount(s.render(),false);}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene);}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];0!==(e&&e.layerMask&i.layerMask)&&i.render();}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene);}}Nn._ZeroVector=te$4.Zero();class Bn{}class Un{get disableDepthPrePass(){return this._disableDepthPrePass}set disableDepthPrePass(e){this._disableDepthPrePass=e;for(const t of this._renderingGroups)t.disableDepthPrePass=e;}get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags());}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=false;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=false;for(const e of this._scene.particleSystems)e._wasDispatched=false;}constructor(e){this._useSceneAutoClearSetup=false,this._disableDepthPrePass=false,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new Bn,this._maintainStateBetweenFrames=false,this._scene=e;for(let e=Un.MIN_RENDERINGGROUPS;e<Un.MAX_RENDERINGGROUPS;e++)this._autoClearDepthStencil[e]={autoClear:true,depth:true,stencil:true};}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=true,t=true){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,false,e,t),this._depthStencilBufferAlreadyCleaned=true);}render(e,t,i,s){const r=this._renderingGroupInfo;if(r.scene=this._scene,r.camera=this._scene.activeCamera,r.renderingManager=this,this._scene.spriteManagers&&s)for(let e=0;e<this._scene.spriteManagers.length;e++){const t=this._scene.spriteManagers[e];this.dispatchSprites(t);}for(let n=Un.MIN_RENDERINGGROUPS;n<Un.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===Un.MIN_RENDERINGGROUPS;const a=this._renderingGroups[n];if(!a||a._empty)continue;const o=1<<n;if(r.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(r,o),Un.AUTOCLEAR){const e=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];e&&e.autoClear&&this._clearDepthStencilBuffer(e.depth,e.stencil);}for(const e of this._scene._beforeRenderingGroupDrawStage)e.action(n);a.render(e,s,i,t);for(const e of this._scene._afterRenderingGroupDrawStage)e.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(r,o);}}reset(){if(!this.maintainStateBetweenFrames)for(let e=Un.MIN_RENDERINGGROUPS;e<Un.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare();}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=Un.MIN_RENDERINGGROUPS;e<Un.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites();}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null;}freeRenderingGroups(){for(let e=Un.MIN_RENDERINGGROUPS;e<Un.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose();}}_prepareRenderingGroup(e){ void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new Nn(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]),this._renderingGroups[e].disableDepthPrePass=this._disableDepthPrePass);}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=true,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e));}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=true,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e));}dispatch(e,t,i){ void 0===t&&(t=e.getMesh()),this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=true,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i));}setRenderingOrder(e,t=null,i=null,s=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=s,this._renderingGroups[e]){const t=this._renderingGroups[e];t.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],t.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],t.transparentSortCompareFn=this._customTransparentSortCompareFn[e];}}setRenderingAutoClearDepthStencil(e,t,i=true,s=true){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:s};}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}Un.MAX_RENDERINGGROUPS=4,Un.MIN_RENDERINGGROUPS=0,Un.AUTOCLEAR=true;class kn{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=false,this.disposeWhenUnowned=true;}static get HasTriggers(){for(const e in kn.Triggers)if(Object.prototype.hasOwnProperty.call(kn.Triggers,e))return  true;return  false}static get HasPickTriggers(){for(const e in kn.Triggers)if(Object.prototype.hasOwnProperty.call(kn.Triggers,e)){const t=parseInt(e);if(t>=Qe$1.ACTION_OnPickTrigger&&t<=Qe$1.ACTION_OnPickUpTrigger)return  true}return  false}static HasSpecificTrigger(e){for(const t in kn.Triggers)if(Object.prototype.hasOwnProperty.call(kn.Triggers,t)){if(parseInt(t)===e)return  true}return  false}}var Gn,Vn,Hn,zn,Xn,Wn,Yn;kn.Triggers={},function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense";}(Gn||(Gn={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move";}(Vn||(Vn={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical";}(Hn||(Hn={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis";}(zn||(zn={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis";}(Xn||(Xn={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis";}(Wn||(Wn={})),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis";}(Yn||(Yn={}));class Kn{static CreateDeviceEvent(e,t,i,s,r,n,a){switch(e){case Gn.Keyboard:return this._CreateKeyboardEvent(i,s,r,n);case Gn.Mouse:if(i===Vn.MouseWheelX||i===Vn.MouseWheelY||i===Vn.MouseWheelZ)return this._CreateWheelEvent(e,t,i,s,r,n);case Gn.Touch:return this._CreatePointerEvent(e,t,i,s,r,n,a);default:throw `Unable to generate event for device ${Gn[e]}`}}static _CreatePointerEvent(e,t,i,s,r,n,a){const o=this._CreateMouseEvent(e,t,i,s,r,n);e===Gn.Mouse?(o.deviceType=Gn.Mouse,o.pointerId=1,o.pointerType="mouse"):(o.deviceType=Gn.Touch,o.pointerId=a??t,o.pointerType="touch");let h=0;return h+=r.pollInput(e,t,Vn.LeftClick),h+=2*r.pollInput(e,t,Vn.RightClick),h+=4*r.pollInput(e,t,Vn.MiddleClick),o.buttons=h,i===Vn.Move?o.type="pointermove":i>=Vn.LeftClick&&i<=Vn.RightClick&&(o.type=1===s?"pointerdown":"pointerup",o.button=i-2),o}static _CreateWheelEvent(e,t,i,s,r,n){const a=this._CreateMouseEvent(e,t,i,s,r,n);switch(a.pointerId=1,a.type="wheel",a.deltaMode=nn.DOM_DELTA_PIXEL,a.deltaX=0,a.deltaY=0,a.deltaZ=0,i){case Vn.MouseWheelX:a.deltaX=s;break;case Vn.MouseWheelY:a.deltaY=s;break;case Vn.MouseWheelZ:a.deltaZ=s;}return a}static _CreateMouseEvent(e,t,i,s,r,n){const a=this._CreateEvent(n),o=r.pollInput(e,t,Vn.Horizontal),h=r.pollInput(e,t,Vn.Vertical);return n?(a.movementX=0,a.movementY=0,a.offsetX=a.movementX-n.getBoundingClientRect().x,a.offsetY=a.movementY-n.getBoundingClientRect().y):(a.movementX=r.pollInput(e,t,10),a.movementY=r.pollInput(e,t,11),a.offsetX=0,a.offsetY=0),this._CheckNonCharacterKeys(a,r),a.clientX=o,a.clientY=h,a.x=o,a.y=h,a.deviceType=e,a.deviceSlot=t,a.inputIndex=i,a}static _CreateKeyboardEvent(e,t,i,s){const r=this._CreateEvent(s);return this._CheckNonCharacterKeys(r,i),r.deviceType=Gn.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=1===t?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(Gn.Keyboard),s=i&&1===t.pollInput(Gn.Keyboard,0,Qe$1.INPUT_ALT_KEY),r=i&&1===t.pollInput(Gn.Keyboard,0,Qe$1.INPUT_CTRL_KEY),n=i&&(1===t.pollInput(Gn.Keyboard,0,Qe$1.INPUT_META_KEY1)||1===t.pollInput(Gn.Keyboard,0,Qe$1.INPUT_META_KEY2)||1===t.pollInput(Gn.Keyboard,0,Qe$1.INPUT_META_KEY3)),a=i&&1===t.pollInput(Gn.Keyboard,0,Qe$1.INPUT_SHIFT_KEY);e.altKey=s,e.ctrlKey=r,e.metaKey=n,e.shiftKey=a;}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class jn{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,((e,t,s,r)=>{const n=Kn.CreateDeviceEvent(e,t,s,r,this);i(e,t,n);})):this._createDummyNativeInput();}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===Gn.Mouse||e===Gn.Touch}dispose(){this._nativeInput.dispose();}_createDummyNativeInput(){return {pollInput:()=>0,isDeviceAvailable:()=>false,dispose:()=>{}}}}const Qn=Object.keys(Vn).length/2;class qn{constructor(e,t,i,s){this._inputs=[],this._keyboardActive=false,this._pointerActive=false,this._usingSafari=Ai.IsSafari(),this._usingMacOs=xe$3()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerCancelTouch=e=>{},this._pointerLeaveEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._pointerMacOsChromeOutEvent=e=>{},this._eventsAttached=false,this._mouseId=-1,this._isUsingFirefox=xe$3()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._isUsingChromium=xe$3()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Chrome"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=Ai.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=s,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOs&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents();});}pollInput(e,t,i){const s=this._inputs[e][t];if(!s)throw `Unable to find device ${Gn[e]}`;e>=Gn.DualShock&&e<=Gn.DualSense&&this._updateDevice(e,t,i);const r=s[i];if(void 0===r)throw `Unable to find input ${i} for device ${Gn[e]} in slot ${t}`;return i===Vn.Move&&Ai.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),r}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents();}_enableEvents(){const e=this?._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const e of this._inputs)if(e)for(const t in e){const i=e[+t];if(i)for(let e=0;e<i.length;e++)i[e]=0;}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=true,this._checkForConnectedDevices();}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOs&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=false;}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t);}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Gn.Mouse,0,0,0);}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t;}_addPointerDevice(e,t,i,s){this._pointerActive||(this._pointerActive=true),this._registerDevice(e,t,Qn);const r=this._inputs[e][t];r[0]=i,r[1]=s;}_registerDevice(e,t,i){if(void 0===t)throw `Unable to register device ${Gn[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const s=new Array(i);s.fill(0),this._inputs[e][t]=s,this._onDeviceConnected(e,t);}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t));}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=true,this._registerDevice(Gn.Keyboard,0,255));const t=this._inputs[Gn.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOs&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Gn.Keyboard,0,i);}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=true,this._registerDevice(Gn.Keyboard,0,255));const t=this._inputs[Gn.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOs&&"Meta"===e.key&&this._metaKeys.length>0){for(const e of this._metaKeys){const i=Kn.CreateDeviceEvent(Gn.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(Gn.Keyboard,0,i);}this._metaKeys.splice(0,this._metaKeys.length);}this._onInputChanged(Gn.Keyboard,0,i);}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[Gn.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const i=Kn.CreateDeviceEvent(Gn.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Gn.Keyboard,0,i);}this._usingMacOs&&this._metaKeys.splice(0,this._metaKeys.length);}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent);}_handlePointerActions(){this._maxTouchPoints=xe$3()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{const t=this._getPointerType(e);let i=t===Gn.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===Gn.Touch&&-1===i){const s=this._activeTouchIds.indexOf(-1);if(!(s>=0))return void Ai.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=s,this._activeTouchIds[s]=e.pointerId,this._onDeviceConnected(t,i);}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]||this._addPointerDevice(t,i,e.clientX,e.clientY);const s=this._inputs[t][i];if(s){const r=e;r.inputIndex=Vn.Move,s[Vn.Horizontal]=e.clientX,s[Vn.Vertical]=e.clientY,t===Gn.Touch&&0===s[Vn.LeftClick]&&(s[Vn.LeftClick]=1),void 0===e.pointerId&&(e.pointerId=this._mouseId),this._onInputChanged(t,i,r),this._usingSafari||-1===e.button||(r.inputIndex=e.button+2,s[e.button+2]=s[e.button+2]?0:1,this._onInputChanged(t,i,r));}},this._pointerDownEvent=e=>{const t=this._getPointerType(e);let i=t===Gn.Mouse?0:e.pointerId;if(t===Gn.Touch){let t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t&&(t=this._activeTouchIds.indexOf(-1)),!(t>=0))return void Ai.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=t,this._activeTouchIds[t]=e.pointerId;}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]?t===Gn.Touch&&this._onDeviceConnected(t,i):this._addPointerDevice(t,i,e.clientX,e.clientY);const s=this._inputs[t][i];if(s){const r=s[Vn.Horizontal],n=s[Vn.Vertical];if(t===Gn.Mouse){if(void 0===e.pointerId&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId);}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId);}catch(e){}s[Vn.Horizontal]=e.clientX,s[Vn.Vertical]=e.clientY,s[e.button+2]=1;const a=e;a.inputIndex=e.button+2,this._onInputChanged(t,i,a),r===e.clientX&&n===e.clientY||(a.inputIndex=Vn.Move,this._onInputChanged(t,i,a));}},this._pointerUpEvent=e=>{const t=this._getPointerType(e),i=t===Gn.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===Gn.Touch){if(-1===i)return;this._activeTouchIds[i]=-1;}const s=this._inputs[t]?.[i];let r=e.button,n=s&&0!==s[r+2];if(!n&&this._isUsingFirefox&&this._usingMacOs&&s&&(r=2===r?0:2,n=0!==s[r+2]),n){const n=s[Vn.Horizontal],a=s[Vn.Vertical];s[Vn.Horizontal]=e.clientX,s[Vn.Vertical]=e.clientY,s[r+2]=0;const o=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),n===e.clientX&&a===e.clientY||(o.inputIndex=Vn.Move,this._onInputChanged(t,i,o)),o.inputIndex=r+2,t===Gn.Mouse&&this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&this._elementToAttachTo.hasPointerCapture?.(e.pointerId)&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(t,i,o),t===Gn.Touch&&this._onDeviceDisconnected(t,i);}},this._pointerCancelTouch=e=>{const t=this._activeTouchIds.indexOf(e);if(-1===t)return;this._elementToAttachTo.hasPointerCapture?.(e)&&this._elementToAttachTo.releasePointerCapture(e),this._inputs[Gn.Touch][t][Vn.LeftClick]=0;const i=Kn.CreateDeviceEvent(Gn.Touch,t,Vn.LeftClick,0,this,this._elementToAttachTo,e);this._onInputChanged(Gn.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(Gn.Touch,t);},this._pointerCancelEvent=e=>{if("mouse"===e.pointerType){const e=this._inputs[Gn.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=Vn.LeftClick;t<=Vn.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=Kn.CreateDeviceEvent(Gn.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Gn.Mouse,0,i);}}else this._pointerCancelTouch(e.pointerId);},this._pointerLeaveEvent=e=>{"pen"===e.pointerType&&this._pointerCancelTouch(e.pointerId);},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=false;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0;}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i);}catch(e){}this._pointerBlurEvent=()=>{if(this.isDeviceAvailable(Gn.Mouse)){const e=this._inputs[Gn.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=Vn.LeftClick;t<=Vn.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=Kn.CreateDeviceEvent(Gn.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Gn.Mouse,0,i);}}if(this.isDeviceAvailable(Gn.Touch)){const e=this._inputs[Gn.Touch];for(let t=0;t<this._activeTouchIds.length;t++){const i=this._activeTouchIds[t];if(this._elementToAttachTo.hasPointerCapture?.(i)&&this._elementToAttachTo.releasePointerCapture(i),-1!==i&&1===e[t]?.[Vn.LeftClick]){e[t][Vn.LeftClick]=0;const s=Kn.CreateDeviceEvent(Gn.Touch,t,Vn.LeftClick,0,this,this._elementToAttachTo,i);this._onInputChanged(Gn.Touch,t,s),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(Gn.Touch,t);}}}},this._pointerWheelEvent=e=>{const t=Gn.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=true,this._registerDevice(t,0,Qn));const i=this._inputs[t][0];if(i){i[Vn.MouseWheelX]=e.deltaX||0,i[Vn.MouseWheelY]=e.deltaY||e.wheelDelta||0,i[Vn.MouseWheelZ]=e.deltaZ||0;const s=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),0!==i[Vn.MouseWheelX]&&(s.inputIndex=Vn.MouseWheelX,this._onInputChanged(t,0,s)),0!==i[Vn.MouseWheelY]&&(s.inputIndex=Vn.MouseWheelY,this._onInputChanged(t,0,s)),0!==i[Vn.MouseWheelZ]&&(s.inputIndex=Vn.MouseWheelZ,this._onInputChanged(t,0,s));}},this._usingMacOs&&this._isUsingChromium&&(this._pointerMacOsChromeOutEvent=e=>{e.buttons>1&&this._pointerCancelEvent(e);},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:false}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add((()=>{if(this.isDeviceAvailable(Gn.Mouse)){const e=this._inputs[Gn.Mouse][0];e[Vn.MouseWheelX]=0,e[Vn.MouseWheelY]=0,e[Vn.MouseWheelZ]=0;}}));}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad);},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i];}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent);}_updateDevice(e,t,i){const s=navigator.getGamepads()[t];if(s&&e===this._gamepads[t]){const r=this._inputs[e][t];i>=s.buttons.length?r[i]=s.axes[i-s.buttons.length].valueOf():r[i]=s.buttons[i].value;}}_getGamepadDeviceType(e){return  -1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?Gn.DualSense:Gn.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?Gn.Xbox:-1!==e.indexOf("057e")?Gn.Switch:Gn.Generic}_getPointerType(e){let t=Gn.Mouse;return ("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=Gn.Touch),t}}class Zn{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new R$g,this._deviceInputSystem=e;}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class Jn{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){const i=this._devices[t];for(const s in i){const i=+s;e._addDevice(new Zn(this._deviceInputSystem,t,i));}}this._registeredManagers.push(e);},this.unregisterManager=e=>{const t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1);};const t=Object.keys(Gn).length/2;this._devices=new Array(t);const i=(e,t)=>{this._devices[e]||(this._devices[e]=new Array),this._devices[e][t]||(this._devices[e][t]=t);for(const i of this._registeredManagers){const s=new Zn(this._deviceInputSystem,e,t);i._addDevice(s);}},s=(e,t)=>{this._devices[e]?.[t]&&delete this._devices[e][t];for(const i of this._registeredManagers)i._removeDevice(e,t);},r=(e,t,i)=>{if(i)for(const s of this._registeredManagers)s._onInputChanged(e,t,i);};"undefined"!=typeof _native?this._deviceInputSystem=new jn(i,s,r):this._deviceInputSystem=new qn(e,i,s,r);}dispose(){this._deviceInputSystem.dispose();}}class $n{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e];}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter((e=>!!e)):[]}constructor(e){const t=Object.keys(Gn).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new Jn(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new R$g((e=>{for(const t of this._devices)if(t)for(const i of t)i&&this.onDeviceConnectedObservable.notifyObserver(e,i);})),this.onDeviceDisconnectedObservable=new R$g,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add((()=>{this.dispose();}));}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver);}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=[]),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e);}_removeDevice(e,t){const i=this._devices[e]?.[t];this.onDeviceDisconnectedObservable.notifyObservers(i),this._devices[e]?.[t]&&delete this._devices[e][t],this._updateFirstDevices(e);}_onInputChanged(e,t,i){this._devices[e]?.[t]?.onInputChangedObservable.notifyObservers(i);}_updateFirstDevices(e){switch(e){case Gn.Keyboard:case Gn.Mouse:this._firstDevice[e]=0;break;case Gn.Touch:case Gn.DualSense:case Gn.DualShock:case Gn.Xbox:case Gn.Switch:case Gn.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t)for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}break}}}}class ea{}ea._IsPickingAvailable=false;class ta{constructor(){this._singleClick=false,this._doubleClick=false,this._hasSwiped=false,this._ignore=false;}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e;}set doubleClick(e){this._doubleClick=e;}set hasSwiped(e){this._hasSwiped=e;}set ignore(e){this._ignore=e;}}class ia{constructor(e){this._alreadyAttached=false,this._meshPickProceed=false,this._currentPickResult=null,this._previousPickResult=null,this._activePointerIds=new Array,this._activePointerIdsCount=0,this._doubleClickOccured=false,this._isSwiping=false,this._swipeButtonPressed=-1,this._skipPointerTap=false,this._isMultiTouchGesture=false,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new ee$4(0,0),this._previousStartingPointerPosition=new ee$4(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||L$7.LastCreatedScene,this._scene;}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new ee$4(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e;}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e;}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY);}_processPointerMove(e,t){const i=this._scene,s=i.getEngine(),r=s.getInputElement();r&&(r.tabIndex=s.canvasTabIndex,i.doNotHandleCursors||(r.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const s of i._pointerMoveStage){e=e||this._pickMove(t);const i=!!e?.pickedMesh;e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,i,r);}const n=t.inputIndex>=Vn.MouseWheelX&&t.inputIndex<=Vn.MouseWheelZ?Ar$1.POINTERWHEEL:Ar$1.POINTERMOVE;let a;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,n)),e?(a=new Sr$1(n,t,e),this._setRayOnPointerInfo(e,t)):(a=new Sr$1(n,t,null,this),this._movePointerInfo=a),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(a,n);}_setRayOnPointerInfo(e,t){const i=this._scene;e&&ea._IsPickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,re$5.Identity(),i.activeCamera)));}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return !!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const s=this._scene,r=new br$1(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(r.originalPickingInfo=e,r.ray=e.ray,"xr-near"===t.pointerType&&e.originMesh&&(r.nearInteractionPickingInfo=e)),s.onPrePointerObservable.notifyObservers(r,i),!!r.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const s=i.getEngine().getInputElement();if(e?.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&s&&this._pointerOverMesh){const e=this._pointerOverMesh._getActionManagerForTrigger();e&&e.hasPointerTriggers&&(s.style.cursor=e.hoverCursor||i.hoverCursor);}}else this.setPointerOverMesh(null,t.pointerId,e,t);}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=Vn.Move,this._checkPrePointerObservable(e,i,Ar$1.POINTERMOVE)||this._processPointerMove(e,i);}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,this._checkPrePointerObservable(e,i,Ar$1.POINTERDOWN)||this._processPointerDown(e,i);}_processPointerDown(e,t){const i=this._scene;if(e?.pickedMesh){this._pickedDownMesh=e.pickedMesh;const s=e.pickedMesh._getActionManagerForTrigger();if(s){if(s.hasPickTriggers)switch(s.processTrigger(Qe$1.ACTION_OnPickDownTrigger,new An(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e)),t.button){case 0:s.processTrigger(Qe$1.ACTION_OnLeftPickTrigger,new An(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 1:s.processTrigger(Qe$1.ACTION_OnCenterPickTrigger,new An(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 2:s.processTrigger(Qe$1.ACTION_OnRightPickTrigger,new An(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));}s.hasSpecificTrigger(Qe$1.ACTION_OnLongPressTrigger)&&window.setTimeout((()=>{const e=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,(e=>e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(Qe$1.ACTION_OnLongPressTrigger)&&e===this._pickedDownMesh),false,i.cameraToUseForPointers);e?.pickedMesh&&s&&0!==this._activePointerIdsCount&&Date.now()-this._startingPointerTime>ia.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,s.processTrigger(Qe$1.ACTION_OnLongPressTrigger,An.CreateNew(e.pickedMesh,t)));}),ia.LongPressDelay);}}else for(const s of i._pointerDownStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,false);let s;const r=Ar$1.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,r),s=new Sr$1(r,t,e),this._setRayOnPointerInfo(e,t)):s=new Sr$1(r,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(s,r);}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const s=new PointerEvent("pointerup",t);s.inputIndex=Vn.Move;const r=new ta;i?r.doubleClick=true:r.singleClick=true,this._checkPrePointerObservable(e,s,Ar$1.POINTERUP)||this._processPointerUp(e,s,r);}_processPointerUp(e,t,i){const s=this._scene;if(e?.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(s.onPointerPick&&s.onPointerPick(t,e),i.singleClick&&!i.ignore&&s.onPointerObservable.observers.length>this._cameraObserverCount)){const i=Ar$1.POINTERPICK,r=new Sr$1(i,t,e);this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(r,i);}const r=e.pickedMesh._getActionManagerForTrigger();if(r&&!i.ignore){r.processTrigger(Qe$1.ACTION_OnPickUpTrigger,An.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&r.processTrigger(Qe$1.ACTION_OnPickTrigger,An.CreateNew(e.pickedMesh,t,e));const s=e.pickedMesh._getActionManagerForTrigger(Qe$1.ACTION_OnDoublePickTrigger);i.doubleClick&&s&&s.processTrigger(Qe$1.ACTION_OnDoublePickTrigger,An.CreateNew(e.pickedMesh,t,e));}}else if(!i.ignore)for(const r of s._pointerUpStage)e=r.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const e=this._pickedDownMesh._getActionManagerForTrigger(Qe$1.ACTION_OnPickOutTrigger);e&&e.processTrigger(Qe$1.ACTION_OnPickOutTrigger,An.CreateNew(this._pickedDownMesh,t));}if(!i.ignore){const r=new Sr$1(Ar$1.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(r,Ar$1.POINTERUP),s.onPointerUp&&s.onPointerUp(t,e,Ar$1.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let r=0;if(i.singleClick?r=Ar$1.POINTERTAP:i.doubleClick&&(r=Ar$1.POINTERDOUBLETAP),r){const i=new Sr$1(r,t,e);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(r)&&s.onPointerObservable.notifyObservers(i,r);}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=true,t=true,i=true,s=null){const r=this._scene,n=r.getEngine();s||(s=n.getInputElement()),this._alreadyAttached&&this.detachControl(),s&&(this._alreadyAttachedTo=s),this._deviceSourceManager=new $n(n),this._initActionManager=e=>{if(!this._meshPickProceed){const t=r.skipPointerUpPicking||0===r._registeredActions&&!this._checkForPicking()&&!r.onPointerUp?null:r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerUpPredicate,r.pointerUpFastCheck,r.cameraToUseForPointers,r.pointerUpTrianglePredicate);this._currentPickResult=t,t&&(e=t.hit&&t.pickedMesh?t.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=true;}return e},this._delayedSimpleClick=(e,t,i)=>{if((Date.now()-this._previousStartingPointerTime>ia.DoubleClickDelay&&!this._doubleClickOccured||e!==this._previousButtonPressed)&&(this._doubleClickOccured=false,t.singleClick=true,t.ignore=false,this._delayedClicks[e])){const t=this._delayedClicks[e].evt,i=Ar$1.POINTERTAP,s=new Sr$1(i,t,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(i)&&r.onPointerObservable.notifyObservers(s,i),this._delayedClicks[e]=null;}},this._initClickEvent=(e,t,i,s)=>{const r=new ta;this._currentPickResult=null;let n=null,a=e.hasSpecificMask(Ar$1.POINTERPICK)||t.hasSpecificMask(Ar$1.POINTERPICK)||e.hasSpecificMask(Ar$1.POINTERTAP)||t.hasSpecificMask(Ar$1.POINTERTAP)||e.hasSpecificMask(Ar$1.POINTERDOUBLETAP)||t.hasSpecificMask(Ar$1.POINTERDOUBLETAP);!a&&kn&&(n=this._initActionManager(n,r),n&&(a=n.hasPickTriggers));let o=false;if(a=a&&!this._isMultiTouchGesture,a){const a=i.button;if(r.hasSwiped=this._isPointerSwiping(),!r.hasSwiped){let h=!ia.ExclusiveDoubleClickMode;if(h||(h=!e.hasSpecificMask(Ar$1.POINTERDOUBLETAP)&&!t.hasSpecificMask(Ar$1.POINTERDOUBLETAP),h&&!kn.HasSpecificTrigger(Qe$1.ACTION_OnDoublePickTrigger)&&(n=this._initActionManager(n,r),n&&(h=!n.hasSpecificTrigger(Qe$1.ACTION_OnDoublePickTrigger)))),h)(Date.now()-this._previousStartingPointerTime>ia.DoubleClickDelay||a!==this._previousButtonPressed)&&(r.singleClick=true,s(r,this._currentPickResult),o=true);else {const e={evt:i,clickInfo:r,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,a,r,s),ia.DoubleClickDelay)};this._delayedClicks[a]=e;}let l=e.hasSpecificMask(Ar$1.POINTERDOUBLETAP)||t.hasSpecificMask(Ar$1.POINTERDOUBLETAP);!l&&kn.HasSpecificTrigger(Qe$1.ACTION_OnDoublePickTrigger)&&(n=this._initActionManager(n,r),n&&(l=n.hasSpecificTrigger(Qe$1.ACTION_OnDoublePickTrigger))),l&&(a===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<ia.DoubleClickDelay&&!this._doubleClickOccured?(r.hasSwiped||this._isPointerSwiping()?(this._doubleClickOccured=false,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=a,ia.ExclusiveDoubleClickMode?(this._delayedClicks[a]&&(clearTimeout(this._delayedClicks[a]?.timeoutId),this._delayedClicks[a]=null),s(r,this._previousPickResult)):s(r,this._currentPickResult)):(this._previousStartingPointerTime=0,this._doubleClickOccured=true,r.doubleClick=true,r.ignore=false,ia.ExclusiveDoubleClickMode&&this._delayedClicks[a]&&(clearTimeout(this._delayedClicks[a]?.timeoutId),this._delayedClicks[a]=null),s(r,this._currentPickResult)),o=true):(this._doubleClickOccured=false,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=a));}}o||s(r,this._currentPickResult);},this._onPointerMove=e=>{if(this._updatePointerPosition(e),this._isSwiping||-1===this._swipeButtonPressed||(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>ia.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>ia.DragMovementThreshold),n.isPointerLock&&n._verifyPointerLock(),this._checkPrePointerObservable(null,e,e.inputIndex>=Vn.MouseWheelX&&e.inputIndex<=Vn.MouseWheelZ?Ar$1.POINTERWHEEL:Ar$1.POINTERMOVE))return;if(!r.cameraToUseForPointers&&!r.activeCamera)return;if(r.skipPointerMovePicking)return void this._processPointerMove(new ls,e);r.pointerMovePredicate||(r.pointerMovePredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||r.constantlyUpdateMeshUnderPointer||null!==e._getActionManagerForTrigger())&&(!r.cameraToUseForPointers||0!==(r.cameraToUseForPointers.layerMask&e.layerMask)));const t=r._registeredActions>0||r.constantlyUpdateMeshUnderPointer?this._pickMove(e):null;this._processPointerMove(t,e);},this._onPointerDown=e=>{const t=this._activePointerIds.indexOf(-1);if(-1===t?this._activePointerIds.push(e.pointerId):this._activePointerIds[t]=e.pointerId,this._activePointerIdsCount++,this._pickedDownMesh=null,this._meshPickProceed=false,ia.ExclusiveDoubleClickMode)for(let t=0;t<this._delayedClicks.length;t++)if(this._delayedClicks[t])if(e.button===t)clearTimeout(this._delayedClicks[t]?.timeoutId);else {const e=this._delayedClicks[t].clickInfo;this._doubleClickOccured=false,e.singleClick=true,e.ignore=false;const i=this._delayedClicks[t].evt,s=Ar$1.POINTERTAP,n=new Sr$1(s,i,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(s)&&r.onPointerObservable.notifyObservers(n,s),this._delayedClicks[t]=null;}if(this._updatePointerPosition(e),-1===this._swipeButtonPressed&&(this._swipeButtonPressed=e.button),r.preventDefaultOnPointerDown&&s&&(e.preventDefault(),s.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,e,Ar$1.POINTERDOWN))return;if(!r.cameraToUseForPointers&&!r.activeCamera)return;let i;this._pointerCaptures[e.pointerId]=true,r.pointerDownPredicate||(r.pointerDownPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!r.cameraToUseForPointers||0!==(r.cameraToUseForPointers.layerMask&e.layerMask))),this._pickedDownMesh=null,i=r.skipPointerDownPicking||0===r._registeredActions&&!this._checkForPicking()&&!r.onPointerDown?new ls:r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerDownPredicate,r.pointerDownFastCheck,r.cameraToUseForPointers,r.pointerDownTrianglePredicate),this._processPointerDown(i,e);},this._onPointerUp=e=>{const t=this._activePointerIds.indexOf(e.pointerId);-1!==t&&(this._activePointerIds[t]=-1,this._activePointerIdsCount--,this._pickedUpMesh=null,this._meshPickProceed=false,this._updatePointerPosition(e),r.preventDefaultOnPointerUp&&s&&(e.preventDefault(),s.focus()),this._initClickEvent(r.onPrePointerObservable,r.onPointerObservable,e,((t,i)=>{if(r.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=false,!t.ignore)){if(this._checkPrePointerObservable(null,e,Ar$1.POINTERUP))return this._swipeButtonPressed===e.button&&(this._isSwiping=false,this._swipeButtonPressed=-1),void(0===e.buttons&&(this._pointerCaptures[e.pointerId]=false));t.hasSwiped||(t.singleClick&&r.onPrePointerObservable.hasSpecificMask(Ar$1.POINTERTAP)&&this._checkPrePointerObservable(null,e,Ar$1.POINTERTAP)&&(this._skipPointerTap=true),t.doubleClick&&r.onPrePointerObservable.hasSpecificMask(Ar$1.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,e,Ar$1.POINTERDOUBLETAP)&&(this._skipPointerTap=true));}this._pointerCaptures[e.pointerId]?(0===e.buttons&&(this._pointerCaptures[e.pointerId]=false),(r.cameraToUseForPointers||r.activeCamera)&&(r.pointerUpPredicate||(r.pointerUpPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!r.cameraToUseForPointers||0!==(r.cameraToUseForPointers.layerMask&e.layerMask))),!this._meshPickProceed&&(kn&&kn.HasTriggers||this._checkForPicking()||r.onPointerUp)&&this._initActionManager(null,t),i||(i=this._currentPickResult),this._processPointerUp(i,e,t),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===e.button&&(this._isSwiping=false,this._swipeButtonPressed=-1))):this._swipeButtonPressed===e.button&&(this._isSwiping=false,this._swipeButtonPressed=-1);})));},this._onKeyDown=e=>{const t=en.KEYDOWN;if(r.onPreKeyboardObservable.hasObservers()){const i=new sn(t,e);if(r.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const i=new tn(t,e);r.onKeyboardObservable.notifyObservers(i,t);}r.actionManager&&r.actionManager.processTrigger(Qe$1.ACTION_OnKeyDownTrigger,An.CreateNewFromScene(r,e));},this._onKeyUp=e=>{const t=en.KEYUP;if(r.onPreKeyboardObservable.hasObservers()){const i=new sn(t,e);if(r.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const i=new tn(t,e);r.onKeyboardObservable.notifyObservers(i,t);}r.actionManager&&r.actionManager.processTrigger(Qe$1.ACTION_OnKeyUpTrigger,An.CreateNewFromScene(r,e));},this._deviceSourceManager.onDeviceConnectedObservable.add((s=>{s.deviceType===Gn.Mouse?s.onInputChangedObservable.add((r=>{this._originMouseEvent=r,r.inputIndex===Vn.LeftClick||r.inputIndex===Vn.MiddleClick||r.inputIndex===Vn.RightClick||r.inputIndex===Vn.BrowserBack||r.inputIndex===Vn.BrowserForward?t&&1===s.getInput(r.inputIndex)?this._onPointerDown(r):e&&0===s.getInput(r.inputIndex)&&this._onPointerUp(r):i&&(r.inputIndex===Vn.Move?this._onPointerMove(r):r.inputIndex!==Vn.MouseWheelX&&r.inputIndex!==Vn.MouseWheelY&&r.inputIndex!==Vn.MouseWheelZ||this._onPointerMove(r));})):s.deviceType===Gn.Touch?s.onInputChangedObservable.add((r=>{r.inputIndex===Vn.LeftClick&&(t&&1===s.getInput(r.inputIndex)?(this._onPointerDown(r),this._activePointerIdsCount>1&&(this._isMultiTouchGesture=true)):e&&0===s.getInput(r.inputIndex)&&(this._onPointerUp(r),0===this._activePointerIdsCount&&(this._isMultiTouchGesture=false))),i&&r.inputIndex===Vn.Move&&this._onPointerMove(r);})):s.deviceType===Gn.Keyboard&&s.onInputChangedObservable.add((e=>{"keydown"===e.type?this._onKeyDown(e):"keyup"===e.type&&this._onKeyUp(e);}));})),this._alreadyAttached=true;}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=false,this._alreadyAttachedTo=null);}setPointerOverMesh(e,t=0,i,s){if(!(this._meshUnderPointerId[t]!==e||e&&e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const r=this._meshUnderPointerId[t];let n;r&&(n=r._getActionManagerForTrigger(Qe$1.ACTION_OnPointerOutTrigger),n&&n.processTrigger(Qe$1.ACTION_OnPointerOutTrigger,new An(r,this._pointerX,this._pointerY,e,s,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,n=e._getActionManagerForTrigger(Qe$1.ACTION_OnPointerOverTrigger),n&&n.processTrigger(Qe$1.ACTION_OnPointerOverTrigger,new An(e,this._pointerX,this._pointerY,e,s,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null),this._scene.onMeshUnderPointerUpdatedObservable.hasObservers()&&this._scene.onMeshUnderPointerUpdatedObservable.notifyObservers({mesh:e,pointerId:t});}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t];}}ia.DragMovementThreshold=10,ia.LongPressDelay=500,ia.DoubleClickDelay=300,ia.ExclusiveDoubleClickMode=false;class sa{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0;}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++;}addCount(e,t){sa.Enabled&&(this._current+=e,t&&this._fetchResult());}beginMonitoring(){sa.Enabled&&(this._startMonitoringTime=Pe$2.Now);}endMonitoring(e=true){if(!sa.Enabled)return;e&&this.fetchNewFrame();const t=Pe$2.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult();}endFrame(){this._fetchResult();}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=Pe$2.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0);}}sa.Enabled=true;class ra{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}ra._UniqueIdCounter=1;class na{constructor(){this.pointerDownFastCheck=false,this.pointerUpFastCheck=false,this.pointerMoveFastCheck=false,this.skipPointerMovePicking=false,this.skipPointerDownPicking=false,this.skipPointerUpPicking=false;}}class aa{constructor(e,t,i){this.name=e,this._parentTask=t,this._context=i,this.disabled=false;}setExecuteFunc(e){this._executeFunc=e;}_execute(){this.disabled||this._executeFunc(this._context);}_isValid(){return void 0!==this._executeFunc?null:"Execute function is not set (call setExecuteFunc to set it)"}}class oa extends aa{static IsCullPass(e){return void 0!==e.setObjectList}get objectList(){return this._objectList}setObjectList(e){this._objectList=e;}constructor(e,t,i,s){super(e,t,i),this._engine=s;}_isValid(){const e=super._isValid();return e||(void 0!==this._objectList?null:"Object list is not set (call setObjectList to set it)")}}class ha extends aa{static IsRenderPass(e){return void 0!==e.setRenderTarget}get renderTarget(){return this._renderTarget}get renderTargetDepth(){return this._renderTargetDepth}constructor(e,t,i,s){super(e,t,i),this._dependencies=new Set,this.depthReadOnly=false,this.stencilReadOnly=false,this._engine=s;}setRenderTarget(e){this._renderTarget=e;}setRenderTargetDepth(e){this._renderTargetDepth=e;}addDependencies(e){if(void 0!==e)if(Array.isArray(e))for(const t of e)this._dependencies.add(t);else this._dependencies.add(e);}collectDependencies(e){const t=this._dependencies.keys();for(let i=t.next();true!==i.done;i=t.next())e.add(i.value);if(void 0!==this._renderTarget)if(Array.isArray(this._renderTarget))for(const t of this._renderTarget) void 0!==t&&e.add(t);else e.add(this._renderTarget);void 0!==this._renderTargetDepth&&e.add(this._renderTargetDepth);}_execute(){this._frameGraphRenderTarget=this._frameGraphRenderTarget||this._context.createRenderTarget(this.name,this._renderTarget,this._renderTargetDepth,this.depthReadOnly,this.stencilReadOnly),this._context.bindRenderTarget(this._frameGraphRenderTarget,`frame graph render pass - ${this.name}`),super._execute(),this._context._flushDebugMessages();}_isValid(){const e=super._isValid();return e||(void 0!==this._renderTarget||void 0!==this.renderTargetDepth?null:"Render target and render target depth cannot both be undefined.")}}class la{get name(){return this._name}set name(e){this._name=e;}get disabled(){return this._disabled}set disabled(e){this._disabled=e;}get passes(){return this._passes}get passesDisabled(){return this._passesDisabled}isReady(){return  true}dispose(){this._reset(),this.onTexturesAllocatedObservable.clear();}constructor(e,t){this._passes=[],this._passesDisabled=[],this._disabled=false,this.onTexturesAllocatedObservable=new R$g,this.name=e,this._frameGraph=t,this._reset();}_reset(){this._passes.length=0,this._passesDisabled.length=0;}_addPass(e,t){t?this._passesDisabled.push(e):this._passes.push(e);}_checkTask(){let e,t=null,i=null;for(const s of this._passes){const r=s._isValid();if(r)throw new Error(`Pass "${s.name}" is not valid. ${r}`);if(ha.IsRenderPass(s)){const e=Array.isArray(s.renderTarget)?s.renderTarget:[s.renderTarget];t=[];for(const i of e) void 0!==i&&t.push(this._frameGraph.textureManager.getTextureFromHandle(i));i=void 0!==s.renderTargetDepth?this._frameGraph.textureManager.getTextureFromHandle(s.renderTargetDepth):null;}else oa.IsCullPass(s)&&(e=s.objectList);}let s,r=null,n=[],a=null;for(const e of this._passesDisabled){const t=e._isValid();if(t)throw new Error(`Pass "${e.name}" is not valid. ${t}`);if(ha.IsRenderPass(e)){const t=Array.isArray(e.renderTarget)?e.renderTarget:[e.renderTarget];r=[];for(const e of t) void 0!==e&&r.push(this._frameGraph.textureManager.getTextureFromHandle(e));n=t,a=void 0!==e.renderTargetDepth?this._frameGraph.textureManager.getTextureFromHandle(e.renderTargetDepth):null;}else oa.IsCullPass(e)&&(s=e.objectList);}if(this._passesDisabled.length>0){if(!this._checkSameRenderTarget(t,r)){let e=true;for(const t of n)if(void 0!==t&&!this._frameGraph.textureManager.isHistoryTexture(t)){e=false;break}if(!e)throw new Error(`The output texture of the task "${this.name}" is different when it is enabled or disabled.`)}if(i!==a)throw new Error(`The output depth texture of the task "${this.name}" is different when it is enabled or disabled.`);if(e!==s)throw new Error(`The output object list of the task "${this.name}" is different when it is enabled or disabled.`)}}_getPasses(){return this.disabled&&this._passesDisabled.length>0?this._passesDisabled:this._passes}_checkSameRenderTarget(e,t){if(null===e||null===t)return e===t;if(e.length!==t.length)return  false;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return  false;return  true}}class ca{get renderList(){return this._renderList}set renderList(e){this._renderList!==e&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=C$e(e,this._renderListHasChanged)),this._renderList=e);}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(e){e!==this._disableImageProcessing&&(this._disableImageProcessing=e,this._scene.markAllMaterialsAsDirty(Qe$1.MATERIAL_ImageProcessingDirtyFlag));}get disableDepthPrePass(){return this._disableDepthPrePass}set disableDepthPrePass(e){this._disableDepthPrePass=e,this._renderingManager.disableDepthPrePass=e;}get name(){return this._name}set name(e){if(this._name!==e){if(this._name=e,this._sceneUBOs)for(let e=0;e<this._sceneUBOs.length;++e)this._sceneUBOs[e].name=`Scene ubo #${e} for ${this.name}`;if(this._scene)for(let e=0;e<this._renderPassIds.length;++e){const t=this._renderPassIds[e];this._engine._renderPassNames[t]=`${this._name}#${e}`;}}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}getActiveMeshes(){return this._activeMeshes}setMaterialForRendering(e,t){let i;i=Array.isArray(e)?e:[e];for(let e=0;e<i.length;++e)for(let s=0;s<this.options.numPasses;++s){let r=i[e];i[e].isAnInstance&&(r=i[e].sourceMesh),r.setMaterialForRenderPass(this._renderPassIds[s],void 0!==t?Array.isArray(t)?t[s]:t:void 0);}}_freezeActiveMeshes(e){this._freezeActiveMeshesCancel=Rt$1((()=>this._checkReadiness()),(()=>{if(this._freezeActiveMeshesCancel=null,e)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();this._prepareRenderingManager(0,true),this._isFrozen=true;}),((e,t)=>{this._freezeActiveMeshesCancel=null,t?(Ie$2.Error("ObjectRenderer: Timeout while waiting for the renderer to be ready."),e&&Ie$2.Error(e)):(Ie$2.Error("ObjectRenderer: An unexpected error occurred while waiting for the renderer to be ready."),e&&(Ie$2.Error(e),e.stack&&Ie$2.Error(e.stack)));}));}_unfreezeActiveMeshes(){this._freezeActiveMeshesCancel?.(),this._freezeActiveMeshesCancel=null;for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();this._isFrozen=false;}constructor(e,t,i){this._unObserveRenderList=null,this._renderListHasChanged=(e,t)=>{const i=this._renderList?this._renderList.length:0;if(0===t&&i>0||0===i)for(const e of this._scene.meshes)e._markSubMeshesAsLightDirty();},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=true,this.renderSprites=false,this.forceLayerMaskCheck=false,this.enableBoundingBoxRendering=false,this.enableOutlineRendering=true,this._disableImageProcessing=false,this.dontSetTransformationMatrix=false,this._disableDepthPrePass=false,this.onBeforeRenderObservable=new R$g,this.onAfterRenderObservable=new R$g,this.onBeforeRenderingManagerRenderObservable=new R$g,this.onAfterRenderingManagerRenderObservable=new R$g,this.onInitRenderingObservable=new R$g,this.onFinishRenderingObservable=new R$g,this.onFastPathRenderObservable=new R$g,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=false,this._activeMeshes=new Ii(256),this._activeBoundingBoxes=new Ii(32),this._currentFrameId=-1,this._currentSceneUBOIndex=0,this._isFrozen=false,this._freezeActiveMeshesCancel=null,this._currentSceneCamera=null,this.name=e,this._scene=t,this._engine=this._scene.getEngine(),this._useUBO=this._engine.supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._createSceneUBO()),this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:true,enableClusteredLights:false,...i},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new Un(t),this._renderingManager._useSceneAutoClearSetup=true,this.options.enableClusteredLights&&this.onInitRenderingObservable.add((()=>{for(const e of this._scene.lights)e.getTypeID()===ms.LIGHTTYPEID_CLUSTERED_CONTAINER&&e.isSupported&&e._updateBatches(this.activeCamera).render();})),this._scene.addObjectRenderer(this);}_releaseRenderPassId(){for(let e=0;e<this.options.numPasses;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds.length=0;}_createRenderPassId(){this._releaseRenderPassId();for(let e=0;e<this.options.numPasses;++e)this._renderPassIds[e]=this._engine.createRenderPassId(`${this.name}#${e}`);}_createSceneUBO(){const e=this._sceneUBOs.length;this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene ubo #${e} for ${this.name}`,false));}_getSceneUBO(){this._currentFrameId!==this._engine.frameId&&(this._currentSceneUBOIndex=0,this._currentFrameId=this._engine.frameId),this._currentSceneUBOIndex>=this._sceneUBOs.length&&this._createSceneUBO();const e=this._sceneUBOs[this._currentSceneUBOIndex++];return e.unbindEffect(),e}resetRefreshCounter(){this._currentRefreshId=-1;}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter();}shouldRender(){return  -1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,true):(this._currentRefreshId++,false)}isReadyForRendering(e,t){this.prepareRenderList(),this.initRender(e,t);const i=this._checkReadiness();return this.finishRender(),i}prepareRenderList(){const e=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let t=0;t<this._waitingRenderList.length;t++){const i=this._waitingRenderList[t],s=e.getMeshById(i);s&&this.renderList.push(s);}}this._waitingRenderList=void 0;}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const e=this._scene.meshes;for(let t=0;t<e.length;t++){const i=e[t];this.renderListPredicate(i)&&this.renderList.push(i);}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing);}initRender(e,t){const i=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,this._useUBO&&(this._currentSceneUBO=this._scene.getSceneUniformBuffer(),this._currentSceneUBO.unbindEffect(),this._scene.setSceneUniformBuffer(this._getSceneUBO())),this.onInitRenderingObservable.notifyObservers(this),i&&(this.dontSetTransformationMatrix||this._scene.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(true)),this._scene.activeCamera=i,this._engine.setViewport(i.rigParent?i.rigParent.viewport:i.viewport,e,t)),this._useUBO&&this._scene.finalizeSceneUbo(),this._defaultRenderListPrepared=false;}finishRender(){const e=this._scene;this._useUBO&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._disableImageProcessing&&(e.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),e.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==e.activeCamera&&e.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(true)),this._engine.setViewport(this._currentSceneCamera.viewport)),e.resetCachedMaterial(),this.onFinishRenderingObservable.notifyObservers(this);}render(e=0,t=false){const i=this._engine.currentRenderPassId;this._engine.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e);if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===Qe$1.SNAPSHOTRENDERING_FAST)this.onFastPathRenderObservable.notifyObservers(e);else {const t=this._prepareRenderingManager(e),i=this._scene.getOutlineRenderer?.(),s=i?.enabled;i&&(i.enabled=this.enableOutlineRendering),this.onBeforeRenderingManagerRenderObservable.notifyObservers(e),this._renderingManager.render(this.customRenderFunction,t,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(e),i&&(i.enabled=s);}t||this.onAfterRenderObservable.notifyObservers(e),this._engine.currentRenderPassId=i;}_checkReadiness(){const e=this._scene,t=this._engine.currentRenderPassId;let i=true;e.getViewMatrix()||e.updateTransformMatrix();const s=this.options.numPasses;for(let t=0;t<s&&i;t++){let r=null;const n=this.renderList?this.renderList:e.frameGraph?e.meshes:e.getActiveMeshes().data,a=this.renderList?this.renderList.length:e.frameGraph?e.meshes.length:e.getActiveMeshes().length;this._engine.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t),this.getCustomRenderList&&(r=this.getCustomRenderList(t,n,a)),r||(r=n),this.options.doNotChangeAspectRatio||e.updateTransformMatrix(true);for(let e=0;e<r.length&&i;++e){const t=r[e];if(t.isEnabled()&&!t.isBlocked&&t.isVisible&&t.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,true)){i=false;continue}}else if(!t.isReady(true)){i=false;continue}}this.onAfterRenderObservable.notifyObservers(t),s>1&&(e.incrementRenderId(),e.resetCachedMaterial());}const r=this.particleSystemList||e.particleSystems;for(const e of r)e.isReady()||(i=false);return this._engine.currentRenderPassId=t,i}_prepareRenderingManager(e=0,t=false){const i=this._scene;let s=null,r=0,n=false;const a=this.renderList?this.renderList:i.frameGraph?i.meshes:i.getActiveMeshes().data,o=this.renderList?this.renderList.length:i.frameGraph?i.meshes.length:i.getActiveMeshes().length;if(this.getCustomRenderList&&(s=this.getCustomRenderList(e,a,o)),s)r=s.length,n=this.forceLayerMaskCheck;else {if(this._defaultRenderListPrepared&&!t)return a;this._defaultRenderListPrepared=true,s=a,r=o,n=!this.renderList||this.forceLayerMaskCheck;}const h=i.activeCamera,l=this.cameraForLOD??h,c=i.getBoundingBoxRenderer?.();if(i._activeMeshesFrozen&&this._isFrozen){if(this._renderingManager.resetSprites(),this.enableBoundingBoxRendering&&c){c.reset();for(let e=0;e<this._activeBoundingBoxes.length;e++){const t=this._activeBoundingBoxes.data[e];c.renderList.push(t);}}return s}this._renderingManager.reset(),this._activeMeshes.reset(),this._activeBoundingBoxes.reset(),c&&c.reset();const u=i.getRenderId(),d=i.getFrameId();for(let e=0;e<r;e++){const t=s[e];if(t&&!t.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,false)){this.resetRefreshCounter();continue}}else if(!t.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let e,s=null;if(l){const e=t._internalAbstractMeshDataInfo._currentLOD.get(l);e&&e[1]===d?s=e[0]:(s=i.customLODSelector?i.customLODSelector(t,l):t.getLOD(l),e?(e[0]=s,e[1]=d):t._internalAbstractMeshDataInfo._currentLOD.set(l,[s,d]));}else s=t;if(!s)continue;if(s!==t&&0!==s.billboardMode&&s.computeWorldMatrix(),s._preActivateForIntermediateRendering(u),e=!(!n||!h)&&0===(t.layerMask&h.layerMask),t.isEnabled()&&t.isVisible&&t.subMeshes&&!e){if(this._activeMeshes.push(t),s._internalAbstractMeshDataInfo._wasActiveLastFrame=true,s!==t&&s._activate(u,true),this.enableBoundingBoxRendering&&c&&c._preActiveMesh(t),t._activate(u,true)&&t.subMeshes.length){t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(s=t):s._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=false,s._internalAbstractMeshDataInfo._isActiveIntermediate=true,i._prepareSkeleton(s);for(let e=0;e<s.subMeshes.length;e++){const i=s.subMeshes[e];this.enableBoundingBoxRendering&&c&&c._evaluateSubMesh(t,i),this._renderingManager.dispatch(i,s);}}t._postActivate();}}}if(this.enableBoundingBoxRendering&&c&&t)for(let e=0;e<c.renderList.length;e++){const t=c.renderList.data[e];this._activeBoundingBoxes.push(t);}if(this._scene.particlesEnabled){this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);const e=this.particleSystemList||i.particleSystems;for(let t=0;t<e.length;t++){const i=e[t],s=i.emitter;i.isStarted()&&s&&(!s.position||s.isEnabled())&&this._renderingManager.dispatchParticles(i);}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene);}return s}get renderingManager(){return this._renderingManager}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s);}setRenderingAutoClearDepthStencil(e,t,i=true,s=true){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,s),this._renderingManager._useSceneAutoClearSetup=false;}clone(){const e=new ca(this.name,this._scene,this.options);return this.renderList&&(e.renderList=this.renderList.slice(0)),e}dispose(){const e=this.renderList?this.renderList:this._scene.getActiveMeshes().data,t=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let i=0;i<t;i++){const t=e[i];t&&void 0!==t.getMaterialForRenderPass(this.renderPassId)&&t.setMaterialForRenderPass(this.renderPassId,void 0);}if(this.onInitRenderingObservable.clear(),this.onFinishRenderingObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null,this._sceneUBOs)for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=void 0,this._scene.removeObjectRenderer(this);}_rebuild(){this.refreshRate===ca.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=ca.REFRESHRATE_RENDER_ONCE);}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups();}}ca.REFRESHRATE_RENDER_ONCE=0,ca.REFRESHRATE_RENDER_ONEVERYFRAME=1,ca.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,Nt$1.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e);};class ua extends Is{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(e){this._objectRenderer.renderListPredicate=e;}get renderList(){return this._objectRenderer.renderList}set renderList(e){this._objectRenderer.renderList=e;}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(e){this._objectRenderer.particleSystemList=e;}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(e){this._objectRenderer.getCustomRenderList=e;}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(e){this._objectRenderer.renderParticles=e;}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(e){this._objectRenderer.renderSprites=e;}get enableBoundingBoxRendering(){return this._objectRenderer.enableBoundingBoxRendering}set enableBoundingBoxRendering(e){this._objectRenderer.enableBoundingBoxRendering=e;}get enableOutlineRendering(){return this._objectRenderer.enableOutlineRendering}set enableOutlineRendering(e){this._objectRenderer.enableOutlineRendering=e;}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._objectRenderer.forceLayerMaskCheck=e;}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(e){this._objectRenderer.activeCamera=e;}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(e){this._objectRenderer.cameraForLOD=e;}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(e){this._objectRenderer.disableImageProcessing=e;}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(e){this._objectRenderer.customIsReadyFunction=e;}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(e){this._objectRenderer.customRenderFunction=e;}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return !!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e);}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e);}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e);}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e);}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(e){this._objectRenderer._waitingRenderList=e;}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(e,t){this._objectRenderer.setMaterialForRendering(e,t);}get isMulti(){return this._renderTarget?.isMulti??false}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter);}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){return this._renderTarget?._depthStencilTexture??null}constructor(e,t,i,s=false,r=true,n=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,a=false,o=Is.TRILINEAR_SAMPLINGMODE,h=true,l=false,c=false,u=Qe$1.TEXTUREFORMAT_RGBA,d=false,_,f,p=false,g=false){let m,T,E=true,A=false;if("object"==typeof s){const e=s;s=!!e.generateMipMaps,r=e.doNotChangeAspectRatio??true,n=e.type??Qe$1.TEXTURETYPE_UNSIGNED_BYTE,a=!!e.isCube,o=e.samplingMode??Is.TRILINEAR_SAMPLINGMODE,h=e.generateDepthBuffer??true,l=!!e.generateStencilBuffer,c=!!e.isMulti,u=e.format??Qe$1.TEXTUREFORMAT_RGBA,d=!!e.delayAllocation,_=e.samples,f=e.creationFlags,p=!!e.noColorAttachment,g=!!e.useSRGBBuffer,m=e.colorAttachment,E=e.gammaSpace??E,T=e.existingObjectRenderer,A=!!e.enableClusteredLights;}if(super(null,i,!s,void 0,o,void 0,void 0,void 0,void 0,u),this.ignoreCameraViewport=false,this.onBeforeBindObservable=new R$g,this.onAfterUnbindObservable=new R$g,this.onClearObservable=new R$g,this.onResizeObservable=new R$g,this._cleared=false,this.skipInitialClear=false,this._samples=1,this._canRescale=true,this._renderTarget=null,this._dontDisposeObjectRenderer=false,this.boundingBoxPosition=te$4.Zero(),this._disableEngineStages=false,this._dumpToolsLoading=false,!(i=this.getScene()))return;const b=this.getScene().getEngine();this._gammaSpace=E,this._coordinatesMode=Is.PROJECTION_MODE,this.name=e,this.isRenderTarget=true,this._initialSizeParameter=t,this._dontDisposeObjectRenderer=!!T,this._processSizeParameter(t),this._objectRenderer=T??new ca(e,i,{numPasses:a?6:this.getRenderLayers()||1,doNotChangeAspectRatio:r,enableClusteredLights:A}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const e of this._scene._beforeRenderTargetClearStage)e.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(b):this.skipInitialClear||b.clear(this.clearColor||this._scene.clearColor,true,true,true),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(true),!this._disableEngineStages)for(const e of this._scene._beforeRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer);})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const e of this._scene._afterRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer);const e=this._texture?.generateMipMaps??false;if(this._texture&&(this._texture.generateMipMaps=false),this._postProcessManager?this._postProcessManager._finalizeFrame(false,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(false,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const e of this._scene._afterRenderTargetPostProcessStage)e.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=e),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(true),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),b):Ie$2.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"));})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(b):this.skipInitialClear||b.clear(this.clearColor||this._scene.clearColor,true,true,true);})),this._resizeObserver=b.onResizeObservable.add((()=>{})),this._generateMipMaps=!!s,this._doNotChangeAspectRatio=r,c||(this._renderTargetOptions={generateMipMaps:s,type:n,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:h,generateStencilBuffer:l,samples:_,creationFlags:f,noColorAttachment:p,useSRGBBuffer:g,colorAttachment:m,label:this.name},this.samplingMode===Is.NEAREST_SAMPLINGMODE&&(this.wrapU=Is.CLAMP_ADDRESSMODE,this.wrapV=Is.CLAMP_ADDRESSMODE),d||(a?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=Is.INVCUBIC_MODE,this._textureMatrix=re$5.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==_&&(this.samples=_)));}createDepthStencilTexture(e=0,t=true,i=false,s=1,r=Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT,n){this._renderTarget?.createDepthStencilTexture(e,t,i,s,r,n);}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)};}else this._size=e;}get samples(){return this._renderTarget?.samples??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e));}addPostProcess(e){if(!this._postProcessManager){const e=this.getScene();if(!e)return;this._postProcessManager=new Rn(e),this._postProcesses=new Array;}this._postProcesses.push(e),this._postProcesses[0].autoClear=false;}clearPostProcesses(e=false){if(this._postProcesses){if(e)for(const e of this._postProcesses)e.dispose();this._postProcesses=[];}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=false));}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter();}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(e){this._objectRenderer.refreshRate=e;}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;if(e)return e;const t=this._size.depth;return t||0}disableRescaling(){this._canRescale=false;}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t);}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){const t=this.isCube;this._renderTarget?.dispose(),this._renderTarget=null;const i=this.getScene();i&&(this._processSizeParameter(e),this._renderTarget=t?i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this));}render(e=false,t=false){this._render(e,t);}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=true,Promise.resolve().then(function(){return dumpToolsXlmyKCb1_esm_min}).then((e=>this._dumpTools=e))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}_render(e=false,t=false){const i=this.getScene();if(i){if(void 0!==this.useCameraPostProcesses&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let s=0;s<6;s++)this._renderToTarget(s,e,t),i.incrementRenderId(),i.resetCachedMaterial();else this._renderToTarget(0,e,t);else for(let s=0;s<this.getRenderLayers();s++)this._renderToTarget(0,e,t,s),i.incrementRenderId(),i.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender();}}_bestReflectionRenderTargetDimension(e,t){const i=e*t,s=gi(i+16384/(128+i));return Math.min(Ti(e),s)}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const s=i.getEngine();this._renderTarget&&s.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t);}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t);}));}_prepareFrame(e,t,i,s){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(t,i):s&&e.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(t,i);}_renderToTarget(e,t,i,s=0){const r=this.getScene();if(!r)return;const n=r.getEngine();this._currentFaceIndex=e,this._currentLayer=s,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=i,this._prepareFrame(r,e,s,t),n._debugPushGroup?.(`render to face #${e} layer #${s}`,2),this._objectRenderer.render(e+s,true),n._debugPopGroup?.(2),this._unbindFrameBuffer(n,e),this._texture&&this.isCube&&5===e&&n.generateMipMapsForCubemap(this._texture,true);}setRenderingOrder(e,t=null,i=null,s=null){this._objectRenderer.setRenderingOrder(e,t,i,s);}setRenderingAutoClearDepthStencil(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t);}clone(){const e=this.getSize(),t=new ua(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){this._renderTarget?.dispose(true);}releaseInternalTexture(){this._renderTarget?.releaseTextures(),this._texture=null;}dispose(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(true),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(const i of e.cameras)t=i.customRenderTargets.indexOf(this),t>=0&&i.customRenderTargets.splice(t,1);this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,super.dispose();}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild();}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups();}getViewCount(){return 1}}ua.REFRESHRATE_RENDER_ONCE=ca.REFRESHRATE_RENDER_ONCE,ua.REFRESHRATE_RENDER_ONEVERYFRAME=ca.REFRESHRATE_RENDER_ONEVERYFRAME,ua.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=ca.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,Is._CreateRenderTargetTexture=(e,t,i,s,r)=>new ua(e,t,i,s);var da=Object.freeze({__proto__:null,RenderTargetTexture:ua});const _a="postprocessVertexShader",fa="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStore[_a]||(bt$1.ShadersStore[_a]=fa);const pa={name:_a,shader:fa};var ga=Object.freeze({__proto__:null,postprocessVertexShader:pa});const ma={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class Ta{constructor(e,t=ma){this._fullscreenViewport=new vi(0,0,1,1);const i=t.positions??ma.positions,s=t.indices??ma.indices;this.engine=e,this._vertexBuffers={[Hi.PositionKind]:new Hi(e,i,Hi.PositionKind,false,false,2)},this._indexBuffer=e.createIndexBuffer(s),this._indexBufferLength=s.length,this._onContextRestoredObserver=e.onContextRestoredObservable.add((()=>{this._indexBuffer=e.createIndexBuffer(s);for(const e in this._vertexBuffers){this._vertexBuffers[e]._rebuild();}}));}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e);}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e);}applyEffectWrapper(e,t=false,i=false){this.engine.setState(true),this.engine.depthCullingState.depthTest=t,this.engine.stencilState.stencilTest=i,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({});}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest;}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest;}draw(){this.engine.drawElementsType(Qe$1.MATERIAL_TriangleFillMode,0,this._indexBufferLength);}_isRenderTargetTexture(e){return void 0!==e.renderTarget}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const i=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates();}dispose(){const e=this._vertexBuffers[Hi.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[Hi.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null);}}class Ea{static RegisterShaderCodeProcessing(e,t){t?Ea._CustomShaderCodeProcessing[e??""]=t:delete Ea._CustomShaderCodeProcessing[e??""];}static _GetShaderCodeProcessing(e){return Ea._CustomShaderCodeProcessing[e]??Ea._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(e){this.options.name=e;}isReady(){return this._drawWrapper.effect?.isReady()??false}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e;}constructor(e){this.alphaMode=Qe$1.ALPHA_DISABLE,this.onEffectCreatedObservable=new R$g(void 0,true),this.onApplyObservable=new R$g,this._shadersLoaded=false,this._webGPUReady=false,this._importPromises=[],this.options={...e,name:e.name||"effectWrapper",engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||["position"],uniformBuffers:e.uniformBuffers||[],defines:e.defines||"",useShaderStore:e.useShaderStore||false,vertexUrl:e.vertexUrl||e.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:e.fragmentShader||"pass",indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||false,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:e.useAsPostProcess??false,allowEmptySourceTexture:e.allowEmptySourceTexture??false},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(this.options.allowEmptySourceTexture||-1!==this.options.samplers.indexOf("textureSampler")||this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1);}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind();})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect();}))),this._drawWrapper=new $i(this.options.engine),this._webGPUReady=1===this.options.shaderLanguage;const t=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,t,this.options.extraInitializations);}_gatherImports(e=false,t){this.options.useAsPostProcess&&(e&&this._webGPUReady?t.push(Promise.all([Promise.resolve().then(function(){return postprocess_vertexBOHFNm19_esm_min})])):t.push(Promise.all([Promise.resolve().then((function(){return ga}))])));}_postConstructor(e,t=null,i,s){this._importPromises.length=0,s&&this._importPromises.push(...s);const r=this.options.engine.isWebGPU&&!Ea.ForceGLSL;this._gatherImports(r,this._importPromises),void 0!==i&&i(r,this._importPromises),r&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t);}updateEffect(e=null,t=null,i=null,s,r,n,a,o){const h=Ea._GetShaderCodeProcessing(this.name);if(h?.defineCustomBindings){const s=t?.slice()??[];s.push(...this.options.uniforms);const r=i?.slice()??[];r.push(...this.options.samplers),e=h.defineCustomBindings(this.name,e,s,r),t=s,i=r;}this.options.defines=e||"";const l=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=true;};let c;c=this.options.extraInitializationsAsync?async()=>{l?.(),await this.options.extraInitializationsAsync();}:l,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:a??this._shaderPath.vertex,fragment:o??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:t||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:i||this.options.samplers,defines:null!==e?e:"",fallbacks:null,onCompiled:r??this.options.onCompiled,onError:n??null,indexParameters:s||this.options.indexParameters,processCodeAfterIncludes:h?.processCodeAfterIncludes?(e,t)=>h.processCodeAfterIncludes(this.name,e,t):null,processFinalCode:h?.processFinalCode?(e,t)=>h.processFinalCode(this.name,e,t):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:c},this.options.engine):this._drawWrapper.effect=new Nt$1(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,i||this.options.samplerNames,this.options.engine,e,void 0,r||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,c),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect);}bind(e=false){this.options.useAsPostProcess&&!e&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),Ea._GetShaderCodeProcessing(this.name)?.bindCustomBindings?.(this.name,this._drawWrapper.effect);}dispose(e=false){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(true);}}Ea.ForceGLSL=false,Ea._CustomShaderCodeProcessing={},jt.prototype.setTextureFromPostProcess=function(e,t,i){let s=null;t&&(t._forcedOutputTexture?s=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(s=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,s?.texture??null,i);},jt.prototype.setTextureFromPostProcessOutput=function(e,t,i){this._bindTexture(e,t?._outputTexture?.texture??null,i);},Nt$1.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e);},Nt$1.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e);};class Aa{static get ForceGLSL(){return Ea.ForceGLSL}static set ForceGLSL(e){Ea.ForceGLSL=e;}static RegisterShaderCodeProcessing(e,t){Ea.RegisterShaderCodeProcessing(e,t);}get name(){return this._effectWrapper.name}set name(e){this._effectWrapper.name=e;}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(e){this._effectWrapper.alphaMode=e;}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach((e=>{e.setSamples(this._samples);}));}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e));}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e);}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e);}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e);}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e);}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e;}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty());}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,s,r,n,a=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,o,h,l=null,c=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,u="postprocess",d,_=false,f=Qe$1.TEXTUREFORMAT_RGBA,p,g){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=true,this.forceAutoClearInAlphaMode=false,this.animations=[],this.enablePixelPerfectMode=false,this.forceFullscreenViewport=true,this.scaleMode=Qe$1.SCALEMODE_FLOOR,this.alwaysForcePOT=false,this._samples=1,this.adaptScaleToCurrentViewport=false,this._webGPUReady=false,this._reusable=false,this._renderId=0,this.externalTextureSamplerBinding=false,this._textures=new Ii(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new ee$4(1,1),this._texelSize=ee$4.Zero(),this.onActivateObservable=new R$g,this.onSizeChangedObservable=new R$g,this.onApplyObservable=new R$g,this.onBeforeRenderObservable=new R$g,this.onAfterRenderObservable=new R$g,this.onDisposeObservable=new R$g;let m,T=1,E=null;if(i&&!Array.isArray(i)){const e=i;i=e.uniforms??null,s=e.samplers??null,T=e.size??1,n=e.camera??null,a=e.samplingMode??Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,o=e.engine,h=e.reusable,l=Array.isArray(e.defines)?e.defines.join("\n"):e.defines??null,c=e.textureType??Qe$1.TEXTURETYPE_UNSIGNED_BYTE,u=e.vertexUrl??"postprocess",d=e.indexParameters,_=e.blockCompilation??false,f=e.textureFormat??Qe$1.TEXTUREFORMAT_RGBA,p=e.shaderLanguage??0,E=e.uniformBuffers??null,g=e.extraInitializations,m=e.effectWrapper;}else r&&(T="number"==typeof r?r:{width:r.width,height:r.height});if(this._useExistingThinPostProcess=!!m,this._effectWrapper=m??new Ea({name:e,useShaderStore:true,useAsPostProcess:true,fragmentShader:t,engine:o||n?.getScene().getEngine(),uniforms:i,samplers:s,uniformBuffers:E,defines:l,vertexUrl:u,indexParameters:d,blockCompilation:true,shaderLanguage:p,extraInitializations:void 0}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=n?(this._camera=n,this._scene=n.getScene(),n.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.addPostProcess(this),this.uniqueId=this._scene.getUniqueId()):o&&(this._engine=o,this._engine.postProcesses.push(this)),this._options=T,this.renderTargetSamplingMode=a||Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,this._reusable=h||false,this._textureType=c,this._textureFormat=f,this._shaderLanguage=p||0,this._samplers=s||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=u,this._parameters=i||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=E||[],this._indexParameters=d,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const e=[];this._gatherImports(this._engine.isWebGPU&&!Aa.ForceGLSL,e),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(_,l,g,e);}}_gatherImports(e=false,t){e&&this._webGPUReady?t.push(Promise.all([Promise.resolve().then(function(){return postprocess_vertexBOHFNm19_esm_min})])):t.push(Promise.all([Promise.resolve().then((function(){return ga}))]));}getClassName(){return "PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){0==this._textures.length&&(this._textures=new Ii(2)),this._shareOutputWithPostProcess=null;}updateEffect(e=null,t=null,i=null,s,r,n,a,o){this._effectWrapper.updateEffect(e,t,i,s,r,n,a,o),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines;}isReusable(){return this._reusable}markTextureDirty(){this.width=-1;}_createRenderTargetTexture(e,t,i=0){for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture.width===e.width&&this._textureCache[s].texture.height===e.height&&this._textureCache[s].postProcessChannel===i&&this._textureCache[s].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[s].texture.samples===t.samples)return this._textureCache[s].texture;const s=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:s,postProcessChannel:i,lastUsedRenderId:-1}),s}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let e=false;for(let i=0;i<this._textures.length;i++)if(this._textures.data[i]===this._textureCache[t].texture){e=true;break}e||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1));}}resize(e,t,i=null,s=false,r=false){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;if(i)for(let e=0;e<i._postProcesses.length;e++)if(null!==i._postProcesses[e]){n=i._postProcesses[e];break}const a={width:this.width,height:this.height},o={generateMipMaps:s,generateDepthBuffer:r||n===this,generateStencilBuffer:(r||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(a,o,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,o,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this);}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else {let t;e=this.inputTexture;for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture===e){t=this._textureCache[i];break}t&&(t.lastUsedRenderId=this._renderId);}return e}activate(e,t=null,i){const s=null===e||void 0!==e.cameraRigMode?e||this._camera:null,r=s?.getScene()??e,n=r.getEngine(),a=n.getCaps().maxTextureSize,o=(t?t.width:this._engine.getRenderWidth(true))*this._options|0,h=(t?t.height:this._engine.getRenderHeight(true))*this._options|0;let l=this._options.width||o,c=this._options.height||h;const u=this.renderTargetSamplingMode!==Qe$1.TEXTURE_NEAREST_LINEAR&&this.renderTargetSamplingMode!==Qe$1.TEXTURE_NEAREST_NEAREST&&this.renderTargetSamplingMode!==Qe$1.TEXTURE_LINEAR_LINEAR;let d=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const e=n.currentViewport;e&&(l*=e.width,c*=e.height);}(u||this.alwaysForcePOT)&&(this._options.width||(l=n.needPOTTextures?Ei(l,a,this.scaleMode):l),this._options.height||(c=n.needPOTTextures?Ei(c,a,this.scaleMode):c)),this.width===l&&this.height===c&&(d=this._getTarget())||this.resize(l,c,s,u,i),this._textures.forEach((e=>{e.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(e,this.samples);})),this._flushTextureCache(),this._renderId++;}return d||(d=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(o/l,h/c),this._engine.bindFramebuffer(d,0,o,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(d,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker?.(`post process ${this.name} input`),this.onActivateObservable.notifyObservers(s),this.autoClear&&(this.alphaMode===Qe$1.ALPHA_DISABLE||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:r.clearColor,r._allowPostProcessClearColor,true,true),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),d}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let e;return this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(false),this._engine.setDepthBuffer(false),this._engine.setDepthWrite(false),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),e=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",e?.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(true),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose());}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0;}setPrePassRenderer(e){return !!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=true,true)}dispose(e){let t;if(e=e||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(t=this._scene.removePostProcess(this)),this._parentContainer){const e=this._parentContainer.postProcesses.indexOf(this);e>-1&&this._parentContainer.postProcesses.splice(e,1),this._parentContainer=null;}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),this.onDisposeObservable.notifyObservers(),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const e=this._camera._getFirstPostProcess();e&&e.markTextureDirty();}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear();}}serialize(){const e=Ae$3.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=Aa.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const s=O$g(e.customType);if(!s||!s._Parse)return null;const r=t?t.getCameraById(e.cameraId):null;return s._Parse(e,r,t,i)}static _Parse(e,t,i,s){return Ae$3.Parse((()=>new Aa(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,false,e.textureFormat)),e,i,s)}}e$z([a$$()],Aa.prototype,"uniqueId",void 0),e$z([a$$()],Aa.prototype,"name",null),e$z([a$$()],Aa.prototype,"width",void 0),e$z([a$$()],Aa.prototype,"height",void 0),e$z([a$$()],Aa.prototype,"renderTargetSamplingMode",void 0),e$z([_$j()],Aa.prototype,"clearColor",void 0),e$z([a$$()],Aa.prototype,"autoClear",void 0),e$z([a$$()],Aa.prototype,"forceAutoClearInAlphaMode",void 0),e$z([a$$()],Aa.prototype,"alphaMode",null),e$z([a$$()],Aa.prototype,"alphaConstants",void 0),e$z([a$$()],Aa.prototype,"enablePixelPerfectMode",void 0),e$z([a$$()],Aa.prototype,"forceFullscreenViewport",void 0),e$z([a$$()],Aa.prototype,"scaleMode",void 0),e$z([a$$()],Aa.prototype,"alwaysForcePOT",void 0),e$z([a$$("samples")],Aa.prototype,"_samples",void 0),e$z([a$$()],Aa.prototype,"adaptScaleToCurrentViewport",void 0),P$9("BABYLON.PostProcess",Aa);class Ra{constructor(){this.shaderLanguage=0;}postProcessor(e,t,i,s,r){if(r.drawBuffersExtensionDisabled){const t=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(t,"");}return e}}const ba=/(flat\s)?\s*varying\s*.*/;class Sa{constructor(){this.shaderLanguage=0;}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return ba.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const s=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const i=-1!==e.search(/layout *\(location *= *0\) *out/g),r=-1!==t.indexOf("#define DUAL_SOURCE_BLENDING"),n=r?"layout(location = 0, index = 0) out vec4 glFragColor;\nlayout(location = 0, index = 1) out vec4 glFragColor2;\n":"layout(location = 0) out vec4 glFragColor;\n";r&&(e="#extension GL_EXT_blend_func_extended : require\n"+e),e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(s||i?"":n)+"void main(");}else {t.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0&&(e="invariant gl_Position;\n"+e);if(-1!==t.indexOf("#define MULTIVIEW"))return "#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e}return e}}class xa extends Li{constructor(e){super(),this._buffer=e;}get underlyingResource(){return this._buffer}}class Ma{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&!(e=t.createTexture()))throw new Error("Unable to create webGL texture");this.set(e);}setUsage(){}set(e){this._webGLTexture=e;}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null;}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e);}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null;}}getMSAARenderBuffer(e=0){return this._MSAARenderBuffers?.[e]??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset();}}function ya(e){return e===Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8||e===Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT||e===Qe$1.TEXTUREFORMAT_DEPTH16||e===Qe$1.TEXTUREFORMAT_DEPTH24||e===Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8||e===Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8||e===Qe$1.TEXTUREFORMAT_STENCIL8}function Ia(e){switch(e){case Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:case Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8:case Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8:case Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT:case Qe$1.TEXTUREFORMAT_DEPTH24:return Qe$1.TEXTURETYPE_FLOAT;case Qe$1.TEXTUREFORMAT_DEPTH16:return Qe$1.TEXTURETYPE_UNSIGNED_SHORT;case Qe$1.TEXTUREFORMAT_STENCIL8:return Qe$1.TEXTURETYPE_UNSIGNED_BYTE}return Qe$1.TEXTURETYPE_UNSIGNED_BYTE}function Ca(e){return e===Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8||e===Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8||e===Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8||e===Qe$1.TEXTUREFORMAT_STENCIL8}class va{}class Pa extends jt{get name(){return this._name}set name(e){this._name=e;}get version(){return this._webGLVersion}static get ShadersRepository(){return Nt$1.ShadersRepository}static set ShadersRepository(e){Nt$1.ShadersRepository=e;}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return  false}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e;}snapshotRenderingReset(){this.snapshotRendering=false;}constructor(e,t,i,s){if(i=i||{},super(t??i.antialias,i,s),this._name="WebGL",this.forcePOTTextures=false,this.validateShaderPrograms=false,this.disableUniformBuffers=false,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=false,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=false,this._mustWipeVertexAttributes=false,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=true,this._boundUniforms={},!e)return;let r=null;if(e.getContext){if(r=e,void 0===i.preserveDrawingBuffer&&(i.preserveDrawingBuffer=false),void 0===i.xrCompatible&&(i.xrCompatible=false),navigator&&navigator.userAgent){this._setupMobileChecks();const e=navigator.userAgent;for(const t of Pa.ExceptionList){const s=t.key,r=t.targets;if(new RegExp(s).test(e)){if(t.capture&&t.captureConstraint){const i=t.capture,s=t.captureConstraint,r=new RegExp(i).exec(e);if(r&&r.length>0){if(parseInt(r[r.length-1])>=s)continue}}for(const e of r)switch(e){case "uniformBuffer":this.disableUniformBuffers=true;break;case "vao":this.disableVertexArrayObjects=true;break;case "antialias":i.antialias=false;break;case "maxMSAASamples":this._maxMSAASamplesOverride=1;}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{It$1(this._gl);}:(this._onContextLost=e=>{e.preventDefault(),this._contextWasLost=true,It$1(this._gl),Ie$2.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this);},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()));},r.addEventListener("webglcontextrestored",this._onContextRestored,false),i.powerPreference=i.powerPreference||"high-performance"),r.addEventListener("webglcontextlost",this._onContextLost,false),this._badDesktopOS&&(i.xrCompatible=false),!i.disableWebGL2Support)try{this._gl=r.getContext("webgl2",i)||r.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"));}catch(e){}if(!this._gl){if(!r)throw new Error("The provided canvas is null or undefined.");try{this._gl=r.getContext("webgl",i)||r.getContext("experimental-webgl",i);}catch(e){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else {this._gl=e,r=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const t=this._gl.getContextAttributes();t&&(i.stencil=t.stencil);}this._sharedInit(r),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==i.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let e=0;e<this._caps.maxVertexAttribs;e++)this._currentBufferPointers[e]=new va;this._shaderProcessor=this.webGLVersion>1?new Sa:new Ra;const n=`Babylon.js v${Pa.Version}`;Ie$2.Log(n+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",n);const a=yt$1(this._gl);a.validateShaderPrograms=this.validateShaderPrograms,a.parallelShaderCompile=this._caps.parallelShaderCompile;}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources();}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(const e in this._compiledEffects){if(!this._compiledEffects[e].isReady())return  false}return  true}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),shaderFloatPrecision:0,parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:false,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:false,drawBuffersExtension:false,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),blendFloat:null!==this._gl.getExtension("EXT_float_blend"),supportFloatTexturesResolve:false,rg11b10ufColorRenderable:false,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:false,textureFloatLinearFiltering:false,textureFloatRender:false,textureHalfFloatLinearFiltering:false,vertexArrayObject:false,instancedArrays:false,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:false,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:false,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:false,supportSRGBBuffers:false,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:false,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16"),blendParametersPerTarget:false,dualSourceBlending:false},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const e=this._gl.getExtension("WEBGL_debug_renderer_info");null!=e&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763);const t=this._gl.getExtension("OES_draw_buffers_indexed");if(this._caps.blendParametersPerTarget=!!t,this._alphaState=new Gt$1(this._caps.blendParametersPerTarget),t&&(this._gl.blendEquationSeparateIndexed=t.blendEquationSeparateiOES.bind(t),this._gl.blendEquationIndexed=t.blendEquationiOES.bind(t),this._gl.blendFuncSeparateIndexed=t.blendFuncSeparateiOES.bind(t),this._gl.blendFuncIndexed=t.blendFunciOES.bind(t),this._gl.colorMaskIndexed=t.colorMaskiOES.bind(t),this._gl.disableIndexed=t.disableiOES.bind(t),this._gl.enableIndexed=t.enableiOES.bind(t)),this._caps.dualSourceBlending=!!this._gl.getExtension("WEBGL_blend_func_extended"),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=true,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else {const e=this._gl.getExtension("WEBGL_draw_buffers");if(null!==e){this._caps.drawBuffersExtension=true,this._gl.drawBuffers=e.drawBuffersWEBGL.bind(e),this._caps.maxDrawBuffers=this._gl.getParameter(e.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let t=0;t<16;t++)this._gl["COLOR_ATTACHMENT"+t+"_WEBGL"]=e["COLOR_ATTACHMENT"+t+"_WEBGL"];}}if(this._webGLVersion>1)this._caps.depthTextureExtension=true;else {const e=this._gl.getExtension("WEBGL_depth_texture");null!=e&&(this._caps.depthTextureExtension=true,this._gl.UNSIGNED_INT_24_8=e.UNSIGNED_INT_24_8_WEBGL);}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=false;else if(this._webGLVersion>1)this._caps.vertexArrayObject=true;else {const e=this._gl.getExtension("OES_vertex_array_object");null!=e&&(this._caps.vertexArrayObject=true,this._gl.createVertexArray=e.createVertexArrayOES.bind(e),this._gl.bindVertexArray=e.bindVertexArrayOES.bind(e),this._gl.deleteVertexArray=e.deleteVertexArrayOES.bind(e));}if(this._webGLVersion>1)this._caps.instancedArrays=true;else {const e=this._gl.getExtension("ANGLE_instanced_arrays");null!=e?(this._caps.instancedArrays=true,this._gl.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),this._gl.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),this._gl.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)):this._caps.instancedArrays=false;}if(this._gl.getShaderPrecisionFormat){const e=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),t=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);if(e&&t&&(this._caps.highPrecisionShaderSupported=0!==e.precision&&0!==t.precision,this._caps.shaderFloatPrecision=Math.min(e.precision,t.precision)),!this._shouldUseHighPrecisionShader){const e=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.MEDIUM_FLOAT),t=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.MEDIUM_FLOAT);e&&t&&(this._caps.shaderFloatPrecision=Math.min(e.precision,t.precision));}this._caps.shaderFloatPrecision<10&&(this._caps.shaderFloatPrecision=10);}if(this._webGLVersion>1)this._caps.blendMinMax=true;else {const e=this._gl.getExtension("EXT_blend_minmax");null!=e&&(this._caps.blendMinMax=true,this._gl.MAX=e.MAX_EXT,this._gl.MIN=e.MIN_EXT);}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=true,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else {const e=this._gl.getExtension("EXT_sRGB");null!=e&&(this._caps.supportSRGBBuffers=true,this._glSRGBExtensionValues={SRGB:e.SRGB_EXT,SRGB8:e.SRGB_ALPHA_EXT,SRGB8_ALPHA8:e.SRGB_ALPHA_EXT});}if(this._creationOptions){const e=this._creationOptions.forceSRGBBufferSupportState;void 0!==e&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&e);}}this._depthCullingState.depthTest=true,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=true,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let e=0;e<this._maxSimultaneousTextures;e++)this._nextFreeTextureSlots.push(e);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=true);}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"==typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:false,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:false,checkUbosContentBeforeUpload:false,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:true,needsInvertingBitmap:true,useUBOBindingCache:true,needShaderCodeInlining:false,needToAlwaysBindUniformBuffers:false,supportRenderPasses:false,supportSpriteInstancing:true,forceVertexBufferStrideAndOffsetMultiple4Bytes:false,_checkNonFloatVertexBuffersDontRecreatePipelineContext:false,_collectUbosUpdatedInFrame:false};}get webGLVersion(){return this._webGLVersion}getClassName(){return "ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e);}getInfo(){return this.getGlInfo()}getGlInfo(){return {vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=false){return !e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=false){return !e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,i,s=false,r=0){const n=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=true,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=n;let a=0;if(t&&e){let t=true;if(this._currentRenderTarget){const i=this._currentRenderTarget.texture?.format;if(i===Qe$1.TEXTUREFORMAT_RED_INTEGER||i===Qe$1.TEXTUREFORMAT_RG_INTEGER||i===Qe$1.TEXTUREFORMAT_RGB_INTEGER||i===Qe$1.TEXTUREFORMAT_RGBA_INTEGER){const i=this._currentRenderTarget.texture?.type;i===Qe$1.TEXTURETYPE_UNSIGNED_INTEGER||i===Qe$1.TEXTURETYPE_UNSIGNED_SHORT?(Pa._TempClearColorUint32[0]=255*e.r,Pa._TempClearColorUint32[1]=255*e.g,Pa._TempClearColorUint32[2]=255*e.b,Pa._TempClearColorUint32[3]=255*e.a,this._gl.clearBufferuiv(this._gl.COLOR,0,Pa._TempClearColorUint32),t=false):(Pa._TempClearColorInt32[0]=255*e.r,Pa._TempClearColorInt32[1]=255*e.g,Pa._TempClearColorInt32[2]=255*e.b,Pa._TempClearColorInt32[3]=255*e.a,this._gl.clearBufferiv(this._gl.COLOR,0,Pa._TempClearColorInt32),t=false);}}t&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),a|=this._gl.COLOR_BUFFER_BIT);}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),a|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(r),a|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(a);}_viewport(e,t,i,s){e===this._viewportCached.x&&t===this._viewportCached.y&&i===this._viewportCached.z&&s===this._viewportCached.w||(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=s,this._gl.viewport(e,t,i,s));}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer();}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,i,s,r,n=0,a=0){const o=e;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(o._framebuffer);const h=this._gl;e.isMulti||(e.is2DArray||e.is3D?(h.framebufferTextureLayer(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,e.texture._hardwareTexture?.underlyingResource,n,a),o._currentLOD=n):e.isCube?h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_CUBE_MAP_POSITIVE_X+t,e.texture._hardwareTexture?.underlyingResource,n):o._currentLOD!==n&&(h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,e.texture._hardwareTexture?.underlyingResource,n),o._currentLOD=n));const l=e._depthStencilTexture;if(l){e.is3D&&(e.texture.width===l.width&&e.texture.height===l.height&&e.texture.depth===l.depth||Ie$2.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const i=e._depthStencilTextureWithStencil?h.DEPTH_STENCIL_ATTACHMENT:h.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?h.framebufferTextureLayer(h.FRAMEBUFFER,i,l._hardwareTexture?.underlyingResource,n,a):e.isCube?h.framebufferTexture2D(h.FRAMEBUFFER,i,h.TEXTURE_CUBE_MAP_POSITIVE_X+t,l._hardwareTexture?.underlyingResource,n):h.framebufferTexture2D(h.FRAMEBUFFER,i,h.TEXTURE_2D,l._hardwareTexture?.underlyingResource,n);}o._MSAAFramebuffer&&this._bindUnboundFramebuffer(o._MSAAFramebuffer),this._cachedViewport&&!r?this.setViewport(this._cachedViewport,i,s):(i||(i=e.width,n&&(i/=Math.pow(2,n))),s||(s=e.height,n&&(s/=Math.pow(2,n))),this._viewport(0,0,i,s)),this.wipeCaches();}setStateCullFaceType(e,t){const i=this.cullBackFaces??e??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==i||t)&&(this._depthCullingState.cullFace=i);}setState(e,t=0,i,s=false,r,n,a=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(r,i),this.setZOffset(t),this.setZOffsetUnits(a);const o=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==o||i)&&(this._depthCullingState.frontFace=o),this._stencilStateComposer.stencilMaterial=n;}_resolveAndGenerateMipMapsFramebuffer(e,t=false){e.disableAutomaticMSAAResolve||(e.isMulti?this.resolveMultiFramebuffer(e):this.resolveFramebuffer(e)),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e));}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e);}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(e){const t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,true),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null);}unBindFramebuffer(e,t,i){const s=e;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(e,t),i&&(s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._framebuffer),i()),this._bindUnboundFramebuffer(null);}generateMipMapsFramebuffer(e){e.isMulti||!e.texture?.generateMipMaps||e.isCube||this.generateMipmaps(e.texture);}resolveFramebuffer(e){const t=e,i=this._gl;if(!t._MSAAFramebuffer||t.isMulti)return;let s=t.resolveMSAAColors?i.COLOR_BUFFER_BIT:0;s|=t._generateDepthBuffer&&t.resolveMSAADepth?i.DEPTH_BUFFER_BIT:0,s|=t._generateStencilBuffer&&t.resolveMSAAStencil?i.STENCIL_BUFFER_BIT:0,i.bindFramebuffer(i.READ_FRAMEBUFFER,t._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),i.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s,i.NEAREST);}flushFramebuffer(){this._gl.flush();}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches();}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null;}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const s=new xa(i);return this.bindArrayBuffer(s),"number"!=typeof e?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),s.capacity=4*e.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),s.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),s.capacity=e),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null;}createIndexBuffer(e,t,i){const s=this._gl.createBuffer(),r=new xa(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);const n=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=4===n.BYTES_PER_ELEMENT,r}_normalizeIndexData(e){if(2===e.BYTES_PER_ELEMENT)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER);}bindUniformBlock(e,t,i){const s=e.program,r=this._gl.getUniformBlockIndex(s,t);this._gl.uniformBlockBinding(s,r,i);}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER);}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e);}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e);}_vertexAttribPointer(e,t,i,s,r,n,a){const o=this._currentBufferPointers[t];if(!o)return;let h=false;o.active?(o.buffer!==e&&(o.buffer=e,h=true),o.size!==i&&(o.size=i,h=true),o.type!==s&&(o.type=s,h=true),o.normalized!==r&&(o.normalized=r,h=true),o.stride!==n&&(o.stride=n,h=true),o.offset!==a&&(o.offset=a,h=true)):(h=true,o.active=true,o.index=t,o.size=i,o.type=s,o.normalized=r,o.stride=n,o.offset=a,o.buffer=e),(h||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(t,i,s,n,a):this._gl.vertexAttribPointer(t,i,s,r,n,a));}_bindIndexBufferWithCache(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits);}_bindVertexBuffersAttributes(e,t,i){const s=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let r=0;r<s.length;r++){const n=t.getAttributeLocation(r);if(n>=0){const t=s[r];let a=null;if(i&&(a=i[t]),a||(a=e[t]),!a)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=true);const o=a.getBuffer();o&&(this._vertexAttribPointer(o,n,a.getSize(),a.type,a.normalized,a.byteStride,a.byteOffset),a.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,a.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(o))));}}}recordVertexArrayObject(e,t,i,s){const r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=true,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=true,this._bindVertexBuffersAttributes(e,i,s),this.bindIndexBuffer(t),this._vaoRecordInProgress=false,this._gl.bindVertexArray(null),r}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=true);}bindBuffersDirectly(e,t,i,s,r){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r;const t=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let n=0;for(let a=0;a<t;a++)if(a<i.length){const t=r.getAttributeLocation(a);t>=0&&(this._gl.enableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=true,this._vertexAttribPointer(e,t,i[a],this._gl.FLOAT,false,s,n)),n+=4*i[a];}}this._bindIndexBufferWithCache(t);}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null));}bindBuffers(e,t,i,s){this._cachedVertexBuffers===e&&this._cachedEffectForVertexBuffers===i||(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,s)),this._bindIndexBufferWithCache(t);}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const i=this._currentInstanceBuffers[t];e!=i&&i.references&&(e=i,this.bindArrayBuffer(i));const s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0);}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0;}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e);}_releaseBuffer(e){return e.references--,0===e.references&&(this._deleteBuffer(e),true)}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource);}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==i[0].index)this.bindInstancesBuffer(e,i,true);else for(let t=0;t<4;t++){const s=i[t];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=true),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,false,64,16*t),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e);}}bindInstancesBuffer(e,t,i=true){this.bindArrayBuffer(e);let s=0;if(i)for(let e=0;e<t.length;e++){s+=4*t[e].attributeSize;}for(let i=0;i<t.length;i++){const r=t[i];void 0===r.index&&(r.index=this._currentEffect.getAttributeLocationByName(r.attributeName)),r.index<0||(this._vertexAttribArraysEnabled[r.index]||(this._gl.enableVertexAttribArray(r.index),this._vertexAttribArraysEnabled[r.index]=true),this._vertexAttribPointer(e,r.index,r.attributeSize,r.attributeType||this._gl.FLOAT,r.normalized||false,s,r.offset),this._gl.vertexAttribDivisor(r.index,void 0===r.divisor?1:r.divisor),this._currentInstanceLocations.push(r.index),this._currentInstanceBuffers.push(e));}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t);}disableInstanceAttribute(e){let t,i=false;for(;-1!==(t=this._currentInstanceLocations.indexOf(e));)this._currentInstanceLocations.splice(t,1),this._currentInstanceBuffers.splice(t,1),i=true,t=this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e));}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=false,this._currentBufferPointers[e].active=false;}draw(e,t,i,s){this.drawElementsType(e?Qe$1.MATERIAL_TriangleFillMode:Qe$1.MATERIAL_WireFrameFillMode,t,i,s);}drawPointClouds(e,t,i){this.drawArraysType(Qe$1.MATERIAL_PointFillMode,e,t,i);}drawUnIndexed(e,t,i,s){this.drawArraysType(e?Qe$1.MATERIAL_TriangleFillMode:Qe$1.MATERIAL_WireFrameFillMode,t,i,s);}drawElementsType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,a=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(r,i,n,t*a,s):this._gl.drawElements(r,i,n,t*a);}drawArraysType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e);s?this._gl.drawArraysInstanced(r,t,i,s):this._gl.drawArrays(r,t,i);}_drawMode(e){switch(e){case Qe$1.MATERIAL_TriangleFillMode:return this._gl.TRIANGLES;case Qe$1.MATERIAL_PointFillMode:return this._gl.POINTS;case Qe$1.MATERIAL_WireFrameFillMode:return this._gl.LINES;case Qe$1.MATERIAL_PointListDrawMode:return this._gl.POINTS;case Qe$1.MATERIAL_LineListDrawMode:return this._gl.LINES;case Qe$1.MATERIAL_LineLoopDrawMode:return this._gl.LINE_LOOP;case Qe$1.MATERIAL_LineStripDrawMode:return this._gl.LINE_STRIP;case Qe$1.MATERIAL_TriangleStripDrawMode:return this._gl.TRIANGLE_STRIP;case Qe$1.MATERIAL_TriangleFanDrawMode:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t);}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,Ft$1(t),this._gl&&(this._currentProgram===t.program&&this._setProgram(null),this._gl.deleteProgram(t.program)));}_getGlobalDefines(e){return $e$1(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,i,s,r,n,a,o,h,l=0,c){const u="string"==typeof e?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d="string"==typeof e?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,_=this._getGlobalDefines(),f=void 0!==t.attributes;let p=r??t.defines??"";_&&(p+=_);const g=u+"+"+d+"@"+p;if(this._compiledEffects[g]){const e=this._compiledEffects[g];return a&&e.isReady()&&a(e),e._refCount++,e}this._gl&&yt$1(this._gl);const m=new Nt$1(e,t,f?this:i,s,this,r,n,a,o,h,g,t.shaderLanguage??l,t.extraInitializationsAsync??c);return this._compiledEffects[g]=m,m}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,s,r=null){const n=yt$1(this._gl);return n._contextWasLost=this._contextWasLost,n.validateShaderPrograms=this.validateShaderPrograms,Ct$1(e,t,i,s||this._gl,r)}createShaderProgram(e,t,i,s,r,n=null){const a=yt$1(this._gl);return a._contextWasLost=this._contextWasLost,a.validateShaderPrograms=this.validateShaderPrograms,vt$1(e,t,i,s,r||this._gl,n)}inlineShaderCode(e){return e}createPipelineContext(e){if(this._gl){yt$1(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile;}const t=function(e){const t=new St$1,i=yt$1(e);return i.parallelShaderCompile&&!i.disableParallelShaderCompile&&(t.isParallelCompiled=true),t.context=i._context,t}(this._gl);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return Ot$1(e,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(e,t,i,s,r,n,a,o,h,l,c){const u=yt$1(this._gl);return u._contextWasLost=this._contextWasLost,u.validateShaderPrograms=this.validateShaderPrograms,u._createShaderProgramInjection=this._createShaderProgram.bind(this),u.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),u.createShaderProgramInjection=this.createShaderProgram.bind(this),u.loadFileInjection=this._loadFile.bind(this),function(e,t,i,s,r,n,a,o,h,l="",c,u,d){const _=yt$1(e.context);u||(u=_.createRawShaderProgramInjection??Ct$1),d||(d=_.createShaderProgramInjection??vt$1);const f=e;f.program=s?u(f,t,i,f.context,h):d(f,t,i,o,f.context,h),f.program.__SPECTOR_rebuildProgram=a,c();}(e,t,i,s,0,0,a,o,h,l,c)}_createShaderProgram(e,t,i,s,r=null){return Pt$1(e,t,i,s,r)}_isRenderingStateCompiled(e){return !this._isDisposed&&function(e,t,i){const s=e;if(s._isDisposed)return  false;const r=yt$1(t);return !!(r&&r.parallelShaderCompile&&r.parallelShaderCompile.COMPLETION_STATUS_KHR&&s.program&&t.getProgramParameter(s.program,r.parallelShaderCompile.COMPLETION_STATUS_KHR))&&(Ot$1(s,t,i),true)}(e,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(e,t){!function(e,t){const i=e;if(!i.isParallelCompiled)return void t(e);const s=i.onCompiled;i.onCompiled=()=>{s?.(),t(e);};}(e,t);}getUniforms(e,t){const i=new Array,s=e;for(let e=0;e<t.length;e++)i.push(this._gl.getUniformLocation(s.program,t[e]));return i}getAttributes(e,t){const i=[],s=e;for(let e=0;e<t.length;e++)try{i.push(this._gl.getAttribLocation(s.program,t[e]));}catch(e){i.push(-1);}return i}enableEffect(e){(e=null!==e&&or$1(e)?e.effect:e)&&e!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e));}setInt(e,t){return !!e&&(this._gl.uniform1i(e,t),true)}setInt2(e,t,i){return !!e&&(this._gl.uniform2i(e,t,i),true)}setInt3(e,t,i,s){return !!e&&(this._gl.uniform3i(e,t,i,s),true)}setInt4(e,t,i,s,r){return !!e&&(this._gl.uniform4i(e,t,i,s,r),true)}setIntArray(e,t){return !!e&&(this._gl.uniform1iv(e,t),true)}setIntArray2(e,t){return !(!e||t.length%2!=0)&&(this._gl.uniform2iv(e,t),true)}setIntArray3(e,t){return !(!e||t.length%3!=0)&&(this._gl.uniform3iv(e,t),true)}setIntArray4(e,t){return !(!e||t.length%4!=0)&&(this._gl.uniform4iv(e,t),true)}setUInt(e,t){return !!e&&(this._gl.uniform1ui(e,t),true)}setUInt2(e,t,i){return !!e&&(this._gl.uniform2ui(e,t,i),true)}setUInt3(e,t,i,s){return !!e&&(this._gl.uniform3ui(e,t,i,s),true)}setUInt4(e,t,i,s,r){return !!e&&(this._gl.uniform4ui(e,t,i,s,r),true)}setUIntArray(e,t){return !!e&&(this._gl.uniform1uiv(e,t),true)}setUIntArray2(e,t){return !(!e||t.length%2!=0)&&(this._gl.uniform2uiv(e,t),true)}setUIntArray3(e,t){return !(!e||t.length%3!=0)&&(this._gl.uniform3uiv(e,t),true)}setUIntArray4(e,t){return !(!e||t.length%4!=0)&&(this._gl.uniform4uiv(e,t),true)}setArray(e,t){return !!e&&(!(t.length<1)&&(this._gl.uniform1fv(e,t),true))}setArray2(e,t){return !(!e||t.length%2!=0)&&(this._gl.uniform2fv(e,t),true)}setArray3(e,t){return !(!e||t.length%3!=0)&&(this._gl.uniform3fv(e,t),true)}setArray4(e,t){return !(!e||t.length%4!=0)&&(this._gl.uniform4fv(e,t),true)}setMatrices(e,t){return !!e&&(this._gl.uniformMatrix4fv(e,false,t),true)}setMatrix3x3(e,t){return !!e&&(this._gl.uniformMatrix3fv(e,false,t),true)}setMatrix2x2(e,t){return !!e&&(this._gl.uniformMatrix2fv(e,false,t),true)}setFloat(e,t){return !!e&&(this._gl.uniform1f(e,t),true)}setFloat2(e,t,i){return !!e&&(this._gl.uniform2f(e,t,i),true)}setFloat3(e,t,i,s){return !!e&&(this._gl.uniform3f(e,t,i,s),true)}setFloat4(e,t,i,s,r){return !!e&&(this._gl.uniform4f(e,t,i,s,r),true)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl,this._currentRenderTarget&&this._currentRenderTarget.textures?this._currentRenderTarget.textures.length:1),this._colorWriteChanged){this._colorWriteChanged=false;const e=this._colorWrite;this._gl.colorMask(e,e,e,e);}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._resetAlphaMode(),this._colorWrite=true,this._colorWriteChanged=true,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=true,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null));}_getSamplingParameters(e,t){const i=this._gl;let s=i.NEAREST,r=i.NEAREST,n=false;switch(e){case Qe$1.TEXTURE_LINEAR_LINEAR_MIPNEAREST:s=i.LINEAR,r=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case Qe$1.TEXTURE_LINEAR_LINEAR_MIPLINEAR:s=i.LINEAR,n=true,r=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case Qe$1.TEXTURE_NEAREST_NEAREST_MIPLINEAR:n=true,s=i.NEAREST,r=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case Qe$1.TEXTURE_NEAREST_NEAREST_MIPNEAREST:s=i.NEAREST,r=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case Qe$1.TEXTURE_NEAREST_LINEAR_MIPNEAREST:s=i.NEAREST,r=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case Qe$1.TEXTURE_NEAREST_LINEAR_MIPLINEAR:n=true,s=i.NEAREST,r=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case Qe$1.TEXTURE_NEAREST_LINEAR:s=i.NEAREST,r=i.LINEAR;break;case Qe$1.TEXTURE_NEAREST_NEAREST:s=i.NEAREST,r=i.NEAREST;break;case Qe$1.TEXTURE_LINEAR_NEAREST_MIPNEAREST:s=i.LINEAR,r=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case Qe$1.TEXTURE_LINEAR_NEAREST_MIPLINEAR:n=true,s=i.LINEAR,r=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case Qe$1.TEXTURE_LINEAR_LINEAR:s=i.LINEAR,r=i.LINEAR;break;case Qe$1.TEXTURE_LINEAR_NEAREST:s=i.LINEAR,r=i.NEAREST;}return {min:r,mag:s,hasMipMaps:n}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new Ma(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=true,s=0){let r,n=false,a=false,o=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,h=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,l=Qe$1.TEXTUREFORMAT_RGBA,c=false,u=1,d=false,_=0;void 0!==t&&"object"==typeof t?(n=!!t.generateMipMaps,a=!!t.createMipMaps,o=void 0===t.type?Qe$1.TEXTURETYPE_UNSIGNED_BYTE:t.type,h=void 0===t.samplingMode?Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE:t.samplingMode,l=void 0===t.format?Qe$1.TEXTUREFORMAT_RGBA:t.format,c=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,u=t.samples??1,r=t.label,d=!!t.createMSAATexture,_=t.comparisonFunction||0):n=!!t,c&&=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU),(o!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering)&&(o!==Qe$1.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering)||(h=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE),o!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloat||(o=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,Ie$2.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const f=ya(l),p=Ca(l),g=this._gl,m=new zt(this,s),T=e.width||e,E=e.height||e,A=e.depth||0,R=e.layers||0,b=this._getSamplingParameters(h,(n||a)&&!f),S=0!==R?g.TEXTURE_2D_ARRAY:0!==A?g.TEXTURE_3D:g.TEXTURE_2D,x=f?this._getInternalFormatFromDepthTextureFormat(l,true,p):this._getRGBABufferInternalSizedFormat(o,l,c),M=f?p?g.DEPTH_STENCIL:g.DEPTH_COMPONENT:this._getInternalFormat(l),y=f?this._getWebGLTextureTypeFromDepthTextureFormat(l):this._getWebGLTextureType(o);if(this._bindTextureDirectly(S,m),0!==R?(m.is2DArray=true,g.texImage3D(S,0,x,T,E,R,0,M,y,null)):0!==A?(m.is3D=true,g.texImage3D(S,0,x,T,E,A,0,M,y,null)):g.texImage2D(S,0,x,T,E,0,M,y,null),g.texParameteri(S,g.TEXTURE_MAG_FILTER,b.mag),g.texParameteri(S,g.TEXTURE_MIN_FILTER,b.min),g.texParameteri(S,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(S,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),f&&this.webGLVersion>1&&(0===_?(g.texParameteri(S,g.TEXTURE_COMPARE_FUNC,Qe$1.LEQUAL),g.texParameteri(S,g.TEXTURE_COMPARE_MODE,g.NONE)):(g.texParameteri(S,g.TEXTURE_COMPARE_FUNC,_),g.texParameteri(S,g.TEXTURE_COMPARE_MODE,g.COMPARE_REF_TO_TEXTURE))),(n||a)&&this._gl.generateMipmap(S),this._bindTextureDirectly(S,null),m._useSRGBBuffer=c,m.baseWidth=T,m.baseHeight=E,m.width=T,m.height=E,m.depth=R||A,m.isReady=true,m.samples=u,m.generateMipMaps=n,m.samplingMode=h,m.type=o,m.format=l,m.label=r,m.comparisonFunction=_,this._internalTexturesCache.push(m),d){let e=null;if(e=ya(m.format)?this._setupFramebufferDepthAttachments(Ca(m.format),m.format!==Qe$1.TEXTUREFORMAT_STENCIL8,m.width,m.height,u,m.format,true):this._createRenderBuffer(m.width,m.height,u,-1,this._getRGBABufferInternalSizedFormat(m.type,m.format,m._useSRGBBuffer),-1),!e)throw new Error("Unable to create render buffer");m._autoMSAAManagement=true;let t=m._hardwareTexture;t||(t=m._hardwareTexture=this._createHardwareTexture()),t.addMSAARenderBuffer(e);}return m}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,i,s,r=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,n=null,a=null,o=null,h=null,l=null,c=null,u,d,_,f){return this._createTextureBase(e,t,i,s,r,n,a,((...e)=>this._prepareWebGLTexture(...e,l)),((e,t,i,r,n,a)=>{const o=this._gl,h=i.width===e&&i.height===t;n._creationFlags=_??0;const l=this._getTexImageParametersForCreateTexture(n.format,n._useSRGBBuffer);if(h)return o.texImage2D(o.TEXTURE_2D,0,l.internalFormat,l.format,l.type,i),false;const c=this._caps.maxTextureSize;if(i.width>c||i.height>c||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=e,this._workingCanvas.height=t,this._workingContext.drawImage(i,0,0,i.width,i.height,0,0,e,t),o.texImage2D(o.TEXTURE_2D,0,l.internalFormat,l.format,l.type,this._workingCanvas),n.width=e,n.height=t,false);{const e=new zt(this,2);this._bindTextureDirectly(o.TEXTURE_2D,e,true),o.texImage2D(o.TEXTURE_2D,0,l.internalFormat,l.format,l.type,i),this._rescaleTexture(e,n,s,l.format,(()=>{this._releaseTexture(e),this._bindTextureDirectly(o.TEXTURE_2D,n,true),a();}));}return  true}),o,h,l,c,u,d,f)}_getTexImageParametersForCreateTexture(e,t){let i,s;return 1===this.webGLVersion?(i=this._getInternalFormat(e,t),s=i):(i=this._getInternalFormat(e,false),s=this._getRGBABufferInternalSizedFormat(Qe$1.TEXTURETYPE_UNSIGNED_BYTE,e,t)),{internalFormat:s,format:i,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,i,s,r){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e));}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=false){const s=this._getTextureTarget(t),r=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,r.min),i&&r.hasMipMaps&&(t.generateMipMaps=true,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),t.samplingMode=e;}updateTextureDimensions(e,t,i,s=1){}updateTextureWrappingMode(e,t,i=null,s=null){const r=this._getTextureTarget(e);null!==t&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),null!==i&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==s&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),e),e._cachedWrapR=s),this._bindTextureDirectly(r,null);}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,a=0){const o=this._gl;let h=o.TEXTURE_2D;if(e.isCube&&(h=o.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2:case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL:this._caps.etc2?t=o.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=false;break;case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC:this._caps.etc2?t=o.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=false;break;case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM:t=o.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4:t=o.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=false;break;case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=false;break;case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=false;break;default:e._useSRGBBuffer=false;}if(e.generateMipMaps){const n=e._hardwareTexture;n.memoryAllocated||(o.texStorage2D(o.TEXTURE_2D,Math.floor(Math.log2(Math.max(i,s)))+1,t,e.width,e.height),n.memoryAllocated=true),this._gl.compressedTexSubImage2D(h,a,0,0,i,s,t,r);}else this._gl.compressedTexImage2D(h,a,t,i,s,0,r);}_uploadDataToTextureDirectly(e,t,i=0,s=0,r,n=false){const a=this._gl,o=this._getWebGLTextureType(e.type),h=this._getInternalFormat(e.format),l=void 0===r?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(r,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let c=a.TEXTURE_2D;e.isCube&&(c=a.TEXTURE_CUBE_MAP_POSITIVE_X+i);const u=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),_=n?e.width:Math.pow(2,Math.max(u-s,0)),f=n?e.height:Math.pow(2,Math.max(d-s,0));a.texImage2D(c,s,l,_,f,0,h,o,t);}updateTextureData(e,t,i,s,r,n,a=0,o=0,h=false){const l=this._gl,c=this._getWebGLTextureType(e.type),u=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let d=l.TEXTURE_2D,_=l.TEXTURE_2D;e.isCube&&(_=l.TEXTURE_CUBE_MAP_POSITIVE_X+a,d=l.TEXTURE_CUBE_MAP),this._bindTextureDirectly(d,e,true),l.texSubImage2D(_,o,i,s,r,n,u,c,t),h&&this._gl.generateMipmap(_),this._bindTextureDirectly(d,null);}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){const r=this._gl,n=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(n,e,true),this._uploadDataToTextureDirectly(e,t,i,s),this._bindTextureDirectly(n,null,true);}_prepareWebGLTextureContinuation(e,t,i,s,r){const n=this._gl;if(!n)return;const a=this._getSamplingParameters(r,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,a.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,a.min),i||s||n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear();}_prepareWebGLTexture(e,t,i,s,r,n,a,o,h,l){const c=this.getCaps().maxTextureSize,u=Math.min(c,this.needPOTTextures?Ei(s.width,c):s.width),d=Math.min(c,this.needPOTTextures?Ei(s.height,c):s.height),_=this._gl;_&&(e._hardwareTexture?(this._bindTextureDirectly(_.TEXTURE_2D,e,true),this._unpackFlipY(void 0===r||!!r),e.baseWidth=s.width,e.baseHeight=s.height,e.width=u,e.height=d,e.isReady=true,e.type=-1!==e.type?e.type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,e.format=-1!==e.format?e.format:l??(".jpg"!==t||e._useSRGBBuffer?Qe$1.TEXTUREFORMAT_RGBA:Qe$1.TEXTUREFORMAT_RGB),o(u,d,s,t,e,(()=>{this._prepareWebGLTextureContinuation(e,i,n,a,h);}))||this._prepareWebGLTextureContinuation(e,i,n,a,h)):i&&i.removePendingData(e));}_getInternalFormatFromDepthTextureFormat(e,t,i){const s=this._gl;if(!t)return s.STENCIL_INDEX8;let r=i?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;return this.webGLVersion>1?e===Qe$1.TEXTUREFORMAT_DEPTH16?r=s.DEPTH_COMPONENT16:e===Qe$1.TEXTUREFORMAT_DEPTH24?r=s.DEPTH_COMPONENT24:e===Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8||e===Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8?r=i?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT24:e===Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT?r=s.DEPTH_COMPONENT32F:e===Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8&&(r=i?s.DEPTH32F_STENCIL8:s.DEPTH_COMPONENT32F):r=s.DEPTH_COMPONENT16,r}_getWebGLTextureTypeFromDepthTextureFormat(e){const t=this._gl;let i=t.UNSIGNED_INT;return e===Qe$1.TEXTUREFORMAT_DEPTH16?i=t.UNSIGNED_SHORT:e===Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8||e===Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8?i=t.UNSIGNED_INT_24_8:e===Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT?i=t.FLOAT:e===Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8?i=t.FLOAT_32_UNSIGNED_INT_24_8_REV:e===Qe$1.TEXTUREFORMAT_STENCIL8&&(i=t.UNSIGNED_BYTE),i}_setupFramebufferDepthAttachments(e,t,i,s,r=1,n,a=false){const o=this._gl;n=n??(e?Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT);const h=this._getInternalFormatFromDepthTextureFormat(n,t,e);return e&&t?this._createRenderBuffer(i,s,r,o.DEPTH_STENCIL,h,a?-1:o.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(i,s,r,h,h,a?-1:o.DEPTH_ATTACHMENT):e?this._createRenderBuffer(i,s,r,h,h,a?-1:o.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,s,r,n,a=true){const o=this._gl.createRenderbuffer();return this._updateRenderBuffer(o,e,t,i,s,r,n,a)}_updateRenderBuffer(e,t,i,s,r,n,a,o=true){const h=this._gl;return h.bindRenderbuffer(h.RENDERBUFFER,e),s>1&&h.renderbufferStorageMultisample?h.renderbufferStorageMultisample(h.RENDERBUFFER,s,n,t,i):h.renderbufferStorage(h.RENDERBUFFER,r,t,i),-1!==a&&h.framebufferRenderbuffer(h.FRAMEBUFFER,a,h.RENDERBUFFER,e),o&&h.bindRenderbuffer(h.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();const t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose();}_deleteTexture(e){e?.release();}_setProgram(e){this._currentProgram!==e&&(!function(e,t){t.useProgram(e);}(e,this._gl),this._currentProgram=e);}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let t=0;t<i.length;t++){const s=e.getUniform(i[t]);s&&(this._boundUniforms[t]=s);}this._currentEffect=null;}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel);}_bindTextureDirectly(e,t,i=false,s=false){let r=false;const n=t&&t._associatedChannel>-1;i&&n&&(this._activeChannel=t._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==t||s){if(this._activateCurrentTexture(),t&&t.isMultiview)throw Ie$2.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,t?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel);}else i&&(r=true,this._activateCurrentTexture());return n&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),r}_bindTexture(e,t,i){if(void 0===e)return;t&&(t._associatedChannel=e),this._activeChannel=e;const s=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,t);}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null));}setTexture(e,t,i,s){ void 0!==e&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i));}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];i&&i._currentState!==t&&(this._gl.uniform1i(i,t),i._currentState=t);}_getTextureWrapMode(e){switch(e){case Qe$1.TEXTURE_WRAP_ADDRESSMODE:return this._gl.REPEAT;case Qe$1.TEXTURE_CLAMP_ADDRESSMODE:return this._gl.CLAMP_TO_EDGE;case Qe$1.TEXTURE_MIRROR_ADDRESSMODE:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=false,s=false,r=""){if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),false;if(t.video){this._activeChannel=e;const i=t.getInternalTexture();i&&(i._associatedChannel=e),t.update();}else if(t.delayLoadState===Qe$1.DELAYLOADSTATE_NOTLOADED)return t.delayLoad(),false;let n;n=s?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!i&&n&&(n._associatedChannel=e);let a=true;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),a=false),this._activeChannel=e;const o=this._getTextureTarget(n);if(a&&this._bindTextureDirectly(o,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const e=t.coordinatesMode!==Qe$1.TEXTURE_CUBIC_MODE&&t.coordinatesMode!==Qe$1.TEXTURE_SKYBOX_MODE?Qe$1.TEXTURE_WRAP_ADDRESSMODE:Qe$1.TEXTURE_CLAMP_ADDRESSMODE;t.wrapU=e,t.wrapV=e;}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(o,n,t.anisotropicFilteringLevel);}return  true}setTextureArray(e,t,i,s){if(void 0!==e&&t){this._textureUnits&&this._textureUnits.length===i.length||(this._textureUnits=new Int32Array(i.length));for(let t=0;t<i.length;t++){const s=i[t].getInternalTexture();s?(this._textureUnits[t]=e+t,s._associatedChannel=e+t):this._textureUnits[t]=-1;}this._gl.uniform1iv(t,this._textureUnits);for(let e=0;e<i.length;e++)this._setTexture(this._textureUnits[e],i[e],true);}}_setAnisotropicLevel(e,t,i){const s=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==Qe$1.TEXTURE_LINEAR_LINEAR_MIPNEAREST&&t.samplingMode!==Qe$1.TEXTURE_LINEAR_LINEAR_MIPLINEAR&&t.samplingMode!==Qe$1.TEXTURE_LINEAR_LINEAR&&(i=1),s&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i);}_setTextureParameterFloat(e,t,i,s){this._bindTextureDirectly(e,s,true,true),this._gl.texParameterf(e,t,i);}_setTextureParameterInteger(e,t,i,s){s&&this._bindTextureDirectly(e,s,true,true),this._gl.texParameteri(e,t,i);}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=false;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);}else for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e);}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this);}dispose(){Se$2()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&this._gl.getExtension("WEBGL_lose_context")?.loseContext(),It$1(this._gl);}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,false);}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,false);}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(Qe$1.TEXTURETYPE_FLOAT)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(Qe$1.TEXTURETYPE_HALF_FLOAT)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=true;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const e=t.RGBA,s=t.UNSIGNED_BYTE,r=new Uint8Array(4);t.readPixels(0,0,1,1,e,s,r),i=i&&t.getError()===t.NO_ERROR;}for(t.deleteTexture(s),t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(1===this._webGLVersion){switch(e){case Qe$1.TEXTURETYPE_FLOAT:return this._gl.FLOAT;case Qe$1.TEXTURETYPE_HALF_FLOAT:return this._gl.HALF_FLOAT_OES;case Qe$1.TEXTURETYPE_UNSIGNED_BYTE:return this._gl.UNSIGNED_BYTE;case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:return this._gl.UNSIGNED_SHORT_4_4_4_4;case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:return this._gl.UNSIGNED_SHORT_5_5_5_1;case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case Qe$1.TEXTURETYPE_BYTE:return this._gl.BYTE;case Qe$1.TEXTURETYPE_UNSIGNED_BYTE:return this._gl.UNSIGNED_BYTE;case Qe$1.TEXTURETYPE_SHORT:return this._gl.SHORT;case Qe$1.TEXTURETYPE_UNSIGNED_SHORT:return this._gl.UNSIGNED_SHORT;case Qe$1.TEXTURETYPE_INT:return this._gl.INT;case Qe$1.TEXTURETYPE_UNSIGNED_INTEGER:return this._gl.UNSIGNED_INT;case Qe$1.TEXTURETYPE_FLOAT:return this._gl.FLOAT;case Qe$1.TEXTURETYPE_HALF_FLOAT:return this._gl.HALF_FLOAT;case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:return this._gl.UNSIGNED_SHORT_4_4_4_4;case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:return this._gl.UNSIGNED_SHORT_5_5_5_1;case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:return this._gl.UNSIGNED_SHORT_5_6_5;case Qe$1.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case Qe$1.TEXTURETYPE_UNSIGNED_INT_24_8:return this._gl.UNSIGNED_INT_24_8;case Qe$1.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case Qe$1.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case Qe$1.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=false){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case Qe$1.TEXTUREFORMAT_ALPHA:i=this._gl.ALPHA;break;case Qe$1.TEXTUREFORMAT_LUMINANCE:i=this._gl.LUMINANCE;break;case Qe$1.TEXTUREFORMAT_LUMINANCE_ALPHA:i=this._gl.LUMINANCE_ALPHA;break;case Qe$1.TEXTUREFORMAT_RED:case Qe$1.TEXTUREFORMAT_R16_UNORM:case Qe$1.TEXTUREFORMAT_R16_SNORM:i=this._gl.RED;break;case Qe$1.TEXTUREFORMAT_RG:case Qe$1.TEXTUREFORMAT_RG16_UNORM:case Qe$1.TEXTUREFORMAT_RG16_SNORM:i=this._gl.RG;break;case Qe$1.TEXTUREFORMAT_RGB:case Qe$1.TEXTUREFORMAT_RGB16_UNORM:case Qe$1.TEXTUREFORMAT_RGB16_SNORM:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case Qe$1.TEXTUREFORMAT_RGBA:case Qe$1.TEXTUREFORMAT_RGBA16_UNORM:case Qe$1.TEXTUREFORMAT_RGBA16_SNORM:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;}if(this._webGLVersion>1)switch(e){case Qe$1.TEXTUREFORMAT_RED_INTEGER:i=this._gl.RED_INTEGER;break;case Qe$1.TEXTUREFORMAT_RG_INTEGER:i=this._gl.RG_INTEGER;break;case Qe$1.TEXTUREFORMAT_RGB_INTEGER:i=this._gl.RGB_INTEGER;break;case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:i=this._gl.RGBA_INTEGER;}return i}_getRGBABufferInternalSizedFormat(e,t,i=false){if(1===this._webGLVersion){if(void 0!==t)switch(t){case Qe$1.TEXTUREFORMAT_ALPHA:return this._gl.ALPHA;case Qe$1.TEXTUREFORMAT_LUMINANCE:return this._gl.LUMINANCE;case Qe$1.TEXTUREFORMAT_LUMINANCE_ALPHA:return this._gl.LUMINANCE_ALPHA;case Qe$1.TEXTUREFORMAT_RGB:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case Qe$1.TEXTURETYPE_BYTE:switch(t){case Qe$1.TEXTUREFORMAT_RED:return this._gl.R8_SNORM;case Qe$1.TEXTUREFORMAT_RG:return this._gl.RG8_SNORM;case Qe$1.TEXTUREFORMAT_RGB:return this._gl.RGB8_SNORM;case Qe$1.TEXTUREFORMAT_RED_INTEGER:return this._gl.R8I;case Qe$1.TEXTUREFORMAT_RG_INTEGER:return this._gl.RG8I;case Qe$1.TEXTUREFORMAT_RGB_INTEGER:return this._gl.RGB8I;case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case Qe$1.TEXTURETYPE_UNSIGNED_BYTE:switch(t){case Qe$1.TEXTUREFORMAT_RED:return this._gl.R8;case Qe$1.TEXTUREFORMAT_RG:return this._gl.RG8;case Qe$1.TEXTUREFORMAT_RGB:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case Qe$1.TEXTUREFORMAT_RGBA:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case Qe$1.TEXTUREFORMAT_RED_INTEGER:return this._gl.R8UI;case Qe$1.TEXTUREFORMAT_RG_INTEGER:return this._gl.RG8UI;case Qe$1.TEXTUREFORMAT_RGB_INTEGER:return this._gl.RGB8UI;case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:return this._gl.RGBA8UI;case Qe$1.TEXTUREFORMAT_ALPHA:return this._gl.ALPHA;case Qe$1.TEXTUREFORMAT_LUMINANCE:return this._gl.LUMINANCE;case Qe$1.TEXTUREFORMAT_LUMINANCE_ALPHA:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case Qe$1.TEXTURETYPE_SHORT:switch(t){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return this._gl.R16I;case Qe$1.TEXTUREFORMAT_R16_SNORM:return this._gl.R16_SNORM_EXT;case Qe$1.TEXTUREFORMAT_RG16_SNORM:return this._gl.RG16_SNORM_EXT;case Qe$1.TEXTUREFORMAT_RGB16_SNORM:return this._gl.RGB16_SNORM_EXT;case Qe$1.TEXTUREFORMAT_RGBA16_SNORM:return this._gl.RGBA16_SNORM_EXT;case Qe$1.TEXTUREFORMAT_RG_INTEGER:return this._gl.RG16I;case Qe$1.TEXTUREFORMAT_RGB_INTEGER:return this._gl.RGB16I;case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return this._gl.RGBA16I}case Qe$1.TEXTURETYPE_UNSIGNED_SHORT:switch(t){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return this._gl.R16UI;case Qe$1.TEXTUREFORMAT_R16_UNORM:return this._gl.R16_EXT;case Qe$1.TEXTUREFORMAT_RG16_UNORM:return this._gl.RG16_EXT;case Qe$1.TEXTUREFORMAT_RGB16_UNORM:return this._gl.RGB16_EXT;case Qe$1.TEXTUREFORMAT_RGBA16_UNORM:return this._gl.RGBA16_EXT;case Qe$1.TEXTUREFORMAT_RG_INTEGER:return this._gl.RG16UI;case Qe$1.TEXTUREFORMAT_RGB_INTEGER:return this._gl.RGB16UI;case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return this._gl.RGBA16UI}case Qe$1.TEXTURETYPE_INT:switch(t){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return this._gl.R32I;case Qe$1.TEXTUREFORMAT_RG_INTEGER:return this._gl.RG32I;case Qe$1.TEXTUREFORMAT_RGB_INTEGER:return this._gl.RGB32I;case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return this._gl.RGBA32I}case Qe$1.TEXTURETYPE_UNSIGNED_INTEGER:switch(t){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return this._gl.R32UI;case Qe$1.TEXTUREFORMAT_RG_INTEGER:return this._gl.RG32UI;case Qe$1.TEXTUREFORMAT_RGB_INTEGER:return this._gl.RGB32UI;case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return this._gl.RGBA32UI}case Qe$1.TEXTURETYPE_FLOAT:switch(t){case Qe$1.TEXTUREFORMAT_RED:return this._gl.R32F;case Qe$1.TEXTUREFORMAT_RG:return this._gl.RG32F;case Qe$1.TEXTUREFORMAT_RGB:return this._gl.RGB32F;case Qe$1.TEXTUREFORMAT_RGBA:default:return this._gl.RGBA32F}case Qe$1.TEXTURETYPE_HALF_FLOAT:switch(t){case Qe$1.TEXTUREFORMAT_RED:return this._gl.R16F;case Qe$1.TEXTUREFORMAT_RG:return this._gl.RG16F;case Qe$1.TEXTUREFORMAT_RGB:return this._gl.RGB16F;case Qe$1.TEXTUREFORMAT_RGBA:default:return this._gl.RGBA16F}case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:return this._gl.RGB565;case Qe$1.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:return this._gl.R11F_G11F_B10F;case Qe$1.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:return this._gl.RGB9_E5;case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:return this._gl.RGBA4;case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:return this._gl.RGB5_A1;case Qe$1.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:switch(t){case Qe$1.TEXTUREFORMAT_RGBA:return this._gl.RGB10_A2;case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,i,s,r=true,n=true,a=null){const o=r?4:3,h=r?this._gl.RGBA:this._gl.RGB,l=i*s*o;if(a){if(a.length<l)return Ie$2.Error(`Data buffer is too small to store the read pixels (${a.length} should be more than ${l})`),Promise.resolve(a)}else a=new Uint8Array(l);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,s,h,this._gl.UNSIGNED_BYTE,a),Promise.resolve(a)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return !this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const e=jt._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=null!=t&&!!window.WebGLRenderingContext;}catch(e){this._IsSupported=false;}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const e=jt._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t;}catch(e){this._HasMajorPerformanceCaveat=false;}return this._HasMajorPerformanceCaveat}}Pa._TempClearColorUint32=new Uint32Array(4),Pa._TempClearColorInt32=new Int32Array(4),Pa.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],Pa._ConcatenateShader=Ze$1,Pa._IsSupported=null,Pa._HasMajorPerformanceCaveat=null;var Oa=Object.freeze({__proto__:null,ThinEngine:Pa});class Da{constructor(e=30){this._enabled=true,this._rollingFrameTime=new La(e);}sampleFrame(e=Pe$2.Now){if(this._enabled){if(null!=this._lastFrameTimeMs){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t);}this._lastFrameTimeMs=e;}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=true;}disable(){this._enabled=false,this._lastFrameTimeMs=null;}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset();}}class La{constructor(e){this._samples=new Array(e),this.reset();}add(e){let t;if(this.isSaturated()){const e=this._samples[this._pos];t=e-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(e-this.average);}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length;}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0;}_wrapPosition(e){const t=this._samples.length;return (e%t+t)%t}}function Fa(e,t,i,s){let r,n=1;s===Qe$1.TEXTURETYPE_FLOAT?r=new Float32Array(t*i*4):s===Qe$1.TEXTURETYPE_HALF_FLOAT?(r=new Uint16Array(t*i*4),n=15360):r=s===Qe$1.TEXTURETYPE_UNSIGNED_INTEGER?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let s=0;s<t;s++)for(let a=0;a<i;a++){const i=3*(a*t+s),o=4*(a*t+s);r[o+0]=e[i+0],r[o+1]=e[i+1],r[o+2]=e[i+2],r[o+3]=n;}return r}function wa(e){return function(t,i,s,r,n,a,o,h,l=null,c=Qe$1.TEXTURETYPE_UNSIGNED_BYTE){const u=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=new zt(this,e?10:11);d.baseWidth=i,d.baseHeight=s,d.baseDepth=r,d.width=i,d.height=s,d.depth=r,d.format=n,d.type=c,d.generateMipMaps=a,d.samplingMode=h,e?d.is3D=true:d.is2DArray=true,this._doNotHandleContextLost||(d._bufferView=t),e?this.updateRawTexture3D(d,t,n,o,l,c):this.updateRawTexture2DArray(d,t,n,o,l,c),this._bindTextureDirectly(u,d,true);const _=this._getSamplingParameters(h,a);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,_.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,_.min),a&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(d),d}}function Na(e){return function(t,i,s,r,n=null,a=Qe$1.TEXTURETYPE_UNSIGNED_BYTE){const o=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,h=this._getWebGLTextureType(a),l=this._getInternalFormat(s),c=this._getRGBABufferInternalSizedFormat(a,s);this._bindTextureDirectly(o,t,true),this._unpackFlipY(void 0===r||!!r),this._doNotHandleContextLost||(t._bufferView=i,t.format=s,t.invertY=r,t._compression=n),t.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&i?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[n],t.width,t.height,t.depth,0,i):this._gl.texImage3D(o,0,c,t.width,t.height,t.depth,0,l,h,i),t.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),t.isReady=true;}}Pa.prototype.setAlphaMode=function(e,t=false,i=0){if(this._alphaMode[i]===e){if(!t){const t=e===Qe$1.ALPHA_DISABLE;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t);}return}const s=e===Qe$1.ALPHA_DISABLE;this._alphaState.setAlphaBlend(!s,i),this._alphaState.setAlphaMode(e,i),t||(this.depthCullingState.depthMask=s),this._alphaMode[i]=e;},Pa.prototype.updateRawTexture=function(e,t,i,s,r=null,n=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,a=false){if(!e)return;const o=this._getRGBABufferInternalSizedFormat(n,i,a),h=this._getInternalFormat(i),l=this._getWebGLTextureType(n);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,true),this._unpackFlipY(void 0===s||!!s),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.type=n,e.invertY=s,e._compression=r),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&t?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],e.width,e.height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,e.width,e.height,0,h,l,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=true;},Pa.prototype.createRawTexture=function(e,t,i,s,r,n,a,o=null,h=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,l=0,c=false){const u=new zt(this,3);u.baseWidth=t,u.baseHeight=i,u.width=t,u.height=i,u.format=s,u.generateMipMaps=r,u.samplingMode=a,u.invertY=n,u._compression=o,u.type=h,u._useSRGBBuffer=this._getUseSRGBBuffer(c,!r),this._doNotHandleContextLost||(u._bufferView=e),this.updateRawTexture(u,e,s,n,o,h,u._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,true);const d=this._getSamplingParameters(a,r);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(u),u},Pa.prototype.createRawCubeTexture=function(e,t,i,s,r,n,a,o=null){const h=this._gl,l=new zt(this,8);l.isCube=true,l.format=i,l.type=s,this._doNotHandleContextLost||(l._bufferViewArray=e);const c=this._getWebGLTextureType(s);let u=this._getInternalFormat(i);u===h.RGB&&(u=h.RGBA),c!==h.FLOAT||this._caps.textureFloatLinearFiltering?c!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?c!==h.FLOAT||this._caps.textureFloatRender?c!==h.HALF_FLOAT||this._caps.colorBufferFloat||(r=false,Ie$2.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(r=false,Ie$2.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(r=false,a=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Ie$2.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(r=false,a=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Ie$2.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const d=t,_=d;l.width=d,l.height=_,l.invertY=n,l._compression=o;if(!this.needPOTTextures||fi(l.width)&&fi(l.height)||(r=false),e)this.updateRawCubeTexture(l,e,i,s,n,o);else {const e=this._getRGBABufferInternalSizedFormat(s),t=0;this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,l,true);for(let i=0;i<6;i++)o?h.compressedTexImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,this.getCaps().s3tc[o],l.width,l.height,0,void 0):h.texImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,e,l.width,l.height,0,u,c,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null);}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,l,true),e&&r&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const f=this._getSamplingParameters(a,r);return h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MAG_FILTER,f.mag),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MIN_FILTER,f.min),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,null),l.generateMipMaps=r,l.samplingMode=a,l.isReady=true,l},Pa.prototype.updateRawCubeTexture=function(e,t,i,s,r,n=null,a=0){e._bufferViewArray=t,e.format=i,e.type=s,e.invertY=r,e._compression=n;const o=this._gl,h=this._getWebGLTextureType(s);let l=this._getInternalFormat(i);const c=this._getRGBABufferInternalSizedFormat(s);let u=false;l===o.RGB&&(l=o.RGBA,u=true),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,e,true),this._unpackFlipY(void 0===r||!!r),e.width%4!=0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let i=0;i<6;i++){let r=t[i];n?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+i,a,this.getCaps().s3tc[n],e.width,e.height,0,r):(u&&(r=Fa(r,e.width,e.height,s)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+i,a,c,e.width,e.height,0,l,h,r));}(!this.needPOTTextures||fi(e.width)&&fi(e.height))&&e.generateMipMaps&&0===a&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=true;},Pa.prototype.createRawCubeTextureFromUrl=function(e,t,i,s,r,n,a,o,h=null,l=null,c=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,u=false){const d=this._gl,_=this.createRawCubeTexture(null,i,s,r,!n,u,c,null);t?.addPendingData(_),_.url=e,_.isReady=false,this._internalTexturesCache.push(_);const f=(e,i)=>{t?.removePendingData(_),l&&e&&l(e.status+" "+e.statusText,i);},p=async e=>{if(!_._hardwareTexture)return;const i=a(e);if(!i)return;const n=i instanceof Promise?await i:i,l=_.width;if(o){const e=this._getWebGLTextureType(r);let t=this._getInternalFormat(s);const i=this._getRGBABufferInternalSizedFormat(r);let a=false;t===d.RGB&&(t=d.RGBA,a=true),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,_,true),this._unpackFlipY(false);const h=o(n);for(let s=0;s<h.length;s++){const n=l>>s;for(let o=0;o<6;o++){let l=h[s][o];a&&(l=Fa(l,n,n,r)),d.texImage2D(o,s,i,n,n,0,t,e,l);}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null);}else this.updateRawCubeTexture(_,n,s,r,u);_.isReady=true,t?.removePendingData(_),_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),h&&h();};return this._loadFile(e,(e=>{p(e).catch((e=>{f(void 0,e);}));}),void 0,t?.offlineProvider,true,f),_},Pa.prototype.createRawTexture2DArray=wa(false),Pa.prototype.createRawTexture3D=wa(true),Pa.prototype.updateRawTexture2DArray=Na(false),Pa.prototype.updateRawTexture3D=Na(true),Pa.prototype._readTexturePixelsSync=function(e,t,i,s=-1,r=0,n=null,a=true,o=false,h=0,l=0){const c=this._gl;if(!c)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const e=c.createFramebuffer();if(!e)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=e;}c.bindFramebuffer(c.FRAMEBUFFER,this._dummyFramebuffer),s>-1?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+s,e._hardwareTexture?.underlyingResource,r):c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e._hardwareTexture?.underlyingResource,r);let u=void 0!==e.type?this._getWebGLTextureType(e.type):c.UNSIGNED_BYTE;if(o)n||(n=et$1(e.type,4*t*i));else if(u===c.UNSIGNED_BYTE)n||(n=new Uint8Array(4*t*i)),u=c.UNSIGNED_BYTE;else n||(n=new Float32Array(4*t*i)),u=c.FLOAT;return a&&this.flushFramebuffer(),c.readPixels(h,l,t,i,c.RGBA,u,n),c.bindFramebuffer(c.FRAMEBUFFER,this._currentFramebuffer),n},Pa.prototype._readTexturePixels=function(e,t,i,s=-1,r=0,n=null,a=true,o=false,h=0,l=0){return Promise.resolve(this._readTexturePixelsSync(e,t,i,s,r,n,a,o,h,l))},Pa.prototype.updateDynamicIndexBuffer=function(e,t,i=0){let s;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),s=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,s,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding();},Pa.prototype.updateDynamicVertexBuffer=function(e,t,i,s){this.bindArrayBuffer(e),void 0===i&&(i=0);const r=t.byteLength||t.length;void 0===s||s>=r&&0===i?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t).subarray(0,s/4)):(t=t instanceof ArrayBuffer?new Uint8Array(t,0,s):new Uint8Array(t.buffer,t.byteOffset,s),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t)),this._resetVertexBufferBinding();},Pa.prototype._createDepthStencilCubeTexture=function(e,t){const i=new zt(this,12);if(i.isCube=true,1===this.webGLVersion)return Ie$2.Error("Depth cube texture is not supported by WebGL 1."),i;const s={bilinearFiltering:false,comparisonFunction:0,generateStencil:false,...t},r=this._gl;this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,i,true),this._setupDepthStencilTexture(i,e,s.bilinearFiltering,s.comparisonFunction);for(let t=0;t<6;t++)s.generateStencil?r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,r.DEPTH24_STENCIL8,e,e,0,r.DEPTH_STENCIL,r.UNSIGNED_INT_24_8,null):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,r.DEPTH_COMPONENT24,e,e,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null);return this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i},Pa.prototype._setCubeMapTextureParams=function(e,t,i){const s=this._gl;s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,t?s.LINEAR_MIPMAP_LINEAR:s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),e.samplingMode=t?Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE:Qe$1.TEXTURE_LINEAR_LINEAR,t&&this.getCaps().textureMaxLevel&&void 0!==i&&i>0&&(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAX_LEVEL,i),e._maxLodLevel=i),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null);},Pa.prototype.createCubeTexture=function(e,t,i,s,r=null,n=null,a,o=null,h=false,l=0,c=0,u=null,d,_=false,f=null){const p=this._gl;return this.createCubeTextureBase(e,t,i,!!s,r,n,a,o,h,l,c,u,(e=>this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,e,true)),((e,t)=>{const i=this.needPOTTextures?Ei(t[0].width,this._caps.maxCubemapTextureSize):t[0].width,n=i,o=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,e,true),this._unpackFlipY(false);const h=a?this._getInternalFormat(a,e._useSRGBBuffer):e._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:p.RGBA;let l=a?this._getInternalFormat(a):p.RGBA;e._useSRGBBuffer&&1===this.webGLVersion&&(l=h);for(let e=0;e<o.length;e++)if(t[e].width!==i||t[e].height!==n){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void Ie$2.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=i,this._workingCanvas.height=n,this._workingContext.drawImage(t[e],0,0,t[e].width,t[e].height,0,0,i,n),p.texImage2D(o[e],0,h,l,p.UNSIGNED_BYTE,this._workingCanvas);}else p.texImage2D(o[e],0,h,l,p.UNSIGNED_BYTE,t[e]);s||p.generateMipmap(p.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(e,!s),e.width=i,e.height=n,e.isReady=true,a&&(e.format=a),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r();}),!!_,f)},Pa.prototype.generateMipMapsForCubemap=function(e,t=true){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,true),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null);}};class Ba{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(e,t=true){t&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=e,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=false,e&&(this._generateDepthBuffer=true,this._generateStencilBuffer=this._depthStencilTextureWithStencil=Ca(e.format));}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){return this._textures?.[0]??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(e){if(!this._textures)return  -1;const t=this._textures[e],i=this._layerIndices?.[e]??0,s=this._faceIndices?.[e]??0;return t.isCube?6*i+s:t.is3D?0:i}get samples(){return this._samples}setSamples(e,t=true,i=false){if(this.samples===e&&!i)return e;const s=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,s}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this);}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,true),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this);}constructor(e,t,i,s,r){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=false,this._generateDepthBuffer=false,this._depthStencilTextureWithStencil=false,this.disableAutomaticMSAAResolve=false,this.resolveMSAAColors=true,this.resolveMSAADepth=false,this.resolveMSAAStencil=false,this.depthReadOnly=false,this.stencilReadOnly=false,this._isMulti=e,this._isCube=t,this._size=i,this._engine=s,this._depthStencilTexture=null,this.label=r;}setTextures(e){Array.isArray(e)?this._textures=e:this._textures=e?[e]:null;}setTexture(e,t=0,i=true){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e);}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t;}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==t&&t>=0&&(this._layerIndices[e]=t),void 0!==i&&i>=0&&(this._faceIndices[e]=i);}createDepthStencilTexture(e=0,t=true,i=false,s=1,r=Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT,n){return this._depthStencilTexture?.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTextureLabel=n,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:s,depthTextureFormat:r,label:n},this),this._depthStencilTexture}_shareDepth(e){this.shareDepth(e);}shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,e._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences());}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(true);}_cloneRenderTargetWrapper(){let e=null;if(this._isMulti){const t=this.textures;if(t&&t.length>0){let i=false,s=t.length,r=-1;const n=t[t.length-1]._source;14!==n&&12!==n||(i=true,r=t[t.length-1].format,s--);const a=[],o=[],h=[],l=[],c=[],u=[],d=[],_={};for(let e=0;e<s;++e){const i=t[e];a.push(i.samplingMode),o.push(i.type),h.push(i.format);void 0!==_[i.uniqueId]?(l.push(-1),d.push(0)):(_[i.uniqueId]=e,i.is2DArray?(l.push(Qe$1.TEXTURE_2D_ARRAY),d.push(i.depth)):i.isCube?(l.push(Qe$1.TEXTURE_CUBE_MAP),d.push(0)):i.is3D?(l.push(Qe$1.TEXTURE_3D),d.push(i.depth)):(l.push(Qe$1.TEXTURE_2D),d.push(0))),this._faceIndices&&c.push(this._faceIndices[e]??0),this._layerIndices&&u.push(this._layerIndices[e]??0);}const f={samplingModes:a,generateMipMaps:t[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:i,depthTextureFormat:r,types:o,formats:h,textureCount:s,targetTypes:l,faceIndex:c,layerIndex:u,layerCounts:d,label:this.label},p={width:this.width,height:this.height,depth:this.depth};e=this._engine.createMultipleRenderTarget(p,f);for(let i=0;i<s;++i){if(-1!==l[i])continue;const s=_[t[i].uniqueId];e.setTexture(e.textures[s],i);}}}else {const t={};if(t.generateDepthBuffer=this._generateDepthBuffer,t.generateMipMaps=this.texture?.generateMipMaps??false,t.generateStencilBuffer=this._generateStencilBuffer,t.samplingMode=this.texture?.samplingMode,t.type=this.texture?.type,t.format=this.texture?.format,t.noColorAttachment=!this._textures,t.label=this.label,this.isCube)e=this._engine.createRenderTargetCubeTexture(this.width,t);else {const i={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?this.texture?.depth:void 0};e=this._engine.createRenderTargetTexture(i,t);}e.texture&&(e.texture.isReady=true);}return e}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],false),e._textures[t].isReady=true;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=true),this._textures=null,this._depthStencilTexture=null;}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=this._depthStencilTexture.format,s=t===Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE||t===Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE||t===Qe$1.TEXTURE_LINEAR_LINEAR_MIPNEAREST;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,s,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,i,this._depthStencilTextureLabel);}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose();}}releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;++e)this._textures[e].dispose();this._textures=null;}dispose(e=false){e||(this._depthStencilTexture?.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this);}}class Ua extends Ba{setDepthStencilTexture(e,t=true){if(super.setDepthStencilTexture(e,t),!e)return;const i=this._engine,s=this._context,r=e._hardwareTexture;if(r&&e._autoMSAAManagement&&this._MSAAFramebuffer){const t=i._currentFramebuffer;i._bindUnboundFramebuffer(this._MSAAFramebuffer),s.framebufferRenderbuffer(s.FRAMEBUFFER,Ca(e.format)?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT,s.RENDERBUFFER,r.getMSAARenderBuffer()),i._bindUnboundFramebuffer(t);}}constructor(e,t,i,s,r){super(e,t,i,s),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=false,this._currentLOD=0,this._context=r;}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=true):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null;}createDepthStencilTexture(e=0,t=true,i=false,s=1,r=Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT,n){if(this._depthStencilBuffer){const e=this._engine,t=e._currentFramebuffer,i=this._context;e._bindUnboundFramebuffer(this._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),e._bindUnboundFramebuffer(t),i.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null;}return super.createDepthStencilTexture(e,t,i,s,r,n)}shareDepth(e){super.shareDepth(e);const t=this._context,i=this._depthStencilBuffer,s=e._MSAAFramebuffer||e._framebuffer,r=this._engine;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;const n=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;r._bindUnboundFramebuffer(s),t.framebufferRenderbuffer(t.FRAMEBUFFER,n,t.RENDERBUFFER,i),r._bindUnboundFramebuffer(null);}_bindTextureRenderTarget(e,t=0,i,s=0){const r=e._hardwareTexture;if(!r)return;const n=this._framebuffer,a=this._engine,o=a._currentFramebuffer;let h;if(a._bindUnboundFramebuffer(n),a.webGLVersion>1){const n=this._context;h=n["COLOR_ATTACHMENT"+t],e.is2DArray||e.is3D?(i=i??this.layerIndices?.[t]??0,n.framebufferTextureLayer(n.FRAMEBUFFER,h,r.underlyingResource,s,i)):e.isCube?(i=i??this.faceIndices?.[t]??0,n.framebufferTexture2D(n.FRAMEBUFFER,h,n.TEXTURE_CUBE_MAP_POSITIVE_X+i,r.underlyingResource,s)):n.framebufferTexture2D(n.FRAMEBUFFER,h,n.TEXTURE_2D,r.underlyingResource,s);}else {const e=this._context;h=e["COLOR_ATTACHMENT"+t+"_WEBGL"];const n=void 0!==i?e.TEXTURE_CUBE_MAP_POSITIVE_X+i:e.TEXTURE_2D;e.framebufferTexture2D(e.FRAMEBUFFER,h,n,r.underlyingResource,s);}if(e._autoMSAAManagement&&this._MSAAFramebuffer){const e=this._context;a._bindUnboundFramebuffer(this._MSAAFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,h,e.RENDERBUFFER,r.getMSAARenderBuffer());}a._bindUnboundFramebuffer(o);}setTexture(e,t=0,i=true){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t);}setLayerAndFaceIndices(e,t){if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const i=this._attachments?.length??this.textures.length;for(let e=0;e<i;e++){const t=this.textures[e];t&&(t.is2DArray||t.is3D?this._bindTextureRenderTarget(t,e,this.layerIndices[e]):t.isCube?this._bindTextureRenderTarget(t,e,this.faceIndices[e]):this._bindTextureRenderTarget(t,e));}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const s=this.textures[e];s.is2DArray||s.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):s.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e]);}resolveMSAATextures(){const e=this._engine,t=e._currentFramebuffer;e._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),e._bindUnboundFramebuffer(t);}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e);}}jt.prototype.createDepthStencilTexture=function(e,t,i){if(t.isCube){const i=e.width||e;return this._createDepthStencilCubeTexture(i,t)}return this._createDepthStencilTexture(e,t,i)},Pa.prototype._createHardwareRenderTargetWrapper=function(e,t,i){const s=new Ua(e,t,i,this,this._gl);return this._renderTargetWrapperCache.push(s),s},Pa.prototype.createRenderTargetTexture=function(e,t){const i=this._createHardwareRenderTargetWrapper(false,false,e);let s,r,n=true,a=false,o=false,h=1;void 0!==t&&"object"==typeof t&&(n=t.generateDepthBuffer??true,a=!!t.generateStencilBuffer,o=!!t.noColorAttachment,s=t.colorAttachment,h=t.samples??1,r=t.label);const l=s||(o?null:this._createInternalTexture(e,t,true,5)),c=e.width||e,u=e.height||e,d=this._currentFramebuffer,_=this._gl,f=_.createFramebuffer();if(this._bindUnboundFramebuffer(f),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(a,n,c,u),!l||l.is2DArray||l.is3D||_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,l._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(d),i.label=r??"RenderTargetWrapper",i._framebuffer=f,i._generateDepthBuffer=n,i._generateStencilBuffer=a,i.setTextures(l),s){if(i._samples=s.samples,s.samples>1){const e=s._hardwareTexture.getMSAARenderBuffer(0);i._MSAAFramebuffer=_.createFramebuffer(),this._bindUnboundFramebuffer(i._MSAAFramebuffer),_.framebufferRenderbuffer(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.RENDERBUFFER,e),this._bindUnboundFramebuffer(null);}}else this.updateRenderTargetTextureSampleCount(i,h);return i},Pa.prototype._createDepthStencilTexture=function(e,t,i){const s=this._gl,r=e.layers||0,n=e.depth||0;let a=s.TEXTURE_2D;0!==r?a=s.TEXTURE_2D_ARRAY:0!==n&&(a=s.TEXTURE_3D);const o=new zt(this,12);if(o.label=t.label,!this._caps.depthTextureExtension)return Ie$2.Error("Depth texture is not supported by your browser or hardware."),o;const h={bilinearFiltering:false,comparisonFunction:0,generateStencil:false,...t};if(this._bindTextureDirectly(a,o,true),this._setupDepthStencilTexture(o,e,0!==h.comparisonFunction&&h.bilinearFiltering,h.comparisonFunction,h.samples),void 0!==h.depthTextureFormat){if(h.depthTextureFormat!==Qe$1.TEXTUREFORMAT_DEPTH16&&h.depthTextureFormat!==Qe$1.TEXTUREFORMAT_DEPTH24&&h.depthTextureFormat!==Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8&&h.depthTextureFormat!==Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8&&h.depthTextureFormat!==Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT&&h.depthTextureFormat!==Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8)return Ie$2.Error(`Depth texture ${h.depthTextureFormat} format is not supported.`),o;o.format=h.depthTextureFormat;}else o.format=h.generateStencil?Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:Qe$1.TEXTUREFORMAT_DEPTH24;const l=Ca(o.format),c=this._getWebGLTextureTypeFromDepthTextureFormat(o.format),u=l?s.DEPTH_STENCIL:s.DEPTH_COMPONENT,d=this._getInternalFormatFromDepthTextureFormat(o.format,true,l);return o.is2DArray?s.texImage3D(a,0,d,o.width,o.height,r,0,u,c,null):o.is3D?s.texImage3D(a,0,d,o.width,o.height,n,0,u,c,null):s.texImage2D(a,0,d,o.width,o.height,0,u,c,null),this._bindTextureDirectly(a,null),this._internalTexturesCache.push(o),i._depthStencilBuffer&&(s.deleteRenderbuffer(i._depthStencilBuffer),i._depthStencilBuffer=null),this._bindUnboundFramebuffer(i._MSAAFramebuffer??i._framebuffer),i._generateStencilBuffer=l,i._depthStencilTextureWithStencil=l,i._depthStencilBuffer=this._setupFramebufferDepthAttachments(i._generateStencilBuffer,i._generateDepthBuffer,i.width,i.height,i.samples,o.format),this._bindUnboundFramebuffer(null),o},Pa.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;const i=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(i.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(i.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const s=e.texture?._hardwareTexture;if(s?.releaseMSAARenderBuffers(),e.texture&&t>1&&"function"==typeof i.renderbufferStorageMultisample){const r=i.createFramebuffer();if(!r)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=r,this._bindUnboundFramebuffer(e._MSAAFramebuffer);const n=this._createRenderBuffer(e.texture.width,e.texture.height,t,-1,this._getRGBABufferInternalSizedFormat(e.texture.type,e.texture.format,e.texture._useSRGBBuffer),i.COLOR_ATTACHMENT0,false);if(!n)throw new Error("Unable to create multi sampled framebuffer");s?.addMSAARenderBuffer(n);}this._bindUnboundFramebuffer(e._MSAAFramebuffer??e._framebuffer),e.texture&&(e.texture.samples=t),e._samples=t;const r=e._depthStencilTexture?e._depthStencilTexture.format:void 0;return e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t,r),this._bindUnboundFramebuffer(null),t},Pa.prototype._setupDepthStencilTexture=function(e,t,i,s,r=1){const n=t.width??t,a=t.height??t,o=t.layers||0,h=t.depth||0;e.baseWidth=n,e.baseHeight=a,e.width=n,e.height=a,e.is2DArray=o>0,e.depth=o||h,e.isReady=true,e.samples=r,e.generateMipMaps=false,e.samplingMode=i?Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,e.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,e._comparisonFunction=s;const l=this._gl,c=this._getTextureTarget(e),u=this._getSamplingParameters(e.samplingMode,false);l.texParameteri(c,l.TEXTURE_MAG_FILTER,u.mag),l.texParameteri(c,l.TEXTURE_MIN_FILTER,u.min),l.texParameteri(c,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(c,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===s?(l.texParameteri(c,l.TEXTURE_COMPARE_FUNC,Qe$1.LEQUAL),l.texParameteri(c,l.TEXTURE_COMPARE_MODE,l.NONE)):(l.texParameteri(c,l.TEXTURE_COMPARE_FUNC,s),l.texParameteri(c,l.TEXTURE_COMPARE_MODE,l.COMPARE_REF_TO_TEXTURE)));},Pa.prototype.setDepthStencilTexture=function(e,t,i,s){ void 0!==e&&(t&&(this._boundUniforms[e]=t),i&&i.depthStencilTexture?this._setTexture(e,i,false,true,s):this._setTexture(e,null,void 0,void 0,s));},Pa.prototype.createRenderTargetCubeTexture=function(e,t){const i=this._createHardwareRenderTargetWrapper(false,true,e),s={generateMipMaps:true,generateDepthBuffer:true,generateStencilBuffer:false,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,samplingMode:Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,format:Qe$1.TEXTUREFORMAT_RGBA,...t};s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,(s.type!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering)&&(s.type!==Qe$1.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering)||(s.samplingMode=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE);const r=this._gl,n=new zt(this,5);this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,n,true);const a=this._getSamplingParameters(s.samplingMode,s.generateMipMaps);s.type!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloat||(s.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,Ie$2.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,a.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,a.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);for(let t=0;t<6;t++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),e,e,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null);const o=r.createFramebuffer();return this._bindUnboundFramebuffer(o),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(s.generateStencilBuffer,s.generateDepthBuffer,e,e),s.generateMipMaps&&r.generateMipmap(r.TEXTURE_CUBE_MAP),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),i._framebuffer=o,i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=s.generateStencilBuffer,n.width=e,n.height=e,n.isReady=true,n.isCube=true,n.samples=1,n.generateMipMaps=s.generateMipMaps,n.samplingMode=s.samplingMode,n.type=s.type,n.format=s.format,this._internalTexturesCache.push(n),i.setTextures(n),i};const ka=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],Ga=[()=>1,e=>e.y,e=>e.z,e=>e.x,e=>e.x*e.y,e=>e.y*e.z,e=>3*e.z*e.z-1,e=>e.x*e.z,e=>e.x*e.x-e.y*e.y],Va=(e,t)=>ka[e]*Ga[e](t),Ha=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class za{constructor(){this.preScaled=false,this.l00=te$4.Zero(),this.l1_1=te$4.Zero(),this.l10=te$4.Zero(),this.l11=te$4.Zero(),this.l2_2=te$4.Zero(),this.l2_1=te$4.Zero(),this.l20=te$4.Zero(),this.l21=te$4.Zero(),this.l22=te$4.Zero();}addLight(e,t,i){ae$5.Vector3[0].set(t.r,t.g,t.b);const s=ae$5.Vector3[0],r=ae$5.Vector3[1];s.scaleToRef(i,r),r.scaleToRef(Va(0,e),ae$5.Vector3[2]),this.l00.addInPlace(ae$5.Vector3[2]),r.scaleToRef(Va(1,e),ae$5.Vector3[2]),this.l1_1.addInPlace(ae$5.Vector3[2]),r.scaleToRef(Va(2,e),ae$5.Vector3[2]),this.l10.addInPlace(ae$5.Vector3[2]),r.scaleToRef(Va(3,e),ae$5.Vector3[2]),this.l11.addInPlace(ae$5.Vector3[2]),r.scaleToRef(Va(4,e),ae$5.Vector3[2]),this.l2_2.addInPlace(ae$5.Vector3[2]),r.scaleToRef(Va(5,e),ae$5.Vector3[2]),this.l2_1.addInPlace(ae$5.Vector3[2]),r.scaleToRef(Va(6,e),ae$5.Vector3[2]),this.l20.addInPlace(ae$5.Vector3[2]),r.scaleToRef(Va(7,e),ae$5.Vector3[2]),this.l21.addInPlace(ae$5.Vector3[2]),r.scaleToRef(Va(8,e),ae$5.Vector3[2]),this.l22.addInPlace(ae$5.Vector3[2]);}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e);}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(Ha[0]),this.l1_1.scaleInPlace(Ha[1]),this.l10.scaleInPlace(Ha[2]),this.l11.scaleInPlace(Ha[3]),this.l2_2.scaleInPlace(Ha[4]),this.l2_1.scaleInPlace(Ha[5]),this.l20.scaleInPlace(Ha[6]),this.l21.scaleInPlace(Ha[7]),this.l22.scaleInPlace(Ha[8]);}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI);}preScaleForRendering(){this.preScaled=true,this.l00.scaleInPlace(ka[0]),this.l1_1.scaleInPlace(ka[1]),this.l10.scaleInPlace(ka[2]),this.l11.scaleInPlace(ka[3]),this.l2_2.scaleInPlace(ka[4]),this.l2_1.scaleInPlace(ka[5]),this.l20.scaleInPlace(ka[6]),this.l21.scaleInPlace(ka[7]),this.l22.scaleInPlace(ka[8]);}updateFromArray(e){return te$4.FromArrayToRef(e[0],0,this.l00),te$4.FromArrayToRef(e[1],0,this.l1_1),te$4.FromArrayToRef(e[2],0,this.l10),te$4.FromArrayToRef(e[3],0,this.l11),te$4.FromArrayToRef(e[4],0,this.l2_2),te$4.FromArrayToRef(e[5],0,this.l2_1),te$4.FromArrayToRef(e[6],0,this.l20),te$4.FromArrayToRef(e[7],0,this.l21),te$4.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return te$4.FromFloatsToRef(e[0],e[1],e[2],this.l00),te$4.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),te$4.FromFloatsToRef(e[6],e[7],e[8],this.l10),te$4.FromFloatsToRef(e[9],e[10],e[11],this.l11),te$4.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),te$4.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),te$4.FromFloatsToRef(e[18],e[19],e[20],this.l20),te$4.FromFloatsToRef(e[21],e[22],e[23],this.l21),te$4.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return (new za).updateFromArray(e)}static FromPolynomial(e){const t=new za;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class Xa{constructor(){this.x=te$4.Zero(),this.y=te$4.Zero(),this.z=te$4.Zero(),this.xx=te$4.Zero(),this.yy=te$4.Zero(),this.zz=te$4.Zero(),this.xy=te$4.Zero(),this.yz=te$4.Zero(),this.zx=te$4.Zero();}get preScaledHarmonics(){return this._harmonics||(this._harmonics=za.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){ae$5.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=ae$5.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t);}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e);}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),ae$5.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),ae$5.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(ae$5.Vector3[0]).addInPlace(ae$5.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(ae$5.Vector3[0]).subtractInPlace(ae$5.Vector3[1]),this.zz.copyFrom(e.l00),ae$5.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(ae$5.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return (new Xa).updateFromHarmonics(e)}static FromArray(e){const t=new Xa;return te$4.FromArrayToRef(e[0],0,t.x),te$4.FromArrayToRef(e[1],0,t.y),te$4.FromArrayToRef(e[2],0,t.z),te$4.FromArrayToRef(e[3],0,t.xx),te$4.FromArrayToRef(e[4],0,t.yy),te$4.FromArrayToRef(e[5],0,t.zz),te$4.FromArrayToRef(e[6],0,t.yz),te$4.FromArrayToRef(e[7],0,t.zx),te$4.FromArrayToRef(e[8],0,t.xy),t}}function Wa(e,t,i){e._onCanvasFocus=()=>{e.onCanvasFocusObservable.notifyObservers(e);},e._onCanvasBlur=()=>{e.onCanvasBlurObservable.notifyObservers(e);},e._onCanvasContextMenu=t=>{e.disableContextMenu&&t.preventDefault();},t.addEventListener("focus",e._onCanvasFocus),t.addEventListener("blur",e._onCanvasBlur),t.addEventListener("contextmenu",e._onCanvasContextMenu),e._onBlur=()=>{e.disablePerformanceMonitorInBackground&&e.performanceMonitor.disable(),e._windowIsBackground=true;},e._onFocus=()=>{e.disablePerformanceMonitorInBackground&&e.performanceMonitor.enable(),e._windowIsBackground=false;},e._onCanvasPointerOut=i=>{document.elementFromPoint(i.clientX,i.clientY)!==t&&e.onCanvasPointerOutObservable.notifyObservers(i);};const s=e.getHostWindow();s&&"function"==typeof s.addEventListener&&(s.addEventListener("blur",e._onBlur),s.addEventListener("focus",e._onFocus)),t.addEventListener("pointerout",e._onCanvasPointerOut),i.doNotHandleTouchAction||function(e){e&&e.setAttribute&&(e.setAttribute("touch-action","none"),e.style.touchAction="none",e.style.webkitTapHighlightColor="transparent");}(t),!jt.audioEngine&&i.audioEngine&&jt.AudioEngineFactory&&(jt.audioEngine=jt.AudioEngineFactory(e.getRenderingCanvas(),e.getAudioContext(),e.getAudioDestination())),Me$3()&&(e._onFullscreenChange=()=>{e.isFullscreen=!!document.fullscreenElement,e.isFullscreen&&e._pointerLockRequested&&t&&Ja(t);},document.addEventListener("fullscreenchange",e._onFullscreenChange,false),document.addEventListener("webkitfullscreenchange",e._onFullscreenChange,false),e._onPointerLockChange=()=>{e.isPointerLock=document.pointerLockElement===t;},document.addEventListener("pointerlockchange",e._onPointerLockChange,false),document.addEventListener("webkitpointerlockchange",e._onPointerLockChange,false)),e.enableOfflineSupport=void 0!==jt.OfflineProviderFactory,e._deterministicLockstep=!!i.deterministicLockstep,e._lockstepMaxSteps=i.lockstepMaxSteps||0,e._timeStep=i.timeStep||1/60;}function Ya(e,t){1===L$7.Instances.length&&jt.audioEngine&&(jt.audioEngine.dispose(),jt.audioEngine=null);const i=e.getHostWindow();i&&"function"==typeof i.removeEventListener&&(i.removeEventListener("blur",e._onBlur),i.removeEventListener("focus",e._onFocus)),t&&(t.removeEventListener("focus",e._onCanvasFocus),t.removeEventListener("blur",e._onCanvasBlur),t.removeEventListener("pointerout",e._onCanvasPointerOut),t.removeEventListener("contextmenu",e._onCanvasContextMenu)),Me$3()&&(document.removeEventListener("fullscreenchange",e._onFullscreenChange),document.removeEventListener("mozfullscreenchange",e._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",e._onFullscreenChange),document.removeEventListener("msfullscreenchange",e._onFullscreenChange),document.removeEventListener("pointerlockchange",e._onPointerLockChange),document.removeEventListener("mspointerlockchange",e._onPointerLockChange),document.removeEventListener("mozpointerlockchange",e._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",e._onPointerLockChange));}function Ka(e){const t=document.createElement("span");t.textContent="Hg",t.style.font=e;const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const s=document.createElement("div");s.style.whiteSpace="nowrap",s.appendChild(t),s.appendChild(i),document.body.appendChild(s);let r=0,n=0;try{n=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",r=i.getBoundingClientRect().top-t.getBoundingClientRect().top;}finally{document.body.removeChild(s);}return {ascent:r,height:n,descent:n-r}}async function ja(e,t,i){return await new Promise(((s,r)=>{const n=new Image;n.onload=()=>{n.decode().then((()=>{e.createImageBitmap(n,i).then((e=>{s(e);}));}));},n.onerror=()=>{r(`Error loading image ${n.src}`);},n.src=t;}))}function Qa(e,t,i,s){const r=e.createCanvas(i,s).getContext("2d");if(!r)throw new Error("Unable to get 2d context for resizeImageBitmap");r.drawImage(t,0,0);return r.getImageData(0,0,i,s).data}function qa(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e);}function Za(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen();}function Ja(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then((()=>{e.focus();})).catch((()=>{})):e.focus();}}function $a(){document.exitPointerLock&&document.exitPointerLock();}Pa.prototype.createPrefilteredCubeTexture=function(e,t,i,s,r=null,n=null,a,o=null,h=true){return this.createCubeTexture(e,t,null,false,(async e=>{if(!e)return void(r&&r(null));const n=e.texture;if(h?e.info.sphericalPolynomial&&(n._sphericalPolynomial=e.info.sphericalPolynomial):n._sphericalPolynomial=new Xa,n._source=9,this.getCaps().textureLOD)return void(r&&r(n));const a=this._gl,o=e.width;if(!o)return;const{DDSTools:l}=await Promise.resolve().then(function(){return ddsCfX3qFhI_esm_min}),c=[];for(let r=0;r<3;r++){const h=1-r/2,u=s,d=Math.log2(o)*i+s,_=u+(d-u)*h,f=Math.round(Math.min(Math.max(_,0),d)),p=new zt(this,2);if(p.type=n.type,p.format=n.format,p.width=Math.pow(2,Math.max(Math.log2(o)-f,0)),p.height=p.width,p.isCube=true,p._cachedWrapU=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,p._cachedWrapV=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,p,true),p.samplingMode=Qe$1.TEXTURE_LINEAR_LINEAR,a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),e.isDDS){const t=e.info,i=e.data;this._unpackFlipY(t.isCompressed),l.UploadDDSLevels(this,p,i,t,true,6,f);}else Ie$2.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null);const g=new Ms(t);g._isCube=true,g._texture=p,p.isReady=true,c.push(g);}n._lodTextureHigh=c[2],n._lodTextureMid=c[1],n._lodTextureLow=c[0],r&&r(n);}),n,a,o,h,i,s)},Pa.prototype.createUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create uniform buffer");const s=new xa(i);return this.bindUniformBuffer(s),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),s.references=1,s},Pa.prototype.createDynamicUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create dynamic uniform buffer");const s=new xa(i);return this.bindUniformBuffer(s),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),s.references=1,s},Pa.prototype.updateUniformBuffer=function(e,t,i,s){this.bindUniformBuffer(e),void 0===i&&(i=0),void 0===s?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(i,i+s)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(i,i+s)),this.bindUniformBuffer(null);},Pa.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null);},Pa.prototype.bindUniformBufferBase=function(e,t,i){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null);},Pa.prototype.bindUniformBlock=function(e,t,i){const s=e.program,r=this._gl.getUniformBlockIndex(s,t);4294967295!==r&&this._gl.uniformBlockBinding(s,r,i);},jt.prototype.displayLoadingUI=function(){if(!Se$2())return;const e=this.loadingScreen;e&&e.displayLoadingUI();},jt.prototype.hideLoadingUI=function(){if(!Se$2())return;const e=this._loadingScreen;e&&e.hideLoadingUI();},Object.defineProperty(jt.prototype,"loadingScreen",{get:function(){return !this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=jt.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(e){this._loadingScreen=e;},enumerable:true,configurable:true}),Object.defineProperty(jt.prototype,"loadingUIText",{set:function(e){this.loadingScreen.loadingUIText=e;},enumerable:true,configurable:true}),Object.defineProperty(jt.prototype,"loadingUIBackgroundColor",{set:function(e){this.loadingScreen.loadingUIBackgroundColor=e;},enumerable:true,configurable:true}),jt.prototype.getInputElement=function(){return this._renderingCanvas},jt.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},jt.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},jt.prototype.getAspectRatio=function(e,t=false){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)},jt.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(true)/this.getRenderHeight(true)},jt.prototype._verifyPointerLock=function(){this._onPointerLockChange?.();},jt.prototype.setAlphaEquation=function(e,t=0){if(this._alphaEquation[t]!==e){switch(e){case Qe$1.ALPHA_EQUATION_ADD:this._alphaState.setAlphaEquationParameters(Qe$1.GL_ALPHA_EQUATION_ADD,Qe$1.GL_ALPHA_EQUATION_ADD,t);break;case Qe$1.ALPHA_EQUATION_SUBSTRACT:this._alphaState.setAlphaEquationParameters(Qe$1.GL_ALPHA_EQUATION_SUBTRACT,Qe$1.GL_ALPHA_EQUATION_SUBTRACT,t);break;case Qe$1.ALPHA_EQUATION_REVERSE_SUBTRACT:this._alphaState.setAlphaEquationParameters(Qe$1.GL_ALPHA_EQUATION_REVERSE_SUBTRACT,Qe$1.GL_ALPHA_EQUATION_REVERSE_SUBTRACT,t);break;case Qe$1.ALPHA_EQUATION_MAX:this._alphaState.setAlphaEquationParameters(Qe$1.GL_ALPHA_EQUATION_MAX,Qe$1.GL_ALPHA_EQUATION_MAX,t);break;case Qe$1.ALPHA_EQUATION_MIN:this._alphaState.setAlphaEquationParameters(Qe$1.GL_ALPHA_EQUATION_MIN,Qe$1.GL_ALPHA_EQUATION_MIN,t);break;case Qe$1.ALPHA_EQUATION_DARKEN:this._alphaState.setAlphaEquationParameters(Qe$1.GL_ALPHA_EQUATION_MIN,Qe$1.GL_ALPHA_EQUATION_ADD,t);}this._alphaEquation[t]=e;}},jt.prototype.getInputElement=function(){return this._renderingCanvas},jt.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},jt.prototype.setDepthFunction=function(e){this._depthCullingState.depthFunc=e;},jt.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(Qe$1.GREATER);},jt.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(Qe$1.GEQUAL);},jt.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(Qe$1.LESS);},jt.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(Qe$1.LEQUAL);},jt.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},jt.prototype.setDepthWrite=function(e){this._depthCullingState.depthMask=e;},jt.prototype.setAlphaConstants=function(e,t,i,s){this._alphaState.setAlphaBlendConstants(e,t,i,s);},jt.prototype.getAlphaMode=function(e=0){return this._alphaMode[e]},jt.prototype.getAlphaEquation=function(e=0){return this._alphaEquation[e]},jt.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},jt.prototype.setStencilBuffer=function(e){this._stencilState.stencilTest=e;},jt.prototype.getStencilMask=function(){return this._stencilState.stencilMask},jt.prototype.setStencilMask=function(e){this._stencilState.stencilMask=e;},jt.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},jt.prototype.getStencilBackFunction=function(){return this._stencilState.stencilBackFunc},jt.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},jt.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},jt.prototype.setStencilFunction=function(e){this._stencilState.stencilFunc=e;},jt.prototype.setStencilBackFunction=function(e){this._stencilState.stencilBackFunc=e;},jt.prototype.setStencilFunctionReference=function(e){this._stencilState.stencilFuncRef=e;},jt.prototype.setStencilFunctionMask=function(e){this._stencilState.stencilFuncMask=e;},jt.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},jt.prototype.getStencilBackOperationFail=function(){return this._stencilState.stencilBackOpStencilFail},jt.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},jt.prototype.getStencilBackOperationDepthFail=function(){return this._stencilState.stencilBackOpDepthFail},jt.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},jt.prototype.getStencilBackOperationPass=function(){return this._stencilState.stencilBackOpStencilDepthPass},jt.prototype.setStencilOperationFail=function(e){this._stencilState.stencilOpStencilFail=e;},jt.prototype.setStencilBackOperationFail=function(e){this._stencilState.stencilBackOpStencilFail=e;},jt.prototype.setStencilOperationDepthFail=function(e){this._stencilState.stencilOpDepthFail=e;},jt.prototype.setStencilBackOperationDepthFail=function(e){this._stencilState.stencilBackOpDepthFail=e;},jt.prototype.setStencilOperationPass=function(e){this._stencilState.stencilOpStencilDepthPass=e;},jt.prototype.setStencilBackOperationPass=function(e){this._stencilState.stencilBackOpStencilDepthPass=e;},jt.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference();},jt.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference);},jt.prototype.getRenderPassNames=function(){return this._renderPassNames},jt.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},jt.prototype.createRenderPassId=function(e){const t=++jt._RenderPassIdCounter;return this._renderPassNames[t]=e??"NONAME",t},jt.prototype.releaseRenderPassId=function(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let t=0;t<i.meshes.length;++t){const s=i.meshes[t];if(s.subMeshes)for(let t=0;t<s.subMeshes.length;++t){s.subMeshes[t]._removeDrawWrapper(e);}}}};class eo extends Pa{static get NpmPackage(){return jt.NpmPackage}static get Version(){return jt.Version}static get Instances(){return L$7.Instances}static get LastCreatedEngine(){return L$7.LastCreatedEngine}static get LastCreatedScene(){return L$7.LastCreatedScene}static DefaultLoadingScreenFactory(e){return jt.DefaultLoadingScreenFactory(e)}get _supportsHardwareTextureRescaling(){return !!eo._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0;}get performanceMonitor(){return this._performanceMonitor}constructor(e,t,i,s=false){super(e,t,i,s),this.customAnimationFrameRequester=null,this._performanceMonitor=new Da,this._drawCalls=new sa,e&&(this._features.supportRenderPasses=true,i=this._creationOptions);}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null;}_sharedInit(e){super._sharedInit(e),Wa(this,e,this._creationOptions);}resizeImageBitmap(e,t,i){return Qa(this,e,t,i)}async _createImageBitmapFromSource(e,t){return await ja(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e);}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&qa(this._renderingCanvas));}exitFullscreen(){this.isFullscreen&&Za();}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER);}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD);}setDirectViewport(e,t,i,s){const r=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,s),r}scissorClear(e,t,i,s,r){this.enableScissor(e,t,i,s),this.clear(r,true,true,true),this.disableScissor();}enableScissor(e,t,i,s){const r=this._gl;r.enable(r.SCISSOR_TEST),r.scissor(e,t,i,s);}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST);}async _loadFileAsync(e,t,i){return await new Promise(((s,r)=>{this._loadFile(e,(e=>{s(e);}),void 0,t,i,((e,t)=>{r(t);}));}))}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this);}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries();super._rebuildBuffers();}getFontOffset(e){return Ka(e)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID);}}else super._cancelFrame();}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()));}enterPointerlock(){this._renderingCanvas&&Ja(this._renderingCanvas);}exitPointerlock(){$a();}beginFrame(){this._measureFps(),super.beginFrame();}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e);}createShaderProgram(e,t,i,s,r,n=null){r=r||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=super.createShaderProgram(e,t,i,s,r,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),a}_createShaderProgram(e,t,i,s,r=null){const n=s.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");if(s.attachShader(n,t),s.attachShader(n,i),this.webGLVersion>1&&r){const t=this.createTransformFeedback();this.bindTransformFeedback(t),this.setTranformFeedbackVaryings(n,r),e.transformFeedback=t;}return s.linkProgram(n),this.webGLVersion>1&&r&&this.bindTransformFeedback(null),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_releaseTexture(e){super._releaseTexture(e);}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e);for(const t of this.scenes){for(const i of t.postProcesses)i._outputTexture===e&&(i._outputTexture=null);for(const i of t.cameras)for(const t of i._postProcesses)t&&t._outputTexture===e&&(t._outputTexture=null);}}_rescaleTexture(e,t,i,s,r){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const n=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:false,type:Qe$1.TEXTURETYPE_UNSIGNED_INT,samplingMode:Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,generateDepthBuffer:false,generateStencilBuffer:false});if(!this._rescalePostProcess&&eo._RescalePostProcessFactory&&(this._rescalePostProcess=eo._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=true;const a=()=>{this._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e);};let a=i;a||(a=this.scenes[this.scenes.length-1]),a.postProcessManager.directRender([this._rescalePostProcess],n,true),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,true),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,s,0,0,t.width,t.height,0),this.unBindFramebuffer(n),n.dispose(),r&&r();},o=this._rescalePostProcess.getEffect();o?o.executeWhenCompiled(a):this._rescalePostProcess.onEffectCreatedObservable.addOnce((e=>{e.executeWhenCompiled(a);}));}}wrapWebGLTexture(e,t=false,i=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,s=0,r=0){const n=new Ma(e,this._gl),a=new zt(this,0,true);return a._hardwareTexture=n,a.baseWidth=s,a.baseHeight=r,a.width=s,a.height=r,a.isReady=true,a.useMipMaps=t,this.updateTextureSamplingMode(i,a),a}_uploadImageToTexture(e,t,i=0,s=0){const r=this._gl,n=this._getWebGLTextureType(e.type),a=this._getInternalFormat(e.format),o=this._getRGBABufferInternalSizedFormat(e.type,a),h=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(h,e,true),this._unpackFlipY(e.invertY);let l=r.TEXTURE_2D;e.isCube&&(l=r.TEXTURE_CUBE_MAP_POSITIVE_X+i),r.texImage2D(l,s,o,a,n,t),this._bindTextureDirectly(h,null,true);}updateTextureComparisonFunction(e,t){if(1===this.webGLVersion)return void Ie$2.Error("WebGL 1 does not support texture comparison.");const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,true),0===t?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,Qe$1.LEQUAL),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,true),0===t?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,Qe$1.LEQUAL),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t;}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new xa(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e);}async _clientWaitAsync(e,t=0,i=10){const s=this._gl;return await new Promise(((r,n)=>{Rt$1((()=>{const i=s.clientWaitSync(e,t,0);if(i==s.WAIT_FAILED)throw new Error("clientWaitSync failed");return i!=s.TIMEOUT_EXPIRED}),r,n,i);}))}_readPixelsAsync(e,t,i,s,r,n,a){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const o=this._gl,h=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,h),o.bufferData(o.PIXEL_PACK_BUFFER,a.byteLength,o.STREAM_READ),o.readPixels(e,t,i,s,r,n,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null);const l=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);return l?(o.flush(),this._clientWaitAsync(l,0,10).then((()=>(o.deleteSync(l),o.bindBuffer(o.PIXEL_PACK_BUFFER,h),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,a),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteBuffer(h),a)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),Ya(this,this._renderingCanvas),super.dispose();}}eo.ALPHA_DISABLE=Qe$1.ALPHA_DISABLE,eo.ALPHA_ADD=Qe$1.ALPHA_ADD,eo.ALPHA_COMBINE=Qe$1.ALPHA_COMBINE,eo.ALPHA_SUBTRACT=Qe$1.ALPHA_SUBTRACT,eo.ALPHA_MULTIPLY=Qe$1.ALPHA_MULTIPLY,eo.ALPHA_MAXIMIZED=Qe$1.ALPHA_MAXIMIZED,eo.ALPHA_ONEONE=Qe$1.ALPHA_ONEONE,eo.ALPHA_PREMULTIPLIED=Qe$1.ALPHA_PREMULTIPLIED,eo.ALPHA_PREMULTIPLIED_PORTERDUFF=Qe$1.ALPHA_PREMULTIPLIED_PORTERDUFF,eo.ALPHA_INTERPOLATE=Qe$1.ALPHA_INTERPOLATE,eo.ALPHA_SCREENMODE=Qe$1.ALPHA_SCREENMODE,eo.DELAYLOADSTATE_NONE=Qe$1.DELAYLOADSTATE_NONE,eo.DELAYLOADSTATE_LOADED=Qe$1.DELAYLOADSTATE_LOADED,eo.DELAYLOADSTATE_LOADING=Qe$1.DELAYLOADSTATE_LOADING,eo.DELAYLOADSTATE_NOTLOADED=Qe$1.DELAYLOADSTATE_NOTLOADED,eo.NEVER=Qe$1.NEVER,eo.ALWAYS=Qe$1.ALWAYS,eo.LESS=Qe$1.LESS,eo.EQUAL=Qe$1.EQUAL,eo.LEQUAL=Qe$1.LEQUAL,eo.GREATER=Qe$1.GREATER,eo.GEQUAL=Qe$1.GEQUAL,eo.NOTEQUAL=Qe$1.NOTEQUAL,eo.KEEP=Qe$1.KEEP,eo.REPLACE=Qe$1.REPLACE,eo.INCR=Qe$1.INCR,eo.DECR=Qe$1.DECR,eo.INVERT=Qe$1.INVERT,eo.INCR_WRAP=Qe$1.INCR_WRAP,eo.DECR_WRAP=Qe$1.DECR_WRAP,eo.TEXTURE_CLAMP_ADDRESSMODE=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,eo.TEXTURE_WRAP_ADDRESSMODE=Qe$1.TEXTURE_WRAP_ADDRESSMODE,eo.TEXTURE_MIRROR_ADDRESSMODE=Qe$1.TEXTURE_MIRROR_ADDRESSMODE,eo.TEXTUREFORMAT_ALPHA=Qe$1.TEXTUREFORMAT_ALPHA,eo.TEXTUREFORMAT_LUMINANCE=Qe$1.TEXTUREFORMAT_LUMINANCE,eo.TEXTUREFORMAT_LUMINANCE_ALPHA=Qe$1.TEXTUREFORMAT_LUMINANCE_ALPHA,eo.TEXTUREFORMAT_RGB=Qe$1.TEXTUREFORMAT_RGB,eo.TEXTUREFORMAT_RGBA=Qe$1.TEXTUREFORMAT_RGBA,eo.TEXTUREFORMAT_RED=Qe$1.TEXTUREFORMAT_RED,eo.TEXTUREFORMAT_R=Qe$1.TEXTUREFORMAT_R,eo.TEXTUREFORMAT_R16_UNORM=Qe$1.TEXTUREFORMAT_R16_UNORM,eo.TEXTUREFORMAT_RG16_UNORM=Qe$1.TEXTUREFORMAT_RG16_UNORM,eo.TEXTUREFORMAT_RGB16_UNORM=Qe$1.TEXTUREFORMAT_RGB16_UNORM,eo.TEXTUREFORMAT_RGBA16_UNORM=Qe$1.TEXTUREFORMAT_RGBA16_UNORM,eo.TEXTUREFORMAT_R16_SNORM=Qe$1.TEXTUREFORMAT_R16_SNORM,eo.TEXTUREFORMAT_RG16_SNORM=Qe$1.TEXTUREFORMAT_RG16_SNORM,eo.TEXTUREFORMAT_RGB16_SNORM=Qe$1.TEXTUREFORMAT_RGB16_SNORM,eo.TEXTUREFORMAT_RGBA16_SNORM=Qe$1.TEXTUREFORMAT_RGBA16_SNORM,eo.TEXTUREFORMAT_RG=Qe$1.TEXTUREFORMAT_RG,eo.TEXTUREFORMAT_RED_INTEGER=Qe$1.TEXTUREFORMAT_RED_INTEGER,eo.TEXTUREFORMAT_R_INTEGER=Qe$1.TEXTUREFORMAT_R_INTEGER,eo.TEXTUREFORMAT_RG_INTEGER=Qe$1.TEXTUREFORMAT_RG_INTEGER,eo.TEXTUREFORMAT_RGB_INTEGER=Qe$1.TEXTUREFORMAT_RGB_INTEGER,eo.TEXTUREFORMAT_RGBA_INTEGER=Qe$1.TEXTUREFORMAT_RGBA_INTEGER,eo.TEXTURETYPE_UNSIGNED_BYTE=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,eo.TEXTURETYPE_UNSIGNED_INT=Qe$1.TEXTURETYPE_UNSIGNED_INT,eo.TEXTURETYPE_FLOAT=Qe$1.TEXTURETYPE_FLOAT,eo.TEXTURETYPE_HALF_FLOAT=Qe$1.TEXTURETYPE_HALF_FLOAT,eo.TEXTURETYPE_BYTE=Qe$1.TEXTURETYPE_BYTE,eo.TEXTURETYPE_SHORT=Qe$1.TEXTURETYPE_SHORT,eo.TEXTURETYPE_UNSIGNED_SHORT=Qe$1.TEXTURETYPE_UNSIGNED_SHORT,eo.TEXTURETYPE_INT=Qe$1.TEXTURETYPE_INT,eo.TEXTURETYPE_UNSIGNED_INTEGER=Qe$1.TEXTURETYPE_UNSIGNED_INTEGER,eo.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=Qe$1.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4,eo.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1,eo.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5,eo.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=Qe$1.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV,eo.TEXTURETYPE_UNSIGNED_INT_24_8=Qe$1.TEXTURETYPE_UNSIGNED_INT_24_8,eo.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=Qe$1.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV,eo.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=Qe$1.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV,eo.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=Qe$1.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV,eo.TEXTURE_NEAREST_SAMPLINGMODE=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,eo.TEXTURE_BILINEAR_SAMPLINGMODE=Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,eo.TEXTURE_TRILINEAR_SAMPLINGMODE=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,eo.TEXTURE_NEAREST_NEAREST_MIPLINEAR=Qe$1.TEXTURE_NEAREST_NEAREST_MIPLINEAR,eo.TEXTURE_LINEAR_LINEAR_MIPNEAREST=Qe$1.TEXTURE_LINEAR_LINEAR_MIPNEAREST,eo.TEXTURE_LINEAR_LINEAR_MIPLINEAR=Qe$1.TEXTURE_LINEAR_LINEAR_MIPLINEAR,eo.TEXTURE_NEAREST_NEAREST_MIPNEAREST=Qe$1.TEXTURE_NEAREST_NEAREST_MIPNEAREST,eo.TEXTURE_NEAREST_LINEAR_MIPNEAREST=Qe$1.TEXTURE_NEAREST_LINEAR_MIPNEAREST,eo.TEXTURE_NEAREST_LINEAR_MIPLINEAR=Qe$1.TEXTURE_NEAREST_LINEAR_MIPLINEAR,eo.TEXTURE_NEAREST_LINEAR=Qe$1.TEXTURE_NEAREST_LINEAR,eo.TEXTURE_NEAREST_NEAREST=Qe$1.TEXTURE_NEAREST_NEAREST,eo.TEXTURE_LINEAR_NEAREST_MIPNEAREST=Qe$1.TEXTURE_LINEAR_NEAREST_MIPNEAREST,eo.TEXTURE_LINEAR_NEAREST_MIPLINEAR=Qe$1.TEXTURE_LINEAR_NEAREST_MIPLINEAR,eo.TEXTURE_LINEAR_LINEAR=Qe$1.TEXTURE_LINEAR_LINEAR,eo.TEXTURE_LINEAR_NEAREST=Qe$1.TEXTURE_LINEAR_NEAREST,eo.TEXTURE_EXPLICIT_MODE=Qe$1.TEXTURE_EXPLICIT_MODE,eo.TEXTURE_SPHERICAL_MODE=Qe$1.TEXTURE_SPHERICAL_MODE,eo.TEXTURE_PLANAR_MODE=Qe$1.TEXTURE_PLANAR_MODE,eo.TEXTURE_CUBIC_MODE=Qe$1.TEXTURE_CUBIC_MODE,eo.TEXTURE_PROJECTION_MODE=Qe$1.TEXTURE_PROJECTION_MODE,eo.TEXTURE_SKYBOX_MODE=Qe$1.TEXTURE_SKYBOX_MODE,eo.TEXTURE_INVCUBIC_MODE=Qe$1.TEXTURE_INVCUBIC_MODE,eo.TEXTURE_EQUIRECTANGULAR_MODE=Qe$1.TEXTURE_EQUIRECTANGULAR_MODE,eo.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=Qe$1.TEXTURE_FIXED_EQUIRECTANGULAR_MODE,eo.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=Qe$1.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE,eo.SCALEMODE_FLOOR=Qe$1.SCALEMODE_FLOOR,eo.SCALEMODE_NEAREST=Qe$1.SCALEMODE_NEAREST,eo.SCALEMODE_CEILING=Qe$1.SCALEMODE_CEILING;var to=Object.freeze({__proto__:null,Engine:eo});class io extends Ea{_gatherImports(e,t){e?(this._webGPUReady=true,t.push(Promise.all([Promise.resolve().then(function(){return kernelBlur_fragmentDeDE4Pu__esm_min}),Promise.resolve().then(function(){return kernelBlur_vertexCLah75Pm_esm_min})]))):t.push(Promise.all([Promise.resolve().then(function(){return kernelBlur_fragmentBf2cC1eV_esm_min}),Promise.resolve().then(function(){return kernelBlur_vertexDnW06C5q_esm_min})]));}constructor(e,t=null,i,s,r){const n=!!r?.blockCompilation;super({...r,name:e,engine:t||eo.LastCreatedEngine,useShaderStore:true,useAsPostProcess:true,fragmentShader:io.FragmentUrl,uniforms:io.Uniforms,samplers:io.Samplers,vertexUrl:io.VertexUrl,blockCompilation:true}),this._packedFloat=false,this._staticDefines="",this.textureWidth=0,this.textureHeight=0,this._staticDefines=r?Array.isArray(r.defines)?r.defines.join("\n"):r.defines||"":"",this.options.blockCompilation=n,void 0!==i&&(this.direction=i),void 0!==s&&(this.kernel=s);}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.options.blockCompilation||this._updateParameters());}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this.options.blockCompilation||this._updateParameters());}get packedFloat(){return this._packedFloat}bind(e=false){super.bind(e),this._drawWrapper.effect.setFloat2("delta",1/this.textureWidth*this.direction.x,1/this.textureHeight*this.direction.y);}_updateParameters(e,t){const i=this._kernel,s=(i-1)/2;let r=[],n=[],a=0;for(let e=0;e<i;e++){const t=e/(i-1),o=this._gaussianWeight(2*t-1);r[e]=e-s,n[e]=o,a+=o;}for(let e=0;e<n.length;e++)n[e]/=a;const o=[],h=[],l=[];for(let e=0;e<=s;e+=2){const t=Math.min(e+1,Math.floor(s));if(e===t)l.push({o:r[e],w:n[e]});else {const i=t===s,a=n[e]+n[t]*(i?.5:1),o=r[e]+1/(1+n[e]/n[t]);0===o?(l.push({o:r[e],w:n[e]}),l.push({o:r[e+1],w:n[e+1]})):(l.push({o:o,w:a}),l.push({o:-o,w:a}));}}for(let e=0;e<l.length;e++)h[e]=l[e].o,o[e]=l[e].w;r=h,n=o;const c=this.options.engine.getCaps().maxVaryingVectors-(1===this.options.shaderLanguage?1:0),u=Math.max(c,0)-1;let d=Math.min(r.length,u),_="";_+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(_+=`#define CENTER_WEIGHT ${this._glslFloat(n[d-1])}\n`,d--);for(let e=0;e<d;e++)_+=`#define KERNEL_OFFSET${e} ${this._glslFloat(r[e])}\n`,_+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(n[e])}\n`;let f=0;for(let e=u;e<r.length;e++)_+=`#define KERNEL_DEP_OFFSET${f} ${this._glslFloat(r[e])}\n`,_+=`#define KERNEL_DEP_WEIGHT${f} ${this._glslFloat(n[e])}\n`,f++;this.packedFloat&&(_+="#define PACKEDFLOAT 1"),this.options.blockCompilation=false,this.updateEffect(_,null,null,{varyingCount:d,depCount:f},e,t);}_nearestBestKernel(e){const t=Math.round(e);for(const e of [t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){const t=1/3,i=-e*e/(2*t*t);return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(i)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}}io.VertexUrl="kernelBlur",io.FragmentUrl="kernelBlur",io.Uniforms=["delta","direction"],io.Samplers=["circleOfConfusionSampler"];class so extends Aa{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e;}set kernel(e){this._effectWrapper.kernel=e;}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e;}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return "BlurPostProcess"}constructor(e,t,i,s,r=null,n=Is.BILINEAR_SAMPLINGMODE,a,o,h=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,l="",c=false,u=Qe$1.TEXTUREFORMAT_RGBA){const d="number"==typeof s?c:!!s.blockCompilation,_={uniforms:io.Uniforms,samplers:io.Samplers,size:"number"==typeof s?s:void 0,camera:r,samplingMode:n,engine:a,reusable:o,textureType:h,vertexUrl:io.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:u,defines:l,...s,blockCompilation:true};super(e,io.FragmentUrl,{effectWrapper:"number"!=typeof s&&s.effectWrapper?void 0:new io(e,a,void 0,void 0,_),..._}),this._effectWrapper.options.blockCompilation=d,this.direction=t,this.onApplyObservable.add((()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height;})),this.kernel=i;}updateEffect(e=null,t=null,i=null,s,r,n){this._effectWrapper._updateParameters(r,n);}static _Parse(e,t,i,s){return Ae$3.Parse((()=>new so(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,false)),e,i,s)}}e$z([c$o()],so.prototype,"direction",null),e$z([a$$()],so.prototype,"kernel",null),e$z([a$$()],so.prototype,"packedFloat",null),P$9("BABYLON.BlurPostProcess",so);class ro{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null;}unBindMesh(){this._mesh=null;}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t);}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e);}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=false,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=true;const i=this._mesh.getScene();for(let e=0;e<i.meshes.length;e++){const s=i.meshes[e];if(s.material){if(s.computeBonesUsingShaders&&0!==s.numBoneInfluencers)if(s.material.getEffect()===t)s.computeBonesUsingShaders=false;else if(s.subMeshes)for(const e of s.subMeshes){if(e.effect===t){s.computeBonesUsingShaders=false;break}}}else !this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=false);}}else {const t=this._defines[this._currentRank];if(t)for(let i=0;i<t.length;i++)e=e.replace("#define "+t[i],"");this._currentRank++;}return e}}class no{get bias(){return this._bias}set bias(e){this._bias=e;}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e;}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses());}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses());}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses());}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses());}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e;}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===no.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=true);if(e===no.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=true);if(e===no.FILTER_PCF||e===no.FILTER_PCSS)return void(this.usePoissonSampling=true)}e!==no.FILTER_PCF&&e!==no.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=true;}get usePoissonSampling(){return this.filter===no.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(no.FILTER_POISSONSAMPLING);(e||this.filter===no.FILTER_POISSONSAMPLING)&&(this.filter=e?t:no.FILTER_NONE);}get useExponentialShadowMap(){return this.filter===no.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(no.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===no.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:no.FILTER_NONE);}get useBlurExponentialShadowMap(){return this.filter===no.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(no.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===no.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:no.FILTER_NONE);}get useCloseExponentialShadowMap(){return this.filter===no.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(no.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===no.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:no.FILTER_NONE);}get useBlurCloseExponentialShadowMap(){return this.filter===no.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(no.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===no.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:no.FILTER_NONE);}get usePercentageCloserFiltering(){return this.filter===no.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(no.FILTER_PCF);(e||this.filter===no.FILTER_PCF)&&(this.filter=e?t:no.FILTER_NONE);}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty());}get useContactHardeningShadow(){return this.filter===no.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(no.FILTER_PCSS);(e||this.filter===no.FILTER_PCSS)&&(this.filter=e?t:no.FILTER_NONE);}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e;}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e);}getDarkness(){return this._darkness}setDarkness(e){return this._darkness=e>=1?1:e<=0?0:e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e);}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return no.CLASSNAME}addShadowCaster(e,t=true){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(const t of e.getChildMeshes()) -1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=true){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(-1!==i&&this._shadowMap.renderList.splice(i,1),t)for(const t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap();}constructor(e,t,i,s,r,n=false){this.onBeforeShadowMapRenderObservable=new R$g,this.onAfterShadowMapRenderObservable=new R$g,this.onBeforeShadowMapRenderMeshObservable=new R$g,this.onAfterShadowMapRenderMeshObservable=new R$g,this.doNotSerialize=false,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=false,this._filter=no.FILTER_NONE,this._filteringQuality=no.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=false,this.enableSoftTransparentShadow=false,this.useOpacityTextureForTransparentShadow=false,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=false,this._lightDirection=te$4.Zero(),this._viewMatrix=re$5.Zero(),this._projectionMatrix=re$5.Zero(),this._transformMatrix=re$5.Zero(),this._cachedPosition=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=re$5.Identity(),this._shadersLoaded=false,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=s??null,this._useRedTextureType=!!r,this._initShaderSourceAsync(n);let a=t._shadowGenerators;a||(a=t._shadowGenerators=new Map),a.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),no._SceneComponentInitialization(this._scene);const o=this._scene.getEngine().getCaps();i?o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=Qe$1.TEXTURETYPE_FLOAT:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=Qe$1.TEXTURETYPE_HALF_FLOAT:this._textureType=Qe$1.TEXTURETYPE_UNSIGNED_BYTE:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=Qe$1.TEXTURETYPE_HALF_FLOAT:o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=Qe$1.TEXTURETYPE_FLOAT:this._textureType=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,this._initializeGenerator(),this._applyFilterValues();}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap();}_createTargetRenderTexture(){const e=this._scene.getEngine();this._shadowMap?.dispose(),e._features.supportDepthStencilTexture?(this._shadowMap=new ua(this._light.name+"_shadowMap",this._mapSize,this._scene,false,true,this._textureType,this._light.needCube(),void 0,false,false,void 0,this._useRedTextureType?Qe$1.TEXTUREFORMAT_RED:Qe$1.TEXTUREFORMAT_RGBA),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?Qe$1.GREATER:Qe$1.LESS,true,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new ua(this._light.name+"_shadowMap",this._mapSize,this._scene,false,true,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=true;}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=Is.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=Is.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(Is.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=false,this._shadowMap.ignoreCameraViewport=true,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,i,s)=>this._renderForShadowMap(e,t,i,s),this._shadowMap.customIsReadyFunction=(e,t,i)=>{if(!i||!e.subMeshes)return  true;let s=true;for(const t of e.subMeshes){const e=t.getRenderingMesh(),i=this._scene.getEngine(),r=t.getMaterial();if(!r||0===t.verticesCount||this.customAllowRendering&&!this.customAllowRendering(t))continue;const n=e._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(n.mustReturn)continue;const a=i.getCaps().instancedArrays&&(null!==n.visibleInstances[t._id]&&void 0!==n.visibleInstances[t._id]||e.hasThinInstances),o=r.needAlphaBlendingForMesh(e);s=this.isReady(t,a,o)&&s;}return s};const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add((()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`shadow map generation for pass id ${e.currentRenderPassId}`,1);})),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===no.FILTER_PCF&&e.setColorWrite(false),this.getTransformMatrix(),Mn.eyeAtCamera=false,this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo());})),this._shadowMap.onAfterUnbindObservable.add((()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),Mn.eyeAtCamera=true,this._scene.updateTransformMatrix(),this._filter===no.FILTER_PCF&&e.setColorWrite(true),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void e._debugPopGroup?.(1);const t=this.getShadowMapForRendering();t&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,t.renderTarget,true),e.unBindFramebuffer(t.renderTarget,true)),e._debugPopGroup?.(1);}));const t=new me$3(0,0,0,0),i=new me$3(1,1,1,1);this._shadowMap.onClearObservable.add((e=>{this._filter===no.FILTER_PCF?e.clear(i,false,true,false):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,true,true,false):e.clear(i,true,true,false);})),this._shadowMap.onResizeObservable.add((e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap();}));for(let e=Un.MIN_RENDERINGGROUPS;e<Un.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,false);}async _initShaderSourceAsync(e=false){!this._scene.getEngine().isWebGPU||e||no.ForceGLSL?await Promise.all([Promise.resolve().then(function(){return shadowMap_fragmentIJyPkm9u_esm_min}),Promise.resolve().then(function(){return shadowMap_vertexRF2sPjTk_esm_min}),Promise.resolve().then(function(){return depthBoxBlur_fragmentBvwLRlf3_esm_min}),Promise.resolve().then(function(){return shadowMapFragmentSoftTransparentShadowCRB_Mg46_esm_min})]):(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(function(){return shadowMap_fragmentZ_Lpm5Fe_esm_min}),Promise.resolve().then(function(){return shadowMap_vertexDi_QOfOI_esm_min}),Promise.resolve().then(function(){return depthBoxBlur_fragmentCZQmTHBc_esm_min}),Promise.resolve().then(function(){return shadowMapFragmentSoftTransparentShadowLruZzcjV_esm_min})])),this._shadersLoaded=true;}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new ua(this._light.name+"_shadowMap2",t,this._scene,false,true,this._textureType,void 0,void 0,false),this._shadowMap2.wrapU=Is.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=Is.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(Is.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new so(this._light.name+"KernelBlurX",new ee$4(1,0),this.blurKernel,1,null,Is.BILINEAR_SAMPLINGMODE,e,false,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=true,this._kernelBlurXPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._shadowMap);})),this._kernelBlurYPostprocess=new so(this._light.name+"KernelBlurY",new ee$4(0,1),this.blurKernel,1,null,Is.BILINEAR_SAMPLINGMODE,e,false,this._textureType),this._kernelBlurXPostprocess.autoClear=false,this._kernelBlurYPostprocess.autoClear=false,this._textureType===Qe$1.TEXTURETYPE_UNSIGNED_BYTE&&(this._kernelBlurXPostprocess.packedFloat=true,this._kernelBlurYPostprocess.packedFloat=true),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new Aa(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,Is.BILINEAR_SAMPLINGMODE,e,false,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=true,this._boxBlurPostprocess.onApplyObservable.add((e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap);})),this._boxBlurPostprocess.autoClear=false,this._blurPostProcesses=[this._boxBlurPostprocess]);}_renderForShadowMap(e,t,i,s){let r;if(s.length)for(r=0;r<s.length;r++)this._renderSubMeshForShadowMap(s.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r],true);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=false;}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix());}_renderSubMeshForShadowMap(e,t=false){const i=e.getRenderingMesh(),s=e.getEffectiveMesh(),r=this._scene,n=r.getEngine(),a=e.getMaterial();if(s._internalAbstractMeshDataInfo._isActiveIntermediate=false,!a||0===e.verticesCount||e._renderId===r.getRenderId())return;const o=r.useRightHandedSystem,h=s._getWorldMatrixDeterminant()<0;let l=a._getEffectiveOrientation(i);(h&&!o||!h&&o)&&(l=l===Qe$1.MATERIAL_ClockWiseSideOrientation?Qe$1.MATERIAL_CounterClockWiseSideOrientation:Qe$1.MATERIAL_ClockWiseSideOrientation);const c=l===Qe$1.MATERIAL_ClockWiseSideOrientation;n.setState(a.backFaceCulling,void 0,void 0,c,a.cullBackFaces);const u=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(u.mustReturn)return;const d=n.getCaps().instancedArrays&&(null!==u.visibleInstances[e._id]&&void 0!==u.visibleInstances[e._id]||i.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,d,t)){e._renderId=r.getRenderId();const o=a.shadowDepthWrapper,h=o?.getEffect(e,this,n.currentRenderPassId)??e._getDrawWrapper(),l=$i.GetEffect(h);n.enableEffect(h),d||i._bind(e,l,a.fillMode),this.getTransformMatrix(),l.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===dn.LIGHTTYPEID_DIRECTIONALLIGHT?l.setVector3("lightDataSM",this._cachedDirection):l.setVector3("lightDataSM",this._cachedPosition.subtractToRef(this._scene.floatingOriginOffset,ae$5.Vector3[0]));const c=this._getCamera();if(l.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(c),this.getLight().getDepthMinZ(c)+this.getLight().getDepthMaxZ(c)),t&&this.enableSoftTransparentShadow&&l.setFloat2("softTransparentShadowSM",s.visibility*a.alpha,this._opacityTexture?.getAlphaFromRGB?1:0),o)e._setMainDrawWrapperOverride(h),o.standalone?o.baseMaterial.bindForSubMesh(s.getWorldMatrix(),i,e):a.bindForSubMesh(s.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else {if(this._opacityTexture&&(l.setTexture("diffuseSampler",this._opacityTexture),l.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){const e=i.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(i);if(!t)return;l.setTexture("boneSampler",t),l.setFloat("boneTextureWidth",4*(e.bones.length+1));}else l.setMatrices("mBones",e.getTransformMatrices(i));}ws(i,l),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(l);const t=e.getMesh().bakedVertexAnimationManager;t&&t.isEnabled&&t.bind(l,d),As(l,a,r);}this._useUBO||o||this._bindCustomEffectForRenderSubMeshForShadowMap(e,l,s),Ns(l,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const _=s.getWorldMatrix();d&&(s.getMeshUniformBuffer().bindToEffect(l,"Mesh"),s.transferToEffect(_)),this.forceBackFacesOnly&&n.setState(true,0,false,true,a.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(l),i._processRendering(s,e,l,a.fillMode,u,d,((e,t)=>{s===i||e?(s.getMeshUniformBuffer().bindToEffect(l,"Mesh"),s.transferToEffect(e?t:_)):(i.getMeshUniformBuffer().bindToEffect(l,"Mesh"),i.transferToEffect(t));})),this.forceBackFacesOnly&&n.setState(true,0,false,false,a.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(l),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i);}else this._shadowMap&&this._shadowMap.resetRefreshCounter();}_applyFilterValues(){this._shadowMap&&(this.filter===no.FILTER_NONE||this.filter===no.FILTER_PCSS?this._shadowMap.updateSamplingMode(Is.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(Is.BILINEAR_SAMPLINGMODE));}forceCompilation(e,t){const i={useInstances:false,...t},s=this.getShadowMap();if(!s)return void(e&&e(this));const r=s.renderList;if(!r)return void(e&&e(this));const n=[];for(const e of r)n.push(...e.subMeshes);if(0===n.length)return void(e&&e(this));let a=0;const o=()=>{if(this._scene&&this._scene.getEngine()){for(;this.isReady(n[a],i.useInstances,n[a].getMaterial()?.needAlphaBlendingForMesh(n[a].getMesh())??false);)if(a++,a>=n.length)return void(e&&e(this));setTimeout(o,16);}};o();}async forceCompilationAsync(e){return await new Promise((t=>{this.forceCompilation((()=>{t();}),e);}))}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,s){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(this._textureType!==Qe$1.TEXTURETYPE_UNSIGNED_BYTE?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const r=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(Hi.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===dn.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){if(!this._shadersLoaded)return  false;const s=e.getMaterial(),r=s?.shadowDepthWrapper;if(this._opacityTexture=null,!s)return  false;const n=[];if(this._prepareShadowDefines(e,t,n,i),r){if(!r.isReadyForSubMesh(e,n,this,t,this._scene.getEngine().currentRenderPassId))return  false}else {const i=e._getDrawWrapper(void 0,true);let r=i.effect,a=i.defines;const o=[Hi.PositionKind],h=e.getMesh();let l=false,c=false,u=false;const d=false;this.normalBias&&h.isVerticesDataPresent(Hi.NormalKind)&&(o.push(Hi.NormalKind),n.push("#define NORMAL"),l=true,h.nonUniformScaling&&n.push("#define NONUNIFORMSCALING"));const _=s.needAlphaTestingForMesh(h);if((_||s.needAlphaBlendingForMesh(h))&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=s.opacityTexture:this._opacityTexture=s.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return  false;const e=s.alphaCutOff??no.DEFAULT_ALPHA_CUTOFF;n.push("#define ALPHATEXTURE"),_&&n.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),h.isVerticesDataPresent(Hi.UVKind)&&(o.push(Hi.UVKind),n.push("#define UV1"),c=true),h.isVerticesDataPresent(Hi.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(o.push(Hi.UV2Kind),n.push("#define UV2"),u=true);}const f=new ro;if(h.useBones&&h.computeBonesUsingShaders&&h.skeleton){o.push(Hi.MatricesIndicesKind),o.push(Hi.MatricesWeightsKind),h.numBoneInfluencers>4&&(o.push(Hi.MatricesIndicesExtraKind),o.push(Hi.MatricesWeightsExtraKind));const e=h.skeleton;n.push("#define NUM_BONE_INFLUENCERS "+h.numBoneInfluencers),h.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,h),e.isUsingTextureForMatrices?n.push("#define BONETEXTURE"):n.push("#define BonesPerMesh "+(e.bones.length+1));}else n.push("#define NUM_BONE_INFLUENCERS 0");const p=h.morphTargetManager?Ds(h.morphTargetManager,n,o,h,true,l,false,c,u,d):0;if(Es(s,this._scene,n),t&&(n.push("#define INSTANCES"),Fs(o),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const e of this.customShaderOptions.defines) -1===n.indexOf(e)&&n.push(e);const g=h.bakedVertexAnimationManager;g&&g.isEnabled&&(n.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&o.push("bakedVertexAnimationSettingsInstanced"));const m=n.join("\n");if(a!==m){a=m;let e="shadowMap";const t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],s=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],n=["Scene","Mesh"];if(Ts(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const e of this.customShaderOptions.attributes) -1===o.indexOf(e)&&o.push(e);if(this.customShaderOptions.uniforms)for(const e of this.customShaderOptions.uniforms) -1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(const e of this.customShaderOptions.samplers) -1===s.indexOf(e)&&s.push(e);}const h=this._scene.getEngine();r=h.createEffect(e,{attributes:o,uniformsNames:t,uniformBuffersNames:n,samplers:s,defines:m,fallbacks:f,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:p},shaderLanguage:this._shaderLanguage},h),i.setEffect(r,a);}if(!r.isReady())return  false}return (this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady())&&(!(this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady())&&!(this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady()))}prepareDefines(e,t){const i=this._scene,s=this._light;i.shadowsEnabled&&s.shadowEnabled&&(e["SHADOW"+t]=true,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=true,this._filteringQuality===no.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=true:this._filteringQuality===no.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=true)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=true,this._filteringQuality===no.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=true:this._filteringQuality===no.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=true)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=true:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=true:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=true),s.needCube()&&(e["SHADOWCUBE"+t]=true));}bindShadowLight(e,t){const i=this._light,s=this._scene;if(!s.shadowsEnabled||!i.shadowEnabled)return;const r=this._getCamera(),n=this.getShadowMap();if(!n)return;if(!i.needCube()){const i=s.floatingOriginOffset,r=this.getTransformMatrix(),n=s.floatingOriginMode?Pn(i,this._viewMatrix,this._projectionMatrix,ae$5.Matrix[0]):r;t.setMatrix("lightMatrix"+e,n);}const a=this.getShadowMapForRendering();this._filter===no.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n.getSize().width,1/n.getSize().width,this.frustumEdgeFalloff,e)):this._filter===no.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,a),t.setTexture("depthTexture"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n.getSize().width,this._contactHardeningLightSizeUVRatio*n.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/n.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e);}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),te$4.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(te$4.Dot(this._lightDirection,te$4.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),re$5.LookAtLHToRef(t,t.add(this._lightDirection),te$4.Up(),this._viewMatrix);const e=this.getShadowMap();if(e){const t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t);}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix);}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const e of t)this._shadowMap.renderList.push(e);}else this._shadowMap.renderList=null;}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[];}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses();}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[];}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();true!==t.done;t=e.next()){const[e,i]=t.value;i===this&&this._light._shadowGenerators.delete(e);}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null);}this._light._markMeshesAsLightDirty();}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear();}serialize(){const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const s=t.renderList[i];e.renderList.push(s.id);}return e}static Parse(e,t,i){const s=t.getLightById(e.lightId),r=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,n=i?i(e.mapSize,s,r):new no(e.mapSize,s,void 0,r),a=n.getShadowMap();if(e.renderList.length&&a){const i=new Set(e.renderList);let s=a.renderList;s||(s=a.renderList=[]);const r=t.meshes;for(const e of r)i.has(e.id)&&s.push(e);}return void 0!==e.id&&(n.id=e.id),n.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&n.setDarkness(e.darkness),e.transparencyShadow&&n.setTransparencyShadow(true),void 0!==e.frustumEdgeFalloff&&(n.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(n.bias=e.bias),void 0!==e.normalBias&&(n.normalBias=e.normalBias),e.usePercentageCloserFiltering?n.usePercentageCloserFiltering=true:e.useContactHardeningShadow?n.useContactHardeningShadow=true:e.usePoissonSampling?n.usePoissonSampling=true:e.useExponentialShadowMap?n.useExponentialShadowMap=true:e.useBlurExponentialShadowMap?n.useBlurExponentialShadowMap=true:e.useCloseExponentialShadowMap?n.useCloseExponentialShadowMap=true:e.useBlurCloseExponentialShadowMap?n.useBlurCloseExponentialShadowMap=true:e.useVarianceShadowMap?n.useExponentialShadowMap=true:e.useBlurVarianceShadowMap&&(n.useBlurExponentialShadowMap=true),void 0!==e.contactHardeningLightSizeUVRatio&&(n.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(n.filteringQuality=e.filteringQuality),e.depthScale&&(n.depthScale=e.depthScale),e.blurScale&&(n.blurScale=e.blurScale),e.blurBoxOffset&&(n.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(n.useKernelBlur=e.useKernelBlur),e.blurKernel&&(n.blurKernel=e.blurKernel),n}}no.CLASSNAME="ShadowGenerator",no.ForceGLSL=false,no.FILTER_NONE=0,no.FILTER_EXPONENTIALSHADOWMAP=1,no.FILTER_POISSONSAMPLING=2,no.FILTER_BLUREXPONENTIALSHADOWMAP=3,no.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,no.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,no.FILTER_PCF=6,no.FILTER_PCSS=7,no.QUALITY_HIGH=0,no.QUALITY_MEDIUM=1,no.QUALITY_LOW=2,no.DEFAULT_ALPHA_CUTOFF=.5,no._SceneComponentInitialization=e=>{throw le$4("ShadowGeneratorSceneComponent")};var ao=Object.freeze({__proto__:null,ShadowGenerator:no});const oo="clipPlaneFragmentDeclaration";bt$1.IncludesShadersStore[oo]||(bt$1.IncludesShadersStore[oo]="#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nvarying float fClipDistance6;\n#endif\n");const ho="packingFunctions";bt$1.IncludesShadersStore[ho]||(bt$1.IncludesShadersStore[ho]="vec4 pack(float depth)\n{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}");const lo="clipPlaneFragment";bt$1.IncludesShadersStore[lo]||(bt$1.IncludesShadersStore[lo]="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{discard;}\n#endif\n");const co="depthPixelShader",uo="#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vec4 vViewPos;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\ngl_FragColor=pack(vViewPos.z);\n#else\ngl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";bt$1.ShadersStore[co]||(bt$1.ShadersStore[co]=uo);const _o={name:co,shader:uo};var fo=Object.freeze({__proto__:null,depthPixelShader:_o});const po="bonesDeclaration";bt$1.IncludesShadersStore[po]||(bt$1.IncludesShadersStore[po]="#if NUM_BONE_INFLUENCERS>0\nattribute vec4 matricesIndices;attribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nuniform highp sampler2D boneSampler;uniform float boneTextureWidth;\n#else\nuniform mat4 mBones[BonesPerMesh];\n#endif\n#ifdef BONES_VELOCITY_ENABLED\nuniform mat4 mPreviousBones[BonesPerMesh];\n#endif\n#ifdef BONETEXTURE\n#define inline\nmat4 readMatrixFromRawSampler(sampler2D smp,float index)\n{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}\n#endif\n#endif\n#endif\n");const go="bakedVertexAnimationDeclaration";bt$1.IncludesShadersStore[go]||(bt$1.IncludesShadersStore[go]="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;\n#ifdef INSTANCES\nattribute vec4 bakedVertexAnimationSettingsInstanced;\n#endif\n#define inline\nmat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)\n{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}\n#endif\n");const mo="morphTargetsVertexGlobalDeclaration";bt$1.IncludesShadersStore[mo]||(bt$1.IncludesShadersStore[mo]="#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#ifdef MORPHTARGETS_TEXTURE \nuniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform highp sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}\nvec4 readVector4FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV);}\n#endif\n#endif\n");const To="morphTargetsVertexDeclaration";bt$1.IncludesShadersStore[To]||(bt$1.IncludesShadersStore[To]="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\n#ifdef MORPHTARGETS_POSITION\nattribute vec3 position{X};\n#endif\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#ifdef MORPHTARGETS_UV\nattribute vec2 uv_{X};\n#endif\n#ifdef MORPHTARGETS_UV2\nattribute vec2 uv2_{X};\n#endif\n#ifdef MORPHTARGETS_COLOR\nattribute vec4 color{X};\n#endif\n#elif {X}==0\nuniform float morphTargetCount;\n#endif\n#endif\n");const Eo="clipPlaneVertexDeclaration";bt$1.IncludesShadersStore[Eo]||(bt$1.IncludesShadersStore[Eo]="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;varying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;varying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;varying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;varying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;varying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;varying float fClipDistance6;\n#endif\n");const Ao="instancesDeclaration";bt$1.IncludesShadersStore[Ao]||(bt$1.IncludesShadersStore[Ao]="#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#ifdef INSTANCESCOLOR\nattribute vec4 instanceColor;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nattribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;\n#ifdef THIN_INSTANCES\nuniform mat4 previousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nuniform mat4 previousWorld;\n#endif\n#endif\n");const Ro="pointCloudVertexDeclaration";bt$1.IncludesShadersStore[Ro]||(bt$1.IncludesShadersStore[Ro]="#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n");const bo="morphTargetsVertexGlobal";bt$1.IncludesShadersStore[bo]||(bt$1.IncludesShadersStore[bo]="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nfloat vertexID;\n#endif\n#endif\n");const So="morphTargetsVertex";bt$1.IncludesShadersStore[So]||(bt$1.IncludesShadersStore[So]="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\n#if {X}==0\nfor (int i=0; i<NUM_MORPH_INFLUENCERS; i++) {if (float(i)>=morphTargetCount) break;vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;\n#ifdef MORPHTARGETS_POSITION\npositionUpdated+=(readVector3FromRawSampler(i,vertexID)-position)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASPOSITIONS\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(readVector3FromRawSampler(i,vertexID) -normal)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASNORMALS\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(readVector3FromRawSampler(i,vertexID).xy-uv)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASUVS\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(readVector3FromRawSampler(i,vertexID) -tangent.xyz)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASTANGENTS\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV2\nuv2Updated+=(readVector3FromRawSampler(i,vertexID).xy-uv2)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASUV2S\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_COLOR\ncolorUpdated+=(readVector4FromRawSampler(i,vertexID)-color)*morphTargetInfluences[i];\n#endif\n}\n#endif\n#else\n#ifdef MORPHTARGETS_POSITION\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV2\nuv2Updated+=(uv2_{X}-uv2)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_COLOR\ncolorUpdated+=(color{X}-color)*morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n");const xo="instancesVertex";bt$1.IncludesShadersStore[xo]||(bt$1.IncludesShadersStore[xo]="#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nmat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,\npreviousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\nfinalWorld=world*finalWorld;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\nmat4 finalWorld=world;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nmat4 finalPreviousWorld=previousWorld;\n#endif\n#endif\n");const Mo="bonesVertex";bt$1.IncludesShadersStore[Mo]||(bt$1.IncludesShadersStore[Mo]="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif\n#else\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n");const yo="bakedVertexAnimation";bt$1.IncludesShadersStore[yo]||(bt$1.IncludesShadersStore[yo]="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\n#define BVASNAME bakedVertexAnimationSettingsInstanced\n#else\n#define BVASNAME bakedVertexAnimationSettings\n#endif\nfloat VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n");const Io="clipPlaneVertex";bt$1.IncludesShadersStore[Io]||(bt$1.IncludesShadersStore[Io]="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,vClipPlane6);\n#endif\n");const Co="pointCloudVertex";bt$1.IncludesShadersStore[Co]||(bt$1.IncludesShadersStore[Co]="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n");const vo="depthVertexShader",Po="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform mat4 view;varying vec4 vViewPos;\n#endif\n#include<pointCloudVertexDeclaration>\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvViewPos=view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#include<pointCloudVertex>\n}\n";bt$1.ShadersStore[vo]||(bt$1.ShadersStore[vo]=Po);const Oo={name:vo,shader:Po};var Do,Lo=Object.freeze({__proto__:null,depthVertexShader:Oo});class Fo{get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t);}constructor(e,t=Qe$1.TEXTURETYPE_FLOAT,i=null,s=false,r=Is.TRILINEAR_SAMPLINGMODE,n=false,a,o){this._shaderLanguage=0,this.enabled=true,this.forceDepthWriteTransparentMeshes=false,this.useOnlyInActiveCamera=false,this.reverseCulling=false,this._shadersLoaded=false,this._scene=e,this._storeNonLinearDepth=s,this._storeCameraSpaceZ=n,this.isPacked=t===Qe$1.TEXTURETYPE_UNSIGNED_BYTE,this.isPacked?this.clearColor=new me$3(1,1,1,1):this.clearColor=new me$3(n?0:1,0,0,1),this._initShaderSourceAsync(),Fo._SceneComponentInitialization(this._scene);const h=e.getEngine();this._camera=i,r!==Is.NEAREST_SAMPLINGMODE&&(t!==Qe$1.TEXTURETYPE_FLOAT||h._caps.textureFloatLinearFiltering||(r=Is.NEAREST_SAMPLINGMODE),t!==Qe$1.TEXTURETYPE_HALF_FLOAT||h._caps.textureHalfFloatLinearFiltering||(r=Is.NEAREST_SAMPLINGMODE));const l=this.isPacked||!h._features.supportExtendedTextureFormats?Qe$1.TEXTUREFORMAT_RGBA:Qe$1.TEXTUREFORMAT_R;this._depthMap=o??new ua(a??"DepthRenderer",{width:h.getRenderWidth(),height:h.getRenderHeight()},this._scene,false,true,t,false,r,void 0,void 0,void 0,l),this._depthMap.wrapU=Is.CLAMP_ADDRESSMODE,this._depthMap.wrapV=Is.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=false,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=true,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=true,this._depthMap.useCameraPostProcesses=false,this._depthMap.onClearObservable.add((e=>{e.clear(this.clearColor,true,true,true);})),this._depthMap.onBeforeBindObservable.add((()=>{h._debugPushGroup?.("depth renderer",1);})),this._depthMap.onAfterUnbindObservable.add((()=>{h._debugPopGroup?.(1);})),this._depthMap.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],s=i.getRenderingMesh(),r=s._getInstancesRenderList(i._id,!!i.getReplacementMesh()),n=h.getCaps().instancedArrays&&(null!==r.visibleInstances[i._id]&&void 0!==r.visibleInstances[i._id]||s.hasThinInstances);if(!this.isReady(i,n))return  false}return  true};const c=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),s=this._scene,r=s.getEngine(),n=e.getMaterial();if(i._internalAbstractMeshDataInfo._isActiveIntermediate=false,!n||i.infiniteDistance||n.disableDepthWrite||0===e.verticesCount||e._renderId===s.getRenderId())return;const a=i._getWorldMatrixDeterminant()<0;let o=n._getEffectiveOrientation(t);a&&(o=o===Qe$1.MATERIAL_ClockWiseSideOrientation?Qe$1.MATERIAL_CounterClockWiseSideOrientation:Qe$1.MATERIAL_ClockWiseSideOrientation);const h=o===Qe$1.MATERIAL_ClockWiseSideOrientation;r.setState(n.backFaceCulling,0,false,h,this.reverseCulling?!n.cullBackFaces:n.cullBackFaces);const l=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(l.mustReturn)return;const c=r.getCaps().instancedArrays&&(null!==l.visibleInstances[e._id]&&void 0!==l.visibleInstances[e._id]||t.hasThinInstances),u=this._camera||s.activeCamera;if(this.isReady(e,c)&&u){e._renderId=s.getRenderId();const a=i._internalAbstractMeshDataInfo._materialForRenderPass?.[r.currentRenderPassId];let o=e._getDrawWrapper();!o&&a&&(o=a._getDrawWrapper());const h=u.mode===Di.ORTHOGRAPHIC_CAMERA;if(!o)return;const d=o.effect;let _,f;if(r.enableEffect(o),c||t._bind(e,d,n.fillMode),a?a.bindForSubMesh(i.getWorldMatrix(),i,e):(d.setMatrix("viewProjection",s.getTransformMatrix()),d.setMatrix("world",i.getWorldMatrix()),this._storeCameraSpaceZ&&d.setMatrix("view",s.getViewMatrix())),h?(_=!r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:1,f=r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:1):(_=r.useReverseDepthBuffer&&r.isNDCHalfZRange?u.minZ:r.isNDCHalfZRange?0:u.minZ,f=r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:u.maxZ),d.setFloat2("depthValues",_,_+f),!a){if(n.needAlphaTestingForMesh(i)){const e=n.getAlphaTestTexture();e&&(d.setTexture("diffuseSampler",e),d.setMatrix("diffuseMatrix",e.getTextureMatrix()));}Hs(t,d),As(d,n,s),ws(t,d),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(d);const r=e.getMesh().bakedVertexAnimationManager;r&&r.isEnabled&&r.bind(d,c),n.pointsCloud&&d.setFloat("pointSize",n.pointSize);}t._processRendering(i,e,d,n.fillMode,l,c,((e,t)=>d.setMatrix("world",t)));}};this._depthMap.customRenderFunction=(e,t,i,s)=>{let r;if(s.length)for(r=0;r<s.length;r++)c(s.data[r]);for(r=0;r<e.length;r++)c(e.data[r]);for(r=0;r<t.length;r++)c(t.data[r]);if(this.forceDepthWriteTransparentMeshes)for(r=0;r<i.length;r++)c(i.data[r]);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=false;};}async _initShaderSourceAsync(e=false){!this._scene.getEngine().isWebGPU||e||Fo.ForceGLSL?await Promise.all([Promise.resolve().then((function(){return Lo})),Promise.resolve().then((function(){return fo}))]):(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(function(){return depth_vertexBt7MVetX_esm_min}),Promise.resolve().then(function(){return depth_fragmentC4SBl4p1_esm_min})])),this._shadersLoaded=true;}isReady(e,t){if(!this._shadersLoaded)return  false;const i=this._scene.getEngine(),s=e.getMesh(),r=s.getScene(),n=s._internalAbstractMeshDataInfo._materialForRenderPass?.[i.currentRenderPassId];if(n)return n.isReadyForSubMesh(s,e,t);const a=e.getMaterial();if(!a||a.disableDepthWrite)return  false;const o=[],h=[Hi.PositionKind];let l=false,c=false;a.needAlphaTestingForMesh(s)&&a.getAlphaTestTexture()&&(o.push("#define ALPHATEST"),s.isVerticesDataPresent(Hi.UVKind)&&(h.push(Hi.UVKind),o.push("#define UV1"),l=true),s.isVerticesDataPresent(Hi.UV2Kind)&&(h.push(Hi.UV2Kind),o.push("#define UV2"),c=true));const u=new ro;if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){h.push(Hi.MatricesIndicesKind),h.push(Hi.MatricesWeightsKind),s.numBoneInfluencers>4&&(h.push(Hi.MatricesIndicesExtraKind),h.push(Hi.MatricesWeightsExtraKind)),o.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),s.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,s);const e=s.skeleton;e.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(e.bones.length+1));}else o.push("#define NUM_BONE_INFLUENCERS 0");const d=s.morphTargetManager?Ds(s.morphTargetManager,o,h,s,true,false,false,l,c,false):0;a.pointsCloud&&o.push("#define POINTSIZE"),t&&(o.push("#define INSTANCES"),Fs(h),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES"));const _=s.bakedVertexAnimationManager;_&&_.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&h.push("bakedVertexAnimationSettingsInstanced")),this._storeNonLinearDepth&&o.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&o.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&o.push("#define PACKED"),Es(a,r,o);const f=e._getDrawWrapper(void 0,true),p=f.defines,g=o.join("\n");if(p!==g){const e=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];Ts(e),f.setEffect(i.createEffect("depth",{attributes:h,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:g,fallbacks:u,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:d},shaderLanguage:this._shaderLanguage},i),g);}return f.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer){this._scene._depthRenderer[t]===this&&e.push(t);}if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t];}}}Fo.ForceGLSL=false,Fo._SceneComponentInitialization=e=>{throw le$4("DepthRendererSceneComponent")},function(e){e[e.NormalizedViewDepth=0]="NormalizedViewDepth",e[e.ViewDepth=1]="ViewDepth",e[e.ScreenDepth=2]="ScreenDepth";}(Do||(Do={}));class wo extends Ea{_gatherImports(e,t){e?(this._webGPUReady=true,t.push(Promise.resolve().then((function(){return Ko})))):t.push(Promise.resolve().then((function(){return zo})));}constructor(e,t=null,i="",s){super({...s,name:e,engine:t||eo.LastCreatedEngine,useShaderStore:true,useAsPostProcess:true,fragmentShader:wo.FragmentUrl,uniforms:wo.Uniforms,defines:i}),this.textureWidth=0,this.textureHeight=0;}bind(e=false){super.bind(e);const t=this.drawWrapper.effect;1===this.textureWidth||1===this.textureHeight?t.setInt2("texSize",this.textureWidth,this.textureHeight):t.setFloat2("texSize",this.textureWidth,this.textureHeight);}}wo.FragmentUrl="minmaxRedux",wo.Uniforms=["texSize"];const No=new Float32Array(4),Bo=new Uint8Array(4),Uo={min:0,max:0};class ko{get depthRedux(){return this._depthRedux}set depthRedux(e){this._depthRedux!==e&&(this._depthRedux=e,this._recreatePostProcesses());}get textureWidth(){return this._textureWidth}get textureHeight(){return this._textureHeight}constructor(e,t=true){this.onAfterReductionPerformed=new R$g,this._textureWidth=0,this._textureHeight=0,this._scene=e,this._depthRedux=t,this.reductionSteps=[];}setTextureDimensions(e,t,i=0){return (e!==this._textureWidth||t!==this._textureHeight||i!==this._depthTextureType)&&(this._textureWidth=e,this._textureHeight=t,this._depthTextureType=i,this._recreatePostProcesses(),true)}readMinMax(e){const t=e.type===eo.TEXTURETYPE_FLOAT||e.type===eo.TEXTURETYPE_HALF_FLOAT,i=t?No:Bo;this._scene.getEngine()._readTexturePixels(e,1,1,-1,0,i,false),Uo.min=i[0],Uo.max=i[1],t||(Uo.min=Uo.min/255,Uo.max=Uo.max/255),Uo.min>=Uo.max&&(Uo.min=0,Uo.max=1),this.onAfterReductionPerformed.notifyObservers(Uo);}dispose(e=true){e&&(this.onAfterReductionPerformed.clear(),this._textureWidth=0,this._textureHeight=0);for(let e=0;e<this.reductionSteps.length;++e)this.reductionSteps[e].dispose();this.reductionSteps.length=0;}_recreatePostProcesses(){this.dispose(false);const e=this._scene;let t=this.textureWidth,i=this.textureHeight;const s=new wo("Initial reduction phase",e.getEngine(),"#define INITIAL"+(this._depthRedux?"\n#define DEPTH_REDUX":"")+(1===this._depthTextureType?"\n#define VIEW_DEPTH":""));s.textureWidth=t,s.textureHeight=i,this.reductionSteps.push(s);let r=1;for(;t>1||i>1;){t=Math.max(Math.round(t/2),1),i=Math.max(Math.round(i/2),1);const s=new wo("Reduction phase "+r,e.getEngine(),"#define "+(1==t&&1==i?"LAST":1==t||1==i?"ONEBEFORELAST":"MAIN"));s.textureWidth=t,s.textureHeight=i,this.reductionSteps.push(s),r++;}}}const Go="minmaxReduxPixelShader",Vo="varying vec2 vUV;uniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(textureSampler,coord,0).r;float f2=texelFetch(textureSampler,coord+ivec2(1,0),0).r;float f3=texelFetch(textureSampler,coord+ivec2(1,1),0).r;float f4=texelFetch(textureSampler,coord+ivec2(0,1),0).r;\n#ifdef DEPTH_REDUX\n#ifdef VIEW_DEPTH\nfloat minz=3.4e38;if (f1 != 0.0) { minz=f1; }\nif (f2 != 0.0) { minz=min(minz,f2); }\nif (f3 != 0.0) { minz=min(minz,f3); }\nif (f4 != 0.0) { minz=min(minz,f4); }\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#else\nfloat minz=min(min(min(f1,f2),f3),f4);float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#endif\n#else\nfloat minz=min(min(min(f1,f2),f3),f4);float maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(MAIN)\nuniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(LAST)\nvoid main(void)\n{glFragColor=vec4(0.);if (true) { \ndiscard;}}\n#endif\n";bt$1.ShadersStore[Go]||(bt$1.ShadersStore[Go]=Vo);const Ho={name:Go,shader:Vo};var zo=Object.freeze({__proto__:null,minmaxReduxPixelShader:Ho});const Xo="minmaxReduxPixelShader",Wo="varying vUV: vec2f;var textureSampler: texture_2d<f32>;\n#if defined(INITIAL)\nuniform texSize: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let coord=vec2i(fragmentInputs.vUV*(uniforms.texSize-1.0));let f1=textureLoad(textureSampler,coord,0).r;let f2=textureLoad(textureSampler,coord+vec2i(1,0),0).r;let f3=textureLoad(textureSampler,coord+vec2i(1,1),0).r;let f4=textureLoad(textureSampler,coord+vec2i(0,1),0).r;\n#ifdef DEPTH_REDUX\n#ifdef VIEW_DEPTH\nvar minz=3.4e38;if (f1 != 0.0) { minz=f1; }\nif (f2 != 0.0) { minz=min(minz,f2); }\nif (f3 != 0.0) { minz=min(minz,f3); }\nif (f4 != 0.0) { minz=min(minz,f4); }\nlet maxz=max(max(max(f1,f2),f3),f4);\n#else\nlet minz=min(min(min(f1,f2),f3),f4);let maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#endif\n#else\nlet minz=min(min(min(f1,f2),f3),f4);let maxz=max(max(max(f1,f2),f3),f4);\n#endif\nfragmentOutputs.color=vec4f(minz,maxz,0.,0.);}\n#elif defined(MAIN)\nuniform texSize: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let coord=vec2i(fragmentInputs.vUV*(uniforms.texSize-1.0));let f1=textureLoad(textureSampler,coord,0).rg;let f2=textureLoad(textureSampler,coord+vec2i(1,0),0).rg;let f3=textureLoad(textureSampler,coord+vec2i(1,1),0).rg;let f4=textureLoad(textureSampler,coord+vec2i(0,1),0).rg;let minz=min(min(min(f1.x,f2.x),f3.x),f4.x);let maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);fragmentOutputs.color=vec4(minz,maxz,0.,0.);}\n#elif defined(ONEBEFORELAST)\nuniform texSize: vec2i;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let coord=vec2i(fragmentInputs.vUV*vec2f(uniforms.texSize-1));let f1=textureLoad(textureSampler,coord % uniforms.texSize,0).rg;let f2=textureLoad(textureSampler,(coord+vec2i(1,0)) % uniforms.texSize,0).rg;let f3=textureLoad(textureSampler,(coord+vec2i(1,1)) % uniforms.texSize,0).rg;let f4=textureLoad(textureSampler,(coord+vec2i(0,1)) % uniforms.texSize,0).rg;let minz=min(min(min(f1.x,f2.x),f3.x),f4.x);let maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);fragmentOutputs.color=vec4(minz,maxz,0.,0.);}\n#elif defined(LAST)\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(0.);if (true) { \ndiscard;}}\n#endif\n";bt$1.ShadersStoreWGSL[Xo]||(bt$1.ShadersStoreWGSL[Xo]=Wo);const Yo={name:Xo,shader:Wo};var Ko=Object.freeze({__proto__:null,minmaxReduxPixelShaderWGSL:Yo});class jo{get onAfterReductionPerformed(){return this._thinMinMaxReducer.onAfterReductionPerformed}constructor(e){this._onAfterUnbindObserver=null,this._forceFullscreenViewport=true,this._activated=false,this._camera=e,this._postProcessManager=new Rn(e.getScene()),this._thinMinMaxReducer=new ko(e.getScene()),this._reductionSteps=[],this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{this._postProcessManager._rebuild();}));}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=Qe$1.TEXTURETYPE_HALF_FLOAT,s=true){if(e!==this._sourceTexture&&(this._thinMinMaxReducer.depthRedux=t,this.deactivate(),this._sourceTexture=e,this._forceFullscreenViewport=s,this._thinMinMaxReducer.setTextureDimensions(e.getRenderWidth(),e.getRenderHeight()))){this._disposePostProcesses();const e=this._thinMinMaxReducer.reductionSteps;for(let t=0;t<e.length;++t){const r=e[t],n=new Aa(r.name,wo.FragmentUrl,{effectWrapper:r,samplingMode:Qe$1.TEXTURE_NEAREST_NEAREST,engine:this._camera.getScene().getEngine(),textureType:i,textureFormat:Qe$1.TEXTUREFORMAT_RG,size:{width:r.textureWidth,height:r.textureHeight}});this._reductionSteps.push(n),n.autoClear=false,n.forceFullscreenViewport=s,0===t&&(n.externalTextureSamplerBinding=true,n.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._sourceTexture);}))),t===e.length-1&&this._reductionSteps[t-1].onAfterRenderObservable.add((()=>{this._thinMinMaxReducer.readMinMax(n.inputTexture.texture);}));}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e);}get activated(){return this._activated}activate(){!this._onAfterUnbindObserver&&this._sourceTexture&&(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add((()=>{const e=this._camera.getScene().getEngine();e._debugPushGroup?.("min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport,0,0,true,this._reductionSteps.length-1),e.unBindFramebuffer(this._reductionSteps[this._reductionSteps.length-1].inputTexture,false),e._debugPopGroup?.(1);})),this._activated=true);}deactivate(){this._onAfterUnbindObserver&&this._sourceTexture&&(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=false);}dispose(e=true){e&&(this.onAfterReductionPerformed.clear(),this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=void 0,this._disposePostProcesses(),this._postProcessManager.dispose(),this._postProcessManager=void 0,this._thinMinMaxReducer.dispose(),this._thinMinMaxReducer=void 0,this._sourceTexture=null);}_disposePostProcesses(){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps.length=0;}}class Qo extends jo{get depthRenderer(){return this._depthRenderer}constructor(e){super(e);}setDepthRenderer(e=null,t=Qe$1.TEXTURETYPE_HALF_FLOAT,i=true){const s=this._camera.getScene();this._depthRenderer&&(delete s._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(s._depthRenderer||(s._depthRenderer={}),this._depthRendererId="minmax_"+this._camera.id,(e=this._depthRenderer=new Fo(s,t,this._camera,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,false,`DepthRenderer ${this._depthRendererId}`)).enabled=false,s._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),true,t,i);}setSourceTexture(e,t,i=Qe$1.TEXTURETYPE_HALF_FLOAT,s=true){super.setSourceTexture(e,t,i,s);}activate(){this._depthRenderer&&(this._depthRenderer.enabled=true),super.activate();}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=false);}dispose(e=true){super.dispose(e),this._depthRenderer&&e&&(this._depthRenderer.dispose(),this._depthRenderer=null);}}const qo=te$4.Up(),Zo=te$4.Zero(),Jo=new te$4,$o=new te$4,eh=new re$5;class th extends no{_validateFilter(e){return e===no.FILTER_NONE||e===no.FILTER_PCF||e===no.FILTER_PCSS?e:(Ie$2.Error('Unsupported filter "'+e+'"!'),no.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,th.MIN_CASCADES_COUNT),th.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs());}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._freezeShadowCastersBoundingInfoObservable||e||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add((()=>this._computeShadowCastersBoundingInfo()))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo();}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){const i=e[t];if(!i)continue;const s=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld);}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax);}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e;}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=true);}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return th.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&0!==t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=true):this._shadowMaxZ=e;}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty();}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e;}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty();}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=true);}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer);}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new Qo(t),this._depthReducer.onAfterReductionPerformed.add((e=>{let t=e.min,i=e.max;t>=i&&(t=0,i=1),t==this._minDistance&&i==this._maxDistance||this.setMinMaxDistance(t,i);})),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate();}}get autoCalcDepthBoundsRefreshRate(){return this._depthReducer?.depthRenderer?.getDepthMap().refreshRate??-1}set autoCalcDepthBoundsRefreshRate(e){this._depthReducer?.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e);}splitFrustum(){this._breaksAreDirty=true;}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ||this._shadowMaxZ,s=i-t,r=this._minDistance,n=t+r*s,a=t+(this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance)*s,o=a-n,h=a/n;for(let e=0;e<this._cascades.length;++e){const i=(e+1)/this._numCascades,a=n*h**i,l=n+o*i,c=this._lambda*(a-l)+l;this._cascades[e].prevBreakDistance=0===e?r:this._cascades[e-1].breakDistance,this._cascades[e].breakDistance=(c-t)/s,this._viewSpaceFrustumsZ[e]=c,this._frustumLengths[e]=(this._cascades[e].breakDistance-this._cascades[e].prevBreakDistance)*s;}this._breaksAreDirty=false;}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;te$4.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(te$4.Dot(this._lightDirection,te$4.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const t=e.getEngine().useReverseDepthBuffer;for(let i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],Jo),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),re$5.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],qo,this._viewMatrices[i]);let s=0,r=Jo.z;const n=this._shadowCastersBoundingInfo;n.update(this._viewMatrices[i]);const a=n.boundingBox.minimumWorld.z,o=n.boundingBox.maximumWorld.z;a>r||(this._depthClamp&&this.filter!==no.FILTER_PCSS?(r=Math.min(r,o),s=Math.max(s,a),r=Math.max(s+1,r)):(s=Math.min(s,a),this.filter!==no.FILTER_PCSS&&(r=Math.min(r,o)))),re$5.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,t?r:s,t?s:r,this._projectionMatrices[i],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=s,this._cascadeMaxExtents[i].z=r,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),te$4.TransformCoordinatesToRef(Zo,this._transformMatrices[i],Jo),Jo.scaleInPlace(this._mapSize/2),$o.copyFromFloats(Math.round(Jo.x),Math.round(Jo.y),Math.round(Jo.z)),$o.subtractInPlace(Jo).scaleInPlace(2/this._mapSize),re$5.TranslationToRef($o.x,$o.y,0,eh),this._projectionMatrices[i].multiplyToRef(eh,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,16*i);}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,s=this._cascades[e].breakDistance,r=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const n=0===t.maxZ,a=t.maxZ;n&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(true));const o=re$5.Invert(t.getTransformationMatrix());n&&(t.maxZ=a,t.getProjectionMatrix(true));const h=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let t=0;t<th._FrustumCornersNdcSpace.length;++t)Jo.copyFrom(th._FrustumCornersNdcSpace[(t+h)%th._FrustumCornersNdcSpace.length]),r&&-1===Jo.z&&(Jo.z=0),te$4.TransformCoordinatesToRef(Jo,o,this._frustumCornersWorldSpace[e][t]);for(let t=0;t<th._FrustumCornersNdcSpace.length/2;++t)Jo.copyFrom(this._frustumCornersWorldSpace[e][t+4]).subtractInPlace(this._frustumCornersWorldSpace[e][t]),$o.copyFrom(Jo).scaleInPlace(i),Jo.scaleInPlace(s),Jo.addInPlace(this._frustumCornersWorldSpace[e][t]),this._frustumCornersWorldSpace[e][t+4].copyFrom(Jo),this._frustumCornersWorldSpace[e][t].addInPlace($o);}_computeCascadeFrustum(e){this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0);if(this._getCamera()){for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let t=0;for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i){const s=this._frustumCornersWorldSpace[e][i].subtractToRef(this._frustumCenter[e],Jo).length();t=Math.max(t,s);}t=Math.ceil(16*t)/16,this._cascadeMaxExtents[e].copyFromFloats(t,t,t),this._cascadeMinExtents[e].copyFromFloats(-t,-t,-t);}else {const t=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,Jo),re$5.LookAtLHToRef(t,Jo,qo,eh);for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)te$4.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][t],eh,Jo),this._cascadeMinExtents[e].minimizeInPlace(Jo),this._cascadeMaxExtents[e].maximizeInPlace(Jo);}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`));}static get IsSupported(){const e=L$7.LastCreatedEngine;return !!e&&e._features.supportCSM}constructor(e,t,i,s,r=true){th.IsSupported?(super(e,t,i,s,r),this.usePercentageCloserFiltering=true):Ie$2.Error("CascadedShadowMap is not supported by the current engine.");}_initializeGenerator(){this.penumbraDarkness=this.penumbraDarkness??1,this._numCascades=this._numCascades??th.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=this.stabilizeCascades??false,this._freezeShadowCastersBoundingInfoObservable=this._freezeShadowCastersBoundingInfoObservable??null,this.freezeShadowCastersBoundingInfo=this.freezeShadowCastersBoundingInfo??false,this._scbiMin=this._scbiMin??new te$4(0,0,0),this._scbiMax=this._scbiMax??new te$4(0,0,0),this._shadowCastersBoundingInfo=this._shadowCastersBoundingInfo??new qi(new te$4(0,0,0),new te$4(0,0,0)),this._breaksAreDirty=this._breaksAreDirty??true,this._minDistance=this._minDistance??0,this._maxDistance=this._maxDistance??1,this._currentLayer=this._currentLayer??0,this._shadowMaxZ=this._shadowMaxZ??this._getCamera()?.maxZ??1e4,this._debug=this._debug??false,this._depthClamp=this._depthClamp??true,this._cascadeBlendPercentage=this._cascadeBlendPercentage??.1,this._lambda=this._lambda??.5,this._autoCalcDepthBounds=this._autoCalcDepthBounds??false,this._recreateSceneUBOs(),super._initializeGenerator();}_createTargetRenderTexture(){const e=this._scene.getEngine();this._shadowMap?.dispose();const t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new ua(this._light.name+"_CSMShadowMap",t,this._scene,false,true,this._textureType,false,void 0,false,false,void 0,this._useRedTextureType?Qe$1.TEXTUREFORMAT_RED:Qe$1.TEXTUREFORMAT_RGBA),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?Qe$1.GREATER:Qe$1.LESS,true,void 0,void 0,void 0,`DepthStencilForCSMShadowGenerator-${this._light.name}`),this._shadowMap.noPrePassRenderer=true;}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._tempTransformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=re$5.Zero(),this._projectionMatrices[e]=re$5.Zero(),this._transformMatrices[e]=re$5.Zero(),this._cascadeMinExtents[e]=new te$4,this._cascadeMaxExtents[e]=new te$4,this._frustumCenter[e]=new te$4,this._shadowCameraPos[e]=new te$4,this._frustumCornersWorldSpace[e]=new Array(th._FrustumCornersNdcSpace.length);for(let t=0;t<th._FrustumCornersNdcSpace.length;++t)this._frustumCornersWorldSpace[e][t]=new te$4;}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===no.FILTER_PCF&&e.setColorWrite(false),Mn.eyeAtCamera=false,this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo());})),this._shadowMap.onBeforeBindObservable.add((()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices();})),this._splitFrustum();}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer));}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==no.FILTER_PCSS?"1":"0"));}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,s=this._light;if(!i.shadowsEnabled||!s.shadowEnabled)return;e["SHADOWCSM"+t]=true,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const r=this._getCamera();r&&this._shadowMaxZ<=(r.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=true),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=true);}bindShadowLight(e,t){const i=this._light,s=this._scene;if(!s.shadowsEnabled||!i.shadowEnabled)return;const r=this._getCamera();if(!r)return;const n=this.getShadowMap();if(!n)return;const a=n.getSize().width,o=this._transformMatricesAsArray,h=s.floatingOriginMode?function(e,t,i,s,r){for(let n=0;n<s;++n)Pn(e,t[n],i[n],Sn),Sn.copyToArray(r,16*n);return r}(this._scene.floatingOriginOffset,this._viewMatrices,this._projectionMatrices,this._numCascades,this._tempTransformMatricesAsArray):o;if(t.setMatrices("lightMatrix"+e,h),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===no.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);else if(this._filter===no.FILTER_PCSS){for(let e=0;e<this._numCascades;++e)this._lightSizeUVCorrection[2*e+0]=0===e?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[e].x-this._cascadeMinExtents[e].x),this._lightSizeUVCorrection[2*e+1]=0===e?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[e].y-this._cascadeMinExtents[e].y),this._depthCorrection[e]=0===e?1:(this._cascadeMaxExtents[e].z-this._cascadeMinExtents[e].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,n),t.setTexture("depthTexture"+e,n),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a,this._contactHardeningLightSizeUVRatio*a,this.frustumEdgeFalloff,e);}else t.setTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e);}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null);}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const s=t.renderList[i];e.renderList.push(s.id);}return e}static Parse(e,t){const i=no.Parse(e,t,((e,t,i)=>new th(e,t,void 0,i)));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}th._FrustumCornersNdcSpace=[new te$4(-1,1,-1),new te$4(1,1,-1),new te$4(1,-1,-1),new te$4(-1,-1,-1),new te$4(-1,1,1),new te$4(1,1,1),new te$4(1,-1,1),new te$4(-1,-1,1)],th.CLASSNAME="CascadedShadowGenerator",th.DEFAULT_CASCADES_COUNT=4,th.MIN_CASCADES_COUNT=2,th.MAX_CASCADES_COUNT=4,th._SceneComponentInitialization=e=>{throw le$4("ShadowGeneratorSceneComponent")};class ih extends la{get light(){return this._light}set light(e){e!==this._light&&(this._light=e,this._setupShadowGenerator());}get camera(){return this._camera}set camera(e){this._camera=e,this._setupShadowGenerator();}get mapSize(){return this._mapSize}set mapSize(e){e!==this._mapSize&&(this._mapSize=e,this._setupShadowGenerator());}get useFloat32TextureType(){return this._useFloat32TextureType}set useFloat32TextureType(e){e!==this._useFloat32TextureType&&(this._useFloat32TextureType=e,this._setupShadowGenerator());}get useRedTextureFormat(){return this._useRedTextureFormat}set useRedTextureFormat(e){e!==this._useRedTextureFormat&&(this._useRedTextureFormat=e,this._setupShadowGenerator());}get bias(){return this._bias}set bias(e){e!==this._bias&&(this._bias=e,this._shadowGenerator&&(this._shadowGenerator.bias=e));}get normalBias(){return this._normalBias}set normalBias(e){e!==this._normalBias&&(this._normalBias=e,this._shadowGenerator&&(this._shadowGenerator.normalBias=e));}get darkness(){return this._darkness}set darkness(e){e!==this._darkness&&(this._darkness=e,this._shadowGenerator&&(this._shadowGenerator.darkness=e));}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){e!==this._transparencyShadow&&(this._transparencyShadow=e,this._shadowGenerator&&(this._shadowGenerator.transparencyShadow=e));}get enableSoftTransparentShadow(){return this._enableSoftTransparentShadow}set enableSoftTransparentShadow(e){e!==this._enableSoftTransparentShadow&&(this._enableSoftTransparentShadow=e,this._shadowGenerator&&(this._shadowGenerator.enableSoftTransparentShadow=e));}get useOpacityTextureForTransparentShadow(){return this._useOpacityTextureForTransparentShadow}set useOpacityTextureForTransparentShadow(e){e!==this._useOpacityTextureForTransparentShadow&&(this._useOpacityTextureForTransparentShadow=e,this._shadowGenerator&&(this._shadowGenerator.useOpacityTextureForTransparentShadow=e));}get filter(){return this._filter}set filter(e){e!==this._filter&&(this._filter=e,this._shadowGenerator&&(this._shadowGenerator.filter=e));}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){e!==this._filteringQuality&&(this._filteringQuality=e,this._shadowGenerator&&(this._shadowGenerator.filteringQuality=e));}_createShadowGenerator(){this._shadowGenerator=new no(this._mapSize,this._light,this._useFloat32TextureType,void 0,this._useRedTextureFormat);}_setupShadowGenerator(){if(this._shadowGenerator?.dispose(),this._shadowGenerator=void 0,void 0!==this._light){this._createShadowGenerator();const e=this._shadowGenerator;if(void 0===e)return;e.bias=this._bias,e.normalBias=this._normalBias,e.darkness=this._darkness,e.transparencyShadow=this._transparencyShadow,e.enableSoftTransparentShadow=this._enableSoftTransparentShadow,e.useOpacityTextureForTransparentShadow=this._useOpacityTextureForTransparentShadow,e.filter=this._filter,e.filteringQuality=this._filteringQuality;const t=e.getShadowMap();t._disableEngineStages=true,t.cameraForLOD=this._camera,this.shadowGenerator=e;}}isReady(){return !!this._shadowGenerator&&!!this._shadowGenerator.getShadowMap()?.isReadyForRendering()}constructor(e,t,i){super(e,t),this._mapSize=1024,this._useFloat32TextureType=false,this._useRedTextureFormat=true,this._bias=.01,this._normalBias=0,this._darkness=0,this._transparencyShadow=false,this._enableSoftTransparentShadow=false,this._useOpacityTextureForTransparentShadow=false,this._filter=no.FILTER_PCF,this._filteringQuality=no.QUALITY_HIGH,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle();}record(){if(void 0===this.light||void 0===this.objectList||void 0===this.camera)throw new Error(`FrameGraphShadowGeneratorTask ${this.name}: light, objectList and camera are required`);const e=this._shadowGenerator.getShadowMap();e.renderList=this.objectList.meshes,e.particleSystemList=this.objectList.particleSystems;const t=this._frameGraph.textureManager.importTexture(`${this.name} shadowmap`,this._shadowGenerator.getShadowMap().getInternalTexture());this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,t);this._frameGraph.addPass(this.name).setExecuteFunc((e=>{if(!this.light.isEnabled()||!this.light.shadowEnabled)return;const t=this._shadowGenerator.getShadowMap();t.renderList=this.objectList.meshes,t.particleSystemList=this.objectList.particleSystems,e.saveDepthStates(),e.setDepthStates(true,true),e.renderUnmanaged(t),e.restoreDepthStates();}));this._frameGraph.addPass(this.name+"_disabled",true).setExecuteFunc((e=>{}));}dispose(){this._shadowGenerator?.dispose(),this._shadowGenerator=void 0;}}class sh extends la{get drawWrapper(){return this._postProcessDrawWrapper}constructor(e,t,i){super(e,t),this.sourceSamplingMode=Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,this.depthReadOnly=false,this.stencilReadOnly=false,this.disableColorWrite=false,this.drawBackFace=false,this.depthTest=true,this.postProcess=i,this._postProcessDrawWrapper=this.postProcess.drawWrapper,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthAttachmentTexture=this._frameGraph.textureManager.createDanglingHandle();}isReady(){return this.postProcess.isReady()}record(e=false,t,i){if(void 0===this.sourceTexture&&void 0===this.targetTexture)throw new Error(`FrameGraphPostProcessTask "${this.name}": sourceTexture or targetTexture is required`);const s=void 0!==this.sourceTexture?this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture):void 0;if(s&&(s.options.samples=1),this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this.name,s),void 0!==this.depthAttachmentTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthAttachmentTexture,this.depthAttachmentTexture),s){const e=this._frameGraph.textureManager.getTextureAbsoluteDimensions(s);this._sourceWidth=e.width,this._sourceHeight=e.height;}const r=this._frameGraph.textureManager.getTextureDescription(this.outputTexture);this._outputWidth=r.size.width,this._outputHeight=r.size.height;const n=this._frameGraph.addRenderPass(this.name);if(n.depthReadOnly=this.depthReadOnly,n.stencilReadOnly=this.stencilReadOnly,n.addDependencies(this.sourceTexture),n.setRenderTarget(this.outputTexture),n.setRenderTargetDepth(this.depthAttachmentTexture),n.setExecuteFunc((e=>{ void 0!==this.sourceTexture&&e.setTextureSamplingMode(this.sourceTexture,this.sourceSamplingMode),t?.(e),e.applyFullScreenEffect(this._postProcessDrawWrapper,(()=>{ void 0!==this.sourceTexture&&e.bindTextureHandle(this._postProcessDrawWrapper.effect,"textureSampler",this.sourceTexture),i?.(e),this.postProcess.bind();}),this.stencilState,this.disableColorWrite,this.drawBackFace,this.depthTest);})),!e){const e=this._frameGraph.addRenderPass(this.name+"_disabled",true);e.depthReadOnly=this.depthReadOnly,e.stencilReadOnly=this.stencilReadOnly,e.addDependencies(this.sourceTexture),e.setRenderTarget(this.outputTexture),e.setRenderTargetDepth(this.depthAttachmentTexture),e.setExecuteFunc((e=>{ void 0!==this.sourceTexture&&e.copyTexture(this.sourceTexture);}));}return n}dispose(){this.postProcess.dispose(),super.dispose();}}function rh(e){return void 0!==e.width}function nh(e){return rh(e)?{width:e.width,height:e.height}:{width:e,height:e}}class ah extends ih{static IsCascadedShadowGenerator(e){return void 0!==e.numCascades}get numCascades(){return this._numCascades}set numCascades(e){e!==this._numCascades&&(this._numCascades=e,this._setupShadowGenerator());}get debug(){return this._debug}set debug(e){e!==this._debug&&(this._debug=e,this._shadowGenerator&&(this._shadowGenerator.debug=e));}get stabilizeCascades(){return this._stabilizeCascades}set stabilizeCascades(e){e!==this._stabilizeCascades&&(this._stabilizeCascades=e,this._shadowGenerator&&(this._shadowGenerator.stabilizeCascades=e));}get lambda(){return this._lambda}set lambda(e){e!==this._lambda&&(this._lambda=e,this._shadowGenerator&&(this._shadowGenerator.lambda=e));}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){e!==this._cascadeBlendPercentage&&(this._cascadeBlendPercentage=e,this._shadowGenerator&&(this._shadowGenerator.cascadeBlendPercentage=e));}get depthClamp(){return this._depthClamp}set depthClamp(e){e!==this._depthClamp&&(this._depthClamp=e,this._shadowGenerator&&(this._shadowGenerator.depthClamp=e));}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){if(e===this._autoCalcDepthBounds)return;this._autoCalcDepthBounds=e,this._currentAutoCalcDepthBoundsCounter=this._autoCalcDepthBoundsRefreshRate,e||this._shadowGenerator?.setMinMaxDistance(0,1);const t=this.passes;for(let i=0;i<t.length-1;++i)t[i].disabled=!e;}get autoCalcDepthBoundsRefreshRate(){return this._autoCalcDepthBoundsRefreshRate}set autoCalcDepthBoundsRefreshRate(e){this._autoCalcDepthBoundsRefreshRate=e,this._currentAutoCalcDepthBoundsCounter=this._autoCalcDepthBoundsRefreshRate;}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){e!==this._shadowMaxZ&&(this._shadowMaxZ=e,this._shadowGenerator&&(this._shadowGenerator.shadowMaxZ=e));}constructor(e,t,i){super(e,t,i),this.depthTextureType=0,this._numCascades=th.DEFAULT_CASCADES_COUNT,this._debug=false,this._stabilizeCascades=false,this._lambda=.5,this._cascadeBlendPercentage=.1,this._depthClamp=true,this._autoCalcDepthBounds=false,this._currentAutoCalcDepthBoundsCounter=0,this._autoCalcDepthBoundsRefreshRate=1,this._shadowMaxZ=1e4,this._thinMinMaxReducer=new ko(i),this._thinMinMaxReducer.onAfterReductionPerformed.add((e=>{if(!this._shadowGenerator)return;const t=this.camera;let i=e.min,s=e.max;if(i>=s)i=0,s=1;else if(t&&0!==this.depthTextureType){if(2===this.depthTextureType){const e=this._frameGraph.engine,r=t.getProjectionMatrix(),n=r.m[10],a=r.m[14];e.isNDCHalfZRange||(i=2*i-1,s=2*s-1),i=a/(i-n),s=a/(s-n);}const e=t.minZ,r=t.maxZ;i=(i-e)/(r-e),s=(s-e)/(r-e);}i===this._shadowGenerator.minDistance&&s===this._shadowGenerator.maxDistance||this._shadowGenerator.setMinMaxDistance(i,s);}));}_createShadowGenerator(){if(!(this.light instanceof fn))throw new Error(`FrameGraphCascadedShadowGeneratorTask ${this.name}: the CSM shadow generator only supports directional lights.`);this._shadowGenerator=new th(this.mapSize,this.light,this.useFloat32TextureType,this.camera,this.useRedTextureFormat),this._shadowGenerator.numCascades=this._numCascades;}_setupShadowGenerator(){super._setupShadowGenerator();const e=this._shadowGenerator;void 0!==e&&(e.debug=this._debug,e.stabilizeCascades=this._stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this._cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.shadowMaxZ=this._shadowMaxZ);}record(){if(void 0===this.light||void 0===this.objectList||void 0===this.camera)throw new Error(`FrameGraphCascadedShadowGeneratorTask ${this.name}: light, objectList and camera are required`);if(void 0!==this.depthTexture){const e=this._frameGraph.textureManager.getTextureCreationOptions(this.depthTexture),t=e.sizeIsPercentage?this._frameGraph.textureManager.getAbsoluteDimensions(e.size):rh(e.size)?e.size:{width:e.size,height:e.size},i=t.width,s=t.height;e.sizeIsPercentage=false,e.options.formats=[Qe$1.TEXTUREFORMAT_RG],e.options.samples=1,this._thinMinMaxReducer.setTextureDimensions(i,s,this.depthTextureType);const r=this._thinMinMaxReducer.reductionSteps;let n;this._frameGraph.addPass(`${this.name} Before Min Max Reduction`).setExecuteFunc((e=>{e.pushDebugGroup("Min Max Reduction");}));for(let t=0;t<r.length-1;++t){const i=r[t];e.size={width:r[t+1].textureWidth,height:r[t+1].textureHeight};const s=new sh(i.name,this._frameGraph,i);s.sourceTexture=0==t?this.depthTexture:n,s.sourceSamplingMode=Qe$1.TEXTURE_NEAREST_NEAREST,s.targetTexture=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} ${i.name}`,e),s.record(true),n=s.outputTexture;}this._frameGraph.addPass(`${this.name} After Min Max Reduction`).setExecuteFunc((e=>{if(e.popDebugGroup(),this._autoCalcDepthBounds&&this._currentAutoCalcDepthBoundsCounter>=0){if(++this._currentAutoCalcDepthBoundsCounter>=this._autoCalcDepthBoundsRefreshRate){const t=e.getTextureFromHandle(n);t&&this._thinMinMaxReducer.readMinMax(t);}this._currentAutoCalcDepthBoundsCounter%=this._autoCalcDepthBoundsRefreshRate,0===this._autoCalcDepthBoundsRefreshRate&&(this._currentAutoCalcDepthBoundsCounter=-1);}}));}super.record();}dispose(){super.dispose(),this._thinMinMaxReducer.dispose();}}class oh extends la{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera;}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(e){e!==this._disableImageProcessing&&(this._disableImageProcessing=e,this._renderer.disableImageProcessing=e);}get renderParticles(){return this._renderParticles}set renderParticles(e){e!==this._renderParticles&&(this._renderParticles=e,this._renderer.renderParticles=e);}get renderSprites(){return this._renderSprites}set renderSprites(e){e!==this._renderSprites&&(this._renderSprites=e,this._renderer.renderSprites=e);}get forceLayerMaskCheck(){return this._forceLayerMaskCheck}set forceLayerMaskCheck(e){e!==this._forceLayerMaskCheck&&(this._forceLayerMaskCheck=e,this._renderer.forceLayerMaskCheck=e);}get enableBoundingBoxRendering(){return this._enableBoundingBoxRendering}set enableBoundingBoxRendering(e){e!==this._enableBoundingBoxRendering&&(this._enableBoundingBoxRendering=e,this._renderer.enableBoundingBoxRendering=e);}get enableOutlineRendering(){return this._enableOutlineRendering}set enableOutlineRendering(e){e!==this._enableOutlineRendering&&(this._enableOutlineRendering=e,this._renderer.enableOutlineRendering=e);}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e);}constructor(e,t,i,s,r){super(e,t),this.shadowGenerators=[],this.depthTest=true,this.depthWrite=true,this.disableShadows=false,this._disableImageProcessing=false,this.isMainObjectRenderer=false,this._renderParticles=true,this._renderSprites=true,this._forceLayerMaskCheck=true,this._enableBoundingBoxRendering=true,this._enableOutlineRendering=true,this._onBeforeRenderObservable=null,this._onAfterRenderObservable=null,this._externalObjectRenderer=false,this._scene=i,this._engine=i.getEngine(),this._externalObjectRenderer=!!r,this._renderer=r??new ca(e,i,s),this.name=e,this._renderer.disableImageProcessing=this._disableImageProcessing,this._renderer.renderParticles=this._renderParticles,this._renderer.renderSprites=this._renderSprites,this._renderer.enableBoundingBoxRendering=this._enableBoundingBoxRendering,this._renderer.forceLayerMaskCheck=this._forceLayerMaskCheck,this._externalObjectRenderer||this._renderer.onBeforeRenderingManagerRenderObservable.add((()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(true);})),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle();}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(e=false,t){if(void 0===this.targetTexture||void 0===this.objectList)throw new Error(`FrameGraphObjectRendererTask ${this.name}: targetTexture and objectList are required`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;const i=Array.isArray(this.targetTexture)?this.targetTexture:[this.targetTexture],s=this._frameGraph.textureManager.getTextureDescription(i[0]);let r=false;if(void 0!==this.depthTexture){if(1===this.depthTexture&&(0!==i[0]||i.length>1))throw new Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer color texture is the only color texture allowed when the depth is the back buffer depth/stencil`);if(1!==this.depthTexture&&0===i[0])throw new Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer depth/stencil texture is the only depth texture allowed when the target is the back buffer color`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==s.options.samples)throw new Error(`FrameGraphObjectRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);r=true;}this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,i[0]),void 0!==this.depthTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),this._textureWidth=s.size.width,this._textureHeight=s.size.height,this._setLightsForShadow();const n=this._frameGraph.addRenderPass(this.name);if(n.setRenderTarget(i),n.setRenderTargetDepth(this.depthTexture),n.setExecuteFunc((e=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;const i=this.getBoundingBoxRenderer?.(),s=i&&i.renderList.length>0?i.renderList.data.slice():[];i&&(s.length=i.renderList.length),e.setDepthStates(this.depthTest&&r,this.depthWrite&&r);const n=this._renderer.activeCamera;if(n&&n.cameraRigMode!==Qe$1.RIG_MODE_NONE&&!n._renderingMultiview){for(let t=0;t<n._rigCameras.length;t++){const i=n._rigCameras[t];i.rigParent=void 0,this._renderer.activeCamera=i,e.render(this._renderer,this._textureWidth,this._textureHeight),i.rigParent=n;}this._renderer.activeCamera=n;}else e.render(this._renderer,this._textureWidth,this._textureHeight);t?.(e),i&&(i.renderList.data=s,i.renderList.length=s.length);})),!e){const e=this._frameGraph.addRenderPass(this.name+"_disabled",true);e.setRenderTarget(i),e.setRenderTargetDepth(this.depthTexture),e.setExecuteFunc((e=>{}));}return n}dispose(){this._renderer.onBeforeRenderObservable.remove(this._onBeforeRenderObservable),this._renderer.onAfterRenderObservable.remove(this._onAfterRenderObservable),this._externalObjectRenderer||this._renderer.dispose(),super.dispose();}_setLightsForShadow(){const e=new Set,t=new Map;if(this.shadowGenerators)for(const t of this.shadowGenerators){const i=t.shadowGenerator,s=i.getLight();s.isEnabled()&&s.shadowEnabled&&(e.add(s),ah.IsCascadedShadowGenerator(t)?s._shadowGenerators.set(t.camera,i):s._shadowGenerators.set(null,i));}this._renderer.onBeforeRenderObservable.remove(this._onBeforeRenderObservable),this._onBeforeRenderObservable=this._renderer.onBeforeRenderObservable.add((()=>{for(let i=0;i<this._scene.lights.length;i++){const s=this._scene.lights[i];s.setShadowProjectionMatrix&&(t.set(s,s.shadowEnabled),s.shadowEnabled=!this.disableShadows&&e.has(s));}})),this._renderer.onAfterRenderObservable.remove(this._onAfterRenderObservable),this._onAfterRenderObservable=this._renderer.onAfterRenderObservable.add((()=>{for(let e=0;e<this._scene.lights.length;e++){const i=this._scene.lights[e];i.setShadowProjectionMatrix&&(i.shadowEnabled=t.get(i));}}));}}var hh,lh;!function(e){e[e.BackwardCompatible=0]="BackwardCompatible",e[e.Intermediate=1]="Intermediate",e[e.Aggressive=2]="Aggressive";}(hh||(hh={}));class ch{static DefaultMaterialFactory(e){throw le$4("StandardMaterial")}static CollisionCoordinatorFactory(){throw le$4("DefaultCollisionCoordinator")}get clearColor(){return this._clearColor}set clearColor(e){e!==this._clearColor&&(this._clearColor=e,this.onClearColorChangedObservable.notifyObservers(this._clearColor));}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case 0:this.skipFrustumClipping=false,this._renderingManager.maintainStateBetweenFrames=false,this.skipPointerMovePicking=false,this.autoClear=true;break;case 1:this.skipFrustumClipping=false,this._renderingManager.maintainStateBetweenFrames=false,this.skipPointerMovePicking=true,this.autoClear=false;break;case 2:this.skipFrustumClipping=true,this._renderingManager.maintainStateBetweenFrames=true,this.skipPointerMovePicking=true,this.autoClear=false;}this.onScenePerformancePriorityChangedObservable.notifyObservers(e);}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(Qe$1.MATERIAL_MiscDirtyFlag));}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e);}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(Qe$1.MATERIAL_MiscDirtyFlag));}get forcePointsCloud(){return this._forcePointsCloud}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.onEnvironmentTextureChangedObservable.notifyObservers(e),this.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(const t of this.skeletons)e=e.concat(t.bones);return e}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e;}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e);}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e));}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e));}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e);}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e);}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e;}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e;}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e;}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e;}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e;}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e;}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e;}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e;}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e;}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return ia.DragMovementThreshold}static set DragMovementThreshold(e){ia.DragMovementThreshold=e;}static get LongPressDelay(){return ia.LongPressDelay}static set LongPressDelay(e){ia.LongPressDelay=e;}static get DoubleClickDelay(){return ia.DoubleClickDelay}static set DoubleClickDelay(e){ia.DoubleClickDelay=e;}static get ExclusiveDoubleClickMode(){return ia.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){ia.ExclusiveDoubleClickMode=e;}bindEyePosition(e,t="vEyePosition",i=false){const s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera?.globalPosition??te$4.ZeroReadOnly,r=this.useRightHandedSystem===(null!=this._mirroredCameraPosition),n=this.floatingOriginOffset,a=this._tempVect4.set(s.x,s.y,s.z,r?-1:1),o=a.subtractFromFloatsToRef(n.x,n.y,n.z,0,ae$5.Vector4[1]);return e&&(i?e.setFloat3(t,o.x,o.y,o.z):e.setVector4(t,o)),a}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null),i=this.floatingOriginOffset;return e.updateFloat4("vEyePosition",t.x-i.x,t.y-i.y,t.z-i.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(Qe$1.MATERIAL_MiscDirtyFlag));}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e;}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(Qe$1.MATERIAL_MiscDirtyFlag));}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(Qe$1.MATERIAL_MiscDirtyFlag));}get fogMode(){return this._fogMode}get prePass(){return !!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(Qe$1.MATERIAL_LightDirtyFlag));}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(Qe$1.MATERIAL_LightDirtyFlag));}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=C$e(e,(()=>{this.onActiveCamerasChanged.notifyObservers(this);}))),this._activeCameras=e;}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this));}get _hasDefaultMaterial(){return ch.DefaultMaterialFactory!==ch._OriginalDefaultMaterialFactory}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=ch.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e;}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag));}get texturesEnabled(){return this._texturesEnabled}get frameGraph(){return this._frameGraph}set frameGraph(e){if(this._frameGraph)return this._frameGraph=e,void(e||(this.customRenderFunction=this._currentCustomRenderFunction));this._frameGraph=e,e&&(this._currentCustomRenderFunction=this.customRenderFunction,this.customRenderFunction=this._renderWithFrameGraph,this.activeCamera=null);}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(Qe$1.MATERIAL_AttributesDirtyFlag));}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=ch.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0;}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t);}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}get uniqueId(){return this._uniqueId}constructor(e,t){this._inputManager=new ia(this),this.cameraToUseForPointers=null,this._isScene=true,this._blockEntityCollection=false,this.autoClear=true,this.autoClearDepthAndStencil=true,this._clearColor=new me$3(.2,.2,.3,1),this._tempVect4=new ie$5,this.onClearColorChangedObservable=new R$g,this.ambientColor=new ge$3(0,0,0),this.environmentIntensity=1,this.iblIntensity=1,this._performancePriority=0,this.onScenePerformancePriorityChangedObservable=new R$g,this._forceWireframe=false,this._skipFrustumClipping=false,this._forcePointsCloud=false,this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.objectRenderers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.effectLayers=[],this.sounds=null,this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.animationsEnabled=true,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=false,this.constantlyUpdateMeshUnderPointer=false,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=false,this.preventDefaultOnPointerDown=true,this.preventDefaultOnPointerUp=true,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new R$g,this._onDisposeObserver=null,this.onBeforeRenderObservable=new R$g,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new R$g,this.onAfterRenderCameraObservable=new R$g,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new R$g,this.onAfterAnimationsObservable=new R$g,this.onBeforeDrawPhaseObservable=new R$g,this.onAfterDrawPhaseObservable=new R$g,this.onReadyObservable=new R$g,this.onBeforeCameraRenderObservable=new R$g,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new R$g,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new R$g,this.onAfterActiveMeshesEvaluationObservable=new R$g,this.onBeforeParticlesRenderingObservable=new R$g,this.onAfterParticlesRenderingObservable=new R$g,this.onDataLoadedObservable=new R$g,this.onNewCameraAddedObservable=new R$g,this.onCameraRemovedObservable=new R$g,this.onNewLightAddedObservable=new R$g,this.onLightRemovedObservable=new R$g,this.onNewGeometryAddedObservable=new R$g,this.onGeometryRemovedObservable=new R$g,this.onNewTransformNodeAddedObservable=new R$g,this.onTransformNodeRemovedObservable=new R$g,this.onNewMeshAddedObservable=new R$g,this.onMeshRemovedObservable=new R$g,this.onNewSkeletonAddedObservable=new R$g,this.onSkeletonRemovedObservable=new R$g,this.onNewParticleSystemAddedObservable=new R$g,this.onParticleSystemRemovedObservable=new R$g,this.onNewAnimationGroupAddedObservable=new R$g,this.onAnimationGroupRemovedObservable=new R$g,this.onNewMaterialAddedObservable=new R$g,this.onNewMultiMaterialAddedObservable=new R$g,this.onMaterialRemovedObservable=new R$g,this.onMultiMaterialRemovedObservable=new R$g,this.onNewTextureAddedObservable=new R$g,this.onTextureRemovedObservable=new R$g,this.onNewFrameGraphAddedObservable=new R$g,this.onFrameGraphRemovedObservable=new R$g,this.onNewObjectRendererAddedObservable=new R$g,this.onObjectRendererRemovedObservable=new R$g,this.onNewPostProcessAddedObservable=new R$g,this.onPostProcessRemovedObservable=new R$g,this.onNewEffectLayerAddedObservable=new R$g,this.onEffectLayerRemovedObservable=new R$g,this.onBeforeRenderTargetsRenderObservable=new R$g,this.onAfterRenderTargetsRenderObservable=new R$g,this.onBeforeStepObservable=new R$g,this.onAfterStepObservable=new R$g,this.onActiveCameraChanged=new R$g,this.onActiveCamerasChanged=new R$g,this.onBeforeRenderingGroupObservable=new R$g,this.onAfterRenderingGroupObservable=new R$g,this.onMeshImportedObservable=new R$g,this.onAnimationFileImportedObservable=new R$g,this.onEnvironmentTextureChangedObservable=new R$g,this.onMeshUnderPointerUpdatedObservable=new R$g,this._registeredForLateAnimationBindings=new Ci(256),this._pointerPickingConfiguration=new na,this.onPrePointerObservable=new R$g,this.onPointerObservable=new R$g,this.onPreKeyboardObservable=new R$g,this.onKeyboardObservable=new R$g,this._useRightHandedSystem=false,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=true,this._fogMode=ch.FOGMODE_NONE,this.fogColor=new ge$3(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=false,this._shadowsEnabled=true,this._lightsEnabled=true,this._unObserveActiveCameras=null,this._texturesEnabled=true,this._frameGraph=null,this.frameGraphs=[],this.physicsEnabled=true,this.particlesEnabled=true,this.spritesEnabled=true,this._skeletonsEnabled=true,this.lensFlaresEnabled=true,this.collisionsEnabled=true,this.gravity=new te$4(0,-9.807,0),this.postProcessesEnabled=true,this.renderTargetsEnabled=true,this.dumpNextRenderTargets=false,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=true,this._meshesForIntersections=new Ci(256),this.proceduralTexturesEnabled=true,this._totalVertices=new sa,this._activeIndices=new sa,this._activeParticles=new sa,this._activeBones=new sa,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=false,this._defaultFrameBufferCleared=false,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=[],this._isDisposed=false,this.dispatchAllSubMeshesOfActiveMeshes=false,this._activeMeshes=new Ii(256),this._processedMaterials=new Ii(256),this._renderTargets=new Ci(256),this._materialsRenderTargets=new Ci(256),this._activeParticleSystems=new Ii(256),this._activeSkeletons=new Ci(32),this._softwareSkinnedMeshes=new Ci(32),this._activeAnimatables=new Array,this._transformMatrix=re$5.Zero(),this.requireLightSorting=false,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=ur$1.Create(),this._beforeClearStage=ur$1.Create(),this._beforeRenderTargetClearStage=ur$1.Create(),this._gatherRenderTargetsStage=ur$1.Create(),this._gatherActiveCameraRenderTargetsStage=ur$1.Create(),this._isReadyForMeshStage=ur$1.Create(),this._beforeEvaluateActiveMeshStage=ur$1.Create(),this._evaluateSubMeshStage=ur$1.Create(),this._preActiveMeshStage=ur$1.Create(),this._cameraDrawRenderTargetStage=ur$1.Create(),this._beforeCameraDrawStage=ur$1.Create(),this._beforeRenderTargetDrawStage=ur$1.Create(),this._beforeRenderingGroupDrawStage=ur$1.Create(),this._beforeRenderingMeshStage=ur$1.Create(),this._afterRenderingMeshStage=ur$1.Create(),this._afterRenderingGroupDrawStage=ur$1.Create(),this._afterCameraDrawStage=ur$1.Create(),this._afterCameraPostProcessStage=ur$1.Create(),this._afterRenderTargetDrawStage=ur$1.Create(),this._afterRenderTargetPostProcessStage=ur$1.Create(),this._afterRenderStage=ur$1.Create(),this._pointerMoveStage=ur$1.Create(),this._pointerDownStage=ur$1.Create(),this._pointerUpStage=ur$1.Create(),this._geometriesByUniqueId=null,this._uniqueId=0,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._floatingOriginScene=void 0,this._floatingOriginOffsetDefault=te$4.Zero(),this._preventFreeActiveMeshesAndRenderingGroups=false,this._activeMeshesFrozen=false,this._activeMeshesFrozenButKeepClipping=false,this._skipEvaluateActiveMeshesCompletely=false,this._freezeActiveMeshesCancel=null,this._useCurrentFrameBuffer=false,this._allowPostProcessClearColor=true,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._getFloatingOriginScene=()=>this._floatingOriginScene,this._registeredActions=0,this._blockMaterialDirtyMechanism=false,this._perfCollector=null,this.activeCameras=[],this._uniqueId=this.getUniqueId();const i={useGeometryUniqueIdsMap:true,useMaterialMeshMap:true,useClonedMeshMap:true,virtual:false,...t};e=this._engine=e||L$7.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(L$7._LastCreatedScene=this,e.scenes.push(this)),(e.getCreationOptions().useLargeWorldRendering||t?.useFloatingOrigin)&&(Ln.prototype._setMatrixOverride=wn,Ln.prototype.setMatrix=function(e,t){return this._setMatrixOverride(e,On(e,t)),this},Dn.prototype._updateMatrixForUniformOverride=Fn,Dn.prototype._updateMatrixForUniform=function(e,t){this._updateMatrixForUniformOverride(e,On(e,t));},this._floatingOriginScene=this),this._uid=null,this._renderingManager=new Un(this),Rn&&(this.postProcessManager=new Rn(this)),Se$2()&&this.attachControl(),this._createUbo(),En&&(this._imageProcessingConfiguration=new En),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,t&&t.virtual||e.onNewSceneAddedObservable.notifyObservers(this);}getClassName(){return "Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e);}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e;}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e;}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++;}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer());}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=true,t=true,i=true){this._inputManager.attachControl(e,t,i);}detachControl(){this._inputManager.detachControl();}isReady(e=true){if(this._isDisposed)return  false;let t;const i=this.getEngine(),s=i.currentRenderPassId;i.currentRenderPassId=this.activeCamera?.renderPassId??s;let r=true;for(this._pendingData.length>0&&(r=false),this.prePassRenderer?.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&(r&&=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){const s=this.meshes[t];if(!s.subMeshes||0===s.subMeshes.length)continue;if(!s.isReady(true)){r=false;continue}const n=s.hasThinInstances||"InstancedMesh"===s.getClassName()||"InstancedLinesMesh"===s.getClassName()||i.getCaps().instancedArrays&&s.instances.length>0;for(const e of this._isReadyForMeshStage)e.action(s,n)||(r=false);if(!e)continue;const a=s.material||this.defaultMaterial;if(a)if(a._storeEffectOnSubMeshes)for(const e of s.subMeshes){const t=e.getMaterial();t&&t.hasRenderTargetTextures&&null!=t.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(t)&&(this._processedMaterials.push(t),this._materialsRenderTargets.concatWithNoDuplicate(t.getRenderTargetTextures()));}else a.hasRenderTargetTextures&&null!=a.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(a)&&(this._processedMaterials.push(a),this._materialsRenderTargets.concatWithNoDuplicate(a.getRenderTargetTextures()));}if(e)for(t=0;t<this._materialsRenderTargets.length;++t){this._materialsRenderTargets.data[t].isReadyForRendering()||(r=false);}for(t=0;t<this.geometries.length;t++){this.geometries[t].delayLoadState===Qe$1.DELAYLOADSTATE_LOADING&&(r=false);}if(this.activeCameras&&this.activeCameras.length>0)for(const e of this.activeCameras)e.isReady(true)||(r=false);else this.activeCamera&&(this.activeCamera.isReady(true)||(r=false));for(const e of this.particleSystems)e.isReady()||(r=false);if(this.layers)for(const e of this.layers)e.isReady()||(r=false);if(this.effectLayers)for(const e of this.effectLayers)e.isLayerReady()||(r=false);return i.areAllEffectsReady()||(r=false),i.currentRenderPassId=s,r}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null;}registerBeforeRender(e){this.onBeforeRenderObservable.add(e);}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e);}registerAfterRender(e){this.onAfterRenderObservable.add(e);}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e);}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout((()=>{this.unregisterBeforeRender(t);}));};this.registerBeforeRender(t);}executeOnceBeforeRender(e,t){ void 0!==t?setTimeout((()=>{this._executeOnceBeforeRender(e);}),t):this._executeOnceBeforeRender(e);}addPendingData(e){this._pendingData.push(e);}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);-1!==i&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this);}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=false){this.onReadyObservable.addOnce(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t);}async whenReadyAsync(e=false){return await new Promise((t=>{this.executeWhenReady((()=>{t();}),e);}))}_checkIsReady(e=false){return this._registerTransientComponents(),this.isReady(e)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout((()=>{this.incrementRenderId(),this._checkIsReady(e);}),100))}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Pe$2.Now;}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,s){i||s||!this._multiviewSceneUbo||(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag||(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Oi.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Oi.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,s):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)));}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e,t){const i=new cs(this._engine,void 0,false,e??"scene",void 0,t);return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1;}get floatingOriginMode(){return void 0!==this._floatingOriginScene}get floatingOriginOffset(){return this.floatingOriginMode&&this.activeCamera?this.activeCamera.getWorldMatrix().getTranslation():this._floatingOriginOffsetDefault}getUniqueId(){return ra.UniqueId}addMesh(e,t=false){if(!this._blockEntityCollection&&(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),Ai.SetImmediate((()=>{this.onNewMeshAddedObservable.notifyObservers(e);})),t)){const t=e.getChildMeshes();for(const e of t)this.addMesh(e);}}removeMesh(e,t=false){const i=this.meshes.indexOf(e);if(-1!==i&&(this.meshes.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t){const t=e.getChildMeshes();for(const e of t)this.removeMesh(e);}return i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneTransformNodesArray||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e));}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(-1!==t){if(t!==this.transformNodes.length-1){const e=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=e,e._indexInSceneTransformNodesArray=t;}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes();}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return  -1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return  -1!==t&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(-1!==t){for(const t of this.meshes)t._removeLightSource(e,false);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes();}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(-1!==t&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const t=this.activeCameras.indexOf(e);-1!==t&&this.activeCameras.splice(t,1);}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return  -1!==t&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),this.onParticleSystemRemovedObservable.notifyObservers(e),t}removeAnimation(e){const t=this.animations.indexOf(e);return  -1!==t&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return  -1!==t&&this.animationGroups.splice(t,1),this.onAnimationGroupRemovedObservable.notifyObservers(e),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return  -1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(-1!==t&&t<this.materials.length){if(t!==this.materials.length-1){const e=this.materials[this.materials.length-1];this.materials[t]=e,e._indexInSceneMaterialArray=t;}e._indexInSceneMaterialArray=-1,this.materials.pop();}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return  -1!==t&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return  -1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}removeFrameGraph(e){const t=this.frameGraphs.indexOf(e);return  -1!==t&&this.frameGraphs.splice(t,1),this.onFrameGraphRemovedObservable.notifyObservers(e),t}removeObjectRenderer(e){const t=this.objectRenderers.indexOf(e);return  -1!==t&&this.objectRenderers.splice(t,1),this.onObjectRendererRemovedObservable.notifyObservers(e),t}removePostProcess(e){const t=this.postProcesses.indexOf(e);return  -1!==t&&this.postProcesses.splice(t,1),this.onPostProcessRemovedObservable.notifyObservers(e),t}removeEffectLayer(e){const t=this.effectLayers.indexOf(e);return  -1!==t&&this.effectLayers.splice(t,1),this.onEffectLayerRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes) -1===t.lightSources.indexOf(e)&&(t.lightSources.push(e),t._resyncLightSources());Ai.SetImmediate((()=>{this.onNewLightAddedObservable.notifyObservers(e);}));}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(ms.CompareLightsPriority);}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),Ai.SetImmediate((()=>{this.onNewCameraAddedObservable.notifyObservers(e);})),e.parent||e._addToSceneRootNodes());}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),Ai.SetImmediate((()=>{this.onNewSkeletonAddedObservable.notifyObservers(e);})));}addParticleSystem(e){this._blockEntityCollection||(this.particleSystems.push(e),Ai.SetImmediate((()=>{this.onNewParticleSystemAddedObservable.notifyObservers(e);})));}addAnimation(e){this._blockEntityCollection||this.animations.push(e);}addAnimationGroup(e){this._blockEntityCollection||(this.animationGroups.push(e),Ai.SetImmediate((()=>{this.onNewAnimationGroupAddedObservable.notifyObservers(e);})));}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),Ai.SetImmediate((()=>{this.onNewMultiMaterialAddedObservable.notifyObservers(e);})));}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneMaterialArray||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),Ai.SetImmediate((()=>{this.onNewMaterialAddedObservable.notifyObservers(e);})));}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e);}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e));}addActionManager(e){this.actionManagers.push(e);}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e));}addFrameGraph(e){this.frameGraphs.push(e),Ai.SetImmediate((()=>{this.onNewFrameGraphAddedObservable.notifyObservers(e);}));}addObjectRenderer(e){this.objectRenderers.push(e),Ai.SetImmediate((()=>{this.onNewObjectRendererAddedObservable.notifyObservers(e);}));}addPostProcess(e){this._blockEntityCollection||(this.postProcesses.push(e),Ai.SetImmediate((()=>{this.onNewPostProcessAddedObservable.notifyObservers(e);})));}addEffectLayer(e){this._blockEntityCollection||(this.effectLayers.push(e),Ai.SetImmediate((()=>{this.onNewEffectLayerAddedObservable.notifyObservers(e);})));}switchActiveCamera(e,t=true){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl());}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let e=0;e<this.materials.length;e++){const i=this.materials[e];if(t(i))return i}if(e)for(let e=0;e<this.multiMaterials.length;e++){const i=this.multiMaterials[e];if(t(i))return i}return null}getMaterialByUniqueID(e,t=false){return this.getMaterialByUniqueId(e,t)}getMaterialByUniqueId(e,t=false){return this._getMaterial(t,(t=>t.uniqueId===e))}getMaterialById(e,t=false){return this._getMaterial(t,(t=>t.id===e))}getMaterialByName(e,t=false){return this._getMaterial(t,(t=>t.name===e))}getLastMaterialById(e,t=false){for(let t=this.materials.length-1;t>=0;t--)if(this.materials[t].id===e)return this.materials[t];if(t)for(let t=this.multiMaterials.length-1;t>=0;t--)if(this.multiMaterials[t].id===e)return this.multiMaterials[t];return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].id===e)return i.bones[t]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].name===e)return i.bones[t]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(void 0!==t)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}getFrameGraphByName(e){for(let t=0;t<this.frameGraphs.length;t++)if(this.frameGraphs[t].name===e)return this.frameGraphs[t];return null}pushGeometry(e,t){return !(!t&&this._getGeometryByUniqueId(e.uniqueId))&&(this.addGeometry(e),Ai.SetImmediate((()=>{this.onNewGeometryAddedObservable.notifyObservers(e);})),true)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],void 0===t)return  false}else if(t=this.geometries.indexOf(e),t<0)return  false;if(t!==this.geometries.length-1){const e=this.geometries[this.geometries.length-1];e&&(this.geometries[t]=e,this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=t));}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),true}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter((function(t){return t.id===e}))}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter((function(t){return t.id===e}))}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const s=this.getLightById(e);if(s)return s;const r=this.getCameraById(e);if(r)return r;const n=this.getBoneById(e);return n||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const s=this.getLightByName(e);if(s)return s;const r=this.getCameraByName(e);if(r)return r;const n=this.getBoneByName(e);return n||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const s=i.getTarget(t);if(s.id===e)return s}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const s=i.getTarget(t);if(s.name===e)return s}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return  -1!==this._activeMeshes.indexOf(e)}get uid(){return this._uid||(this._uid=Ai.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new gn),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new gn),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,s){if(s||e.isInFrustum(this._frustumPlanes)){for(const i of this._evaluateSubMeshStage)i.action(t,e);const i=e.getMaterial();null!=i&&(i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._materialsRenderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,i));}}freeProcessedMaterials(){this._processedMaterials.dispose();}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e);}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose();}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups();}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=false,t,i,s=true,r=false){if(this.frameGraph){this._renderWithFrameGraph(true,false,true);const n=this.frameGraph.getTasksByType(oh);for(const e of n)e.objectRenderer._freezeActiveMeshes(s);return this._freezeActiveMeshesCancel=Rt$1((()=>{let e=true,t=true;for(const i of n)e&&=i.objectRenderer._isFrozen,t&&=null!==i.objectRenderer._freezeActiveMeshesCancel;if(e)return  true;if(!t)throw new Error("Freezing active meshes was cancelled");return  false}),(()=>{this._freezeActiveMeshesCancel=null,this._activeMeshesFrozen=true,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,t?.();}),((e,t)=>{if(this._freezeActiveMeshesCancel=null,this.unfreezeActiveMeshes(),t){const t="Scene: Timeout while waiting for meshes to be frozen.";i?i(t):(Ie$2.Error(t),e&&Ie$2.Error(e));}else {const t="Scene: An unexpected error occurred while trying to freeze active meshes.";i?i(t):(Ie$2.Error(t),e&&(Ie$2.Error(e),e.stack&&Ie$2.Error(e.stack)));}})),this}return this.executeWhenReady((()=>{if(this.activeCamera){if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=true,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,s)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();t&&t();}else i&&i("No active camera found");})),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=false);}if(this._freezeActiveMeshesCancel?.(),this._freezeActiveMeshesCancel=null,this.frameGraph){const e=this.frameGraph.getTasksByType(oh);for(const t of e)t.objectRenderer._unfreezeActiveMeshes();}else for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=false,this}_executeActiveContainerCleanup(e){(!this._engine.snapshotRendering||this._engine.snapshotRenderingMode!==Qe$1.SNAPSHOTRENDERING_FAST)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce((()=>e.dispose()));}_evaluateActiveMeshes(){if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===Qe$1.SNAPSHOTRENDERING_FAST)return void(this._activeMeshes.length>0&&(this.activeCamera?._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset()));if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const e=this._activeMeshes.length;for(let t=0;t<e;t++){this._activeMeshes.data[t].computeWorldMatrix();}}if(this._activeParticleSystems){const e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate();}return void this._renderingManager.resetSprites()}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const e of this._beforeEvaluateActiveMeshStage)e.action();const e=this.getActiveMeshCandidates(),t=e.length;for(let i=0;i<t;i++){const t=e.data[i];let s=t._internalAbstractMeshDataInfo._currentLOD.get(this.activeCamera);if(s?s[1]=-1:(s=[t,-1],t._internalAbstractMeshDataInfo._currentLOD.set(this.activeCamera,s)),t.isBlocked)continue;if(this._totalVertices.addCount(t.getTotalVertices(),false),!t.isReady()||!t.isEnabled()||t.scaling.hasAZeroComponent)continue;t.computeWorldMatrix(),t.actionManager&&t.actionManager.hasSpecificTriggers2(Qe$1.ACTION_OnIntersectionEnterTrigger,Qe$1.ACTION_OnIntersectionExitTrigger)&&this._meshesForIntersections.pushNoDuplicate(t);let r=this.customLODSelector?this.customLODSelector(t,this.activeCamera):t.getLOD(this.activeCamera);if(s[0]=r,s[1]=this._frameId,null!=r&&(r!==t&&0!==r.billboardMode&&r.computeWorldMatrix(),t._preActivate(),t.isVisible&&t.visibility>0&&0!==(t.layerMask&this.activeCamera.layerMask)&&(this._skipFrustumClipping||t.alwaysSelectAsActiveMesh||t.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(t),this.activeCamera._activeMeshes.push(t),r!==t&&r._activate(this._renderId,false);for(const e of this._preActiveMeshStage)e.action(t);t._activate(this._renderId,false)&&(t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(r=t):r._internalAbstractMeshDataInfo._onlyForInstances=false,r._internalAbstractMeshDataInfo._isActive=true,this._activeMesh(t,r)),t._postActivate();}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let e=0;e<this.particleSystems.length;e++){const t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;const i=t.emitter;i.position&&!i.isEnabled()||(this._activeParticleSystems.push(t),t.animate(),this._renderingManager.dispatchParticles(t));}this.onAfterParticlesRenderingObservable.notifyObservers(this);}}_prepareSkeleton(e){this._skeletonsEnabled&&e.skeleton&&(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&(e.skeleton.prepare(),this._activeBones.addCount(e.skeleton.bones.length,false)),e.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(e)&&this.frameGraph&&e.applySkeleton(e.skeleton));}_activeMesh(e,t){this._prepareSkeleton(t);let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const s=this.getActiveSubMeshCandidates(t),r=s.length;i=i||1===r;for(let n=0;n<r;n++){const r=s.data[n];this._evaluateSubMesh(r,t,e,i);}}}updateTransformMatrix(e){const t=this.activeCamera;if(t)if(t._renderingMultiview){const i=t._rigCameras[0],s=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),s.getViewMatrix(),s.getProjectionMatrix(e));}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e));}_bindFrameBuffer(e,t=true){this._useCurrentFrameBuffer||(e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer()),t&&this._clearFrameBuffer(e);}_clearFrameBuffer(e){if(e&&e._multiviewTexture);else if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||e.isRightCamera||(this.autoClear&&this._engine.clear(t.clearColor||this._clearColor,!t._cleared,true,true),t._cleared=true);}else this._defaultFrameBufferCleared?this._engine.clear(null,false,true,true):(this._defaultFrameBufferCleared=true,this._clear());}_renderForCamera(e,t,i=true){if(e&&e._skipRendering)return;const s=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(s.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let t=true;e._renderingMultiview&&e.outputRenderTarget&&(t=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=false,e.outputRenderTarget.skipInitialClear=false)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=t);}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let e=0;e<this._softwareSkinnedMeshes.length;e++){const t=this._softwareSkinnedMeshes.data[e];t.applySkeleton(t.skeleton);}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const e of this._gatherActiveCameraRenderTargetsStage)e.action(this._renderTargets);let r=false;if(this.renderTargetsEnabled){if(this._intermediateRendering=true,this._renderTargets.length>0){Ai.StartPerformanceCounter("Render targets",this._renderTargets.length>0);const e=this.getBoundingBoxRenderer?.();let t;for(let i=0;i<this._renderTargets.length;i++){const s=this._renderTargets.data[i];if(s._shouldRender()){this._renderId++;const i=s.activeCamera&&s.activeCamera!==this.activeCamera;e&&!t&&(t=e.renderList.length>0?e.renderList.data.slice():[],t.length=e.renderList.length),s.render(i,this.dumpNextRenderTargets),r=true;}}e&&t&&(e.renderList.data=t,e.renderList.length=t.length),Ai.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++;}for(const e of this._cameraDrawRenderTargetStage)r=e.action(this.activeCamera)||r;this._intermediateRendering=false;}this._engine.currentRenderPassId=e.outputRenderTarget?.renderPassId??e.renderPassId??Qe$1.RENDERPASS_MAIN,r&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,false),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||e._multiviewTexture||this.prePass||this.postProcessManager._prepareFrame();for(const e of this._beforeCameraDrawStage)e.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this);const n=s.snapshotRendering&&s.snapshotRenderingMode===Qe$1.SNAPSHOTRENDERING_FAST;n&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,true,!n),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const e of this._afterCameraDrawStage)e.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,t);}for(const e of this._afterCameraPostProcessStage)e.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera);}_processSubCameras(e,t=true){if(e.cameraRigMode===Qe$1.RIG_MODE_NONE||e._renderingMultiview)return e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),void this.onAfterRenderCameraObservable.notifyObservers(e);if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else {this.onBeforeCameraRenderObservable.notifyObservers(e);for(let t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e);}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e);}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let e=0;t.actionManager&&e<t.actionManager.actions.length;e++){const i=t.actionManager.actions[e];if(i.trigger===Qe$1.ACTION_OnIntersectionEnterTrigger||i.trigger===Qe$1.ACTION_OnIntersectionExitTrigger){const e=i.getTriggerParameter(),s=e.mesh?e.mesh:e,r=s.intersectsMesh(t,e.usePreciseIntersection),n=t._intersectionsInProgress.indexOf(s);r&&-1===n?i.trigger===Qe$1.ACTION_OnIntersectionEnterTrigger?(i._executeCurrent(An.CreateNew(t,void 0,s)),t._intersectionsInProgress.push(s)):i.trigger===Qe$1.ACTION_OnIntersectionExitTrigger&&t._intersectionsInProgress.push(s):!r&&n>-1&&(i.trigger===Qe$1.ACTION_OnIntersectionExitTrigger&&i._executeCurrent(An.CreateNew(t,void 0,s)),t.actionManager.hasSpecificTrigger(Qe$1.ACTION_OnIntersectionExitTrigger,(e=>{const t=e.mesh?e.mesh:e;return s===t}))&&i.trigger!==Qe$1.ACTION_OnIntersectionExitTrigger||t._intersectionsInProgress.splice(n,1));}}}}_advancePhysicsEngineStep(e){}_animate(e){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(ch.MinDeltaTime,Math.min(this._engine.getDeltaTime(),ch.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let s=0;const r=this._engine.getLockstepMaxSteps();let n=Math.floor(e/t);for(n=Math.min(n,r);e>0&&s<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(t),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,s++,e-=t;this._timeAccumulator=e<0?0:e;}else {const e=this.useConstantAnimationDeltaTime?16:Math.max(ch.MinDeltaTime,Math.min(this._engine.getDeltaTime(),ch.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e);}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this._clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil);}_checkCameraRenderTarget(e){if(e?.outputRenderTarget&&!e?.isRigCamera&&(e.outputRenderTarget._cleared=false),e?.rigCameras?.length)for(let t=0;t<e.rigCameras.length;++t){const i=e.rigCameras[t].outputRenderTarget;i&&(i._cleared=false);}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e);}_renderWithFrameGraph(e=true,t=false,i=false){if(this.activeCamera=null,this.activeCameras=null,e)for(const e of this.cameras)if(e.update(),e.cameraRigMode!==Qe$1.RIG_MODE_NONE)for(let t=0;t<e._rigCameras.length;t++)e._rigCameras[t].update();this.onBeforeRenderObservable.notifyObservers(this);for(const e of this._beforeClearStage)e.action();if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===Qe$1.SNAPSHOTRENDERING_FAST)this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset();else {const e=this.getActiveMeshCandidates(),t=e.length;if(this._activeMeshesFrozen){if(!this._skipEvaluateActiveMeshesCompletely)for(let i=0;i<t;i++){const t=e.data[i];t._internalAbstractMeshDataInfo._wasActiveLastFrame&&t.computeWorldMatrix();}if(this.particlesEnabled){const e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate();}}else {this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset();for(let s=0;s<t;s++){const t=e.data[s];t._internalAbstractMeshDataInfo._wasActiveLastFrame=false,t.isBlocked||(this._totalVertices.addCount(t.getTotalVertices(),false),t.isReady()&&t.isEnabled()&&!t.scaling.hasAZeroComponent&&(t.computeWorldMatrix(i),t.actionManager&&t.actionManager.hasSpecificTriggers2(Qe$1.ACTION_OnIntersectionEnterTrigger,Qe$1.ACTION_OnIntersectionExitTrigger)&&this._meshesForIntersections.pushNoDuplicate(t)));}if(this.particlesEnabled)for(let e=0;e<this.particleSystems.length;e++){const t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;const i=t.emitter;i.position&&!i.isEnabled()||(this._activeParticleSystems.push(t),t.animate());}}}this.frameGraph?.execute();}_renderRenderTarget(e,t,i=false,s=false){if(this._intermediateRendering=true,e._shouldRender()){if(this._renderId++,this.activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");this._engine.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),e.render(i,s);}this._intermediateRendering=false;}render(e=true,t=false){if(!this.isDisposed){if(this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),Mn.getScene=this._getFloatingOriginScene,this._frameId++,this._defaultFrameBufferCleared=false,this._checkCameraRenderTarget(this.activeCamera),this.activeCameras?.length)for(const e of this.activeCameras)this._checkCameraRenderTarget(e);this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(Qe$1.ACTION_OnEveryFrameTrigger),t||this.animate();for(const e of this._beforeCameraUpdateStage)e.action();if(e)if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];if(t.update(),t.cameraRigMode!==Qe$1.RIG_MODE_NONE)for(let e=0;e<t._rigCameras.length;e++)t._rigCameras[e].update();}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==Qe$1.RIG_MODE_NONE))for(let e=0;e<this.activeCamera._rigCameras.length;e++)this.activeCamera._rigCameras[e].update();if(this.customRenderFunction)this._renderId++,this._engine.currentRenderPassId=Qe$1.RENDERPASS_MAIN,this.customRenderFunction(e,t);else {this.onBeforeRenderObservable.notifyObservers(this),this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const e=this.activeCameras?.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){Ai.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);for(let t=0;t<this.customRenderTargets.length;t++){const i=this.customRenderTargets[t],s=i.activeCamera||this.activeCamera;this._renderRenderTarget(i,s,e!==s,this.dumpNextRenderTargets);}Ai.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._renderId++;}this._engine.currentRenderPassId=e?.renderPassId??Qe$1.RENDERPASS_MAIN,this.activeCamera=e,this._activeCamera&&this._activeCamera.cameraRigMode!==Qe$1.RIG_MODE_CUSTOM&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,false),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const e of this._beforeClearStage)e.action();this._clearFrameBuffer(this.activeCamera);for(const e of this._gatherRenderTargetsStage)e.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++)this._processSubCameras(this.activeCameras[e],e>0);else {if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget);}}this._checkIntersections();for(const e of this._afterRenderStage)e.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let e=0;e<this._toBeDisposed.length;e++){const t=this._toBeDisposed[e];t&&t.dispose();}this._toBeDisposed.length=0;}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=false),this._activeBones.addCount(0,true),this._activeIndices.addCount(0,true),this._activeParticles.addCount(0,true),this._engine.restoreDefaultFramebuffer();}}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze();}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze();}dispose(){if(this.isDisposed)return;if(this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this._activeAnimatables&&this.stopAllAnimations){for(const e of this._activeAnimatables)e.onAnimationEndObservable.clear(),e.onAnimationEnd=null;this.stopAllAnimations();}this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const t of e)t.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this);}catch(e){Ie$2.Error("An error occurred while calling onDisposeObservable!",e);}this.detachControl();if(this._engine.getInputElement())for(let e=0;e<this.cameras.length;e++)this.cameras[e].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.meshes,(e=>e.dispose(true))),this._disposeList(this.transformNodes,(e=>e.dispose(true)));const t=this.cameras;this._disposeList(t),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._disposeList(this.frameGraphs),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let i=this._engine.scenes.indexOf(this);if(i>-1&&this._engine.scenes.splice(i,1),this._floatingOriginScene=void 0,0===this._engine.scenes.length&&(Nt$1.prototype.setMatrix=wn,Ln._setMatrixOverride=void 0,Dn.prototype._updateMatrixForUniform=Fn,Dn.prototype._updateMatrixForUniformOverride=void 0),L$7._LastCreatedScene===this){L$7._LastCreatedScene=null;let e=L$7.Instances.length-1;for(;e>=0;){const t=L$7.Instances[e];if(t.scenes.length>0){L$7._LastCreatedScene=t.scenes[this._engine.scenes.length-1];break}e--;}}i=this._engine._virtualScenes.indexOf(this),i>-1&&this._engine._virtualScenes.splice(i,1),this._engine.wipeCaches(true),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onNewFrameGraphAddedObservable.clear(),this.onFrameGraphRemovedObservable.clear(),this.onNewObjectRendererAddedObservable.clear(),this.onObjectRendererRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this.onClearColorChangedObservable.clear(),this.onEnvironmentTextureChangedObservable.clear(),this.onMeshUnderPointerUpdatedObservable.clear(),this._isDisposed=true;}_disposeList(e,t){const i=e.slice(0);t=t??(e=>e.dispose());for(const e of i)t(e);e.length=0;}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e].geometry;t&&t.clearCachedData();}}cleanCachedTextureBuffer(){for(const e of this.textures){e._buffer&&(e._buffer=null);}}getWorldExtends(e){const t=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new te$4(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);e=e||(()=>true);const s=this.meshes.filter(e);for(const e of s){if(e.computeWorldMatrix(true),!e.subMeshes||0===e.subMeshes.length||e.infiniteDistance)continue;const s=e.getBoundingInfo(),r=s.boundingBox.minimumWorld,n=s.boundingBox.maximumWorld;te$4.CheckExtends(r,t,i),te$4.CheckExtends(n,t,i);}return {min:t,max:i}}createPickingRay(e,t,i,s,r=false){throw le$4("Ray")}createPickingRayToRef(e,t,i,s,r,n=false,a=false){throw le$4("Ray")}createPickingRayInCameraSpace(e,t,i){throw le$4("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,s){throw le$4("Ray")}pick(e,t,i,s,r,n){const a=le$4("Ray",true);return a&&Ie$2.Warn(a),new ls}pickWithBoundingInfo(e,t,i,s,r){const n=le$4("Ray",true);return n&&Ie$2.Warn(n),new ls}pickWithRay(e,t,i,s){throw le$4("Ray")}multiPick(e,t,i,s,r){throw le$4("Ray")}multiPickWithRay(e,t,i){throw le$4("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i);}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild();}_rebuildTextures(){for(const e of this.textures)e._rebuild(true);this.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}_getByTags(e,t,i){if(void 0===t)return e;const s=[];for(const r in e){const n=e[r];ue$4&&ue$4.MatchesQuery(n,t)&&(!i||i(n))&&s.push(n);}return s}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s);}setRenderingAutoClearDepthStencil(e,t,i=true,s=true){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,s);}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e;}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(Qe$1.MATERIAL_AllDirtyFlag));}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e);}_loadFile(e,t,i,s,r,n,a){const o=si(e,t,i,s?this.offlineProvider:void 0,r,n,a);return this._activeRequests.push(o),o.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1);})),o}async _loadFileAsync(e,t,i,s,r){return await new Promise(((n,a)=>{this._loadFile(e,(e=>{n(e);}),t,i,s,((e,t)=>{a(t);}),r);}))}_requestFile(e,t,i,s,r,n,a){const o=ri(e,t,i,s?this.offlineProvider:void 0,r,n,a);return this._activeRequests.push(o),o.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1);})),o}async _requestFileAsync(e,t,i,s,r){return await new Promise(((n,a)=>{this._requestFile(e,(e=>{n(e);}),t,i,s,(e=>{a(e);}),r);}))}_readFile(e,t,i,s,r){const n=ii(e,t,i,s,r);return this._activeRequests.push(n),n.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1);})),n}async _readFileAsync(e,t,i){return await new Promise(((s,r)=>{this._readFile(e,(e=>{s(e);}),t,i,(e=>{r(e);}));}))}getPerfCollector(){throw le$4("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}ch.FOGMODE_NONE=Qe$1.FOGMODE_NONE,ch.FOGMODE_EXP=Qe$1.FOGMODE_EXP,ch.FOGMODE_EXP2=Qe$1.FOGMODE_EXP2,ch.FOGMODE_LINEAR=Qe$1.FOGMODE_LINEAR,ch.MinDeltaTime=1,ch.MaxDeltaTime=1e3,ch._OriginalDefaultMaterialFactory=ch.DefaultMaterialFactory,P$9("BABYLON.Scene",ch),function(e){e[e.Clean=0]="Clean",e[e.Stop=1]="Stop",e[e.Sync=2]="Sync",e[e.NoSync=3]="NoSync";}(lh||(lh={}));const uh=new R$g,dh={};function _h(){return dh[".babylon"]}function fh(e,t){const i=dh[e];return i||(Ie$2.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),t?_h():void 0)}async function ph(e,t,i,s,r,n,a,o,h){const l="data:"===(c=e.url).substring(0,5)?c.substring(5):null;var c;if(e.rawData&&!a)throw "When using ArrayBufferView to load data the file extension must be provided.";const u=l||a?"":function(e){const t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));const i=e.lastIndexOf(".");return e.substring(i,e.length).toLowerCase()}(e.url);let d=a?fh(a,true):l?function(e){for(const t in dh){const i=dh[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return dh[t]}return _h()}(e.url):fh(u,false);if(!d&&u){if(e.url&&!e.url.startsWith("blob:")){const t=await async function(e,t){const i=t.method||"GET";return await new Promise(((s,r)=>{const n=new Oe$3;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const e={};if(t.responseHeaders)for(const i of t.responseHeaders)e[i]=n.getResponseHeader(i)||"";s({response:n.response,headerValues:e});}else r(`Unable to fetch data from ${e}. Error code: ${n.status}`);})),n.open(i,e),n.send();}))}(e.url,{method:"HEAD",responseHeaders:["Content-Type"]}),i=t.headerValues?t.headerValues["Content-Type"]:"";i&&(d=function(e){for(const t in dh){const i=dh[t];if(i.mimeType===e)return i}}(i));}d||(d=_h());}if(!d)throw new Error(`No plugin or fallback for ${a??e.url}`);if(false===h?.[d.plugin.name]?.enabled)throw new Error(`The '${d.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(e.rawData&&!d.isBinary)throw "Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return (e=>{if(d.plugin.createPlugin){const t=d.plugin.createPlugin(h??{});return t instanceof Promise?(t.then(e).catch((e=>{r("Error instantiating plugin.",e);})),null):(e(t),t)}return e(d.plugin),d.plugin})((h=>{if(!h)throw `The loader plugin corresponding to the '${a}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(uh.notifyObservers(h),l&&(h.canDirectLoad&&h.canDirectLoad(e.url)||!oi(e.url))){if(h.directLoad){const e=h.directLoad(t,l);e instanceof Promise?e.then((e=>{i(h,e);})).catch((e=>{r("Error in directLoad of _loadData: "+e,e);})):i(h,e);}else i(h,l);return}const c=d.isBinary,u=(e,s)=>{t.isDisposed?r("Scene has been disposed"):i(h,e,s);};let _=null,f=false;h.onDisposeObservable?.add((()=>{f=true,_&&(_.abort(),_=null),n();}));const p=()=>{if(f)return;const i=(e,t)=>{r(e?.statusText,t);};if(!h.loadFile&&e.rawData)throw "Plugin does not support loading ArrayBufferView.";_=h.loadFile?h.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,u,s,c,i,o):t._loadFile(e.file||e.url,u,s,true,c,i);},g=t.getEngine();let m=g.enableOfflineSupport;if(m){let i=false;for(const s of t.disableOfflineSupportExceptionRules)if(s.test(e.url)){i=true;break}m=!i;}m&&jt.OfflineProviderFactory?t.offlineProvider=jt.OfflineProviderFactory(e.url,p,g.disableManifestCheck):p();}))}function gh(e){if("string"==typeof e.extensions){const t=e.extensions;dh[t.toLowerCase()]={plugin:e,isBinary:false};}else {const t=e.extensions,i=Object.keys(t);for(const s of i)dh[s.toLowerCase()]={plugin:e,isBinary:t[s].isBinary,mimeType:t[s].mimeType};}}async function mh(e,t="",i=L$7.LastCreatedScene,s=null,r=null,n=null,a=null,o="",h={}){if(!i)return Ie$2.Error("No scene available to load asset container to"),null;const l=function(e,t){let i,s,r=null,n=null;if(t)if(t.name)i=`file:${t.name}`,s=t.name,r=t;else if(ArrayBuffer.isView(t))i="",s=_i(),n=t;else if(t.startsWith("data:"))i=t,s="";else if(e){const r=t;if("/"===r.substring(0,1))return Ai.Error("Wrong sceneFilename parameter"),null;i=e+r,s=r;}else i=t,s=Ai.GetFilename(t),e=Ai.GetFolderPath(t);else i=e,s=Ai.GetFilename(e),e=Ai.GetFolderPath(e);return {url:i,rootUrl:e,name:s,file:r,rawData:n}}(e,t);if(!l)return null;const c={};i.addPendingData(c);const u=()=>{i.removePendingData(c);},d=(e,t)=>{const s=function(e,t,i){let s="Unable to load from "+(e.rawData?"binary data":e.url);return t?s+=`: ${t}`:i&&(s+=`: ${i}`),s}(l,e,t);n?n(i,s,new we$3(s,Fe$2.SceneLoaderError,t)):Ie$2.Error(s),u();},_=r?e=>{try{r(e);}catch(e){d("Error in onProgress callback",e);}}:void 0,f=e=>{if(s)try{s(e);}catch(e){d("Error in onSuccess callback",e);}i.removePendingData(c);};return await ph(l,i,((e,t)=>{if(e.loadAssetContainer){const s=e.loadAssetContainer(i,t,l.rootUrl,d);if(!s)return;s.populateRootNodes(),i.loadingPluginName=e.name,f(s);}else if(e.loadAssetContainerAsync){e.loadAssetContainerAsync(i,t,l.rootUrl,_,l.name).then((t=>{t.populateRootNodes(),i.loadingPluginName=e.name,f(t);})).catch((e=>{d(e.message,e);}));}else d("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.");}),_,d,u,a,o,h)}async function Th(e,t,i){const{rootUrl:s="",onProgress:r,pluginExtension:n,name:a,pluginOptions:o}=i??{};return await async function(e,t,i,s,r,n,a){return await new Promise(((o,h)=>{try{mh(e,t,i,(e=>{o(e);}),s,((e,t,i)=>{h(i||new Error(t));}),r,n,a).catch(h);}catch(e){h(e);}}))}(s,e,t,r,n,a,o)}class Eh{constructor(e){if(this.VERTEXOUTPUT_INVARIANT=false,this._keys=[],this._isDirty=true,this._areLightsDirty=true,this._areLightsDisposed=false,this._areAttributesDirty=true,this._areTexturesDirty=true,this._areFresnelDirty=true,this._areMiscDirty=true,this._arePrePassDirty=true,this._areImageProcessingDirty=true,this._normals=false,this._uvs=false,this._needNormals=false,this._needUVs=false,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t);}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=false,this._areAttributesDirty=false,this._areTexturesDirty=false,this._areFresnelDirty=false,this._areLightsDirty=false,this._areLightsDisposed=false,this._areMiscDirty=false,this._arePrePassDirty=false,this._areImageProcessingDirty=false;}markAsUnprocessed(){this._isDirty=true;}markAllAsDirty(){this._areTexturesDirty=true,this._areAttributesDirty=true,this._areLightsDirty=true,this._areFresnelDirty=true,this._areMiscDirty=true,this._arePrePassDirty=true,this._areImageProcessingDirty=true,this._isDirty=true;}markAsImageProcessingDirty(){this._areImageProcessingDirty=true,this._isDirty=true;}markAsLightDirty(e=false){this._areLightsDirty=true,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=true;}markAsAttributesDirty(){this._areAttributesDirty=true,this._isDirty=true;}markAsTexturesDirty(){this._areTexturesDirty=true,this._isDirty=true;}markAsFresnelDirty(){this._areFresnelDirty=true,this._isDirty=true;}markAsMiscDirty(){this._areMiscDirty=true,this._isDirty=true;}markAsPrePassDirty(){this._arePrePassDirty=true,this._isDirty=true;}rebuild(){this._keys.length=0;for(const e of Object.keys(this))"_"!==e[0]&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties) -1===this._keys.indexOf(e)&&this._keys.push(e);}isEqual(e){if(this._keys.length!==e._keys.length)return  false;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return  false}return  true}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i];}}reset(){for(const e of this._keys)this._setDefaultValue(e);}_setDefaultValue(e){const t=this._externalProperties?.[e]?.type??typeof this[e],i=this._externalProperties?.[e]?.default;switch(t){case "number":this[e]=i??0;break;case "string":this[e]=i??"";break;default:this[e]=i??false;}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=this[i];switch(typeof s){case "number":case "string":e+="#define "+i+" "+s+"\n";break;default:s&&(e+="#define "+i+"\n");}}return e}}class Ah extends hr$1{constructor(e,t,i=true,s=false){super(e,t,void 0,s),this._normalMatrix=new re$5,this._storeEffectOnSubMeshes=i;}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return !!e&&(!this._storeEffectOnSubMeshes||(!e.subMeshes||0===e.subMeshes.length||this.isReadyForSubMesh(e,e.subMeshes[0],t)))}_isReadyForSubMesh(e){const t=e.materialDefines;return !(this.checkReadyOnEveryCall||!e.effect||!t||t._renderId!==this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e);}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e);}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0]);}_afterBind(e,t=null,i){super._afterBind(e,t,i),this.getScene()._cachedEffect=t,i?i._drawWrapper._forceRebindOnNextCall=false:this._drawWrapper._forceRebindOnNextCall=false;}_mustRebind(e,t,i,s=1){return i._drawWrapper._forceRebindOnNextCall||e.isCachedMaterialInvalid(this,t,s)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i);}}function Rh(e){return class extends e{constructor(){super(...arguments),this.IMAGEPROCESSING=false,this.VIGNETTE=false,this.VIGNETTEBLENDMODEMULTIPLY=false,this.VIGNETTEBLENDMODEOPAQUE=false,this.TONEMAPPING=0,this.CONTRAST=false,this.COLORCURVES=false,this.COLORGRADING=false,this.COLORGRADING3D=false,this.SAMPLER3DGREENDEPTH=false,this.SAMPLER3DBGRMAP=false,this.DITHER=false,this.IMAGEPROCESSINGPOSTPROCESS=false,this.SKIPFINALCOLORCLAMP=false,this.EXPOSURE=false;}}}function bh(e){return class extends e{constructor(...e){super(...e),f$z.call(this,this,"_imageProcessingConfiguration");}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsImageProcessingDirty&&this._markAllSubMeshesAsImageProcessingDirty();}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),!e&&this.getScene?this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration:e&&(this._imageProcessingConfiguration=e),this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty&&this._markAllSubMeshesAsImageProcessingDirty();}))));}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e;}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e;}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e;}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e;}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e;}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e;}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e;}}}class Sh extends Eh{}class xh extends(Rh(Sh)){constructor(){super(),this.DIFFUSE=false,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=false,this.DIFFUSEHASALPHA=false,this.OPACITYFRESNEL=false,this.REFLECTIONBLUR=false,this.REFLECTIONFRESNEL=false,this.REFLECTIONFALLOFF=false,this.TEXTURELODSUPPORT=false,this.PREMULTIPLYALPHA=false,this.USERGBCOLOR=false,this.USEHIGHLIGHTANDSHADOWCOLORS=false,this.BACKMAT_SHADOWONLY=false,this.NOISE=false,this.REFLECTIONBGR=false,this.PROJECTED_GROUND=false,this.REFLECTION=false,this.REFLECTIONMAP_3D=false,this.REFLECTIONMAP_SPHERICAL=false,this.REFLECTIONMAP_PLANAR=false,this.REFLECTIONMAP_CUBIC=false,this.REFLECTIONMAP_PROJECTION=false,this.REFLECTIONMAP_SKYBOX=false,this.REFLECTIONMAP_EXPLICIT=false,this.REFLECTIONMAP_EQUIRECTANGULAR=false,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false,this.INVERTCUBICMAP=false,this.REFLECTIONMAP_OPPOSITEZ=false,this.LODINREFLECTIONALPHA=false,this.GAMMAREFLECTION=false,this.RGBDREFLECTION=false,this.EQUIRECTANGULAR_RELFECTION_FOV=false,this.MAINUV1=false,this.MAINUV2=false,this.UV1=false,this.UV2=false,this.CLIPPLANE=false,this.CLIPPLANE2=false,this.CLIPPLANE3=false,this.CLIPPLANE4=false,this.CLIPPLANE5=false,this.CLIPPLANE6=false,this.POINTSIZE=false,this.FOG=false,this.NORMAL=false,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=false,this.SHADOWFLOAT=false,this.LOGARITHMICDEPTH=false,this.NONUNIFORMSCALING=false,this.ALPHATEST=false,this.rebuild();}}class Mh extends(bh(Ah)){}class yh extends Mh{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty();}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty();}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty();}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t*=2,this.reflectionReflectance0=yh.StandardReflectance0*t,this.reflectionReflectance90=yh.StandardReflectance90*t):(t=2*t-1,this.reflectionReflectance0=yh.StandardReflectance0+(1-yh.StandardReflectance0)*t,this.reflectionReflectance90=yh.StandardReflectance90+(1-yh.StandardReflectance90)*t);}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e));}constructor(e,t,i=false){super(e,t,void 0,i),this.primaryColor=ge$3.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=te$4.Zero(),this.opacityFresnel=true,this.reflectionFresnel=false,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=true,this.enableNoise=false,this._fovMultiplier=1,this.useEquirectangularFOV=false,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=false,this.shadowOnly=false,this.switchToBGR=false,this._enableGroundProjection=false,this.enableGroundProjection=false,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new Ii(16),this._reflectionControls=ie$5.Zero(),this._white=ge$3.White(),this._primaryShadowColor=ge$3.Black(),this._primaryHighlightColor=ge$3.Black(),this._shadersLoaded=false,this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets);}get hasRenderTargetTextures(){return !(!this._diffuseTexture||!this._diffuseTexture.isRenderTarget)||!(!this._reflectionTexture||!this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return  true}needAlphaBlending(){return this.alpha<1||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=false){const s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return  true;t.materialDefines||(t.materialDefines=new xh);const r=this.getScene(),n=t.materialDefines;if(this._isReadyForSubMesh(t))return  true;const a=r.getEngine();if(Qs(r,e,n,false,this._maxSimultaneousLights),n._needNormals=true,er$1(r,n),n._areTexturesDirty){if(n._needUVs=false,r.texturesEnabled){if(r.getEngine().getCaps().textureLOD&&(n.TEXTURELODSUPPORT=true),this._diffuseTexture&&bs.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return  false;ks(this._diffuseTexture,n,"DIFFUSE"),n.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,n.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,n.OPACITYFRESNEL=this._opacityFresnel;}else n.DIFFUSE=false,n.DIFFUSEDIRECTUV=0,n.DIFFUSEHASALPHA=false,n.GAMMADIFFUSE=false,n.OPACITYFRESNEL=false;const e=this._reflectionTexture;if(qs(r,e,n),e&&bs.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return  false;n.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,n.REFLECTIONBGR=this.switchToBGR,n.REFLECTIONBLUR=this._reflectionBlur>0,this.reflectionFresnel?(n.REFLECTIONFRESNEL=true,n.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(n.REFLECTIONFRESNEL=false,n.REFLECTIONFALLOFF=false);}else n.REFLECTIONFRESNEL=false,n.REFLECTIONFALLOFF=false,n.REFLECTIONBLUR=false;}n.PREMULTIPLYALPHA=this.alphaMode===Qe$1.ALPHA_PREMULTIPLIED||this.alphaMode===Qe$1.ALPHA_PREMULTIPLIED_PORTERDUFF,n.USERGBCOLOR=this._useRGBColor,n.NOISE=this._enableNoise;}if(n._areLightsDirty&&(n.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel),n.BACKMAT_SHADOWONLY=this._shadowOnly),n._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return  false;this._imageProcessingConfiguration.prepareDefines(n);}if(n._areMiscDirty&&(n.REFLECTIONMAP_3D&&this._enableGroundProjection?(n.PROJECTED_GROUND=true,n.REFLECTIONMAP_SKYBOX=true):n.PROJECTED_GROUND=false),js(e,r,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),n,void 0,void 0,void 0,this._isVertexOutputInvariant),Js(r,a,this,n,i,null,t.getRenderingMesh().hasThinInstances),$s(e,n,false,true,false)&&e&&(r.getEngine().getCaps().standardDerivatives||e.isVerticesDataPresent(Hi.NormalKind)||(e.createNormals(true),Ie$2.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name))),n.isDirty){n.markAsProcessed(),r.resetCachedMaterial();const i=new ro;n.FOG&&i.addFallback(0,"FOG"),n.POINTSIZE&&i.addFallback(1,"POINTSIZE"),n.MULTIVIEW&&i.addFallback(0,"MULTIVIEW"),Ks(n,i,this._maxSimultaneousLights);const s=[Hi.PositionKind];n.NORMAL&&s.push(Hi.NormalKind),n.UV1&&s.push(Hi.UVKind),n.UV2&&s.push(Hi.UV2Kind),Ws(s,e,n,i),Ys(s,n);const o=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];Ts(o);const h=["diffuseSampler"];rr$1(o,h,false);const l=["Material","Scene"];En&&(En.PrepareUniforms(o,n),En.PrepareSamplers(h,n)),nr$1({uniformsNames:o,uniformBuffersNames:l,samplers:h,defines:n,maxSimultaneousLights:this._maxSimultaneousLights});const c=n.toString(),u=r.getEngine().createEffect("background",{attributes:s,uniformsNames:o,uniformBuffersNames:l,samplers:h,defines:c,fallbacks:i,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(function(){return background_vertexBQ3ezD5_esm_min}),Promise.resolve().then(function(){return background_fragmentFey1Liol_esm_min})]):await Promise.all([Promise.resolve().then(function(){return background_vertexCa0V8OXK_esm_min}),Promise.resolve().then(function(){return background_fragmentBQDdXoiV_esm_min})]),this._shadersLoaded=true;}},a);t.setEffect(u,n,this._materialContext),this.buildUniformLayout();}return !(!t.effect||!t.effect.isReady())&&(n._renderId=r.getRenderId(),s._wasPreviouslyReady=true,s._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),true)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors());}_computePrimaryColors(){0===this._primaryColorShadowLevel&&0===this._primaryColorHighlightLevel||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor));}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),ar$1(this._uniformBuffer,true,false,false),this._uniformBuffer.create();}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind();}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e);}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e),Hs(t,this._activeEffect);const a=this._mustRebind(s,n,i,t.visibility);if(a){this._uniformBuffer.bindToEffect(n,"Material"),this.bindViewProjection(n);const e=this._reflectionTexture;this._uniformBuffer.useUbo&&this.isFrozen&&this._uniformBuffer.isSync&&!i._drawWrapper._forceRebindOnNextCall||(s.texturesEnabled&&(this._diffuseTexture&&bs.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),Gs(this._diffuseTexture,this._uniformBuffer,"diffuse")),Bs(s,r,this._uniformBuffer,ge$3.White(),e,false,true,false,false,false,false,this._reflectionBlur)),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),r.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),s.texturesEnabled&&(this._diffuseTexture&&bs.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),e&&bs.ReflectionTextureEnabled&&(Us(s,r,this._uniformBuffer,e),r.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),r.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),As(this._activeEffect,this,s),s.bindEyePosition(n);}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(n,"Material"),this._needToBindSceneUbo=true);!a&&this.isFrozen||(s.lightsEnabled&&Xs(s,t,this._activeEffect,r,this._maxSimultaneousLights),this.bindView(n),Os(s,t,this._activeEffect,true),this._useLogarithmicDepth&&Cs(r,n,s),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update();}hasTexture(e){return !!super.hasTexture(e)||(this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=false,t=false){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e);}clone(e){return Ae$3.Clone((()=>new yh(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return "BackgroundMaterial"}static Parse(e,t,i){return Ae$3.Parse((()=>new yh(e.name,t)),e,t,i)}}yh.StandardReflectance0=.05,yh.StandardReflectance90=.5,e$z([h$c()],yh.prototype,"_primaryColor",void 0),e$z([n$1W("_markAllSubMeshesAsLightsDirty")],yh.prototype,"primaryColor",void 0),e$z([h$c()],yh.prototype,"__perceptualColor",void 0),e$z([a$$()],yh.prototype,"_primaryColorShadowLevel",void 0),e$z([a$$()],yh.prototype,"_primaryColorHighlightLevel",void 0),e$z([n$1W("_markAllSubMeshesAsLightsDirty")],yh.prototype,"primaryColorHighlightLevel",null),e$z([o$19()],yh.prototype,"_reflectionTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"reflectionTexture",void 0),e$z([a$$()],yh.prototype,"_reflectionBlur",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"reflectionBlur",void 0),e$z([o$19()],yh.prototype,"_diffuseTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"diffuseTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"shadowLights",void 0),e$z([a$$()],yh.prototype,"_shadowLevel",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"shadowLevel",void 0),e$z([u$s()],yh.prototype,"_sceneCenter",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"sceneCenter",void 0),e$z([a$$()],yh.prototype,"_opacityFresnel",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"opacityFresnel",void 0),e$z([a$$()],yh.prototype,"_reflectionFresnel",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"reflectionFresnel",void 0),e$z([a$$()],yh.prototype,"_reflectionFalloffDistance",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"reflectionFalloffDistance",void 0),e$z([a$$()],yh.prototype,"_reflectionAmount",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"reflectionAmount",void 0),e$z([a$$()],yh.prototype,"_reflectionReflectance0",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"reflectionReflectance0",void 0),e$z([a$$()],yh.prototype,"_reflectionReflectance90",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"reflectionReflectance90",void 0),e$z([a$$()],yh.prototype,"_useRGBColor",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"useRGBColor",void 0),e$z([a$$()],yh.prototype,"_enableNoise",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"enableNoise",void 0),e$z([a$$()],yh.prototype,"_maxSimultaneousLights",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"maxSimultaneousLights",void 0),e$z([a$$()],yh.prototype,"_shadowOnly",void 0),e$z([n$1W("_markAllSubMeshesAsLightsDirty")],yh.prototype,"shadowOnly",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],yh.prototype,"enableGroundProjection",void 0),e$z([a$$()],yh.prototype,"projectedGroundRadius",void 0),e$z([a$$()],yh.prototype,"projectedGroundHeight",void 0),P$9("BABYLON.BackgroundMaterial",yh);class Ih extends Ea{_gatherImports(e,t){e?(this._webGPUReady=true,t.push(Promise.all([Promise.resolve().then(function(){return pass_fragmentBTnRKMbi_esm_min})]))):t.push(Promise.all([Promise.resolve().then(function(){return pass_fragmentY28YD4oC_esm_min})])),super._gatherImports(e,t);}constructor(e,t=null,i){const s={name:e,engine:t||eo.LastCreatedEngine,useShaderStore:true,useAsPostProcess:true,fragmentShader:Ih.FragmentUrl,...i};s.engine||(s.engine=eo.LastCreatedEngine),super(s);}}Ih.FragmentUrl="pass";class Ch extends Ea{_gatherImports(e,t){e?(this._webGPUReady=true,t.push(Promise.all([Promise.resolve().then(function(){return passCube_fragmentDQB4iKcr_esm_min})]))):t.push(Promise.all([Promise.resolve().then(function(){return passCube_fragmentCoj5UJcQ_esm_min})])),super._gatherImports(e,t);}constructor(e,t=null,i){super({...i,name:e,engine:t||eo.LastCreatedEngine,useShaderStore:true,useAsPostProcess:true,fragmentShader:Ch.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0;}get face(){return this._face}set face(e){if(!(e<0||e>5))switch(this._face=e,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ");}}}Ch.FragmentUrl="passCube";class vh extends Aa{getClassName(){return "PassPostProcess"}constructor(e,t,i=null,s,r,n,a=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,o=false){const h={size:"number"==typeof t?t:void 0,camera:i,samplingMode:s,engine:r,reusable:n,textureType:a,blockCompilation:o,...t};super(e,Ih.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new Ih(e,r,h),...h});}static _Parse(e,t,i,s){return Ae$3.Parse((()=>new vh(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable)),e,i,s)}}P$9("BABYLON.PassPostProcess",vh);class Ph extends Aa{get face(){return this._effectWrapper.face}set face(e){this._effectWrapper.face=e;}getClassName(){return "PassCubePostProcess"}constructor(e,t,i=null,s,r,n,a=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,o=false){const h={size:"number"==typeof t?t:void 0,camera:i,samplingMode:s,engine:r,reusable:n,textureType:a,blockCompilation:o,...t};super(e,Ih.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new Ch(e,r,h),...h});}static _Parse(e,t,i,s){return Ae$3.Parse((()=>new Ph(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable)),e,i,s)}}let Oh,Dh;function Lh(e){Oh||(Oh=new Float32Array(1),Dh=new Int32Array(Oh.buffer)),Oh[0]=e;const t=Dh[0];let i=t>>16&32768,s=t>>12&2047;const r=t>>23&255;return r<103?i:r>142?(i|=31744,i|=(255==r?0:1)&&8388607&t,i):r<113?(s|=2048,i|=(s>>114-r)+(s>>113-r&1),i):(i|=r-112<<10|s>>1,i+=1&s,i)}function Fh(e){const t=(32768&e)>>15,i=(31744&e)>>10,s=1023&e;return 0===i?(t?-1:1)*Math.pow(2,-14)*(s/Math.pow(2,10)):31==i?s?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,i-15)*(1+s/Math.pow(2,10))}e$z([a$$()],Ph.prototype,"face",null),jt._RescalePostProcessFactory=e=>new vh("rescale",1,null,Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,e,false,Qe$1.TEXTURETYPE_UNSIGNED_BYTE);class wh{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),s=i.getCaps(),r=t.isReady;let n=false;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(n=true,t.type=Qe$1.TEXTURETYPE_HALF_FLOAT):s.textureFloatRender&&s.textureFloatLinearFiltering&&(n=true,t.type=Qe$1.TEXTURETYPE_FLOAT),n&&(t.isReady=false,t._isRGBD=false,t.invertY=false);const a=async()=>{const s=i.isWebGPU,r=s?1:0;t.isReady=false,s?await Promise.resolve().then(function(){return rgbdDecode_fragmentC93bUglL_esm_min}):await Promise.resolve().then(function(){return rgbdDecode_fragmentBCFIXNGa_esm_min});const n=new Aa("rgbdDecode","rgbdDecode",null,null,1,null,Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,i,false,void 0,t.type,void 0,null,false,void 0,r);n.externalTextureSamplerBinding=true;const a=i.createRenderTargetTexture(t.width,{generateDepthBuffer:false,generateMipMaps:false,generateStencilBuffer:false,samplingMode:t.samplingMode,type:t.type,format:Qe$1.TEXTUREFORMAT_RGBA});n.onEffectCreatedObservable.addOnce((s=>{s.executeWhenCompiled((()=>{n.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1);},e.getScene().postProcessManager.directRender([n],a,true),i.restoreDefaultFramebuffer(),i._releaseTexture(t),n&&n.dispose(),a._swapAndDie(t),t.isReady=true;}));}));};n&&(r?a():e.onLoadObservable.addOnce(a));}static async EncodeTextureToRGBD(e,t,i=Qe$1.TEXTURETYPE_UNSIGNED_BYTE){return t.getEngine().isWebGPU?await Promise.resolve().then(function(){return rgbdEncode_fragmentDSvE5Q3X_esm_min}):await Promise.resolve().then(function(){return rgbdEncode_fragmentBiQ_a6bE_esm_min}),await function(e,t,i,s,r,n,a,o){const h=t.getEngine();return t.isReady=false,r=r??t.samplingMode,s=s??t.type,n=n??t.format,a=a??t.width,o=o??t.height,-1===s&&(s=Qe$1.TEXTURETYPE_UNSIGNED_BYTE),new Promise((l=>{const c=new Aa("postprocess",e,null,null,1,null,r,h,false,void 0,s,void 0,null,false,n);c.externalTextureSamplerBinding=true;const u=h.createRenderTargetTexture({width:a,height:o},{generateDepthBuffer:false,generateMipMaps:false,generateStencilBuffer:false,samplingMode:r,type:s,format:n});c.onEffectCreatedObservable.addOnce((e=>{e.executeWhenCompiled((()=>{c.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1);},i.postProcessManager.directRender([c],u,true),h.restoreDefaultFramebuffer(),h._releaseTexture(t),c&&c.dispose(),u._swapAndDie(t),t.type=s,t.format=Qe$1.TEXTUREFORMAT_RGBA,t.isReady=true,l(t);}));}));}))}("rgbdEncode",e,t,i,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Qe$1.TEXTUREFORMAT_RGBA)}}let Nh=0;const Bh=(e,t,i,s)=>{if(!e[i]){const r=e.useDelayedTextureLoading;e.useDelayedTextureLoading=false;const n=e._blockEntityCollection;e._blockEntityCollection=false;const a=Is.CreateFromBase64String(t,s+Nh++,e,true,false,Is.BILINEAR_SAMPLINGMODE);e._blockEntityCollection=n;const o=e.getEngine().getLoadedTexturesCache(),h=o.indexOf(a.getInternalTexture());-1!==h&&o.splice(h,1),a.isRGBD=true,a.wrapU=Is.CLAMP_ADDRESSMODE,a.wrapV=Is.CLAMP_ADDRESSMODE,e[i]=a,e.useDelayedTextureLoading=r,wh.ExpandRGBDTexture(a);const l=e.getEngine().onContextRestoredObservable.add((()=>{a.isRGBD=true;const t=e.onBeforeRenderObservable.add((()=>{a.isReady()&&(e.onBeforeRenderObservable.remove(t),wh.ExpandRGBDTexture(a));}));}));e.onDisposeObservable.add((()=>{e.getEngine().onContextRestoredObservable.remove(l);}));}return e[i]},Uh=e=>Bh(e,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","environmentBRDFTexture","EnvironmentBRDFTexture"),kh=e=>Bh(e,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAF9UlEQVR4nGWVy64eVxGF16X27u7/HMcyuZGYAINwmTBigngBXoc34El4B0ZMGDJjFCExQUIKiRKZYBITHdvn/L1rF4P+c+yEUqmH9WmtrrWLkdB4C1/91h/9yn947D8+8CfdlBeGGAMtqwNd6K7VWAJrw9qwLtw2nDaernh6wKuHPD3S1Vs6vaPT97W9r/Wx1seKUWj7Uzz6vX79T//wF/Gbx/7rw/jsFB/39nlrX7q99LKrp5bJZXAtrqW1uJIncbNOXafBU+o0tZW28got0AJ3KACsE4OfYvmzfvDMb/+4//Td9snD9rfr9vHWnyz9361/1fpNLLde0mt5pTZ7a9pCm32SrqQTfZI3aqNXHAwvcAB4BPwnk/oMEcqX8eaz1t9cHjxs7133f5z6p2v/Ylme9eWmLbexjlhnrPBirz3WxWv30rw0L/Yi96PpDrcDcPMEfq+qvQCfsFF1blcv2js3vb2xLNd9O/XT1p8u/Vlfnvd+25bResXC6BFLj2WJpUdv7uEe0exGByPoOAC//BH+cgNqUjfkU4mOEetde+O2vf+y8br71Nva+9q/XpYXvZ97z9ardUXrra3RerQWrUU4myLk4AzYiADwJ+NRQ41i7MSNEBIcM5YR1+f21rnlXcPWtbVYW1/a7dL21mZvbK211lv01lpEtIi0MxTmFGzMAABAN6gF1CTPxI1gkXa5Z5xGPNrbfo6xB/bQubW9nXvkHtXDPfqIJd2bI+1mpZjmNK17QFuxDzhBJued8Fy0KLvcp7fpNzJuM3JE7daIWGKMqAylW0bLiHQ0e1ppTXEK8Qrwkzv8fUIua6oG553wQpRIme7lbfpBxm3GnoEMZ+wZlYGMlu6pNh1pT3nqALCEugCeAB2ohKqYk9hZd4JFS5ThDm/lB9N305nGtKfnNKZiqk23qZhySZOcYhHFewXfI54UMCBDOYlU3TMkSaYWaCtdwXu5yprOKUxrqk9FyUWXNKXiBfCNgucGboGAUBwUJzFYO3G+MCwFtdAn6K6UZZSyXCXBAUVdGCoS5IVxAcQNujAHKCiLLHJqDtWZh1GHV0Et8EYNqOABTUhglKJoyKBBgSwCBC6Ajz7Azz+GiJbwhFTkZCXnEM6EJcuHDmmlztCkBE2IkMGAAhQoSCBBvgYA0G6xN4DgLE5IU5iqZA1hJ8zDqCY2qktJHfEnZSpIk6bE++kEXwHUEBMCmBBBFzE5UzNZuyBRshlSSF0aEg6MaDHIgyFCPAqvA/YdIjTgQ3WBLNZkpWoQPnRIUljdGiIkHd9jumgeO0ESEI97cNTPJj6Z4ISOZh1JUSVLwiAs7pRp02aTypRUhwIzjvhfPCKF1wH/BTqwA5pQlnYyipgs6dDBQVncZatZaZUlsUxZYVq0jyfm8kNeBzz/Gu0ETrjABAURAoTJOVVJpDAoM3ZOc5olfmMK42CYMrRTAr6tIK6QiSA84VtIIEosslSTNYUkUxyS5aEDQ6tMmQ7YDMOmjziYx8E56oPEl8DdDgM2/BLeIJVw9CRSTClZg97ZrDl0BF6m49V0GTIZQL4CvNuxFj47w4ASmqUkAalYU+DBoIbK8hAG506aZTLonWFG0IMa1AAHXlegW9wFGuAJG97hhFkqiuCxUZyqSSWR5GCZHKxB7nSwDcZADHiACQ4eJ/Oot9+BvsaLQD2Hby9RUEEs1cUlcdKpmWKSQ2VyqAY56J0RiEEPOqHxXYv2W4yJuANWxBkBOKEGFcwyjlhMYdLJSjLJpA8FAxqMwXZRQA0wgdQ94Hcf4nqDFnQhBDcY5YJUIqSSpnxpRqone6ol+2Af7Il2MJJxnN/8lgIA8yWQUKItaBMRsGEdDIrQoYNTnGSyBqdZQSY16IEYaANOOKn/A+htXH+OdgLOiB1BBOEGCz5ejmO6JpGEeexVJTmohJNORqIlnVDyO4CvvsT2AGm0BVEHo0IMHeEooeQipzDFY5eSNcigLgwoGYlIKHF/ky9Z+xD/WrCfoQUuRCGAKBhlwIBRQvmSuykkMYHkqx7EAPK+/wdqEbWmfB0bfwAAAABJRU5ErkJggg==","environmentFuzzBRDFTexture","EnvironmentFuzzBRDFTexture"),Gh=new RegExp("^([gimus]+)!");class Vh{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine();}_addPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e.name)return  false;if(this._material._uniformBufferLayoutBuilt&&(this._material.resetDrawCache(),this._material._createUniformBuffer()),!e.isCompatible(this._material.shaderLanguage))throw `The plugin "${e.name}" can't be added to the material "${this._material.name}" because the plugin is not compatible with the shader language of the material.`;const t=e.getClassName();Vh._MaterialPluginClassToMainDefine[t]||(Vh._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++Vh._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(e,t)=>this._handlePluginEvent(e,t),this._plugins.push(e),this._plugins.sort(((e,t)=>e.priority-t.priority)),this._codeInjectionPoints={};const i={};i[Vh._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:true};for(const e of this._plugins)e.collectDefines(i),this._collectPointNames("vertex",e.getCustomCode("vertex",this._material.shaderLanguage)),this._collectPointNames("fragment",e.getCustomCode("fragment",this._material.shaderLanguage));return this._defineNamesFromPlugins=i,true}_activatePlugin(e){ -1===this._activePlugins.indexOf(e)&&(this._activePlugins.push(e),this._activePlugins.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)));}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=true;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t;}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh);}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh);}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh);}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh);}_handlePluginEventHasRenderTargetTextures(e){let t=false;for(const e of this._activePluginsForExtraEvents)if(t=e.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t;}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets);}_handlePluginEvent(e,t){switch(e){case 512:{const e=t;for(const t of this._activePlugins)t.getActiveTextures(e.activeTextures);break}case 256:{const e=t;for(const t of this._activePlugins)t.getAnimatables(e.animatables);break}case 1024:{const e=t;let i=false;for(const t of this._activePlugins)if(i=t.hasTexture(e.texture),i)break;e.hasTexture=i;break}case 2:{const e=t;for(const t of this._plugins)t.dispose(e.forceDisposeTextures);break}case 4:t.defineNames=this._defineNamesFromPlugins;break;case 128:{const e=t;for(const t of this._activePlugins)e.fallbackRank=t.addFallbacks(e.defines,e.fallbacks,e.fallbackRank),t.getAttributes(e.attributes,this._scene,e.mesh);this._uniformList.length>0&&e.uniforms.push(...this._uniformList),this._samplerList.length>0&&e.samplers.push(...this._samplerList),this._uboList.length>0&&e.uniformBuffersNames.push(...this._uboList),e.customCode=this._injectCustomCode(e,e.customCode);break}case 8:{const e=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];const i=1===this._material.shaderLanguage;for(const t of this._plugins){const s=t.getUniforms(this._material.shaderLanguage);if(s){if(s.ubo)for(const t of s.ubo){if(t.size&&t.type){const s=t.arraySize??0;if(e.ubo.addUniform(t.name,t.size,s),i){let e;switch(t.type){case "mat4":e="mat4x4f";break;case "float":e="f32";break;default:e=`${t.type}f`;}this._uboDeclaration+=s>0?`uniform ${t.name}: array<${e}, ${s}>;\n`:`uniform ${t.name}: ${e};\n`;}else this._uboDeclaration+=`${t.type} ${t.name}${s>0?`[${s}]`:""};\n`;}this._uniformList.push(t.name);}s.vertex&&(this._vertexDeclaration+=s.vertex+"\n"),s.fragment&&(this._fragmentDeclaration+=s.fragment+"\n"),s.externalUniforms&&this._uniformList.push(...s.externalUniforms);}t.getSamplers(this._samplerList),t.getUniformBuffersNames(this._uboList);}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=true;}_injectCustomCode(e,t){return (i,s)=>{t&&(s=t(i,s)),this._uboDeclaration&&(s=s.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(s=s.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(s=s.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const r=this._codeInjectionPoints?.[i];if(!r)return s;let n=null;for(let t in r){let r="";for(const s of this._activePlugins){let a=s.getCustomCode(i,this._material.shaderLanguage)?.[t];if(a){if(s.resolveIncludes){if(null===n){const t=0;n={defines:[],indexParameters:e.indexParameters,isFragment:false,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:bt$1.GetShadersRepository(t),includesShadersStore:bt$1.GetIncludesShadersStore(t),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0};}n.isFragment="fragment"===i,gt$1(a,n,(e=>a=e));}r+=a+"\n";}}if(r.length>0)if("!"===t.charAt(0)){t=t.substring(1);let e="g";if("!"===t.charAt(0))e="",t=t.substring(1);else {const i=Gh.exec(t);i&&i.length>=2&&(e=i[1],t=t.substring(e.length+1));}e.indexOf("g")<0&&(e+="g");const i=s,n=new RegExp(t,e);let a=n.exec(i);for(;null!==a;){let e=r;for(let t=0;t<a.length;++t)e=e.replace("$"+t,a[t]);s=s.replace(a[0],e),a=n.exec(i);}}else {const e="#define "+t;s=s.replace(e,"\n"+r+"\n"+e);}}return s}}}Vh._MaterialPluginClassToMainDefine={},Vh._MaterialPluginCounter=0,L$7.OnEnginesDisposedObservable.add((()=>{Hh.length=0,hr$1.OnEventObservable.remove(zh),zh=null;}));const Hh=[];let zh=null;class Xh{isCompatible(e){return 0===e}_enable(e){e&&this._pluginManager._activatePlugin(this);}constructor(e,t,i,s,r=true,n=false,a=false){this.priority=500,this.resolveIncludes=false,this.registerForExtraEvents=false,this.doNotSerialize=false,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=a,e.pluginManager||(e.pluginManager=new Vh(e),e.onDisposeObservable.add((()=>{e.pluginManager=void 0;}))),this._pluginDefineNames=s,this._pluginManager=e.pluginManager,r&&this._pluginManager._addPlugin(this),n&&this._enable(true),this.markAllDefinesAsDirty=e._dirtyCallbacks[Qe$1.MATERIAL_AllDirtyFlag];}getClassName(){return "MaterialPluginBase"}isReadyForSubMesh(e,t,i,s){return  true}hardBindForSubMesh(e,t,i,s){}bindForSubMesh(e,t,i,s){}dispose(e){}getCustomCode(e,t=0){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if("_"===t[0])continue;const i=typeof this._pluginDefineNames[t];e[t]={type:"number"===i?"number":"string"===i?"string":"boolean"===i?"boolean":"object",default:this._pluginDefineNames[t]};}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return  false}hasRenderTargetTextures(){return  false}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(e=0){return {}}copyTo(e){Ae$3.Clone((()=>e),this);}serialize(){return Ae$3.Serialize(this)}parse(e,t,i){Ae$3.Parse((()=>this),e,t,i);}}e$z([a$$()],Xh.prototype,"name",void 0),e$z([a$$()],Xh.prototype,"priority",void 0),e$z([a$$()],Xh.prototype,"resolveIncludes",void 0),e$z([a$$()],Xh.prototype,"registerForExtraEvents",void 0),P$9("BABYLON.MaterialPluginBase",Xh);class Wh extends Eh{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=false,this.MS_BRDF_ENERGY_CONSERVATION=false,this.SPHERICAL_HARMONICS=false,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=false,this.MIX_IBL_RADIANCE_WITH_IRRADIANCE=true,this.LEGACY_SPECULAR_ENERGY_CONSERVATION=false,this.BASE_DIFFUSE_MODEL=0,this.DIELECTRIC_SPECULAR_MODEL=0,this.CONDUCTOR_SPECULAR_MODEL=0;}}class Yh extends Xh{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty();}isCompatible(){return  true}constructor(e,t=true){super(e,"PBRBRDF",90,new Wh,t),this._useEnergyConservation=Yh.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Yh.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Yh.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Yh.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Yh.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Yh.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Yh.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Yh.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._mixIblRadianceWithIrradiance=Yh.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this.mixIblRadianceWithIrradiance=Yh.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this._useLegacySpecularEnergyConservation=Yh.DEFAULT_USE_LEGACY_SPECULAR_ENERGY_CONSERVATION,this.useLegacySpecularEnergyConservation=Yh.DEFAULT_USE_LEGACY_SPECULAR_ENERGY_CONSERVATION,this._baseDiffuseModel=Yh.DEFAULT_DIFFUSE_MODEL,this.baseDiffuseModel=Yh.DEFAULT_DIFFUSE_MODEL,this._dielectricSpecularModel=Yh.DEFAULT_DIELECTRIC_SPECULAR_MODEL,this.dielectricSpecularModel=Yh.DEFAULT_DIELECTRIC_SPECULAR_MODEL,this._conductorSpecularModel=Yh.DEFAULT_CONDUCTOR_SPECULAR_MODEL,this.conductorSpecularModel=Yh.DEFAULT_CONDUCTOR_SPECULAR_MODEL,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[Qe$1.MATERIAL_MiscDirtyFlag],this._enable(true);}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation,e.MIX_IBL_RADIANCE_WITH_IRRADIANCE=this._mixIblRadianceWithIrradiance,e.LEGACY_SPECULAR_ENERGY_CONSERVATION=this._useLegacySpecularEnergyConservation,e.BASE_DIFFUSE_MODEL=this._baseDiffuseModel,e.DIELECTRIC_SPECULAR_MODEL=this._dielectricSpecularModel,e.CONDUCTOR_SPECULAR_MODEL=this._conductorSpecularModel;}getClassName(){return "PBRBRDFConfiguration"}}Yh.DEFAULT_USE_ENERGY_CONSERVATION=true,Yh.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=true,Yh.DEFAULT_USE_SPHERICAL_HARMONICS=true,Yh.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=true,Yh.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE=true,Yh.DEFAULT_USE_LEGACY_SPECULAR_ENERGY_CONSERVATION=true,Yh.DEFAULT_DIFFUSE_MODEL=Qe$1.MATERIAL_DIFFUSE_MODEL_E_OREN_NAYAR,Yh.DEFAULT_DIELECTRIC_SPECULAR_MODEL=Qe$1.MATERIAL_DIELECTRIC_SPECULAR_MODEL_GLTF,Yh.DEFAULT_CONDUCTOR_SPECULAR_MODEL=Qe$1.MATERIAL_CONDUCTOR_SPECULAR_MODEL_GLTF,e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],Yh.prototype,"useEnergyConservation",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],Yh.prototype,"useSmithVisibilityHeightCorrelated",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],Yh.prototype,"useSphericalHarmonics",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],Yh.prototype,"useSpecularGlossinessInputEnergyConservation",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],Yh.prototype,"mixIblRadianceWithIrradiance",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],Yh.prototype,"useLegacySpecularEnergyConservation",void 0),e$z([a$$("baseDiffuseModel"),n$1W("_markAllSubMeshesAsMiscDirty")],Yh.prototype,"baseDiffuseModel",void 0),e$z([a$$("dielectricSpecularModel"),n$1W("_markAllSubMeshesAsMiscDirty")],Yh.prototype,"dielectricSpecularModel",void 0),e$z([a$$("conductorSpecularModel"),n$1W("_markAllSubMeshesAsMiscDirty")],Yh.prototype,"conductorSpecularModel",void 0);class Kh{constructor(){this.previousWorldMatrices={},this.previousBones={};}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones");}static AddSamplers(e){}bindForSubMesh(e,t,i,s,r){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&(-1!==t.prePassRenderer.getIndex(Qe$1.PREPASS_VELOCITY_TEXTURE_TYPE)||-1!==t.prePassRenderer.getIndex(Qe$1.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE))){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=s.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const r=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=r.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==r.frameId&&(this._lastUpdateFrameId=r.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=s.clone();}}}class jh{constructor(e,t,i,s){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=s;}}class Qh{static ConvertCubeMapTextureToSphericalPolynomial(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();const t=e.getSize().width,i=e.readPixels(0,void 0,void 0,false),s=e.readPixels(1,void 0,void 0,false);let r,n;e.isRenderTarget?(r=e.readPixels(3,void 0,void 0,false),n=e.readPixels(2,void 0,void 0,false)):(r=e.readPixels(2,void 0,void 0,false),n=e.readPixels(3,void 0,void 0,false));const a=e.readPixels(4,void 0,void 0,false),o=e.readPixels(5,void 0,void 0,false),h=e.gammaSpace,l=Qe$1.TEXTUREFORMAT_RGBA;let c=Qe$1.TEXTURETYPE_UNSIGNED_BYTE;return e.textureType!=Qe$1.TEXTURETYPE_FLOAT&&e.textureType!=Qe$1.TEXTURETYPE_HALF_FLOAT||(c=Qe$1.TEXTURETYPE_FLOAT),new Promise((e=>{Promise.all([s,i,r,n,a,o]).then((([i,s,r,n,a,o])=>{const u={size:t,right:s,left:i,up:r,down:n,front:a,back:o,format:l,type:c,gammaSpace:h};e(this.ConvertCubeMapToSphericalPolynomial(u));}));}))}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new za;let i=0;const s=2/e.size,r=s,n=.5*s,a=n-1;for(let o=0;o<6;o++){const h=this._FileFaces[o],l=e[h.name];let c=a;const u=e.format===Qe$1.TEXTUREFORMAT_RGBA?4:3;for(let o=0;o<e.size;o++){let d=a;for(let r=0;r<e.size;r++){const a=h.worldAxisForFileX.scale(d).add(h.worldAxisForFileY.scale(c)).add(h.worldAxisForNormal);a.normalize();const _=this._AreaElement(d-n,c-n)-this._AreaElement(d-n,c+n)-this._AreaElement(d+n,c-n)+this._AreaElement(d+n,c+n);let f=l[o*e.size*u+r*u+0],p=l[o*e.size*u+r*u+1],g=l[o*e.size*u+r*u+2];isNaN(f)&&(f=0),isNaN(p)&&(p=0),isNaN(g)&&(g=0),e.type===Qe$1.TEXTURETYPE_UNSIGNED_BYTE&&(f/=255,p/=255,g/=255),e.gammaSpace&&(f=Math.pow(U$5(f),S$d),p=Math.pow(U$5(p),S$d),g=Math.pow(U$5(g),S$d));const m=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const e=Math.max(f,p,g);if(e>m){const t=m/e;f*=t,p*=t,g*=t;}}else f=U$5(f,0,m),p=U$5(p,0,m),g=U$5(g,0,m);const T=new ge$3(f,p,g);t.addLight(a,T,_),i+=_,d+=s;}c+=r;}}const o=6*(4*Math.PI)/6/i;return t.scaleInPlace(o),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),Xa.FromHarmonics(t)}}Qh._FileFaces=[new jh("right",new te$4(1,0,0),new te$4(0,0,-1),new te$4(0,-1,0)),new jh("left",new te$4(-1,0,0),new te$4(0,0,1),new te$4(0,-1,0)),new jh("up",new te$4(0,1,0),new te$4(1,0,0),new te$4(0,0,1)),new jh("down",new te$4(0,-1,0),new te$4(1,0,0),new te$4(0,0,-1)),new jh("front",new te$4(0,0,1),new te$4(1,0,0),new te$4(0,-1,0)),new jh("back",new te$4(0,0,-1),new te$4(-1,0,0),new te$4(0,-1,0))],Qh.MAX_HDRI_VALUE=4096,Qh.PRESERVE_CLAMPED_COLORS=false,Ms.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=false);},Object.defineProperty(Ms.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=Qh.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=true:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=true;}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e);},enumerable:true,configurable:true});class qh extends Eh{constructor(){super(...arguments),this.CLEARCOAT=false,this.CLEARCOAT_DEFAULTIOR=false,this.CLEARCOAT_TEXTURE=false,this.CLEARCOAT_TEXTURE_ROUGHNESS=false,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=false,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=false,this.CLEARCOAT_REMAP_F0=false,this.CLEARCOAT_TINT=false,this.CLEARCOAT_TINT_TEXTURE=false,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=false;}}class Zh extends Xh{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty();}isCompatible(){return  true}constructor(e,t=true){super(e,"PBRClearCoat",100,new qh,t),this._isEnabled=false,this.isEnabled=false,this.intensity=1,this.roughness=0,this._indexOfRefraction=Zh._DefaultIndexOfRefraction,this.indexOfRefraction=Zh._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=true,this.useRoughnessFromMainTexture=true,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=true,this.remapF0OnInterfaceChange=true,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=false,this.isTintEnabled=false,this.tintColor=ge$3.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[Qe$1.MATERIAL_TextureDirtyFlag];}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return  true;const s=this._material._disableBumpMap;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&bs.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking())return  false;if(this._textureRoughness&&bs.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return  false;if(i.getCaps().standardDerivatives&&this._bumpTexture&&bs.ClearCoatBumpTextureEnabled&&!s&&!this._bumpTexture.isReady())return  false;if(this._isTintEnabled&&this._tintTexture&&bs.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking())return  false}return  true}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=true,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&bs.ClearCoatTextureEnabled?ks(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=false,this._textureRoughness&&bs.ClearCoatTextureEnabled?ks(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=false,this._bumpTexture&&bs.ClearCoatBumpTextureEnabled?ks(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=false,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===Zh._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=true,this._tintTexture&&bs.ClearCoatTintTextureEnabled?(ks(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=false):(e.CLEARCOAT_TINT=false,e.CLEARCOAT_TINT_TEXTURE=false))):(e.CLEARCOAT=false,e.CLEARCOAT_TEXTURE=false,e.CLEARCOAT_TEXTURE_ROUGHNESS=false,e.CLEARCOAT_BUMP=false,e.CLEARCOAT_TINT=false,e.CLEARCOAT_TINT_TEXTURE=false,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=false,e.CLEARCOAT_DEFAULTIOR=false,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=false,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=false);}bindForSubMesh(e,t,i,s){if(!this._isEnabled)return;const r=s.materialDefines,n=this._material.isFrozen,a=this._material._disableBumpMap,o=this._material._invertNormalMapX,h=this._material._invertNormalMapY;if(!e.useUbo||!n||!e.isSync){(this._texture||this._textureRoughness)&&bs.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&Gs(this._texture,e,"clearCoat"),this._textureRoughness&&!r.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Gs(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&bs.ClearCoatTextureEnabled&&!a&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),Gs(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",o?1:-1,h?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",o?-1:1,h?-1:1)),this._tintTexture&&bs.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),Gs(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const s=1-this._indexOfRefraction,n=1+this._indexOfRefraction,l=Math.pow(-s/n,2),c=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",l,c,s,n),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)));}t.texturesEnabled&&(this._texture&&bs.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!r.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&bs.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&bs.ClearCoatBumpTextureEnabled&&!a&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&bs.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture));}hasTexture(e){return this._texture===e||(this._textureRoughness===e||(this._bumpTexture===e||this._tintTexture===e))}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture);}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture);}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose(),this._bumpTexture?.dispose(),this._tintTexture?.dispose());}getClassName(){return "PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler");}getUniforms(){return {ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}Zh._DefaultIndexOfRefraction=1.5,e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],Zh.prototype,"isEnabled",void 0),e$z([a$$()],Zh.prototype,"intensity",void 0),e$z([a$$()],Zh.prototype,"roughness",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],Zh.prototype,"indexOfRefraction",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],Zh.prototype,"texture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],Zh.prototype,"useRoughnessFromMainTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],Zh.prototype,"textureRoughness",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],Zh.prototype,"remapF0OnInterfaceChange",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],Zh.prototype,"bumpTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],Zh.prototype,"isTintEnabled",void 0),e$z([h$c()],Zh.prototype,"tintColor",void 0),e$z([a$$()],Zh.prototype,"tintColorAtDistance",void 0),e$z([a$$()],Zh.prototype,"tintThickness",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],Zh.prototype,"tintTexture",void 0);class Jh extends Eh{constructor(){super(...arguments),this.IRIDESCENCE=false,this.IRIDESCENCE_TEXTURE=false,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=false,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0;}}class $h extends Xh{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty();}isCompatible(){return  true}constructor(e,t=true){super(e,"PBRIridescence",110,new Jh,t),this._isEnabled=false,this.isEnabled=false,this.intensity=1,this.minimumThickness=$h._DefaultMinimumThickness,this.maximumThickness=$h._DefaultMaximumThickness,this.indexOfRefraction=$h._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[Qe$1.MATERIAL_TextureDirtyFlag];}isReadyForSubMesh(e,t){if(!this._isEnabled)return  true;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&bs.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking())return  false;if(this._thicknessTexture&&bs.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return  false}return  true}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=true,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&bs.IridescenceTextureEnabled?ks(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=false,this._thicknessTexture&&bs.IridescenceTextureEnabled?ks(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=false)):(e.IRIDESCENCE=false,e.IRIDESCENCE_TEXTURE=false,e.IRIDESCENCE_THICKNESS_TEXTURE=false,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0);}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||((this._texture||this._thicknessTexture)&&bs.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._thicknessTexture?.coordinatesIndex??0,this._thicknessTexture?.level??0),this._texture&&Gs(this._texture,e,"iridescence"),this._thicknessTexture&&Gs(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&bs.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&bs.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture));}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture);}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture);}dispose(e){e&&(this._texture?.dispose(),this._thicknessTexture?.dispose());}getClassName(){return "PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler");}getUniforms(){return {ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}$h._DefaultMinimumThickness=100,$h._DefaultMaximumThickness=400,$h._DefaultIndexOfRefraction=1.3,e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],$h.prototype,"isEnabled",void 0),e$z([a$$()],$h.prototype,"intensity",void 0),e$z([a$$()],$h.prototype,"minimumThickness",void 0),e$z([a$$()],$h.prototype,"maximumThickness",void 0),e$z([a$$()],$h.prototype,"indexOfRefraction",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],$h.prototype,"texture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],$h.prototype,"thicknessTexture",void 0);class el extends Eh{constructor(){super(...arguments),this.ANISOTROPIC=false,this.ANISOTROPIC_TEXTURE=false,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=false,this.MAINUV1=false;}}class tl extends Xh{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e);}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty();}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty();}isCompatible(){return  true}constructor(e,t=true){super(e,"PBRAnisotropic",110,new el,t),this._isEnabled=false,this.isEnabled=false,this.intensity=1,this.direction=new ee$4(1,0),this._texture=null,this.texture=null,this._legacy=false,this.legacy=false,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[Qe$1.MATERIAL_TextureDirtyFlag],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[Qe$1.MATERIAL_MiscDirtyFlag];}isReadyForSubMesh(e,t){return !this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&bs.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(Hi.TangentKind)&&(e._needUVs=true,e.MAINUV1=true),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&bs.AnisotropicTextureEnabled?ks(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=false),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=false,e.ANISOTROPIC_TEXTURE=false,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=false);}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||(this._texture&&bs.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),Gs(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&bs.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture);}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture);}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture);}dispose(e){e&&this._texture&&this._texture.dispose();}getClassName(){return "PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler");}getUniforms(){return {ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),void 0===e.legacy&&(this.legacy=true);}}e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],tl.prototype,"isEnabled",void 0),e$z([a$$()],tl.prototype,"intensity",void 0),e$z([c$o()],tl.prototype,"direction",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],tl.prototype,"texture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],tl.prototype,"legacy",void 0);class il extends Eh{constructor(){super(...arguments),this.SHEEN=false,this.SHEEN_TEXTURE=false,this.SHEEN_GAMMATEXTURE=false,this.SHEEN_TEXTURE_ROUGHNESS=false,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=false,this.SHEEN_ROUGHNESS=false,this.SHEEN_ALBEDOSCALING=false,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=false;}}class sl extends Xh{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty();}isCompatible(){return  true}constructor(e,t=true){super(e,"Sheen",120,new il,t),this._isEnabled=false,this.isEnabled=false,this._linkSheenWithAlbedo=false,this.linkSheenWithAlbedo=false,this.intensity=1,this.color=ge$3.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=true,this.useRoughnessFromMainTexture=true,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=false,this.albedoScaling=false,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[Qe$1.MATERIAL_TextureDirtyFlag];}isReadyForSubMesh(e,t){if(!this._isEnabled)return  true;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&bs.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking())return  false;if(this._textureRoughness&&bs.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return  false}return  true}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=true,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&bs.SheenTextureEnabled?(ks(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=false,this._textureRoughness&&bs.SheenTextureEnabled?ks(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=false)):(e.SHEEN=false,e.SHEEN_TEXTURE=false,e.SHEEN_TEXTURE_ROUGHNESS=false,e.SHEEN_LINKWITHALBEDO=false,e.SHEEN_ROUGHNESS=false,e.SHEEN_ALBEDOSCALING=false,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=false,e.SHEEN_GAMMATEXTURE=false,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0);}bindForSubMesh(e,t,i,s){if(!this._isEnabled)return;const r=s.materialDefines,n=this._material.isFrozen;e.useUbo&&n&&e.isSync||((this._texture||this._textureRoughness)&&bs.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&Gs(this._texture,e,"sheen"),this._textureRoughness&&!r.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Gs(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&bs.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!r.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&bs.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness));}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness);}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness);}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose());}getClassName(){return "PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler");}getUniforms(){return {ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],sl.prototype,"isEnabled",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],sl.prototype,"linkSheenWithAlbedo",void 0),e$z([a$$()],sl.prototype,"intensity",void 0),e$z([h$c()],sl.prototype,"color",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],sl.prototype,"texture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],sl.prototype,"useRoughnessFromMainTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],sl.prototype,"roughness",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],sl.prototype,"textureRoughness",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],sl.prototype,"albedoScaling",void 0);class rl extends Eh{constructor(){super(...arguments),this.SUBSURFACE=false,this.SS_REFRACTION=false,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=false,this.SS_TRANSLUCENCY=false,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=false,this.SS_SCATTERING=false,this.SS_DISPERSION=false,this.SS_THICKNESSANDMASK_TEXTURE=false,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=false,this.SS_REFRACTIONINTENSITY_TEXTURE=false,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=false,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=false,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=false,this.SS_REFRACTIONMAP_3D=false,this.SS_REFRACTIONMAP_OPPOSITEZ=false,this.SS_LODINREFRACTIONALPHA=false,this.SS_GAMMAREFRACTION=false,this.SS_RGBDREFRACTION=false,this.SS_LINEARSPECULARREFRACTION=false,this.SS_LINKREFRACTIONTOTRANSPARENCY=false,this.SS_ALBEDOFORREFRACTIONTINT=false,this.SS_ALBEDOFORTRANSLUCENCYTINT=false,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=false,this.SS_USE_THICKNESS_AS_DEPTH=false,this.SS_USE_GLTF_TEXTURES=false,this.SS_APPLY_ALBEDO_AFTER_SUBSURFACE=false,this.SS_TRANSLUCENCY_LEGACY=false;}}class nl extends Xh{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e));}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){this._volumeIndexOfRefraction=e>=1?e:-1;}get legacyTransluceny(){return this.legacyTranslucency}set legacyTransluceny(e){this.legacyTranslucency=e;}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty();}_markScenePrePassDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty();}isCompatible(){return  true}constructor(e,t=true){super(e,"PBRSubSurface",130,new rl,t),this._isRefractionEnabled=false,this.isRefractionEnabled=false,this._isTranslucencyEnabled=false,this.isTranslucencyEnabled=false,this._isDispersionEnabled=false,this.isDispersionEnabled=false,this._isScatteringEnabled=false,this.isScatteringEnabled=false,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=false,this.useAlbedoToTintTranslucency=false,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=false,this.invertRefractionY=false,this._linkRefractionWithTransparency=false,this.linkRefractionWithTransparency=false,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=false,this.tintColor=ge$3.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=ge$3.White(),this._useMaskFromThicknessTexture=false,this.useMaskFromThicknessTexture=false,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=true,this.useGltfStyleTextures=true,this.applyAlbedoAfterSubSurface=nl.DEFAULT_APPLY_ALBEDO_AFTERSUBSURFACE,this.legacyTranslucency=nl.DEFAULT_LEGACY_TRANSLUCENCY,this._scene=e.getScene(),this.registerForExtraEvents=true,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[Qe$1.MATERIAL_TextureDirtyFlag],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[Qe$1.MATERIAL_PrePassDirtyFlag];}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return  true;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&bs.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return  false;if(this._refractionIntensityTexture&&bs.RefractionIntensityTextureEnabled&&!this._refractionIntensityTexture.isReadyOrNotBlocking())return  false;if(this._translucencyColorTexture&&bs.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking())return  false;if(this._translucencyIntensityTexture&&bs.TranslucencyIntensityTextureEnabled&&!this._translucencyIntensityTexture.isReadyOrNotBlocking())return  false;const e=this._getRefractionTexture(t);if(e&&bs.RefractionTextureEnabled&&!e.isReadyOrNotBlocking())return  false}return  true}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return e.SUBSURFACE=false,e.SS_DISPERSION=false,e.SS_TRANSLUCENCY=false,e.SS_SCATTERING=false,e.SS_REFRACTION=false,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=false,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=false,e.SS_THICKNESSANDMASK_TEXTURE=false,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=false,e.SS_REFRACTIONINTENSITY_TEXTURE=false,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=false,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=false,e.SS_REFRACTIONMAP_OPPOSITEZ=false,e.SS_LODINREFRACTIONALPHA=false,e.SS_GAMMAREFRACTION=false,e.SS_RGBDREFRACTION=false,e.SS_LINEARSPECULARREFRACTION=false,e.SS_LINKREFRACTIONTOTRANSPARENCY=false,e.SS_ALBEDOFORREFRACTIONTINT=false,e.SS_ALBEDOFORTRANSLUCENCYTINT=false,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=false,e.SS_USE_THICKNESS_AS_DEPTH=false,e.SS_USE_GLTF_TEXTURES=false,e.SS_TRANSLUCENCYCOLOR_TEXTURE=false,e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=false,void(e.SS_APPLY_ALBEDO_AFTER_SUBSURFACE=false);if(e._areTexturesDirty){if(e.SUBSURFACE=true,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=false,e.SS_TRANSLUCENCY_LEGACY=this.legacyTranslucency,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=false,e.SS_REFRACTIONINTENSITY_TEXTURE=false,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=false,e.SS_HAS_THICKNESS=false,e.SS_USE_GLTF_TEXTURES=false,e.SS_REFRACTION=false,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=false,e.SS_REFRACTIONMAP_3D=false,e.SS_GAMMAREFRACTION=false,e.SS_RGBDREFRACTION=false,e.SS_LINEARSPECULARREFRACTION=false,e.SS_REFRACTIONMAP_OPPOSITEZ=false,e.SS_LODINREFRACTIONALPHA=false,e.SS_LINKREFRACTIONTOTRANSPARENCY=false,e.SS_ALBEDOFORREFRACTIONTINT=false,e.SS_ALBEDOFORTRANSLUCENCYTINT=false,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=false,e.SS_USE_THICKNESS_AS_DEPTH=false,e.SS_TRANSLUCENCYCOLOR_TEXTURE=false,e.SS_APPLY_ALBEDO_AFTER_SUBSURFACE=this.applyAlbedoAfterSubSurface,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&bs.ThicknessTextureEnabled&&ks(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&bs.RefractionIntensityTextureEnabled&&ks(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&bs.TranslucencyIntensityTextureEnabled&&ks(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&bs.TranslucencyColorTextureEnabled&&(ks(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE"),e.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=this._translucencyColorTexture.gammaSpace)),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){const i=this._getRefractionTexture(t);i&&bs.RefractionTextureEnabled&&(e.SS_REFRACTION=true,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth);}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency);}}hardBindForSubMesh(e,t,i,s){if(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled)if(0===this.maximumThickness&&0===this.minimumThickness)e.updateFloat2("vThicknessParam",0,0);else {s.getRenderingMesh().getWorldMatrix().decompose(ae$5.Vector3[0]);const t=Math.max(Math.abs(ae$5.Vector3[0].x),Math.abs(ae$5.Vector3[0].y),Math.abs(ae$5.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*t,(this.maximumThickness-this.minimumThickness)*t);}}bindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const r=s.materialDefines,n=this._material.isFrozen,a=this._material.realTimeFiltering,o=r.LODBASEDMICROSFURACE,h=this._getRefractionTexture(t);if(!e.useUbo||!n||!e.isSync){if(this._thicknessTexture&&bs.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),Gs(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&bs.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),Gs(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&bs.TranslucencyColorTextureEnabled&&r.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),Gs(this._translucencyColorTexture,e,"translucencyColor")),this._translucencyIntensityTexture&&bs.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),Gs(this._translucencyIntensityTexture,e,"translucencyIntensity")),h&&bs.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",h.getRefractionTextureMatrix());let t=1;h.isCube||h.depth&&(t=h.depth);const i=h.getSize().width,s=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",h.level,1/s,t,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",i,h.lodGenerationScale,h.lodGenerationOffset,1/this.indexOfRefraction),a&&e.updateFloat2("vRefractionFilteringInfo",i,Math.log2(i)),h.boundingBoxSize){const t=h;e.updateVector3("vRefractionPosition",t.boundingBoxPosition),e.updateVector3("vRefractionSize",t.boundingBoxSize);}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",this.translucencyColor??this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion);}t.texturesEnabled&&(this._thicknessTexture&&bs.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&bs.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&bs.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&bs.TranslucencyColorTextureEnabled&&r.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),h&&bs.RefractionTextureEnabled&&(o?e.setTexture("refractionSampler",h):(e.setTexture("refractionSampler",h._lodTextureMid||h),e.setTexture("refractionSamplerLow",h._lodTextureLow||h),e.setTexture("refractionSamplerHigh",h._lodTextureHigh||h))));}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){bs.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture);}hasTexture(e){return this._thicknessTexture===e||(this._refractionTexture===e||(this._refractionIntensityTexture===e||(this._translucencyIntensityTexture===e||this._translucencyColorTexture===e)))}hasRenderTargetTextures(){return !!(bs.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._refractionIntensityTexture&&e.push(this._refractionIntensityTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&e.push(this._translucencyIntensityTexture);}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._refractionIntensityTexture&&this._refractionIntensityTexture.animations&&this._refractionIntensityTexture.animations.length>0&&e.push(this._refractionIntensityTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.animations&&this._translucencyIntensityTexture.animations.length>0&&e.push(this._translucencyIntensityTexture);}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._refractionIntensityTexture&&this._refractionIntensityTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose(),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.dispose());}getClassName(){return "PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler");}getUniforms(){return {ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}}nl.DEFAULT_APPLY_ALBEDO_AFTERSUBSURFACE=false,nl.DEFAULT_LEGACY_TRANSLUCENCY=false,e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"isRefractionEnabled",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"isTranslucencyEnabled",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"isDispersionEnabled",void 0),e$z([a$$(),n$1W("_markScenePrePassDirty")],nl.prototype,"isScatteringEnabled",void 0),e$z([a$$()],nl.prototype,"_scatteringDiffusionProfileIndex",void 0),e$z([a$$()],nl.prototype,"refractionIntensity",void 0),e$z([a$$()],nl.prototype,"translucencyIntensity",void 0),e$z([a$$()],nl.prototype,"useAlbedoToTintRefraction",void 0),e$z([a$$()],nl.prototype,"useAlbedoToTintTranslucency",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"thicknessTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"refractionTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"indexOfRefraction",void 0),e$z([a$$()],nl.prototype,"_volumeIndexOfRefraction",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"volumeIndexOfRefraction",null),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"invertRefractionY",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"linkRefractionWithTransparency",void 0),e$z([a$$()],nl.prototype,"minimumThickness",void 0),e$z([a$$()],nl.prototype,"maximumThickness",void 0),e$z([a$$()],nl.prototype,"useThicknessAsDepth",void 0),e$z([h$c()],nl.prototype,"tintColor",void 0),e$z([a$$()],nl.prototype,"tintColorAtDistance",void 0),e$z([a$$()],nl.prototype,"dispersion",void 0),e$z([h$c()],nl.prototype,"diffusionDistance",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"useMaskFromThicknessTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"refractionIntensityTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"translucencyIntensityTexture",void 0),e$z([h$c()],nl.prototype,"translucencyColor",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"translucencyColorTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],nl.prototype,"useGltfStyleTextures",void 0),e$z([a$$()],nl.prototype,"applyAlbedoAfterSubSurface",void 0),e$z([a$$()],nl.prototype,"legacyTranslucency",void 0);class al extends Eh{constructor(){super(...arguments),this.DETAIL=false,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0;}}class ol extends Xh{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty();}isCompatible(){return  true}constructor(e,t=true){super(e,"DetailMap",140,new al,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=hr$1.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=false,this.isEnabled=false,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[Qe$1.MATERIAL_TextureDirtyFlag];}isReadyForSubMesh(e,t,i){return !this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&bs.DetailTextureEnabled&&!this._texture.isReady())}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&bs.DetailTextureEnabled&&this._isEnabled?(ks(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=false);}else e.DETAIL=false;}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||this._texture&&bs.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),Gs(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&bs.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture);}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture);}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture);}dispose(e){e&&this._texture?.dispose();}getClassName(){return "DetailMapConfiguration"}getSamplers(e){e.push("detailSampler");}getUniforms(){return {ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}var hl;e$z([o$19("detailTexture"),n$1W("_markAllSubMeshesAsTexturesDirty")],ol.prototype,"texture",void 0),e$z([a$$()],ol.prototype,"diffuseBlendLevel",void 0),e$z([a$$()],ol.prototype,"roughnessBlendLevel",void 0),e$z([a$$()],ol.prototype,"bumpLevel",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ol.prototype,"normalBlendMethod",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ol.prototype,"isEnabled",void 0),function(e){e[e.Zero=0]="Zero",e[e.One=1]="One",e[e.MaxViewZ=2]="MaxViewZ";}(hl||(hl={}));class ll{static CreateConfiguration(e){return ll._Configurations[e]={defines:{},previousWorldMatrices:{},previousViewProjection:re$5.Zero(),currentViewProjection:re$5.Zero(),previousBones:{},lastUpdateFrameId:-1,excludedSkinnedMesh:[],reverseCulling:false},ll._Configurations[e]}static DeleteConfiguration(e){delete ll._Configurations[e];}static GetConfiguration(e){return ll._Configurations[e]}static AddUniformsAndSamplers(e,t){e.push("previousWorld","previousViewProjection","mPreviousBones");}static MarkAsDirty(e,t){for(const i of t)if(i.subMeshes)for(const t of i.subMeshes)t._removeDrawWrapper(e);}static PrepareDefines(e,t,i){if(!i._arePrePassDirty)return;const s=ll._Configurations[e];if(!s)return;i.PREPASS=true,i.PREPASS_COLOR=false,i.PREPASS_COLOR_INDEX=-1;let r=0;for(let e=0;e<ll.GeometryTextureDescriptions.length;e++){const t=ll.GeometryTextureDescriptions[e],n=t.define,a=t.defineIndex,o=s.defines[a];void 0!==o?(i[n]=true,i[a]=o,r++):(i[n]=false,delete i[a]);}i.SCENE_MRT_COUNT=r,i.BONES_VELOCITY_ENABLED=t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&!t.skeleton.isUsingTextureForMatrices&&-1===s.excludedSkinnedMesh.indexOf(t);}static Bind(e,t,i,s,r){const n=ll._Configurations[e];if(!n)return;const a=i.getScene(),o=a.getEngine();if(n.reverseCulling&&o.setStateCullFaceType(a._mirroredCameraPosition?r.cullBackFaces:!r.cullBackFaces),(void 0!==n.defines.PREPASS_VELOCITY_INDEX||void 0!==n.defines.PREPASS_VELOCITY_LINEAR_INDEX)&&(n.previousWorldMatrices[i.uniqueId]||(n.previousWorldMatrices[i.uniqueId]=s.clone()),n.previousViewProjection||(n.previousViewProjection=a.getTransformMatrix().clone(),n.currentViewProjection=a.getTransformMatrix().clone()),n.currentViewProjection.updateFlag!==a.getTransformMatrix().updateFlag?(n.lastUpdateFrameId=o.frameId,n.previousViewProjection.copyFrom(n.currentViewProjection),n.currentViewProjection.copyFrom(a.getTransformMatrix())):n.lastUpdateFrameId!==o.frameId&&(n.lastUpdateFrameId=o.frameId,n.previousViewProjection.copyFrom(n.currentViewProjection)),t.setMatrix("previousWorld",n.previousWorldMatrices[i.uniqueId]),t.setMatrix("previousViewProjection",n.previousViewProjection),n.previousWorldMatrices[i.uniqueId]=s.clone(),i.useBones&&i.computeBonesUsingShaders&&i.skeleton)){const e=i.skeleton;if(!e.isUsingTextureForMatrices||-1===t.getUniformIndex("boneTextureWidth")){const s=e.getTransformMatrices(i);s&&(n.previousBones[i.uniqueId]||(n.previousBones[i.uniqueId]=s.slice()),t.setMatrices("mPreviousBones",n.previousBones[i.uniqueId]),n.previousBones[i.uniqueId].set(s));}}}}function cl(e){return class extends e{constructor(){super(...arguments),this.MAINUV1=false,this.MAINUV2=false,this.MAINUV3=false,this.MAINUV4=false,this.MAINUV5=false,this.MAINUV6=false,this.UV1=false,this.UV2=false,this.UV3=false,this.UV4=false,this.UV5=false,this.UV6=false;}}}ll.GeometryTextureDescriptions=[{type:Qe$1.PREPASS_IRRADIANCE_TEXTURE_TYPE,name:"Irradiance",clearType:0,define:"PREPASS_IRRADIANCE",defineIndex:"PREPASS_IRRADIANCE_INDEX"},{type:Qe$1.PREPASS_POSITION_TEXTURE_TYPE,name:"WorldPosition",clearType:0,define:"PREPASS_POSITION",defineIndex:"PREPASS_POSITION_INDEX"},{type:Qe$1.PREPASS_VELOCITY_TEXTURE_TYPE,name:"Velocity",clearType:0,define:"PREPASS_VELOCITY",defineIndex:"PREPASS_VELOCITY_INDEX"},{type:Qe$1.PREPASS_REFLECTIVITY_TEXTURE_TYPE,name:"Reflectivity",clearType:0,define:"PREPASS_REFLECTIVITY",defineIndex:"PREPASS_REFLECTIVITY_INDEX"},{type:Qe$1.PREPASS_DEPTH_TEXTURE_TYPE,name:"ViewDepth",clearType:2,define:"PREPASS_DEPTH",defineIndex:"PREPASS_DEPTH_INDEX"},{type:Qe$1.PREPASS_NORMAL_TEXTURE_TYPE,name:"ViewNormal",clearType:0,define:"PREPASS_NORMAL",defineIndex:"PREPASS_NORMAL_INDEX"},{type:Qe$1.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE,name:"AlbedoSqrt",clearType:0,define:"PREPASS_ALBEDO_SQRT",defineIndex:"PREPASS_ALBEDO_SQRT_INDEX"},{type:Qe$1.PREPASS_WORLD_NORMAL_TEXTURE_TYPE,name:"WorldNormal",clearType:0,define:"PREPASS_WORLD_NORMAL",defineIndex:"PREPASS_WORLD_NORMAL_INDEX"},{type:Qe$1.PREPASS_LOCAL_POSITION_TEXTURE_TYPE,name:"LocalPosition",clearType:0,define:"PREPASS_LOCAL_POSITION",defineIndex:"PREPASS_LOCAL_POSITION_INDEX"},{type:Qe$1.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE,name:"ScreenDepth",clearType:1,define:"PREPASS_SCREENSPACE_DEPTH",defineIndex:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:Qe$1.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE,name:"LinearVelocity",clearType:0,define:"PREPASS_VELOCITY_LINEAR",defineIndex:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:Qe$1.PREPASS_ALBEDO_TEXTURE_TYPE,name:"Albedo",clearType:0,define:"PREPASS_ALBEDO",defineIndex:"PREPASS_ALBEDO_INDEX"},{type:Qe$1.PREPASS_NORMALIZED_VIEW_DEPTH_TEXTURE_TYPE,name:"NormalizedViewDepth",clearType:1,define:"PREPASS_NORMALIZED_VIEW_DEPTH",defineIndex:"PREPASS_NORMALIZED_VIEW_DEPTH_INDEX"}],ll._Configurations={};const ul={effect:null,subMesh:null};class dl extends(cl(Eh)){}class _l extends(Rh(dl)){constructor(e){super(e),this.PBR=true,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=false,this.IBL_CDF_FILTERING=false,this.ALBEDO=false,this.GAMMAALBEDO=false,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=false,this.BASE_WEIGHT=false,this.BASE_WEIGHTDIRECTUV=0,this.BASE_DIFFUSE_ROUGHNESS=false,this.BASE_DIFFUSE_ROUGHNESSDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=false,this.AMBIENT=false,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=false,this.OPACITY=false,this.VERTEXALPHA=false,this.OPACITYDIRECTUV=0,this.OPACITYRGB=false,this.ALPHATEST=false,this.DEPTHPREPASS=false,this.ALPHABLEND=false,this.ALPHAFROMALBEDO=false,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=false,this.RADIANCEOVERALPHA=false,this.ALPHAFRESNEL=false,this.LINEARALPHAFRESNEL=false,this.PREMULTIPLYALPHA=false,this.EMISSIVE=false,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=false,this.REFLECTIVITY=false,this.REFLECTIVITY_GAMMA=false,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=false,this.MICROSURFACEFROMREFLECTIVITYMAP=false,this.MICROSURFACEAUTOMATIC=false,this.LODBASEDMICROSFURACE=false,this.MICROSURFACEMAP=false,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=false,this.ROUGHNESSSTOREINMETALMAPALPHA=false,this.ROUGHNESSSTOREINMETALMAPGREEN=false,this.METALLNESSSTOREINMETALMAPBLUE=false,this.AOSTOREINMETALMAPRED=false,this.METALLIC_REFLECTANCE=false,this.METALLIC_REFLECTANCE_GAMMA=false,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=false,this.REFLECTANCE=false,this.REFLECTANCE_GAMMA=false,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=false,this.ENVIRONMENTBRDF_RGBD=false,this.NORMAL=false,this.TANGENT=false,this.BUMP=false,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=false,this.PARALLAX=false,this.PARALLAX_RHS=false,this.PARALLAXOCCLUSION=false,this.NORMALXYSCALE=true,this.LIGHTMAP=false,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=false,this.GAMMALIGHTMAP=false,this.RGBDLIGHTMAP=false,this.REFLECTION=false,this.REFLECTIONMAP_3D=false,this.REFLECTIONMAP_SPHERICAL=false,this.REFLECTIONMAP_PLANAR=false,this.REFLECTIONMAP_CUBIC=false,this.USE_LOCAL_REFLECTIONMAP_CUBIC=false,this.REFLECTIONMAP_PROJECTION=false,this.REFLECTIONMAP_SKYBOX=false,this.REFLECTIONMAP_EXPLICIT=false,this.REFLECTIONMAP_EQUIRECTANGULAR=false,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false,this.INVERTCUBICMAP=false,this.USESPHERICALFROMREFLECTIONMAP=false,this.USEIRRADIANCEMAP=false,this.USE_IRRADIANCE_DOMINANT_DIRECTION=false,this.USESPHERICALINVERTEX=false,this.REFLECTIONMAP_OPPOSITEZ=false,this.LODINREFLECTIONALPHA=false,this.GAMMAREFLECTION=false,this.RGBDREFLECTION=false,this.LINEARSPECULARREFLECTION=false,this.RADIANCEOCCLUSION=false,this.HORIZONOCCLUSION=false,this.INSTANCES=false,this.THIN_INSTANCES=false,this.INSTANCESCOLOR=false,this.PREPASS=false,this.PREPASS_COLOR=false,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=false,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=false,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=false,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=false,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=false,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=false,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=false,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=false,this.PREPASS_WORLD_NORMAL=false,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=false,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=false,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=false,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=false,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=false,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=false,this.BONES_VELOCITY_ENABLED=false,this.NONUNIFORMSCALING=false,this.MORPHTARGETS=false,this.MORPHTARGETS_POSITION=false,this.MORPHTARGETS_NORMAL=false,this.MORPHTARGETS_TANGENT=false,this.MORPHTARGETS_UV=false,this.MORPHTARGETS_UV2=false,this.MORPHTARGETS_COLOR=false,this.MORPHTARGETTEXTURE_HASPOSITIONS=false,this.MORPHTARGETTEXTURE_HASNORMALS=false,this.MORPHTARGETTEXTURE_HASTANGENTS=false,this.MORPHTARGETTEXTURE_HASUVS=false,this.MORPHTARGETTEXTURE_HASUV2S=false,this.MORPHTARGETTEXTURE_HASCOLORS=false,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=false,this.MULTIVIEW=false,this.ORDER_INDEPENDENT_TRANSPARENCY=false,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=false,this.USEPHYSICALLIGHTFALLOFF=false,this.USEGLTFLIGHTFALLOFF=false,this.TWOSIDEDLIGHTING=false,this.MIRRORED=false,this.SHADOWFLOAT=false,this.CLIPPLANE=false,this.CLIPPLANE2=false,this.CLIPPLANE3=false,this.CLIPPLANE4=false,this.CLIPPLANE5=false,this.CLIPPLANE6=false,this.POINTSIZE=false,this.FOG=false,this.LOGARITHMICDEPTH=false,this.CAMERA_ORTHOGRAPHIC=false,this.CAMERA_PERSPECTIVE=false,this.AREALIGHTSUPPORTED=true,this.FORCENORMALFORWARD=false,this.SPECULARAA=false,this.UNLIT=false,this.DECAL_AFTER_DETAIL=false,this.DEBUGMODE=0,this.USE_VERTEX_PULLING=false,this.CLUSTLIGHT_SLICES=0,this.CLUSTLIGHT_BATCH=0,this.rebuild();}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=true,this.NORMALXYSCALE=true;}}class fl extends(bh(Ah)){}class pl extends fl{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}get canRenderToMRT(){return  true}constructor(e,t,i=false){super(e,t,void 0,i||pl.ForceGLSL),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new ie$5(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=false,this._albedoTexture=null,this._baseWeightTexture=null,this._baseDiffuseRoughnessTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=pl.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=ge$3.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=false,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new ge$3(0,0,0),this._albedoColor=new ge$3(1,1,1),this._baseWeight=1,this._baseDiffuseRoughness=null,this._reflectivityColor=new ge$3(1,1,1),this._reflectionColor=new ge$3(1,1,1),this._emissiveColor=new ge$3(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=false,this._useHorizonOcclusion=true,this._useRadianceOcclusion=true,this._useAlphaFromAlbedoTexture=false,this._useSpecularOverAlpha=true,this._useMicroSurfaceFromReflectivityMapAlpha=false,this._useRoughnessFromMetallicTextureAlpha=true,this._useRoughnessFromMetallicTextureGreen=false,this._useMetallnessFromMetallicTextureBlue=false,this._useAmbientOcclusionFromMetallicTextureRed=false,this._useAmbientInGrayScale=false,this._useAutoMicroSurfaceFromReflectivityMap=false,this._lightFalloff=pl.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=true,this._useObjectSpaceNormalMap=false,this._useParallax=false,this._useParallaxOcclusion=false,this._parallaxScaleBias=.05,this._disableLighting=false,this._maxSimultaneousLights=4,this._invertNormalMapX=false,this._invertNormalMapY=false,this._twoSidedLighting=false,this._alphaCutOff=.4,this._useAlphaFresnel=false,this._useLinearAlphaFresnel=false,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=false,this._realTimeFiltering=false,this._realTimeFilteringQuality=Qe$1.TEXTURE_FILTERING_QUALITY_LOW,this._forceNormalForward=false,this._enableSpecularAntiAliasing=false,this._renderTargets=new Ii(16),this._globalAmbientColor=new ge$3(0,0,0),this._unlit=false,this._applyDecalMapAfterDetailMap=false,this._debugMode=0,this._shadersLoaded=false,this._breakShaderLoadedCheck=false,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=false,this.brdf=new Yh(this),this.clearCoat=new Zh(this),this.iridescence=new $h(this),this.anisotropy=new tl(this),this.sheen=new sl(this),this.subSurface=new nl(this),this.detailMap=new ol(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),bs.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=Uh(this.getScene()),this.prePassConfiguration=new Kh;}get hasRenderTargetTextures(){return !!(bs.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return !this.disableDepthWrite}getClassName(){return "PBRBaseMaterial"}get _disableAlphaBlending(){return this._transparencyMode===pl.PBRMATERIAL_OPAQUE||this._transparencyMode===pl.PBRMATERIAL_ALPHATEST||this.subSurface?.disableAlphaBlending}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:!this.subSurface?.disableAlphaBlending&&(this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===pl.PBRMATERIAL_ALPHATEST))}_shouldUseAlphaFromAlbedoTexture(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==pl.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return  true;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new _l(this._eventInfo.defineNames));const r=t.materialDefines;if(this._isReadyForSubMesh(t))return  true;const n=this.getScene(),a=n.getEngine();if(r._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=false,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n.texturesEnabled)){if(this._albedoTexture&&bs.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking())return  false;if(this._baseWeightTexture&&bs.BaseWeightTextureEnabled&&!this._baseWeightTexture.isReadyOrNotBlocking())return  false;if(this._baseDiffuseRoughnessTexture&&bs.BaseDiffuseRoughnessTextureEnabled&&!this._baseDiffuseRoughnessTexture.isReadyOrNotBlocking())return  false;if(this._ambientTexture&&bs.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking())return  false;if(this._opacityTexture&&bs.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return  false;const e=this._getReflectionTexture();if(e&&bs.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return  false;if(e.irradianceTexture){if(!e.irradianceTexture.isReadyOrNotBlocking())return  false}else if(!e.sphericalPolynomial&&e.getInternalTexture()?._sphericalPolynomialPromise)return  false}if(this._lightmapTexture&&bs.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking())return  false;if(this._emissiveTexture&&bs.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return  false;if(bs.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return  false}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return  false;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking())return  false;if(this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking())return  false;if(this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return  false}if(a.getCaps().standardDerivatives&&this._bumpTexture&&bs.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady())return  false;if(this._environmentBRDFTexture&&bs.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return  false}if(this._eventInfo.isReadyForSubMesh=true,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return  false;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return  false;if(r.AREALIGHTUSED||r.CLUSTLIGHT_BATCH)for(let t=0;t<e.lightSources.length;t++)if(!e.lightSources[t]._isReady())return  false;a.getCaps().standardDerivatives||e.isVerticesDataPresent(Hi.NormalKind)||(e.createNormals(true),Ie$2.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const o=t.effect,h=r._areLightsDisposed;let l=this._prepareEffect(e,t.getRenderingMesh(),r,this.onCompiled,this.onError,i,null),c=false;if(l)if(this._onEffectCreatedObservable&&(ul.effect=l,ul.subMesh=t,this._onEffectCreatedObservable.notifyObservers(ul)),this.allowShaderHotSwapping&&o&&!l.isReady()){if(l=o,r.markAsUnprocessed(),c=this.isFrozen,h)return r._areLightsDisposed=true,false}else n.resetCachedMaterial(),t.setEffect(l,r,this._materialContext);return !(!t.effect||!t.effect.isReady())&&(r._renderId=n.getRenderId(),s._wasPreviouslyReady=!c,s._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),true)}isMetallicWorkflow(){return !(null==this._metallic&&null==this._roughness&&!this._metallicTexture)}_prepareEffect(e,t,i,s=null,r=null,n=null,a=null){if(this._prepareDefines(e,t,i,n,a),!i.isDirty)return null;i.markAsProcessed();const o=this.getScene().getEngine(),h=new ro;let l=0;i.USESPHERICALINVERTEX&&h.addFallback(l++,"USESPHERICALINVERTEX"),i.FOG&&h.addFallback(l,"FOG"),i.SPECULARAA&&h.addFallback(l,"SPECULARAA"),i.POINTSIZE&&h.addFallback(l,"POINTSIZE"),i.LOGARITHMICDEPTH&&h.addFallback(l,"LOGARITHMICDEPTH"),i.PARALLAX&&h.addFallback(l,"PARALLAX"),i.PARALLAX_RHS&&h.addFallback(l,"PARALLAX_RHS"),i.PARALLAXOCCLUSION&&h.addFallback(l++,"PARALLAXOCCLUSION"),i.ENVIRONMENTBRDF&&h.addFallback(l++,"ENVIRONMENTBRDF"),i.TANGENT&&h.addFallback(l++,"TANGENT"),i.BUMP&&h.addFallback(l++,"BUMP"),l=Ks(i,h,this._maxSimultaneousLights,l++),i.SPECULARTERM&&h.addFallback(l++,"SPECULARTERM"),i.USESPHERICALFROMREFLECTIONMAP&&h.addFallback(l++,"USESPHERICALFROMREFLECTIONMAP"),i.USEIRRADIANCEMAP&&h.addFallback(l++,"USEIRRADIANCEMAP"),i.LIGHTMAP&&h.addFallback(l++,"LIGHTMAP"),i.NORMAL&&h.addFallback(l++,"NORMAL"),i.AMBIENT&&h.addFallback(l++,"AMBIENT"),i.EMISSIVE&&h.addFallback(l++,"EMISSIVE"),i.VERTEXCOLOR&&h.addFallback(l++,"VERTEXCOLOR"),i.MORPHTARGETS&&h.addFallback(l++,"MORPHTARGETS"),i.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const c=[Hi.PositionKind];i.NORMAL&&c.push(Hi.NormalKind),i.TANGENT&&c.push(Hi.TangentKind);for(let e=1;e<=Qe$1.MAX_SUPPORTED_UV_SETS;++e)i["UV"+e]&&c.push(`uv${1===e?"":e}`);i.VERTEXCOLOR&&c.push(Hi.ColorKind),Ws(c,e,i,h),Ys(c,i),Ls(c,e,i),Vs(c,0,i);let u="pbr";const d=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","baseWeight","baseDiffuseRoughness","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vBaseWeightInfos","vBaseDiffuseRoughnessInfos","vAmbientInfos","vOpacityInfos","vEmissiveInfos","vReflectivityInfos","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","baseWeightMatrix","baseDiffuseRoughnessMatrix","ambientMatrix","opacityMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"],_=["albedoSampler","baseWeightSampler","baseDiffuseRoughnessSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"];rr$1(d,_,true);const f=["Material","Scene","Mesh"],p={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:i.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=l,this._eventInfo.defines=i,this._eventInfo.uniforms=d,this._eventInfo.attributes=c,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=f,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=p,this._callbackPluginEventGeneric(128,this._eventInfo),ll.AddUniformsAndSamplers(d,_),Kh.AddUniforms(d),Ts(d),En&&(En.PrepareUniforms(d,i),En.PrepareSamplers(_,i)),nr$1({uniformsNames:d,uniformBuffersNames:f,samplers:_,defines:i,maxSimultaneousLights:this._maxSimultaneousLights});const g={};this.customShaderNameResolve&&(u=this.customShaderNameResolve(u,d,f,_,i,c,g));const m=i.toString(),T=o.createEffect(u,{attributes:c,uniformsNames:d,uniformBuffersNames:f,samplers:_,defines:m,fallbacks:h,onCompiled:s,onError:r,indexParameters:p,processFinalCode:g.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:i.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(function(){return pbr_vertexC4arN8R__esm_min}),Promise.resolve().then(function(){return pbr_fragmentBMoFW2hA_esm_min})]):await Promise.all([Promise.resolve().then(function(){return pbr_vertexCVn_VV4N_esm_min}),Promise.resolve().then(function(){return pbr_fragmentC9RmUGFO_esm_min})]),this._shadersLoaded=true;}},o);return this._eventInfo.customCode=void 0,T}_prepareDefines(e,t,i,s=null,r=null){const n=t.hasThinInstances,a=this.getScene(),o=a.getEngine();Qs(a,e,i,true,this._maxSimultaneousLights,this._disableLighting),i._needNormals=true,er$1(a,i);const h=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(ir$1(a,i,this.canRenderToMRT&&!h),tr$1(a,i,h),ll.PrepareDefines(o.currentRenderPassId,e,i),i.METALLICWORKFLOW=this.isMetallicWorkflow(),i._areTexturesDirty){i._needUVs=false;for(let e=1;e<=Qe$1.MAX_SUPPORTED_UV_SETS;++e)i["MAINUV"+e]=false;if(a.texturesEnabled){i.ALBEDODIRECTUV=0,i.BASE_WEIGHTDIRECTUV=0,i.BASE_DIFFUSE_ROUGHNESSDIRECTUV=0,i.AMBIENTDIRECTUV=0,i.OPACITYDIRECTUV=0,i.EMISSIVEDIRECTUV=0,i.REFLECTIVITYDIRECTUV=0,i.MICROSURFACEMAPDIRECTUV=0,i.METALLIC_REFLECTANCEDIRECTUV=0,i.REFLECTANCEDIRECTUV=0,i.BUMPDIRECTUV=0,i.LIGHTMAPDIRECTUV=0,o.getCaps().textureLOD&&(i.LODBASEDMICROSFURACE=true),this._albedoTexture&&bs.DiffuseTextureEnabled?(ks(this._albedoTexture,i,"ALBEDO"),i.GAMMAALBEDO=this._albedoTexture.gammaSpace):i.ALBEDO=false,this._baseWeightTexture&&bs.BaseWeightTextureEnabled?ks(this._baseWeightTexture,i,"BASE_WEIGHT"):i.BASE_WEIGHT=false,this._baseDiffuseRoughnessTexture&&bs.BaseDiffuseRoughnessTextureEnabled?ks(this._baseDiffuseRoughnessTexture,i,"BASE_DIFFUSE_ROUGHNESS"):i.BASE_DIFFUSE_ROUGHNESS=false,this._ambientTexture&&bs.AmbientTextureEnabled?(ks(this._ambientTexture,i,"AMBIENT"),i.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):i.AMBIENT=false,this._opacityTexture&&bs.OpacityTextureEnabled?(ks(this._opacityTexture,i,"OPACITY"),i.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):i.OPACITY=false;const e=this._getReflectionTexture(),t=this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||o.getCaps().maxVaryingVectors<=8||null!=this._baseDiffuseRoughnessTexture;qs(a,e,i,this.realTimeFiltering,this.realTimeFilteringQuality,!t),this._lightmapTexture&&bs.LightmapTextureEnabled?(ks(this._lightmapTexture,i,"LIGHTMAP"),i.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,i.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,i.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):i.LIGHTMAP=false,this._emissiveTexture&&bs.EmissiveTextureEnabled?(ks(this._emissiveTexture,i,"EMISSIVE"),i.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):i.EMISSIVE=false,bs.SpecularTextureEnabled?(this._metallicTexture?(ks(this._metallicTexture,i,"REFLECTIVITY"),i.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,i.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,i.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,i.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,i.REFLECTIVITY_GAMMA=false):this._reflectivityTexture?(ks(this._reflectivityTexture,i,"REFLECTIVITY"),i.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,i.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,i.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):i.REFLECTIVITY=false,this._metallicReflectanceTexture||this._reflectanceTexture?(i.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?(ks(this._metallicReflectanceTexture,i,"METALLIC_REFLECTANCE"),i.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):i.METALLIC_REFLECTANCE=false,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(ks(this._reflectanceTexture,i,"REFLECTANCE"),i.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):i.REFLECTANCE=false):(i.METALLIC_REFLECTANCE=false,i.REFLECTANCE=false),this._microSurfaceTexture?ks(this._microSurfaceTexture,i,"MICROSURFACEMAP"):i.MICROSURFACEMAP=false):(i.REFLECTIVITY=false,i.MICROSURFACEMAP=false),o.getCaps().standardDerivatives&&this._bumpTexture&&bs.BumpTextureEnabled&&!this._disableBumpMap?(ks(this._bumpTexture,i,"BUMP"),this._useParallax&&this._albedoTexture&&bs.DiffuseTextureEnabled?(i.PARALLAX=true,i.PARALLAX_RHS=a.useRightHandedSystem,i.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):i.PARALLAX=false,i.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(i.BUMP=false,i.PARALLAX=false,i.PARALLAX_RHS=false,i.PARALLAXOCCLUSION=false,i.OBJECTSPACE_NORMALMAP=false),this._environmentBRDFTexture&&bs.ReflectionTextureEnabled?(i.ENVIRONMENTBRDF=true,i.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(i.ENVIRONMENTBRDF=false,i.ENVIRONMENTBRDF_RGBD=false),this._shouldUseAlphaFromAlbedoTexture()?i.ALPHAFROMALBEDO=true:i.ALPHAFROMALBEDO=false;}i.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===pl.LIGHTFALLOFF_STANDARD?(i.USEPHYSICALLIGHTFALLOFF=false,i.USEGLTFLIGHTFALLOFF=false):this._lightFalloff===pl.LIGHTFALLOFF_GLTF?(i.USEPHYSICALLIGHTFALLOFF=false,i.USEGLTFLIGHTFALLOFF=true):(i.USEPHYSICALLIGHTFALLOFF=true,i.USEGLTFLIGHTFALLOFF=false),i.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?i.TWOSIDEDLIGHTING=true:i.TWOSIDEDLIGHTING=false,i.MIRRORED=!!a._mirroredCameraPosition,i.SPECULARAA=o.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing;}(i._areTexturesDirty||i._areMiscDirty)&&(i.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,i.PREMULTIPLYALPHA=this.alphaMode===Qe$1.ALPHA_PREMULTIPLIED||this.alphaMode===Qe$1.ALPHA_PREMULTIPLIED_PORTERDUFF,i.ALPHABLEND=this.needAlphaBlendingForMesh(e),i.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,i.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),i._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(i),i.FORCENORMALFORWARD=this._forceNormalForward,i.RADIANCEOCCLUSION=this._useRadianceOcclusion,i.HORIZONOCCLUSION=this._useHorizonOcclusion,i._areMiscDirty&&(js(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),i,this._applyDecalMapAfterDetailMap,this._useVertexPulling,t,this._isVertexOutputInvariant),i.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(Hi.NormalKind),i.DEBUGMODE=this._debugMode),Js(a,o,this,i,!!s,r,n),this._eventInfo.defines=i,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),$s(e,i,true,true,true,this._transparencyMode!==pl.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo);}forceCompilation(e,t,i){const s={clipPlane:false,useInstances:false,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo);(()=>{if(this._breakShaderLoadedCheck)return;const i=new _l(this._eventInfo.defineNames),r=this._prepareEffect(e,e,i,void 0,void 0,s.useInstances,s.clipPlane);this._onEffectCreatedObservable&&(ul.effect=r,ul.subMesh=null,this._onEffectCreatedObservable.notifyObservers(ul)),r.isReady()?t&&t(this):r.onCompileObservable.add((()=>{t&&t(this);}));})();}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vBaseWeightInfos",2),e.addUniform("vBaseDiffuseRoughnessInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("baseWeightMatrix",16),e.addUniform("baseDiffuseRoughnessMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("vAlbedoColor",4),e.addUniform("baseWeight",1),e.addUniform("baseDiffuseRoughness",1),e.addUniform("vLightingIntensity",4),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("cameraInfo",4),ar$1(e,true,true,true,true,true),super.buildUniformLayout();}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(!n)return;this._activeEffect=n,t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e);const a=s.getEngine();this._uniformBuffer.bindToEffect(n,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,s,t,e,this.isFrozen),ll.Bind(a.currentRenderPassId,this._activeEffect,t,e,this);const o=s.activeCamera;o?this._uniformBuffer.updateFloat4("cameraInfo",o.minZ,o.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),r.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const h=this._mustRebind(s,n,i,t.visibility);Hs(t,this._activeEffect,this.prePassConfiguration);let l=null;const c=this._uniformBuffer;if(h){if(this.bindViewProjection(n),l=this._getReflectionTexture(),!c.useUbo||!this.isFrozen||!c.isSync||i._drawWrapper._forceRebindOnNextCall){if(s.texturesEnabled&&(this._albedoTexture&&bs.DiffuseTextureEnabled&&(c.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),Gs(this._albedoTexture,c,"albedo")),this._baseWeightTexture&&bs.BaseWeightTextureEnabled&&(c.updateFloat2("vBaseWeightInfos",this._baseWeightTexture.coordinatesIndex,this._baseWeightTexture.level),Gs(this._baseWeightTexture,c,"baseWeight")),this._baseDiffuseRoughnessTexture&&bs.BaseDiffuseRoughnessTextureEnabled&&(c.updateFloat2("vBaseDiffuseRoughnessInfos",this._baseDiffuseRoughnessTexture.coordinatesIndex,this._baseDiffuseRoughnessTexture.level),Gs(this._baseDiffuseRoughnessTexture,c,"baseDiffuseRoughness")),this._ambientTexture&&bs.AmbientTextureEnabled&&(c.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),Gs(this._ambientTexture,c,"ambient")),this._opacityTexture&&bs.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),Gs(this._opacityTexture,c,"opacity")),this._emissiveTexture&&bs.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),Gs(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&bs.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),Gs(this._lightmapTexture,c,"lightmap")),bs.SpecularTextureEnabled&&(this._metallicTexture?(c.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),Gs(this._metallicTexture,c,"reflectivity")):this._reflectivityTexture&&(c.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),Gs(this._reflectivityTexture,c,"reflectivity")),this._metallicReflectanceTexture&&(c.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),Gs(this._metallicReflectanceTexture,c,"metallicReflectance")),this._reflectanceTexture&&r.REFLECTANCE&&(c.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),Gs(this._reflectanceTexture,c,"reflectance")),this._microSurfaceTexture&&(c.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),Gs(this._microSurfaceTexture,c,"microSurfaceSampler"))),this._bumpTexture&&a.getCaps().standardDerivatives&&bs.BumpTextureEnabled&&!this._disableBumpMap&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),Gs(this._bumpTexture,c,"bump"),s._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),Bs(s,r,c,this._reflectionColor,l,this.realTimeFiltering,true,true,true,true,true)),this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),r.METALLICWORKFLOW){Te$3.Color4[0].r=void 0===this._metallic||null===this._metallic?1:this._metallic,Te$3.Color4[0].g=void 0===this._roughness||null===this._roughness?1:this._roughness;const e=this.subSurface?._indexOfRefraction??1.5,t=1;Te$3.Color4[0].b=e;const i=Math.pow((e-t)/(e+t),2);Te$3.Color4[0].a=i,c.updateDirectColor4("vReflectivityColor",Te$3.Color4[0]),c.updateColor4("vMetallicReflectanceFactors",this._metallicReflectanceColor,this._metallicF0Factor);}else c.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);c.updateColor3("vEmissiveColor",bs.EmissiveTextureEnabled?this._emissiveColor:ge$3.BlackReadOnly),!r.SS_REFRACTION&&this.subSurface?._linkRefractionWithTransparency?c.updateColor4("vAlbedoColor",this._albedoColor,1):c.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),c.updateFloat("baseWeight",this._baseWeight),c.updateFloat("baseDiffuseRoughness",this._baseDiffuseRoughness||0),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*s.environmentIntensity,this._lightingInfos.w=this._specularIntensity,c.updateVector4("vLightingIntensity",this._lightingInfos),s.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor),c.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor);}s.texturesEnabled&&(this._albedoTexture&&bs.DiffuseTextureEnabled&&c.setTexture("albedoSampler",this._albedoTexture),this._baseWeightTexture&&bs.BaseWeightTextureEnabled&&c.setTexture("baseWeightSampler",this._baseWeightTexture),this._baseDiffuseRoughnessTexture&&bs.BaseDiffuseRoughnessTextureEnabled&&c.setTexture("baseDiffuseRoughnessSampler",this._baseDiffuseRoughnessTexture),this._ambientTexture&&bs.AmbientTextureEnabled&&c.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&bs.OpacityTextureEnabled&&c.setTexture("opacitySampler",this._opacityTexture),Us(s,r,c,l,this.realTimeFiltering),r.ENVIRONMENTBRDF&&c.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&bs.EmissiveTextureEnabled&&c.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&bs.LightmapTextureEnabled&&c.setTexture("lightmapSampler",this._lightmapTexture),bs.SpecularTextureEnabled&&(this._metallicTexture?c.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&c.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&c.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&r.REFLECTANCE&&c.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&c.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&a.getCaps().standardDerivatives&&bs.BumpTextureEnabled&&!this._disableBumpMap&&c.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(n),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),As(this._activeEffect,this,s),this.bindEyePosition(n);}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=true);!h&&this.isFrozen||(s.lightsEnabled&&!this._disableLighting&&Xs(s,t,this._activeEffect,r,this._maxSimultaneousLights),(s.fogEnabled&&t.applyFog&&s.fogMode!==ch.FOGMODE_NONE||l||this.subSurface.refractionTexture||t.receiveShadows||r.PREPASS||r.CLUSTLIGHT_BATCH)&&this.bindView(n),Os(s,t,this._activeEffect,true),r.NUM_MORPH_INFLUENCERS&&ws(t,this._activeEffect),r.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(n,r.INSTANCES),this._imageProcessingConfiguration.bind(this._activeEffect),Cs(r,this._activeEffect,s)),this._afterBind(t,this._activeEffect,i),c.update();}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._baseWeightTexture&&this._baseWeightTexture.animations&&this._baseWeightTexture.animations.length>0&&e.push(this._baseWeightTexture),this._baseDiffuseRoughnessTexture&&this._baseDiffuseRoughnessTexture.animations&&this._baseDiffuseRoughnessTexture.animations.length>0&&e.push(this._baseDiffuseRoughnessTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._baseWeightTexture&&e.push(this._baseWeightTexture),this._baseDiffuseRoughnessTexture&&e.push(this._baseDiffuseRoughnessTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return !!super.hasTexture(e)||(this._albedoTexture===e||(this._baseWeightTexture===e||(this._baseDiffuseRoughnessTexture===e||(this._ambientTexture===e||(this._opacityTexture===e||(this._reflectionTexture===e||(this._emissiveTexture===e||(this._reflectivityTexture===e||(this._metallicTexture===e||(this._metallicReflectanceTexture===e||(this._reflectanceTexture===e||(this._microSurfaceTexture===e||(this._bumpTexture===e||this._lightmapTexture===e)))))))))))))}setPrePassRenderer(){if(!this.subSurface?.isScatteringEnabled)return  false;const e=this.getScene().enableSubSurfaceForPrePass();return e&&(e.enabled=true),true}dispose(e,t){this._breakShaderLoadedCheck=true,t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),this._albedoTexture?.dispose(),this._baseWeightTexture?.dispose(),this._baseDiffuseRoughnessTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._metallicTexture?.dispose(),this._reflectivityTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._metallicReflectanceTexture?.dispose(),this._reflectanceTexture?.dispose(),this._microSurfaceTexture?.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t);}}pl.PBRMATERIAL_OPAQUE=hr$1.MATERIAL_OPAQUE,pl.PBRMATERIAL_ALPHATEST=hr$1.MATERIAL_ALPHATEST,pl.PBRMATERIAL_ALPHABLEND=hr$1.MATERIAL_ALPHABLEND,pl.PBRMATERIAL_ALPHATESTANDBLEND=hr$1.MATERIAL_ALPHATESTANDBLEND,pl.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,pl.LIGHTFALLOFF_PHYSICAL=0,pl.LIGHTFALLOFF_GLTF=1,pl.LIGHTFALLOFF_STANDARD=2,pl.ForceGLSL=false,e$z([n$1W("_markAllSubMeshesAsMiscDirty")],pl.prototype,"debugMode",void 0);class gl extends pl{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=true:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=false);}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e;}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e;}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=true);}get usePhysicalLightFalloff(){return this._lightFalloff===pl.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?pl.LIGHTFALLOFF_PHYSICAL:pl.LIGHTFALLOFF_STANDARD);}get useGLTFLightFalloff(){return this._lightFalloff===pl.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?pl.LIGHTFALLOFF_GLTF:pl.LIGHTFALLOFF_STANDARD);}constructor(e,t,i=false){super(e,t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=false,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=gl.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=ge$3.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=false,this.ambientColor=new ge$3(0,0,0),this.albedoColor=new ge$3(1,1,1),this.baseWeight=1,this.reflectivityColor=new ge$3(1,1,1),this.reflectionColor=new ge$3(1,1,1),this.emissiveColor=new ge$3(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=false,this.useAlphaFromAlbedoTexture=false,this.forceAlphaTest=false,this.alphaCutOff=.4,this.useSpecularOverAlpha=true,this.useMicroSurfaceFromReflectivityMapAlpha=false,this.useRoughnessFromMetallicTextureAlpha=true,this.useRoughnessFromMetallicTextureGreen=false,this.useMetallnessFromMetallicTextureBlue=false,this.useAmbientOcclusionFromMetallicTextureRed=false,this.useAmbientInGrayScale=false,this.useAutoMicroSurfaceFromReflectivityMap=false,this.useRadianceOverAlpha=true,this.useObjectSpaceNormalMap=false,this.useParallax=false,this.useParallaxOcclusion=false,this.parallaxScaleBias=.05,this.disableLighting=false,this.forceIrradianceInFragment=false,this.maxSimultaneousLights=4,this.invertNormalMapX=false,this.invertNormalMapY=false,this.twoSidedLighting=false,this.useAlphaFresnel=false,this.useLinearAlphaFresnel=false,this.environmentBRDFTexture=null,this.forceNormalForward=false,this.enableSpecularAntiAliasing=false,this.useHorizonOcclusion=true,this.useRadianceOcclusion=true,this.unlit=false,this.applyDecalMapAfterDetailMap=false,this._environmentBRDFTexture=Uh(this.getScene());}getClassName(){return "PBRMaterial"}clone(e,t=true,i=""){const s=Ae$3.Clone((()=>new gl(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.id=e,s.name=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const s=Ae$3.Parse((()=>new gl(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),hr$1._ParsePlugins(e,s,t,i),e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}gl.PBRMATERIAL_OPAQUE=pl.PBRMATERIAL_OPAQUE,gl.PBRMATERIAL_ALPHATEST=pl.PBRMATERIAL_ALPHATEST,gl.PBRMATERIAL_ALPHABLEND=pl.PBRMATERIAL_ALPHABLEND,gl.PBRMATERIAL_ALPHATESTANDBLEND=pl.PBRMATERIAL_ALPHATESTANDBLEND,gl.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=pl.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"directIntensity",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"emissiveIntensity",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"environmentIntensity",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"specularIntensity",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"disableBumpMap",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"albedoTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"baseWeightTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"baseDiffuseRoughnessTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"ambientTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"ambientTextureStrength",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesAndMiscDirty")],gl.prototype,"opacityTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"reflectionTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"emissiveTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"reflectivityTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"metallicTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"metallic",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"roughness",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"metallicF0Factor",void 0),e$z([h$c(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"metallicReflectanceColor",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"metallicReflectanceTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"reflectanceTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"microSurfaceTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"bumpTexture",void 0),e$z([o$19(),n$1W("_markAllSubMeshesAsTexturesDirty",null)],gl.prototype,"lightmapTexture",void 0),e$z([h$c("ambient"),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"ambientColor",void 0),e$z([h$c("albedo"),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"albedoColor",void 0),e$z([a$$("baseWeight"),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"baseWeight",void 0),e$z([a$$("baseDiffuseRoughness"),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"baseDiffuseRoughness",void 0),e$z([h$c("reflectivity"),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"reflectivityColor",void 0),e$z([h$c("reflection"),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"reflectionColor",void 0),e$z([h$c("emissive"),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"emissiveColor",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"microSurface",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useLightmapAsShadowmap",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesAndMiscDirty")],gl.prototype,"useAlphaFromAlbedoTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesAndMiscDirty")],gl.prototype,"forceAlphaTest",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesAndMiscDirty")],gl.prototype,"alphaCutOff",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useSpecularOverAlpha",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useRoughnessFromMetallicTextureGreen",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useMetallnessFromMetallicTextureBlue",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useAmbientInGrayScale",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),e$z([a$$()],gl.prototype,"usePhysicalLightFalloff",null),e$z([a$$()],gl.prototype,"useGLTFLightFalloff",null),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useRadianceOverAlpha",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useObjectSpaceNormalMap",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useParallax",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useParallaxOcclusion",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"parallaxScaleBias",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsLightsDirty")],gl.prototype,"disableLighting",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"forceIrradianceInFragment",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsLightsDirty")],gl.prototype,"maxSimultaneousLights",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"invertNormalMapX",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"invertNormalMapY",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"twoSidedLighting",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useAlphaFresnel",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useLinearAlphaFresnel",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"environmentBRDFTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"forceNormalForward",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"enableSpecularAntiAliasing",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useHorizonOcclusion",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],gl.prototype,"useRadianceOcclusion",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],gl.prototype,"unlit",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],gl.prototype,"applyDecalMapAfterDetailMap",void 0),P$9("BABYLON.PBRMaterial",gl);var ml,Tl=Object.freeze({__proto__:null,PBRMaterial:gl});function El(e,t,i){const s=e.getVertexBuffer(i);if(!s)return null;const r=s.getData();if(!r)return null;let n;return Ui(r,s.byteStride*t,s.byteStride,s.getSize(),s.type,1,s.normalized,(e=>n=e)),n}function Al(e,t,i){const s=El(e,t,Hi.PositionKind);if(!s)return  false;if(s.some((e=>isNaN(e??Number.NaN))))return  false;if(e.morphTargetManager){const i=3*t;for(let t=0;t<s.length;t++){let r=s[t];for(let n=0;n<e.morphTargetManager.numTargets;n++){const a=e.morphTargetManager.getTarget(n),o=a.influence;if(0!==o){const e=a.getPositions();e&&(r+=(e[i+t]-s[t])*o);}}s[t]=r;}}if(i.fromArray(s),e.skeleton){const r=El(e,t,Hi.MatricesIndicesKind),n=El(e,t,Hi.MatricesWeightsKind);if(r&&n){const a=e.numBoneInfluencers>4,o=a?El(e,t,Hi.MatricesIndicesExtraKind):null,h=a?El(e,t,Hi.MatricesWeightsExtraKind):null,l=e.skeleton.getTransformMatrices(e),c=ae$5.Matrix[0],u=ae$5.Matrix[1];c.reset();for(let e=0;e<n.length;e++){const t=n[e];t>0&&(re$5.FromFloat32ArrayToRefScaled(l,Math.floor(16*r[e]),t,u),c.addToSelf(u));}if(o&&h)for(let e=0;e<h.length;e++){const t=h[e];t>0&&(re$5.FromFloat32ArrayToRefScaled(l,Math.floor(16*o[e]),t,u),c.addToSelf(u));}te$4.TransformCoordinatesFromFloatsToRef(s[0],s[1],s[2],c,i);}}return  true}Er$1._GroundMeshParser=(e,t)=>Rl.Parse(e,t);class Rl extends Er$1{constructor(e,t){super(e,t),this.generateOctree=false;}getClassName(){return "GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);const i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t);}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),s=ae$5.Matrix[5];i.invertToRef(s);const r=ae$5.Vector3[8];if(te$4.TransformCoordinatesFromFloatsToRef(e,0,t,s,r),e=r.x,t=r.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const n=this._getFacetAt(e,t),a=-(n.x*e+n.z*t+n.w)/n.y;return te$4.TransformCoordinatesFromFloatsToRef(0,a,0,i,r),r.y}getNormalAtCoordinates(e,t){const i=new te$4(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const s=this.getWorldMatrix(),r=ae$5.Matrix[5];s.invertToRef(r);const n=ae$5.Vector3[8];if(te$4.TransformCoordinatesFromFloatsToRef(e,0,t,r,n),e=n.x,t=n.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const a=this._getFacetAt(e,t);return te$4.TransformNormalFromFloatsToRef(a.x,a.y,a.z,s,i),this}updateCoordinateHeights(){return this._heightQuads&&0!=this._heightQuads.length||this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),s=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),r=this._heightQuads[s*this._subdivisionsX+i];let n;return n=t<r.slope.x*e+r.slope.y?r.facet1:r.facet2,n}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=[];for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s={slope:ee$4.Zero(),facet1:new ie$5(0,0,0,0),facet2:new ie$5(0,0,0,0)};this._heightQuads[i*e+t]=s;}return this}_computeHeightQuads(){const e=this.getVerticesData(Hi.PositionKind);if(!e)return this;const t=ae$5.Vector3[3],i=ae$5.Vector3[2],s=ae$5.Vector3[1],r=ae$5.Vector3[0],n=ae$5.Vector3[4],a=ae$5.Vector3[5],o=ae$5.Vector3[6],h=ae$5.Vector3[7],l=ae$5.Vector3[8];let c=0,u=0,d=0,_=0,f=0,p=0,g=0;const m=this._subdivisionsX,T=this._subdivisionsY;for(let E=0;E<T;E++)for(let T=0;T<m;T++){c=3*T,u=E*(m+1)*3,d=(E+1)*(m+1)*3,t.x=e[u+c],t.y=e[u+c+1],t.z=e[u+c+2],i.x=e[u+c+3],i.y=e[u+c+4],i.z=e[u+c+5],s.x=e[d+c],s.y=e[d+c+1],s.z=e[d+c+2],r.x=e[d+c+3],r.y=e[d+c+4],r.z=e[d+c+5],_=(r.z-t.z)/(r.x-t.x),f=t.z-_*t.x,i.subtractToRef(t,n),s.subtractToRef(t,a),r.subtractToRef(t,o),te$4.CrossToRef(o,a,h),te$4.CrossToRef(n,o,l),h.normalize(),l.normalize(),p=-(h.x*t.x+h.y*t.y+h.z*t.z),g=-(l.x*i.x+l.y*i.y+l.z*i.z);const A=this._heightQuads[E*m+T];A.slope.copyFromFloats(_,f),A.facet1.copyFromFloats(h.x,h.y,h.z,p),A.facet2.copyFromFloats(l.x,l.y,l.z,g);}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height;}static Parse(e,t){const i=new Rl(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function bl(e){const t=[],i=[],s=[],r=[];let n,a;const o=e.width||e.size||1,h=e.height||e.size||1,l=0|(e.subdivisionsX||e.subdivisions||1),c=0|(e.subdivisionsY||e.subdivisions||1);for(n=0;n<=c;n++)for(a=0;a<=l;a++){const e=new te$4(a*o/l-o/2,0,(c-n)*h/c-h/2),t=new te$4(0,1,0);i.push(e.x,e.y,e.z),s.push(t.x,t.y,t.z),r.push(a/l,1-n/c);}for(n=0;n<c;n++)for(a=0;a<l;a++)t.push(a+1+(n+1)*(l+1)),t.push(a+1+n*(l+1)),t.push(a+n*(l+1)),t.push(a+(n+1)*(l+1)),t.push(a+1+(n+1)*(l+1)),t.push(a+n*(l+1));const u=new is;return u.indices=t,u.positions=i,u.normals=s,u.uvs=r,u}function Sl(e){const t=void 0!==e.xmin&&null!==e.xmin?e.xmin:-1,i=void 0!==e.zmin&&null!==e.zmin?e.zmin:-1,s=void 0!==e.xmax&&null!==e.xmax?e.xmax:1,r=void 0!==e.zmax&&null!==e.zmax?e.zmax:1,n=e.subdivisions||{w:1,h:1},a=e.precision||{w:1,h:1},o=[],h=[],l=[],c=[];let u,d,_,f;n.h=n.h<1?1:n.h,n.w=n.w<1?1:n.w,a.w=a.w<1?1:a.w,a.h=a.h<1?1:a.h;const p=(s-t)/n.w,g=(r-i)/n.h;function m(e,t,i,s){const r=h.length/3,n=a.w+1;for(u=0;u<a.h;u++)for(d=0;d<a.w;d++){const e=[r+d+u*n,r+(d+1)+u*n,r+(d+1)+(u+1)*n,r+d+(u+1)*n];o.push(e[1]),o.push(e[2]),o.push(e[3]),o.push(e[0]),o.push(e[1]),o.push(e[3]);}const _=te$4.Zero(),f=new te$4(0,1,0);for(u=0;u<=a.h;u++)for(_.z=u*(s-t)/a.h+t,d=0;d<=a.w;d++)_.x=d*(i-e)/a.w+e,_.y=0,h.push(_.x,_.y,_.z),l.push(f.x,f.y,f.z),c.push(d/a.w,u/a.h);}for(_=0;_<n.h;_++)for(f=0;f<n.w;f++)m(t+f*p,i+_*g,t+(f+1)*p,i+(_+1)*g);const T=new is;return T.indices=o,T.positions=h,T.normals=l,T.uvs=c,T}function xl(e){const t=[],i=[],s=[],r=[];let n,a;const o=e.colorFilter||new ge$3(.3,.59,.11),h=e.alphaFilter||0;let l=false;if(e.minHeight>e.maxHeight){l=true;const t=e.maxHeight;e.maxHeight=e.minHeight,e.minHeight=t;}for(n=0;n<=e.subdivisions;n++)for(a=0;a<=e.subdivisions;a++){const t=new te$4(a*e.width/e.subdivisions-e.width/2,0,(e.subdivisions-n)*e.height/e.subdivisions-e.height/2),c=4*(((t.x+e.width/2)/e.width*(e.bufferWidth-1)|0)+((1-(t.z+e.height/2)/e.height)*(e.bufferHeight-1)|0)*e.bufferWidth);let u=e.buffer[c]/255,d=e.buffer[c+1]/255,_=e.buffer[c+2]/255;const f=e.buffer[c+3]/255;l&&(u=1-u,d=1-d,_=1-_);const p=u*o.r+d*o.g+_*o.b;t.y=f>=h?e.minHeight+(e.maxHeight-e.minHeight)*p:e.minHeight-x$d,e.heightBuffer&&(e.heightBuffer[n*(e.subdivisions+1)+a]=t.y),i.push(t.x,t.y,t.z),s.push(0,0,0),r.push(a/e.subdivisions,1-n/e.subdivisions);}for(n=0;n<e.subdivisions;n++)for(a=0;a<e.subdivisions;a++){const s=a+1+(n+1)*(e.subdivisions+1),r=a+1+n*(e.subdivisions+1),o=a+n*(e.subdivisions+1),h=a+(n+1)*(e.subdivisions+1),l=i[3*s+1]>=e.minHeight,c=i[3*r+1]>=e.minHeight,u=i[3*o+1]>=e.minHeight;l&&c&&u&&(t.push(s),t.push(r),t.push(o));i[3*h+1]>=e.minHeight&&l&&u&&(t.push(h),t.push(s),t.push(o));}is.ComputeNormals(i,t,s);const c=new is;return c.indices=t,c.positions=i,c.normals=s,c.uvs=r,c}function Ml(e){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],s=[];let r=[];const n=e.width||e.size||1,a=e.height||e.size||1,o=e.depth||e.size||1,h=e.wrap||false;let l=void 0===e.topBaseAt?1:e.topBaseAt,c=void 0===e.bottomBaseAt?0:e.bottomBaseAt;l=(l+4)%4,c=(c+4)%4;let u=[2,0,3,1][l],d=[2,0,1,3][c],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(h){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let e=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],i=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const s=[17,18,19,16],r=[22,23,20,21];for(;u>0;)e.unshift(e.pop()),s.unshift(s.pop()),u--;for(;d>0;)i.unshift(i.pop()),r.unshift(r.pop()),d--;e=e.flat(),i=i.flat(),_=_.concat(e).concat(i),t.push(s[0],s[2],s[3],s[0],s[1],s[2]),t.push(r[0],r[2],r[3],r[0],r[1],r[2]);}const f=[n/2,a/2,o/2];r=_.reduce(((e,t,i)=>e.concat(t*f[i%3])),[]);const p=0===e.sideOrientation?0:e.sideOrientation||is.DEFAULTSIDE,g=e.faceUV||new Array(6),m=e.faceColors,T=[];for(let e=0;e<6;e++) void 0===g[e]&&(g[e]=new ie$5(0,0,1,1)),m&&void 0===m[e]&&(m[e]=new me$3(1,1,1,1));for(let e=0;e<6;e++)if(s.push(g[e].z,g[e].w),s.push(g[e].x,g[e].w),s.push(g[e].x,g[e].y),s.push(g[e].z,g[e].y),m)for(let t=0;t<4;t++)T.push(m[e].r,m[e].g,m[e].b,m[e].a);is._ComputeSides(p,r,t,i,s,e.frontUVs,e.backUVs);const E=new is;if(E.indices=t,E.positions=r,E.normals=i,E.uvs=s,m){const e=p===is.DOUBLESIDE?T.concat(T):T;E.colors=e;}return E}function yl(e,t={},i=null){const s=new Er$1(e,i);t.sideOrientation=Er$1._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation;return Ml(t).applyToMesh(s,t.updatable),s}function Il(e){const t=e.minimum.x,i=e.minimum.y,s=e.minimum.z,r=e.maximum.x,n=e.maximum.y,a=e.maximum.z;return [new te$4(t,i,s),new te$4(r,n,a),new te$4(r,i,s),new te$4(t,n,s),new te$4(t,i,a),new te$4(r,n,s),new te$4(t,n,a),new te$4(r,i,a)]}is.CreateGround=bl,is.CreateTiledGround=Sl,is.CreateGroundFromHeightMap=xl,Er$1.CreateGround=(e,t,i,s,r,n)=>function(e,t={},i){const s=new Rl(e,i);return s._setReady(false),s._subdivisionsX=t.subdivisionsX||t.subdivisions||1,s._subdivisionsY=t.subdivisionsY||t.subdivisions||1,s._width=t.width||1,s._height=t.height||1,s._maxX=s._width/2,s._maxZ=s._height/2,s._minX=-s._maxX,s._minZ=-s._maxZ,bl(t).applyToMesh(s,t.updatable),s._setReady(true),s}(e,{width:t,height:i,subdivisions:s,updatable:n},r),Er$1.CreateTiledGround=(e,t,i,s,r,n,a,o,h)=>function(e,t,i=null){const s=new Er$1(e,i);return Sl(t).applyToMesh(s,t.updatable),s}(e,{xmin:t,zmin:i,xmax:s,zmax:r,subdivisions:n,precision:a,updatable:h},o),Er$1.CreateGroundFromHeightMap=(e,t,i,s,r,n,a,o,h,l,c)=>function(e,t,i={},s=null){const r=i.width||10,n=i.height||10,a=i.subdivisions||1,o=i.minHeight||0,h=i.maxHeight||1,l=i.colorFilter||new ge$3(.3,.59,.11),c=i.alphaFilter||0,u=i.updatable,d=i.onReady;s=s||L$7.LastCreatedScene;const _=new Rl(e,s);let f;_._subdivisionsX=a,_._subdivisionsY=a,_._width=r,_._height=n,_._maxX=_._width/2,_._maxZ=_._height/2,_._minX=-_._maxX,_._minZ=-_._maxZ,_._setReady(false),i.passHeightBufferInCallback&&(f=new Float32Array((a+1)*(a+1)));const p=(e,t,i)=>{xl({width:r,height:n,subdivisions:a,minHeight:o,maxHeight:h,colorFilter:l,buffer:e,bufferWidth:t,bufferHeight:i,alphaFilter:c,heightBuffer:f}).applyToMesh(_,u),d&&d(_,f),_._setReady(true);};if("string"==typeof t){const e=e=>{const t=e.width,i=e.height;if(s.isDisposed)return;const r=s?.getEngine().resizeImageBitmap(e,t,i);p(r,t,i);};Ai.LoadImage(t,e,i.onError?i.onError:()=>{},s.offlineProvider);}else p(t.data,t.width,t.height);return _}(e,t,{width:i,height:s,subdivisions:r,minHeight:n,maxHeight:a,updatable:h,onReady:l,alphaFilter:c},o),is.CreateBox=Ml,Er$1.CreateBox=(e,t,i=null,s,r)=>yl(e,{size:t,sideOrientation:r,updatable:s},i);class Cl{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t;}));}}class vl{constructor(){this._currentOperation=Promise.resolve();}lockAsync(e,t){t?.throwIfAborted();const i=t?()=>(t.throwIfAborted(),e()):e,s=this._currentOperation.then(i);return this._currentOperation=new Promise((e=>{s.then((()=>e()),e);})),s}static async LockAsync(e,t,i){if(i?.throwIfAborted(),0===t.length)return await e();const s=new Cl;let r=0;for(const n of t)n.lockAsync((async()=>(r++,r===t.length&&s.resolve(await e()),await s.promise)),i).catch((e=>s.reject(e)));return await s.promise}}function Pl(...e){const t=e=>!!e&&"object"==typeof e;return e.reduce(((e,i)=>{const s=Object.keys(i);for(const r of s){const s=e[r],n=i[r];Array.isArray(s)&&Array.isArray(n)?e[r]=s.concat(...n):t(s)&&t(n)?e[r]=Pl(s,n):e[r]=n;}return e}),{})}class Ol{constructor(e){this._factory=e;}get value(){return this._factory&&(this._value=this._factory(),this._factory=void 0),this._value}}class Dl{getDescription(){return ""}apply(e,t){return  true}constructor(e=0){this.priority=e;}}class Ll extends Dl{getDescription(){return "Reducing render target texture size to "+this.maximumSize}constructor(e=0,t=1024,i=.5){super(e),this.priority=e,this.maximumSize=t,this.step=i;}apply(e,t){let i=true;for(let t=0;t<e.textures.length;t++){const s=e.textures[t];if(!s.canRescale||s.getContext)continue;const r=s.getSize();Math.max(r.width,r.height)>this.maximumSize&&(s.scale(this.step),i=false);}return i}}class Fl extends Dl{getDescription(){return "Setting hardware scaling level to "+this._currentScale}constructor(e=0,t=2,i=.25){super(e),this.priority=e,this.maximumScale=t,this.step=i,this._currentScale=-1,this._directionOffset=1;}apply(e,t){return  -1===this._currentScale&&(this._currentScale=e.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,this._currentScale=Math.min(this.maximumScale,this._currentScale),e.getEngine().setHardwareScalingLevel(this._currentScale),1===this._directionOffset?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale}}class wl extends Dl{getDescription(){return "Turning shadows on/off"}apply(e,t){return e.shadowsEnabled=t.isInImprovementMode,true}}class Nl extends Dl{getDescription(){return "Turning post-processes on/off"}apply(e,t){return e.postProcessesEnabled=t.isInImprovementMode,true}}class Bl extends Dl{getDescription(){return "Turning lens flares on/off"}apply(e,t){return e.lensFlaresEnabled=t.isInImprovementMode,true}}class Ul extends Dl{getDescription(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"}apply(e,t){return !this.onApply||this.onApply(e,t)}}class kl extends Dl{getDescription(){return "Turning particles on/off"}apply(e,t){return e.particlesEnabled=t.isInImprovementMode,true}}class Gl extends Dl{getDescription(){return "Turning render targets off"}apply(e,t){return e.renderTargetsEnabled=t.isInImprovementMode,true}}class Vl extends Dl{constructor(){super(...arguments),this._canBeMerged=e=>{if(!(e instanceof Er$1))return  false;const t=e;return !t.isDisposed()&&(!(!t.isVisible||!t.isEnabled())&&(!(t.instances.length>0)&&(!t.skeleton&&!t.hasLODLevels&&0!==t.getTotalVertices())))};}static get UpdateSelectionTree(){return Vl._UpdateSelectionTree}static set UpdateSelectionTree(e){Vl._UpdateSelectionTree=e;}getDescription(){return "Merging similar meshes together"}apply(e,t,i){const s=e.meshes.slice(0);let r=s.length;for(let e=0;e<r;e++){const t=[],i=s[e];if(this._canBeMerged(i)){t.push(i);for(let n=e+1;n<r;n++){const e=s[n];this._canBeMerged(e)&&(e.material===i.material&&e.checkCollisions===i.checkCollisions&&(t.push(e),r--,s.splice(n,1),n--));}t.length<2||Er$1.MergeMeshes(t,void 0,true);}}const n=e;return n.createOrUpdateSelectionOctree&&(null!=i?i&&n.createOrUpdateSelectionOctree():Vl.UpdateSelectionTree&&n.createOrUpdateSelectionOctree()),true}}Vl._UpdateSelectionTree=false;class Hl{constructor(e=60,t=2e3){this.targetFrameRate=e,this.trackerDuration=t,this.optimizations=[];}addOptimization(e){return this.optimizations.push(e),this}addCustomOptimization(e,t,i=0){const s=new Ul(i);return s.onApply=e,s.onGetDescription=t,this.optimizations.push(s),this}static LowDegradationAllowed(e){const t=new Hl(e);let i=0;return t.addOptimization(new Vl(i)),t.addOptimization(new wl(i)),t.addOptimization(new Bl(i)),i++,t.addOptimization(new Nl(i)),t.addOptimization(new kl(i)),i++,t.addOptimization(new Ll(i,1024)),t}static ModerateDegradationAllowed(e){const t=new Hl(e);let i=0;return t.addOptimization(new Vl(i)),t.addOptimization(new wl(i)),t.addOptimization(new Bl(i)),i++,t.addOptimization(new Nl(i)),t.addOptimization(new kl(i)),i++,t.addOptimization(new Ll(i,512)),i++,t.addOptimization(new Gl(i)),i++,t.addOptimization(new Fl(i,2)),t}static HighDegradationAllowed(e){const t=new Hl(e);let i=0;return t.addOptimization(new Vl(i)),t.addOptimization(new wl(i)),t.addOptimization(new Bl(i)),i++,t.addOptimization(new Nl(i)),t.addOptimization(new kl(i)),i++,t.addOptimization(new Ll(i,256)),i++,t.addOptimization(new Gl(i)),i++,t.addOptimization(new Fl(i,4)),t}}class zl{get isInImprovementMode(){return this._improvementMode}set isInImprovementMode(e){this._improvementMode=e;}get currentPriorityLevel(){return this._currentPriorityLevel}get currentFrameRate(){return this._currentFrameRate}get targetFrameRate(){return this._targetFrameRate}set targetFrameRate(e){this._targetFrameRate=e;}get trackerDuration(){return this._trackerDuration}set trackerDuration(e){this._trackerDuration=e;}get optimizations(){return this._options.optimizations}constructor(e,t,i=true,s=false){if(this._isRunning=false,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=false,this.onSuccessObservable=new R$g,this.onNewOptimizationAppliedObservable=new R$g,this.onFailureObservable=new R$g,this._options=t||new Hl,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),i){let e=0;for(const t of this._options.optimizations)t.priority=e++;}this._improvementMode=s,this._scene=e||L$7.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add((()=>{this._sceneDisposeObserver=null,this.dispose();}));}stop(){this._isRunning=false;}reset(){this._currentPriorityLevel=0;}start(){this._isRunning||(this._isRunning=true,this._scene.executeWhenReady((()=>{setTimeout((()=>{this._checkCurrentState();}),this._trackerDuration);})));}_checkCurrentState(){if(!this._isRunning)return;const e=this._scene,t=this._options;if(this._currentFrameRate=Math.round(e.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate)return this._isRunning=false,void this.onSuccessObservable.notifyObservers(this);let i=true,s=true;for(let r=0;r<t.optimizations.length;r++){const n=t.optimizations[r];n.priority===this._currentPriorityLevel&&(s=false,i=i&&n.apply(e,this),this.onNewOptimizationAppliedObservable.notifyObservers(n));}if(s)return this._isRunning=false,void this.onFailureObservable.notifyObservers(this);i&&this._currentPriorityLevel++,e.executeWhenReady((()=>{setTimeout((()=>{this._checkCurrentState();}),this._trackerDuration);}));}dispose(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver);}static OptimizeAsync(e,t,i,s){const r=new zl(e,t||Hl.ModerateDegradationAllowed(),false);return i&&r.onSuccessObservable.add((()=>{i();})),s&&r.onFailureObservable.add((()=>{s();})),r.start(),r}}class Xl extends la{constructor(e,t){super(e,t),this.color=new me$3(.2,.2,.3,1),this.clearColor=true,this.convertColorToLinearSpace=false,this.clearDepth=false,this.clearStencil=false,this.stencilValue=0,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle();}record(){if(void 0===this.targetTexture&&void 0===this.depthTexture)throw new Error(`FrameGraphClearTextureTask ${this.name}: targetTexture and depthTexture can't both be undefined.`);const e=void 0!==this.targetTexture?Array.isArray(this.targetTexture)?this.targetTexture:[this.targetTexture]:void 0;let t=0,i=0;if(void 0!==this.targetTexture&&(t=this._frameGraph.textureManager.getTextureDescription(e[0]).options.samples||1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,e[0])),void 0!==this.depthTexture&&(i=this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples||1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture)),t!==i&&0!==t&&0!==i)throw new Error(`FrameGraphClearTextureTask ${this.name}: the depth texture and the target texture must have the same number of samples.`);const s=this._frameGraph.engine.buildTextureLayout(e?Array(e.length).fill(true):[],0===this.targetTexture&&!this._frameGraph.textureManager.backBufferTextureOverriden),r=Te$3.Color4[0],n=this._frameGraph.addRenderPass(this.name);n.setRenderTarget(e),n.setRenderTargetDepth(this.depthTexture),n.setExecuteFunc((e=>{r.copyFrom(this.color),this.convertColorToLinearSpace&&r.toLinearSpaceToRef(r),e.clearAttachments(r,s,!!this.clearColor,!!this.clearDepth,!!this.clearStencil,this.stencilValue);}));const a=this._frameGraph.addRenderPass(this.name+"_disabled",true);return a.setRenderTarget(e),a.setRenderTargetDepth(this.depthTexture),a.setExecuteFunc((e=>{})),n}}class Wl extends sh{constructor(e,t,i){super(e,t,i||new io(e,t.engine,new ee$4(1,0),10));}record(e=false,t,i){const s=super.record(e,t,i);return this.postProcess.textureWidth=this._outputWidth,this.postProcess.textureHeight=this._outputHeight,s}}class Yl{constructor(e,t,i,s){this._isBackBuffer=false,this.name=e,this._textureManager=t,this._renderTargets=void 0===i?void 0:Array.isArray(i)?i:[i],this._renderTargetDepth=s;}get renderTargetWrapper(){if(!this._isBackBuffer){if(!this._renderTargetWrapper){const e=this._textureManager.engine,t=void 0===this._renderTargets||0===this._renderTargets.length?this._renderTargetDepth:this._renderTargets[0];if(this._textureManager.isBackbuffer(t))return void(this._isBackBuffer=true);const i=this._textureManager.getTextureDescription(t),s={textureCount:this._renderTargets?.length??0,generateDepthBuffer:false,label:this.name,samples:i.options.samples??1,dontCreateTextures:true};this._renderTargetWrapper=e.createMultipleRenderTarget(i.size,s,true);for(let e=0;e<s.textureCount;e++){const t=this._renderTargets[e],i=this._textureManager.getTextureFromHandle(t);if(!i)throw new Error(`FrameGraphRenderTarget.renderTargetWrapper: Failed to get texture from handle. handle: ${t}, name: ${this.name}, index: ${e}, renderTargets: ${this._renderTargets}`);this._renderTargetWrapper.setTexture(i,e,false);} void 0!==this._renderTargetDepth&&this._renderTargetWrapper.setDepthStencilTexture(this._textureManager.getTextureFromHandle(this._renderTargetDepth),false);}return this._renderTargetWrapper}}equals(e){const t=this._renderTargets,i=e._renderTargets;if(void 0!==t&&void 0!==i){if(t.length!==i.length)return  false;for(let e=0;e<t.length;e++)if(t[e]!==i[e])return  false}else if(void 0===t&&void 0!==i||void 0!==t&&void 0===i)return  false;return this._renderTargetDepth===e._renderTargetDepth}}!function(e){e[e.Task=0]="Task",e[e.Graph=1]="Graph",e[e.External=2]="External";}(ml||(ml={}));class Kl{constructor(e,t=false,i){this.engine=e,this._debugTextures=t,this._scene=i,this._textures=new Map,this._historyTextures=new Map,this._isRecordingTask=false,this.showDebugLogsForTextureAllcationOptimization=false,this._backBufferTextureEntry=null,this._backBufferDepthStencilTextureEntry=null,this._backBufferTextureOverriden=false,this._addSystemTextures();}isBackbuffer(e){return !this._backBufferTextureOverriden&&this._isBackbuffer(e)}_isBackbuffer(e){if(0===e||1===e)return  true;const t=this._textures.get(e);return !!t&&(0===t.refHandle||1===t.refHandle)}isBackbufferColor(e){if(this._backBufferTextureOverriden)return  false;if(0===e)return  true;const t=this._textures.get(e);return !!t&&0===t.refHandle}isBackbufferDepthStencil(e){if(this._backBufferTextureOverriden)return  false;if(1===e)return  true;const t=this._textures.get(e);return !!t&&1===t.refHandle}isHistoryTexture(e,t=false){const i=this._textures.get(e);return !!i&&(e=i.refHandle??e,t?true===this._textures.get(e)?.historyTexture:this._historyTextures.has(e))}getTextureCreationOptions(e,t=false){e=this._textures.get(e)?.refHandle??e;const i=this._textures.get(e),s=i.creationOptions;return {size:rh(s.size)?{...s.size}:s.size,sizeIsPercentage:s.sizeIsPercentage,options:Kl.CloneTextureOptions(s.options,i.textureIndex),isHistoryTexture:!!t&&s.isHistoryTexture}}getTextureDescription(e){const t=this.getTextureCreationOptions(e);return {size:t.sizeIsPercentage?this.getAbsoluteDimensions(t.size):rh(t.size)?t.size:{width:t.size,height:t.size},options:t.options}}getTextureHandleOrCreateTexture(e,t,i){if(void 0===e){if(void 0===t||void 0===i)throw new Error("getTextureHandleOrCreateTexture: Either handle or newTextureName and creationOptions must be provided.");return this.createRenderTargetTexture(t,i)}return e}getTextureFromHandle(e,t){const i=this._textures.get(e),s=i?.refHandle,r=void 0!==s?this._textures.get(s):i,n=void 0!==s?s:e,a=this._historyTextures.get(n);return a?a.textures[t?a.index:1^a.index]:r.texture}importTexture(e,t,i){ void 0!==i&&this._freeEntry(i);const s={size:{width:t.width,height:t.height},sizeIsPercentage:false,isHistoryTexture:false,options:{createMipMaps:t.generateMipMaps,samples:t.samples,types:[t.type],formats:[t.format],useSRGBBuffers:[t._useSRGBBuffer],creationFlags:[t._creationFlags],labels:t.label?[t.label]:["imported"]}};return this._createHandleForTexture(e,t,s,ml.External,i)}createRenderTargetTexture(e,t,i){return this._createHandleForTexture(e,null,{size:rh(t.size)?{...t.size}:t.size,sizeIsPercentage:t.sizeIsPercentage,isHistoryTexture:t.isHistoryTexture,options:Kl.CloneTextureOptions(t.options,void 0,true)},this._isRecordingTask?ml.Task:ml.Graph,i)}createRenderTarget(e,t,i,s,r){const n=new Yl(e,this,t,i),a=n.renderTargetWrapper;if(void 0!==a&&(a.depthReadOnly=!!s,a.stencilReadOnly=!!r,t)){const e=Array.isArray(t)?t:[t];for(let t=0;t<e.length;t++){let i=e[t];i=this._textures.get(i)?.refHandle??i;const s=this._historyTextures.get(i);s&&(s.references.push({renderTargetWrapper:a,textureIndex:t}),a.setTexture(s.textures[s.index],t,false));}}return n}createDanglingHandle(){return Kl._Counter++}resolveDanglingHandle(e,t,i,s){if(void 0===t){if(void 0===i||void 0===s)throw new Error("resolveDanglingHandle: Either handle or newTextureName and creationOptions must be provided.");return void this.createRenderTargetTexture(i,s,e)}const r=this._textures.get(t);if(void 0===r)throw new Error(`resolveDanglingHandle: Handle ${t} does not exist!`);t=r.refHandle??t,this._textures.set(e,{texture:r.texture,refHandle:t,name:r.name,creationOptions:{size:{...r.creationOptions.size},options:Kl.CloneTextureOptions(r.creationOptions.options),sizeIsPercentage:r.creationOptions.sizeIsPercentage,isHistoryTexture:false},namespace:r.namespace,textureIndex:r.textureIndex});}getAbsoluteDimensions(e,t,i){if(this._backBufferTextureOverriden){const e=this._textures.get(0).creationOptions.size;t??=e.width,i??=e.height;}else t??=this.engine.getRenderWidth(true),i??=this.engine.getRenderHeight(true);const{width:s,height:r}=nh(e);return {width:Math.floor(s*t/100),height:Math.floor(r*i/100)}}getTextureAbsoluteDimensions(e){return "number"==typeof e&&(e=this.getTextureCreationOptions(e)),e.sizeIsPercentage?this.getAbsoluteDimensions(e.size):rh(e.size)?e.size:{width:e.size,height:e.size}}computeTotalTextureSize(e,t,i){let s=0;return this._textures.forEach(((r,n)=>{if(!this._backBufferTextureOverriden&&(0===n||1===n)||void 0!==r.refHandle)return;if(e&&void 0!==r.aliasHandle)return;const a=r.creationOptions,o=r.textureIndex||0,h=a.sizeIsPercentage?this.getAbsoluteDimensions(a.size,t,i):nh(a.size),l=Kl._GetTextureBlockInformation(a.options.types?.[o]??Qe$1.TEXTURETYPE_UNSIGNED_BYTE,a.options.formats[o]),c=Math.ceil(h.width/l.width)*Math.ceil(h.height/l.height)*l.length;let u=c;a.options.createMipMaps&&(u=Math.floor(4*u/3)),(a.options.samples||1)>1&&(u+=c),s+=u;})),s}get backBufferTextureOverriden(){return this._backBufferTextureOverriden}setBackBufferTextures(e,t,i,s){if(!(0!==e&&0!==t||i&&s)){if(this._backBufferTextureOverriden){let e=this._textures.get(0);e.texture?.dispose(),e.texture=null,e.debug?.dispose(),e.debug=void 0,e=this._textures.get(1),e.texture?.dispose(),e.texture=null,e.debug?.dispose(),e.debug=void 0;}return this._backBufferTextureEntry=null,this._backBufferDepthStencilTextureEntry=null,this._backBufferTextureOverriden=false,void this._addSystemTextures()}this._backBufferTextureOverriden=true;const r={width:e,height:t};this._backBufferTextureEntry={name:"backbuffer color",texture:null,creationOptions:i??{size:r,options:{createMipMaps:false,samples:this.engine.getCreationOptions().antialias?4:1,types:[Qe$1.TEXTURETYPE_UNSIGNED_BYTE],formats:[Qe$1.TEXTUREFORMAT_RGBA],useSRGBBuffers:[false],creationFlags:[0],labels:["backbuffer color"]},sizeIsPercentage:false},namespace:ml.Graph,lifespan:{firstTask:Number.MAX_VALUE,lastTask:0}},this._backBufferTextureEntry.textureDescriptionHash=this._createTextureDescriptionHash(this._backBufferTextureEntry.creationOptions),this._backBufferDepthStencilTextureEntry={name:"backbuffer depth/stencil",texture:null,creationOptions:s??{size:r,options:{createMipMaps:false,samples:this.engine.getCreationOptions().antialias?4:1,types:[Qe$1.TEXTURETYPE_UNSIGNED_BYTE],formats:[this.engine.isStencilEnable?Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT],useSRGBBuffers:[false],creationFlags:[0],labels:["backbuffer depth/stencil"]},sizeIsPercentage:false},namespace:ml.Graph,lifespan:{firstTask:Number.MAX_VALUE,lastTask:0}},this._backBufferDepthStencilTextureEntry.textureDescriptionHash=this._createTextureDescriptionHash(this._backBufferDepthStencilTextureEntry.creationOptions),this._addSystemTextures();}resetBackBufferTextures(){this.setBackBufferTextures(0,0);}get hasHistoryTextures(){return this._historyTextures.size>0}_dispose(){this._releaseTextures();}_allocateTextures(e){e&&this._optimizeTextureAllocation(e),this._textures.forEach((e=>{if(!e.texture)if(void 0!==e.refHandle){const t=this._textures.get(e.refHandle);e.texture=t.texture,e.texture?.incrementReferences(),0===t.refHandle&&(e.refHandle=0),1===t.refHandle&&(e.refHandle=1);}else if(e.namespace!==ml.External)if(void 0!==e.aliasHandle){const t=this._textures.get(e.aliasHandle);e.texture=t.texture,e.texture.incrementReferences();}else {const t=e.creationOptions,i=t.sizeIsPercentage?this.getAbsoluteDimensions(t.size):t.size,s=e.textureIndex||0,r={createMipMaps:t.options.createMipMaps,samples:t.options.samples,type:t.options.types?.[s],format:t.options.formats?.[s],useSRGBBuffer:t.options.useSRGBBuffers?.[s],creationFlags:t.options.creationFlags?.[s],label:t.options.labels?.[s]??`${e.name}${s>0?"#"+s:""}`,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,createMSAATexture:t.options.samples>1},n=ya(r.format),a=Ca(r.format),o=n&&a?12:n||a?14:5,h=this.engine._createInternalTexture(i,r,false,o);n&&(h.type=Ia(h.format)),e.texture=h;}e.texture&&void 0===e.refHandle&&(e.debug?.dispose(),e.debug=this._createDebugTexture(e.name,e.texture));})),this._historyTextures.forEach((e=>{for(let t=0;t<e.handles.length;t++)e.textures[t]=this._textures.get(e.handles[t]).texture;}));}_releaseTextures(e=true){this._textures.forEach(((t,i)=>{t.lifespan&&(t.lifespan.firstTask=Number.MAX_VALUE,t.lifespan.lastTask=0),t.aliasHandle=void 0,(e||t.namespace!==ml.External)&&(t.debug?.dispose(),t.debug=void 0),t.namespace!==ml.External&&(t.texture?.dispose(),t.texture=null,(e||t.namespace===ml.Task)&&(this._textures.delete(i),this._historyTextures.delete(i)));})),this._historyTextures.forEach((e=>{for(let t=0;t<e.handles.length;t++)e.textures[t]=null;})),e&&(this._textures.clear(),this._historyTextures.clear(),this._addSystemTextures());}_updateHistoryTextures(){this._historyTextures.forEach((e=>{e.index=1^e.index;const t=e.textures[e.index];if(t)for(const{renderTargetWrapper:i,textureIndex:s}of e.references)i.setTexture(t,s,false);}));}_addSystemTextures(){const e={width:this.engine.getRenderWidth(true),height:this.engine.getRenderHeight(true)};this._textures.set(0,this._backBufferTextureEntry??{name:"backbuffer color",texture:null,creationOptions:{size:e,options:{createMipMaps:false,samples:this.engine.getCreationOptions().antialias?4:1,types:[Qe$1.TEXTURETYPE_UNSIGNED_BYTE],formats:[Qe$1.TEXTUREFORMAT_RGBA],useSRGBBuffers:[false],creationFlags:[0],labels:["backbuffer color"]},sizeIsPercentage:false},namespace:ml.External}),this._textures.set(1,this._backBufferDepthStencilTextureEntry??{name:"backbuffer depth/stencil",texture:null,creationOptions:{size:e,options:{createMipMaps:false,samples:this.engine.getCreationOptions().antialias?4:1,types:[Qe$1.TEXTURETYPE_UNSIGNED_BYTE],formats:[Qe$1.TEXTUREFORMAT_DEPTH24],useSRGBBuffers:[false],creationFlags:[0],labels:["backbuffer depth/stencil"]},sizeIsPercentage:false},namespace:ml.External});}_createDebugTexture(e,t){if(!this._debugTextures)return;const i=new Is(null,this._scene);return i.name=e,i._texture=t,i._texture.incrementReferences(),i}_freeEntry(e){const t=this._textures.get(e);t&&(t.debug?.dispose(),this._textures.delete(e));}_createHandleForTexture(e,t,i,s,r,n){r=r??Kl._Counter++,n=n||0;const a=i.isHistoryTexture?`${e} ping`:e;let o=i.options.labels?.[n]??"";o===a&&(o="");const h={texture:t,name:`${a}${o?" "+o:""}`,creationOptions:{size:rh(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage,isHistoryTexture:i.isHistoryTexture},namespace:s,textureIndex:n,textureDescriptionHash:this._createTextureDescriptionHash(i),lifespan:{firstTask:Number.MAX_VALUE,lastTask:0},historyTexture:i.isHistoryTexture};if(this._textures.set(r,h),s===ml.External)return r;if(i.isHistoryTexture){const t={size:{...h.creationOptions.size},options:{...h.creationOptions.options},sizeIsPercentage:h.creationOptions.sizeIsPercentage,isHistoryTexture:false},i=this._createHandleForTexture(`${e} pong`,null,t,s);return this._textures.get(i).historyTexture=true,this._historyTextures.set(r,{textures:[null,null],handles:[r,i],index:0,references:[]}),r}if(i.options.types&&i.options.types.length>1&&0===n){const e=i.options.types.length,t={size:rh(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage};for(let i=1;i<e;i++)this._createHandleForTexture(a,null,t,s,r+i,i);Kl._Counter+=e-1;}return r}_createTextureDescriptionHash(e){const t=[];return t.push(rh(e.size)?`${e.size.width}_${e.size.height}`:`${e.size}`),t.push(e.sizeIsPercentage?"%":"A"),t.push(e.options.createMipMaps?"M":"N"),t.push(e.options.samples?`${e.options.samples}`:"S1"),t.push(e.options.types?e.options.types.join("_"):`${Qe$1.TEXTURETYPE_UNSIGNED_BYTE}`),t.push(e.options.formats?e.options.formats.join("_"):`${Qe$1.TEXTUREFORMAT_RGBA}`),t.push(e.options.useSRGBBuffers?e.options.useSRGBBuffers.join("_"):"false"),t.push(e.options.creationFlags?e.options.creationFlags.join("_"):"0"),t.join("_")}_optimizeTextureAllocation(e){this._computeTextureLifespan(e),this.showDebugLogsForTextureAllcationOptimization&&Ie$2.Log("================== Optimization of texture allocation ==================");const t=new Map,i=this._textures.keys();for(let e=i.next();true!==e.done;e=i.next()){const i=e.value,s=this._textures.get(i);if(void 0!==s.refHandle||s.namespace===ml.External||this.isHistoryTexture(i,true))continue;const r=s.textureDescriptionHash,n=s.lifespan,a=t.get(r);if(a){let e=false;for(const t of a){const[r,a]=t;let o=false;for(const e of a)if(e.firstTask<=n.lastTask&&e.lastTask>=n.firstTask){o=true;break}if(!o){this.showDebugLogsForTextureAllcationOptimization&&Ie$2.Log(`Texture ${i} (${s.name}) reuses cache entry ${r}`),a.push(n),s.aliasHandle=r,e=true;break}}e||a.push([i,[n]]);}else t.set(r,[[i,[n]]]);}}_computeTextureLifespan(e){this.showDebugLogsForTextureAllcationOptimization&&Ie$2.Log("================== Dump of texture dependencies for all tasks/passes ==================");for(let t=0;t<e.length;++t){const i=e[t];i.passes.length>0&&this._computeTextureLifespanForPasses(i,t,i.passes),i.passesDisabled.length>0&&this._computeTextureLifespanForPasses(i,t,i.passesDisabled),i.dependencies&&(this.showDebugLogsForTextureAllcationOptimization&&Ie$2.Log(`task#${t} (${i.name}), global dependencies`),this._updateLifespan(100*t+99,i.dependencies));}if(this.showDebugLogsForTextureAllcationOptimization){Ie$2.Log("================== Texture lifespans ==================");const e=this._textures.keys();for(let t=e.next();true!==t.done;t=e.next()){const e=t.value,i=this._textures.get(e);void 0!==i.refHandle||i.namespace===ml.External||this._historyTextures.has(e)||Ie$2.Log(`${e} (${i.name}): ${i.lifespan.firstTask} - ${i.lifespan.lastTask}`);}}}_computeTextureLifespanForPasses(e,t,i){for(let s=0;s<i.length;++s){const r=new Set,n=i[s];ha.IsRenderPass(n)&&(n.collectDependencies(r),this.showDebugLogsForTextureAllcationOptimization&&Ie$2.Log(`task#${t} (${e.name}), pass#${s} (${n.name})`),this._updateLifespan(100*t+s,r));}}_updateLifespan(e,t){const i=t.keys();for(let t=i.next();true!==t.done;t=i.next()){const i=t.value;if(this.isBackbuffer(i))continue;let s=this._textures.get(i);if(!s)throw new Error(`FrameGraph._computeTextureLifespan: Texture handle "${i}" not found in the texture manager.`);let r=i;for(;void 0!==s.refHandle;)if(r=s.refHandle,s=this._textures.get(r),!s)throw new Error(`FrameGraph._computeTextureLifespan: Texture handle "${r}" not found in the texture manager (source handle="${i}").`);s.namespace===ml.External||this._historyTextures.has(r)||(this.showDebugLogsForTextureAllcationOptimization&&Ie$2.Log(`    ${r} (${s.name})`),s.lifespan.firstTask=Math.min(s.lifespan.firstTask,e),s.lifespan.lastTask=Math.max(s.lifespan.lastTask,e));}}static CloneTextureOptions(e,t,i){return void 0!==t?{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[e.types[t]]:void 0,formats:e.formats?[e.formats[t]]:void 0,useSRGBBuffers:e.useSRGBBuffers?[e.useSRGBBuffers[t]]:void 0,creationFlags:e.creationFlags?[e.creationFlags[t]]:void 0,labels:e.labels?[e.labels[t]]:void 0}:{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[...e.types]:void 0,formats:e.formats?[...e.formats]:void 0,useSRGBBuffers:e.useSRGBBuffers?[...e.useSRGBBuffers]:void 0,creationFlags:e.creationFlags?[...e.creationFlags]:void 0,labels:e.labels&&i?[...e.labels]:void 0}}static _GetTextureBlockInformation(e,t){switch(t){case Qe$1.TEXTUREFORMAT_DEPTH16:return {width:1,height:1,length:2};case Qe$1.TEXTUREFORMAT_DEPTH24:return {width:1,height:1,length:3};case Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:case Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT:return {width:1,height:1,length:4};case Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8:return {width:1,height:1,length:5};case Qe$1.TEXTUREFORMAT_STENCIL8:return {width:1,height:1,length:1};case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM:case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT:case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT:case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5:case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3:return {width:4,height:4,length:16};case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1:case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1:return {width:4,height:4,length:8};case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4:return {width:4,height:4,length:16};case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL:case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2:return {width:4,height:4,length:8};case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC:return {width:4,height:4,length:16}}switch(e){case Qe$1.TEXTURETYPE_BYTE:case Qe$1.TEXTURETYPE_UNSIGNED_BYTE:switch(t){case Qe$1.TEXTUREFORMAT_R:case Qe$1.TEXTUREFORMAT_R_INTEGER:case Qe$1.TEXTUREFORMAT_ALPHA:case Qe$1.TEXTUREFORMAT_LUMINANCE:case Qe$1.TEXTUREFORMAT_LUMINANCE_ALPHA:return {width:1,height:1,length:1};case Qe$1.TEXTUREFORMAT_RG:case Qe$1.TEXTUREFORMAT_RG_INTEGER:return {width:1,height:1,length:2};case Qe$1.TEXTUREFORMAT_RGB:case Qe$1.TEXTUREFORMAT_RGB_INTEGER:return {width:1,height:1,length:3};case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return {width:1,height:1,length:4}}case Qe$1.TEXTURETYPE_SHORT:case Qe$1.TEXTURETYPE_UNSIGNED_SHORT:switch(t){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return {width:1,height:1,length:2};case Qe$1.TEXTUREFORMAT_RG_INTEGER:return {width:1,height:1,length:4};case Qe$1.TEXTUREFORMAT_RGB_INTEGER:return {width:1,height:1,length:6};case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return {width:1,height:1,length:8}}case Qe$1.TEXTURETYPE_INT:case Qe$1.TEXTURETYPE_UNSIGNED_INTEGER:switch(t){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return {width:1,height:1,length:4};case Qe$1.TEXTUREFORMAT_RG_INTEGER:return {width:1,height:1,length:8};case Qe$1.TEXTUREFORMAT_RGB_INTEGER:return {width:1,height:1,length:12};case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return {width:1,height:1,length:16}}case Qe$1.TEXTURETYPE_FLOAT:switch(t){case Qe$1.TEXTUREFORMAT_RED:return {width:1,height:1,length:4};case Qe$1.TEXTUREFORMAT_RG:return {width:1,height:1,length:8};case Qe$1.TEXTUREFORMAT_RGB:return {width:1,height:1,length:12};case Qe$1.TEXTUREFORMAT_RGBA:default:return {width:1,height:1,length:16}}case Qe$1.TEXTURETYPE_HALF_FLOAT:switch(t){case Qe$1.TEXTUREFORMAT_RED:return {width:1,height:1,length:2};case Qe$1.TEXTUREFORMAT_RG:return {width:1,height:1,length:4};case Qe$1.TEXTUREFORMAT_RGB:return {width:1,height:1,length:6};case Qe$1.TEXTUREFORMAT_RGBA:default:return {width:1,height:1,length:8}}case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:return {width:1,height:1,length:2};case Qe$1.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:case Qe$1.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:return {width:1,height:1,length:4};case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:return {width:1,height:1,length:2};case Qe$1.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:return {width:1,height:1,length:4}}return {width:1,height:1,length:4}}}Kl._Counter=2;class jl extends Ea{constructor(e,t=null,i,s,r){super({...r,name:e,engine:t||eo.LastCreatedEngine,useShaderStore:true,useAsPostProcess:true,fragmentShader:jl.FragmentUrl,uniforms:jl.Uniforms}),this.direction=i,this.kernel=s,this.textureWidth=0,this.textureHeight=0;}_gatherImports(e,t){e?(this._webGPUReady=true,t.push(Promise.resolve().then(function(){return glowBlurPostProcess_fragmentCe2UszEv_esm_min}))):t.push(Promise.resolve().then(function(){return glowBlurPostProcess_fragmentBoX4p9sr_esm_min})),super._gatherImports(e,t);}bind(){super.bind(),this._drawWrapper.effect.setFloat2("screenSize",this.textureWidth,this.textureHeight),this._drawWrapper.effect.setVector2("direction",this.direction),this._drawWrapper.effect.setFloat("blurWidth",this.kernel);}}jl.FragmentUrl="glowBlurPostProcess",jl.Uniforms=["screenSize","direction","blurWidth"];class Ql extends la{constructor(e,t){super(e,t);}record(){if(!this.func)throw new Error("FrameGraphExecuteTask: Execute task must have a function.");const e=this._frameGraph.addPass(this.name);e.setExecuteFunc((e=>{this.func(e);}));return this._frameGraph.addPass(this.name+"_disabled",true).setExecuteFunc((e=>{this.funcDisabled?.(e);})),e}}class ql extends sh{constructor(e,t,i){super(e,t,i||new jl(e,t.engine,new ee$4(1,0),1));}record(e=false,t,i){const s=super.record(e,t,i);return this.postProcess.textureWidth=this._outputWidth,this.postProcess.textureHeight=this._outputHeight,s}}class Zl extends la{get name(){return this._name}set name(e){if(this._name=e,this._blurX)for(let t=0;t<this._blurX.length;t++)this._blurX[t].name=`${e} Blur X${t}`,this._blurY[t].name=`${e} Blur Y${t}`;this._clearLayerTextures&&(this._clearLayerTextures.name=e+" Clear Layer"),this._objectRendererForLayer&&(this._objectRendererForLayer.name=e+" Render to Layer");}get objectRendererForLayer(){return this._objectRendererForLayer}constructor(e,t,i,s,r,n=false,a=false,o=false){super(e,t),this._setRenderTargetDepth=a,this._notifyBlurObservable=o,this._blurX=[],this._blurY=[],this._onBeforeBlurTask=null,this._onAfterBlurTask=null,this._onBeforeObservableObserver=null,this._onAfterObservableObserver=null,this._onAfterRenderingGroupObserver=null,this._scene=i,this._engine=i.getEngine(),this.layer=s;for(let t=0;t<r;t++)n?(this._blurX.push(new ql(`${e} Blur X${t}`,this._frameGraph,this.layer._postProcesses[1+2*t+0])),this._blurY.push(new ql(`${e} Blur Y${t}`,this._frameGraph,this.layer._postProcesses[1+2*t+1]))):(this._blurX.push(new Wl(`${e} Blur X${t}`,this._frameGraph,this.layer._postProcesses[2*t+0])),this._blurY.push(new Wl(`${e} Blur Y${t}`,this._frameGraph,this.layer._postProcesses[2*t+1])));this._clearLayerTextures=new Xl(e+" Clear Layer",t),this._clearLayerTextures.clearColor=true,this._clearLayerTextures.clearDepth=true,this._objectRendererForLayer=new oh(e+" Render to Layer",t,i,void 0,this.layer.objectRenderer),this._notifyBlurObservable&&(this._onBeforeBlurTask=new Ql(e+" On Before Blur",t),this._onAfterBlurTask=new Ql(e+" On After Blur",t),this._onBeforeBlurTask.func=()=>{this.layer.onBeforeBlurObservable.hasObservers()&&this.layer.onBeforeBlurObservable.notifyObservers(this.layer);},this._onAfterBlurTask.func=()=>{this.layer.onAfterBlurObservable.hasObservers()&&this.layer.onAfterBlurObservable.notifyObservers(this.layer);}),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle();}isReady(){return this._objectRendererForLayer.isReady()&&this.layer.isLayerReady()}record(){if(void 0===this.targetTexture||void 0===this.objectRendererTask)throw new Error(`${this.constructor.name} "${this.name}": targetTexture and objectRendererTask are required`);let e,t,i;if(this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture),this.layerTexture)i=this.layerTexture,t=this._frameGraph.textureManager.getTextureCreationOptions(this.layerTexture),e=nh(t.size),t.size=e;else {const s=this._frameGraph.textureManager.getTextureCreationOptions(this.targetTexture),r=this.layer._options.mainTextureFixedSize?Math.max(2,this.layer._options.mainTextureFixedSize):0;e=nh(s.size),e.width=r||Math.floor(e.width*(this.layer._options.mainTextureRatio||.1))||1,e.height=r||Math.floor(e.height*(this.layer._options.mainTextureRatio||.1))||1,t={size:e,options:{createMipMaps:false,types:[this.layer._options.mainTextureType],formats:[Qe$1.TEXTUREFORMAT_RGBA],samples:1,useSRGBBuffers:[false],creationFlags:[0]},sizeIsPercentage:!this.layer._options.mainTextureFixedSize&&s.sizeIsPercentage},i=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} Color`,t);}const s={size:e,options:Kl.CloneTextureOptions(t.options),sizeIsPercentage:t.sizeIsPercentage};s.options.formats[0]=Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT;const r=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} Depth`,s);this._clearLayerTextures.targetTexture=i,this._clearLayerTextures.depthTexture=r,this._clearLayerTextures.color=this.layer.neutralColor,this._clearLayerTextures.clearDepth=true;const n=this._clearLayerTextures.record();this._objectRendererForLayer.targetTexture=this._clearLayerTextures.outputTexture,this._objectRendererForLayer.depthTexture=this._clearLayerTextures.outputDepthTexture,this._objectRendererForLayer.camera=this.objectRendererTask.camera,this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,this._objectRendererForLayer.disableShadows=true;const a=this._objectRendererForLayer.record();let o=0;o=this._engine.getCaps().textureHalfFloatRender?Qe$1.TEXTURETYPE_HALF_FLOAT:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,t.options.types[0]=o;const h=void 0!==this.layer._options.blurTextureSizeRatio?this.layer._options.blurTextureSizeRatio||.1:void 0;void 0!==h&&(e.width=Math.floor(e.width*h)||1,e.height=Math.floor(e.height*h)||1);const l=this._onBeforeBlurTask?.record(),c=[];for(let i=0;i<this._blurX.length;i++){const s=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX[i].name,t);this._blurX[i].sourceTexture=0===i?this._objectRendererForLayer.outputTexture:this._blurY[i-1].outputTexture,this._blurX[i].sourceSamplingMode=Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,this._blurX[i].targetTexture=s,c.push(this._blurX[i].record(true));const r=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY[i].name,t);this._blurY[i].sourceTexture=this._blurX[i].outputTexture,this._blurY[i].sourceSamplingMode=Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,this._blurY[i].targetTexture=r,c.push(this._blurY[i].record(true)),e.width=e.width>>1,e.height=e.height>>1;}const u=this._onAfterBlurTask?.record();this.objectRendererTask.objectRenderer.onBeforeRenderObservable.remove(this._onBeforeObservableObserver),this._onBeforeObservableObserver=this.objectRendererTask.objectRenderer.onBeforeRenderObservable.add((()=>{const e=this.layer.shouldRender();n.disabled=!e,a.disabled=!e,l&&(l.disabled=!e);for(let t=0;t<c.length;t++)c[t].disabled=!e;u&&(u.disabled=!e),e&&this.layer.needStencil()&&(this._engine.setStencilBuffer(true),this._engine.setStencilFunctionReference(1));})),this.objectRendererTask.objectRenderer.onAfterRenderObservable.remove(this._onAfterObservableObserver),this._onAfterObservableObserver=this.objectRendererTask.objectRenderer.onAfterRenderObservable.add((()=>{this.layer.shouldRender()&&this.layer.needStencil()&&this._engine.setStencilBuffer(false);})),this.layer.bindTexturesForCompose=void 0,this._clearAfterRenderingGroupObserver();const d=this._frameGraph.addRenderPass(this.name);for(let e=0;e<this._blurY.length;e++)d.addDependencies(this._blurY[e].outputTexture);d.setRenderTarget(this.outputTexture),this._setRenderTargetDepth&&d.setRenderTargetDepth(this.objectRendererTask.depthTexture),d.setExecuteFunc((e=>{e.setTextureSamplingMode(this._blurY[this._blurY.length-1].targetTexture,Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE),this.layer.bindTexturesForCompose||(this.layer.bindTexturesForCompose=t=>{for(let i=0;i<this._blurY.length;i++)e.bindTextureHandle(t,`textureSampler${i>0?i+1:""}`,this._blurY[i].outputTexture);}),-1!==this.layer._options.renderingGroupId?this._onAfterRenderingGroupObserver||(this._onAfterRenderingGroupObserver=this._scene.onAfterRenderingGroupObservable.add((t=>{this.layer.shouldRender()&&t.renderingGroupId===this.layer._options.renderingGroupId&&t.renderingManager===this.objectRendererTask.objectRenderer.renderingManager&&(this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,e.saveDepthStates(),e.setDepthStates(false,false),e._applyRenderTarget(),this.layer.compose(),e.restoreDepthStates());}))):(this._clearAfterRenderingGroupObserver(),this.layer.shouldRender()&&(this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,e.setDepthStates(false,false),e._applyRenderTarget(),this.layer.compose()));}));const _=this._frameGraph.addRenderPass(this.name+"_disabled",true);_.setRenderTarget(this.outputTexture),this._setRenderTargetDepth&&_.setRenderTargetDepth(this.objectRendererTask.depthTexture),_.setExecuteFunc((e=>{}));}_clearAfterRenderingGroupObserver(){this._scene.onAfterRenderingGroupObservable.remove(this._onAfterRenderingGroupObserver),this._onAfterRenderingGroupObserver=null;}dispose(){this._clearAfterRenderingGroupObserver(),this._clearLayerTextures.dispose(),this._objectRendererForLayer.dispose(),this._onBeforeBlurTask?.dispose(),this._onAfterBlurTask?.dispose(),this.layer.dispose();for(let e=0;e<this._blurX.length;e++)this._blurX[e].dispose(),this._blurY[e].dispose();super.dispose();}}const Jl=[new me$3(0,0,0,0),new me$3(1,1,1,1),new me$3(0,0,0,0)];class $l extends la{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera;}get reverseCulling(){return this._reverseCulling}set reverseCulling(e){this._reverseCulling=e;const t=ll.GetConfiguration(this._renderer.renderPassId);t&&(t.reverseCulling=e);}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e);}get forceLayerMaskCheck(){return this._forceLayerMaskCheck}set forceLayerMaskCheck(e){e!==this._forceLayerMaskCheck&&(this._forceLayerMaskCheck=e,this._renderer.forceLayerMaskCheck=e);}constructor(e,t,i,s){super(e,t),this.depthTest=true,this.depthWrite=true,this.size={width:100,height:100},this.sizeIsPercentage=true,this.samples=1,this._reverseCulling=false,this.dontRenderWhenMaterialDepthWriteIsDisabled=true,this.textureDescriptions=[],this._forceLayerMaskCheck=true,this._scene=i,this._engine=this._scene.getEngine(),this._renderer=new ca(e,i,s),this._renderer.renderSprites=false,this._renderer.renderParticles=false,this._renderer.enableBoundingBoxRendering=false,this._renderer.enableOutlineRendering=false,this._renderer.disableDepthPrePass=true,this._renderer.customIsReadyFunction=(e,t,i)=>this.dontRenderWhenMaterialDepthWriteIsDisabled&&e.material&&e.material.disableDepthWrite?!!i:e.isReady(0===t),this._renderer.onBeforeRenderingManagerRenderObservable.add((()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(true);})),this.name=e,this._clearAttachmentsLayout=new Map,this._allAttachmentsLayout=[],this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryNormViewDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryScreenDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLocalPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryAlbedoTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryReflectivityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryVelocityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLinearVelocityTexture=this._frameGraph.textureManager.createDanglingHandle();}get excludedSkinnedMeshFromVelocityTexture(){return ll.GetConfiguration(this._renderer.renderPassId).excludedSkinnedMesh}excludeSkinnedMeshFromVelocityTexture(e){if(e.skeleton){const t=this.excludedSkinnedMeshFromVelocityTexture;-1===t.indexOf(e)&&t.push(e);}}removeExcludedSkinnedMeshFromVelocityTexture(e){const t=this.excludedSkinnedMeshFromVelocityTexture,i=t.indexOf(e);-1!==i&&t.splice(i,1);}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(){if(void 0===this.objectList)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: object list must be provided`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;const e=this._createMultiRenderTargetTexture(),t=this._checkDepthTextureCompatibility();this._buildClearAttachmentsLayout(),this._registerForRenderPassId(this._renderer.renderPassId);const i=e.length>0?this._frameGraph.textureManager.getTextureDescription(e[0]):null;this._textureWidth=i?.size.width??0,this._textureHeight=i?.size.height??0,ll.MarkAsDirty(this._renderer.renderPassId,this.objectList.meshes||this._scene.meshes);const s=this._frameGraph.addRenderPass(this.name);s.setRenderTarget(e);let r=false;for(let t=0;t<this.textureDescriptions.length;t++){const i=this.textureDescriptions[t],s=e[t],n=ll.GeometryTextureDescriptions.findIndex((e=>e.type===i.type));switch(ll.GeometryTextureDescriptions[n].type){case Qe$1.PREPASS_DEPTH_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewDepthTexture,s);break;case Qe$1.PREPASS_NORMALIZED_VIEW_DEPTH_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryNormViewDepthTexture,s);break;case Qe$1.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryScreenDepthTexture,s);break;case Qe$1.PREPASS_NORMAL_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewNormalTexture,s);break;case Qe$1.PREPASS_WORLD_NORMAL_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldNormalTexture,s);break;case Qe$1.PREPASS_LOCAL_POSITION_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLocalPositionTexture,s);break;case Qe$1.PREPASS_POSITION_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldPositionTexture,s);break;case Qe$1.PREPASS_ALBEDO_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryAlbedoTexture,s);break;case Qe$1.PREPASS_REFLECTIVITY_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryReflectivityTexture,s);break;case Qe$1.PREPASS_VELOCITY_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryVelocityTexture,s),r=true;break;case Qe$1.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLinearVelocityTexture,s),r=true;}}this._scene.needsPreviousWorldMatrices=r,s.setRenderTargetDepth(this.depthTexture),s.setExecuteFunc((e=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,e.setDepthStates(this.depthTest&&t,this.depthWrite&&t),this._clearAttachmentsLayout.forEach(((t,i)=>{e.clearColorAttachments(Jl[i],t);})),e.bindAttachments(this._allAttachmentsLayout),e.render(this._renderer,this._textureWidth,this._textureHeight);}));const n=this._frameGraph.addRenderPass(this.name+"_disabled",true);n.setRenderTarget(e),n.setRenderTargetDepth(this.depthTexture),n.setExecuteFunc((e=>{}));}dispose(){ll.DeleteConfiguration(this._renderer.renderPassId),this._renderer.dispose(),super.dispose();}_createMultiRenderTargetTexture(){const e=[],t=[],i=[],s=[];for(let r=0;r<this.textureDescriptions.length;r++){const n=this.textureDescriptions[r],a=ll.GeometryTextureDescriptions.findIndex((e=>e.type===n.type));if(-1===a)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: unknown texture type ${n.type}`);e[r]=n.textureType,t[r]=n.textureFormat,i[r]=ll.GeometryTextureDescriptions[a].name,s[r]=false;}const r=this._frameGraph.textureManager.createRenderTargetTexture(this.name,{size:this.size,sizeIsPercentage:this.sizeIsPercentage,options:{createMipMaps:false,samples:this.samples,types:e,formats:t,useSRGBBuffers:s,labels:i}}),n=[];for(let e=0;e<this.textureDescriptions.length;e++)n.push(r+e);return n}_checkDepthTextureCompatibility(){let e=false;if(void 0!==this.depthTexture){if(1===this.depthTexture)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth/stencil back buffer is not allowed as a depth texture`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==this.samples&&this.textureDescriptions.length>0)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),e=true;}return e}_buildClearAttachmentsLayout(){const e=new Map,t=[];for(let i=0;i<this.textureDescriptions.length;i++){const s=this.textureDescriptions[i],r=ll.GeometryTextureDescriptions.findIndex((e=>e.type===s.type)),n=ll.GeometryTextureDescriptions[r];let a=e.get(n.clearType);if(void 0===a){a=[],e.set(n.clearType,a);for(let e=0;e<i;e++)a[e]=false;}e.forEach(((e,t)=>{e.push(t===n.clearType);})),t.push(true);}this._clearAttachmentsLayout=new Map,e.forEach(((e,t)=>{this._clearAttachmentsLayout.set(t,this._engine.buildTextureLayout(e));})),this._allAttachmentsLayout=this._engine.buildTextureLayout(t);}_registerForRenderPassId(e){const t=ll.CreateConfiguration(e);for(let e=0;e<this.textureDescriptions.length;e++){const i=this.textureDescriptions[e],s=ll.GeometryTextureDescriptions.findIndex((e=>e.type===i.type)),r=ll.GeometryTextureDescriptions[s];t.defines[r.defineIndex]=e;}t.reverseCulling=this.reverseCulling;}}class ec{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return t=this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e;}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new pn("shared gizmo light",new te$4(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=ge$3.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return null==ec._DefaultUtilityLayer?ec._CreateDefaultUtilityLayerFromScene(L$7.LastCreatedScene):ec._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return ec._DefaultUtilityLayer=new ec(e),ec._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{ec._DefaultUtilityLayer=null;})),ec._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return null==ec._DefaultKeepDepthUtilityLayer&&(ec._DefaultKeepDepthUtilityLayer=new ec(L$7.LastCreatedScene),ec._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=false,ec._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{ec._DefaultKeepDepthUtilityLayer=null;}))),ec._DefaultKeepDepthUtilityLayer}constructor(e,t=true,i=false){this.originalScene=e,this.handleEvents=t,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=true,this.shouldRender=true,this.onlyCheckPointerDownEvents=true,this.processAllEvents=false,this.pickingEnabled=true,this.onPointerOutObservable=new R$g,this.utilityLayerScene=new ch(e.getEngine(),{virtual:true,useFloatingOrigin:e.floatingOriginMode}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=false,this.utilityLayerScene.postProcessesEnabled=false,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add((t=>{if(!this.utilityLayerScene.activeCamera)return;if(!this.pickingEnabled)return;if(!this.processAllEvents&&t.type!==Ar$1.POINTERMOVE&&t.type!==Ar$1.POINTERUP&&t.type!==Ar$1.POINTERDOWN&&t.type!==Ar$1.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const i=t.event;if(e.isPointerCaptured(i.pointerId))return void(this._pointerCaptures[i.pointerId]=false);const s=i=>{let s=null;if(t.nearInteractionPickingInfo)s=t.nearInteractionPickingInfo.pickedMesh.getScene()==i?t.nearInteractionPickingInfo:new ls;else if(i!==this.utilityLayerScene&&t.originalPickingInfo)s=t.originalPickingInfo;else {let r=null;this._renderCamera&&(r=i._activeCamera,i._activeCamera=this._renderCamera,t.ray=null),s=t.ray?i.pickWithRay(t.ray):i.pick(e.pointerX,e.pointerY),r&&(i._activeCamera=r);}return s},r=s(this.utilityLayerScene);if(!t.ray&&r&&(t.ray=r.ray),t.originalPickingInfo?.aimTransform&&r&&(r.aimTransform=t.originalPickingInfo.aimTransform,r.gripTransform=t.originalPickingInfo.gripTransform),this.utilityLayerScene.onPrePointerObservable.notifyObservers(t),this.onlyCheckPointerDownEvents&&t.type!=Ar$1.POINTERDOWN)return t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Sr$1(t.type,t.event,r),t.type),void(t.type===Ar$1.POINTERUP&&this._pointerCaptures[i.pointerId]&&(this._pointerCaptures[i.pointerId]=false));if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)r&&r.hit&&(t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Sr$1(t.type,t.event,r),t.type),t.skipOnPointerObservable=true);else {const i=s(e),n=t.event;i&&r&&(0===r.distance&&i.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,n),t.skipOnPointerObservable=true):t.type===Ar$1.POINTERDOWN?(this._pointerCaptures[n.pointerId]=true,this._notifyObservers(t,i,n)):t.type!==Ar$1.POINTERMOVE&&t.type!==Ar$1.POINTERUP||(this._lastPointerEvents[n.pointerId]&&(this.onPointerOutObservable.notifyObservers(n.pointerId),delete this._lastPointerEvents[n.pointerId]),this._notifyObservers(t,i,n)):!this._pointerCaptures[n.pointerId]&&(r.distance<i.distance||0===i.distance)?(this._notifyObservers(t,r,n),t.skipOnPointerObservable||(t.skipOnPointerObservable=r.distance>0)):!this._pointerCaptures[n.pointerId]&&r.distance>=i.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,n),t.skipOnPointerObservable=true):(t.type!==Ar$1.POINTERMOVE&&t.type!==Ar$1.POINTERUP||this._lastPointerEvents[n.pointerId]&&(this.onPointerOutObservable.notifyObservers(n.pointerId),delete this._lastPointerEvents[n.pointerId]),this._notifyObservers(t,r,n))),t.type===Ar$1.POINTERUP&&this._pointerCaptures[n.pointerId]&&(this._pointerCaptures[n.pointerId]=false));}})),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=false,i||(this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add((e=>{this.shouldRender&&e==this.getRenderCamera()&&this.render();}))),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add((()=>{this.dispose();})),this._updateCamera();}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new Sr$1(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=true);}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(false),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e);}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose();}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera();}}ec._DefaultUtilityLayer=null,ec._DefaultKeepDepthUtilityLayer=null;class tc extends la{constructor(e,t,i,s=true){super(e,t),this.layer=new ec(i,s,true),this.layer.utilityLayerScene._useCurrentFrameBuffer=true,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle();}record(){if(!this.targetTexture||!this.camera)throw new Error(`FrameGraphUtilityLayerRendererTask "${this.name}": targetTexture and camera are required`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture);const e=this._frameGraph.addRenderPass(this.name);e.setRenderTarget(this.outputTexture),e.setExecuteFunc((e=>{this.layer.setRenderCamera(this.camera),e.render(this.layer);}));const t=this._frameGraph.addRenderPass(this.name+"_disabled",true);t.setRenderTarget(this.outputTexture),t.setExecuteFunc((e=>{}));}dispose(){this.layer.dispose(),super.dispose();}}const ic={FindMainCamera:function(e){const t=ic.FindMainObjectRenderer(e);if(t)return t.camera;const i=e.tasks;for(let e=i.length-1;e>=0;e--){const t=i[e];if(t instanceof $l||t instanceof tc)return t.camera}return null},FindMainObjectRenderer:function(e){const t=e.getTasksByType(oh);let i=null;for(let e=t.length-1;e>=0;--e){if(t[e].isMainObjectRenderer)return t[e];t[e].objectList.meshes&&!i&&(i=t[e]);}return i},CreateUtilityLayerRenderer:function(e,t=true){const i=e.scene,s=new ec(i,t,true);s.utilityLayerScene.activeCamera=i.activeCamera;let r=ic.FindMainCamera(i.frameGraph);!r&&i.cameras.length>0&&(r=i.cameras[0]),r&&(s.setRenderCamera(r),s.utilityLayerScene.activeCamera=r);const n=i.onAfterRenderObservable.add((()=>{s.render();}));return s.utilityLayerScene.onDisposeObservable.addOnce((()=>{i.onAfterRenderObservable.remove(n);})),s}};class sc{constructor(e,t){this._disableRenderingRefCount=0,this._currentPerformancePriorityMode=0,this._isEnabling=false,this._enableCancelFunctions=new Map,this._disableCancelFunctions=new Map,this.showDebugLogs=false,this._scene=e,this._engine=e.getEngine(),this._engine.isWebGPU&&(this._options={morphTargetsNumMaxInfluences:20,...t},this._engine.snapshotRenderingMode=Qe$1.SNAPSHOTRENDERING_FAST,this.fixMeshes(),this._onResizeObserver=this._engine.onResizeObservable.add((()=>{this._log("onResize","start"),this._fastSnapshotRenderingEnabled&&(this.disableSnapshotRendering(),this.enableSnapshotRendering()),this._log("onResize","end");})),this._scene.onBeforeRenderObservable.add((()=>{if(!this._fastSnapshotRenderingEnabled)return;for(const t of e.skeletons)t.prepare(true);for(const t of e.meshes)if(t.infiniteDistance&&t.transferToEffect(t.computeWorldMatrix(true)),t.skeleton&&t.transferToEffect(t.computeWorldMatrix(true)),"GaussianSplattingMesh"===t.getClassName()&&t._postToWorker(),t.morphTargetManager&&t.subMeshes)for(const e of t.subMeshes){const i=e._drawWrapper,s=i.effect;if(s){const e=i.drawContext.buffers.LeftOver,r=s._pipelineContext?.uniformBuffer;e&&r&&r.setDataBuffer(e)&&(t.morphTargetManager._bind(s),ws(t,s),r.update());}}let t=e.activeCamera;if(e.frameGraph&&(t=ic.FindMainCamera(e.frameGraph)||t),e.spriteManagers&&t)for(const i of e.spriteManagers){const e=i.spriteRenderer;this._spriteRendererUpdateEffects(e._drawWrapperBase,e._drawWrapperDepth,t);}})));}get isReady(){return !this._isEnabling}enableSnapshotRendering(){if(!this._engine.isWebGPU)return;if(--this._disableRenderingRefCount>0)return;this._log("enableSnapshotRendering","called"),this._disableCancelFunctions.size>0&&this._log("enableSnapshotRendering",`cancelling ${this._disableCancelFunctions.size} "disable" callbacks`),this._disableCancelFunctions.forEach((e=>e())),this._disableCancelFunctions.clear(),this._isEnabling=true,this._disableRenderingRefCount=0,this._currentPerformancePriorityMode=this._pendingCurrentPerformancePriorityMode??this._scene.performancePriority,this._pendingCurrentPerformancePriorityMode=void 0,this._scene.performancePriority=0;const e=()=>{this._enableCancelFunctions.delete(e);const t=this._engine.frameId+2;this._log("enableSnapshotRendering",`scene ready, add callbacks for frames ${t} and ${t+1}`),this._executeAtFrame(t,(()=>{this._log("enableSnapshotRendering","callback #1, enable snapshot rendering at the engine level"),this._engine.snapshotRendering=true;})),this._executeAtFrame(t+1,(()=>{this._log("enableSnapshotRendering","callback #2, signals that snapshot rendering helper is ready"),this._isEnabling=false;}));};this._enableCancelFunctions.set(e,(()=>this._scene.onReadyObservable.removeCallback(e))),this._scene.executeWhenReady(e);}disableSnapshotRendering(){if(this._engine.isWebGPU){if(this._log("disableSnapshotRendering","called"),0===this._disableRenderingRefCount&&(this._enableCancelFunctions.size>0&&this._log("disableSnapshotRendering",`cancelling ${this._enableCancelFunctions.size} "enable" callbacks`),this._enableCancelFunctions.forEach((e=>e())),this._enableCancelFunctions.clear(),this._isEnabling=false,this._scene.performancePriority=0,0!==this._currentPerformancePriorityMode)){this._log("disableSnapshotRendering",`makes sure that the scene is rendered once in BackwardCompatible mode (code: 0) before switching to mode ${this._currentPerformancePriorityMode}`),this._pendingCurrentPerformancePriorityMode=this._currentPerformancePriorityMode;const e=()=>{this._log("disableSnapshotRendering",`scene ready, add callback for frame ${this._engine.frameId+2}`),this._executeAtFrame(this._engine.frameId+2,(()=>{this._log("disableSnapshotRendering",`switching to performance priority mode ${this._pendingCurrentPerformancePriorityMode}`),this._scene.performancePriority=this._pendingCurrentPerformancePriorityMode,this._pendingCurrentPerformancePriorityMode=void 0;}),"whenDisabled");};this._disableCancelFunctions.set(e,(()=>this._scene.onReadyObservable.removeCallback(e))),this._scene.executeWhenReady(e);}this._engine.snapshotRendering=false,this._disableRenderingRefCount++;}}fixMeshes(e){if(this._engine.isWebGPU){e=e||this._scene.meshes;for(const t of e)t.ignoreCameraMaxZ=false,t.morphTargetManager&&(t.morphTargetManager.numMaxInfluencers=Math.min(t.morphTargetManager.numTargets,this._options.morphTargetsNumMaxInfluences));}}updateMesh(e,t=true){if(this._fastSnapshotRenderingEnabled)if(Array.isArray(e))for(const i of e)t&&this._updateInstancedMesh(i)||i.transferToEffect(i.computeWorldMatrix());else t&&this._updateInstancedMesh(e)||e.transferToEffect(e.computeWorldMatrix());}_updateInstancedMesh(e){if(e.hasInstances){if(e.subMeshes){const t=e;for(const e of t.subMeshes){const i=t._getInstancesRenderList(e._id);t._updateInstancedBuffers(e,i,i.parent.instancesBufferSize,this._engine);}}return  true}return !!e.isAnInstance}updateMeshesForEffectLayer(e,t=true){if(!this._engine.isWebGPU)return;const i=e instanceof Zl?e.objectRendererForLayer.objectRenderer.renderPassId:e.mainTexture.renderPassId;t?this._onBeforeRenderObserverUpdateLayer=this._scene.onBeforeRenderObservable.add((()=>{this._updateMeshMatricesForRenderPassId(i);})):this._updateMeshMatricesForRenderPassId(i);}dispose(){this._engine.isWebGPU&&(this._scene.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._scene.onBeforeRenderObservable.remove(this._onBeforeRenderObserverUpdateLayer),this._engine.onResizeObservable.remove(this._onResizeObserver));}get _fastSnapshotRenderingEnabled(){return this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===Qe$1.SNAPSHOTRENDERING_FAST}_updateMeshMatricesForRenderPassId(e){if(!this._fastSnapshotRenderingEnabled)return;const t=this._scene.objectRenderers.find((t=>t.renderPassId===e))?.activeCamera?.getTransformationMatrix()??this._scene.getTransformMatrix();for(let i=0;i<this._scene.meshes.length;++i){const s=this._scene.meshes[i];if(s.subMeshes)for(let i=0;i<s.subMeshes.length;++i){const r=s.subMeshes[i]._getDrawWrapper(e),n=r?.effect;if(n){const e=r.drawContext.buffers.LeftOver,i=n._pipelineContext?.uniformBuffer;e&&i&&i.setDataBuffer(e)&&(n.setMatrix("viewProjection",t),n.setMatrix("world",s.computeWorldMatrix()),i.update());}}}}_spriteRendererDirectMatrixUpdate(e,t){const i=e?.effect;if(i){const s=e.drawContext.buffers.LeftOver,r=i._pipelineContext?.uniformBuffer;s&&r&&r.setDataBuffer(s)&&(i.setMatrix("view",t.getViewMatrix()),i.setMatrix("projection",t.getProjectionMatrix()),r.update());}}_spriteRendererUpdateEffects(e,t,i){this._spriteRendererDirectMatrixUpdate(e,i),this._spriteRendererDirectMatrixUpdate(t,i);}_executeAtFrame(e,t,i="whenEnabled"){const s=()=>{this._engine.frameId>=e&&(this._engine.onEndFrameObservable.remove(r),"whenEnabled"===i?this._enableCancelFunctions.delete(s):this._disableCancelFunctions.delete(s),t());},r=this._engine.onEndFrameObservable.add(s);"whenEnabled"===i?this._enableCancelFunctions.set(s,(()=>this._engine.onEndFrameObservable.remove(r))):this._disableCancelFunctions.set(s,(()=>this._engine.onEndFrameObservable.remove(r)));}_log(e,t){this.showDebugLogs&&Ie$2.Log(`[Frame: ${this._engine.frameId}] SnapshotRenderingHelper:${e} - ${t}`);}}function rc(e){const t=e.split("?")[0],i=t.lastIndexOf(".");return i>-1?t.substring(i).toLowerCase():""}const nc={name:"bvh",extensions:{".bvh":{isBinary:false}}},ac="Z2xURg",oc={name:"gltf",extensions:{".gltf":{isBinary:false,mimeType:"model/gltf+json"},".glb":{isBinary:true,mimeType:"model/gltf-binary"}},canDirectLoad:e=>-1!==e.indexOf("asset")&&-1!==e.indexOf("version")||e.startsWith("data:base64,"+ac)||e.startsWith("data:;base64,"+ac)||e.startsWith("data:application/octet-stream;base64,"+ac)||e.startsWith("data:model/gltf-binary;base64,"+ac)},hc={name:"obj",extensions:".obj"},lc={name:"splat",extensions:{".splat":{isBinary:true},".ply":{isBinary:true},".spz":{isBinary:true},".json":{isBinary:false},".sog":{isBinary:true}}},cc={name:"stl",extensions:{".stl":{isBinary:true}}},uc=new Map,dc=uc;function _c(e,t,i){fc(e)&&Ie$2.Warn(`Extension with the name '${e}' already exists`),uc.set(e,{isGLTFExtension:t,factory:i});}function fc(e){return uc.delete(e)}function pc(){gh({...nc,createPlugin:async e=>{const{BVHFileLoader:t}=await Promise.resolve().then(function(){return bvhFileLoaderCFXNglAB_esm_min});return new t(e[nc.name])}}),gh({...oc,createPlugin:async e=>{const{GLTFFileLoader:t}=await Promise.resolve().then(function(){return glTFLoaderDKIjI8R4_esm_min});return new t(e[oc.name])}}),_c("EXT_lights_image_based",true,(async e=>{const{EXT_lights_image_based:t}=await Promise.resolve().then(function(){return EXT_lights_image_basedDnZqov6m_esm_min});return new t(e)})),_c("EXT_mesh_gpu_instancing",true,(async e=>{const{EXT_mesh_gpu_instancing:t}=await Promise.resolve().then(function(){return EXT_mesh_gpu_instancingCKB7YdY7_esm_min});return new t(e)})),_c("EXT_meshopt_compression",true,(async e=>{const{EXT_meshopt_compression:t}=await Promise.resolve().then(function(){return EXT_meshopt_compressionCn4BFUXI_esm_min});return new t(e)})),_c("EXT_texture_avif",true,(async e=>{const{EXT_texture_avif:t}=await Promise.resolve().then(function(){return EXT_texture_avifDm7QsZfM_esm_min});return new t(e)})),_c("EXT_texture_webp",true,(async e=>{const{EXT_texture_webp:t}=await Promise.resolve().then(function(){return EXT_texture_webpBIdVdnIh_esm_min});return new t(e)})),_c("ExtrasAsMetadata",false,(async e=>{const{ExtrasAsMetadata:t}=await Promise.resolve().then(function(){return ExtrasAsMetadataDlmjm18_esm_min});return new t(e)})),_c("KHR_animation_pointer",true,(async e=>{const{KHR_animation_pointer:t}=await Promise.resolve().then(function(){return KHR_animation_pointerDIJlJSoB_esm_min});return new t(e)})),_c("KHR_draco_mesh_compression",true,(async e=>{const{KHR_draco_mesh_compression:t}=await Promise.resolve().then(function(){return KHR_draco_mesh_compressionCTKUQAgQ_esm_min});return new t(e)})),_c("KHR_interactivity",true,(async e=>{const{KHR_interactivity:t}=await Promise.resolve().then(function(){return KHR_interactivityPLcKePSA_esm_min}).then((function(e){return e.K}));return new t(e)})),_c("KHR_lights_punctual",true,(async e=>{const{KHR_lights:t}=await Promise.resolve().then(function(){return KHR_lights_punctualNqeob4Z4_esm_min});return new t(e)})),_c("EXT_lights_ies",true,(async e=>{const{EXT_lights_ies:t}=await Promise.resolve().then(function(){return EXT_lights_iesDqJqn21G_esm_min});return new t(e)})),_c("KHR_materials_anisotropy",true,(async e=>{const{KHR_materials_anisotropy:t}=await Promise.resolve().then(function(){return KHR_materials_anisotropyCsYiwLfN_esm_min});return new t(e)})),_c("KHR_materials_clearcoat",true,(async e=>{const{KHR_materials_clearcoat:t}=await Promise.resolve().then(function(){return KHR_materials_clearcoatC1QZaAXG_esm_min});return new t(e)})),_c("KHR_materials_diffuse_roughness",true,(async e=>{const{KHR_materials_diffuse_roughness:t}=await Promise.resolve().then(function(){return KHR_materials_diffuse_roughnessCE2DwL0T_esm_min});return new t(e)})),_c("KHR_materials_diffuse_transmission",true,(async e=>{const{KHR_materials_diffuse_transmission:t}=await Promise.resolve().then(function(){return KHR_materials_diffuse_transmissionDTyHxs4H_esm_min});return new t(e)})),_c("KHR_materials_dispersion",true,(async e=>{const{KHR_materials_dispersion:t}=await Promise.resolve().then(function(){return KHR_materials_dispersionOov2u1lo_esm_min});return new t(e)})),_c("KHR_materials_emissive_strength",true,(async e=>{const{KHR_materials_emissive_strength:t}=await Promise.resolve().then(function(){return KHR_materials_emissive_strengthD5P2AM9z_esm_min});return new t(e)})),_c("KHR_materials_ior",true,(async e=>{const{KHR_materials_ior:t}=await Promise.resolve().then(function(){return KHR_materials_iorCBGrQ4sL_esm_min});return new t(e)})),_c("KHR_materials_iridescence",true,(async e=>{const{KHR_materials_iridescence:t}=await Promise.resolve().then(function(){return KHR_materials_iridescenceCe7w5fDO_esm_min});return new t(e)})),_c("KHR_materials_pbrSpecularGlossiness",true,(async e=>{const{KHR_materials_pbrSpecularGlossiness:t}=await Promise.resolve().then(function(){return KHR_materials_pbrSpecularGlossinessWtXBUgb6_esm_min});return new t(e)})),_c("KHR_materials_sheen",true,(async e=>{const{KHR_materials_sheen:t}=await Promise.resolve().then(function(){return KHR_materials_sheenBqFvYGyK_esm_min});return new t(e)})),_c("KHR_materials_specular",true,(async e=>{const{KHR_materials_specular:t}=await Promise.resolve().then(function(){return KHR_materials_specularD8iVKYIB_esm_min});return new t(e)})),_c("KHR_materials_transmission",true,(async e=>{const{KHR_materials_transmission:t}=await Promise.resolve().then(function(){return KHR_materials_transmission7ljGlqUe_esm_min});return new t(e)})),_c("KHR_materials_unlit",true,(async e=>{const{KHR_materials_unlit:t}=await Promise.resolve().then(function(){return KHR_materials_unlit2nBGO9GB_esm_min});return new t(e)})),_c("KHR_materials_variants",true,(async e=>{const{KHR_materials_variants:t}=await Promise.resolve().then(function(){return KHR_materials_variants2EdtXuM9_esm_min});return new t(e)})),_c("KHR_materials_volume",true,(async e=>{const{KHR_materials_volume:t}=await Promise.resolve().then(function(){return KHR_materials_volumeICuwBO4_esm_min});return new t(e)})),_c("KHR_mesh_quantization",true,(async e=>{const{KHR_mesh_quantization:t}=await Promise.resolve().then(function(){return KHR_mesh_quantizationC5yW_zvY_esm_min});return new t(e)})),_c("KHR_texture_basisu",true,(async e=>{const{KHR_texture_basisu:t}=await Promise.resolve().then(function(){return KHR_texture_basisuCMZNYAJN_esm_min});return new t(e)})),_c("KHR_texture_transform",true,(async e=>{const{KHR_texture_transform:t}=await Promise.resolve().then(function(){return KHR_texture_transformCsBKLYw7_esm_min});return new t(e)})),_c("KHR_xmp_json_ld",true,(async e=>{const{KHR_xmp_json_ld:t}=await Promise.resolve().then(function(){return KHR_xmp_json_ldBEXvpjL3_esm_min});return new t(e)})),_c("MSFT_audio_emitter",true,(async e=>{const{MSFT_audio_emitter:t}=await Promise.resolve().then(function(){return MSFT_audio_emitterCmDdp9Vo_esm_min});return new t(e)})),_c("MSFT_lod",true,(async e=>{const{MSFT_lod:t}=await Promise.resolve().then(function(){return MSFT_lodDL_omRXB_esm_min});return new t(e)})),_c("MSFT_minecraftMesh",true,(async e=>{const{MSFT_minecraftMesh:t}=await Promise.resolve().then(function(){return MSFT_minecraftMeshCXum7ogz_esm_min});return new t(e)})),_c("MSFT_sRGBFactors",true,(async e=>{const{MSFT_sRGBFactors:t}=await Promise.resolve().then(function(){return MSFT_sRGBFactorsTxXGZyh_esm_min});return new t(e)})),_c("KHR_node_visibility",true,(async e=>{const{KHR_node_visibility:t}=await Promise.resolve().then(function(){return KHR_node_visibilityCw9XSLCx_esm_min});return new t(e)})),_c("KHR_node_hoverability",true,(async e=>{const{KHR_node_hoverability:t}=await Promise.resolve().then(function(){return KHR_node_hoverabilityVeW9q7fl_esm_min});return new t(e)})),_c("KHR_node_selectability",true,(async e=>{const{KHR_node_selectability:t}=await Promise.resolve().then(function(){return KHR_node_selectabilityDPnTqtNB_esm_min});return new t(e)})),gh({...hc,createPlugin:async e=>{const{OBJFileLoader:t}=await Promise.resolve().then(function(){return objFileLoaderCeQH81_esm_min});return new t(e[hc.name])}}),gh({...lc,createPlugin:async e=>{const{SPLATFileLoader:t}=await Promise.resolve().then(function(){return splatFileLoaderD3EpyLgL_esm_min});return new t(e[lc.name])}}),gh({...cc,createPlugin:async()=>{const{STLFileLoader:e}=await Promise.resolve().then(function(){return stlFileLoaderCQ_DxrvQ_esm_min});return new e}});}const gc=new Ol((()=>Promise.all([Promise.resolve().then(function(){return ssao2RenderingPipelineEUwrxTfo_esm_min}),Promise.resolve().then(function(){return prePassRendererSceneComponentBdLeH256_esm_min}),Promise.resolve().then(function(){return geometryBufferRendererSceneComponentGhcZfRxY_esm_min}),Promise.resolve().then(function(){return engine_multiRenderBa06RCov_esm_min}),Promise.resolve().then(function(){return engine_multiRenderCrzbKH2j_esm_min})]))),mc=["none","normal","high"],Tc=["none","standard","aces","neutral"];function Ec(e){return Tc.includes(e)}function Ac(...e){for(const t of e)t?.throwIfAborted();}async function Rc(e,t,i){i=i??rc(e);const s=await(async()=>{if(".hdr"===i){const{HDRCubeTexture:i}=await Promise.resolve().then(function(){return hdrCubeTextureDrNFOKdT_esm_min});return ()=>new i(e,t,256,false,true,false,true,void 0,void 0,void 0,true,true)}{const{CubeTexture:s}=await Promise.resolve().then(function(){return cubeTextureQcQtFJtH_esm_min});return ()=>new s(e,t,null,false,null,null,null,void 0,true,i,true)}})(),r=t.useDelayedTextureLoading;try{return t.useDelayedTextureLoading=!1,s()}finally{t.useDelayedTextureLoading=r;}}function bc(e,t){e?.scaling.setAll((t.maxZ-t.minZ)/2);}function Sc(e){return e.flatMap((e=>function(e,t=null,i=1/6){const s=ae$5.Vector3[0],r=new Map,n=new Map,a=e.reduce(((e,t)=>Math.max(e,t.getTotalVertices())),0),o=Array.from({length:a},(()=>new te$4)),h=Array.from({length:a},(()=>new te$4));for(const t of e){const e=t.getVerticesData(Hi.PositionKind);if(!e)continue;const i=t.getTotalVertices();o.length=Math.max(o.length,i),h.length=Math.max(o.length,i);for(let t=0,r=0;t<i;t++,r+=3)s.set(e[r],e[r+1],e[r+2]),o[t].copyFrom(s),h[t].copyFrom(s);const a=t.morphTargetManager;if(a)for(let e=0;e<a.numTargets;++e){const t=a.getTarget(e).getPositions();if(t)for(let e=0,r=0;e<i;e++,r+=3)s.set(t[r],t[r+1],t[r+2]),o[e].minimizeInPlace(s),h[e].maximizeInPlace(s);}const l=t.skeleton,c=l?t.getVerticesData(Hi.MatricesWeightsKind):null,u=l?t.getVerticesData(Hi.MatricesIndicesKind):null;if(c&&u){const e=t.numBoneInfluencers>4,s=e?t.getVerticesData(Hi.MatricesWeightsExtraKind):null,r=e?t.getVerticesData(Hi.MatricesIndicesExtraKind):null,a=n.get(t.uniqueId)||new Map;n.set(t.uniqueId,a);const l=(e,t,i,s)=>{for(let r=t;r<t+4;r++)if(i[r]>0){const t=s[r],i=a.get(t);i?(i.minimum.minimizeInPlace(o[e]),i.maximum.maximizeInPlace(h[e])):a.set(t,{minimum:o[e].clone(),maximum:h[e].clone()});}};for(let e=0,t=0;e<i;e++,t+=4)l(e,t,c,u),s&&r&&l(e,t,s,r);}else {const e=r.get(t.uniqueId)||{minimum:(new te$4).setAll(Number.POSITIVE_INFINITY),maximum:(new te$4).setAll(Number.NEGATIVE_INFINITY)};r.set(t.uniqueId,e);for(let t=0;t<i;t++)e.minimum.minimizeInPlace(o[t]),e.maximum.maximizeInPlace(h[t]);}}const l=new Map,c=new Map;for(const t of e){const e=r.get(t.uniqueId);if(e)l.set(t.uniqueId,Il(e));else {const e=n.get(t.uniqueId);if(e){const i=t.skeleton.bones,s=new Map;c.set(t.uniqueId,s),e.forEach(((e,t)=>{const r=Il(e),n=i[t].getAbsoluteInverseBindMatrix();for(const e of r)te$4.TransformCoordinatesToRef(e,n,e);s.set(t,r);}));}}}const u=Array.from({length:e.length},(()=>({minimum:(new te$4).setAll(Number.POSITIVE_INFINITY),maximum:(new te$4).setAll(Number.NEGATIVE_INFINITY)}))),d=()=>{for(let t=0;t<e.length;t++){const i=e[t];if(!i.getVerticesData(Hi.PositionKind))continue;const r=i.computeWorldMatrix(true),n=i.skeleton;if(n){n.prepare(true);const e=n.bones;c.get(i.uniqueId).forEach(((i,n)=>{for(const a of i){const i=e[n].getFinalMatrix().multiplyToRef(r,ae$5.Matrix[0]);te$4.TransformCoordinatesToRef(a,i,s),u[t].minimum.minimizeInPlace(s),u[t].maximum.maximizeInPlace(s);}}));}else for(const e of l.get(i.uniqueId))te$4.TransformCoordinatesToRef(e,r,s),u[t].minimum.minimizeInPlace(s),u[t].maximum.maximizeInPlace(s);}};if(t&&t.isStarted){const e=t.getCurrentFrame(),s=i/t.getLength(0,1);for(let e=t.from;e<=t.to;e+=s)t.goToFrame(e),d();t.goToFrame(e);}else d();return u}(e.assetContainer.meshes,e.assetContainer.animationGroups[e.selectedAnimation])))}function xc(e){return function(e){if(0===e.length)return null;const t=new te$4(Math.min(...e.map((e=>e.minimum.x))),Math.min(...e.map((e=>e.minimum.y))),Math.min(...e.map((e=>e.minimum.z)))),i=new te$4(Math.max(...e.map((e=>e.maximum.x))),Math.max(...e.map((e=>e.maximum.y))),Math.max(...e.map((e=>e.maximum.z)))),s=i.subtract(t),r=t.add(s.scale(.5));return {extents:{min:t.asArray(),max:i.asArray()},size:s.asArray(),center:r.asArray()}}(Sc(e))}function Mc(e){(async()=>{try{await e;}catch(e){e instanceof Ne$1||Ie$2.Error(e);}})();}async function yc(e,t){await Promise.resolve().then(function(){return rayBVwnQLmQ_esm_min});const i=e.assetContainer.scene,s=t.getForwardRay(100,t.getWorldMatrix(),t.globalPosition),r=t.globalPosition.clone();let n=1e-4;const a=te$4.Zero(),o=i.pickWithRay(s,(t=>e.assetContainer.meshes.includes(t)));if(o&&o.hit)a.copyFrom(o.pickedPoint);else {const t=e.getWorldBounds(),i=t?t.center:[0,0,0],o=te$4.FromArray(i),h=s.direction.clone();a.copyFrom(r),n=te$4.Distance(r,o),h.scaleAndAddToRef(n,a);}const h=te$4.Zero();r.subtractToRef(a,h),o&&o.hit&&(n=h.length());const l=hn(h),c=ln(h.y,n),u=a.asArray();return {type:"world",position:u,normal:u,cameraOrbit:[l,c,n]}}const Ic={clearColor:[0,0,0,0],autoSuspendRendering:true,environmentConfig:{intensity:1,blur:.3,rotation:0},environmentLighting:"auto",environmentSkybox:"none",cameraAutoOrbit:{enabled:false,delay:2e3,speed:.05},animationAutoPlay:false,animationSpeed:1,shadowConfig:{quality:"none"},postProcessing:{toneMapping:"neutral",contrast:1,exposure:1,ssao:"auto"},useRightHandedSystem:false},Cc={lighting:true,skybox:true};class vc{constructor(){this.screenPosition=[NaN,NaN],this.worldPosition=[NaN,NaN,NaN],this.visibility=NaN;}}class Pc{constructor(e,t){this._engine=e,this._options=t,this.showDebugLogs=false,this.onEnvironmentChanged=new R$g,this.onEnvironmentConfigurationChanged=new R$g,this.onEnvironmentError=new R$g,this.onShadowsConfigurationChanged=new R$g,this.onPostProcessingChanged=new R$g,this.onModelChanged=new R$g,this.onModelError=new R$g,this.onLoadingProgressChanged=new R$g,this.onCameraAutoOrbitChanged=new R$g,this.onSelectedAnimationChanged=new R$g,this.onAnimationSpeedChanged=new R$g,this.onIsAnimationPlayingChanged=new R$g,this.onAnimationProgressChanged=new R$g,this.onSelectedMaterialVariantChanged=new R$g,this.onHotSpotsChanged=new R$g,this.onCamerasAsHotSpotsChanged=new R$g,this._renderedLastFrame=null,this._sceneOptimizer=null,this._tempVectors=y$e(4,te$4.Zero),this._meshDataCache=new Map,this._renderLoopController=null,this._loadedModelsBacking=[],this._activeModelBacking=null,this._environmentSkyboxMode="none",this._environmentLightingMode="none",this._skybox=null,this._skyboxBlur=this._options?.environmentConfig?.blur??Ic.environmentConfig.blur,this._skyboxTexture=null,this._reflectionTexture=null,this._reflectionsIntensity=this._options?.environmentConfig?.intensity??Ic.environmentConfig.intensity,this._reflectionsRotation=this._options?.environmentConfig?.rotation??Ic.environmentConfig.rotation,this._light=null,this._ssaoOption=this._options?.postProcessing?.ssao??Ic.postProcessing.ssao,this._ssaoPipeline=null,this._autoSuspendRendering=this._options?.autoSuspendRendering??Ic.autoSuspendRendering,this._sceneMutated=false,this._suspendRenderCount=0,this._isDisposed=false,this._loadModelLock=new vl,this._loadModelAbortController=null,this._loadEnvironmentLock=new vl,this._loadEnvironmentAbortController=null,this._camerasAsHotSpotsAbortController=null,this._updateShadowsLock=new vl,this._shadowsAbortController=null,this._loadOperations=new Set,this._activeAnimationObservers=[],this._animationSpeed=this._options?.animationSpeed??Ic.animationSpeed,this._camerasAsHotSpots=false,this._hotSpots=this._options?.hotSpots??{},this._shadowQuality=this._options?.shadowConfig?.quality??Ic.shadowConfig.quality,this._shadowState={},this._defaultHardwareScalingLevel=this._lastHardwareScalingLevel=this._engine.getHardwareScalingLevel();{const e=new ch(this._engine);e.useRightHandedSystem=this._options?.useRightHandedSystem??Ic.useRightHandedSystem;const t=new gl("default Material",e);t.albedoColor=new ge$3(.4,.4,.4),t.metallic=0,t.roughness=1,t.baseDiffuseRoughness=1,t.microSurface=0,e.defaultMaterial=t,this._toneMappingEnabled=e.imageProcessingConfiguration.toneMappingEnabled,this._toneMappingType=e.imageProcessingConfiguration.toneMappingType,this._contrast=e.imageProcessingConfiguration.contrast,this._exposure=e.imageProcessingConfiguration.exposure,this._imageProcessingConfigurationObserver=e.imageProcessingConfiguration.onUpdateParameters.add((()=>{let t=false;this._toneMappingEnabled!==e.imageProcessingConfiguration.toneMappingEnabled&&(this._toneMappingEnabled=e.imageProcessingConfiguration.toneMappingEnabled,t=true),this._toneMappingType!==e.imageProcessingConfiguration.toneMappingType&&(this._toneMappingType=e.imageProcessingConfiguration.toneMappingType,t=true),this._contrast!==e.imageProcessingConfiguration.contrast&&(this._contrast=e.imageProcessingConfiguration.contrast,t=true),this._exposure!==e.imageProcessingConfiguration.exposure&&(this._exposure=e.imageProcessingConfiguration.exposure,t=true),t&&this.onPostProcessingChanged.notifyObservers();}));const i=new un("Viewer Default Camera",0,0,1,te$4.Zero(),e);i.useInputToRestoreState=false,i.useAutoRotationBehavior=true,i.onViewMatrixChangedObservable.add((()=>{this._markSceneMutated();})),e.onClearColorChangedObservable.add((()=>{this._markSceneMutated();})),e.onPointerObservable.add((async e=>{const t=await this._pick(e.event.offsetX,e.event.offsetY);if(t?.pickedPoint){const e=t.pickedPoint.subtract(i.position).dot(i.getForwardRay().direction);i.target=i.position.add(i.getForwardRay().direction.scale(e)),i.radius=e,i.interpolateTo(void 0,void 0,void 0,t.pickedPoint);}else this.resetCamera(true);}),Ar$1.POINTERDOUBLETAP),e.onNewCameraAddedObservable.add((e=>{this.camerasAsHotSpots&&Mc(this._addCameraHotSpot(e,this._camerasAsHotSpotsAbortController?.signal));})),e.onCameraRemovedObservable.add((e=>{this._removeCameraHotSpot(e);})),this._scene=e,this._camera=i;}this._scene.skipFrustumClipping=true,this._scene.skipPointerDownPicking=true,this._scene.skipPointerUpPicking=true,this._scene.skipPointerMovePicking=true,this._snapshotHelper=new sc(this._scene,{morphTargetsNumMaxInfluences:30}),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{this._snapshotHelper.updateMesh(this._scene.meshes);})),this._camera.attachControl(),this._autoRotationBehavior=this._camera.getBehaviorByName("AutoRotation"),this._reset(false,"camera"),Mc(this.resetEnvironment()),this._beginRendering();const i=this;this._options?.onInitialized?.({scene:i._scene,camera:i._camera,get model(){return i._activeModel??null},suspendRendering:()=>this._suspendRendering(),markSceneMutated:()=>this._markSceneMutated(),pick:async(e,t)=>await this._pick(e,t)}),this._reset(false,"source","environment","post-processing");}get cameraAutoOrbit(){return {enabled:this._camera.behaviors.includes(this._autoRotationBehavior),speed:this._autoRotationBehavior.idleRotationSpeed,delay:this._autoRotationBehavior.idleRotationWaitTime}}set cameraAutoOrbit(e){ void 0!==e.enabled&&e.enabled!==this.cameraAutoOrbit.enabled&&(e.enabled?this._camera.addBehavior(this._autoRotationBehavior):this._camera.removeBehavior(this._autoRotationBehavior)),void 0!==e.delay&&(this._autoRotationBehavior.idleRotationWaitTime=e.delay),void 0!==e.speed&&(this._autoRotationBehavior.idleRotationSpeed=e.speed),this.onCameraAutoOrbitChanged.notifyObservers();}get environmentConfig(){return {intensity:this._reflectionsIntensity,blur:this._skyboxBlur,rotation:this._reflectionsRotation}}set environmentConfig(e){ void 0!==e.blur&&this._changeSkyboxBlur(e.blur),void 0!==e.intensity&&(this._changeEnvironmentIntensity(e.intensity),this._changeShadowLightIntensity()),void 0!==e.rotation&&(this._changeEnvironmentRotation(e.rotation),this._rotateShadowLightWithEnvironment()),this.onEnvironmentConfigurationChanged.notifyObservers();}get shadowConfig(){return {quality:this._shadowQuality}}async updateShadows(e){e.quality&&this._shadowQuality!==e.quality&&(this._shadowQuality=e.quality,await this._updateShadows(),this.onShadowsConfigurationChanged.notifyObservers());}_changeSkyboxBlur(e){if(e!==this._skyboxBlur&&(this._skyboxBlur=e,this._skybox)){const e=this._skybox.material;e instanceof yh&&(this._snapshotHelper.disableSnapshotRendering(),e.reflectionBlur=this._skyboxBlur,this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated());}}_changeEnvironmentRotation(e){e!==this._reflectionsRotation&&(this._reflectionsRotation=e,this._snapshotHelper.disableSnapshotRendering(),this._skyboxTexture&&(this._skyboxTexture.rotationY=this._reflectionsRotation),this._reflectionTexture&&(this._reflectionTexture.rotationY=this._reflectionsRotation),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated());}_changeEnvironmentIntensity(e){e!==this._reflectionsIntensity&&(this._reflectionsIntensity=e,this._snapshotHelper.disableSnapshotRendering(),this._skyboxTexture&&(this._skyboxTexture.level=this._reflectionsIntensity),this._reflectionTexture&&(this._reflectionTexture.level=this._reflectionsIntensity),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated());}_updateAutoClear(){this._scene.autoClear=true,this._markSceneMutated();}get postProcessing(){let e="none";if(this._toneMappingEnabled)switch(this._toneMappingType){case En.TONEMAPPING_STANDARD:e="standard";break;case En.TONEMAPPING_ACES:e="aces";break;case En.TONEMAPPING_KHR_PBR_NEUTRAL:e="neutral";}return {toneMapping:e,contrast:this._contrast,exposure:this._exposure,ssao:this._ssaoOption}}set postProcessing(e){if(this._snapshotHelper.disableSnapshotRendering(),void 0!==e.toneMapping)if("none"===e.toneMapping)this._scene.imageProcessingConfiguration.toneMappingEnabled=false;else {switch(e.toneMapping){case "standard":this._scene.imageProcessingConfiguration.toneMappingType=En.TONEMAPPING_STANDARD;break;case "aces":this._scene.imageProcessingConfiguration.toneMappingType=En.TONEMAPPING_ACES;break;case "neutral":this._scene.imageProcessingConfiguration.toneMappingType=En.TONEMAPPING_KHR_PBR_NEUTRAL;}this._scene.imageProcessingConfiguration.toneMappingEnabled=true;} void 0!==e.contrast&&(this._scene.imageProcessingConfiguration.contrast=e.contrast),void 0!==e.exposure&&(this._scene.imageProcessingConfiguration.exposure=e.exposure),e.ssao&&this._ssaoOption!==e.ssao&&(this._ssaoOption=e.ssao,this._updateSSAOPipeline()),this._scene.imageProcessingConfiguration.isEnabled=this._toneMappingEnabled||1!==this._contrast||1!==this._exposure||null!==this._ssaoPipeline,this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated();}get loadingProgress(){if(this._loadOperations.size>0){let e=0;for(const t of this._loadOperations){if(null==t.progress)return  true;e+=t.progress;}return e/this._loadOperations.size}return  false}get _loadedModels(){return this._loadedModelsBacking}get _activeModel(){return this._activeModelBacking}_setActiveModel(...e){const[t,i]=e;t!==this._activeModelBacking&&(this._activeModelBacking=t,this._updateLight(),Mc(this._updateShadows()),this._updateSSAOPipeline(),this._applyAnimationSpeed(),this._selectAnimation(0,false),this.onSelectedMaterialVariantChanged.notifyObservers(),this._reframeCamera(true,t?[t]:void 0),this.onModelChanged.notifyObservers(i?.source??null));}async _enableSSAOPipeline(e){const t=this._loadedModels.length>0,i=this._loadedModels.some((e=>e.assetContainer.materials.length>0));if("enabled"===e||"auto"===e&&t&&!i){const[{SSAO2RenderingPipeline:e}]=await gc.value;this._ssaoPipeline||(this._scene.postProcessRenderPipelineManager.onNewPipelineAddedObservable.add((e=>{"ssao"===e.name&&this.onPostProcessingChanged.notifyObservers();})),this._scene.postProcessRenderPipelineManager.onPipelineRemovedObservable.add((e=>{"ssao"===e.name&&this.onPostProcessingChanged.notifyObservers();})));const t={ssaoRatio:1,blurRatio:1};this._ssaoPipeline=new e("ssao",this._scene,t);const i=this._getWorldBounds(this._loadedModels);if(this._ssaoPipeline&&i){const e=te$4.FromArray(i.size).length();this._ssaoPipeline.expensiveBlur=true,this._ssaoPipeline.maxZ=2*e;const t=50;this._ssaoPipeline.radius=U$5(N$c(1,5,U$5((e-1)/t,0,1)),1,5),this._ssaoPipeline.totalStrength=U$5(N$c(.3,1,U$5((e-1)/t,0,1)),.3,1),this._ssaoPipeline.samples=Math.round(U$5(N$c(8,32,U$5((e-1)/t,0,1)),8,32));}this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline("ssao",this._camera);}}_disableSSAOPipeline(){this._ssaoPipeline&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline("ssao",this._camera),this._scene.postProcessRenderPipelineManager.removePipeline("ssao"),this._ssaoPipeline?.dispose(),this._ssaoPipeline=null);}_updateSSAOPipeline(){this._ssaoPipeline||"auto"!==this._ssaoOption&&"enabled"!==this._ssaoOption?"disabled"===this._ssaoOption&&this._disableSSAOPipeline():Mc(this._enableSSAOPipeline(this._ssaoOption));}get animations(){return this._activeModel?.assetContainer.animationGroups.map((e=>e.name))??[]}get selectedAnimation(){return this._activeModel?.selectedAnimation??-1}set selectedAnimation(e){this._selectAnimation(e,0===this._loadOperations.size);}_selectAnimation(e,t=true){e=Math.round(U$5(e,-1,this.animations.length-1)),this._activeModel&&e!==this._activeModel.selectedAnimation&&(this._activeAnimationObservers.forEach((e=>e.remove())),this._activeAnimationObservers=[],this._activeModel.selectedAnimation=e,this._activeAnimation&&(this._activeAnimationObservers=[this._activeAnimation.onAnimationGroupPlayObservable.add((()=>{this.onIsAnimationPlayingChanged.notifyObservers();})),this._activeAnimation.onAnimationGroupPauseObservable.add((()=>{this.onIsAnimationPlayingChanged.notifyObservers();})),this._activeAnimation.onAnimationGroupEndObservable.add((()=>{this.onIsAnimationPlayingChanged.notifyObservers(),this.onAnimationProgressChanged.notifyObservers();}))],this._reframeCamera(t)),this.onSelectedAnimationChanged.notifyObservers(),this.onAnimationProgressChanged.notifyObservers());}get isAnimationPlaying(){return this._activeModelBacking?._animationPlaying()??false}get animationSpeed(){return this._animationSpeed}set animationSpeed(e){this._animationSpeed=e,this._applyAnimationSpeed(),this.onAnimationSpeedChanged.notifyObservers();}get animationProgress(){return this._activeAnimation?this._activeAnimation.getCurrentFrame()/(this._activeAnimation.to-this._activeAnimation.from):0}set animationProgress(e){this._activeAnimation&&(this._activeAnimation.goToFrame(e*(this._activeAnimation.to-this._activeAnimation.from)),this.onAnimationProgressChanged.notifyObservers(),this._autoRotationBehavior.resetLastInteractionTime(),this._markSceneMutated());}get _activeAnimation(){return this._activeModel?.assetContainer.animationGroups[this._activeModel?.selectedAnimation]??null}get materialVariants(){return this._activeModel?.materialVariantsController?.variants??[]}get selectedMaterialVariant(){return this._activeModel?.selectedMaterialVariant??null}set selectedMaterialVariant(e){this._activeModel&&e&&(this._activeModel.selectedMaterialVariant=e);}get hotSpots(){return this._hotSpots}set hotSpots(e){this._hotSpots=e,this.onHotSpotsChanged.notifyObservers();}get camerasAsHotSpots(){return this._camerasAsHotSpots}set camerasAsHotSpots(e){this._camerasAsHotSpots!==e&&(this._camerasAsHotSpots=e,this._toggleCamerasAsHotSpots(),this.onCamerasAsHotSpotsChanged.notifyObservers());}_beginLoadOperation(){const e=this;let t=null;const i={get progress(){return t},set progress(i){t=i,e.onLoadingProgressChanged.notifyObservers();},dispose:()=>{e._loadOperations.delete(i),e.onLoadingProgressChanged.notifyObservers();}};return this._loadOperations.add(i),this.onLoadingProgressChanged.notifyObservers(),i}async loadModel(e,t,i){await this._updateModel(e,t,i);}async resetModel(e){await this._updateModel(void 0,void 0,e);}async _loadModel(e,t,i){this._throwIfDisposedOrAborted(i);const s=this._beginLoadOperation(),r=t?.onProgress;delete t?.onProgress;let n=null;const a=t?.pluginOptions?.gltf?.extensionOptions?.KHR_materials_variants?.onLoaded;delete t?.pluginOptions?.gltf?.extensionOptions?.KHR_materials_variants?.onLoaded;t=Pl({onProgress:e=>{r?.(e),s.progress=e.lengthComputable?e.loaded/e.total:null;},pluginOptions:{gltf:{transparencyAsCoverage:true,extensionOptions:{KHR_materials_variants:{onLoaded:e=>{a?.(e),n=e;}}}}}},t??{}),this._snapshotHelper.disableSnapshotRendering();try{const i=await Th(e,this._scene,t);!function(e){const t=[Hi.UVKind,Hi.UV2Kind,Hi.UV3Kind,Hi.UV4Kind,Hi.UV5Kind,Hi.UV6Kind];for(const i of e){const e=new Set(t),s=i.material?.getActiveTextures();if(s)for(const i of s)e.delete(t[i.coordinatesIndex]);e.forEach((e=>{i.isVerticesDataPresent(e)&&i.removeVerticesData(e);}));}}(i.meshes.filter((e=>e instanceof Er$1))),i.animationGroups.forEach((e=>{e.start(!0,this.animationSpeed),e.pause();})),i.addAllToScene(),this._snapshotHelper.fixMeshes(i.meshes);let s=-1;const r=[],a=this,o={assetContainer:i,materialVariantsController:n,_animationPlaying:()=>{const e=i.animationGroups[s];return e?.isPlaying??!1},_shouldRender:()=>{const e=o?.assetContainer.animationGroups.some((e=>e.animatables.some((e=>e.animationStarted))));return o._animationPlaying()||e},getHotSpotToRef:(e,t)=>this._getHotSpotToRef(i,e,t),dispose:()=>{this._snapshotHelper.disableSnapshotRendering(),i.meshes.forEach((e=>this._meshDataCache.delete(e))),i.dispose();const e=this._loadedModelsBacking.indexOf(o);-1!==e&&(this._loadedModelsBacking.splice(e,1),o===this._activeModel&&this._setActiveModel(null)),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated();},getWorldBounds:(e=s)=>{let t=r[e];return t||(t=xc([o]),t&&(r[e]=t)),t},resetWorldBounds:()=>{r.length=0;},get selectedAnimation(){return s},set selectedAnimation(e){let t=i.animationGroups[s];const r=t?.isPlaying??!1;t&&(t.pause(),t.goToFrame(0)),s=e,t=i.animationGroups[s],Mc(a._updateShadows()),t&&(t.goToFrame(0),t.play(!0),r||t.pause());},makeActive:e=>{this._setActiveModel(o,e);},set selectedMaterialVariant(e){if(n){let t=e;t||(t=n.variants[0]),t!==n.selectedVariant&&n.variants.includes(t)&&(a._snapshotHelper.disableSnapshotRendering(),n.selectedVariant=t,a._snapshotHelper.enableSnapshotRendering(),a._markSceneMutated(),a.onSelectedMaterialVariantChanged.notifyObservers());}},get selectedMaterialVariant(){return n?n.selectedVariant:null}};return this._loadedModelsBacking.push(o),o}catch(e){throw this.onModelError.notifyObservers(e),e}finally{s.dispose(),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated();}}async _updateModel(e,t,i){this._throwIfDisposedOrAborted(i),this._loadModelAbortController?.abort(new Ne$1("New model is being loaded before previous model finished loading."));const s=this._loadModelAbortController=new AbortController;await this._loadModelLock.lockAsync((async()=>{if(Ac(i,s.signal),this._activeModel?.dispose(),this._activeModelBacking=null,this.selectedAnimation=-1,e){(await this._loadModel(e,t,s.signal)).makeActive(Object.assign({source:e,interpolateCamera:false},t)),this._reset(false,"camera","animation","material-variant");}}));const r=this._loadedModels.some((e=>e.assetContainer.materials.some((e=>e instanceof gl)))),n=this._loadedModels.some((e=>e.assetContainer.meshes.some((e=>!e.material))));this._scene.environmentTexture||!r&&!n||await this.resetEnvironment({lighting:true},i),this._startSceneOptimizer(true);}async _updateShadows(){this._shadowsAbortController?.abort(new Ne$1("Shadows quality is being change before previous shadows finished initializing."));const e=this._shadowsAbortController=new AbortController;await this._updateShadowsLock.lockAsync((async()=>{"none"===this._shadowQuality?this._disposeShadows():(this._reflectionTexture||await this.loadEnvironment("auto",{lighting:true,skybox:false}),"normal"===this._shadowQuality?await this._updateShadowMap(e.signal):"high"===this._shadowQuality&&await this._updateEnvShadow(e.signal));}));}_changeShadowLightIntensity(){this._shadowState.high&&(this._shadowState.high.pipeline.resetAccumulation(),this._startIblShadowsRenderTime());}_rotateShadowLightWithEnvironment(){"normal"===this._shadowQuality&&this._shadowState.normal?this._shadowState.normal.light&&this._shadowState.normal.refreshLightPositionDirection(this._reflectionsRotation):"high"===this._shadowQuality&&this._shadowState.high&&(this._shadowState.high.pipeline?.resetAccumulation(),this._startIblShadowsRenderTime());}_startIblShadowsRenderTime(){if(this._shadowState.high){null!=this._shadowState.high.renderTimer?clearTimeout(this._shadowState.high.renderTimer):this._snapshotHelper.disableSnapshotRendering(),this._shadowState.high.shouldRender=true;const e=()=>{this._shadowState.high&&(this._shadowState.high.shouldRender=false,this._shadowState.high.renderTimer=null),this._snapshotHelper.enableSnapshotRendering();};this._shadowState.high.renderTimer=setTimeout(e,4e3*this._shadowState.high.pipeline.shadowRemanence);}}async _updateEnvShadow(e){const[{ShaderMaterial:t},{ShaderLanguage:i},{CreateDisc:s},{IblShadowsRenderPipeline:r}]=await Promise.all([Promise.resolve().then(function(){return shaderMaterialB2PRHxGe_esm_min}),Promise.resolve().then(function(){return shaderLanguageR84fVnRr_esm_min}),Promise.resolve().then(function(){return discBuilderD9KLnRbJ_esm_min}),Promise.resolve().then(function(){return iblShadowsRenderPipelineB0_8f9tc_esm_min}),Promise.resolve().then(function(){return engine_multiRenderBa06RCov_esm_min}),Promise.resolve().then(function(){return engine_multiRenderCrzbKH2j_esm_min}),Promise.resolve().then(function(){return postProcessRenderPipelineManagerSceneComponentCqIiRFQN_esm_min})]);this._throwIfDisposedOrAborted(e,this._loadModelAbortController?.signal,this._loadEnvironmentAbortController?.signal);let n=this._shadowState.high;const a=xc(this._loadedModelsBacking);if(!a)return n?.ground.setEnabled(false),void this._log("No models loaded, cannot create shadows.");const o=4*te$4.FromArray(a.size).length(),h=()=>{if(this._shadowState.high){this._snapshotHelper.disableSnapshotRendering();const{pipeline:e,groundMaterial:t,ground:i}=this._shadowState.high;t?.setVector2("renderTargetSize",new ee$4(this._scene.getEngine().getRenderWidth(),this._scene.getEngine().getRenderHeight())),t?.setFloat("shadowOpacity",e.shadowOpacity),t?.setTexture("shadowTexture",e._getAccumulatedTexture());const s=4*e?.voxelGridSize;i?.scaling.set(s,s,s),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated();}};if(this._snapshotHelper.disableSnapshotRendering(),!n){const e=new r("ibl shadows",this._scene,{resolutionExp:6,sampleDirections:3,ssShadowsEnabled:true,shadowRemanence:.7,triPlanarVoxelization:true},[this._camera]);e.toggleShadow(false);const i=this._scene.getEngine().isWebGPU?1:0,l={attributes:["position","uv"],uniforms:["world","worldView","worldViewProjection","view","projection","renderTargetSize","shadowOpacity"],samplers:["shadowTexture"],shaderLanguage:i,extraInitializationsAsync:async()=>{1===i?await Promise.all([Promise.resolve().then(function(){return envShadowGround_vertexC1y0EEHZ_esm_min}),Promise.resolve().then(function(){return envShadowGround_fragmentR7HvuC7k_esm_min})]):await Promise.all([Promise.resolve().then(function(){return envShadowGround_vertexD5GmKrpO_esm_min}),Promise.resolve().then(function(){return envShadowGround_fragmentDcw3WIFt_esm_min})]);}},c=new t("envShadowGroundMaterial",this._scene,"envShadowGround",l);c.alphaMode=Qe$1.ALPHA_MULTIPLY,c.alpha=.99,h(),e.onShadowTextureReadyObservable.addOnce(h);const u=this._engine.onResizeObservable.add((()=>{h(),e?.resetAccumulation(),this._startIblShadowsRenderTime();}));this._camera.onViewMatrixChangedObservable.add((()=>{this._startIblShadowsRenderTime();}));const d=s("envShadowGround",{radius:o,tessellation:64},this._scene);d.setEnabled(false),d.rotation.x=Math.PI/2,d.position.y=a.extents.min[1],d.material=c,n={pipeline:e,groundMaterial:c,resizeObserver:u,shouldRender:true,ground:d};}n.pipeline.clearShadowCastingMeshes(),n.pipeline.clearShadowReceivingMaterials();for(const e of this._loadedModelsBacking){const t=e.assetContainer.meshes;for(const e of t)e instanceof Er$1&&(n.pipeline.addShadowCastingMesh(e),e.material&&n.pipeline.addShadowReceivingMaterial(e.material));}n.pipeline.onVoxelizationCompleteObservable.addOnce((()=>{this._snapshotHelper.disableSnapshotRendering(),h(),n.pipeline.toggleShadow(true),n.ground.setEnabled(true),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated();})),n.ground.position.y=a.extents.min[1],n.pipeline.updateSceneBounds(),n.pipeline.updateVoxelization(),n.pipeline.resetAccumulation(),this._shadowState.normal?.ground.setEnabled(false),this._startIblShadowsRenderTime(),this._shadowState.high=n,this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated();}async _findIblDominantDirection(e){return this._reflectionTexture&&e.iblSource!==this._reflectionTexture&&(e.iblSource=this._reflectionTexture,await e.renderWhenReady()),await e.findDominantDirection()}async _updateShadowMap(e){const[{CreateDisc:t},{RenderTargetTexture:i},{ShadowGenerator:s},{IblCdfGenerator:r}]=await Promise.all([Promise.resolve().then(function(){return discBuilderD9KLnRbJ_esm_min}),Promise.resolve().then((function(){return da})),Promise.resolve().then((function(){return ao})),Promise.resolve().then(function(){return iblCdfGeneratorNqPZwQCt_esm_min}).then((function(e){return e.i})),Promise.resolve().then(function(){return iblCdfGeneratorSceneComponentDJa78QH7_esm_min}),Promise.resolve().then(function(){return shadowGeneratorSceneComponentBUSilCQf_esm_min})]);this._throwIfDisposedOrAborted(e,this._loadModelAbortController?.signal,this._loadEnvironmentAbortController?.signal);let n=this._shadowState.normal;const a=xc(this._loadedModelsBacking);if(!a)return n?.ground.setEnabled(false),void this._log("No models loaded, cannot create shadows.");const o=te$4.FromArray(a.size).length();if("normal"!==this._shadowQuality)return;const h=n?.iblDirection.iblCdfGenerator?n?.iblDirection.iblCdfGenerator:new r(this._engine),l=await this._findIblDominantDirection(h);this._throwIfDisposedOrAborted(e,this._loadModelAbortController?.signal,this._loadEnvironmentAbortController?.signal),this._snapshotHelper.disableSnapshotRendering();const c=20*o,u=3*o,d=l?U$5(l.length(),0,1):.5;if(!n){const e=new fn("shadowMapDirectionalLight",te$4.Zero(),this._scene);e.autoUpdateExtends=false;const r=new s(4096,e);r.setDarkness(N$c(.8,.2,d)),r.setTransparencyShadow(true),r.filteringQuality=s.QUALITY_HIGH,r.useBlurExponentialShadowMap=true,r.enableSoftTransparentShadow=true,r.bias=o/1e3,r.useKernelBlur=true,r.blurKernel=Math.floor(N$c(64,8,d));const _=r.getShadowMap();_&&(_.refreshRate=i.REFRESHRATE_RENDER_ONEVERYFRAME,_.renderList=this._scene.meshes.slice());const f=new yh("shadowMapGroundMaterial",this._scene);f.shadowOnly=true,f.primaryColor=ge$3.Black();const p=t("shadowMapGround",{radius:c,tessellation:64},this._scene);p.rotation.x=Math.PI/2,p.receiveShadows=true,p.position.y=a.extents.min[1],p.material=f;const g=n={light:e,generator:r,ground:p,shouldRender:true,iblDirection:{iblCdfGenerator:h,positionFactor:u,direction:l},refreshLightPositionDirection(e){let t=this.iblDirection.direction.normalizeToNew();this.light.getScene().useRightHandedSystem&&(t.z*=-1);const i=re$5.RotationY(-1*e);t=te$4.TransformCoordinates(t,i),this.light.position=t.scale(this.iblDirection.positionFactor),this.light.direction=function(e){const t=e.clone();return t.y>0&&(t.y*=-1),t.y>-0.01&&(t.y=Math.min(10*t.y,-0.05)),t}(t.negate());}};await new Promise(((e,t)=>{Rt$1((()=>_.isReadyForRendering()),(()=>e(void 0)),(()=>t(new Error("Failed to get shadow map generator ready"))));})),r.onAfterShadowMapRenderObservable.addOnce((()=>{g.shouldRender=false;}));}n.iblDirection.direction=l,n.iblDirection.positionFactor=u,n.refreshLightPositionDirection(this._reflectionsRotation),n.light.shadowFrustumSize=4*o;for(const e of this._loadedModelsBacking)for(const t of e.assetContainer.meshes)n.generator.addShadowCaster(t,false),t.receiveShadows=true;n.ground.position.y=a.extents.min[1],n.ground.scaling.set(c,c,c),this._shadowState.high?.ground.setEnabled(false),this._shadowState.high?.pipeline.toggleShadow(false),n.ground.setEnabled(true),this._shadowState.normal=n,this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated();}_disposeShadows(){if(this._snapshotHelper.disableSnapshotRendering(),!this._shadowState)return;for(const e of this._loadedModelsBacking){const t=e.assetContainer.meshes,i=e.assetContainer.meshes[0];this._shadowState.normal?.generator.removeShadowCaster(i,true),i.receiveShadows=false;for(const e of t)e instanceof Er$1&&(this._shadowState.high?.pipeline.removeShadowCastingMesh(e),e.material&&this._shadowState.high?.pipeline.removeShadowReceivingMaterial(e.material));}const e=this._shadowState.high,t=this._shadowState.normal;t&&(t.generator.dispose(),t.light.dispose(),t.ground.dispose(true,true),t.iblDirection.iblCdfGenerator.dispose(),this._scene.removeMesh(t.ground)),e&&(e.resizeObserver.remove(),e.pipeline.dispose(),e.ground.dispose(true,true),this._scene.removeMesh(e.ground),e.renderTimer&&clearTimeout(e.renderTimer)),delete this._shadowState.normal,delete this._shadowState.high,this.onShadowsConfigurationChanged.clear(),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated();}async loadEnvironment(e,t,i){await this._updateEnvironment(e,t,i);}async resetEnvironment(e,t){const i=[];if(e?.lighting&&this._scene.materials.some((e=>e instanceof gl))){const s={...e,skybox:false};e={...e,lighting:false},i.push(this._updateEnvironment("auto",s,t));}i.push(this._updateEnvironment(void 0,e,t)),await Promise.all(i);}_setEnvironmentLighting(e){this._reflectionTexture=e,this._scene.environmentTexture=this._reflectionTexture,this._reflectionTexture.level=this.environmentConfig.intensity,this._reflectionTexture.rotationY=this.environmentConfig.rotation;}_setEnvironmentSkybox(e){this._skyboxTexture=e,this._skyboxTexture.level=this.environmentConfig.intensity,this._skyboxTexture.rotationY=this.environmentConfig.rotation,this._skybox=function(e,t,i,s){const r=e.blockMaterialDirtyMechanism;e.blockMaterialDirtyMechanism=true;try{const r=yl("hdrSkyBox",{sideOrientation:Er$1.BACKSIDE},e),n=new yh("skyBox",e);return n.imageProcessingConfiguration=new En,n.reflectionTexture=i,i.coordinatesMode=Is.SKYBOX_MODE,n.reflectionBlur=s,r.material=n,r.isPickable=!1,r.infiniteDistance=!0,r.applyFog=!1,bc(r,t),r}finally{e.blockMaterialDirtyMechanism=r;}}(this._scene,this._camera,this._skyboxTexture,this.environmentConfig.blur),this._skybox.setEnabled(true),this._snapshotHelper.fixMeshes([this._skybox]),this._updateAutoClear();}async _updateEnvironment(e,t=Cc,i){if(this._throwIfDisposedOrAborted(i),!t.lighting&&!t.skybox)return;e=e?.trim(),"auto"===e&&(t={...t,extension:".env"}),this._loadEnvironmentAbortController?.abort(new Ne$1("New environment is being loaded before previous environment finished loading."));const s=this._loadEnvironmentAbortController=new AbortController;await this._loadEnvironmentLock.lockAsync((async()=>{Ac(i,s.signal);const r=async()=>(await Promise.resolve().then(function(){return defaultEnvironmentDPUnnTO0_esm_min})).default,n=async e=>{await new Promise(((t,i)=>{const s=e.onLoadObservable.addOnce((()=>{r.remove(),t();})),r=Is.OnTextureLoadErrorObservable.add((t=>{t===e&&(s.remove(),r.remove(),i(new Error("Failed to load environment texture.")));}));}));},a=e?"auto"===e?"auto":"url":"none";this._environmentLightingMode=t.lighting?a:this._environmentLightingMode,this._environmentSkyboxMode=t.skybox?a:this._environmentSkyboxMode;let o=this._reflectionTexture?.url,h=this._skyboxTexture?.url;this._snapshotHelper.disableSnapshotRendering();try{"auto"===this._environmentLightingMode&&"auto"===this._environmentSkyboxMode?o=h=await r():("auto"!==this._environmentLightingMode&&t.lighting&&(o=e),"auto"!==this._environmentSkyboxMode&&t.skybox&&(h=e),"auto"===this._environmentLightingMode&&(o=h??await r()),"auto"===this._environmentSkyboxMode&&(h=o??await r()));const i=[];if(o!==this._reflectionTexture?.url&&(this._reflectionTexture?.dispose(),this._reflectionTexture=null,this._scene.environmentTexture=null,o))if(o===this._skyboxTexture?.url)this._setEnvironmentLighting(this._skyboxTexture.clone());else {const e=await Rc(o,this._scene,t.extension);i.push(n(e)),this._setEnvironmentLighting(e);}if(h!==this._skyboxTexture?.url&&(this._skybox?.dispose(void 0,!0),this._skyboxTexture=null,this._skybox=null,this._updateAutoClear(),h))if(h===this._reflectionTexture?.url)this._setEnvironmentSkybox(this._reflectionTexture.clone());else {const e=await Rc(h,this._scene,t.extension);i.push(n(e)),this._setEnvironmentSkybox(e);}await Promise.all(i),this._updateLight(),Mc(this._updateShadows()),this.onEnvironmentChanged.notifyObservers();}catch(e){throw this.onEnvironmentError.notifyObservers(e),e}finally{this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated();}}));}toggleAnimation(){this.isAnimationPlaying?this.pauseAnimation():this.playAnimation();}playAnimation(){this._activeAnimation?.play(true);}async pauseAnimation(){this._activeAnimation?.pause();}resetCamera(e){null==e&&(e=this.selectedAnimation!==(this._options?.selectedAnimation??0)),e?this._reframeCamera(true):this._reset(true,"camera");}updateCamera(e){this._reframeCameraFromBounds(true,this._loadedModels,e.alpha??NaN,e.beta??NaN,e.radius??NaN,e.targetX??NaN,e.targetY??NaN,e.targetZ??NaN);}reset(...e){this._reset(true,...e);}_reset(e,...t){if((0===t.length||t.includes("source"))&&Mc(this._updateModel(this._options?.source)),(0===t.length||t.includes("environment"))&&(this._scene.clearColor=new me$3(...this._options?.clearColor??Ic.clearColor),this.environmentConfig={intensity:this._options?.environmentConfig?.intensity??Ic.environmentConfig.intensity,blur:this._options?.environmentConfig?.blur??Ic.environmentConfig.blur,rotation:this._options?.environmentConfig?.rotation??Ic.environmentConfig.rotation},this._options?.environmentLighting===this._options?.environmentSkybox?Mc(this._updateEnvironment(this._options?.environmentLighting,{lighting:true,skybox:true})):(Mc(this._updateEnvironment(this._options?.environmentLighting,{lighting:true})),Mc(this._updateEnvironment(this._options?.environmentSkybox,{skybox:true})))),(0===t.length||t.includes("shadow"))&&(this._shadowQuality=this._options?.shadowConfig?.quality??Ic.shadowConfig.quality,Mc(this.updateShadows({quality:this._shadowQuality}))),(0===t.length||t.includes("animation"))&&(this.animationSpeed=this._options?.animationSpeed??Ic.animationSpeed,this.selectedAnimation=this._options?.selectedAnimation??0,this._options?.animationAutoPlay?this.playAnimation():this.pauseAnimation()),0===t.length||t.includes("camera")){const t=Number(this._options?.cameraOrbit?.[0]),i=Number(this._options?.cameraOrbit?.[1]),s=Number(this._options?.cameraOrbit?.[2]),r=Number(this._options?.cameraTarget?.[0]),n=Number(this._options?.cameraTarget?.[1]),a=Number(this._options?.cameraTarget?.[2]);this._reframeCameraFromBounds(e,this._loadedModels,isNaN(t)?void 0:t,isNaN(i)?void 0:i,isNaN(s)?void 0:s,isNaN(r)?void 0:r,isNaN(n)?void 0:n,isNaN(a)?void 0:a),this.cameraAutoOrbit={enabled:this._options?.cameraAutoOrbit?.enabled??Ic.cameraAutoOrbit.enabled,speed:this._options?.cameraAutoOrbit?.speed??Ic.cameraAutoOrbit.speed,delay:this._options?.cameraAutoOrbit?.delay??Ic.cameraAutoOrbit.delay};}(0===t.length||t.includes("post-processing"))&&(this.postProcessing={toneMapping:this._options?.postProcessing?.toneMapping??Ic.postProcessing.toneMapping,contrast:this._options?.postProcessing?.contrast??Ic.postProcessing.contrast,exposure:this._options?.postProcessing?.exposure??Ic.postProcessing.exposure,ssao:this._options?.postProcessing?.ssao??Ic.postProcessing.ssao}),(0===t.length||t.includes("material-variant"))&&(this.selectedMaterialVariant=this._options?.selectedMaterialVariant??null);}dispose(){this.selectedAnimation=-1,this.animationProgress=0,this._loadEnvironmentAbortController?.abort(new Ne$1("Thew viewer is being disposed.")),this._loadModelAbortController?.abort(new Ne$1("Thew viewer is being disposed.")),this._camerasAsHotSpotsAbortController?.abort(new Ne$1("Thew viewer is being disposed.")),this._shadowsAbortController?.abort(new Ne$1("Thew viewer is being disposed.")),this._renderLoopController?.dispose(),this._activeModel?.dispose(),this._loadedModelsBacking.forEach((e=>e.dispose())),this._disposeShadows(),this._scene.dispose(),this.onEnvironmentChanged.clear(),this.onEnvironmentError.clear(),this.onEnvironmentConfigurationChanged.clear(),this.onPostProcessingChanged.clear(),this.onModelChanged.clear(),this.onModelError.clear(),this.onCameraAutoOrbitChanged.clear(),this.onSelectedAnimationChanged.clear(),this.onAnimationSpeedChanged.clear(),this.onIsAnimationPlayingChanged.clear(),this.onAnimationProgressChanged.clear(),this.onSelectedMaterialVariantChanged.clear(),this.onHotSpotsChanged.clear(),this.onCamerasAsHotSpotsChanged.clear(),this.onLoadingProgressChanged.clear(),this._imageProcessingConfigurationObserver.remove(),this._beforeRenderObserver.remove(),this._isDisposed=true;}getHotSpotToRef(e,t){return this._activeModel?.getHotSpotToRef(e,t)??false}_getHotSpotToRef(e,t,i){const s=this._tempVectors[2],r=this._tempVectors[1],n=this._tempVectors[0];if("surface"===t.type){const i=e?.meshes[t.meshIndex];if(!i)return  false;if(!function(e,t,i,s){i.set(0,0,0);for(let s=0;s<3;s++){if(!Al(e,t.pointIndex[s],ae$5.Vector3[s]))return  false;ae$5.Vector3[s].scaleAndAddToRef(t.barycentric[s],i);}if(te$4.TransformCoordinatesToRef(i,e.getWorldMatrix(),i),s){const t=ae$5.Vector3[0],i=ae$5.Vector3[1],r=ae$5.Vector3[2],n=ae$5.Vector3[3],a=ae$5.Vector3[4];n.copyFrom(i),n.subtractInPlace(t),a.copyFrom(r),a.subtractInPlace(t),n.normalize(),a.normalize(),te$4.CrossToRef(n,a,s),e.material&&e.material.sideOrientation===(e.getScene().useRightHandedSystem?Qe$1.MATERIAL_ClockWiseSideOrientation:Qe$1.MATERIAL_CounterClockWiseSideOrientation)&&s.scaleInPlace(-1),te$4.TransformNormalToRef(s,e.getWorldMatrix(),s),s.normalize();}return  true}(i,t,r,s))return  false}else r.copyFromFloats(t.position[0],t.position[1],t.position[2]),s.copyFromFloats(t.normal[0],t.normal[1],t.normal[2]);const a=this._camera.viewport.width*this._engine.getRenderWidth()*this._engine.getHardwareScalingLevel(),o=this._camera.viewport.height*this._engine.getRenderHeight()*this._engine.getHardwareScalingLevel(),h=this._scene;te$4.ProjectToRef(r,re$5.IdentityReadOnly,h.getTransformMatrix(),new vi(0,0,a,o),n),i.screenPosition[0]=n.x,i.screenPosition[1]=n.y,i.worldPosition[0]=r.x,i.worldPosition[1]=r.y,i.worldPosition[2]=r.z;const l=this._tempVectors[3];return l.copyFrom(this._camera.globalPosition),l.subtractInPlace(r),l.normalize(),i.visibility=te$4.Dot(l,s),true}queryHotSpot(e,t){return null!=this._queryHotSpot(e,t)}focusHotSpot(e){const t=new vc,i=this._queryHotSpot(e,t);if(i){this.pauseAnimation();const e=i.cameraOrbit??[void 0,void 0,void 0];return this._camera.interpolateTo(e[0],e[1],e[2],new te$4(t.worldPosition[0],t.worldPosition[1],t.worldPosition[2])),true}return  false}_queryHotSpot(e,t){const i=this.hotSpots?.[e];return i&&this.getHotSpotToRef(i,t)?i:null}async _addCameraHotSpot(e,t){if(e!==this._camera){const i=await this._createHotSpotFromCamera(e);i&&!t?.aborted&&(this.hotSpots={...this.hotSpots,[`camera-${e.name}`]:i});}}_removeCameraHotSpot(e){delete this.hotSpots[`camera-${e.name}`],this.hotSpots={...this.hotSpots};}_toggleCamerasAsHotSpots(){if(this.camerasAsHotSpots){const e=this._camerasAsHotSpotsAbortController=new AbortController;this._scene.cameras.forEach((async t=>await this._addCameraHotSpot(t,e.signal)));}else this._camerasAsHotSpotsAbortController?.abort(),this._camerasAsHotSpotsAbortController=null,this._scene.cameras.forEach((e=>this._removeCameraHotSpot(e)));}async _createHotSpotFromCamera(e){if(e instanceof un){const t=e.target.asArray();return {type:"world",position:t,normal:t,cameraOrbit:[e.alpha,e.beta,e.radius]}}return this._activeModel?await yc(this._activeModel,e):null}get _shouldRender(){return !this._autoSuspendRendering||this._sceneMutated||!this._snapshotHelper.isReady||this._shadowState.normal?.shouldRender||this._shadowState.high?.shouldRender||this._loadedModelsBacking.some((e=>e._shouldRender()))}_markSceneMutated(){this._sceneMutated=true;}_suspendRendering(){this._renderLoopController?.dispose(),this._suspendRenderCount++;let e=false;return {dispose:()=>{e||(e=true,this._suspendRenderCount--,0===this._suspendRenderCount&&this._beginRendering());}}}_beginRendering(){if(!this._renderLoopController){let e=false;const t=()=>{this._log("Viewer Resumed Rendering"),this._engine.setHardwareScalingLevel(this._lastHardwareScalingLevel),this._engine.performanceMonitor.enable(),this._snapshotHelper.enableSnapshotRendering(),this._startSceneOptimizer();},i=()=>{this._log("Viewer Suspended Rendering"),this._renderedLastFrame=false,e=false,this._lastHardwareScalingLevel=this._engine.getHardwareScalingLevel(),this._stopSceneOptimizer(),this._snapshotHelper.disableSnapshotRendering(),this._engine.performanceMonitor.disable(),this._engine.setHardwareScalingLevel(this._defaultHardwareScalingLevel),this._engine.beginFrame(),this._scene.render(),this._engine.endFrame();},s=()=>{let s=this._shouldRender;s||!this._renderedLastFrame||e||(e=this._scene.isReady(true),s=true),s?(this._renderedLastFrame||(null!==this._renderedLastFrame&&t(),this._renderedLastFrame=true),this._sceneMutated=false,this._scene.render(),this._camera.panningSensibility=5e3/this._camera.radius,this._camera.speed=.2*this._camera.radius,this._camera.inputs.attached.keyboard.zoomingSensibility=500/this._camera.radius,this.isAnimationPlaying&&(this.onAnimationProgressChanged.notifyObservers(),this._autoRotationBehavior.resetLastInteractionTime())):(this._camera.update(),this._renderedLastFrame&&i());};this._engine.runRenderLoop(s);let r=false;this._renderLoopController={dispose:()=>{r||(r=true,this._engine.stopRenderLoop(s),this._renderLoopController=null,this._renderedLastFrame&&i());}};}}_reframeCamera(e=false,t=this._loadedModelsBacking){this._reframeCameraFromBounds(e,t);}_getWorldBounds(e){return xc(e)}_getCameraConfig(e){let t=1,i=te$4.Zero();const s=this._getWorldBounds(e);s&&(this._camera.lowerRadiusLimit=null,t=1.1*te$4.FromArray(s.size).length(),i=te$4.FromArray(s.center),isFinite(t)||(t=1,i.copyFromFloats(0,0,0)));return {radius:t,target:i,lowerRadiusLimit:.001*t,upperRadiusLimit:5*t,minZ:.001*t,maxZ:1e3*t}}_reframeCameraFromBounds(e,t,i,s,r,n,a,o){let h=1;const l=te$4.Zero();let c=Math.PI/2,u=Math.PI/2.4;const{radius:d,target:_,lowerRadiusLimit:f,upperRadiusLimit:p,minZ:g,maxZ:m}=this._getCameraConfig(t);this._camera.lowerRadiusLimit=f,this._camera.upperRadiusLimit=p,this._camera.minZ=g,this._camera.maxZ=m,c=i??c,u=s??u,h=r??d,l.x=n??_.x,l.y=a??_.y,l.z=o??_.z,e?this._camera.interpolateTo(c,u,h,l,void 0,.1):(this._camera.stopInterpolation(),isNaN(c)||(this._camera.alpha=c),isNaN(u)||(this._camera.beta=u),isNaN(h)||(this._camera.radius=h),this._camera.setTarget(new te$4(isNaN(l.x)?this._camera.target.x:l.x,isNaN(l.y)?this._camera.target.y:l.y,isNaN(l.z)?this._camera.target.z:l.z),void 0,void 0,true)),this._camera.wheelDeltaPercentage=.01,this._camera.useNaturalPinchZoom=true,bc(this._skybox,this._camera);}_updateLight(){let e;if(0===this._loadedModels.length)e=false;else {const t=this._loadedModels.some((e=>e.assetContainer.lights.length>0)),i=!!this._reflectionTexture,s=this._loadedModels.some((e=>e.assetContainer.materials.some((e=>!(e instanceof gl)))));e=!t&&(!i||s);}e?this._light||(this._light=new pn("defaultLight",te$4.Up(),this._scene)):(this._light?.dispose(),this._light=null);}_applyAnimationSpeed(){this._activeModel?.assetContainer.animationGroups.forEach((e=>e.speedRatio=this._animationSpeed));}async _pick(e,t){if(await Promise.resolve().then(function(){return rayBVwnQLmQ_esm_min}),this._loadedModels.length>0){const i=this._loadedModelsBacking.flatMap((e=>e.assetContainer.meshes));i.forEach((e=>{let t=this._meshDataCache.get(e);t||(t={},this._meshDataCache.set(e,t)),e.refreshBoundingInfo({applyMorph:true,applySkeleton:true,cache:t});}));const s=this._scene.pick(e,t,(e=>i.includes(e)));if(s.hit)return s}return null}_startSceneOptimizer(e=false){this._stopSceneOptimizer(),e&&this._engine.setHardwareScalingLevel(this._defaultHardwareScalingLevel);const t=new Hl(60,1e3),i=new Fl(void 0,1);t.addOptimization(i),this._sceneOptimizer=new zl(this._scene,t),this._sceneOptimizer.start();}_stopSceneOptimizer(){this._sceneOptimizer?.dispose(),this._sceneOptimizer=null;}_log(e){this.showDebugLogs&&Ie$2.Log(e);}_throwIfDisposedOrAborted(...e){if(this._isDisposed)throw new Error("Viewer is disposed.");Ac(...e);}}pc();
/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
const Oc=globalThis,Dc=Oc.ShadowRoot&&(void 0===Oc.ShadyCSS||Oc.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,Lc=Symbol(),Fc=new WeakMap;let wc=class{constructor(e,t,i){if(this._$cssResult$=true,i!==Lc)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t;}get styleSheet(){let e=this.o;const t=this.t;if(Dc&&void 0===e){const i=void 0!==t&&1===t.length;i&&(e=Fc.get(t)),void 0===e&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),i&&Fc.set(t,e));}return e}toString(){return this.cssText}};const Nc=(e,...t)=>{const i=1===e.length?e[0]:t.reduce(((t,i,s)=>t+(e=>{if(true===e._$cssResult$)return e.cssText;if("number"==typeof e)return e;throw Error("Value passed to 'css' function must be a 'css' function result: "+e+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(i)+e[s+1]),e[0]);return new wc(i,e,Lc)},Bc=Dc?e=>e:e=>e instanceof CSSStyleSheet?(e=>{let t="";for(const i of e.cssRules)t+=i.cssText;return (e=>new wc("string"==typeof e?e:e+"",void 0,Lc))(t)})(e):e,{is:Uc,defineProperty:kc,getOwnPropertyDescriptor:Gc,getOwnPropertyNames:Vc,getOwnPropertySymbols:Hc,getPrototypeOf:zc}=Object,Xc=globalThis,Wc=Xc.trustedTypes,Yc=Wc?Wc.emptyScript:"",Kc=Xc.reactiveElementPolyfillSupport,jc=(e,t)=>e,Qc={toAttribute(e,t){switch(t){case Boolean:e=e?Yc:null;break;case Object:case Array:e=null==e?e:JSON.stringify(e);}return e},fromAttribute(e,t){let i=e;switch(t){case Boolean:i=null!==e;break;case Number:i=null===e?null:Number(e);break;case Object:case Array:try{i=JSON.parse(e);}catch(e){i=null;}}return i}},qc=(e,t)=>!Uc(e,t),Zc={attribute:true,type:String,converter:Qc,reflect:false,useDefault:false,hasChanged:qc};
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */Symbol.metadata??=Symbol("metadata"),Xc.litPropertyMetadata??=new WeakMap;let Jc=class extends HTMLElement{static addInitializer(e){this._$Ei(),(this.l??=[]).push(e);}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(e,t=Zc){if(t.state&&(t.attribute=false),this._$Ei(),this.prototype.hasOwnProperty(e)&&((t=Object.create(t)).wrapped=true),this.elementProperties.set(e,t),!t.noAccessor){const i=Symbol(),s=this.getPropertyDescriptor(e,i,t);void 0!==s&&kc(this.prototype,e,s);}}static getPropertyDescriptor(e,t,i){const{get:s,set:r}=Gc(this.prototype,e)??{get(){return this[t]},set(e){this[t]=e;}};return {get:s,set(t){const n=s?.call(this);r?.call(this,t),this.requestUpdate(e,n,i);},configurable:true,enumerable:true}}static getPropertyOptions(e){return this.elementProperties.get(e)??Zc}static _$Ei(){if(this.hasOwnProperty(jc("elementProperties")))return;const e=zc(this);e.finalize(),void 0!==e.l&&(this.l=[...e.l]),this.elementProperties=new Map(e.elementProperties);}static finalize(){if(this.hasOwnProperty(jc("finalized")))return;if(this.finalized=true,this._$Ei(),this.hasOwnProperty(jc("properties"))){const e=this.properties,t=[...Vc(e),...Hc(e)];for(const i of t)this.createProperty(i,e[i]);}const e=this[Symbol.metadata];if(null!==e){const t=litPropertyMetadata.get(e);if(void 0!==t)for(const[e,i]of t)this.elementProperties.set(e,i);}this._$Eh=new Map;for(const[e,t]of this.elementProperties){const i=this._$Eu(e,t);void 0!==i&&this._$Eh.set(i,e);}this.elementStyles=this.finalizeStyles(this.styles);}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const i=new Set(e.flat(1/0).reverse());for(const e of i)t.unshift(Bc(e));}else void 0!==e&&t.push(Bc(e));return t}static _$Eu(e,t){const i=t.attribute;return  false===i?void 0:"string"==typeof i?i:"string"==typeof e?e.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=false,this.hasUpdated=false,this._$Em=null,this._$Ev();}_$Ev(){this._$ES=new Promise((e=>this.enableUpdating=e)),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach((e=>e(this)));}addController(e){(this._$EO??=new Set).add(e),void 0!==this.renderRoot&&this.isConnected&&e.hostConnected?.();}removeController(e){this._$EO?.delete(e);}_$E_(){const e=new Map,t=this.constructor.elementProperties;for(const i of t.keys())this.hasOwnProperty(i)&&(e.set(i,this[i]),delete this[i]);e.size>0&&(this._$Ep=e);}createRenderRoot(){const e=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return ((e,t)=>{if(Dc)e.adoptedStyleSheets=t.map((e=>e instanceof CSSStyleSheet?e:e.styleSheet));else for(const i of t){const t=document.createElement("style"),s=Oc.litNonce;void 0!==s&&t.setAttribute("nonce",s),t.textContent=i.cssText,e.appendChild(t);}})(e,this.constructor.elementStyles),e}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(true),this._$EO?.forEach((e=>e.hostConnected?.()));}enableUpdating(e){}disconnectedCallback(){this._$EO?.forEach((e=>e.hostDisconnected?.()));}attributeChangedCallback(e,t,i){this._$AK(e,i);}_$ET(e,t){const i=this.constructor.elementProperties.get(e),s=this.constructor._$Eu(e,i);if(void 0!==s&&true===i.reflect){const r=(void 0!==i.converter?.toAttribute?i.converter:Qc).toAttribute(t,i.type);this._$Em=e,null==r?this.removeAttribute(s):this.setAttribute(s,r),this._$Em=null;}}_$AK(e,t){const i=this.constructor,s=i._$Eh.get(e);if(void 0!==s&&this._$Em!==s){const e=i.getPropertyOptions(s),r="function"==typeof e.converter?{fromAttribute:e.converter}:void 0!==e.converter?.fromAttribute?e.converter:Qc;this._$Em=s,this[s]=r.fromAttribute(t,e.type)??this._$Ej?.get(s)??null,this._$Em=null;}}requestUpdate(e,t,i){if(void 0!==e){const s=this.constructor,r=this[e];if(i??=s.getPropertyOptions(e),!((i.hasChanged??qc)(r,t)||i.useDefault&&i.reflect&&r===this._$Ej?.get(e)&&!this.hasAttribute(s._$Eu(e,i))))return;this.C(e,t,i);} false===this.isUpdatePending&&(this._$ES=this._$EP());}C(e,t,{useDefault:i,reflect:s,wrapped:r},n){i&&!(this._$Ej??=new Map).has(e)&&(this._$Ej.set(e,n??t??this[e]),true!==r||void 0!==n)||(this._$AL.has(e)||(this.hasUpdated||i||(t=void 0),this._$AL.set(e,t)),true===s&&this._$Em!==e&&(this._$Eq??=new Set).add(e));}async _$EP(){this.isUpdatePending=true;try{await this._$ES;}catch(e){Promise.reject(e);}const e=this.scheduleUpdate();return null!=e&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(const[e,t]of this._$Ep)this[e]=t;this._$Ep=void 0;}const e=this.constructor.elementProperties;if(e.size>0)for(const[t,i]of e){const{wrapped:e}=i,s=this[t];true!==e||this._$AL.has(t)||void 0===s||this.C(t,void 0,i,s);}}let e=false;const t=this._$AL;try{e=this.shouldUpdate(t),e?(this.willUpdate(t),this._$EO?.forEach((e=>e.hostUpdate?.())),this.update(t)):this._$EM();}catch(t){throw e=false,this._$EM(),t}e&&this._$AE(t);}willUpdate(e){}_$AE(e){this._$EO?.forEach((e=>e.hostUpdated?.())),this.hasUpdated||(this.hasUpdated=true,this.firstUpdated(e)),this.updated(e);}_$EM(){this._$AL=new Map,this.isUpdatePending=false;}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(e){return  true}update(e){this._$Eq&&=this._$Eq.forEach((e=>this._$ET(e,this[e]))),this._$EM();}updated(e){}firstUpdated(e){}};Jc.elementStyles=[],Jc.shadowRootOptions={mode:"open"},Jc[jc("elementProperties")]=new Map,Jc[jc("finalized")]=new Map,Kc?.({ReactiveElement:Jc}),(Xc.reactiveElementVersions??=[]).push("2.1.0");
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
const $c=globalThis,eu=$c.trustedTypes,tu=eu?eu.createPolicy("lit-html",{createHTML:e=>e}):void 0,iu="$lit$",su=`lit$${Math.random().toFixed(9).slice(2)}$`,ru="?"+su,nu=`<${ru}>`,au=document,ou=()=>au.createComment(""),hu=e=>null===e||"object"!=typeof e&&"function"!=typeof e,lu=Array.isArray,cu="[ \t\n\f\r]",uu=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,du=/-->/g,_u=/>/g,fu=RegExp(`>|${cu}(?:([^\\s"'>=/]+)(${cu}*=${cu}*(?:[^ \t\n\f\r"'\`<>=]|("|')|))|$)`,"g"),pu=/'/g,gu=/"/g,mu=/^(?:script|style|textarea|title)$/i,Tu=(e=>(t,...i)=>({_$litType$:e,strings:t,values:i}))(1),Eu=Symbol.for("lit-noChange"),Au=Symbol.for("lit-nothing"),Ru=new WeakMap,bu=au.createTreeWalker(au,129);function Su(e,t){if(!lu(e)||!e.hasOwnProperty("raw"))throw Error("invalid template strings array");return void 0!==tu?tu.createHTML(t):t}const xu=(e,t)=>{const i=e.length-1,s=[];let r,n=2===t?"<svg>":3===t?"<math>":"",a=uu;for(let t=0;t<i;t++){const i=e[t];let o,h,l=-1,c=0;for(;c<i.length&&(a.lastIndex=c,h=a.exec(i),null!==h);)c=a.lastIndex,a===uu?"!--"===h[1]?a=du:void 0!==h[1]?a=_u:void 0!==h[2]?(mu.test(h[2])&&(r=RegExp("</"+h[2],"g")),a=fu):void 0!==h[3]&&(a=fu):a===fu?">"===h[0]?(a=r??uu,l=-1):void 0===h[1]?l=-2:(l=a.lastIndex-h[2].length,o=h[1],a=void 0===h[3]?fu:'"'===h[3]?gu:pu):a===gu||a===pu?a=fu:a===du||a===_u?a=uu:(a=fu,r=void 0);const u=a===fu&&e[t+1].startsWith("/>")?" ":"";n+=a===uu?i+nu:l>=0?(s.push(o),i.slice(0,l)+iu+i.slice(l)+su+u):i+su+(-2===l?t:u);}return [Su(e,n+(e[i]||"<?>")+(2===t?"</svg>":3===t?"</math>":"")),s]};class Mu{constructor({strings:e,_$litType$:t},i){let s;this.parts=[];let r=0,n=0;const a=e.length-1,o=this.parts,[h,l]=xu(e,t);if(this.el=Mu.createElement(h,i),bu.currentNode=this.el.content,2===t||3===t){const e=this.el.content.firstChild;e.replaceWith(...e.childNodes);}for(;null!==(s=bu.nextNode())&&o.length<a;){if(1===s.nodeType){if(s.hasAttributes())for(const e of s.getAttributeNames())if(e.endsWith(iu)){const t=l[n++],i=s.getAttribute(e).split(su),a=/([.?@])?(.*)/.exec(t);o.push({type:1,index:r,name:a[2],strings:i,ctor:"."===a[1]?Pu:"?"===a[1]?Ou:"@"===a[1]?Du:vu}),s.removeAttribute(e);}else e.startsWith(su)&&(o.push({type:6,index:r}),s.removeAttribute(e));if(mu.test(s.tagName)){const e=s.textContent.split(su),t=e.length-1;if(t>0){s.textContent=eu?eu.emptyScript:"";for(let i=0;i<t;i++)s.append(e[i],ou()),bu.nextNode(),o.push({type:2,index:++r});s.append(e[t],ou());}}}else if(8===s.nodeType)if(s.data===ru)o.push({type:2,index:r});else {let e=-1;for(;-1!==(e=s.data.indexOf(su,e+1));)o.push({type:7,index:r}),e+=su.length-1;}r++;}}static createElement(e,t){const i=au.createElement("template");return i.innerHTML=e,i}}function yu(e,t,i=e,s){if(t===Eu)return t;let r=void 0!==s?i._$Co?.[s]:i._$Cl;const n=hu(t)?void 0:t._$litDirective$;return r?.constructor!==n&&(r?._$AO?.(false),void 0===n?r=void 0:(r=new n(e),r._$AT(e,i,s)),void 0!==s?(i._$Co??=[])[s]=r:i._$Cl=r),void 0!==r&&(t=yu(e,r._$AS(e,t.values),r,s)),t}class Iu{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t;}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){const{el:{content:t},parts:i}=this._$AD,s=(e?.creationScope??au).importNode(t,true);bu.currentNode=s;let r=bu.nextNode(),n=0,a=0,o=i[0];for(;void 0!==o;){if(n===o.index){let t;2===o.type?t=new Cu(r,r.nextSibling,this,e):1===o.type?t=new o.ctor(r,o.name,o.strings,this,e):6===o.type&&(t=new Lu(r,this,e)),this._$AV.push(t),o=i[++a];}n!==o?.index&&(r=bu.nextNode(),n++);}return bu.currentNode=au,s}p(e){let t=0;for(const i of this._$AV) void 0!==i&&(void 0!==i.strings?(i._$AI(e,i,t),t+=i.strings.length-2):i._$AI(e[t])),t++;}}class Cu{get _$AU(){return this._$AM?._$AU??this._$Cv}constructor(e,t,i,s){this.type=2,this._$AH=Au,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=i,this.options=s,this._$Cv=s?.isConnected??true;}get parentNode(){let e=this._$AA.parentNode;const t=this._$AM;return void 0!==t&&11===e?.nodeType&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=yu(this,e,t),hu(e)?e===Au||null==e||""===e?(this._$AH!==Au&&this._$AR(),this._$AH=Au):e!==this._$AH&&e!==Eu&&this._(e):void 0!==e._$litType$?this.$(e):void 0!==e.nodeType?this.T(e):(e=>lu(e)||"function"==typeof e?.[Symbol.iterator])(e)?this.k(e):this._(e);}O(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}T(e){this._$AH!==e&&(this._$AR(),this._$AH=this.O(e));}_(e){this._$AH!==Au&&hu(this._$AH)?this._$AA.nextSibling.data=e:this.T(au.createTextNode(e)),this._$AH=e;}$(e){const{values:t,_$litType$:i}=e,s="number"==typeof i?this._$AC(e):(void 0===i.el&&(i.el=Mu.createElement(Su(i.h,i.h[0]),this.options)),i);if(this._$AH?._$AD===s)this._$AH.p(t);else {const e=new Iu(s,this),i=e.u(this.options);e.p(t),this.T(i),this._$AH=e;}}_$AC(e){let t=Ru.get(e.strings);return void 0===t&&Ru.set(e.strings,t=new Mu(e)),t}k(e){lu(this._$AH)||(this._$AH=[],this._$AR());const t=this._$AH;let i,s=0;for(const r of e)s===t.length?t.push(i=new Cu(this.O(ou()),this.O(ou()),this,this.options)):i=t[s],i._$AI(r),s++;s<t.length&&(this._$AR(i&&i._$AB.nextSibling,s),t.length=s);}_$AR(e=this._$AA.nextSibling,t){for(this._$AP?.(false,true,t);e&&e!==this._$AB;){const t=e.nextSibling;e.remove(),e=t;}}setConnected(e){ void 0===this._$AM&&(this._$Cv=e,this._$AP?.(e));}}class vu{get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}constructor(e,t,i,s,r){this.type=1,this._$AH=Au,this._$AN=void 0,this.element=e,this.name=t,this._$AM=s,this.options=r,i.length>2||""!==i[0]||""!==i[1]?(this._$AH=Array(i.length-1).fill(new String),this.strings=i):this._$AH=Au;}_$AI(e,t=this,i,s){const r=this.strings;let n=false;if(void 0===r)e=yu(this,e,t,0),n=!hu(e)||e!==this._$AH&&e!==Eu,n&&(this._$AH=e);else {const s=e;let a,o;for(e=r[0],a=0;a<r.length-1;a++)o=yu(this,s[i+a],t,a),o===Eu&&(o=this._$AH[a]),n||=!hu(o)||o!==this._$AH[a],o===Au?e=Au:e!==Au&&(e+=(o??"")+r[a+1]),this._$AH[a]=o;}n&&!s&&this.j(e);}j(e){e===Au?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,e??"");}}class Pu extends vu{constructor(){super(...arguments),this.type=3;}j(e){this.element[this.name]=e===Au?void 0:e;}}class Ou extends vu{constructor(){super(...arguments),this.type=4;}j(e){this.element.toggleAttribute(this.name,!!e&&e!==Au);}}class Du extends vu{constructor(e,t,i,s,r){super(e,t,i,s,r),this.type=5;}_$AI(e,t=this){if((e=yu(this,e,t,0)??Au)===Eu)return;const i=this._$AH,s=e===Au&&i!==Au||e.capture!==i.capture||e.once!==i.once||e.passive!==i.passive,r=e!==Au&&(i===Au||s);s&&this.element.removeEventListener(this.name,this,i),r&&this.element.addEventListener(this.name,this,e),this._$AH=e;}handleEvent(e){"function"==typeof this._$AH?this._$AH.call(this.options?.host??this.element,e):this._$AH.handleEvent(e);}}class Lu{constructor(e,t,i){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=i;}get _$AU(){return this._$AM._$AU}_$AI(e){yu(this,e);}}const Fu=$c.litHtmlPolyfillSupport;Fu?.(Mu,Cu),($c.litHtmlVersions??=[]).push("3.3.0");const wu=globalThis;
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */let Nu=class extends Jc{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0;}createRenderRoot(){const e=super.createRenderRoot();return this.renderOptions.renderBefore??=e.firstChild,e}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=((e,t,i)=>{const s=i?.renderBefore??t;let r=s._$litPart$;if(void 0===r){const e=i?.renderBefore??null;s._$litPart$=r=new Cu(t.insertBefore(ou(),e),e,void 0,i??{});}return r._$AI(e),r})(t,this.renderRoot,this.renderOptions);}connectedCallback(){super.connectedCallback(),this._$Do?.setConnected(true);}disconnectedCallback(){super.disconnectedCallback(),this._$Do?.setConnected(false);}render(){return Eu}};Nu._$litElement$=true,Nu.finalized=true,wu.litElementHydrateSupport?.({LitElement:Nu});const Bu=wu.litElementPolyfillSupport;Bu?.({LitElement:Nu}),(wu.litElementVersions??=[]).push("4.2.0");
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
const Uu=e=>(t,i)=>{ void 0!==i?i.addInitializer((()=>{customElements.define(e,t);})):customElements.define(e,t);},ku={attribute:true,type:String,converter:Qc,reflect:false,hasChanged:qc},Gu=(e=ku,t,i)=>{const{kind:s,metadata:r}=i;let n=globalThis.litPropertyMetadata.get(r);if(void 0===n&&globalThis.litPropertyMetadata.set(r,n=new Map),"setter"===s&&((e=Object.create(e)).wrapped=true),n.set(i.name,e),"accessor"===s){const{name:s}=i;return {set(i){const r=t.get.call(this);t.set.call(this,i),this.requestUpdate(s,r,e);},init(t){return void 0!==t&&this.C(s,void 0,e,t),t}}}if("setter"===s){const{name:s}=i;return function(i){const r=this[s];t.call(this,i),this.requestUpdate(s,r,e);}}throw Error("Unsupported decorator location: "+s)};
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function Vu(e){return (t,i)=>"object"==typeof i?Gu(e,t,i):((e,t,i)=>{const s=t.hasOwnProperty(i);return t.constructor.createProperty(i,e),s?Object.getOwnPropertyDescriptor(t,i):void 0})(e,t,i)}
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function Hu(e){return Vu({...e,state:true,attribute:false})}
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
function zu(e,t){return (t,i,s)=>((e,t,i)=>(i.configurable=true,i.enumerable=true,Reflect.decorate&&"object"!=typeof t&&Object.defineProperty(e,t,i),i))(t,i,{get(){return (t=>t.renderRoot?.querySelector(e)??null)(this)}})}
/**
 * @license
 * Copyright 2020 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const Xu=2;
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */class Wu{constructor(e){}get _$AU(){return this._$AM._$AU}_$AT(e,t,i){this._$Ct=e,this._$AM=t,this._$Ci=i;}_$AS(e,t){return this.update(e,t)}update(e,t){return this.render(...t)}}
/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const Yu=(e,t)=>{const i=e._$AN;if(void 0===i)return  false;for(const e of i)e._$AO?.(t,false),Yu(e,t);return  true},Ku=e=>{let t,i;do{if(void 0===(t=e._$AM))break;i=t._$AN,i.delete(e),e=t;}while(0===i?.size)},ju=e=>{for(let t;t=e._$AM;e=t){let i=t._$AN;if(void 0===i)t._$AN=i=new Set;else if(i.has(e))break;i.add(e),Zu(t);}};function Qu(e){ void 0!==this._$AN?(Ku(this),this._$AM=e,ju(this)):this._$AM=e;}function qu(e,t=false,i=0){const s=this._$AH,r=this._$AN;if(void 0!==r&&0!==r.size)if(t)if(Array.isArray(s))for(let e=i;e<s.length;e++)Yu(s[e],false),Ku(s[e]);else null!=s&&(Yu(s,false),Ku(s));else Yu(this,e);}const Zu=e=>{e.type==Xu&&(e._$AP??=qu,e._$AQ??=Qu);};class Ju extends Wu{constructor(){super(...arguments),this._$AN=void 0;}_$AT(e,t,i){super._$AT(e,t,i),ju(this),this.isConnected=e._$AU;}_$AO(e,t=true){e!==this.isConnected&&(this.isConnected=e,e?this.reconnected?.():this.disconnected?.()),t&&(Yu(this,e),Ku(this));}setValue(e){if((e=>void 0===e.strings)(this._$Ct))this._$Ct._$AI(e,this);else {const t=[...this._$Ct._$AH];t[this._$Ci]=e,this._$Ct._$AI(t,this,0);}}disconnected(){}reconnected(){}}const $u=new WeakMap,ed=(e=>(...t)=>({_$litDirective$:e,values:t}))(class extends Ju{render(e){return Au}update(e,[t]){const i=t!==this.G;return i&&void 0!==this.G&&this.rt(void 0),(i||this.lt!==this.ct)&&(this.G=t,this.ht=e.options?.host,this.rt(this.ct=e.element)),Au}rt(e){if(this.isConnected||(e=void 0),"function"==typeof this.G){const t=this.ht??globalThis;let i=$u.get(t);void 0===i&&(i=new WeakMap,$u.set(t,i)),void 0!==i.get(this.G)&&this.G.call(this.ht,void 0),i.set(this.G,e),void 0!==e&&this.G.call(this.ht,e);}else this.G.value=e;}get lt(){return "function"==typeof this.G?$u.get(this.ht??globalThis)?.get(this.G):this.G?.value}disconnected(){this.lt===this.ct&&this.rt(void 0);}reconnected(){this.rt(this.ct);}}),td=true,id=true,sd=true,rd=true;async function nd(e,t={}){const i=new Cl;t=new Proxy(t,{get(e,t){switch(t){case "antialias":return e.antialias??td;case "adaptToDeviceRatio":return e.adaptToDeviceRatio??id;case "enableAllFeatures":return e.enableAllFeatures??sd;case "setMaximumLimits":return e.setMaximumLimits??rd;case "onInitialized":return t=>{e.onInitialized?.(t),i.resolve(t);};default:return e[t]}}});const s=[];let r;switch(t.engine??("gpu"in navigator&&"chrome"in window?"WebGPU":"WebGL")){case "WebGL":{const{Engine:i}=await Promise.resolve().then((function(){return to}));r=new i(e,void 0,t);break}case "WebGPU":{const{WebGPUEngine:i}=await Promise.resolve().then(function(){return webgpuEngine5o0Cwobe_esm_min}),s=new i(e,t);await s.initAsync(),r=s;break}}if(t.onFaulted){const e=t.onFaulted,i=r.onContextLostObservable.addOnce((()=>{e(new Error("The engine context was lost."));}));s.push((()=>i.remove()));}const n=new(t?.viewerClass??Pc)(r,t);{const t=await i.promise;let n=false;const a=new ResizeObserver((()=>{n=true,t.markSceneMutated();}));a.observe(e),s.push((()=>a.disconnect()));const o=t.scene.onBeforeRenderObservable.add((()=>{n&&(r.resize(),n=false);}));s.push((()=>o.remove()));let h=null;const l=new IntersectionObserver((e=>{e.length>0&&(e[e.length-1].isIntersecting?(h?.dispose(),h=null):h=t.suspendRendering());}));l.observe(e),s.push((()=>l.disconnect()));}return s.push(n.dispose.bind(n)),s.push((()=>r.dispose())),n.dispose=()=>s.forEach((e=>e())),n}const ad=[.5,1,1.5,2];function od(e){return null==e?null:Number(e)}function hd(e){if(!e)return null;const t=e.trim().split(/\s+/);if(3!==t.length)throw new Error(`Camera orbit and target should be defined as three space separated numbers, but was specified as "${e}".`);return t.map((e=>Number(e)))}function ld(e){return e&&function(e){return mc.includes(e)}(e)?e:null}class cd extends Nu{constructor(e,t={}){super(),this._viewerClass=e,this._options=t,this._viewerLock=new vl,this._animationSliderResizeObserver=null,this._propertyBindings=[this._createPropertyBinding("clearColor",(e=>e.scene.onClearColorChangedObservable),(e=>e.scene.clearColor=this.clearColor??new me$3(0,0,0,0)),(e=>this.clearColor=e.scene.clearColor)),this._createPropertyBinding("skyboxBlur",(e=>e.viewer.onEnvironmentConfigurationChanged),(e=>e.viewer.environmentConfig={blur:this.skyboxBlur??e.viewer.environmentConfig.blur}),(e=>this.skyboxBlur=e.viewer.environmentConfig.blur)),this._createPropertyBinding("environmentIntensity",(e=>e.viewer.onEnvironmentConfigurationChanged),(e=>e.viewer.environmentConfig={intensity:this.environmentIntensity??e.viewer.environmentConfig.intensity}),(e=>this.environmentIntensity=e.viewer.environmentConfig.intensity)),this._createPropertyBinding("environmentRotation",(e=>e.viewer.onEnvironmentConfigurationChanged),(e=>e.viewer.environmentConfig={rotation:this.environmentRotation??e.viewer.environmentConfig.rotation}),(e=>this.environmentRotation=e.viewer.environmentConfig.rotation)),this._createPropertyBinding("toneMapping",(e=>e.viewer.onPostProcessingChanged),(e=>{this.toneMapping&&(e.viewer.postProcessing={toneMapping:this.toneMapping});}),(e=>this.toneMapping=e.viewer.postProcessing?.toneMapping)),this._createPropertyBinding("contrast",(e=>e.viewer.onPostProcessingChanged),(e=>e.viewer.postProcessing={contrast:this.contrast??void 0}),(e=>this.contrast=e.viewer.postProcessing.contrast)),this._createPropertyBinding("exposure",(e=>e.viewer.onPostProcessingChanged),(e=>e.viewer.postProcessing={exposure:this.exposure??void 0}),(e=>this.exposure=e.viewer.postProcessing.exposure)),this._createPropertyBinding("ssao",(e=>e.viewer.onPostProcessingChanged),(e=>e.viewer.postProcessing={ssao:this.ssao??void 0}),(e=>this.ssao=e.viewer.postProcessing.ssao)),this._createPropertyBinding("cameraAutoOrbit",(e=>e.viewer.onCameraAutoOrbitChanged),(e=>e.viewer.cameraAutoOrbit={enabled:this.cameraAutoOrbit}),(e=>this.cameraAutoOrbit=e.viewer.cameraAutoOrbit.enabled)),this._createPropertyBinding("cameraAutoOrbitSpeed",(e=>e.viewer.onCameraAutoOrbitChanged),(e=>e.viewer.cameraAutoOrbit={speed:this.cameraAutoOrbitSpeed??void 0}),(e=>this.cameraAutoOrbitSpeed=e.viewer.cameraAutoOrbit.speed)),this._createPropertyBinding("cameraAutoOrbitDelay",(e=>e.viewer.onCameraAutoOrbitChanged),(e=>e.viewer.cameraAutoOrbit={delay:this.cameraAutoOrbitDelay??void 0}),(e=>this.cameraAutoOrbitDelay=e.viewer.cameraAutoOrbit.delay)),this._createPropertyBinding("animationSpeed",(e=>e.viewer.onAnimationSpeedChanged),(e=>e.viewer.animationSpeed=this.animationSpeed),(e=>{let t=e.viewer.animationSpeed;t=ad.reduce(((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e)),this.animationSpeed=t,this._dispatchCustomEvent("animationspeedchange",(e=>new Event(e)));})),this._createPropertyBinding("selectedAnimation",(e=>e.viewer.onSelectedAnimationChanged),(e=>e.viewer.selectedAnimation=this.selectedAnimation??e.viewer.selectedAnimation),(e=>this.selectedAnimation=e.viewer.selectedAnimation)),this._createPropertyBinding("selectedMaterialVariant",(e=>e.viewer.onSelectedMaterialVariantChanged),(e=>e.viewer.selectedMaterialVariant=this.selectedMaterialVariant??e.viewer.selectedMaterialVariant??""),(e=>this.selectedMaterialVariant=e.viewer.selectedMaterialVariant)),this._createPropertyBinding("hotSpots",(e=>e.viewer.onHotSpotsChanged),(e=>e.viewer.hotSpots=this.hotSpots??e.viewer.hotSpots),(e=>this.hotSpots=e.viewer.hotSpots)),this._createPropertyBinding("camerasAsHotSpots",(e=>e.viewer.onCamerasAsHotSpotsChanged),(e=>e.viewer.camerasAsHotSpots=this.camerasAsHotSpots??e.viewer.camerasAsHotSpots),(e=>this.camerasAsHotSpots=e.viewer.camerasAsHotSpots))],this._isFaultedBacking=false,this.engine=this._options.engine,this.renderWhenIdle=false===this._options.autoSuspendRendering,this.source=this._options.source??null,this.extension=null,this.environmentLighting=this._options.environmentLighting??null,this.environmentSkybox=this._options.environmentSkybox??null,this.environmentIntensity=this._options.environmentConfig?.intensity??null,this.environmentRotation=this._options.environmentConfig?.rotation??null,this.shadowQuality=null,this._loadingProgress=false,this.skyboxBlur=this._options.environmentConfig?.blur??null,this.toneMapping=this._options.postProcessing?.toneMapping??null,this.contrast=this._options.postProcessing?.contrast??null,this.exposure=this._options.postProcessing?.exposure??null,this.ssao=this._options.postProcessing?.ssao??null,this.clearColor=this._options.clearColor?new me$3(this._options.clearColor[0],this._options.clearColor[1],this._options.clearColor[2],this._options.clearColor[3]??1):null,this.cameraAutoOrbit=this._options.cameraAutoOrbit?.enabled??false,this.cameraAutoOrbitSpeed=this._options.cameraAutoOrbit?.speed??null,this.cameraAutoOrbitDelay=this._options.cameraAutoOrbit?.delay??null,this.hotSpots=this._options.hotSpots??{},this.animationAutoPlay=!!this._options.animationAutoPlay,this.selectedAnimation=this._options.selectedAnimation??null,this.animationSpeed=this._options.animationSpeed??1,this.animationProgress=0,this._animations=[],this._isAnimationPlaying=false,this._showAnimationSlider=true,this.selectedMaterialVariant=this._options.selectedMaterialVariant??null,this.camerasAsHotSpots=false,this.resetMode="auto";}static get observedAttributes(){return [...super.observedAttributes,"camera-orbit","camera-target"]}get viewerDetails(){return this._viewerDetails}queryHotSpot(e,t){return !!this._viewerDetails&&this._viewerDetails.viewer.queryHotSpot(e,t)}focusHotSpot(e){return !!this._viewerDetails&&this._viewerDetails.viewer.focusHotSpot(e)}get _isFaulted(){return this._isFaultedBacking}get environment(){return {lighting:this.environmentLighting,skybox:this.environmentSkybox}}set environment(e){this.environmentLighting=e||null,this.environmentSkybox=e||null;}get loadingProgress(){return this._loadingProgress}get _hasHotSpots(){return Object.keys(this.hotSpots).length>0}get animations(){return this._animations}get _hasAnimations(){return this._animations.length>0}get isAnimationPlaying(){return this._isAnimationPlaying}get materialVariants(){return this._viewerDetails?.viewer.materialVariants??[]}toggleAnimation(){this._viewerDetails?.viewer.toggleAnimation();}reset(){this._reset(this.resetMode);}_reset(e){switch(e){case "auto":this._viewerDetails?.viewer.resetCamera(void 0);break;case "reframe":this._viewerDetails?.viewer.resetCamera(true);break;default:this._viewerDetails?.viewer.reset(...e);}}resetCamera(){this._reset("reframe");}reload(){this._tearDownViewer(),this._setupViewer();}connectedCallback(){super.connectedCallback(),this._setupViewer();}disconnectedCallback(){super.disconnectedCallback(),this._tearDownViewer();}attributeChangedCallback(e,t,i){if(super.attributeChangedCallback(e,t,i),this.hasUpdated)if("camera-orbit"==e){const e=hd(i);e?this._viewerDetails?.viewer.updateCamera({alpha:e[0],beta:e[1],radius:e[2]}):this._viewerDetails?.viewer.resetCamera(false);}else if("camera-target"==e){const e=hd(i);e?this._viewerDetails?.viewer.updateCamera({targetX:e[0],targetY:e[1],targetZ:e[2]}):this._viewerDetails?.viewer.resetCamera(false);}}update(e){super.update(e),this._hotSpotSelect&&(this._hotSpotSelect.value="");let t=false;if(null!=e.get("renderWhenIdle"))t=true;else if(e.has("engine")){const i=e.get("engine");i&&this.engine!==i&&(t=true);}t?(this._tearDownViewer(),this._setupViewer()):(this._propertyBindings.filter((t=>e.has(t.property))).forEach((e=>e.updateViewer())),e.has("source")&&this._updateModel(),(e.has("environmentLighting")||e.has("environmentSkybox"))&&this._updateEnv({lighting:e.has("environmentLighting"),skybox:e.has("environmentSkybox")}),e.has("shadowQuality")&&this._updateShadows(this.shadowQuality));}render(){return Tu`<div class="full-size"><div id="canvasContainer" class="full-size"></div>${this._renderOverlay()}</div>`}_renderProgressBar(){const e=false!==this.loadingProgress,t="boolean"==typeof this.loadingProgress?0:100*this.loadingProgress,i=true===this.loadingProgress;return Tu`<div part="progress-bar" class="bar loading-progress-outer ${e?"":"loading-progress-outer-inactive"}" aria-label="Loading Progress"><div class="loading-progress-inner ${i?"loading-progress-inner-indeterminate":""}" style="${i?"":`width: ${t}%`}"></div></div>`}_renderToolbar(){let e=[];if(null!=this._viewerDetails?.model){this._hasAnimations&&e.push(Tu`<div class="animation-timeline"><button aria-label="${this.isAnimationPlaying?"Pause":"Play"}" @click="${this.toggleAnimation}">${this.isAnimationPlaying?Tu`<svg viewBox="0 0 24 24"><path d="${"M5.74609 3C4.7796 3 3.99609 3.7835 3.99609 4.75V19.25C3.99609 20.2165 4.7796 21 5.74609 21H9.24609C10.2126 21 10.9961 20.2165 10.9961 19.25V4.75C10.9961 3.7835 10.2126 3 9.24609 3H5.74609ZM14.7461 3C13.7796 3 12.9961 3.7835 12.9961 4.75V19.25C12.9961 20.2165 13.7796 21 14.7461 21H18.2461C19.2126 21 19.9961 20.2165 19.9961 19.25V4.75C19.9961 3.7835 19.2126 3 18.2461 3H14.7461Z"}" fill="currentColor"></path></svg>`:Tu`<svg viewBox="0 0 24 24"><path d="${"M5 5.27368C5 3.56682 6.82609 2.48151 8.32538 3.2973L20.687 10.0235C22.2531 10.8756 22.2531 13.124 20.687 13.9762L8.32538 20.7024C6.82609 21.5181 5 20.4328 5 18.726V5.27368Z"}" fill="currentColor"></path></svg>`}</button> <input ${ed(this._onAnimationSliderChanged)} aria-label="Animation Progress" class="animation-timeline-input" style="${this._showAnimationSlider?"":"visibility: hidden"}" type="range" min="0" max="1" step="0.0001" .value="${this.animationProgress}" @input="${this._onAnimationTimelineChanged}" @pointerdown="${this._onAnimationTimelinePointerDown}"></div><select aria-label="Select Animation Speed" @change="${this._onAnimationSpeedChanged}">${ad.map((e=>Tu`<option value="${e}" .selected="${this.animationSpeed===e}">${e}x</option>`))}</select> ${this.animations.length>1?Tu`<select aria-label="Select Animation" @change="${this._onSelectedAnimationChanged}">${this.animations.map(((e,t)=>Tu`<option value="${t}" .selected="${this.selectedAnimation===t}">${e}</option>`))}</select>`:""}`),this.materialVariants.length>1&&e.push(Tu`<select aria-label="Select Material Variant" @change="${this._onMaterialVariantChanged}">${this.materialVariants.map((e=>Tu`<option value="${e}" .selected="${this.selectedMaterialVariant===e}">${e}</option>`))}</select>`),e.push(Tu`<button aria-label="Reset Camera Pose" @click="${this.reset}"><svg viewBox="0 0 24 24"><path d="${"M7.20711 2.54289C7.59763 2.93342 7.59763 3.56658 7.20711 3.95711L5.41421 5.75H13.25C17.6683 5.75 21.25 9.33172 21.25 13.75C21.25 18.1683 17.6683 21.75 13.25 21.75C8.83172 21.75 5.25 18.1683 5.25 13.75C5.25 13.1977 5.69772 12.75 6.25 12.75C6.80228 12.75 7.25 13.1977 7.25 13.75C7.25 17.0637 9.93629 19.75 13.25 19.75C16.5637 19.75 19.25 17.0637 19.25 13.75C19.25 10.4363 16.5637 7.75 13.25 7.75H5.41421L7.20711 9.54289C7.59763 9.93342 7.59763 10.5666 7.20711 10.9571C6.81658 11.3476 6.18342 11.3476 5.79289 10.9571L2.29289 7.45711C1.90237 7.06658 1.90237 6.43342 2.29289 6.04289L5.79289 2.54289C6.18342 2.15237 6.81658 2.15237 7.20711 2.54289Z"}" fill="currentColor"></path></svg></button>`),this._hasHotSpots&&e.push(Tu`<div class="select-container"><select id="hotSpotSelect" aria-label="Select HotSpot" @change="${this._onHotSpotsChanged}">${Object.keys(this.hotSpots).map((e=>Tu`<option value="${e}">${e}</option>`))}</select> <button style="pointer-events:none"><svg viewBox="0 0 24 24"><path d="${"M12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14ZM6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18C8.68629 18 6 15.3137 6 12ZM12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4Z"}" fill="currentColor"></path></svg></button></div>`);const t=e.length,i=Tu`<div class="divider"></div>`;e=e.reduce(((e,s,r)=>r<t-1?[...e,s,i]:[...e,s]),new Array);}return e.length>0?Tu`<div part="tool-bar" class="bar ${this._hasAnimations?"":"bar-min"} tool-bar">${e}</div>`:Tu``}_renderReloadButton(){return Tu`${this._isFaulted?Tu`<button aria-label="Reload" part="reload-button" class="reload-button" @click="${this.reload}"><svg viewBox="0 0 24 24"><path d="${"M5 12C5 8.13401 8.13401 5 12 5C13.32 5 14.5542 5.36484 15.608 6H15C14.4477 6 14 6.44772 14 7C14 7.55228 14.4477 8 15 8H18C18.5523 8 19 7.55228 19 7C19 6 19 5 19 4C19 3.44772 18.5523 3 18 3C17.4477 3 17 3.44772 17 4V4.51575C15.5702 3.5588 13.85 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 11.6199 20.9764 11.2448 20.9304 10.8763C20.8621 10.3282 20.3624 9.93935 19.8144 10.0077C19.2663 10.076 18.8775 10.5757 18.9458 11.1237C18.9815 11.4104 19 11.7028 19 12C19 15.866 15.866 19 12 19C8.13401 19 5 15.866 5 12Z"}" fill="currentColor"></path></svg></button>`:""}`}_renderOverlay(){return Tu`<slot class="full-size children-slot"></slot><slot name="progress-bar">${this._renderProgressBar()}</slot><slot name="tool-bar">${this._renderToolbar()}</slot><slot name="reload-button">${this._renderReloadButton()}</slot>`}_dispatchCustomEvent(e,t){this.dispatchEvent(t(e));}_onSelectedAnimationChanged(e){const t=e.target;this.selectedAnimation=Number(t.value);}_onAnimationSpeedChanged(e){const t=e.target;this.animationSpeed=Number(t.value);}_onAnimationTimelineChanged(e){if(this._viewerDetails){const t=e.target,i=Number(t.value);i!==this.animationProgress&&(this._viewerDetails.viewer.animationProgress=i);}}_onAnimationTimelinePointerDown(e){if(this._viewerDetails?.viewer.isAnimationPlaying){this._viewerDetails.viewer.pauseAnimation();e.target.addEventListener("pointerup",(()=>this._viewerDetails?.viewer.playAnimation()),{once:true});}}_onMaterialVariantChanged(e){const t=e.target;this.selectedMaterialVariant=t.value;}_onHotSpotsChanged(e){const t=e.target,i=t.value;t.value="",this.focusHotSpot(i);}_onAnimationSliderChanged(e){this._animationSliderResizeObserver?.disconnect(),e&&(this._animationSliderResizeObserver=new ResizeObserver((()=>{this._showAnimationSlider=e.clientWidth>=80;})),this._animationSliderResizeObserver.observe(e));}_createPropertyBinding(e,t,i,s){return {property:e,onInitialized:e=>{t(e).add((()=>{s(e);})),i(e);},updateViewer:()=>{this._viewerDetails&&i(this._viewerDetails);}}}async _setupViewer(){await this._viewerLock.lockAsync((async()=>{if(this._canvasContainer||await this.updateComplete,this._canvasContainer&&!this._viewerDetails){const e=document.createElement("canvas");e.className="full-size canvas",e.setAttribute("touch-action","none"),this._canvasContainer.appendChild(e);{const t=new Cl,i=this,s=await this._createViewer(e,new Proxy(this._options,{get(e,s){switch(s){case "engine":return i.engine??e.engine;case "autoSuspendRendering":return !(i.hasAttribute("render-when-idle")||false===e.autoSuspendRendering);case "source":return i.getAttribute("source")??e.source;case "environmentLighting":return i.getAttribute("environment-lighting")??i.getAttribute("environment")??e.environmentLighting;case "environmentSkybox":return i.getAttribute("environment-skybox")??i.getAttribute("environment")??e.environmentSkybox;case "environmentConfig":return {intensity:od(i.getAttribute("environment-intensity"))??e.environmentConfig?.intensity,blur:od(i.getAttribute("skybox-blur"))??e.environmentConfig?.blur,rotation:od(i.getAttribute("environment-rotation"))??e.environmentConfig?.rotation};case "shadowConfig":return {quality:ld(i.getAttribute("shadow-quality"))??e.shadowConfig?.quality};case "cameraOrbit":return hd(i.getAttribute("camera-orbit"))??e.cameraOrbit;case "cameraTarget":return hd(i.getAttribute("camera-target"))??e.cameraTarget;case "cameraAutoOrbit":return {enabled:i.hasAttribute("camera-auto-orbit")||e.cameraAutoOrbit?.enabled,speed:od(i.getAttribute("camera-auto-orbit-speed"))??e.cameraAutoOrbit?.speed,delay:od(i.getAttribute("camera-auto-orbit-delay"))??e.cameraAutoOrbit?.delay};case "animationAutoPlay":return i.hasAttribute("animation-auto-play")||e.animationAutoPlay;case "animationSpeed":return od(i.getAttribute("animation-speed"))??e.animationSpeed;case "selectedAnimation":return od(i.getAttribute("selected-animation"))??e.selectedAnimation;case "postProcessing":return {toneMapping:(r=i.getAttribute("tone-mapping"),(r&&Ec(r)?r:null)??e.postProcessing?.toneMapping),contrast:od(i.getAttribute("contrast"))??e.postProcessing?.contrast,exposure:od(i.getAttribute("exposure"))??e.postProcessing?.exposure,ssao:i.hasAttribute("ssao")||e.postProcessing?.ssao};case "selectedMaterialVariant":return i.getAttribute("material-variant")??e.selectedMaterialVariant;case "onInitialized":return i=>{e.onInitialized?.(i),t.resolve(i);};case "onFaulted":return t=>{i._isFaultedBacking=true,e.onFaulted?.(t),i._tearDownViewer();};default:return e[s]}var r;}})),r=await t.promise;this._viewerDetails=Object.assign(r,{viewer:s});}const t=this._viewerDetails;t.viewer.onEnvironmentChanged.add((()=>{this._dispatchCustomEvent("environmentchange",(e=>new Event(e)));})),t.viewer.onEnvironmentConfigurationChanged.add((()=>{this._dispatchCustomEvent("environmentconfigurationchange",(e=>new Event(e)));})),t.viewer.onEnvironmentError.add((e=>{this._dispatchCustomEvent("environmenterror",(t=>new ErrorEvent(t,{error:e})));})),t.viewer.onShadowsConfigurationChanged.add((()=>{this._dispatchCustomEvent("shadowsconfigurationchange",(e=>new Event(e)));})),t.viewer.onModelChanged.add((e=>{this._animations=[...t.viewer.animations],this._dispatchCustomEvent("modelchange",(t=>new CustomEvent(t,{detail:e})));})),t.viewer.onModelError.add((e=>{this._animations=[...t.viewer.animations],this._dispatchCustomEvent("modelerror",(t=>new ErrorEvent(t,{error:e})));})),t.viewer.onLoadingProgressChanged.add((()=>{this._loadingProgress=t.viewer.loadingProgress,this._dispatchCustomEvent("loadingprogresschange",(e=>new Event(e)));})),t.viewer.onSelectedAnimationChanged.add((()=>{this._dispatchCustomEvent("selectedanimationchange",(e=>new Event(e)));})),t.viewer.onIsAnimationPlayingChanged.add((()=>{this._isAnimationPlaying=t.viewer.isAnimationPlaying??false,this._dispatchCustomEvent("animationplayingchange",(e=>new Event(e)));})),t.viewer.onAnimationProgressChanged.add((()=>{this.animationProgress=t.viewer.animationProgress??0,this._dispatchCustomEvent("animationprogresschange",(e=>new Event(e)));})),t.viewer.onSelectedMaterialVariantChanged.add((()=>{this._dispatchCustomEvent("selectedmaterialvariantchange",(e=>new Event(e)));})),t.scene.onAfterRenderCameraObservable.add((()=>{this._dispatchCustomEvent("viewerrender",(e=>new Event(e)));})),this._propertyBindings.forEach((e=>e.onInitialized(t))),this._dispatchCustomEvent("viewerready",(e=>new Event(e)));}this._isFaultedBacking=false;}));}async _createViewer(e,t){return await nd(e,Object.assign(t,{viewerClass:this._viewerClass}))}async _tearDownViewer(){await this._viewerLock.lockAsync((async()=>{this._viewerDetails&&(this._viewerDetails.viewer.dispose(),this._viewerDetails=void 0),this._loadingProgress=false,this._canvasContainer&&this._canvasContainer.firstElementChild&&this._canvasContainer.removeChild(this._canvasContainer.firstElementChild);}));}async _updateModel(){if(this._viewerDetails)try{this.source?await this._viewerDetails.viewer.loadModel(this.source,{pluginExtension:this.extension??void 0}):await this._viewerDetails.viewer.resetModel();}catch(e){e instanceof Ne$1||Ie$2.Error(e);}}async _updateEnv(e){if(this._viewerDetails)try{const t=[];e.lighting&&e.skybox&&this.environmentLighting===this.environmentSkybox?t.push([this.environmentLighting,{lighting:!0,skybox:!0}]):(e.lighting&&t.push([this.environmentLighting,{lighting:!0}]),e.skybox&&t.push([this.environmentSkybox,{skybox:!0}]));const i=t.map((async([e,t])=>{e?await(this._viewerDetails?.viewer.loadEnvironment(e,t)):await(this._viewerDetails?.viewer.resetEnvironment(t));}));await Promise.all(i);}catch(e){e instanceof Ne$1||Ie$2.Error(e);}}async _updateShadows(e){if(e)try{const t={quality:e};await(this._viewerDetails?.viewer.updateShadows(t));}catch(e){e instanceof Ne$1||Ie$2.Error(e);}}}cd.styles=Nc`:host{--ui-foreground-color:white;--ui-background-hue:233;--ui-background-saturation:8%;--ui-background-lightness:39%;--ui-background-opacity:0.75;--ui-background-color:hsla(var(--ui-background-hue), var(--ui-background-saturation), var(--ui-background-lightness), var(--ui-background-opacity));--ui-background-color-hover:hsla(
                var(--ui-background-hue),
                var(--ui-background-saturation),
                calc(var(--ui-background-lightness) - 10%),
                calc(var(--ui-background-opacity) - 0.1)
            );all:inherit;overflow:hidden}.full-size{display:block;position:relative;width:100%;height:100%}.canvas{outline:0}.children-slot{position:absolute;top:0;background:0 0;pointer-events:none}.reload-button{position:absolute;top:50%;left:50%;width:25%;transform:translate(-50%,-50%);color:var(--ui-foreground-color);background-color:var(--ui-background-color);border:1px solid transparent;border-radius:24px;padding:0;cursor:pointer;outline:0}.reload-button:hover{background-color:var(--ui-background-color-hover)}.bar{position:absolute;width:calc(100% - 24px);min-width:370px;max-width:1280px;left:50%;transform:translateX(-50%);background-color:var(--ui-background-color)}.bar-min{width:unset;min-width:unset;max-width:unset}.loading-progress-outer{height:4px;border-radius:4px;border:1px solid var(--ui-background-color);outline:0;top:12px;pointer-events:none;transition:opacity .5s ease}.loading-progress-outer-inactive{opacity:0;background-color:var(--ui-foreground-color)}.loading-progress-inner{width:0;height:100%;border-radius:inherit;background-color:var(--ui-foreground-color);transition:width .3s linear}@keyframes indeterminate{0%{left:0;width:0%}23%{left:0;width:30%}77%{left:70%;width:30%}100%{left:100%;width:0%}}.loading-progress-inner-indeterminate{position:absolute;animation:indeterminate 1.5s infinite;animation-timing-function:linear}.tool-bar{display:flex;flex-direction:row;align-items:center;border-radius:12px;border-color:var(--ui-foreground-color);height:48px;bottom:12px;color:var(--ui-foreground-color);-webkit-tap-highlight-color:transparent}.tool-bar *{height:100%;min-width:48px}.tool-bar .divider{min-width:1px;margin:0 6px;height:66%;background-color:var(--ui-foreground-color)}.tool-bar select{background:0 0;min-width:52px;max-width:128px;border:1px solid transparent;border-radius:inherit;color:inherit;font-size:14px;padding:0 12px;cursor:pointer;outline:0;appearance:none;-webkit-appearance:none}.tool-bar .select-container{position:relative;display:flex;border-radius:inherit;border-width:0;padding:0}.tool-bar .select-container select{position:absolute;min-width:0;width:100%}.tool-bar .select-container button{position:absolute;border-width:0}.tool-bar select:focus,.tool-bar select:hover{background-color:var(--ui-background-color-hover)}.tool-bar select option{background-color:var(--ui-background-color);color:var(--ui-foreground-color)}.tool-bar select:focus-visible{border-color:inherit}.tool-bar button{background:0 0;border:1px solid transparent;border-radius:inherit;color:inherit;padding:0;cursor:pointer;outline:0}.tool-bar button:hover{background-color:var(--ui-background-color-hover)}.tool-bar button:focus-visible{border-color:inherit}.tool-bar button svg{width:32px;height:32px}.animation-timeline{display:flex;flex:1;position:relative;overflow:hidden;cursor:pointer;align-items:center;border-radius:inherit;border-color:inherit}.animation-timeline-input{-webkit-appearance:none;cursor:pointer;width:100%;height:100%;outline:0;border:1px solid transparent;border-radius:inherit;padding:0 12px;background-color:transparent}.animation-timeline-input:focus-visible{border-color:inherit}.animation-timeline-input::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border:2px solid;color:var(--ui-foreground-color);border-radius:50%;background:hsla(var(--ui-background-hue),var(--ui-background-saturation),var(--ui-background-lightness),1);margin-top:-10px}.animation-timeline-input::-webkit-slider-runnable-track{height:2px;-webkit-appearance:none;background-color:var(--ui-foreground-color)}.animation-timeline-input::-moz-range-progress{height:2px;background-color:var(--ui-foreground-color)}.animation-timeline-input::-moz-range-thumb{width:16px;height:16px;border:2px solid var(--ui-foreground-color);border-radius:50%;background:hsla(var(--ui-background-hue),var(--ui-background-saturation),var(--ui-background-lightness),1)}.animation-timeline-input::-moz-range-track{height:2px;background:var(--ui-foreground-color)}`,e$z([Hu()],cd.prototype,"_isFaultedBacking",void 0),e$z([Vu({converter:function(e){if("WebGL"===e||"WebGPU"===e)return e}})],cd.prototype,"engine",void 0),e$z([Vu({attribute:"render-when-idle",type:Boolean})],cd.prototype,"renderWhenIdle",void 0),e$z([Vu()],cd.prototype,"source",void 0),e$z([Vu()],cd.prototype,"extension",void 0),e$z([Vu({hasChanged:(e,t)=>e.lighting!==t.lighting||e.skybox!==t.skybox})],cd.prototype,"environment",null),e$z([Vu({attribute:"environment-lighting"})],cd.prototype,"environmentLighting",void 0),e$z([Vu({attribute:"environment-skybox"})],cd.prototype,"environmentSkybox",void 0),e$z([Vu({type:Number,attribute:"environment-intensity"})],cd.prototype,"environmentIntensity",void 0),e$z([Vu({type:Number,attribute:"environment-rotation"})],cd.prototype,"environmentRotation",void 0),e$z([Vu({attribute:"shadow-quality"})],cd.prototype,"shadowQuality",void 0),e$z([Hu()],cd.prototype,"_loadingProgress",void 0),e$z([Vu({attribute:"skybox-blur"})],cd.prototype,"skyboxBlur",void 0),e$z([Vu({attribute:"tone-mapping",converter:e=>e&&Ec(e)?e:"neutral"})],cd.prototype,"toneMapping",void 0),e$z([Vu()],cd.prototype,"contrast",void 0),e$z([Vu()],cd.prototype,"exposure",void 0),e$z([Vu({type:String})],cd.prototype,"ssao",void 0),e$z([Vu({attribute:"clear-color",converter:{fromAttribute:function(e){if(!e)return null;const t=document.createElement("canvas");t.width=t.height=1;const i=t.getContext("2d");if(!i)throw new Error("Unable to get 2d context for parseColor");i.clearRect(0,0,1,1),i.fillStyle=e,i.fillRect(0,0,1,1);const s=i.getImageData(0,0,1,1).data;return new me$3(s[0]/255,s[1]/255,s[2]/255,s[3]/255)},toAttribute:e=>e?e.toHexString():null}})],cd.prototype,"clearColor",void 0),e$z([Vu({attribute:"camera-auto-orbit",type:Boolean})],cd.prototype,"cameraAutoOrbit",void 0),e$z([Vu({attribute:"camera-auto-orbit-speed",type:Number})],cd.prototype,"cameraAutoOrbitSpeed",void 0),e$z([Vu({attribute:"camera-auto-orbit-delay",type:Number})],cd.prototype,"cameraAutoOrbitDelay",void 0),e$z([Vu({attribute:"hotspots",converter:e=>e?JSON.parse(e):{}})],cd.prototype,"hotSpots",void 0),e$z([Vu({attribute:"animation-auto-play",type:Boolean})],cd.prototype,"animationAutoPlay",void 0),e$z([Vu({attribute:"selected-animation",type:Number})],cd.prototype,"selectedAnimation",void 0),e$z([Vu({attribute:"animation-speed"})],cd.prototype,"animationSpeed",void 0),e$z([Vu({attribute:false})],cd.prototype,"animationProgress",void 0),e$z([Hu()],cd.prototype,"_animations",void 0),e$z([Hu()],cd.prototype,"_isAnimationPlaying",void 0),e$z([Hu()],cd.prototype,"_showAnimationSlider",void 0),e$z([Vu({attribute:"material-variant"})],cd.prototype,"selectedMaterialVariant",void 0),e$z([Vu({attribute:"cameras-as-hotspots",type:Boolean})],cd.prototype,"camerasAsHotSpots",void 0),e$z([Vu({attribute:"reset-mode",converter:function(e){return e&&"auto"!==e?"reframe"===e?"reframe":e.trim().split(/\s+/):"auto"}})],cd.prototype,"resetMode",void 0),e$z([zu("#canvasContainer")],cd.prototype,"_canvasContainer",void 0),e$z([zu("#hotSpotSelect")],cd.prototype,"_hotSpotSelect",void 0);let ud=class extends cd{constructor(e){super(Pc,e);}};function dd(e,t){customElements.define(e,class extends ud{constructor(){super(t);}});}ud=e$z([Uu("babylon-viewer")],ud);let _d=class extends Nu{constructor(){super(...arguments),this._internals=this.attachInternals(),this._mutationObserver=new MutationObserver((e=>{e.some((e=>"childList"===e.type))&&this._sanitizeInnerHTML();})),this._viewerAttachment=null,this._connectingAbortController=null,this._updateAnnotation=null,this.hotSpot="";}connectedCallback(){super.connectedCallback(),this._internals.states?.add("invalid"),this._connectingAbortController?.abort(),this._connectingAbortController=new AbortController;const e=this._connectingAbortController.signal;(async()=>{if(this.parentElement?.matches(":not(:defined)")&&(await customElements.whenDefined(this.parentElement?.tagName.toLowerCase()),e.aborted))return;if(!(this.parentElement instanceof cd))return void console.warn("The babylon-viewer-annotation element must be a child of a babylon-viewer element.");this._mutationObserver.observe(this,{childList:true,characterData:true}),this._sanitizeInnerHTML();const t=this.parentElement,i=new vc,s=this._updateAnnotation=()=>{if(this.hotSpot)if(t.queryHotSpot(this.hotSpot,i)){const[e,t]=i.screenPosition;this.style.transform=`translate(${e}px, ${t}px)`,this._internals.states?.delete("invalid"),i.visibility<=0?this._internals.states?.add("back-facing"):this._internals.states?.delete("back-facing");}else this._internals.states?.add("invalid");};this._updateAnnotation(),t.addEventListener("viewerrender",s),this._viewerAttachment={dispose(){t.removeEventListener("viewerrender",s);}};})();}disconnectedCallback(){super.disconnectedCallback(),this._connectingAbortController?.abort(),this._connectingAbortController=null,this._viewerAttachment?.dispose(),this._viewerAttachment=null,this._internals.states?.add("invalid"),this._updateAnnotation=null;}render(){return Tu`<slot><div aria-label="${this.hotSpot} annotation" part="annotation" class="annotation">${this.hotSpot}</div></slot>`}update(e){super.update(e),e.has("hotSpot")&&this._updateAnnotation?.();}_sanitizeInnerHTML(){0===this.innerHTML.trim().length&&(this.innerHTML="");}};_d.styles=Nc`:host{--annotation-foreground-color:black;--annotation-background-color:white;display:inline-block;position:absolute;transition:opacity .25s}:host([hidden]){display:none}:host(:state(back-facing)){opacity:.2}:host(:state(invalid)){display:none}.annotation{transform:translate(-50%,-135%);font-size:14px;padding:0 6px;border-radius:6px;color:var(--annotation-foreground-color);background-color:var(--annotation-background-color)}.annotation::after{content:"";position:absolute;left:50%;height:60%;aspect-ratio:1;transform:translate(-50%,110%) rotate(-45deg);background-color:inherit;clip-path:polygon(0 0,100% 100%,0 100%,0 0)}`,e$z([Vu({attribute:"hotspot"})],_d.prototype,"hotSpot",void 0),_d=e$z([Uu("babylon-viewer-annotation")],_d);var indexANBEaM64_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,$:Pa,A:Eh,B:Ms,C:Qe$1,D:n$1W,E:Ea,F:bt$1,G:Hi,H:bs,I:En,J:Ds,K:Fs,L:Ie$2,M:hr$1,N:Es,O:R$g,P:vh,Q:se$5,R:w$8,S:Ae$3,T:Is,U:ra,V:ee$4,W:Ns,X:As,Y:ws,Z:Ts,_:e$z,a:Di,a$:er$1,a0:$i,a1:Rt$1,a2:no,a3:sa,a4:jt,a5:cs,a6:lt$1,a7:ct$1,a8:ut$1,a9:Li,aA:nc,aB:gh,aC:Pe$2,aD:O$g,aE:u$s,aF:p$p,aG:_i,aH:ti,aI:rc,aJ:Yt$1,aK:M$d,aL:x$d,aM:zi,aN:ea,aO:ls,aP:Ah,aQ:Vs,aR:Hs,aS:Cs,aT:Os,aU:Oe$3,aV:ro,aW:ge$3,aX:Ii,aY:ol,aZ:Kh,a_:Qs,aa:Fh,ab:et$1,ac:Ut$1,ad:Bt$1,ae:Ni,af:Vi,ag:Ba,ah:Ca,ai:Ia,aj:ps,ak:Ka,al:Da,am:Gt$1,an:Wa,ao:Qa,ap:ja,aq:qa,ar:Za,as:Ja,at:$a,au:Nt$1,av:or$1,aw:Ft$1,ax:Ya,ay:Xa,az:zr$1,b:te$4,b$:yi,b0:ir$1,b1:tr$1,b2:ll,b3:ks,b4:qs,b5:js,b6:Js,b7:$s,b8:Ks,b9:Ws,bA:Ar$1,bB:nn,bC:Zr,bD:jr,bE:Be$2,bF:oc,bG:ac,bH:li,bI:we$3,bJ:Fe$2,bK:_c,bL:fc,bM:dc,bN:Pl,bO:rs,bP:Ol,bQ:Cl,bR:ni,bS:oi,bT:qt$1,bU:Bi,bV:qi,bW:_n,bX:hc,bY:Y$5,bZ:W$4,b_:es,ba:Ys,bb:Ls,bc:rr$1,bd:nr$1,be:ar$1,bf:Gs,bg:Bs,bh:Xs,bi:bh,bj:Rh,bk:cl,bl:o$19,bm:h$c,bn:l$r,bo:Uh,bp:kh,bq:Us,br:m$q,bs:ns,bt:ve$3,bu:dn,bv:ue$4,bw:be$3,bx:wr$1,by:en,bz:qr,c:eo,c0:Si,c1:Mi,c2:lc,c3:cc,c4:za,c5:U$5,c6:fn,c7:gl,c8:N$c,c9:Vr$1,ca:Gr$1,cb:kr$1,cc:Ur,cd:Br$1,ce:Nr$1,cf:Lr,cg:Dr$1,ch:Or,ci:Pr,cj:vr$1,ck:Cr$1,cl:Fr$1,cm:yc,cn:Ic,co:Pc,cp:vc,cq:dd,get cr(){return ud},cs:cd,ct:nd,get cu(){return _d},cv:Oa,cw:Tl,d:ae$5,e:L$7,f:Aa,g:P$9,h:me$3,i:le$4,j:cr$1,k:ch,l:zt,m:V$8,n:Ta,o:re$5,p:Ai,q:Qh,r:b$f,s:a$$,t:Lh,u:is,v:Er$1,w:ua,x:ie$5,y:Xh,z:pl});function l$q(e){return e.split(" ").filter((e=>""!==e)).map((e=>parseFloat(e)))}function t$1j(e,n,t){for(;t.length!==n;){const n=l$q(e.lines[e.index++]);t.push(...n);}}function a$_(n,l,t){let a=0,r=0,i=0,s=0,o=0,u=0;for(let e=0;e<n.numberOfHorizontalAngles-1;e++)if(t<n.horizontalAngles[e+1]||e===n.numberOfHorizontalAngles-2){r=e,i=n.horizontalAngles[e],s=n.horizontalAngles[e+1];break}for(let e=0;e<n.numberOfVerticalAngles-1;e++)if(l<n.verticalAngles[e+1]||e===n.numberOfVerticalAngles-2){a=e,o=n.verticalAngles[e],u=n.verticalAngles[e+1];break}const c=s-i,f=u-o;if(0===f)return 0;const g=0===c?0:(t-i)/c,d=(l-o)/f,A=0===c?r:r+1,m=N$c(n.candelaValues[r][a],n.candelaValues[A][a],g),b=N$c(n.candelaValues[r][a+1],n.candelaValues[A][a+1],g);return N$c(m,b,d)}let r$1T=class r{constructor(){this.supportCascades=false;}loadCubeData(){throw ".ies not supported in Cube."}loadData(e,r,i){const s=function(e){const n={lines:new TextDecoder("utf-8").decode(e).split("\n"),index:0},r={version:n.lines[0],candelaValues:[],horizontalAngles:[],verticalAngles:[],numberOfHorizontalAngles:0,numberOfVerticalAngles:0};for(n.index=1;n.lines.length>0&&!n.lines[n.index].includes("TILT=");)n.index++;n.lines[n.index].includes("INCLUDE"),n.index++;const i=l$q(n.lines[n.index++]);r.numberOfLights=i[0],r.lumensPerLamp=i[1],r.candelaMultiplier=i[2],r.numberOfVerticalAngles=i[3],r.numberOfHorizontalAngles=i[4],r.photometricType=i[5],r.unitsType=i[6],r.width=i[7],r.length=i[8],r.height=i[9];const s=l$q(n.lines[n.index++]);r.ballastFactor=s[0],r.fileGenerationType=s[1],r.inputWatts=s[2];for(let e=0;e<r.numberOfHorizontalAngles;e++)r.candelaValues[e]=[];t$1j(n,r.numberOfVerticalAngles,r.verticalAngles),t$1j(n,r.numberOfHorizontalAngles,r.horizontalAngles);for(let e=0;e<r.numberOfHorizontalAngles;e++)t$1j(n,r.numberOfVerticalAngles,r.candelaValues[e]);let o=-1;for(let e=0;e<r.numberOfHorizontalAngles;e++)for(let n=0;n<r.numberOfVerticalAngles;n++)r.candelaValues[e][n]*=r.candelaValues[e][n]*r.candelaMultiplier*r.ballastFactor*r.fileGenerationType,o=Math.max(o,r.candelaValues[e][n]);if(o>0)for(let e=0;e<r.numberOfHorizontalAngles;e++)for(let n=0;n<r.numberOfVerticalAngles;n++)r.candelaValues[e][n]/=o;const u=180,c=360,f=new Float32Array(64800),g=r.horizontalAngles[0],d=r.horizontalAngles[r.numberOfHorizontalAngles-1];for(let e=0;e<64800;e++){let n=e%c;const l=Math.floor(e/c);d-g!==0&&(n<g||n>=d)&&(n%=2*d,n>d&&(n=2*d-n)),f[l+n*u]=a$_(r,l,n);}return {width:180,height:1,data:f}}(new Uint8Array(e.buffer,e.byteOffset,e.byteLength));i(s.width,s.height,r.useMipMaps,false,(()=>{const e=r.getEngine();r.type=Qe$1.TEXTURETYPE_FLOAT,r.format=Qe$1.TEXTUREFORMAT_R,r._gammaSpace=false,e._uploadDataToTextureDirectly(r,s.data);}));}};var iesTextureLoaderSK5XZdbF_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_IESTextureLoader:r$1T});jt.prototype._partialLoadFile=function(e,t,a,n,o=null){this._loadFile(e,(e=>{a[t]=e,a._internalCount++,6===a._internalCount&&n(a);}),void 0,void 0,true,((e,t)=>{o&&e&&o(e.status+" "+e.statusText,t);}));},jt.prototype._cascadeLoadFiles=function(e,t,a,n=null){const o=[];o._internalCount=0;for(let e=0;e<6;e++)this._partialLoadFile(a[e],e,o,t,n);},jt.prototype._cascadeLoadImgs=function(e,t,a,n,o=null,s){const l=[];l._internalCount=0;for(let i=0;i<6;i++)this._partialLoadImg(n[i],i,l,e,t,a,o,s);},jt.prototype._partialLoadImg=function(e,n,o,s,l,i,r=null,u){const d=_i();ti(e,(e=>{o[n]=e,o._internalCount++,s&&s.removePendingData(d),6===o._internalCount&&i&&i(l,o);}),((e,t)=>{s&&s.removePendingData(d),r&&r(e,t);}),s?s.offlineProvider:null,u),s&&s.addPendingData(d);},jt.prototype.createCubeTextureBase=function(e,t,a,i,r=null,u=null,d,c=null,f=false,p=0,_=0,h=null,m=null,C=null,g=false,b=null){const x=h||new zt(this,7);x.isCube=true,x.url=e,x.generateMipMaps=!i,x._lodGenerationScale=p,x._lodGenerationOffset=_,x._useSRGBBuffer=!!g&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!i),x!==h&&(x.label=e.substring(0,60)),this._doNotHandleContextLost||(x._extension=c,x._files=a,x._buffer=b);const L=e;this._transformTextureUrl&&!h&&(e=this._transformTextureUrl(e));const v=c??rc(e),y=Yt$1(v),T=(e,t)=>{x.dispose(),u?u(e,t):e&&Ie$2.Warn(e);},w=(n,o)=>{e===L?n&&T(n.status+" "+n.statusText,o):(Ie$2.Warn(`Failed to load ${e}, falling back to the ${L}`),this.createCubeTextureBase(L,t,a,!!i,r,T,d,c,f,p,_,x,m,C,g,b));};if(y)y.then((n=>{const o=e=>{m&&m(x,e),n.loadCubeData(e,x,f,r,((e,t)=>{T(e,t);}));};b?o(b):a&&6===a.length?n.supportCascades?this._cascadeLoadFiles(t,(e=>o(e.map((e=>new Uint8Array(e))))),a,T):T("Textures type does not support cascades."):this._loadFile(e,(e=>o(new Uint8Array(e))),void 0,t?t.offlineProvider||null:void 0,true,w);}));else {if(!a||0===a.length)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(t,x,((e,t)=>{C&&C(e,t);}),a,T);}return this._internalTexturesCache.push(x),x};const f$y=131072,l$p=131072;function s$u(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const A$e=s$u("DXT1"),T$f=s$u("DXT3"),i$1i=s$u("DXT5"),u$r=s$u("DX10");let E$l=class E{static GetDDSInfo(t){const r=new Int32Array(t.buffer,t.byteOffset,31),a=new Int32Array(t.buffer,t.byteOffset,35);let o=1;r[2]&f$y&&(o=Math.max(1,r[7]));const n=r[21],s=n===u$r?a[32]:0;let E=Qe$1.TEXTURETYPE_UNSIGNED_BYTE;switch(n){case 113:E=Qe$1.TEXTURETYPE_HALF_FLOAT;break;case 116:E=Qe$1.TEXTURETYPE_FLOAT;break;case u$r:if(10===s){E=Qe$1.TEXTURETYPE_HALF_FLOAT;break}if(2===s){E=Qe$1.TEXTURETYPE_FLOAT;break}}return {width:r[4],height:r[3],mipmapCount:o,isFourCC:!(4&~r[20]),isRGB:!(64&~r[20]),isLuminance:(r[20]&l$p)===l$p,isCube:!(512&~r[28]),isCompressed:n===A$e||n===T$f||n===i$1i,dxgiFormat:s,textureType:E}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,r,a,o,n,f){const l=new Float32Array(o),s=new Uint16Array(n,a);let A=0;for(let a=0;a<r;a++)for(let r=0;r<e;r++){const o=4*(r+a*e);l[A]=Fh(s[o]),l[A+1]=Fh(s[o+1]),l[A+2]=Fh(s[o+2]),E.StoreLODInAlphaChannel?l[A+3]=f:l[A+3]=Fh(s[o+3]),A+=4;}return l}static _GetHalfFloatRGBAArrayBuffer(e,t,a,o,n,f){if(E.StoreLODInAlphaChannel){const l=new Uint16Array(o),s=new Uint16Array(n,a);let A=0;for(let a=0;a<t;a++)for(let t=0;t<e;t++){const o=4*(t+a*e);l[A]=s[o],l[A+1]=s[o+1],l[A+2]=s[o+2],l[A+3]=Lh(f),A+=4;}return l}return new Uint16Array(n,a,o)}static _GetFloatRGBAArrayBuffer(e,t,r,a,o,n){if(E.StoreLODInAlphaChannel){const f=new Float32Array(a),l=new Float32Array(o,r);let s=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=4*(t+r*e);f[s]=l[a],f[s+1]=l[a+1],f[s+2]=l[a+2],f[s+3]=n,s+=4;}return f}return new Float32Array(o,r,a)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,a,o,n,f){const l=new Uint16Array(o),s=new Float32Array(n,a);let A=0;for(let a=0;a<t;a++)for(let t=0;t<e;t++)l[A]=Lh(s[A]),l[A+1]=Lh(s[A+1]),l[A+2]=Lh(s[A+2]),E.StoreLODInAlphaChannel?l[A+3]=Lh(f):l[A+3]=Lh(s[A+3]),A+=4;return l}static _GetFloatAsUIntRGBAArrayBuffer(e,t,r,o,n,f){const l=new Uint8Array(o),s=new Float32Array(n,r);let A=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const o=4*(t+r*e);l[A]=255*U$5(s[o]),l[A+1]=255*U$5(s[o+1]),l[A+2]=255*U$5(s[o+2]),E.StoreLODInAlphaChannel?l[A+3]=f:l[A+3]=255*U$5(s[o+3]),A+=4;}return l}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,r,o,n,f,l){const s=new Uint8Array(n),A=new Uint16Array(f,o);let T=0;for(let o=0;o<r;o++)for(let r=0;r<e;r++){const n=4*(r+o*e);s[T]=255*U$5(Fh(A[n])),s[T+1]=255*U$5(Fh(A[n+1])),s[T+2]=255*U$5(Fh(A[n+2])),E.StoreLODInAlphaChannel?s[T+3]=l:s[T+3]=255*U$5(Fh(A[n+3])),T+=4;}return s}static _GetRGBAArrayBuffer(e,t,r,a,o,n,f,l,s){const A=new Uint8Array(a),T=new Uint8Array(o,r);let i=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=4*(t+r*e);A[i]=T[a+n],A[i+1]=T[a+f],A[i+2]=T[a+l],A[i+3]=T[a+s],i+=4;}return A}static _ExtractLongWordOrder(e){return 0===e||255===e||-16777216===e?0:1+E._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,r,a,o,n,f,l){const s=new Uint8Array(a),A=new Uint8Array(o,r);let T=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=3*(t+r*e);s[T]=A[a+n],s[T+1]=A[a+f],s[T+2]=A[a+l],T+=3;}return s}static _GetLuminanceArrayBuffer(e,t,r,a,o){const n=new Uint8Array(a),f=new Uint8Array(o,r);let l=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=t+r*e;n[l]=f[a],l++;}return n}static UploadDDSLevels(t,r,a,l,s,c,_=-1,y,F=true){let R=null;l.sphericalPolynomial&&(R=[]);const B=!!t.getCaps().s3tc;r.generateMipMaps=s;const G=new Int32Array(a.buffer,a.byteOffset,31);let U,p,b,d,O,C,m,h=0,D=0,L=1;if(542327876!==G[0])return void Ie$2.Error("Invalid magic number in DDS header");if(!l.isFourCC&&!l.isRGB&&!l.isLuminance)return void Ie$2.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(l.isCompressed&&!B)return void Ie$2.Error("Compressed textures are not supported on this platform.");let X=G[22];d=G[1]+4;let S=false;if(l.isFourCC)switch(U=G[21],U){case A$e:L=8,D=Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1;break;case T$f:L=16,D=Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3;break;case i$1i:L=16,D=Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5;break;case 113:S=true,X=64;break;case 116:S=true,X=128;break;case u$r:{d+=20;let e=false;switch(l.dxgiFormat){case 10:S=true,X=64,e=true;break;case 2:S=true,X=128,e=true;break;case 88:l.isRGB=true,l.isFourCC=false,X=32,e=true;}if(e)break}default:return void Ie$2.Error(["Unsupported FourCC code:",(w=U,String.fromCharCode(255&w,w>>8&255,w>>16&255,w>>24&255))])}var w;const x=E._ExtractLongWordOrder(G[23]),I=E._ExtractLongWordOrder(G[24]),Y=E._ExtractLongWordOrder(G[25]),P=E._ExtractLongWordOrder(G[26]);S&&(D=t._getRGBABufferInternalSizedFormat(l.textureType)),C=1,G[2]&f$y&&false!==s&&(C=Math.max(1,G[7]));const g=y||0,M=t.getCaps();for(let o=g;o<c;o++){for(p=G[4],b=G[3],m=0;m<C;++m){if(-1===_||_===m){const n=-1===_?m:0;if(!l.isCompressed&&l.isFourCC){r.format=Qe$1.TEXTUREFORMAT_RGBA,h=p*b*4;let f=null;if(t._badOS||t._badDesktopOS||!M.textureHalfFloat&&!M.textureFloat)128===X?(f=E._GetFloatAsUIntRGBAArrayBuffer(p,b,a.byteOffset+d,h,a.buffer,n),R&&0==n&&R.push(E._GetFloatRGBAArrayBuffer(p,b,a.byteOffset+d,h,a.buffer,n))):64===X&&(f=E._GetHalfFloatAsUIntRGBAArrayBuffer(p,b,a.byteOffset+d,h,a.buffer,n),R&&0==n&&R.push(E._GetHalfFloatAsFloatRGBAArrayBuffer(p,b,a.byteOffset+d,h,a.buffer,n))),r.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE;else {const t=M.textureFloat&&(F&&M.textureFloatLinearFiltering||!F),o=M.textureHalfFloat&&(F&&M.textureHalfFloatLinearFiltering||!F),l=(128===X||64===X&&!o)&&t?Qe$1.TEXTURETYPE_FLOAT:(64===X||128===X&&!t)&&o?Qe$1.TEXTURETYPE_HALF_FLOAT:Qe$1.TEXTURETYPE_UNSIGNED_BYTE;let s,A=null;if(128===X)switch(l){case Qe$1.TEXTURETYPE_FLOAT:s=E._GetFloatRGBAArrayBuffer,A=null;break;case Qe$1.TEXTURETYPE_HALF_FLOAT:s=E._GetFloatAsHalfFloatRGBAArrayBuffer,A=E._GetFloatRGBAArrayBuffer;break;case Qe$1.TEXTURETYPE_UNSIGNED_BYTE:s=E._GetFloatAsUIntRGBAArrayBuffer,A=E._GetFloatRGBAArrayBuffer;}else switch(l){case Qe$1.TEXTURETYPE_FLOAT:s=E._GetHalfFloatAsFloatRGBAArrayBuffer,A=null;break;case Qe$1.TEXTURETYPE_HALF_FLOAT:s=E._GetHalfFloatRGBAArrayBuffer,A=E._GetHalfFloatAsFloatRGBAArrayBuffer;break;case Qe$1.TEXTURETYPE_UNSIGNED_BYTE:s=E._GetHalfFloatAsUIntRGBAArrayBuffer,A=E._GetHalfFloatAsFloatRGBAArrayBuffer;}r.type=l,f=s(p,b,a.byteOffset+d,h,a.buffer,n),R&&0==n&&R.push(A?A(p,b,a.byteOffset+d,h,a.buffer,n):f);}f&&t._uploadDataToTextureDirectly(r,f,o,n);}else if(l.isRGB)r.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,24===X?(r.format=Qe$1.TEXTUREFORMAT_RGB,h=p*b*3,O=E._GetRGBArrayBuffer(p,b,a.byteOffset+d,h,a.buffer,x,I,Y),t._uploadDataToTextureDirectly(r,O,o,n)):(r.format=Qe$1.TEXTUREFORMAT_RGBA,h=p*b*4,O=E._GetRGBAArrayBuffer(p,b,a.byteOffset+d,h,a.buffer,x,I,Y,P),t._uploadDataToTextureDirectly(r,O,o,n));else if(l.isLuminance){const f=t._getUnpackAlignement(),l=p;h=Math.floor((p+f-1)/f)*f*(b-1)+l,O=E._GetLuminanceArrayBuffer(p,b,a.byteOffset+d,h,a.buffer),r.format=Qe$1.TEXTUREFORMAT_LUMINANCE,r.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,t._uploadDataToTextureDirectly(r,O,o,n);}else h=Math.max(4,p)/4*Math.max(4,b)/4*L,O=new Uint8Array(a.buffer,a.byteOffset+d,h),r.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,t._uploadCompressedDataToTextureDirectly(r,D,p,b,O,o,n);}d+=X?p*b*(X/8):h,p*=.5,b*=.5,p=Math.max(1,p),b=Math.max(1,b);}if(void 0!==y)break}R&&R.length>0?l.sphericalPolynomial=Qh.ConvertCubeMapToSphericalPolynomial({size:G[4],right:R[0],left:R[1],up:R[2],down:R[3],front:R[4],back:R[5],format:Qe$1.TEXTUREFORMAT_RGBA,type:Qe$1.TEXTURETYPE_FLOAT,gammaSpace:false}):l.sphericalPolynomial=void 0;}};E$l.StoreLODInAlphaChannel=false;var ddsCfX3qFhI_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,DDSTools:E$l});let t$1i=class t{constructor(){this.supportCascades=true;}loadCubeData(t,a,s,n){const o=a.getEngine();let p,m=false,r=1e3;if(Array.isArray(t))for(let e=0;e<t.length;e++){const s=t[e];p=E$l.GetDDSInfo(s),a.width=p.width,a.height=p.height,m=(p.isRGB||p.isLuminance||p.mipmapCount>1)&&a.generateMipMaps,o._unpackFlipY(p.isCompressed),E$l.UploadDDSLevels(o,a,s,p,m,6,-1,e),p.isFourCC||1!==p.mipmapCount?r=p.mipmapCount-1:o.generateMipMapsForCubemap(a);}else {const n=t;p=E$l.GetDDSInfo(n),a.width=p.width,a.height=p.height,s&&(p.sphericalPolynomial=new Xa),m=(p.isRGB||p.isLuminance||p.mipmapCount>1)&&a.generateMipMaps,o._unpackFlipY(p.isCompressed),E$l.UploadDDSLevels(o,a,n,p,m,6),p.isFourCC||1!==p.mipmapCount?r=p.mipmapCount-1:o.generateMipMapsForCubemap(a,false);}o._setCubeMapTextureParams(a,m,r),a.isReady=true,a.onLoadedObservable.notifyObservers(a),a.onLoadedObservable.clear(),n&&n({isDDS:true,width:a.width,info:p,data:t,texture:a});}loadData(e,t,a){const s=E$l.GetDDSInfo(e),n=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps&&Math.max(s.width,s.height)>>s.mipmapCount-1==1;a(s.width,s.height,n,s.isFourCC,(()=>{E$l.UploadDDSLevels(t.getEngine(),t,e,s,n,1);}));}};var ddsTextureLoader3Y_V94PT_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_DDSTextureLoader:t$1i});function r$1S(){const e=0,t=1,a=2,s=3,r=6,n=8,o=9,i=10,c=14;let l=null;function T(e,t,a,s,r){const n=e.getImageTranscodedSizeInBytes(t,a,s);let o=new Uint8Array(n);if(!e.transcodeImage(o,t,a,s,1,0))return null;if(r){o=function(e,t,a,s){const r=new Uint16Array(4),n=new Uint16Array(a*s),o=a/4,i=s/4;for(let s=0;s<i;s++)for(let i=0;i<o;i++){const c=t+8*(s*o+i);r[0]=e[c]|e[c+1]<<8,r[1]=e[c+2]|e[c+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let t=0;t<4;t++){const o=e[c+4+t];let l=(4*s+t)*a+4*i;n[l++]=r[3&o],n[l++]=r[o>>2&3],n[l++]=r[o>>4&3],n[l++]=r[o>>6&3];}}return n}(o,0,e.getImageWidth(t,a)+3&-4,e.getImageHeight(t,a)+3&-4);}return o}onmessage=d=>{if("init"===d.data.action){if(d.data.url)try{importScripts(d.data.url);}catch(e){postMessage({action:"error",error:e});}l||(l=BASIS({wasmBinary:d.data.wasmBinary})),null!==l&&l.then((e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"});}));}else if("transcode"===d.data.action){const l=d.data.config,R=d.data.imageData,u=new BASIS.BasisFile(R),_=function(e){const t=e.getHasAlpha(),a=e.getNumImages(),s=[];for(let t=0;t<a;t++){const a={levels:[]},r=e.getNumLevels(t);for(let s=0;s<r;s++){const r={width:e.getImageWidth(t,s),height:e.getImageHeight(t,s)};a.levels.push(r);}s.push(a);}return {hasAlpha:t,images:s}}(u);let p=d.data.ignoreSupportedFormats?null:function(l,T){let d=null;l.supportedCompressionFormats&&(d=l.supportedCompressionFormats.astc?i:l.supportedCompressionFormats.bc7?r:l.supportedCompressionFormats.s3tc?T.hasAlpha?s:a:l.supportedCompressionFormats.pvrtc?T.hasAlpha?o:n:l.supportedCompressionFormats.etc2?t:l.supportedCompressionFormats.etc1?e:c);return d}(d.data.config,_),g=false;null===p&&(g=true,p=_.hasAlpha?s:a);let m=true;u.startTranscoding()||(m=false);const f=[];for(let e=0;e<_.images.length&&m;e++){const t=_.images[e];if(void 0===l.loadSingleImage||l.loadSingleImage===e){let a=t.levels.length;false===l.loadMipmapLevels&&(a=1);for(let s=0;s<a;s++){const a=t.levels[s],r=T(u,e,s,p,g);if(!r){m=false;break}a.transcodedPixels=r,f.push(a.transcodedPixels.buffer);}}}u.close(),u.delete(),g&&(p=-1),m?postMessage({action:"transcode",success:m,id:d.data.id,fileInfo:_,format:p},f):postMessage({action:"transcode",success:m,id:d.data.id});}};}var n$1V;!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11";}(n$1V||(n$1V={}));const o$18={JSModuleURL:`${Ai._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${Ai._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let i$1h=null,c$n=null,l$o=0;const T$e=async()=>(i$1h||(i$1h=new Promise(((t,a)=>{c$n?t(c$n):Ai.LoadFileAsync(Ai.GetBabylonScriptURL(o$18.WasmModuleURL)).then((s=>{if("function"!=typeof URL)return a("Basis transcoder requires an environment with a URL constructor");const n=URL.createObjectURL(new Blob([`(${r$1S})()`],{type:"application/javascript"}));c$n=new Worker(n),async function(t,a,s){return await new Promise(((r,n)=>{const o=e=>{"init"===e.data.action?(t.removeEventListener("message",o),r(t)):"error"===e.data.action&&n(e.data.error||"error initializing worker");};t.addEventListener("message",o),t.postMessage({action:"init",url:s?Ai.GetBabylonScriptURL(s):void 0,wasmBinary:a},[a]);}))}(c$n,s,o$18.JSModuleURL).then(t,a);})).catch(a);}))),await i$1h),d$t=async(e,t)=>{const a=e instanceof ArrayBuffer?new Uint8Array(e):e;return await new Promise(((e,s)=>{T$e().then((()=>{const r=l$o++,n=t=>{"transcode"===t.data.action&&t.data.id===r&&(c$n.removeEventListener("message",n),t.data.success?e(t.data):s("Transcode is not supported on this device"));};c$n.addEventListener("message",n);const o=new Uint8Array(a.byteLength);o.set(new Uint8Array(a.buffer,a.byteOffset,a.byteLength)),c$n.postMessage({action:"transcode",id:r,imageData:o,config:t,ignoreSupportedFormats:false},[o.buffer]);}),(e=>{s(e);}));}))},R$f=(e,t)=>{let a=t._gl?.TEXTURE_2D;e.isCube&&(a=t._gl?.TEXTURE_CUBE_MAP),t._bindTextureDirectly(a,e,true);},u$q=(r,o)=>{const i=r.getEngine();for(let c=0;c<o.fileInfo.images.length;c++){const l=o.fileInfo.images[c].levels[0];if(r._invertVScale=r.invertY,-1===o.format||o.format===n$1V.cTFRGB565)if(r.type=Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5,r.format=Qe$1.TEXTUREFORMAT_RGB,!i._features.basisNeedsPOT||Math.log2(l.width)%1==0&&Math.log2(l.height)%1==0)r._invertVScale=!r.invertY,r.width=l.width+3&-4,r.height=l.height+3&-4,r.samplingMode=Qe$1.TEXTURE_LINEAR_LINEAR,R$f(r,i),i._uploadDataToTextureDirectly(r,new Uint16Array(l.transcodedPixels.buffer),c,0,Qe$1.TEXTUREFORMAT_RGB,true);else {const e=new zt(i,2);r._invertVScale=r.invertY,e.type=Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5,e.format=Qe$1.TEXTUREFORMAT_RGB,e.width=l.width+3&-4,e.height=l.height+3&-4,R$f(e,i),i._uploadDataToTextureDirectly(e,new Uint16Array(l.transcodedPixels.buffer),c,0,Qe$1.TEXTUREFORMAT_RGB,true),i._rescaleTexture(e,r,i.scenes[0],i._getInternalFormat(Qe$1.TEXTUREFORMAT_RGB),(()=>{i._releaseTexture(e),R$f(r,i);}));}else {r.width=l.width,r.height=l.height,r.generateMipMaps=o.fileInfo.images[c].levels.length>1;const t=_$i.GetInternalFormatFromBasisFormat(o.format,i);r.format=t,R$f(r,i);const a=o.fileInfo.images[c].levels;for(let e=0;e<a.length;e++){const s=a[e];i._uploadCompressedDataToTextureDirectly(r,t,s.width,s.height,s.transcodedPixels,c,e);}!i._features.basisNeedsPOT||Math.log2(r.width)%1==0&&Math.log2(r.height)%1==0||(Ai.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),r._cachedWrapU=Is.CLAMP_ADDRESSMODE,r._cachedWrapV=Is.CLAMP_ADDRESSMODE);}}},_$i={JSModuleURL:o$18.JSModuleURL,WasmModuleURL:o$18.WasmModuleURL,GetInternalFormatFromBasisFormat:(e,a)=>{let s;switch(e){case n$1V.cTFETC1:s=Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL;break;case n$1V.cTFBC1:s=Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1;break;case n$1V.cTFBC4:s=Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5;break;case n$1V.cTFASTC_4x4:s=Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4;break;case n$1V.cTFETC2:s=Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC;break;case n$1V.cTFBC7:s=Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM;}if(void 0===s)throw "The chosen Basis transcoder format is not currently supported";return s},TranscodeAsync:d$t,LoadTextureFromTranscodeResult:u$q};Object.defineProperty(_$i,"JSModuleURL",{get:function(){return o$18.JSModuleURL},set:function(e){o$18.JSModuleURL=e;}}),Object.defineProperty(_$i,"WasmModuleURL",{get:function(){return o$18.WasmModuleURL},set:function(e){o$18.WasmModuleURL=e;}});let p$o=class p{constructor(){this.supportCascades=false;}loadCubeData(t,a,s,r,n){if(Array.isArray(t))return;const o=a.getEngine().getCaps(),i={supportedCompressionFormats:{etc1:!!o.etc1,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,astc:!!o.astc,bc7:!!o.bptc}};d$t(t,i).then((e=>{const t=e.fileInfo.images[0].levels.length>1&&a.generateMipMaps;u$q(a,e),a.getEngine()._setCubeMapTextureParams(a,t),a.isReady=true,a.onLoadedObservable.notifyObservers(a),a.onLoadedObservable.clear(),r&&r();})).catch((t=>{Ai.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),a.isReady=true,n&&n(t);}));}loadData(t,a,s){const r=a.getEngine().getCaps(),n={supportedCompressionFormats:{etc1:!!r.etc1,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,astc:!!r.astc,bc7:!!r.bptc}};d$t(t,n).then((e=>{const t=e.fileInfo.images[0].levels[0],r=e.fileInfo.images[0].levels.length>1&&a.generateMipMaps;s(t.width,t.height,r,-1!==e.format,(()=>{u$q(a,e);}));})).catch((t=>{Ai.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),Ai.Warn(`Failed to transcode Basis file: ${t}`),s(0,0,false,false,(()=>{}),true);}));}};var basisTextureLoaderIArbJ2PB_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_BasisTextureLoader:p$o});let o$17=null;async function p$n(){return o$17||(o$17=async function(){const e=L$7.LastCreatedEngine?.createCanvas(100,100)??new OffscreenCanvas(100,100);e instanceof OffscreenCanvas&&Ie$2.Warn("DumpData: OffscreenCanvas will be used for dumping data. This may result in lossy alpha values.");const{ThinEngine:a}=await Promise.resolve().then(function(){return indexANBEaM64_esm_min}).then((function(e){return e.cv}));if(!a.IsSupported){if(!e.getContext("bitmaprenderer"))throw new Error("DumpData: No WebGL or bitmap rendering context available. Cannot dump data.");return {canvas:e}}const n=new a(e,false,{preserveDrawingBuffer:true,depth:false,stencil:false,alpha:true,premultipliedAlpha:false,antialias:false,failIfMajorPerformanceCaveat:false});L$7.Instances.pop(),L$7.OnEnginesDisposedObservable.add((e=>{n&&e!==n&&!n.isDisposed&&0===L$7.Instances.length&&l$n();})),n.getCaps().parallelShaderCompile=void 0;const o=new Ta(n),{passPixelShader:p}=await Promise.resolve().then(function(){return pass_fragmentY28YD4oC_esm_min}),m=new Ea({engine:n,name:p.name,fragmentShader:p.shader,samplerNames:["textureSampler"]});return {canvas:e,dumpEngine:{engine:n,renderer:o,wrapper:m}}}()),await o$17}async function m$p(e,a,n,r,t="image/png",s,i){const o=await n.readPixels(0,0,e,a);d$s(e,a,new Uint8Array(o.buffer),r,t,s,true,void 0,i);}async function c$m(r,t,s,i="image/png",o,m=false,c=false,d){if(s instanceof Float32Array){const a=new Uint8Array(s.length);let n=s.length;for(;n--;){const r=s[n];a[n]=Math.round(255*U$5(r));}s=a;}const l=await p$n();return await new Promise((async e=>{if(l.dumpEngine){const e=l.dumpEngine;e.engine.setSize(r,t,true);const n=e.engine.createRawTexture(s,r,t,Qe$1.TEXTUREFORMAT_RGBA,false,!m,Qe$1.TEXTURE_NEAREST_NEAREST);e.renderer.setViewport(),e.renderer.applyEffectWrapper(e.wrapper),e.wrapper.effect._bindTexture("textureSampler",n),e.renderer.draw(),n.dispose();}else {const e=l.canvas.getContext("bitmaprenderer");l.canvas.width=r,l.canvas.height=t;const a=new ImageData(r,t);a.data.set(s);const n=await createImageBitmap(a,{premultiplyAlpha:"none",imageOrientation:m?"flipY":"from-image"});e.transferFromImageBitmap(n);}Ai.ToBlob(l.canvas,(a=>{if(!a)throw new Error("DumpData: Failed to convert canvas to blob.");void 0!==o&&Ai.DownloadBlob(a,o);const r=new FileReader;r.onload=a=>{const n=a.target.result;e(n);},c?r.readAsArrayBuffer(a):r.readAsDataURL(a);}),i,d);}))}function d$s(e,a,n,r,t="image/png",s,i=false,o=false,p){ void 0!==s||r||(s=""),c$m(e,a,n,t,s,i,o,p).then((e=>{r&&r(e);}));}function l$n(){o$17&&(o$17?.then((e=>{e.canvas instanceof HTMLCanvasElement&&e.canvas.remove(),e.dumpEngine&&(e.dumpEngine.engine.dispose(),e.dumpEngine.renderer.dispose(),e.dumpEngine.wrapper.dispose());})),o$17=null);}const u$p={DumpData:d$s,DumpDataAsync:c$m,DumpFramebuffer:m$p,Dispose:l$n};Ai.DumpData=d$s,Ai.DumpDataAsync=c$m,Ai.DumpFramebuffer=m$p;var dumpToolsXlmyKCb1_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,Dispose:l$n,DumpData:d$s,DumpDataAsync:c$m,DumpFramebuffer:m$p,DumpTools:u$p});const u$o="image/png",c$l=[134,22,135,150,246,214,150,54];function T$d(r){const t=new DataView(r.buffer,r.byteOffset,r.byteLength);let n=0;for(let r=0;r<c$l.length;r++)if(t.getUint8(n++)!==c$l[r])return Ie$2.Error("Not a babylon environment map"),null;let a="",o=0;for(;o=t.getUint8(n++);)a+=String.fromCharCode(o);let i=JSON.parse(a);return i=d$r(i),i.binaryDataPosition=n,i.specular&&(i.specular.lodGenerationScale=i.specular.lodGenerationScale||.8),i}function d$r(e){if(e.version>2)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:u$o}}function p$m(e,r,i){const s=(i=d$r(i)).specular;if(!s)return Promise.resolve([]);e._lodGenerationScale=s.lodGenerationScale;const l=[],c=function(e,r){const t=(r=d$r(r)).specular;let n=Math.log2(r.width);if(n=Math.round(n)+1,t.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const a=new Array(n);for(let o=0;o<n;o++){a[o]=new Array(6);for(let n=0;n<6;n++){const i=t.mipmaps[6*o+n];a[o][n]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+i.position,i.length);}}return a}(r,i);l.push(m$o(e,c,i.imageType));const T=i.irradiance?.irradianceTexture;if(T){const s=function(e,r){r=d$r(r);const t=new Array(6),n=r.irradiance?.irradianceTexture;if(n){if(6!==n.faces.length)throw new Error(`Incorrect irradiance texture faces number "${n.faces.length}"`);for(let a=0;a<6;a++){const o=n.faces[a];t[a]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+o.position,o.length);}}return t}(r,i);let c=null;i.irradiance?.irradianceTexture?.dominantDirection&&(c=te$4.FromArray(i.irradiance.irradianceTexture.dominantDirection)),l.push(async function(e,r,t,i=u$o,s=null){const l=e.getEngine(),c=new zt(l,5),T=new Ms(l,c);e._irradianceTexture=T,T._dominantDirection=s,c.isCube=true,c.format=Qe$1.TEXTUREFORMAT_RGBA,c.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,c.generateMipMaps=true,c._cachedAnisotropicFilteringLevel=null,c.generateMipMaps=true,c.width=t,c.height=t,l.updateTextureSamplingMode(Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,c),await _$h(c,[r],false,i),l.generateMipMapsForCubemap(c),c.isReady=true;}(e,s,T.size,i.imageType,c));}return Promise.all(l)}async function f$x(e,r,t,a,o,i,s,l,u,c,T){return await new Promise(((d,p)=>{if(t){const t=r.createTexture(null,true,true,null,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,null,(e=>{p(e);}),e);a?.onEffectCreatedObservable.addOnce((n=>{n.executeWhenCompiled((()=>{a.externalTextureSamplerBinding=true,a.onApply=n=>{n._bindTexture("textureSampler",t),n.setFloat2("scale",1,r._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1);},r.scenes.length&&(r.scenes[0].postProcessManager.directRender([a],c,true,i,s),r.restoreDefaultFramebuffer(),t.dispose(),URL.revokeObjectURL(o),d());}));}));}else {if(r._uploadImageToTexture(T,e,i,s),l){const t=u[s];t&&r._uploadImageToTexture(t._texture,e,i,0);}d();}}))}async function m$o(e,r,t=u$o){const a=e.getEngine();e.format=Qe$1.TEXTUREFORMAT_RGBA,e.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,e.generateMipMaps=true,e._cachedAnisotropicFilteringLevel=null,a.updateTextureSamplingMode(Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,e),await _$h(e,r,true,t),e.isReady=true;}async function _$h(e,r,t,c=u$o){if(!Ai.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const T=V$8(e.width)+1,d=e.getEngine();let p=false,m=false,_=null,y=null,g=null;const E=d.getCaps();E.textureLOD?d._features.supportRenderAndCopyToLodForFloatTextures?E.textureHalfFloatRender&&E.textureHalfFloatLinearFiltering?(p=true,e.type=Qe$1.TEXTURETYPE_HALF_FLOAT):E.textureFloatRender&&E.textureFloatLinearFiltering&&(p=true,e.type=Qe$1.TEXTURETYPE_FLOAT):p=false:(p=false,m=t);let x=0;if(p)d.isWebGPU?(x=1,await Promise.resolve().then(function(){return rgbdDecode_fragmentC93bUglL_esm_min})):await Promise.resolve().then(function(){return rgbdDecode_fragmentBCFIXNGa_esm_min}),_=new Aa("rgbdDecode","rgbdDecode",null,null,1,null,Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,d,false,void 0,e.type,void 0,null,false,void 0,x),e._isRGBD=false,e.invertY=false,y=d.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:false,generateMipMaps:true,generateStencilBuffer:false,samplingMode:Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,type:e.type,format:Qe$1.TEXTUREFORMAT_RGBA});else if(e._isRGBD=true,e.invertY=true,m){const r=3;g={};const t=e._lodGenerationScale,i=e._lodGenerationOffset;for(let s=0;s<r;s++){const l=(T-1)*t+i,u=i+(l-i)*(1-s/(r-1)),c=Math.round(Math.min(Math.max(u,0),l)),p=new zt(d,2);p.isCube=true,p.invertY=true,p.generateMipMaps=false,d.updateTextureSamplingMode(Qe$1.TEXTURE_LINEAR_LINEAR,p);const f=new Ms(null);switch(f._isCube=true,f._texture=p,g[c]=f,s){case 0:e._lodTextureLow=f;break;case 1:e._lodTextureMid=f;break;case 2:e._lodTextureHigh=f;}}}const R=[];for(let t=0;t<r.length;t++)for(let n=0;n<6;n++){const a=r[t][n],o=new Blob([a],{type:c}),i=URL.createObjectURL(o);let s;if(d._features.forceBitmapOverHTMLImageElement)s=d.createImageBitmap(o,{premultiplyAlpha:"none"}).then((async r=>await f$x(r,d,p,_,i,n,t,m,g,y,e)));else {const r=new Image;r.src=i,s=new Promise(((a,o)=>{r.onload=()=>{f$x(r,d,p,_,i,n,t,m,g,y,e).then((()=>a())).catch((e=>{o(e);}));},r.onerror=e=>{o(e);};}));}R.push(s);}if(await Promise.all(R),r.length<T){let t;const a=Math.pow(2,T-1-r.length),o=a*a*4;switch(e.type){case Qe$1.TEXTURETYPE_UNSIGNED_BYTE:t=new Uint8Array(o);break;case Qe$1.TEXTURETYPE_HALF_FLOAT:t=new Uint16Array(o);break;case Qe$1.TEXTURETYPE_FLOAT:t=new Float32Array(o);}for(let n=r.length;n<T;n++)for(let r=0;r<6;r++)d._uploadArrayBufferViewToTexture(y?.texture||e,t,r,n);}if(y){const r=e._irradianceTexture;e._irradianceTexture=null,d._releaseTexture(e),y._swapAndDie(e),e._irradianceTexture=r;}_&&_.dispose(),m&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=true),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=true),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=true));}function y$d(e,n){const a=(n=d$r(n)).irradiance;if(!a)return;const o=new Xa;te$4.FromArrayToRef(a.x,0,o.x),te$4.FromArrayToRef(a.y,0,o.y),te$4.FromArrayToRef(a.z,0,o.z),te$4.FromArrayToRef(a.xx,0,o.xx),te$4.FromArrayToRef(a.yy,0,o.yy),te$4.FromArrayToRef(a.zz,0,o.zz),te$4.FromArrayToRef(a.yz,0,o.yz),te$4.FromArrayToRef(a.zx,0,o.zx),te$4.FromArrayToRef(a.xy,0,o.xy),e._sphericalPolynomial=o;}function g$i(e,r,t,n,a){const o=m$o(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),r).then((()=>e));return e.onRebuildCallback=e=>({proxy:o,isReady:true,isAsync:true}),e._source=13,e._bufferViewArrayArray=r,e._lodGenerationScale=n,e._lodGenerationOffset=a,e._sphericalPolynomial=t,m$o(e,r).then((()=>(e.isReady=true,e)))}let t$1h=class t{constructor(){this.supportCascades=false;}loadCubeData(t,s,a,r,i){if(Array.isArray(t))return;const d=T$d(t);if(d){s.width=d.width,s.height=d.width;try{y$d(s,d),p$m(s,t,d).then((()=>{s.isReady=!0,s.onLoadedObservable.notifyObservers(s),s.onLoadedObservable.clear(),r&&r();}),(e=>{i?.("Can not upload environment levels",e);}));}catch(e){i?.("Can not upload environment file",e);}}else i&&i("Can not parse the environment file",null);}loadData(){throw ".env not supported in 2d."}};var envTextureLoaderDCq6gy_r_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_ENVTextureLoader:t$1h});let r$1R=class r{static ConvertPanoramaToCubemap(e,r,a,n,o=false,i=true){if(!e)throw "ConvertPanoramaToCubemap: input cannot be null";let h=0;if(e.length!=r*a*3){if(e.length!=r*a*4)throw "ConvertPanoramaToCubemap: input size is wrong";h=4;}else h=3;return {front:this.CreateCubemapTexture(n,this.FACE_FRONT,e,r,a,o,i,h),back:this.CreateCubemapTexture(n,this.FACE_BACK,e,r,a,o,i,h),left:this.CreateCubemapTexture(n,this.FACE_LEFT,e,r,a,o,i,h),right:this.CreateCubemapTexture(n,this.FACE_RIGHT,e,r,a,o,i,h),up:this.CreateCubemapTexture(n,this.FACE_UP,e,r,a,o,i,h),down:this.CreateCubemapTexture(n,this.FACE_DOWN,e,r,a,o,i,h),size:n,type:Qe$1.TEXTURETYPE_FLOAT,format:Qe$1.TEXTUREFORMAT_RGB,gammaSpace:false}}static CreateCubemapTexture(t,e,r,a,n,o,i,h){const s=new ArrayBuffer(t*t*4*3),w=new Float32Array(s),u=o?Math.max(1,Math.round(a/4/t)):1,f=1/u,l=f*f,c=e[1].subtract(e[0]).scale(f/t),d=e[3].subtract(e[2]).scale(f/t),C=1/t;let m=0;for(let o=0;o<t;o++)for(let s=0;s<u;s++){let s=e[0],p=e[2];for(let e=0;e<t;e++)for(let f=0;f<u;f++){const u=p.subtract(s).scale(m).add(s);u.normalize();const f=this.CalcProjectionSpherical(u,r,a,n,h,i);w[o*t*3+3*e+0]+=f.r*l,w[o*t*3+3*e+1]+=f.g*l,w[o*t*3+3*e+2]+=f.b*l,s=s.add(c),p=p.add(d);}m+=C*f;}return w}static CalcProjectionSpherical(t,e,r,a,n,o){let i=Math.atan2(t.z,t.x);const h=Math.acos(t.y);for(;i<-Math.PI;)i+=2*Math.PI;for(;i>Math.PI;)i-=2*Math.PI;let s=i/Math.PI;const w=h/Math.PI;s=.5*s+.5;let u=Math.round(s*r);u<0?u=0:u>=r&&(u=r-1);let f=Math.round(w*a);f<0?f=0:f>=a&&(f=a-1);const l=o?a-f-1:f;return {r:e[l*r*n+u*n+0],g:e[l*r*n+u*n+1],b:e[l*r*n+u*n+2]}}};function a$Z(t,e,r,a,n,o){n>0?(n=function(t,e){return e>1023?t*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?t*Math.pow(2,-1074)*Math.pow(2,e+1074):t*Math.pow(2,e)}(1,n-136),t[o+0]=e*n,t[o+1]=r*n,t[o+2]=a*n):(t[o+0]=0,t[o+1]=0,t[o+2]=0);}function n$1U(t,e){let r="",a="";for(let n=e;n<t.length-e&&(a=String.fromCharCode(t[n]),"\n"!=a);n++)r+=a;return r}function o$16(t){let e=0,r=0,a=n$1U(t,0);if("#"!=a[0]||"?"!=a[1])throw "Bad HDR Format.";let o=false,i=false,h=0;do{h+=a.length+1,a=n$1U(t,h),"FORMAT=32-bit_rle_rgbe"==a?i=true:0==a.length&&(o=true);}while(!o);if(!i)throw "HDR Bad header format, unsupported FORMAT";h+=a.length+1,a=n$1U(t,h);const s=/^-Y (.*) \+X (.*)$/g.exec(a);if(!s||s.length<3)throw "HDR Bad header format, no size";if(r=parseInt(s[2]),e=parseInt(s[1]),r<8||r>32767)throw "HDR Bad header format, unsupported size";return h+=a.length+1,{height:e,width:r,dataPosition:h}}function i$1g(t,e,a=false){const n=new Uint8Array(t),i=o$16(n),s=h$b(n,i);return r$1R.ConvertPanoramaToCubemap(s,i.width,i.height,e,a)}function h$b(t,e){return function(t,e){let r=e.height;const n=e.width;let o,i,h,w,u,f=e.dataPosition,l=0,c=0,d=0;const C=new ArrayBuffer(4*n),m=new Uint8Array(C),p=new ArrayBuffer(e.width*e.height*4*3),A=new Float32Array(p);for(;r>0;){if(o=t[f++],i=t[f++],h=t[f++],w=t[f++],2!=o||2!=i||128&h||e.width<8||e.width>32767)return s$t(t,e);if((h<<8|w)!=n)throw "HDR Bad header format, wrong scan line width";for(l=0,d=0;d<4;d++)for(c=(d+1)*n;l<c;)if(o=t[f++],i=t[f++],o>128){if(u=o-128,0==u||u>c-l)throw "HDR Bad Format, bad scanline data (run)";for(;u-- >0;)m[l++]=i;}else {if(u=o,0==u||u>c-l)throw "HDR Bad Format, bad scanline data (non-run)";if(m[l++]=i,--u>0)for(let e=0;e<u;e++)m[l++]=t[f++];}for(d=0;d<n;d++)o=m[d],i=m[d+n],h=m[d+2*n],w=m[d+3*n],a$Z(A,o,i,h,w,(e.height-r)*n*3+3*d);r--;}return A}(t,e)}function s$t(t,e){let r=e.height;const n=e.width;let o,i,h,s,w,u=e.dataPosition;const f=new ArrayBuffer(e.width*e.height*4*3),l=new Float32Array(f);for(;r>0;){for(w=0;w<e.width;w++)o=t[u++],i=t[u++],h=t[u++],s=t[u++],a$Z(l,o,i,h,s,(e.height-r)*n*3+3*w);r--;}return l}r$1R.FACE_LEFT=[new te$4(-1,-1,-1),new te$4(1,-1,-1),new te$4(-1,1,-1),new te$4(1,1,-1)],r$1R.FACE_RIGHT=[new te$4(1,-1,1),new te$4(-1,-1,1),new te$4(1,1,1),new te$4(-1,1,1)],r$1R.FACE_FRONT=[new te$4(1,-1,-1),new te$4(1,-1,1),new te$4(1,1,-1),new te$4(1,1,1)],r$1R.FACE_BACK=[new te$4(-1,-1,1),new te$4(-1,-1,-1),new te$4(-1,1,1),new te$4(-1,1,-1)],r$1R.FACE_DOWN=[new te$4(1,1,-1),new te$4(1,1,1),new te$4(-1,1,-1),new te$4(-1,1,1)],r$1R.FACE_UP=[new te$4(-1,-1,-1),new te$4(-1,-1,1),new te$4(1,-1,-1),new te$4(1,-1,1)];let r$1Q=class r{constructor(){this.supportCascades=false;}loadCubeData(){throw ".hdr not supported in Cube."}loadData(r,o,s){const i=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),n=o$16(i),p=h$b(i,n),h=n.width*n.height,m=new Float32Array(4*h);for(let t=0;t<h;t+=1)m[4*t]=p[3*t],m[4*t+1]=p[3*t+1],m[4*t+2]=p[3*t+2],m[4*t+3]=1;s(n.width,n.height,o.generateMipMaps,false,(()=>{const t=o.getEngine();o.type=Qe$1.TEXTURETYPE_FLOAT,o.format=Qe$1.TEXTUREFORMAT_RGBA,o._gammaSpace=false,t._uploadDataToTextureDirectly(o,m);}));}};var hdrTextureLoaderCF2CBpx6_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_HDRTextureLoader:r$1Q});let e$y=class e{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map((e=>({workerPromise:Promise.resolve(e),idle:true})));}dispose(){for(const e of this._workerInfos)e.workerPromise.then((e=>{e.terminate();}));this._workerInfos.length=0,this._pendingActions.length=0;}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e);}_executeOnIdleWorker(e){for(const s of this._workerInfos)if(s.idle)return this._execute(s,e),true;return  false}_execute(e,s){e.idle=false,e.workerPromise.then((t=>{s(t,(()=>{const s=this._pendingActions.shift();s?this._execute(e,s):e.idle=true;}));}));}};let s$s=class s extends e$y{constructor(e,t,i=s.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i;}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const s={workerPromise:this._createWorkerAsync(),idle:false};this._workerInfos.push(s),this._execute(s,e);}else this._pendingActions.push(e);}_execute(e,s){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,((t,i)=>{s(t,(()=>{i(),e.idle&&(e.timeoutId=setTimeout((()=>{e.workerPromise.then((e=>{e.terminate();}));const s=this._workerInfos.indexOf(e);-1!==s&&this._workerInfos.splice(s,1);}),this._options.idleTimeElapsedBeforeRelease));}));}));}};s$s.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};let a$Y=class a{constructor(t,s){if(this.data=t,this.isInvalid=false,!a.IsValid(t))return this.isInvalid=true,void Ie$2.Error("texture missing KTX identifier");const r=Uint32Array.BYTES_PER_ELEMENT,o=new DataView(this.data.buffer,this.data.byteOffset+12,13*r),i=67305985===o.getUint32(0,true);return this.glType=o.getUint32(1*r,i),this.glTypeSize=o.getUint32(2*r,i),this.glFormat=o.getUint32(3*r,i),this.glInternalFormat=o.getUint32(4*r,i),this.glBaseInternalFormat=o.getUint32(5*r,i),this.pixelWidth=o.getUint32(6*r,i),this.pixelHeight=o.getUint32(7*r,i),this.pixelDepth=o.getUint32(8*r,i),this.numberOfArrayElements=o.getUint32(9*r,i),this.numberOfFaces=o.getUint32(10*r,i),this.numberOfMipmapLevels=o.getUint32(11*r,i),this.bytesOfKeyValueData=o.getUint32(12*r,i),0!==this.glType?(Ie$2.Error("only compressed formats currently supported"),void(this.isInvalid=true)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(Ie$2.Error("only 2D textures currently supported"),void(this.isInvalid=true)):0!==this.numberOfArrayElements?(Ie$2.Error("texture arrays not currently supported"),void(this.isInvalid=true)):this.numberOfFaces!==s?(Ie$2.Error("number of faces expected"+s+", but found "+this.numberOfFaces),void(this.isInvalid=true)):void(this.loadType=a.COMPRESSED_2D))}uploadLevels(e,t){if(this.loadType===a.COMPRESSED_2D)this._upload2DCompressedLevels(e,t);}_upload2DCompressedLevels(e,t){let s=a.HEADER_LEN+this.bytesOfKeyValueData,r=this.pixelWidth,o=this.pixelHeight;const i=t?this.numberOfMipmapLevels:1;for(let t=0;t<i;t++){const a=new Int32Array(this.data.buffer,this.data.byteOffset+s,1)[0];s+=4;for(let i=0;i<this.numberOfFaces;i++){const n=new Uint8Array(this.data.buffer,this.data.byteOffset+s,a);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,r,o,n,i,t),s+=a,s+=3-(a+3)%4;}r=Math.max(1,.5*r),o=Math.max(1,.5*o);}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return  true}return  false}};var o$15,i$1f,n$1T;function T$c(e,t){const s=t?.jsDecoderModule||KTX2DECODER;e&&(e.wasmBaseUrl&&(s.Transcoder.WasmBaseUrl=e.wasmBaseUrl),e.wasmUASTCToASTC&&(s.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(s.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(s.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(s.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(s.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(s.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(s.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(s.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(s.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder)),t&&(t.wasmUASTCToASTC&&(s.LiteTranscoder_UASTC_ASTC.WasmBinary=t.wasmUASTCToASTC),t.wasmUASTCToBC7&&(s.LiteTranscoder_UASTC_BC7.WasmBinary=t.wasmUASTCToBC7),t.wasmUASTCToRGBA_UNORM&&(s.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=t.wasmUASTCToRGBA_UNORM),t.wasmUASTCToRGBA_SRGB&&(s.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=t.wasmUASTCToRGBA_SRGB),t.wasmUASTCToR8_UNORM&&(s.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=t.wasmUASTCToR8_UNORM),t.wasmUASTCToRG8_UNORM&&(s.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=t.wasmUASTCToRG8_UNORM),t.jsMSCTranscoder&&(s.MSCTranscoder.JSModule=t.jsMSCTranscoder),t.wasmMSCTranscoder&&(s.MSCTranscoder.WasmBinary=t.wasmMSCTranscoder),t.wasmZSTDDecoder&&(s.ZSTDDecoder.WasmBinary=t.wasmZSTDDecoder));}function _$g(e){let t;void 0===e&&"undefined"!=typeof KTX2DECODER&&(e=KTX2DECODER),onmessage=s=>{if(s.data)switch(s.data.action){case "init":{const r=s.data.urls;r&&(r.jsDecoderModule&&void 0===e&&(importScripts(r.jsDecoderModule),e=KTX2DECODER),T$c(r)),s.data.wasmBinaries&&T$c(void 0,{...s.data.wasmBinaries,jsDecoderModule:e}),t=new e.KTX2Decoder,postMessage({action:"init"});break}case "setDefaultDecoderOptions":e.KTX2Decoder.DefaultDecoderOptions=s.data.options;break;case "decode":t.decode(s.data.data,s.data.caps,s.data.options).then((e=>{const t=[];for(let s=0;s<e.mipmaps.length;++s){const r=e.mipmaps[s];r&&r.data&&t.push(r.data.buffer);}postMessage({action:"decoded",success:true,decodedData:e},t);})).catch((e=>{postMessage({action:"decoded",success:false,msg:e});}));}};}a$Y.HEADER_LEN=64,a$Y.COMPRESSED_2D=0,a$Y.COMPRESSED_3D=1,a$Y.TEX_2D=2,a$Y.TEX_3D=3,function(e){e[e.ETC1S=0]="ETC1S",e[e.UASTC4x4=1]="UASTC4x4";}(o$15||(o$15={})),function(e){e[e.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",e[e.ASTC_4x4_RGBA=0]="ASTC_4x4_RGBA",e[e.BC7_RGBA=1]="BC7_RGBA",e[e.BC3_RGBA=2]="BC3_RGBA",e[e.BC1_RGB=3]="BC1_RGB",e[e.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",e[e.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",e[e.ETC2_RGBA=6]="ETC2_RGBA",e[e.ETC1_RGB=7]="ETC1_RGB",e[e.RGBA32=8]="RGBA32",e[e.R8=9]="R8",e[e.RG8=10]="RG8";}(i$1f||(i$1f={})),function(e){e[e.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",e[e.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.RGBA8Format=32856]="RGBA8Format",e[e.R8Format=33321]="R8Format",e[e.RG8Format=33323]="RG8Format";}(n$1T||(n$1T={}));let R$e=class R{static GetDefaultNumWorkers(){return "object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(e){if(R._WorkerPoolPromise||R._DecoderModulePromise)return;const s={wasmBaseUrl:Ai.ScriptBaseUrl,jsDecoderModule:Ai.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,true),wasmUASTCToASTC:Ai.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,true),wasmUASTCToBC7:Ai.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,true),wasmUASTCToRGBA_UNORM:Ai.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,true),wasmUASTCToRGBA_SRGB:Ai.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,true),wasmUASTCToR8_UNORM:Ai.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,true),wasmUASTCToRG8_UNORM:Ai.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,true),jsMSCTranscoder:Ai.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,true),wasmMSCTranscoder:Ai.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,true),wasmZSTDDecoder:Ai.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,true)};e&&"function"==typeof Worker&&"undefined"!=typeof URL?R._WorkerPoolPromise=new Promise((t=>{const a=`${T$c}(${_$g})()`,o=URL.createObjectURL(new Blob([a],{type:"application/javascript"}));t(new s$s(e,(async()=>await async function(e,t,s){return await new Promise(((r,a)=>{const o=t=>{e.removeEventListener("error",o),e.removeEventListener("message",i),a(t);},i=t=>{"init"===t.data.action&&(e.removeEventListener("error",o),e.removeEventListener("message",i),r(e));};e.addEventListener("error",o),e.addEventListener("message",i),e.postMessage({action:"init",urls:s,wasmBinaries:t});}))}(new Worker(o),void 0,s))));})):void 0===R._KTX2DecoderModule?R._DecoderModulePromise=Ai.LoadBabylonScriptAsync(s.jsDecoderModule).then((()=>(R._KTX2DecoderModule=KTX2DECODER,R._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=false,R._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=true,T$c(s,R._KTX2DecoderModule),new R._KTX2DecoderModule.KTX2Decoder))):(R._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=false,R._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=true,R._DecoderModulePromise=Promise.resolve(new R._KTX2DecoderModule.KTX2Decoder));}constructor(e,t=R.DefaultNumWorkers){this._engine=e;const s="object"==typeof t&&t.workerPool||R.WorkerPool;if(s)R._WorkerPoolPromise=Promise.resolve(s);else {"object"==typeof t?R._KTX2DecoderModule=t?.binariesAndModulesContainer?.jsDecoderModule:"undefined"!=typeof KTX2DECODER&&(R._KTX2DecoderModule=KTX2DECODER);const e="number"==typeof t?t:t.numWorkers??R.DefaultNumWorkers;R._Initialize(e);}}async _uploadAsync(e,t,s){const r=this._engine.getCaps(),a={astc:!!r.astc,bptc:!!r.bptc,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,etc1:!!r.etc1};if(R._WorkerPoolPromise){const r=await R._WorkerPoolPromise;return await new Promise(((o,i)=>{r.push(((r,n)=>{const T=e=>{r.removeEventListener("error",T),r.removeEventListener("message",_),i(e),n();},_=e=>{if("decoded"===e.data.action){if(r.removeEventListener("error",T),r.removeEventListener("message",_),e.data.success)try{this._createTexture(e.data.decodedData,t,s),o();}catch(e){i({message:e});}else i({message:e.data.msg});n();}};r.addEventListener("error",T),r.addEventListener("message",_),r.postMessage({action:"setDefaultDecoderOptions",options:R.DefaultDecoderOptions._getKTX2DecoderOptions()});const d=new Uint8Array(e.byteLength);d.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),r.postMessage({action:"decode",data:d,caps:a,options:s},[d.buffer]);}));}))}if(R._DecoderModulePromise){const s=await R._DecoderModulePromise;return R.DefaultDecoderOptions.isDirty&&(R._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=R.DefaultDecoderOptions._getKTX2DecoderOptions()),await new Promise(((a,o)=>{s.decode(e,r).then((e=>{this._createTexture(e,t),a();})).catch((e=>{o({message:e});}));}))}throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,r){this._engine._bindTextureDirectly(3553,t),r&&(r.transcodedFormat=e.transcodedFormat,r.isInGammaSpace=e.isInGammaSpace,r.hasAlpha=e.hasAlpha,r.transcoderName=e.transcoderName);let a=true;switch(e.transcodedFormat){case 32856:t.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,t.format=Qe$1.TEXTUREFORMAT_RGBA;break;case 33321:t.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,t.format=Qe$1.TEXTUREFORMAT_R;break;case 33323:t.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,t.format=Qe$1.TEXTUREFORMAT_RG;break;default:t.format=e.transcodedFormat,a=false;}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let s=0;s<e.mipmaps.length;++s){const r=e.mipmaps[s];if(!r||!r.data)throw new Error("KTX2 container - could not transcode one of the image");a?(t.width=r.width,t.height=r.height,this._engine._uploadDataToTextureDirectly(t,r.data,0,s,void 0,true)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,r.width,r.height,r.data,0,s);}t._extension=".ktx2",t.isReady=true,this._engine._bindTextureDirectly(3553,null);}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return  true}return  false}};R$e.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},R$e.DefaultNumWorkers=R$e.GetDefaultNumWorkers(),R$e.DefaultDecoderOptions=new class{constructor(){this._isDirty=true,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=true,this._ktx2DecoderOptions={};}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=true);}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=true);}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=true);}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=true);}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=true);}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=true);}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=false;const e={};return void 0!==this._useRGBAIfASTCBC7NotAvailableWhenUASTC&&(e.useRGBAIfASTCBC7NotAvailableWhenUASTC=this._useRGBAIfASTCBC7NotAvailableWhenUASTC),void 0!==this._forceRGBA&&(e.forceRGBA=this._forceRGBA),void 0!==this._forceR8&&(e.forceR8=this._forceR8),void 0!==this._forceRG8&&(e.forceRG8=this._forceRG8),void 0!==this._bypassTranscoders&&(e.bypassTranscoders=this._bypassTranscoders),this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[i$1f.BC1_RGB,i$1f.BC3_RGBA],yes:{transcodeFormat:i$1f.RGBA32,engineFormat:32856,roundToMultiple4:false}}}),this._ktx2DecoderOptions=e,e}};let d$q=class d{constructor(){this.supportCascades=false;}loadCubeData(e,t,s,r){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const o=t.getEngine(),i=new a$Y(e,6),n=i.numberOfMipmapLevels>1&&t.generateMipMaps;o._unpackFlipY(true),i.uploadLevels(t,t.generateMipMaps),t.width=i.pixelWidth,t.height=i.pixelHeight,o._setCubeMapTextureParams(t,n,i.numberOfMipmapLevels-1),t.isReady=true,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r();}loadData(t,r,o,i){if(a$Y.IsValid(t)){r._invertVScale=!r.invertY;const e=new a$Y(t,1),i=function(e){switch(e){case Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT:return Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1;case Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:return Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3;case Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:return Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5;case Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2:return Qe$1.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2;case Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC;case Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return Qe$1.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:return Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4;case Qe$1.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM:return Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM}return null}(e.glInternalFormat);i?(r.format=i,r._useSRGBBuffer=r.getEngine()._getUseSRGBBuffer(true,r.generateMipMaps),r._gammaSpace=true):r.format=e.glInternalFormat,o(e.pixelWidth,e.pixelHeight,r.generateMipMaps,true,(()=>{e.uploadLevels(r,r.generateMipMaps);}),e.isInvalid);}else if(R$e.IsValid(t)){new R$e(r.getEngine())._uploadAsync(t,r,i).then((()=>{o(r.width,r.height,r.generateMipMaps,true,(()=>{}),false);}),(t=>{Ie$2.Warn(`Failed to load KTX2 texture data: ${t.message}`),o(0,0,false,false,(()=>{}),true);}));}else Ie$2.Error("texture missing KTX identifier"),o(0,0,false,false,(()=>{}),true);}};
var ktxTextureLoaderMXoviPI_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_KTXTextureLoader:d$q});function e$x(t){let e=0;return {id_length:t[e++],colormap_type:t[e++],image_type:t[e++],colormap_index:t[e++]|t[e++]<<8,colormap_length:t[e++]|t[e++]<<8,colormap_size:t[e++],origin:[t[e++]|t[e++]<<8,t[e++]|t[e++]<<8],width:t[e++]|t[e++]<<8,height:t[e++]|t[e++]<<8,pixel_size:t[e++],flags:t[e++]}}function r$1P(r,a){if(a.length<19)return void Ie$2.Error("Unable to load TGA file - Not enough data to contain header");let i=18;const o=e$x(a);if(o.id_length+i>a.length)return void Ie$2.Error("Unable to load TGA file - Not enough data");i+=o.id_length;let s,h=false,c=false,g=false;switch(o.image_type){case 9:h=true;case 1:c=true;break;case 10:h=true;case 2:break;case 11:h=true;case 3:g=true;}const l=o.pixel_size>>3,f=o.width*o.height*l;let d,u,w,p,_,b,y;if(c&&(d=a.subarray(i,i+=o.colormap_length*(o.colormap_size>>3))),h){let t,e,r;s=new Uint8Array(f);let n=0;const o=new Uint8Array(l);for(;i<f&&n<f;)if(t=a[i++],e=1+(127&t),128&t){for(r=0;r<l;++r)o[r]=a[i++];for(r=0;r<e;++r)s.set(o,n+r*l);n+=l*e;}else {for(e*=l,r=0;r<e;++r)s[n+r]=a[i++];n+=e;}}else s=a.subarray(i,i+=c?o.width*o.height:f);switch((48&o.flags)>>4){default:case 2:u=0,p=1,y=o.width,w=0,_=1,b=o.height;break;case 0:u=0,p=1,y=o.width,w=o.height-1,_=-1,b=-1;break;case 3:u=o.width-1,p=-1,y=-1,w=0,_=1,b=o.height;break;case 1:u=o.width-1,p=-1,y=-1,w=o.height-1,_=-1,b=-1;}const m="_getImageData"+(g?"Grey":"")+o.pixel_size+"bits",A=n$1S[m](o,d,s,w,_,b,u,p,y);r.getEngine()._uploadDataToTextureDirectly(r,A);}const n$1S={GetTGAHeader:e$x,UploadContent:r$1P,_getImageData8bits:function(t,e,r,n,a,i,o,s,h){const c=r,g=e,l=t.width,f=t.height;let d,u,w,p=0;const _=new Uint8Array(l*f*4);for(w=n;w!==i;w+=a)for(u=o;u!==h;u+=s,p++)d=c[p],_[4*(u+l*w)+3]=255,_[4*(u+l*w)+2]=g[3*d+0],_[4*(u+l*w)+1]=g[3*d+1],_[4*(u+l*w)+0]=g[3*d+2];return _},_getImageData16bits:function(t,e,r,n,a,i,o,s,h){const c=r,g=t.width,l=t.height;let f,d,u,w=0;const p=new Uint8Array(g*l*4);for(u=n;u!==i;u+=a)for(d=o;d!==h;d+=s,w+=2){f=c[w+0]+(c[w+1]<<8);const t=255*((31744&f)>>10)/31|0,e=255*((992&f)>>5)/31|0,r=255*(31&f)/31|0;p[4*(d+g*u)+0]=t,p[4*(d+g*u)+1]=e,p[4*(d+g*u)+2]=r,p[4*(d+g*u)+3]=32768&f?0:255;}return p},_getImageData24bits:function(t,e,r,n,a,i,o,s,h){const c=r,g=t.width,l=t.height;let f,d,u=0;const w=new Uint8Array(g*l*4);for(d=n;d!==i;d+=a)for(f=o;f!==h;f+=s,u+=3)w[4*(f+g*d)+3]=255,w[4*(f+g*d)+2]=c[u+0],w[4*(f+g*d)+1]=c[u+1],w[4*(f+g*d)+0]=c[u+2];return w},_getImageData32bits:function(t,e,r,n,a,i,o,s,h){const c=r,g=t.width,l=t.height;let f,d,u=0;const w=new Uint8Array(g*l*4);for(d=n;d!==i;d+=a)for(f=o;f!==h;f+=s,u+=4)w[4*(f+g*d)+2]=c[u+0],w[4*(f+g*d)+1]=c[u+1],w[4*(f+g*d)+0]=c[u+2],w[4*(f+g*d)+3]=c[u+3];return w},_getImageDataGrey8bits:function(t,e,r,n,a,i,o,s,h){const c=r,g=t.width,l=t.height;let f,d,u,w=0;const p=new Uint8Array(g*l*4);for(u=n;u!==i;u+=a)for(d=o;d!==h;d+=s,w++)f=c[w],p[4*(d+g*u)+0]=f,p[4*(d+g*u)+1]=f,p[4*(d+g*u)+2]=f,p[4*(d+g*u)+3]=255;return p},_getImageDataGrey16bits:function(t,e,r,n,a,i,o,s,h){const c=r,g=t.width,l=t.height;let f,d,u=0;const w=new Uint8Array(g*l*4);for(d=n;d!==i;d+=a)for(f=o;f!==h;f+=s,u+=2)w[4*(f+g*d)+0]=c[u+0],w[4*(f+g*d)+1]=c[u+0],w[4*(f+g*d)+2]=c[u+0],w[4*(f+g*d)+3]=c[u+1];return w}};let a$X=class a{constructor(){this.supportCascades=false;}loadCubeData(){throw ".env not supported in Cube."}loadData(t,n,a){const i=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),o=e$x(i);a(o.width,o.height,n.generateMipMaps,false,(()=>{r$1P(n,i);}));}};var tgaTextureLoaderBjuFwILe_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_TGATextureLoader:a$X});const o$14=65536,a$W=14,i$1e=65537,l$m=16384;var s$r,c$k;!function(e){e[e.NO_COMPRESSION=0]="NO_COMPRESSION",e[e.RLE_COMPRESSION=1]="RLE_COMPRESSION",e[e.ZIPS_COMPRESSION=2]="ZIPS_COMPRESSION",e[e.ZIP_COMPRESSION=3]="ZIP_COMPRESSION",e[e.PIZ_COMPRESSION=4]="PIZ_COMPRESSION",e[e.PXR24_COMPRESSION=5]="PXR24_COMPRESSION";}(s$r||(s$r={})),function(e){e[e.INCREASING_Y=0]="INCREASING_Y",e[e.DECREASING_Y=1]="DECREASING_Y";}(c$k||(c$k={}));const u$n=function(){const e=new ArrayBuffer(4),n=new Float32Array(e),t=new Uint32Array(e),r=new Uint32Array(512),o=new Uint32Array(512);for(let e=0;e<256;++e){const n=e-127;n<-27?(r[e]=0,r[256|e]=32768,o[e]=24,o[256|e]=24):n<-14?(r[e]=1024>>-n-14,r[256|e]=1024>>-n-14|32768,o[e]=-n-1,o[256|e]=-n-1):n<=15?(r[e]=n+15<<10,r[256|e]=n+15<<10|32768,o[e]=13,o[256|e]=13):n<128?(r[e]=31744,r[256|e]=64512,o[e]=24,o[256|e]=24):(r[e]=31744,r[256|e]=64512,o[e]=13,o[256|e]=13);}const a=new Uint32Array(2048),i=new Uint32Array(64),l=new Uint32Array(64);for(let e=1;e<1024;++e){let n=e<<13,t=0;for(;!(8388608&n);)n<<=1,t-=8388608;n&=-8388609,t+=947912704,a[e]=n|t;}for(let e=1024;e<2048;++e)a[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)i[e]=e<<23;i[31]=1199570944,i[32]=2147483648;for(let e=33;e<63;++e)i[e]=2147483648+(e-32<<23);i[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(l[e]=1024);return {floatView:n,uint32View:t,baseTable:r,shiftTable:o,mantissaTable:a,exponentTable:i,offsetTable:l}}();function f$w(e,n){const t=new Uint8Array(e);let r=0;for(;0!=t[n.value+r];)r+=1;const o=(new TextDecoder).decode(t.slice(n.value,n.value+r));return n.value=n.value+r+1,o}function w$7(e,n){const t=e.getInt32(n.value,true);return n.value+=4,t}function h$a(e,n){const t=e.getUint32(n.value,true);return n.value+=4,t}function p$l(e,n){const t=e.getUint8(n.value);return n.value+=1,t}function d$p(e,n){const t=e.getUint16(n.value,true);return n.value+=2,t}function y$c(e,n){const t=e[n.value];return n.value+=1,t}function b$e(e,n){let t;return t="getBigInt64"in DataView.prototype?Number(e.getBigInt64(n.value,true)):e.getUint32(n.value+4,true)+Number(e.getUint32(n.value,true)<<32),n.value+=8,t}function v$c(e,n){const t=e.getFloat32(n.value,true);return n.value+=4,t}function E$k(e,n){return function(e){const n=(31744&e)>>10,t=1023&e;return (e>>15?-1:1)*(n?31===n?t?NaN:1/0:Math.pow(2,n-15)*(1+t/1024):t/1024*6103515625e-14)}(d$p(e,n))}function S$c(n,t){return function(n){if(Math.abs(n)>65504)throw new Error("Value out of range.Consider using float instead of half-float.");n=U$5(n,-65504,65504),u$n.floatView[0]=n;const t=u$n.uint32View[0],r=t>>23&511;return u$n.baseTable[r]+((8388607&t)>>u$n.shiftTable[r])}(v$c(n,t))}function A$d(e,n,t,r){switch(t){case "string":case "stringvector":case "iccProfile":return function(e,n,t){const r=(new TextDecoder).decode(new Uint8Array(e).slice(n.value,n.value+t));return n.value=n.value+t,r}(e.buffer,n,r);case "chlist":return function(e,n,t){const r=n.value,o=[];for(;n.value<r+t-1;){const t=f$w(e.buffer,n),r=w$7(e,n),a=p$l(e,n);n.value+=3;const i=w$7(e,n),l=w$7(e,n);o.push({name:t,pixelType:r,pLinear:a,xSampling:i,ySampling:l});}return n.value+=1,o}(e,n,r);case "chromaticities":return function(e,n){return {redX:v$c(e,n),redY:v$c(e,n),greenX:v$c(e,n),greenY:v$c(e,n),blueX:v$c(e,n),blueY:v$c(e,n),whiteX:v$c(e,n),whiteY:v$c(e,n)}}(e,n);case "compression":return function(e,n){return p$l(e,n)}(e,n);case "box2i":return function(e,n){return {xMin:w$7(e,n),yMin:w$7(e,n),xMax:w$7(e,n),yMax:w$7(e,n)}}(e,n);case "lineOrder":return function(e,n){const t=p$l(e,n);return c$k[t]}(e,n);case "float":return v$c(e,n);case "v2f":return function(e,n){return [v$c(e,n),v$c(e,n)]}(e,n);case "v3f":return function(e,n){return [v$c(e,n),v$c(e,n),v$c(e,n)]}(e,n);case "int":return w$7(e,n);case "rational":return function(e,n){return [w$7(e,n),h$a(e,n)]}(e,n);case "timecode":return function(e,n){return [h$a(e,n),h$a(e,n)]}(e,n);case "preview":return n.value+=r,"skipped";default:return void(n.value+=r)}}function g$h(e){for(let n=1;n<e.length;n++){const t=e[n-1]+e[n]-128;e[n]=t;}}function O$f(e,n){let t=0,r=Math.floor((e.length+1)/2),o=0;const a=e.length-1;for(;!(o>a||(n[o++]=e[t++],o>a));)n[o++]=e[r++];}function R$d(e,n,t,r,o){for(;t<e;)n=n<<8|y$c(r,o),t+=8;return {l:n>>(t-=e)&(1<<e)-1,c:n,lc:t}}function C$d(e,n,t,r){return {c:e=e<<8|y$c(t,r),lc:n+=8}}function U$4(e,n,t,r,o,a,i,l,s){if(e==n){if(r<8){const e=C$d(t,r,o,a);t=e.c,r=e.lc;}let e=t>>(r-=8);if(e=new Uint8Array([e])[0],l.value+e>s)return null;const n=i[l.value-1];for(;e-- >0;)i[l.value++]=n;}else {if(!(l.value<s))return null;i[l.value++]=e;}return {c:t,lc:r}}const I$e=new Array(59);function T$b(e,n,t,r,o,a){const l=n;let s=0,c=0;for(;r<=o;r++){if(l.value-n.value>t)return;let i=R$d(6,s,c,e,l);const u=i.l;if(s=i.c,c=i.lc,a[r]=u,63==u){if(l.value-n.value>t)throw new Error("Error in HufUnpackEncTable");i=R$d(8,s,c,e,l);let u=i.l+6;if(s=i.c,c=i.lc,r+u>o+1)throw new Error("Error in HufUnpackEncTable");for(;u--;)a[r++]=0;r--;}else if(u>=59){let e=u-59+2;if(r+e>o+1)throw new Error("Error in HufUnpackEncTable");for(;e--;)a[r++]=0;r--;}}!function(e){for(let e=0;e<=58;++e)I$e[e]=0;for(let n=0;n<i$1e;++n)I$e[e[n]]+=1;let n=0;for(let e=58;e>0;--e){const t=n+I$e[e]>>1;I$e[e]=n,n=t;}for(let n=0;n<i$1e;++n){const t=e[n];t>0&&(e[n]=t|I$e[t]++<<6);}}(a);}function m$n(e){return 63&e}function M$c(e){return e>>6}function P$8(e,n,t,r,o,s){const c=t.value,u=h$a(n,t),f=h$a(n,t);t.value+=4;const w=h$a(n,t);if(t.value+=4,u<0||u>=i$1e||f<0||f>=i$1e)throw new Error("Wrong HUF_ENCSIZE");const p=new Array(i$1e),d=new Array(l$m);!function(e){for(let n=0;n<l$m;n++)e[n]={},e[n].len=0,e[n].lit=0,e[n].p=null;}(d);if(T$b(e,t,r-(t.value-c),u,f,p),w>8*(r-(t.value-c)))throw new Error("Wrong hufUncompress");!function(e,n,t,r){for(;n<=t;n++){const t=M$c(e[n]),o=m$n(e[n]);if(t>>o)throw new Error("Invalid table entry");if(o>a$W){const e=r[t>>o-a$W];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const n=e.p;e.p=new Array(e.lit);for(let t=0;t<e.lit-1;++t)e.p[t]=n[t];}else e.p=new Array(1);e.p[e.lit-1]=n;}else if(o){let e=0;for(let i=1<<a$W-o;i>0;i--){const i=r[(t<<a$W-o)+e];if(i.len||i.p)throw new Error("Invalid table entry");i.len=o,i.lit=n,e++;}}}}(p,u,f,d),function(e,n,t,r,o,i,l,s,c){let u=0,f=0;const w=l,h=Math.trunc(r.value+(o+7)/8);for(;r.value<h;){let o=C$d(u,f,t,r);for(u=o.c,f=o.lc;f>=a$W;){const l=n[u>>f-a$W&16383];if(l.len){f-=l.len;const e=U$4(l.lit,i,u,f,t,r,s,c,w);e&&(u=e.c,f=e.lc);}else {if(!l.p)throw new Error("hufDecode issues");let n;for(n=0;n<l.lit;n++){const a=m$n(e[l.p[n]]);for(;f<a&&r.value<h;)o=C$d(u,f,t,r),u=o.c,f=o.lc;if(f>=a&&M$c(e[l.p[n]])==(u>>f-a&(1<<a)-1)){f-=a;const e=U$4(l.p[n],i,u,f,t,r,s,c,w);e&&(u=e.c,f=e.lc);break}}if(n==l.lit)throw new Error("HufDecode issues")}}}const p=8-o&7;for(u>>=p,f-=p;f>0;){const e=n[u<<a$W-f&16383];if(!e.len)throw new Error("HufDecode issues");{f-=e.len;const n=U$4(e.lit,i,u,f,t,r,s,c,w);n&&(u=n.c,f=n.lc);}}}(p,d,e,t,w,f,s,o,{value:0});}function N$b(e){return 65535&e}function x$c(e){const n=N$b(e);return n>32767?n-65536:n}function _$f(e,n){const t=x$c(e),r=x$c(n),o=t+(1&r)+(r>>1);return {a:o,b:o-r}}function F$7(e,n){const t=N$b(e),r=N$b(n),o=t-(r>>1)&65535;return {a:r+o-32768&65535,b:o}}function k$6(e,n,t,r,o,a,i){const l=i<16384,s=t>o?o:t;let c,u,f=1;for(;f<=s;)f<<=1;for(f>>=1,c=f,f>>=1;f>=1;){u=0;const i=u+a*(o-c),s=a*f,w=a*c,h=r*f,p=r*c;let d,y,b,v;for(;u<=i;u+=w){let o=u;const a=u+r*(t-c);for(;o<=a;o+=p){const t=o+h,r=o+s,a=r+h;if(l){let i=_$f(e[o+n],e[r+n]);d=i.a,b=i.b,i=_$f(e[t+n],e[a+n]),y=i.a,v=i.b,i=_$f(d,y),e[o+n]=i.a,e[t+n]=i.b,i=_$f(b,v),e[r+n]=i.a,e[a+n]=i.b;}else {let i=F$7(e[o+n],e[r+n]);d=i.a,b=i.b,i=F$7(e[t+n],e[a+n]),y=i.a,v=i.b,i=F$7(d,y),e[o+n]=i.a,e[t+n]=i.b,i=F$7(b,v),e[r+n]=i.a,e[a+n]=i.b;}}if(t&f){const t=o+s;let r;r=l?_$f(e[o+n],e[t+n]):F$7(e[o+n],e[t+n]),d=r.a,e[t+n]=r.b,e[o+n]=d;}}if(o&f){let o=u;const a=u+r*(t-c);for(;o<=a;o+=p){const t=o+h;let r;r=l?_$f(e[o+n],e[t+n]):F$7(e[o+n],e[t+n]),d=r.a,e[t+n]=r.b,e[o+n]=d;}}c=f,f>>=1;}return u}function z$6(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function L$6(e){const n=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),t=new Uint8Array(function(e){let n=e.byteLength;const t=[];let r=0;const o=new DataView(e);for(;n>0;){const e=o.getInt8(r++);if(e<0){const a=-e;n-=a+1;for(let e=0;e<a;e++)t.push(o.getUint8(r++));}else {const a=e;n-=2;const i=o.getUint8(r++);for(let e=0;e<a+1;e++)t.push(i);}}return t}(n)),r=new Uint8Array(t.length);return g$h(t),O$f(t,r),new DataView(r.buffer)}function D$8(e){const n=e.array.slice(e.offset.value,e.offset.value+e.size),t=fflate.unzlibSync(n),r=new Uint8Array(t.length);return g$h(t),O$f(t,r),new DataView(r.buffer)}function B$6(e){const n=e.array.slice(e.offset.value,e.offset.value+e.size),t=fflate.unzlibSync(n),r=e.lines*e.channels*e.width,o=1==e.type?new Uint16Array(r):new Uint32Array(r);let a=0,i=0;const l=new Array(4);for(let n=0;n<e.lines;n++)for(let n=0;n<e.channels;n++){let n=0;switch(e.type){case 1:l[0]=a,l[1]=l[0]+e.width,a=l[1]+e.width;for(let r=0;r<e.width;++r){n+=t[l[0]++]<<8|t[l[1]++],o[i]=n,i++;}break;case 2:l[0]=a,l[1]=l[0]+e.width,l[2]=l[1]+e.width,a=l[2]+e.width;for(let r=0;r<e.width;++r){n+=t[l[0]++]<<24|t[l[1]++]<<16|t[l[2]++]<<8,o[i]=n,i++;}}}return new DataView(o.buffer)}function W$3(e){const n=e.viewer,t={value:e.offset.value},r=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),a=new Uint8Array(8192);let i=0;const l=new Array(e.channels);for(let n=0;n<e.channels;n++)l[n]={},l[n].start=i,l[n].end=l[n].start,l[n].nx=e.width,l[n].ny=e.lines,l[n].size=e.type,i+=l[n].nx*l[n].ny*l[n].size;const s=d$p(n,t),c=d$p(n,t);if(c>=8192)throw new Error("Wrong PIZ_COMPRESSION BITMAP_SIZE");if(s<=c)for(let e=0;e<c-s+1;e++)a[e+s]=p$l(n,t);const u=new Uint16Array(o$14),f=function(e,n){let t=0;for(let r=0;r<o$14;++r)(0==r||e[r>>3]&1<<(7&r))&&(n[t++]=r);const r=t-1;for(;t<o$14;)n[t++]=0;return r}(a,u),w=h$a(n,t);P$8(e.array,n,t,w,r,i);for(let n=0;n<e.channels;++n){const e=l[n];for(let t=0;t<l[n].size;++t)k$6(r,e.start+t,e.nx,e.size,e.ny,e.nx*e.size,f);}!function(e,n,t){for(let r=0;r<t;++r)n[r]=e[n[r]];}(u,r,i);let y=0;const b=new Uint8Array(r.buffer.byteLength);for(let n=0;n<e.lines;n++)for(let n=0;n<e.channels;n++){const e=l[n],t=e.nx*e.size,o=new Uint8Array(r.buffer,2*e.end,2*t);b.set(o,y),y+=2*t,e.end+=t;}return new DataView(b.buffer)}var X$3;!function(e){e[e.Float=0]="Float",e[e.HalfFloat=1]="HalfFloat";}(X$3||(X$3={}));let Y$4=class Y{};Y$4.DefaultOutputType=X$3.HalfFloat,Y$4.FFLATEUrl="https://unpkg.com/fflate@0.8.2";let G$3=class G{constructor(){this.supportCascades=false;}loadCubeData(e,n,t,r,o){throw ".exr not supported in Cube."}loadData(e,o,a){const i=new DataView(e.buffer),l={value:0},c=function(e,t){if(20000630!=e.getUint32(0,true))throw new Error("Incorrect OpenEXR format");const r=e.getUint8(4),o=e.getUint8(5),a={singleTile:!!(2&o),longName:!!(4&o),deepFormat:!!(8&o),multiPart:!!(16&o)};t.value=8;const i={};let l=true;for(;l;){const r=f$w(e.buffer,t);if(r){const o=f$w(e.buffer,t),a=A$d(e,t,o,h$a(e,t));void 0===a?Ie$2.Warn(`Unknown header attribute type ${o}'.`):i[r]=a;}else l=false;}if(-5&o)throw new Error("Unsupported file format");return {version:r,spec:a,...i}}(i,l);(async function(e,n,o,a){const i={size:0,viewer:n,array:new Uint8Array(n.buffer),offset:o,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,channelLineOffsets:{},scanOrder:()=>0,bytesPerLine:0,outLineWidth:0,lines:0,scanlineBlockSize:0,inputSize:null,type:0,uncompress:null,getter:()=>0,format:Qe$1.TEXTUREFORMAT_RGBA,outputChannels:0,decodeChannels:{},blockCount:null,byteArray:null,linearSpace:false,textureType:0};switch(e.compression){case s$r.NO_COMPRESSION:i.lines=1,i.uncompress=z$6;break;case s$r.RLE_COMPRESSION:i.lines=1,i.uncompress=L$6;break;case s$r.ZIPS_COMPRESSION:i.lines=1,i.uncompress=D$8,await Ai.LoadScriptAsync(Y$4.FFLATEUrl);break;case s$r.ZIP_COMPRESSION:i.lines=16,i.uncompress=D$8,await Ai.LoadScriptAsync(Y$4.FFLATEUrl);break;case s$r.PIZ_COMPRESSION:i.lines=32,i.uncompress=W$3;break;case s$r.PXR24_COMPRESSION:i.lines=16,i.uncompress=B$6,await Ai.LoadScriptAsync(Y$4.FFLATEUrl);break;default:throw new Error(s$r[e.compression]+" is unsupported")}i.scanlineBlockSize=i.lines;const l={};for(const n of e.channels)switch(n.name){case "R":case "G":case "B":case "A":case "Y":l[n.name]=true,i.type=n.pixelType;}let c=false;if(l.R&&l.G&&l.B&&l.A)i.outputChannels=4,i.decodeChannels={R:0,G:1,B:2,A:3};else if(l.R&&l.G&&l.B)c=true,i.outputChannels=4,i.decodeChannels={R:0,G:1,B:2,A:3};else if(l.R&&l.G)i.outputChannels=2,i.decodeChannels={R:0,G:1};else if(l.R)i.outputChannels=1,i.decodeChannels={R:0};else {if(!l.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");i.outputChannels=1,i.decodeChannels={Y:0};}if(1===i.type)switch(a){case X$3.Float:i.getter=E$k,i.inputSize=2;break;case X$3.HalfFloat:i.getter=d$p,i.inputSize=2;}else {if(2!==i.type)throw new Error("Unsupported pixelType "+i.type+" for "+e.compression);switch(a){case X$3.Float:i.getter=v$c,i.inputSize=4;break;case X$3.HalfFloat:i.getter=S$c,i.inputSize=4;}}i.blockCount=i.height/i.scanlineBlockSize;for(let e=0;e<i.blockCount;e++)b$e(n,o);const u=i.width*i.height*i.outputChannels;switch(a){case X$3.Float:i.byteArray=new Float32Array(u),i.textureType=Qe$1.TEXTURETYPE_FLOAT,c&&i.byteArray.fill(1,0,u);break;case X$3.HalfFloat:i.byteArray=new Uint16Array(u),i.textureType=Qe$1.TEXTURETYPE_HALF_FLOAT,c&&i.byteArray.fill(15360,0,u);break;default:throw new Error("Unsupported type: "+a)}let f=0;for(const n of e.channels) void 0!==i.decodeChannels[n.name]&&(i.channelLineOffsets[n.name]=f*i.width),f+=2*n.pixelType;return i.bytesPerLine=i.width*f,i.outLineWidth=i.width*i.outputChannels,"INCREASING_Y"===e.lineOrder?i.scanOrder=e=>e:i.scanOrder=e=>i.height-1-e,4==i.outputChannels?(i.format=Qe$1.TEXTUREFORMAT_RGBA,i.linearSpace=true):(i.format=Qe$1.TEXTUREFORMAT_R,i.linearSpace=false),i})(c,i,l,Y$4.DefaultOutputType).then((e=>{!function(e,n,t,r){const o={value:0};for(let a=0;a<e.height/e.scanlineBlockSize;a++){const i=w$7(t,r)-n.dataWindow.yMin;e.size=h$a(t,r),e.lines=i+e.scanlineBlockSize>e.height?e.height-i:e.scanlineBlockSize;const l=e.size<e.lines*e.bytesPerLine&&e.uncompress?e.uncompress(e):z$6(e);r.value+=e.size;for(let t=0;t<e.scanlineBlockSize;t++){const r=a*e.scanlineBlockSize,i=t+e.scanOrder(r);if(i>=e.height)continue;const s=t*e.bytesPerLine,c=(e.height-1-i)*e.outLineWidth;for(let t=0;t<e.channels;t++){const r=n.channels[t].name,a=e.channelLineOffsets[r],i=e.decodeChannels[r];if(void 0!==i){o.value=s+a;for(let n=0;n<e.width;n++){const t=c+n*e.outputChannels+i;e.byteArray&&(e.byteArray[t]=e.getter(l,o));}}}}}}(e,c,i,l);const n=c.dataWindow.xMax-c.dataWindow.xMin+1,t=c.dataWindow.yMax-c.dataWindow.yMin+1;a(n,t,o.generateMipMaps,false,(()=>{const n=o.getEngine();o.format=c.format,o.type=e.textureType,o.invertY=false,o._gammaSpace=!c.linearSpace,e.byteArray&&n._uploadDataToTextureDirectly(o,e.byteArray,0,0,void 0,true);}));})).catch((e=>{Ie$2.Error("Failed to load EXR texture: ",e);}));}};
var exrTextureLoaderDverv0f3_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_ExrTextureLoader:G$3});function t$1g(t){return Math.floor(t/8)}function e$w(t){return 1<<t%8}let o$13=class o{constructor(t){this.size=t,this._byteArray=new Uint8Array(Math.ceil(this.size/8));}get(o){if(o>=this.size)throw new RangeError("Bit index out of range");const r=t$1g(o),n=e$w(o);return 0!==(this._byteArray[r]&n)}set(o,r){if(o>=this.size)throw new RangeError("Bit index out of range");const n=t$1g(o),s=e$w(o);r?this._byteArray[n]|=s:this._byteArray[n]&=~s;}};function r$1O(t){const e=[],r=t.length/3;for(let o=0;o<r;o++)e.push([t[3*o],t[3*o+1],t[3*o+2]]);const n=new Map;for(let t=0;t<e.length;t++){const o=e[t];for(const e of o){let o=n.get(e);o||n.set(e,o=[]),o.push(t);}}const s=new o$13(r),i=[],f=t=>{const o=[t];for(;o.length>0;){const t=o.pop();if(!s.get(t)){s.set(t,true),i.push(e[t]);for(const r of e[t]){const t=n.get(r);if(!t)return;for(const e of t)s.get(e)||o.push(e);}}}};for(let t=0;t<r;t++)s.get(t)||f(t);let c=0;for(const e of i)t[c++]=e[0],t[c++]=e[1],t[c++]=e[2];}var mesh_vertexData_functionsD0Kx5Kh7_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,OptimizeIndices:r$1O});const n$1R="postprocessVertexShader",t$1f="attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";bt$1.ShadersStoreWGSL[n$1R]||(bt$1.ShadersStoreWGSL[n$1R]=t$1f);const s$q={name:n$1R,shader:t$1f};var postprocess_vertexBOHFNm19_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,postprocessVertexShaderWGSL:s$q});const r$1N="kernelBlurVaryingDeclaration";bt$1.IncludesShadersStoreWGSL[r$1N]||(bt$1.IncludesShadersStoreWGSL[r$1N]="varying sampleCoord{X}: vec2f;");const t$1e="packingFunctions";bt$1.IncludesShadersStoreWGSL[t$1e]||(bt$1.IncludesShadersStoreWGSL[t$1e]="fn pack(depth: f32)->vec4f\n{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfn unpack(color: vec4f)->f32\n{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}");const n$1Q="kernelBlurFragment";bt$1.IncludesShadersStoreWGSL[n$1Q]||(bt$1.IncludesShadersStoreWGSL[n$1Q]="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X})*computedWeight;\n#endif\n");const r$1M="kernelBlurFragment2";bt$1.IncludesShadersStoreWGSL[r$1M]||(bt$1.IncludesShadersStoreWGSL[r$1M]="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n");const t$1d="kernelBlurPixelShader",a$V="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform delta: vec2f;varying sampleCenter: vec2f;\n#ifdef DOF\nvar circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;fn sampleCoC(offset: vec2f)->f32 {var coc: f32=textureSample(circleOfConfusionSampler,circleOfConfusionSamplerSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var computedWeight: f32=0.0;\n#ifdef PACKEDFLOAT\nvar blend: f32=0.;\n#else\nvar blend: vec4f= vec4f(0.);\n#endif\n#ifdef DOF\nvar sumOfWeights: f32=CENTER_WEIGHT; \nvar factor: f32=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,input.sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,input.sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\nfragmentOutputs.color=pack(blend);\n#else\nfragmentOutputs.color=blend;\n#endif\n#ifdef DOF\nfragmentOutputs.color/=sumOfWeights;\n#endif\n}";bt$1.ShadersStoreWGSL[t$1d]||(bt$1.ShadersStoreWGSL[t$1d]=a$V);const l$l={name:t$1d,shader:a$V};var kernelBlur_fragmentDeDE4Pu__esm_min=/*#__PURE__*/Object.freeze({__proto__:null,kernelBlurPixelShaderWGSL:l$l});const n$1P="kernelBlurVertex";bt$1.IncludesShadersStoreWGSL[n$1P]||(bt$1.IncludesShadersStoreWGSL[n$1P]="vertexOutputs.sampleCoord{X}=vertexOutputs.sampleCenter+uniforms.delta*KERNEL_OFFSET{X};");const t$1c="kernelBlurVertexShader",r$1L="attribute position: vec2f;uniform delta: vec2f;varying sampleCenter: vec2f;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.sampleCenter=(input.position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\nvertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStoreWGSL[t$1c]||(bt$1.ShadersStoreWGSL[t$1c]=r$1L);const i$1d={name:t$1c,shader:r$1L};var kernelBlur_vertexCLah75Pm_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,kernelBlurVertexShaderWGSL:i$1d});const r$1K="kernelBlurVaryingDeclaration";bt$1.IncludesShadersStore[r$1K]||(bt$1.IncludesShadersStore[r$1K]="varying vec2 sampleCoord{X};");const n$1O="kernelBlurFragment";bt$1.IncludesShadersStore[n$1O]||(bt$1.IncludesShadersStore[n$1O]="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n");const t$1b="kernelBlurFragment2";bt$1.IncludesShadersStore[t$1b]||(bt$1.IncludesShadersStore[t$1b]="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n");const r$1J="kernelBlurPixelShader",l$k="uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";bt$1.ShadersStore[r$1J]||(bt$1.ShadersStore[r$1J]=l$k);const d$o={name:r$1J,shader:l$k};var kernelBlur_fragmentBf2cC1eV_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,kernelBlurPixelShader:d$o});const n$1N="kernelBlurVertex";bt$1.IncludesShadersStore[n$1N]||(bt$1.IncludesShadersStore[n$1N]="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};");const r$1I="kernelBlurVertexShader",i$1c="attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStore[r$1I]||(bt$1.ShadersStore[r$1I]=i$1c);const t$1a={name:r$1I,shader:i$1c};var kernelBlur_vertexDnW06C5q_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,kernelBlurVertexShader:t$1a});const n$1M="bayerDitherFunctions";bt$1.IncludesShadersStore[n$1M]||(bt$1.IncludesShadersStore[n$1M]="float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}\nfloat bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfloat bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n");const a$U="shadowMapFragmentExtraDeclaration";bt$1.IncludesShadersStore[a$U]||(bt$1.IncludesShadersStore[a$U]="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform vec2 softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;varying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n");const r$1H="shadowMapFragment";bt$1.IncludesShadersStore[r$1H]||(bt$1.IncludesShadersStore[r$1H]="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\ndepthSM=clamp(depthSM,0.0,1.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;");const i$1b="shadowMapPixelShader",t$19="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nvec4 opacityMap=texture2D(diffuseSampler,vUV);float alphaFromAlphaTexture=opacityMap.a;\n#if SM_SOFTTRANSPARENTSHADOW==1\nif (softTransparentShadowSM.y==1.0) {opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}\n#endif\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";bt$1.ShadersStore[i$1b]||(bt$1.ShadersStore[i$1b]=t$19);const S$b={name:i$1b,shader:t$19};var shadowMap_fragmentIJyPkm9u_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,shadowMapPixelShader:S$b});const n$1L="helperFunctions";bt$1.IncludesShadersStore[n$1L]||(bt$1.IncludesShadersStore[n$1L]="const float PI=3.1415926535897932384626433832795;const float TWO_PI=6.283185307179586;const float HALF_PI=1.5707963267948966;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float RECIPROCAL_PI4=0.07957747154594767;const float HALF_MIN=5.96046448e-08; \nconst float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;\n#define saturate(x) clamp(x,0.0,1.0)\n#define absEps(x) abs(x)+Epsilon\n#define maxEps(x) max(x,Epsilon)\n#define saturateEps(x) clamp(x,Epsilon,1.0)\nmat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);return outMatrix;}\nmat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}\n#if USE_EXACT_SRGB_CONVERSIONS\nvec3 toLinearSpaceExact(vec3 color)\n{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));\n#else\nreturn\nvec3(\ncolor.r<=0.04045 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.04045 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.04045 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\nvec3 toGammaSpaceExact(vec3 color)\n{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));\n#else\nreturn\nvec3(\ncolor.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\n#endif\nfloat toLinearSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nvec3 toLinearSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3(LinearEncodePowerApprox));\n#endif\n}\nvec4 toLinearSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfloat toGammaSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,GammaEncodePowerApprox);\n#endif\n}\nvec3 toGammaSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3(GammaEncodePowerApprox));\n#endif\n}\nvec4 toGammaSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfloat square(float value)\n{return value*value;}\nvec3 square(vec3 value)\n{return value*value;}\nfloat pow5(float value) {float sq=value*value;return sq*sq*value;}\nfloat getLuminance(vec3 color)\n{return saturate(dot(color,LuminanceEncodeApprox));}\nfloat getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}\nfloat dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}\nconst float rgbdMaxRange=255.;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =saturate(floor(D)/255.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(saturate(rgb),D);}\nvec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}\nvec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*TWO_PI-PI;float latitude=HALF_PI-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\nfloat sqrtClamped(float value) {return sqrt(max(value,0.));}\nfloat avg(vec3 value) {return dot(value,vec3(0.333333333));}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE) \nuint extractBits(uint value,int offset,int width) {return (value>>offset) & ((1u<<width)-1u);}\nint onlyBitPosition(uint value) {return (floatBitsToInt(float(value))>>23)-0x7f;}\n#endif\n");const n$1K="sceneUboDeclaration";bt$1.IncludesShadersStore[n$1K]||(bt$1.IncludesShadersStore[n$1K]="layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nmat4 view;mat4 projection;vec4 vEyePosition;};\n");const i$1a="meshUboDeclaration";bt$1.IncludesShadersStore[i$1a]||(bt$1.IncludesShadersStore[i$1a]="#ifdef WEBGL2\nuniform mat4 world;uniform float visibility;\n#else\nlayout(std140,column_major) uniform;uniform Mesh\n{mat4 world;float visibility;};\n#endif\n#define WORLD_UBO\n");const n$1J="sceneVertexDeclaration";bt$1.IncludesShadersStore[n$1J]||(bt$1.IncludesShadersStore[n$1J]="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;\n");const i$19="meshVertexDeclaration";bt$1.IncludesShadersStore[i$19]||(bt$1.IncludesShadersStore[i$19]="uniform mat4 world;uniform float visibility;\n");const o$12="shadowMapVertexDeclaration";bt$1.IncludesShadersStore[o$12]||(bt$1.IncludesShadersStore[o$12]="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n");const r$1G="shadowMapUboDeclaration";bt$1.IncludesShadersStore[r$1G]||(bt$1.IncludesShadersStore[r$1G]="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n");const t$18="shadowMapVertexExtraDeclaration";bt$1.IncludesShadersStore[t$18]||(bt$1.IncludesShadersStore[t$18]="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n");const d$n="shadowMapVertexNormalBias";bt$1.IncludesShadersStore[d$n]||(bt$1.IncludesShadersStore[d$n]="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n");const a$T="shadowMapVertexMetric";bt$1.IncludesShadersStore[a$T]||(bt$1.IncludesShadersStore[a$T]="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;gl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n");const l$j="shadowMapVertexShader",s$p="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";bt$1.ShadersStore[l$j]||(bt$1.ShadersStore[l$j]=s$p);const S$a={name:l$j,shader:s$p};var shadowMap_vertexRF2sPjTk_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,shadowMapVertexShader:S$a});const r$1F="depthBoxBlurPixelShader",o$11="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}";bt$1.ShadersStore[r$1F]||(bt$1.ShadersStore[r$1F]=o$11);const n$1I={name:r$1F,shader:o$11};var depthBoxBlur_fragmentBvwLRlf3_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,depthBoxBlurPixelShader:n$1I});const r$1E="shadowMapFragmentSoftTransparentShadow",e$v="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alpha) discard;\n#endif\n";bt$1.IncludesShadersStore[r$1E]||(bt$1.IncludesShadersStore[r$1E]=e$v);const o$10={name:r$1E,shader:e$v};var shadowMapFragmentSoftTransparentShadowCRB_Mg46_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,shadowMapFragmentSoftTransparentShadow:o$10});const e$u="clipPlaneFragmentDeclaration";bt$1.IncludesShadersStoreWGSL[e$u]||(bt$1.IncludesShadersStoreWGSL[e$u]="#ifdef CLIPPLANE\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nvarying fClipDistance6: f32;\n#endif\n");const i$18="clipPlaneFragment";bt$1.IncludesShadersStoreWGSL[i$18]||(bt$1.IncludesShadersStoreWGSL[i$18]="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fragmentInputs.fClipDistance>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE2\nelse if (fragmentInputs.fClipDistance2>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE3\nelse if (fragmentInputs.fClipDistance3>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE4\nelse if (fragmentInputs.fClipDistance4>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE5\nelse if (fragmentInputs.fClipDistance5>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE6\nelse if (fragmentInputs.fClipDistance6>0.0)\n{discard;}\n#endif\n");const n$1H="bayerDitherFunctions";bt$1.IncludesShadersStoreWGSL[n$1H]||(bt$1.IncludesShadersStoreWGSL[n$1H]="fn bayerDither2(_P: vec2f)->f32 {return ((2.0*_P.y+_P.x+1.0)%(4.0));}\nfn bayerDither4(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); \nvar P2: vec2f=floor(0.5*((_P)%(4.0))); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfn bayerDither8(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); \nvar P2: vec2f=floor(0.5 *((_P)%(4.0))); \nvar P4: vec2f=floor(0.25*((_P)%(8.0))); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n");const a$S="shadowMapFragmentExtraDeclaration";bt$1.IncludesShadersStoreWGSL[a$S]||(bt$1.IncludesShadersStoreWGSL[a$S]="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform softTransparentShadowSM: vec2f;\n#endif\nvarying vDepthMetricSM: f32;\n#if SM_USEDISTANCE==1\nuniform lightDataSM: vec3f;varying vPositionWSM: vec3f;\n#endif\nuniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying zSM: f32;\n#endif\n");const r$1D="shadowMapFragment";bt$1.IncludesShadersStoreWGSL[r$1D]||(bt$1.IncludesShadersStoreWGSL[r$1D]="var depthSM: f32=fragmentInputs.vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\ndepthSM=(fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\ndepthSM=clamp(depthSM,0.0,1.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfragmentOutputs.fragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\nfragmentOutputs.fragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,uniforms.biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\nfragmentOutputs.color= vec4f(depthSM,1.0,1.0,1.0);\n#else\nfragmentOutputs.color=pack(depthSM);\n#endif\n");const t$17="shadowMapPixelShader",i$17="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nvar opacityMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV);var alphaFromAlphaTexture: f32=opacityMap.a;\n#if SM_SOFTTRANSPARENTSHADOW==1\nif (uniforms.softTransparentShadowSM.y==1.0) {opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}\n#endif\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE) {discard;}\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alphaFromAlphaTexture) {discard;}\n#else\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x) {discard;} \n#endif\n#endif\n#include<shadowMapFragment>\n}";bt$1.ShadersStoreWGSL[t$17]||(bt$1.ShadersStoreWGSL[t$17]=i$17);const f$v={name:t$17,shader:i$17};var shadowMap_fragmentZ_Lpm5Fe_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,shadowMapPixelShaderWGSL:f$v});const n$1G="bonesDeclaration";bt$1.IncludesShadersStoreWGSL[n$1G]||(bt$1.IncludesShadersStoreWGSL[n$1G]="#if NUM_BONE_INFLUENCERS>0\nattribute matricesIndices : vec4<f32>;attribute matricesWeights : vec4<f32>;\n#if NUM_BONE_INFLUENCERS>4\nattribute matricesIndicesExtra : vec4<f32>;attribute matricesWeightsExtra : vec4<f32>;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nvar boneSampler : texture_2d<f32>;uniform boneTextureWidth : f32;\n#else\nuniform mBones : array<mat4x4f,BonesPerMesh>;\n#endif\n#ifdef BONES_VELOCITY_ENABLED\nuniform mPreviousBones : array<mat4x4f,BonesPerMesh>;\n#endif\n#ifdef BONETEXTURE\nfn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4f\n{let offset=i32(index) *4; \nlet m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4f(m0,m1,m2,m3);}\n#endif\n#endif\n#endif\n");const i$16="bonesVertex";bt$1.IncludesShadersStoreWGSL[i$16]||(bt$1.IncludesShadersStoreWGSL[i$16]="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nvar influence : mat4x4<f32>;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0])*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1])*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[2])*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[3])*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[0])*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[1])*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[2])*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[3])*vertexInputs.matricesWeightsExtra[3];\n#endif \n#else \ninfluence=uniforms.mBones[i32(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+uniforms.mBones[i32(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+uniforms.mBones[i32(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+uniforms.mBones[i32(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+uniforms.mBones[i32(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+uniforms.mBones[i32(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+uniforms.mBones[i32(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+uniforms.mBones[i32(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];\n#endif \n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n");const n$1F="bakedVertexAnimationDeclaration";bt$1.IncludesShadersStoreWGSL[n$1F]||(bt$1.IncludesShadersStoreWGSL[n$1F]="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform bakedVertexAnimationTime: f32;uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;uniform bakedVertexAnimationSettings: vec4<f32>;var bakedVertexAnimationTexture : texture_2d<f32>;\n#ifdef INSTANCES\nattribute bakedVertexAnimationSettingsInstanced : vec4<f32>;\n#endif\nfn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>\n{let offset=i32(index)*4;let frameUV=i32(frame);let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);return mat4x4<f32>(m0,m1,m2,m3);}\n#endif\n");const t$16="instancesVertex";bt$1.IncludesShadersStoreWGSL[t$16]||(bt$1.IncludesShadersStoreWGSL[t$16]="#ifdef INSTANCES\nvar finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nvar finalPreviousWorld=mat4x4<f32>(\nvertexInputs.previousWorld0,vertexInputs.previousWorld1,\nvertexInputs.previousWorld2,vertexInputs.previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\n#if !defined(WORLD_UBO)\nfinalWorld=uniforms.world*finalWorld;\n#else\nfinalWorld=mesh.world*finalWorld;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nfinalPreviousWorld=uniforms.previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nvar finalWorld=uniforms.world;\n#else\nvar finalWorld=mesh.world;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nvar finalPreviousWorld=uniforms.previousWorld;\n#endif\n#endif\n");const r$1C="bakedVertexAnimation";bt$1.IncludesShadersStoreWGSL[r$1C]||(bt$1.IncludesShadersStoreWGSL[r$1C]="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\nlet VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;let VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;let VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;let VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;\n#else\nlet VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;\n#endif\nlet totalFrames: f32=VATEndFrame-VATStartFrame+1.0;let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;let frameCorrection: f32=select(1.0,0.0,time<1.0);let numOfFrames: f32=totalFrames-frameCorrection;var VATFrameNum: f32=fract(time)*numOfFrames;VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;VATFrameNum=floor(VATFrameNum);VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;var VATInfluence : mat4x4<f32>;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n");const r$1B="morphTargetsVertexGlobalDeclaration";bt$1.IncludesShadersStoreWGSL[r$1B]||(bt$1.IncludesShadersStoreWGSL[r$1B]="#ifdef MORPHTARGETS\nuniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;\n#ifdef MORPHTARGETS_TEXTURE \nuniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;uniform morphTargetTextureInfo : vec3<f32>;var morphTargets : texture_2d_array<f32>;var morphTargetsSampler : sampler;fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>\n{ \nlet y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;}\nfn readVector4FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec4<f32>\n{ \nlet y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0);}\n#endif\n#endif\n");const t$15="morphTargetsVertexDeclaration";bt$1.IncludesShadersStoreWGSL[t$15]||(bt$1.IncludesShadersStoreWGSL[t$15]="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\n#ifdef MORPHTARGETS_POSITION\nattribute position{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_NORMAL\nattribute normal{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute tangent{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_UV\nattribute uv_{X} : vec2<f32>;\n#endif\n#ifdef MORPHTARGETS_UV2\nattribute uv2_{X} : vec2<f32>;\n#endif\n#ifdef MORPHTARGETS_COLOR\nattribute color{X} : vec4<f32>;\n#endif\n#elif {X}==0\nuniform morphTargetCount: f32;\n#endif\n#endif\n");const n$1E="helperFunctions";bt$1.IncludesShadersStoreWGSL[n$1E]||(bt$1.IncludesShadersStoreWGSL[n$1E]="const PI: f32=3.1415926535897932384626433832795;const TWO_PI: f32=6.283185307179586;const HALF_PI: f32=1.5707963267948966;const RECIPROCAL_PI: f32=0.3183098861837907;const RECIPROCAL_PI2: f32=0.15915494309189535;const RECIPROCAL_PI4: f32=0.07957747154594767;const HALF_MIN: f32=5.96046448e-08; \nconst LinearEncodePowerApprox: f32=2.2;const GammaEncodePowerApprox: f32=1.0/LinearEncodePowerApprox;const LuminanceEncodeApprox: vec3f=vec3f(0.2126,0.7152,0.0722);const Epsilon:f32=0.0000001;fn square(x: f32)->f32 {return x*x;}\nfn saturate(x: f32)->f32 {return clamp(x,0.0,1.0);}\nfn saturateVec3(x: vec3f)->vec3f {return clamp(x,vec3f(),vec3f(1.0));}\nfn saturateEps(x: f32)->f32 {return clamp(x,Epsilon,1.0);}\nfn maxEps(x: f32)->f32 {return max(x,Epsilon);}\nfn maxEpsVec3(x: vec3f)->vec3f {return max(x,vec3f(Epsilon));}\nfn absEps(x: f32)->f32 {return abs(x)+Epsilon;}\nfn transposeMat3(inMatrix: mat3x3f)->mat3x3f {let i0: vec3f=inMatrix[0];let i1: vec3f=inMatrix[1];let i2: vec3f=inMatrix[2];let outMatrix:mat3x3f=mat3x3f(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);return outMatrix;}\nfn inverseMat3(inMatrix: mat3x3f)->mat3x3f {let a00: f32=inMatrix[0][0];let a01: f32=inMatrix[0][1];let a02: f32=inMatrix[0][2];let a10: f32=inMatrix[1][0];let a11: f32=inMatrix[1][1];let a12: f32=inMatrix[1][2];let a20: f32=inMatrix[2][0];let a21: f32=inMatrix[2][1];let a22: f32=inMatrix[2][2];let b01: f32=a22*a11-a12*a21;let b11: f32=-a22*a10+a12*a20;let b21: f32=a21*a10-a11*a20;let det: f32=a00*b01+a01*b11+a02*b21;return mat3x3f(b01/det,(-a22*a01+a02*a21)/det,(a12*a01-a02*a11)/det,\nb11/det,(a22*a00-a02*a20)/det,(-a12*a00+a02*a10)/det,\nb21/det,(-a21*a00+a01*a20)/det,(a11*a00-a01*a10)/det);}\n#if USE_EXACT_SRGB_CONVERSIONS\nfn toLinearSpaceExact(color: vec3f)->vec3f\n{let nearZeroSection: vec3f=0.0773993808*color;let remainingSection: vec3f=pow(0.947867299*(color+vec3f(0.055)),vec3f(2.4));return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.04045)));}\nfn toGammaSpaceExact(color: vec3f)->vec3f\n{let nearZeroSection: vec3f=12.92*color;let remainingSection: vec3f=1.055*pow(color,vec3f(0.41666))-vec3f(0.055);return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.0031308)));}\n#endif\nfn toLinearSpace(color: f32)->f32\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nvar nearZeroSection=0.0773993808*color;var remainingSection=pow(0.947867299*(color+0.055),2.4);return select(remainingSection,nearZeroSection,color<=0.04045);\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nfn toLinearSpaceVec3(color: vec3f)->vec3f\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3f(LinearEncodePowerApprox));\n#endif\n}\nfn toLinearSpaceVec4(color: vec4<f32>)->vec4<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4f(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4f(pow(color.rgb,vec3f(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfn toGammaSpace(color: vec4<f32>)->vec4<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4<f32>(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4<f32>(pow(color.rgb,vec3f(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfn toGammaSpaceVec3(color: vec3f)->vec3f\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3f(GammaEncodePowerApprox));\n#endif\n}\nfn squareVec3(value: vec3f)->vec3f\n{return value*value;}\nfn pow5(value: f32)->f32 {let sq: f32=value*value;return sq*sq*value;}\nfn getLuminance(color: vec3f)->f32\n{return saturate(dot(color,LuminanceEncodeApprox));}\nfn getRand(seed: vec2<f32>)->f32 {return fract(sin(dot(seed.xy ,vec2<f32>(12.9898,78.233)))*43758.5453);}\nfn dither(seed: vec2<f32>,varianceAmount: f32)->f32 {let rand: f32=getRand(seed);let normVariance: f32=varianceAmount/255.0;let dither: f32=mix(-normVariance,normVariance,rand);return dither;}\nconst rgbdMaxRange: f32=255.0;fn toRGBD(color: vec3f)->vec4<f32> {let maxRGB: f32=max(max(color.r,max(color.g,color.b)),Epsilon);var D: f32 =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);var rgb: vec3f =color.rgb*D;rgb=toGammaSpaceVec3(rgb);return vec4<f32>(saturateVec3(rgb),D);}\nfn fromRGBD(rgbd: vec4<f32>)->vec3f {let rgb=toLinearSpaceVec3(rgbd.rgb);return rgb/rgbd.a;}\nfn parallaxCorrectNormal(vertexPos: vec3f,origVec: vec3f,cubeSize: vec3f,cubePos: vec3f)->vec3f {let invOrigVec: vec3f=vec3f(1.)/origVec;let halfSize: vec3f=cubeSize*0.5;let intersecAtMaxPlane: vec3f=(cubePos+halfSize-vertexPos)*invOrigVec;let intersecAtMinPlane: vec3f=(cubePos-halfSize-vertexPos)*invOrigVec;let largestIntersec: vec3f=max(intersecAtMaxPlane,intersecAtMinPlane);let distance: f32=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);let intersectPositionWS: vec3f=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}\nfn equirectangularToCubemapDirection(uv : vec2f)->vec3f {var longitude : f32=uv.x*TWO_PI-PI;var latitude : f32=HALF_PI-uv.y*PI;var direction : vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\nfn sqrtClamped(value: f32)->f32 {return sqrt(max(value,0.));}\nfn avg(value: vec3f)->f32 {return dot(value,vec3f(0.333333333));}\n");const n$1D="sceneUboDeclaration";bt$1.IncludesShadersStoreWGSL[n$1D]||(bt$1.IncludesShadersStoreWGSL[n$1D]="struct Scene {viewProjection : mat4x4<f32>,\n#ifdef MULTIVIEW\nviewProjectionR : mat4x4<f32>,\n#endif \nview : mat4x4<f32>,\nprojection : mat4x4<f32>,\nvEyePosition : vec4<f32>,};\n#define SCENE_UBO\nvar<uniform> scene : Scene;\n");const s$o="meshUboDeclaration";bt$1.IncludesShadersStoreWGSL[s$o]||(bt$1.IncludesShadersStoreWGSL[s$o]="struct Mesh {world : mat4x4<f32>,\nvisibility : f32,};var<uniform> mesh : Mesh;\n#define WORLD_UBO\n");const e$t="clipPlaneVertexDeclaration";bt$1.IncludesShadersStoreWGSL[e$t]||(bt$1.IncludesShadersStoreWGSL[e$t]="#ifdef CLIPPLANE\nuniform vClipPlane: vec4<f32>;varying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nuniform vClipPlane2: vec4<f32>;varying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nuniform vClipPlane3: vec4<f32>;varying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nuniform vClipPlane4: vec4<f32>;varying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nuniform vClipPlane5: vec4<f32>;varying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nuniform vClipPlane6: vec4<f32>;varying fClipDistance6: f32;\n#endif\n");const i$15="clipPlaneVertex";bt$1.IncludesShadersStoreWGSL[i$15]||(bt$1.IncludesShadersStoreWGSL[i$15]="#ifdef CLIPPLANE\nvertexOutputs.fClipDistance=dot(worldPos,uniforms.vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nvertexOutputs.fClipDistance2=dot(worldPos,uniforms.vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nvertexOutputs.fClipDistance3=dot(worldPos,uniforms.vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nvertexOutputs.fClipDistance4=dot(worldPos,uniforms.vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nvertexOutputs.fClipDistance5=dot(worldPos,uniforms.vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nvertexOutputs.fClipDistance6=dot(worldPos,uniforms.vClipPlane6);\n#endif\n");const n$1C="morphTargetsVertexGlobal";bt$1.IncludesShadersStoreWGSL[n$1C]||(bt$1.IncludesShadersStoreWGSL[n$1C]="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nvar vertexID : f32;\n#endif\n#endif\n");const t$14="morphTargetsVertex";bt$1.IncludesShadersStoreWGSL[t$14]||(bt$1.IncludesShadersStoreWGSL[t$14]="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\n#if {X}==0\nfor (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (f32(i)>=uniforms.morphTargetCount) {break;}\nvertexID=f32(vertexInputs.vertexIndex)*uniforms.morphTargetTextureInfo.x;\n#ifdef MORPHTARGETS_POSITION\npositionUpdated=positionUpdated+(readVector3FromRawSampler(i,vertexID)-vertexInputs.position)*uniforms.morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASPOSITIONS\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated=normalUpdated+(readVector3FromRawSampler(i,vertexID) -vertexInputs.normal)*uniforms.morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASNORMALS\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv)*uniforms.morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASUVS\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated=vec4f(tangentUpdated.xyz+(readVector3FromRawSampler(i,vertexID) -vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[i],tangentUpdated.a);\n#endif\n#ifdef MORPHTARGETTEXTURE_HASTANGENTS\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_UV2\nuv2Updated=uv2Updated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv2)*uniforms.morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETS_COLOR\ncolorUpdated=colorUpdated+(readVector4FromRawSampler(i,vertexID)-vertexInputs.color)*uniforms.morphTargetInfluences[i];\n#endif\n}\n#endif\n#else\n#ifdef MORPHTARGETS_POSITION\npositionUpdated=positionUpdated+(vertexInputs.position{X}-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated=normalUpdated+(vertexInputs.normal{X}-vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated=vec4f(tangentUpdated.xyz+(vertexInputs.tangent{X}-vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}],tangentUpdated.a);\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(vertexInputs.uv_{X}-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV2\nuv2Updated=uv2Updated+(vertexInputs.uv2_{X}-vertexInputs.uv2)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_COLOR\ncolorUpdated=colorUpdated+(vertexInputs.color{X}-vertexInputs.color)*uniforms.morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n");const n$1B="shadowMapVertexExtraDeclaration";bt$1.IncludesShadersStoreWGSL[n$1B]||(bt$1.IncludesShadersStoreWGSL[n$1B]="#if SM_NORMALBIAS==1\nuniform lightDataSM: vec3f;\n#endif\nuniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;varying vDepthMetricSM: f32;\n#if SM_USEDISTANCE==1\nvarying vPositionWSM: vec3f;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying zSM: f32;\n#endif\n");const i$14="shadowMapVertexNormalBias";bt$1.IncludesShadersStoreWGSL[i$14]||(bt$1.IncludesShadersStoreWGSL[i$14]="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvar worldLightDirSM: vec3f=normalize(-uniforms.lightDataSM.xyz);\n#else\nvar directionToLightSM: vec3f=uniforms.lightDataSM.xyz-worldPos.xyz;var worldLightDirSM: vec3f=normalize(directionToLightSM);\n#endif\nvar ndlSM: f32=dot(vNormalW,worldLightDirSM);var sinNLSM: f32=sqrt(1.0-ndlSM*ndlSM);var normalBiasSM: f32=uniforms.biasAndScaleSM.y*sinNLSM;worldPos=vec4f(worldPos.xyz-vNormalW*normalBiasSM,worldPos.w);\n#endif\n");const r$1A="shadowMapVertexMetric";bt$1.IncludesShadersStoreWGSL[r$1A]||(bt$1.IncludesShadersStoreWGSL[r$1A]="#if SM_USEDISTANCE==1\nvertexOutputs.vPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.position.z-=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#else\nvertexOutputs.position.z+=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvertexOutputs.zSM=vertexOutputs.position.z;vertexOutputs.position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetricSM=(-vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\nvertexOutputs.vDepthMetricSM=(vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\n");const t$13="shadowMapVertexShader",o$$="attribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute world0: vec4f;attribute world1: vec4f;attribute world2: vec4f;attribute world3: vec4f;\n#endif\n#include<helperFunctions>\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n#ifdef ALPHATEXTURE\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=input.uv2;\n#endif\n#ifdef NORMAL\nvar normalUpdated: vec3f=input.normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#ifdef NORMAL\nvar normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvar vNormalW: vec3f=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvar vNormalW: vec3f=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\nvertexOutputs.position=scene.viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#include<clipPlaneVertex>\n}";bt$1.ShadersStoreWGSL[t$13]||(bt$1.ShadersStoreWGSL[t$13]=o$$);const a$R={name:t$13,shader:o$$};var shadowMap_vertexDi_QOfOI_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,shadowMapVertexShaderWGSL:a$R});const r$1z="depthBoxBlurPixelShader",t$12="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colorDepth: vec4f=vec4f(0.0);for (var x: i32=-OFFSET; x<=OFFSET; x++) {for (var y: i32=-OFFSET; y<=OFFSET; y++) {colorDepth+=textureSample(textureSampler,textureSamplerSampler,input.vUV+ vec2f(f32(x),f32(y))/uniforms.screenSize);}}\nfragmentOutputs.color=(colorDepth/ f32((OFFSET*2+1)*(OFFSET*2+1)));}";bt$1.ShadersStoreWGSL[r$1z]||(bt$1.ShadersStoreWGSL[r$1z]=t$12);const a$Q={name:r$1z,shader:t$12};var depthBoxBlur_fragmentCZQmTHBc_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,depthBoxBlurPixelShaderWGSL:a$Q});const a$P="shadowMapFragmentSoftTransparentShadow",r$1y="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alpha) {discard;}\n#endif\n";bt$1.IncludesShadersStoreWGSL[a$P]||(bt$1.IncludesShadersStoreWGSL[a$P]=r$1y);const e$s={name:a$P,shader:r$1y};var shadowMapFragmentSoftTransparentShadowLruZzcjV_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,shadowMapFragmentSoftTransparentShadowWGSL:e$s});const n$1A="instancesDeclaration";bt$1.IncludesShadersStoreWGSL[n$1A]||(bt$1.IncludesShadersStoreWGSL[n$1A]="#ifdef INSTANCES\nattribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;\n#ifdef INSTANCESCOLOR\nattribute instanceColor : vec4<f32>;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nattribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;\n#ifdef THIN_INSTANCES\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n");const n$1z="depthVertexShader",i$13="attribute position: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;uniform depthValues: vec2f;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform view: mat4x4f;varying vViewPos: vec4f;\n#endif\nvarying vDepthMetric: f32;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=input.uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#include<clipPlaneVertex>\nvertexOutputs.position=uniforms.viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvertexOutputs.vViewPos=uniforms.view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric=((-vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));\n#else\nvertexOutputs.vDepthMetric=((vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n}\n";bt$1.ShadersStoreWGSL[n$1z]||(bt$1.ShadersStoreWGSL[n$1z]=i$13);const t$11={name:n$1z,shader:i$13};var depth_vertexBt7MVetX_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,depthVertexShaderWGSL:t$11});const e$r="depthPixelShader",i$12="#ifdef ALPHATEST\nvarying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying vDepthMetric: f32;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vViewPos: vec4f;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\nfragmentOutputs.color=pack(input.vViewPos.z);\n#else\nfragmentOutputs.color= vec4f(input.vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\nfragmentOutputs.color=pack(input.position.z);\n#else\nfragmentOutputs.color= vec4f(input.position.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\nfragmentOutputs.color=pack(input.vDepthMetric);\n#else\nfragmentOutputs.color= vec4f(input.vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";bt$1.ShadersStoreWGSL[e$r]||(bt$1.ShadersStoreWGSL[e$r]=i$12);const t$10={name:e$r,shader:i$12};var depth_fragmentC4SBl4p1_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,depthPixelShaderWGSL:t$10});const e$q="backgroundUboDeclaration";bt$1.IncludesShadersStoreWGSL[e$q]||(bt$1.IncludesShadersStoreWGSL[e$q]="uniform vPrimaryColor: vec4f;uniform vPrimaryColorShadow: vec4f;uniform vDiffuseInfos : vec2f;uniform diffuseMatrix : mat4x4f;uniform fFovMultiplier: f32;uniform pointSize: f32;uniform shadowLevel: f32;uniform alpha: f32;uniform vBackgroundCenter: vec3f;uniform vReflectionControl: vec4f;uniform projectedGroundInfos: vec2f;uniform vReflectionInfos : vec2f;uniform reflectionMatrix : mat4x4f;uniform vReflectionMicrosurfaceInfos : vec3f;\n#include<sceneUboDeclaration>\n");const t$$="fogVertexDeclaration";bt$1.IncludesShadersStoreWGSL[t$$]||(bt$1.IncludesShadersStoreWGSL[t$$]="#ifdef FOG\nvarying vFogDistance: vec3f;\n#endif\n");const n$1y="fogVertex";bt$1.IncludesShadersStoreWGSL[n$1y]||(bt$1.IncludesShadersStoreWGSL[n$1y]="#ifdef FOG\n#ifdef SCENE_UBO\nvertexOutputs.vFogDistance=(scene.view*worldPos).xyz;\n#else\nvertexOutputs.vFogDistance=(uniforms.view*worldPos).xyz;\n#endif\n#endif\n");const s$n="logDepthVertex";bt$1.IncludesShadersStoreWGSL[s$n]||(bt$1.IncludesShadersStoreWGSL[s$n]="#ifdef LOGARITHMICDEPTH\nvertexOutputs.vFragmentDepth=1.0+vertexOutputs.position.w;vertexOutputs.position.z=log2(max(0.000001,vertexOutputs.vFragmentDepth))*uniforms.logarithmicDepthConstant;\n#endif\n");const e$p="lightVxUboDeclaration";bt$1.IncludesShadersStoreWGSL[e$p]||(bt$1.IncludesShadersStoreWGSL[e$p]="#ifdef LIGHT{X}\nstruct Light{X}\n{vLightData: vec4f,\nvLightDiffuse: vec4f,\nvLightSpecular: vec4f,\n#ifdef SPOTLIGHT{X}\nvLightDirection: vec4f,\nvLightFalloff: vec4f,\n#elif defined(POINTLIGHT{X})\nvLightFalloff: vec4f,\n#elif defined(HEMILIGHT{X})\nvLightGround: vec3f,\n#elif defined(CLUSTLIGHT{X})\nvSliceData: vec2f,\nvSliceRanges: array<vec4f,CLUSTLIGHT_SLICES>,\n#endif\n#if defined(AREALIGHT{X})\nvLightWidth: vec4f,\nvLightHeight: vec4f,\n#endif\nshadowsInfo: vec4f,\ndepthValues: vec2f} ;var<uniform> light{X} : Light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;\n#endif\n#endif\n#endif\n");const i$11="shadowsVertex";bt$1.IncludesShadersStoreWGSL[i$11]||(bt$1.IncludesShadersStoreWGSL[i$11]="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvertexOutputs.vPositionFromCamera{X}=scene.view*worldPos;\n#if SHADOWCSMNUM_CASCADES{X}>0\nvertexOutputs.vPositionFromLight{X}_0=uniforms.lightMatrix{X}[0]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_0=(-vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_0= (vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#if SHADOWCSMNUM_CASCADES{X}>1\nvertexOutputs.vPositionFromLight{X}_1=uniforms.lightMatrix{X}[1]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_1=(-vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_1= (vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif \n#if SHADOWCSMNUM_CASCADES{X}>2\nvertexOutputs.vPositionFromLight{X}_2=uniforms.lightMatrix{X}[2]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_2=(-vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_2= (vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif \n#if SHADOWCSMNUM_CASCADES{X}>3\nvertexOutputs.vPositionFromLight{X}_3=uniforms.lightMatrix{X}[3]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_3=(-vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_3= (vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif \n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvertexOutputs.vPositionFromLight{X}=uniforms.lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}=(-vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}=(vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n");const n$1x="logDepthDeclaration";bt$1.IncludesShadersStoreWGSL[n$1x]||(bt$1.IncludesShadersStoreWGSL[n$1x]="#ifdef LOGARITHMICDEPTH\nuniform logarithmicDepthConstant: f32;varying vFragmentDepth: f32;\n#endif\n");const n$1w="backgroundVertexShader",i$10="#include<backgroundUboDeclaration>\n#include<helperFunctions>\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vPositionW: vec3f;\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#ifdef MAINUV1\nvarying vMainUV1: vec2f;\n#endif\n#ifdef MAINUV2\nvarying vMainUV2: vec2f;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vDiffuseUV: vec2f;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<lightVxUboDeclaration>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=input.position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);} else {vertexOutputs.position=scene.viewProjectionR*finalWorld* vec4f(input.position,1.0);}\n#else\nvertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);\n#endif\nvar worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.vPositionW= worldPos.xyz;\n#ifdef NORMAL\nvar normalWorld: mat3x3f=mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*input.normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld*vec4f(input.position,0.0)).xyz);\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nvar screenToWorld: mat3x3f=inverseMat3( mat3x3f(finalWorld*scene.viewProjection));var segment: vec3f=mix(vertexOutputs.vDirectionW,screenToWorld* vec3f(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vertexOutputs.vDirectionW=normalize(segment);} else {vertexOutputs.vDirectionW=normalize(vertexOutputs.vDirectionW+(vertexOutputs.vDirectionW-segment));}\n#endif\n#endif\n#ifndef UV1\nvar uv: vec2f=vec2f(0.,0.);\n#else\nvar uv=input.uv;\n#endif\n#ifndef UV2\nvar uv2: vec2f=vec2f(0.,0.);\n#else\nvar uv2=input.uv2;\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (uniforms.vDiffuseInfos.x==0.)\n{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv,1.0,0.0)).xy;}\nelse\n{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv2,1.0,0.0)).xy;}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvertexOutputs.vColor=vertexInputs.color;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";bt$1.ShadersStoreWGSL[n$1w]||(bt$1.ShadersStoreWGSL[n$1w]=i$10);const t$_={name:n$1w,shader:i$10};var background_vertexBQ3ezD5_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,backgroundVertexShaderWGSL:t$_});const r$1x="reflectionFunction";bt$1.IncludesShadersStoreWGSL[r$1x]||(bt$1.IncludesShadersStoreWGSL[r$1x]="fn computeFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f\n{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0); }\nfn computeMirroredFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f\n{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(1.0-s,t,0); }\nfn computeEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{var cameraToVertex: vec3f=normalize(worldPos.xyz-eyePosition);var r: vec3f=normalize(reflect(cameraToVertex,worldNormal));r= (reflectionMatrix* vec4f(r,0)).xyz;var lon: f32=atan2(r.z,r.x);var lat: f32=acos(r.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0);}\nfn computeSphericalCoords(worldPos: vec4f,worldNormal: vec3f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f\n{var viewDir: vec3f=normalize((view*worldPos).xyz);var viewNormal: vec3f=normalize((view* vec4f(worldNormal,0.0)).xyz);var r: vec3f=reflect(viewDir,viewNormal);r= (reflectionMatrix* vec4f(r,0)).xyz;r.z=r.z-1.0;var m: f32=2.0*length(r);return vec3f(r.x/m+0.5,1.0-r.y/m-0.5,0);}\nfn computePlanarCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{var viewDir: vec3f=worldPos.xyz-eyePosition;var coords: vec3f=normalize(reflect(viewDir,worldNormal));return (reflectionMatrix* vec4f(coords,1)).xyz;}\nfn computeCubicCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords= (reflectionMatrix* vec4f(coords,0)).xyz;\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nfn computeCubicLocalCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f,reflectionSize: vec3f,reflectionPosition: vec3f)->vec3f\n{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=(reflectionMatrix* vec4f(coords,0)).xyz;\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nfn computeProjectionCoords(worldPos: vec4f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f\n{return (reflectionMatrix*(view*worldPos)).xyz;}\nfn computeSkyBoxCoords(positionW: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{return (reflectionMatrix* vec4f(positionW,1.)).xyz;}\n#ifdef REFLECTION\nfn computeReflectionCoords(worldPos: vec4f,worldNormal: vec3f)->vec3f\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvar direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvar direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,scene.view,uniforms.reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix,uniforms.vReflectionSize,uniforms.vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,scene.view,uniforms.reflectionMatrix);\n#endif\n#ifndef REFLECTIONMAP_CUBIC\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(fragmentInputs.vPositionUVW,uniforms.reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3f(0,0,0);\n#endif\n}\n#endif\n");const t$Z="lightUboDeclaration";bt$1.IncludesShadersStoreWGSL[t$Z]||(bt$1.IncludesShadersStoreWGSL[t$Z]="#ifdef LIGHT{X}\nstruct Light{X}\n{vLightData: vec4f,\nvLightDiffuse: vec4f,\nvLightSpecular: vec4f,\n#ifdef SPOTLIGHT{X}\nvLightDirection: vec4f,\nvLightFalloff: vec4f,\n#elif defined(POINTLIGHT{X})\nvLightFalloff: vec4f,\n#elif defined(HEMILIGHT{X})\nvLightGround: vec3f,\n#elif defined(CLUSTLIGHT{X})\nvSliceData: vec2f,\nvSliceRanges: array<vec4f,CLUSTLIGHT_SLICES>,\n#endif\n#if defined(AREALIGHT{X})\nvLightWidth: vec4f,\nvLightHeight: vec4f,\n#endif\nshadowsInfo: vec4f,\ndepthValues: vec2f} ;var<uniform> light{X} : Light{X};\n#ifdef IESLIGHTTEXTURE{X}\nvar iesLightTexture{X}Sampler: sampler;var iesLightTexture{X}: texture_2d<f32>;\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform textureProjectionMatrix{X}: mat4x4f;var projectionLightTexture{X}Sampler: sampler;var projectionLightTexture{X}: texture_2d<f32>;\n#endif\n#ifdef CLUSTLIGHT{X}\nvar lightDataTexture{X}: texture_2d<f32>;var<storage,read> tileMaskBuffer{X}: array<u32>;\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;uniform viewFrustumZ{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform frustumLengths{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform cascadeBlendFactor{X}: f32;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;var<private> vPositionFromLight{X}: array<vec4f,4>;var<private> vDepthMetric{X} : array<f32,4>;\n#if defined(SHADOWPCSS{X})\nvar shadowTexture{X}Sampler: sampler_comparison; \nvar shadowTexture{X}: texture_depth_2d_array;var depthTexture{X}Sampler: sampler;var depthTexture{X}: texture_2d_array<f32>;uniform lightSizeUVCorrection{X}: array<vec2f,SHADOWCSMNUM_CASCADES{X}>;uniform depthCorrection{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform penumbraDarkness{X}: f32;\n#elif defined(SHADOWPCF{X})\nvar shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d_array;\n#else \nvar shadowTexture{X}Sampler: sampler; \nvar shadowTexture{X}: texture_2d_array<f32>;\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vCascadeColorsMultiplier{X}: array<vec3f,8>=array<vec3f,8>\n(\nvec3f ( 1.5,0.0,0.0 ),\nvec3f ( 0.0,1.5,0.0 ),\nvec3f ( 0.0,0.0,5.5 ),\nvec3f ( 1.5,0.0,5.5 ),\nvec3f ( 1.5,1.5,0.0 ),\nvec3f ( 1.0,1.0,1.0 ),\nvec3f ( 0.0,1.0,5.5 ),\nvec3f ( 0.5,3.5,0.75 )\n);\n#endif\n#elif defined(SHADOWCUBE{X})\nvar shadowTexture{X}Sampler: sampler;var shadowTexture{X}: texture_cube<f32>;\n#else\nvarying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;\n#if defined(SHADOWPCSS{X})\nvar shadowTexture{X}Sampler: sampler_comparison; \nvar shadowTexture{X}: texture_depth_2d;var depthTexture{X}Sampler: sampler; \nvar depthTexture{X}: texture_2d<f32>;\n#elif defined(SHADOWPCF{X})\nvar shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d;\n#else\nvar shadowTexture{X}Sampler: sampler; \nvar shadowTexture{X}: texture_2d<f32>;\n#endif\nuniform lightMatrix{X}: mat4x4f;\n#endif\n#endif\n#endif\n");const a$O="ltcHelperFunctions";bt$1.IncludesShadersStoreWGSL[a$O]||(bt$1.IncludesShadersStoreWGSL[a$O]="fn LTCUv(N: vec3f,V: vec3f,roughness: f32)->vec2f {var LUTSIZE: f32=64.0;var LUTSCALE: f32=( LUTSIZE-1.0 )/LUTSIZE;var LUTBIAS:f32=0.5/LUTSIZE;var dotNV:f32=saturate( dot( N,V ) );var uv:vec2f=vec2f( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}\nfn LTCClippedSphereFormFactor( f:vec3f )->f32 {var l: f32=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}\nfn LTCEdgeVectorFormFactor( v1:vec3f,v2:vec3f )->vec3f {var x:f32=dot( v1,v2 );var y:f32=abs( x );var a:f32=0.8543985+( 0.4965155+0.0145206*y )*y;var b:f32=3.4175940+( 4.1616724+y )*y;var v:f32=a/b;var thetaSintheta:f32=0.0;if( x>0.0 )\n{thetaSintheta=v;}\nelse\n{thetaSintheta=0.5*inverseSqrt( max( 1.0-x*x,0.00000001 ) )-v;}\nreturn cross( v1,v2 )*thetaSintheta;}\nfn LTCEvaluate( N:vec3f,V:vec3f,P:vec3f,mInv: mat3x3<f32>,rectCoords0:vec3f,rectCoords1:vec3f,rectCoords2:vec3f,rectCoords3:vec3f )->vec3f {var v1:vec3f=rectCoords1-rectCoords0;var v2:vec3f=rectCoords3-rectCoords0;var lightNormal:vec3f=cross( v1,v2 );if( dot( lightNormal,P-rectCoords0 )<0.0 ){return vec3f( 0.0 );}\nvar T1:vec3f=normalize( V-N*dot( V,N ) );var T2:vec3f=- cross( N,T1 ); \nvar mat: mat3x3<f32>=mInv*transposeMat3( mat3x3<f32>( T1,T2,N ) );var coords0: vec3f=mat*( rectCoords0-P );var coords1: vec3f=mat*( rectCoords1-P );var coords2: vec3f=mat*( rectCoords2-P );var coords3: vec3f=mat*( rectCoords3-P );coords0=normalize( coords0 );coords1=normalize( coords1 );coords2=normalize( coords2 );coords3=normalize( coords3 );var vectorFormFactor:vec3f=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords0,coords1 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords1,coords2 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords2,coords3 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords3,coords0 );var result:f32=LTCClippedSphereFormFactor( vectorFormFactor );return vec3f( result );}\nstruct areaLightData\n{Diffuse: vec3f,\nSpecular: vec3f,\nFresnel: vec4f};fn computeAreaLightSpecularDiffuseFresnel(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDir: vec3f,normal:vec3f,position:vec3f,lightPos:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->areaLightData {var result: areaLightData;var rectCoords0:vec3f=lightPos+halfWidth-halfHeight; \nvar rectCoords1:vec3f=lightPos-halfWidth-halfHeight;var rectCoords2:vec3f=lightPos-halfWidth+halfHeight;var rectCoords3:vec3f=lightPos+halfWidth+halfHeight;\n#ifdef SPECULARTERM\nvar uv:vec2f=LTCUv( normal,viewDir,roughness );var t1:vec4f=textureSample( ltc1,ltc1Sampler,uv );var t2:vec4f=textureSample( ltc2,ltc2Sampler,uv );var mInv:mat3x3<f32>=mat3x3<f32>(\nvec3f( t1.x,0,t1.y ),\nvec3f( 0,1, 0 ),\nvec3f( t1.z,0,t1.w )\n);result.Fresnel=t2;result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );\n#endif\nvar mInvEmpty:mat3x3<f32>=mat3x3<f32>(\nvec3f( 1,0,0 ),\nvec3f( 0,1,0 ),\nvec3f( 0,0,1 )\n);result.Diffuse+=LTCEvaluate( normal,viewDir,position,mInvEmpty,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );return result;}");const o$_="clusteredLightingFunctions";bt$1.IncludesShadersStoreWGSL[o$_]||(bt$1.IncludesShadersStoreWGSL[o$_]="struct ClusteredLight {vLightData: vec4f,\nvLightDiffuse: vec4f,\nvLightSpecular: vec4f,\nvLightDirection: vec4f,\nvLightFalloff: vec4f,}\nfn getClusteredLight(lightDataTexture: texture_2d<f32>,index: u32)->ClusteredLight {return ClusteredLight(\ntextureLoad(lightDataTexture,vec2u(0,index),0),\ntextureLoad(lightDataTexture,vec2u(1,index),0),\ntextureLoad(lightDataTexture,vec2u(2,index),0),\ntextureLoad(lightDataTexture,vec2u(3,index),0),\ntextureLoad(lightDataTexture,vec2u(4,index),0)\n);}\nfn getClusteredSliceIndex(sliceData: vec2f,viewDepth: f32)->i32 {return i32(log(viewDepth)*sliceData.x+sliceData.y);}\n");const i$$="shadowsFragmentFunctions";bt$1.IncludesShadersStoreWGSL[i$$]||(bt$1.IncludesShadersStoreWGSL[i$$]="#ifdef SHADOWS\n#ifndef SHADOWFLOAT\nfn unpack(color: vec4f)->f32\n{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}\n#endif\nfn computeFallOff(value: f32,clipSpace: vec2f,frustumEdgeFalloff: f32)->f32\n{var mask: f32=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}\nfn computeShadowCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nvar shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));\n#else\nvar shadow: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;\n#endif\nreturn select(1.0,darkness,depth>shadow);}\nfn computeShadowWithPoissonSamplingCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;var visibility: f32=1.;var poissonDisk: array<vec3f,4>;poissonDisk[0]= vec3f(-1.0,1.0,-1.0);poissonDisk[1]= vec3f(1.0,-1.0,-1.0);poissonDisk[2]= vec3f(-1.0,-1.0,-1.0);poissonDisk[3]= vec3f(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) {visibility-=0.25;};\n#else\nif (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) {visibility-=0.25;};\n#endif\nreturn min(1.0,visibility+darkness);}\nfn computeShadowWithESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));\n#else\nvar shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;\n#endif\nvar esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}\nfn computeShadowWithCloseESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));\n#else\nvar shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;\n#endif\nvar esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}\nfn computeShadowCSM(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d_array<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nvar shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,uv,layer));\n#else\nvar shadow: f32=textureSample(shadowTexture,shadowSampler,uv,layer).x;\n#endif\nreturn select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}\nfn computeShadow(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nvar shadow: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));\n#else\nvar shadow: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;\n#endif\nreturn select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}}\nfn computeShadowWithPoissonSampling(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);var visibility: f32=1.;var poissonDisk: array<vec2f,4>;poissonDisk[0]= vec2f(-0.94201624,-0.39906216);poissonDisk[1]= vec2f(0.94558609,-0.76890725);poissonDisk[2]= vec2f(-0.094184101,-0.92938870);poissonDisk[3]= vec2f(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\n#else\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));\n#else\nvar shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;\n#endif\nvar esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithCloseESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));\n#else\nvar shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;\n#endif\nvar esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\nfn getZInClip(clipSpace: vec3f,uvDepth: vec3f)->f32\n{\n#ifdef IS_NDC_HALF_ZRANGE\nreturn clipSpace.z;\n#else\nreturn uvDepth.z;\n#endif\n}\nconst GREATEST_LESS_THAN_ONE: f32=0.99999994;\n#define DISABLE_UNIFORMITY_ANALYSIS\nfn computeShadowWithCSMPCF1(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var shadow: f32=textureSampleCompare(shadowTexture,shadowSampler,uvDepth.xy,layer,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\nfn computeShadowWithCSMPCF3(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\nfn computeShadowWithCSMPCF5(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),layer,uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),layer,uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),layer,uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),layer,uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\nfn computeShadowWithPCF1(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var shadow: f32=textureSampleCompareLevel(shadowTexture,shadowSampler,uvDepth.xy,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithPCF3(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithPCF5(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nconst PoissonSamplers32: array<vec3f,64>=array<vec3f,64> (\nvec3f(0.06407013,0.05409927,0.),\nvec3f(0.7366577,0.5789394,0.),\nvec3f(-0.6270542,-0.5320278,0.),\nvec3f(-0.4096107,0.8411095,0.),\nvec3f(0.6849564,-0.4990818,0.),\nvec3f(-0.874181,-0.04579735,0.),\nvec3f(0.9989998,0.0009880066,0.),\nvec3f(-0.004920578,-0.9151649,0.),\nvec3f(0.1805763,0.9747483,0.),\nvec3f(-0.2138451,0.2635818,0.),\nvec3f(0.109845,0.3884785,0.),\nvec3f(0.06876755,-0.3581074,0.),\nvec3f(0.374073,-0.7661266,0.),\nvec3f(0.3079132,-0.1216763,0.),\nvec3f(-0.3794335,-0.8271583,0.),\nvec3f(-0.203878,-0.07715034,0.),\nvec3f(0.5912697,0.1469799,0.),\nvec3f(-0.88069,0.3031784,0.),\nvec3f(0.5040108,0.8283722,0.),\nvec3f(-0.5844124,0.5494877,0.),\nvec3f(0.6017799,-0.1726654,0.),\nvec3f(-0.5554981,0.1559997,0.),\nvec3f(-0.3016369,-0.3900928,0.),\nvec3f(-0.5550632,-0.1723762,0.),\nvec3f(0.925029,0.2995041,0.),\nvec3f(-0.2473137,0.5538505,0.),\nvec3f(0.9183037,-0.2862392,0.),\nvec3f(0.2469421,0.6718712,0.),\nvec3f(0.3916397,-0.4328209,0.),\nvec3f(-0.03576927,-0.6220032,0.),\nvec3f(-0.04661255,0.7995201,0.),\nvec3f(0.4402924,0.3640312,0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.)\n);const PoissonSamplers64: array<vec3f,64>=array<vec3f,64> (\nvec3f(-0.613392,0.617481,0.),\nvec3f(0.170019,-0.040254,0.),\nvec3f(-0.299417,0.791925,0.),\nvec3f(0.645680,0.493210,0.),\nvec3f(-0.651784,0.717887,0.),\nvec3f(0.421003,0.027070,0.),\nvec3f(-0.817194,-0.271096,0.),\nvec3f(-0.705374,-0.668203,0.),\nvec3f(0.977050,-0.108615,0.),\nvec3f(0.063326,0.142369,0.),\nvec3f(0.203528,0.214331,0.),\nvec3f(-0.667531,0.326090,0.),\nvec3f(-0.098422,-0.295755,0.),\nvec3f(-0.885922,0.215369,0.),\nvec3f(0.566637,0.605213,0.),\nvec3f(0.039766,-0.396100,0.),\nvec3f(0.751946,0.453352,0.),\nvec3f(0.078707,-0.715323,0.),\nvec3f(-0.075838,-0.529344,0.),\nvec3f(0.724479,-0.580798,0.),\nvec3f(0.222999,-0.215125,0.),\nvec3f(-0.467574,-0.405438,0.),\nvec3f(-0.248268,-0.814753,0.),\nvec3f(0.354411,-0.887570,0.),\nvec3f(0.175817,0.382366,0.),\nvec3f(0.487472,-0.063082,0.),\nvec3f(-0.084078,0.898312,0.),\nvec3f(0.488876,-0.783441,0.),\nvec3f(0.470016,0.217933,0.),\nvec3f(-0.696890,-0.549791,0.),\nvec3f(-0.149693,0.605762,0.),\nvec3f(0.034211,0.979980,0.),\nvec3f(0.503098,-0.308878,0.),\nvec3f(-0.016205,-0.872921,0.),\nvec3f(0.385784,-0.393902,0.),\nvec3f(-0.146886,-0.859249,0.),\nvec3f(0.643361,0.164098,0.),\nvec3f(0.634388,-0.049471,0.),\nvec3f(-0.688894,0.007843,0.),\nvec3f(0.464034,-0.188818,0.),\nvec3f(-0.440840,0.137486,0.),\nvec3f(0.364483,0.511704,0.),\nvec3f(0.034028,0.325968,0.),\nvec3f(0.099094,-0.308023,0.),\nvec3f(0.693960,-0.366253,0.),\nvec3f(0.678884,-0.204688,0.),\nvec3f(0.001801,0.780328,0.),\nvec3f(0.145177,-0.898984,0.),\nvec3f(0.062655,-0.611866,0.),\nvec3f(0.315226,-0.604297,0.),\nvec3f(-0.780145,0.486251,0.),\nvec3f(-0.371868,0.882138,0.),\nvec3f(0.200476,0.494430,0.),\nvec3f(-0.494552,-0.711051,0.),\nvec3f(0.612476,0.705252,0.),\nvec3f(-0.578845,-0.768792,0.),\nvec3f(-0.772454,-0.090976,0.),\nvec3f(0.504440,0.372295,0.),\nvec3f(0.155736,0.065157,0.),\nvec3f(0.391522,0.849605,0.),\nvec3f(-0.620106,-0.328104,0.),\nvec3f(0.789239,-0.419965,0.),\nvec3f(-0.545396,0.538133,0.),\nvec3f(-0.178564,-0.596057,0.)\n);fn computeShadowWithCSMPCSS(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uvDepthLayer: vec4f= vec4f(uvDepth.x,uvDepth.y,f32(layer),uvDepth.z);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;for (var i: i32=0; i<searchTapCount; i ++) {blockerDepth=textureSample(depthTexture,depthSampler, uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}\nvar avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);var filterRadius: vec4f= vec4f(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {var offset: vec4f= vec4f(poissonSamplers[i],0.);offset= vec4f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);let coords=uvDepthLayer+offset*filterRadius;shadow+=textureSampleCompare(shadowTexture,shadowSampler,coords.xy,i32(coords.z),coords.w);}\nshadow/= f32(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,numBlocker<1.0);}\nfn computeShadowWithPCSS(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;var exitCondition: bool=depthMetric>1.0 || depthMetric<0.0;for (var i: i32=0; i<searchTapCount; i ++) {if (exitCondition) {break;}\nblockerDepth=textureSampleLevel(depthTexture,depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}\nexitCondition=exitCondition || numBlocker<1.0;var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)+AAOffset);var filterRadius: f32=penumbraRatio*lightSizeUV*shadowMapSizeInverse;var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {if (exitCondition) {break;}\nvar offset: vec3f=poissonSamplers[i];offset= vec3f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);let coords=uvDepth+offset*filterRadius;shadow+=textureSampleCompareLevel(shadowTexture,shadowSampler,coords.xy,coords.z);}\nshadow/= f32(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,exitCondition);}\nfn computeShadowWithPCSS16(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}\nfn computeShadowWithPCSS32(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}\nfn computeShadowWithPCSS64(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}\nfn computeShadowWithCSMPCSS16(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\nfn computeShadowWithCSMPCSS32(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\nfn computeShadowWithCSMPCSS64(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#endif\n");const r$1w="imageProcessingDeclaration";bt$1.IncludesShadersStoreWGSL[r$1w]||(bt$1.IncludesShadersStoreWGSL[r$1w]="#ifdef EXPOSURE\nuniform exposureLinear: f32;\n#endif\n#ifdef CONTRAST\nuniform contrast: f32;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vInverseScreenSize: vec2f;\n#endif\n#ifdef VIGNETTE\nuniform vignetteSettings1: vec4f;uniform vignetteSettings2: vec4f;\n#endif\n#ifdef COLORCURVES\nuniform vCameraColorCurveNegative: vec4f;uniform vCameraColorCurveNeutral: vec4f;uniform vCameraColorCurvePositive: vec4f;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nvar txColorTransformSampler: sampler;var txColorTransform: texture_3d<f32>;\n#else\nvar txColorTransformSampler: sampler;var txColorTransform: texture_2d<f32>;\n#endif\nuniform colorTransformSettings: vec4f;\n#endif\n#ifdef DITHER\nuniform ditherIntensity: f32;\n#endif\n");const n$1v="imageProcessingFunctions";bt$1.IncludesShadersStoreWGSL[n$1v]||(bt$1.IncludesShadersStoreWGSL[n$1v]="#if TONEMAPPING==3\nconst PBRNeutralStartCompression: f32=0.8-0.04;const PBRNeutralDesaturation: f32=0.15;fn PBRNeutralToneMapping( color: vec3f )->vec3f {var x: f32=min(color.r,min(color.g,color.b));var offset: f32=select(0.04,x-6.25*x*x,x<0.08);var result=color;result-=offset;var peak: f32=max(result.r,max(result.g,result.b));if (peak<PBRNeutralStartCompression) {return result;}\nvar d: f32=1.-PBRNeutralStartCompression;var newPeak: f32=1.-d*d/(peak+d-PBRNeutralStartCompression);result*=newPeak/peak;var g: f32=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(result,newPeak* vec3f(1,1,1),g);}\n#endif\n#if TONEMAPPING==2\nconst ACESInputMat: mat3x3f= mat3x3f(\nvec3f(0.59719,0.07600,0.02840),\nvec3f(0.35458,0.90834,0.13383),\nvec3f(0.04823,0.01566,0.83777)\n);const ACESOutputMat: mat3x3f= mat3x3f(\nvec3f( 1.60475,-0.10208,-0.00327),\nvec3f(-0.53108, 1.10813,-0.07276),\nvec3f(-0.07367,-0.00605, 1.07602)\n);fn RRTAndODTFit(v: vec3f)->vec3f\n{var a: vec3f=v*(v+0.0245786)-0.000090537;var b: vec3f=v*(0.983729*v+0.4329510)+0.238081;return a/b;}\nfn ACESFitted(color: vec3f)->vec3f\n{var output=ACESInputMat*color;output=RRTAndODTFit(output);output=ACESOutputMat*output;output=saturateVec3(output);return output;}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nfn applyImageProcessing(result: vec4f)->vec4f {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\nvar rgb=result.rgb;;\n#ifdef EXPOSURE\nrgb*=uniforms.exposureLinear;\n#endif\n#ifdef VIGNETTE\nvar viewportXY: vec2f=fragmentInputs.position.xy*uniforms.vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;var vignetteXY1: vec3f= vec3f(viewportXY*uniforms.vignetteSettings1.xy+uniforms.vignetteSettings1.zw,1.0);var vignetteTerm: f32=dot(vignetteXY1,vignetteXY1);var vignette: f32=pow(vignetteTerm,uniforms.vignetteSettings2.w);var vignetteColor: vec3f=uniforms.vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvar vignetteColorMultiplier: vec3f=mix(vignetteColor, vec3f(1,1,1),vignette);rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nrgb=mix(vignetteColor,rgb,vignette);\n#endif\n#endif\n#if TONEMAPPING==3\nrgb=PBRNeutralToneMapping(rgb);\n#elif TONEMAPPING==2\nrgb=ACESFitted(rgb);\n#elif TONEMAPPING==1\nconst tonemappingCalibration: f32=1.590579;rgb=1.0-exp2(-tonemappingCalibration*rgb);\n#endif\nrgb=toGammaSpaceVec3(rgb);rgb=saturateVec3(rgb);\n#ifdef CONTRAST\nvar resultHighContrast: vec3f=rgb*rgb*(3.0-2.0*rgb);if (uniforms.contrast<1.0) {rgb=mix( vec3f(0.5,0.5,0.5),rgb,uniforms.contrast);} else {rgb=mix(rgb,resultHighContrast,uniforms.contrast-1.0);}\nrgb=max(rgb,vec3f(0.));\n#endif\n#ifdef COLORGRADING\nvar colorTransformInput: vec3f=rgb*uniforms.colorTransformSettings.xxx+uniforms.colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvar colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput).rgb;\n#else\nvar colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput,uniforms.colorTransformSettings.yz).rgb;\n#endif\nrgb=mix(rgb,colorTransformOutput,uniforms.colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nvar luma: f32=getLuminance(rgb);var curveMix: vec2f=clamp( vec2f(luma*3.0-1.5,luma*-3.0+1.5), vec2f(0.0), vec2f(1.0));var colorCurve: vec4f=uniforms.vCameraColorCurveNeutral+curveMix.x*uniforms.vCameraColorCurvePositive-curveMix.y*uniforms.vCameraColorCurveNegative;rgb*=colorCurve.rgb;rgb=mix( vec3f(luma),rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nvar rand: f32=getRand(fragmentInputs.position.xy*uniforms.vInverseScreenSize);var dither: f32=mix(-uniforms.ditherIntensity,uniforms.ditherIntensity,rand);rgb=saturateVec3(rgb+ vec3f(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn vec4f(rgb,result.a);}");const t$Y="lightsFragmentFunctions";bt$1.IncludesShadersStoreWGSL[t$Y]||(bt$1.IncludesShadersStoreWGSL[t$Y]="struct lightingInfo\n{diffuse: vec3f,\n#ifdef SPECULARTERM\nspecular: vec3f,\n#endif\n#ifdef NDOTL\nndl: f32,\n#endif\n};fn computeLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var lightVectorW: vec3f;var attenuation: f32=1.0;if (lightData.w==0.)\n{var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nvar ndl: f32=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfn getAttenuation(cosAngle: f32,exponent: f32)->f32 {return max(0.,pow(cosAngle,exponent));}\nfn getIESAttenuation(cosAngle: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32 {var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}\nfn computeBasicSpotLighting(viewDirectionW: vec3f,lightVectorW: vec3f,vNormal: vec3f,attenuation: f32,diffuseColor: vec3f,specularColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfn computeIESSpotLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var dotProduct=dot(lightDirection.xyz,-lightVectorW);var cosAngle: f32=max(0.,dotProduct);if (cosAngle>=lightDirection.w)\n{attenuation*=getIESAttenuation(dotProduct,iesLightTexture,iesLightTextureSampler);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nvar result: lightingInfo;result.diffuse=vec3f(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3f(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nfn computeSpotLighting(viewDirectionW: vec3f,vNormal: vec3f ,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var cosAngle: f32=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{attenuation*=getAttenuation(cosAngle,lightData.w);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nvar result: lightingInfo;result.diffuse=vec3f(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3f(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nfn computeHemisphericLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,groundColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightData.xyz);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\nfn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f {var strq: vec4f=textureProjectionMatrix*vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return textureColor;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\nvar areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaLighting(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightPosition:vec3f,halfWidth:vec3f, halfHeight:vec3f,diffuseColor:vec3f,specularColor:vec3f,roughness:f32 )->lightingInfo\n{var result: lightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nvar fresnel:vec3f=( specularColor*data.Fresnel.x+( vec3f( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;\n#endif\nresult.diffuse+=diffuseColor*data.Diffuse;return result;}\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\n#include<clusteredLightingFunctions>\nfn computeClusteredLighting(\nlightDataTexture: texture_2d<f32>,\ntileMaskBuffer: ptr<storage,array<u32>>,\nviewDirectionW: vec3f,\nvNormal: vec3f,\nlightData: vec4f,\nsliceRange: vec2u,\nglossiness: f32\n)->lightingInfo {var result: lightingInfo;let tilePosition=vec2u(fragmentInputs.position.xy*lightData.xy);let maskResolution=vec2u(lightData.zw);var tileIndex=(tilePosition.x*maskResolution.x+tilePosition.y)*maskResolution.y;let batchRange=sliceRange/CLUSTLIGHT_BATCH;var batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tileIndex+=batchRange.x;for (var i=batchRange.x; i<=batchRange.y; i+=1) {var mask=tileMaskBuffer[tileIndex];tileIndex+=1;let maskOffset=max(sliceRange.x,batchOffset)-batchOffset; \nlet maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while mask != 0 {let trailing=firstTrailingBit(mask);mask ^= 1u<<trailing;let light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+trailing);var info: lightingInfo;if light.vLightDirection.w<0.0 {info=computeLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);} else {info=computeSpotLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDirection,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);}\nresult.diffuse+=info.diffuse;\n#ifdef SPECULARTERM\nresult.specular+=info.specular;\n#endif\n}\nbatchOffset+=CLUSTLIGHT_BATCH;}\nreturn result;}\n#endif\n");const o$Z="fogFragmentDeclaration";bt$1.IncludesShadersStoreWGSL[o$Z]||(bt$1.IncludesShadersStoreWGSL[o$Z]="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\nconst E=2.71828;uniform vFogInfos: vec4f;uniform vFogColor: vec3f;varying vFogDistance: vec3f;fn CalcFogFactor()->f32\n{var fogCoeff: f32=1.0;var fogStart: f32=uniforms.vFogInfos.y;var fogEnd: f32=uniforms.vFogInfos.z;var fogDensity: f32=uniforms.vFogInfos.w;var fogDistance: f32=length(fragmentInputs.vFogDistance);if (FOGMODE_LINEAR==uniforms.vFogInfos.x)\n{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}\nelse if (FOGMODE_EXP==uniforms.vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}\nelse if (FOGMODE_EXP2==uniforms.vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}\nreturn clamp(fogCoeff,0.0,1.0);}\n#endif\n");const f$u="logDepthFragment";bt$1.IncludesShadersStoreWGSL[f$u]||(bt$1.IncludesShadersStoreWGSL[f$u]="#ifdef LOGARITHMICDEPTH\nfragmentOutputs.fragDepth=log2(fragmentInputs.vFragmentDepth)*uniforms.logarithmicDepthConstant*0.5;\n#endif\n");const e$o="fogFragment";bt$1.IncludesShadersStoreWGSL[e$o]||(bt$1.IncludesShadersStoreWGSL[e$o]="#ifdef FOG\nvar fog: f32=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor= vec4f(mix(uniforms.vFogColor,color.rgb,fog),color.a);\n#endif\n");const n$1u="lightFragment";bt$1.IncludesShadersStoreWGSL[n$1u]||(bt$1.IncludesShadersStoreWGSL[n$1u]="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\nvar diffuse{X}: vec4f=light{X}.vLightDiffuse;\n#define CUSTOM_LIGHT{X}_COLOR \n#if defined(PBR) && defined(CLUSTLIGHT{X})\n{let sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,fragmentInputs.vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(\nlightDataTexture{X},\n&tileMaskBuffer{X},\nlight{X}.vLightData,\nvec2u(light{X}.vSliceRanges[sliceIndex].xy),\nviewDirectionW,\nnormalW,\nfragmentInputs.vPositionW,\nsurfaceAlbedo,\nreflectivityOut,\n#ifdef IRIDESCENCE\niridescenceIntensity,\n#endif\n#ifdef SS_TRANSLUCENCY\nsubSurfaceOut,\n#endif\n#ifdef SPECULARTERM\nAARoughnessFactors.x,\n#endif\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#ifdef SHEEN\nsheenOut,\n#endif\n#ifdef CLEARCOAT\nclearcoatOut,\n#endif\n);}\n#elif defined(PBR)\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\npreInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#endif\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#endif\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\npreInfo.diffuseRoughness=diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission=vec3f(0.0);\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);\n#elif defined(AREALIGHT{X})\ninfo.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);\n#elif defined(SS_TRANSLUCENCY)\n#ifndef SS_TRANSLUCENCY_LEGACY\ninfo.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance); \n#else\ninfo.diffuse=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);\n#endif\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);\n#endif\n#ifdef SPECULARTERM\n#if AREALIGHT{X}\ninfo.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);\n#else\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\n{let metalFresnel: vec3f=vec3f(reflectivityOut.specularWeight)*getF82Specular(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricFresnel: vec3f=fresnelSchlickGGXVec3(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);}\n#else\ncoloredFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);\n#endif\n#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION\n{let NdotH: f32=dot(normalW,preInfo.H);let fresnel: vec3f=fresnelSchlickGGXVec3(NdotH,vec3f(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3f(1.0)-fresnel);}\n#endif\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,coloredFresnel,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#endif\n#endif\n#ifndef AREALIGHT{X}\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission*=absorption;\n#endif\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission*=info.clearCoat.w;\n#endif\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\n#ifdef IESLIGHTTEXTURE{X}\ninfo=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#endif\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#elif define(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\ninfo=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,\n#ifdef AREALIGHTNOROUGHTNESS\n0.5\n#else\nuniforms.vReflectionInfos.y\n#endif\n);\n#elif defined(CLUSTLIGHT{X})\n{let sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,fragmentInputs.vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(lightDataTexture{X},&tileMaskBuffer{X},viewDirectionW,normalW,light{X}.vLightData,vec2u(light{X}.vSliceRanges[sliceIndex].xy),glossiness);}\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},projectionLightTexture{X}Sampler,uniforms.textureProjectionMatrix{X},fragmentInputs.vPositionW);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSMDEBUG{X}\nvar shadowDebug{X}: vec3f;\n#endif\n#ifdef SHADOWCSM{X}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nvar index{X}: i32=-1;\n#else\nvar index{X}: i32=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nvar diff{X}: f32=0.;vPositionFromLight{X}[0]=fragmentInputs.vPositionFromLight{X}_0;vPositionFromLight{X}[1]=fragmentInputs.vPositionFromLight{X}_1;vPositionFromLight{X}[2]=fragmentInputs.vPositionFromLight{X}_2;vPositionFromLight{X}[3]=fragmentInputs.vPositionFromLight{X}_3;vDepthMetric{X}[0]=fragmentInputs.vDepthMetric{X}_0;vDepthMetric{X}[1]=fragmentInputs.vDepthMetric{X}_1;vDepthMetric{X}[2]=fragmentInputs.vDepthMetric{X}_2;vDepthMetric{X}[3]=fragmentInputs.vDepthMetric{X}_3;for (var i:i32=0; i<SHADOWCSMNUM_CASCADES{X}; i++)\n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=uniforms.viewFrustumZ{X}[i]+fragmentInputs.vPositionFromCamera{X}.z;\n#else\ndiff{X}=uniforms.viewFrustumZ{X}[i]-fragmentInputs.vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {index{X}=i;break;}}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3f(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nvar frustumLength:f32=uniforms.frustumLengths{X}[index{X}];var diffRatio:f32=clamp(diff{X}/frustumLength,0.,1.)*uniforms.cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{index{X}+=1;var nextShadow: f32=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;shadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\naggShadow+=shadow;numLights+=1.0;\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else\ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SS_TRANSLUCENCY\ndiffuseTransmissionBase+=info.diffuseTransmission*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n");const n$1t="intersectionFunctions";bt$1.IncludesShadersStoreWGSL[n$1t]||(bt$1.IncludesShadersStoreWGSL[n$1t]="fn diskIntersectWithBackFaceCulling(ro: vec3f,rd: vec3f,c: vec3f,r: f32)->f32 {var d: f32=rd.y;if(d>0.0) { return 1e6; }\nvar o: vec3f=ro-c;var t: f32=-o.y/d;var q: vec3f=o+rd*t;return select(1e6,t,(dot(q,q)<r*r));}\nfn sphereIntersect(ro: vec3f,rd: vec3f,ce: vec3f,ra: f32)->vec2f {var oc: vec3f=ro-ce;var b: f32=dot(oc,rd);var c: f32=dot(oc,oc)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }\nh=sqrt(h);return vec2f(-b+h,-b-h);}\nfn sphereIntersectFromOrigin(ro: vec3f,rd: vec3f,ra: f32)->vec2f {var b: f32=dot(ro,rd);var c: f32=dot(ro,ro)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }\nh=sqrt(h);return vec2f(-b+h,-b-h);}");const r$1v="backgroundPixelShader",o$Y="#include<backgroundUboDeclaration>\n#include<helperFunctions>\nvarying vPositionW: vec3f;\n#ifdef MAINUV1\nvarying vMainUV1: vec2f;\n#endif \n#ifdef MAINUV2 \nvarying vMainUV2: vec2f; \n#endif \n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vDiffuseUV: vec2f;\n#endif\nvar diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;\n#ifdef TEXTURELODSUPPORT\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;\n#endif\n#else\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;\n#ifdef TEXTURELODSUPPORT\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#include<logDepthDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nfn fresnelSchlickEnvironmentGGX(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f\n{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#ifdef PROJECTED_GROUND\n#include<intersectionFunctions>\nfn project(viewDirectionW: vec3f,eyePosition: vec3f)->vec3f {var radius: f32=uniforms.projectedGroundInfos.x;var height: f32=uniforms.projectedGroundInfos.y;var camDir: vec3f=-viewDirectionW;var skySphereDistance: f32=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;var skySpherePositionW: vec3f=eyePosition+camDir*skySphereDistance;var p: vec3f=normalize(skySpherePositionW);var upEyePosition=vec3f(eyePosition.x,eyePosition.y-height,eyePosition.z);var sIntersection: f32=sphereIntersectFromOrigin(upEyePosition,p,radius).x;var h: vec3f= vec3f(0.0,-height,0.0);var dIntersection: f32=diskIntersectWithBackFaceCulling(upEyePosition,p,h,radius);p=(upEyePosition+min(sIntersection,dIntersection)*p);return p;}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvar viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);\n#ifdef NORMAL\nvar normalW: vec3f=normalize(fragmentInputs.vNormalW);\n#else\nvar normalW: vec3f= vec3f(0.0,1.0,0.0);\n#endif\nvar shadow: f32=1.;var globalShadow: f32=0.;var shadowLightCount: f32=0.;var aggShadow: f32=0.;var numLights: f32=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvar reflectionColor: vec4f= vec4f(1.,1.,1.,1.);\n#ifdef REFLECTION\n#ifdef PROJECTED_GROUND\nvar reflectionVector: vec3f=project(viewDirectionW,scene.vEyePosition.xyz);reflectionVector= (uniforms.reflectionMatrix*vec4f(reflectionVector,1.)).xyz;\n#else\nvar reflectionVector: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvar reflectionCoords: vec3f=reflectionVector;\n#else\nvar reflectionCoords: vec2f=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nvar reflectionLOD: f32=uniforms.vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(uniforms.vReflectionMicrosurfaceInfos.x)*uniforms.vReflectionMicrosurfaceInfos.y+uniforms.vReflectionMicrosurfaceInfos.z;reflectionColor=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);\n#else\nvar lodReflectionNormalized: f32=saturate(reflectionLOD);var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var reflectionSpecularMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(\ntextureSample(reflectionrHighSampler,reflectionrHighSamplerSampler,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);} else {reflectionColor=mix(\nreflectionSpecularMid,\ntextureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#else\nvar reflectionSample: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);reflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor=vec4f(fromRGBD(reflectionColor).rgb,reflectionColor.a);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor=vec4f(toLinearSpaceVec3(reflectionColor.rgb),reflectionColor.a);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor=vec4f(reflectionColor.bgr,reflectionColor.a);\n#endif\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);\n#endif\nvar diffuseColor: vec3f= vec3f(1.,1.,1.);var finalAlpha: f32=uniforms.alpha;\n#ifdef DIFFUSE\nvar diffuseMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap=vec4f(toLinearSpaceVec3(diffuseMap.rgb),diffuseMap.a);\n#endif\ndiffuseMap=vec4f(diffuseMap.rgb *uniforms.vDiffuseInfos.y,diffuseMap.a);\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvar colorBase: vec3f=diffuseColor;\n#else\nvar colorBase: vec3f=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,vec3f(0.0));\n#ifdef USERGBCOLOR\nvar finalColor: vec3f=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvar mainColor: vec3f=mix(uniforms.vPrimaryColorShadow.rgb,uniforms.vPrimaryColor.rgb,colorBase);\n#else\nvar mainColor: vec3f=uniforms.vPrimaryColor.rgb;\n#endif\nvar finalColor: vec3f=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvar reflectionAmount: vec3f=uniforms.vReflectionControl.xxx;var reflectionReflectance0: vec3f=uniforms.vReflectionControl.yyy;var reflectionReflectance90: vec3f=uniforms.vReflectionControl.zzz;var VdotN: f32=dot(normalize(scene.vEyePosition.xyz),normalW);var planarReflectionFresnel: vec3f=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nvar reflectionDistanceFalloff: f32=1.0-saturate(length(vPositionW.xyz-uniforms.vBackgroundCenter)*uniforms.vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturateVec3(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nvar viewAngleToFloor: f32=dot(normalW,normalize(scene.vEyePosition.xyz-uniforms.vBackgroundCenter));const startAngle: f32=0.1;var fadeFactor: f32=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*uniforms.shadowLevel,finalColor,globalShadow);\n#endif\nvar color: vec4f= vec4f(finalColor,finalAlpha);\n#else\nvar color: vec4f= vec4f(uniforms.vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*uniforms.alpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor=vec4f(clamp(color.rgb,vec3f(0.),vec3f(30.0)),color.a);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor=vec4f(color.rgb *color.a,color.a);\n#endif\n#ifdef NOISE\ncolor=vec4f(color.rgb+dither(fragmentInputs.vPositionW.xy,0.5),color.a);color=max(color,vec4f(0.0));\n#endif\nfragmentOutputs.color=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStoreWGSL[r$1v]||(bt$1.ShadersStoreWGSL[r$1v]=o$Y);const i$_={name:r$1v,shader:o$Y};var background_fragmentFey1Liol_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,backgroundPixelShaderWGSL:i$_});const n$1s="backgroundUboDeclaration";bt$1.IncludesShadersStore[n$1s]||(bt$1.IncludesShadersStore[n$1s]="layout(std140,column_major) uniform;uniform Material\n{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform mat4 diffuseMatrix;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;};\n#include<sceneUboDeclaration>\n");const n$1r="fogVertexDeclaration";bt$1.IncludesShadersStore[n$1r]||(bt$1.IncludesShadersStore[n$1r]="#ifdef FOG\nvarying vec3 vFogDistance;\n#endif\n");const t$X="fogVertex";bt$1.IncludesShadersStore[t$X]||(bt$1.IncludesShadersStore[t$X]="#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif\n");const o$X="logDepthVertex";bt$1.IncludesShadersStore[o$X]||(bt$1.IncludesShadersStore[o$X]="#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif\n");const e$n="lightVxFragmentDeclaration";bt$1.IncludesShadersStore[e$n]||(bt$1.IncludesShadersStore[e$n]="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#if defined(AREALIGHT{X})\nuniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};\n#endif\n#endif\n");const n$1q="lightVxUboDeclaration";bt$1.IncludesShadersStore[n$1q]||(bt$1.IncludesShadersStore[n$1q]="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#elif defined(CLUSTLIGHT{X})\nvec2 vSliceData;vec2 vSliceRanges[CLUSTLIGHT_SLICES];\n#endif\n#if defined(AREALIGHT{X})\nvec4 vLightWidth;vec4 vLightHeight;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n");const t$W="shadowsVertex";bt$1.IncludesShadersStore[t$W]||(bt$1.IncludesShadersStore[t$W]="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n}\n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n");const n$1p="logDepthDeclaration";bt$1.IncludesShadersStore[n$1p]||(bt$1.IncludesShadersStore[n$1p]="#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;varying float vFragmentDepth;\n#endif\n");const e$m="backgroundVertexDeclaration";bt$1.IncludesShadersStore[e$m]||(bt$1.IncludesShadersStore[e$m]="uniform mat4 view;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n");const i$Z="backgroundVertexShader",o$W="precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}\n#else\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#endif\nvec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (vDiffuseInfos.x==0.)\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}\nelse\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvColor=colorUpdated;\n#endif\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";bt$1.ShadersStore[i$Z]||(bt$1.ShadersStore[i$Z]=o$W);const f$t={name:i$Z,shader:o$W};var background_vertexCa0V8OXK_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,backgroundVertexShader:f$t});const o$V="reflectionFunction";bt$1.IncludesShadersStore[o$V]||(bt$1.IncludesShadersStore[o$V]="vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }\nvec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }\nvec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}\nvec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}\nvec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}\nvec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*(view*worldPos));}\nvec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*vec4(positionW,1.));}\n#ifdef REFLECTION\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(vPositionUVW,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}\n#endif\n");const t$V="lightFragmentDeclaration";bt$1.IncludesShadersStore[t$V]||(bt$1.IncludesShadersStore[t$V]="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};\n#else\nuniform highp sampler2DArray shadowTexture{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowTexture{X};\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowTexture{X};\n#else\nuniform sampler2D shadowTexture{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#ifdef AREALIGHT{X}\nuniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};\n#endif\n#ifdef IESLIGHTTEXTURE{X}\nuniform sampler2D iesLightTexture{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};\n#endif\n#ifdef CLUSTLIGHT{X}\nuniform vec2 vSliceData{X};uniform vec2 vSliceRanges{X}[CLUSTLIGHT_SLICES];uniform sampler2D lightDataTexture{X};uniform highp sampler2D tileMaskTexture{X};\n#endif\n#endif\n");const i$Y="lightUboDeclaration";bt$1.IncludesShadersStore[i$Y]||(bt$1.IncludesShadersStore[i$Y]="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#elif defined(CLUSTLIGHT{X})\nvec2 vSliceData;vec2 vSliceRanges[CLUSTLIGHT_SLICES];\n#endif\n#if defined(AREALIGHT{X})\nvec4 vLightWidth;vec4 vLightHeight;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef IESLIGHTTEXTURE{X}\nuniform sampler2D iesLightTexture{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};\n#endif\n#ifdef CLUSTLIGHT{X}\nuniform sampler2D lightDataTexture{X};uniform highp sampler2D tileMaskTexture{X};\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};\n#else\nuniform highp sampler2DArray shadowTexture{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowTexture{X}; \n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowTexture{X};\n#else\nuniform sampler2D shadowTexture{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n");const n$1o="ltcHelperFunctions";bt$1.IncludesShadersStore[n$1o]||(bt$1.IncludesShadersStore[n$1o]="vec2 LTCUv( const in vec3 N,const in vec3 V,const in float roughness ) {const float LUTSIZE=64.0;const float LUTSCALE=( LUTSIZE-1.0 )/LUTSIZE;const float LUTBIAS=0.5/LUTSIZE;float dotNV=saturate( dot( N,V ) );vec2 uv=vec2( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}\nfloat LTCClippedSphereFormFactor( const in vec3 f ) {float l=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}\nvec3 LTCEdgeVectorFormFactor( const in vec3 v1,const in vec3 v2 ) {float x=dot( v1,v2 );float y=abs( x );float a=0.8543985+( 0.4965155+0.0145206*y )*y;float b=3.4175940+( 4.1616724+y )*y;float v=a/b;float thetaSintheta=0.0;if( x>0.0 )\n{thetaSintheta=v;}\nelse\n{thetaSintheta=0.5*inversesqrt( max( 1.0-x*x,1e-7 ) )-v;}\nreturn cross( v1,v2 )*thetaSintheta;}\nvec3 LTCEvaluate( const in vec3 N,const in vec3 V,const in vec3 P,const in mat3 mInv,const in vec3 rectCoords[ 4 ] ) {vec3 v1=rectCoords[ 1 ]-rectCoords[ 0 ];vec3 v2=rectCoords[ 3 ]-rectCoords[ 0 ];vec3 lightNormal=cross( v1,v2 );if( dot( lightNormal,P-rectCoords[ 0 ] )<0.0 ) return vec3( 0.0 );vec3 T1,T2;T1=normalize( V-N*dot( V,N ) );T2=- cross( N,T1 ); \nmat3 mat=mInv*transposeMat3( mat3( T1,T2,N ) );vec3 coords[ 4 ];coords[ 0 ]=mat*( rectCoords[ 0 ]-P );coords[ 1 ]=mat*( rectCoords[ 1 ]-P );coords[ 2 ]=mat*( rectCoords[ 2 ]-P );coords[ 3 ]=mat*( rectCoords[ 3 ]-P );coords[ 0 ]=normalize( coords[ 0 ] );coords[ 1 ]=normalize( coords[ 1 ] );coords[ 2 ]=normalize( coords[ 2 ] );coords[ 3 ]=normalize( coords[ 3 ] );vec3 vectorFormFactor=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 0 ],coords[ 1 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 1 ],coords[ 2 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 2 ],coords[ 3 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 3 ],coords[ 0 ] );float result=LTCClippedSphereFormFactor( vectorFormFactor );return vec3( result );}\nstruct areaLightData\n{vec3 Diffuse;vec3 Specular;vec4 Fresnel;};\n#define inline\nareaLightData computeAreaLightSpecularDiffuseFresnel(const in sampler2D ltc1,const in sampler2D ltc2,const in vec3 viewDir,const in vec3 normal,const in vec3 position,const in vec3 lightPos,const in vec3 halfWidth,const in vec3 halfHeight,const in float roughness) \n{areaLightData result;vec3 rectCoords[ 4 ];rectCoords[ 0 ]=lightPos+halfWidth-halfHeight; \nrectCoords[ 1 ]=lightPos-halfWidth-halfHeight;rectCoords[ 2 ]=lightPos-halfWidth+halfHeight;rectCoords[ 3 ]=lightPos+halfWidth+halfHeight;\n#ifdef SPECULARTERM\nvec2 uv=LTCUv( normal,viewDir,roughness );vec4 t1=texture2D( ltc1,uv );vec4 t2=texture2D( ltc2,uv );mat3 mInv=mat3(\nvec3( t1.x,0,t1.y ),\nvec3( 0,1, 0 ),\nvec3( t1.z,0,t1.w )\n);result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords );result.Fresnel=t2;\n#endif\nresult.Diffuse=LTCEvaluate( normal,viewDir,position,mat3( 1.0 ),rectCoords );return result;}");const a$N="shadowsFragmentFunctions";bt$1.IncludesShadersStore[a$N]||(bt$1.IncludesShadersStore[a$N]="#ifdef SHADOWS\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}\n#endif\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}\n#define inline\nfloat computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nreturn depth>shadow ? darkness : 1.0;}\n#define inline\nfloat computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);}\n#define inline\nfloat computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}\n#define inline\nfloat computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define inline\nfloat computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uvLayer));\n#else\nfloat shadow=texture2D(shadowSampler,uvLayer).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}\n#endif\n#define inline\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}\n#define inline\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\n#else\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#ifdef IS_NDC_HALF_ZRANGE\n#define ZINCLIP clipSpace.z\n#else\n#define ZINCLIP uvDepth.z\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define SMALLEST_ABOVE_ZERO 1.1754943508e-38\n#define GREATEST_LESS_THAN_ONE 0.99999994\n#define DISABLE_UNIFORMITY_ANALYSIS\n#define inline\nfloat computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\n#ifdef USE_REVERSE_DEPTHBUFFER\nuvDepth.z=clamp(ZINCLIP,SMALLEST_ABOVE_ZERO,1.);\n#else\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\n#endif\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\n#ifdef USE_REVERSE_DEPTHBUFFER\nuvDepth.z=clamp(ZINCLIP,SMALLEST_ABOVE_ZERO,1.);\n#else\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\n#endif\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\n#ifdef USE_REVERSE_DEPTHBUFFER\nuvDepth.z=clamp(ZINCLIP,SMALLEST_ABOVE_ZERO,1.);\n#else\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\n#endif\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.)\n);const vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n#define inline\nfloat computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\n#ifdef USE_REVERSE_DEPTHBUFFER\nuvDepth.z=clamp(ZINCLIP,SMALLEST_ABOVE_ZERO,1.);\n#else\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\n#endif\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}\nelse\n{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nif (numBlocker<1.0) {return 1.0;}\nelse\n{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}\n#define inline\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}\n#define inline\nfloat computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#endif\n#endif\n");const r$1u="imageProcessingDeclaration";bt$1.IncludesShadersStore[r$1u]||(bt$1.IncludesShadersStore[r$1u]="#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vec2 vInverseScreenSize;\n#endif\n#ifdef VIGNETTE\nuniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif\n#ifdef DITHER\nuniform float ditherIntensity;\n#endif\n");const n$1n="imageProcessingFunctions";bt$1.IncludesShadersStore[n$1n]||(bt$1.IncludesShadersStore[n$1n]="#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n/** \n* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.\n* sampler3dSetting.x=textureOffset (0.5/textureSize).\n* sampler3dSetting.y=textureSize.\n*/\n#define inline\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{float sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;}\n#endif\n#if TONEMAPPING==3\nconst float PBRNeutralStartCompression=0.8-0.04;const float PBRNeutralDesaturation=0.15;vec3 PBRNeutralToneMapping( vec3 color ) {float x=min(color.r,min(color.g,color.b));float offset=x<0.08 ? x-6.25*x*x : 0.04;color-=offset;float peak=max(color.r,max(color.g,color.b));if (peak<PBRNeutralStartCompression) return color;float d=1.-PBRNeutralStartCompression;float newPeak=1.-d*d/(peak+d-PBRNeutralStartCompression);color*=newPeak/peak;float g=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(color,newPeak*vec3(1,1,1),g);}\n#endif\n#if TONEMAPPING==2\nconst mat3 ACESInputMat=mat3(\nvec3(0.59719,0.07600,0.02840),\nvec3(0.35458,0.90834,0.13383),\nvec3(0.04823,0.01566,0.83777)\n);const mat3 ACESOutputMat=mat3(\nvec3( 1.60475,-0.10208,-0.00327),\nvec3(-0.53108, 1.10813,-0.07276),\nvec3(-0.07367,-0.00605, 1.07602)\n);vec3 RRTAndODTFit(vec3 v)\n{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}\nvec3 ACESFitted(vec3 color)\n{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nvec4 applyImageProcessing(vec4 result) {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#if TONEMAPPING==3\nresult.rgb=PBRNeutralToneMapping(result.rgb);\n#elif TONEMAPPING==2\nresult.rgb=ACESFitted(result.rgb);\n#elif TONEMAPPING==1\nconst float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\nresult.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);\n#ifdef CONTRAST\nvec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}\nresult.rgb=max(result.rgb,0.);\n#endif\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nfloat luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nfloat rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn result;}");const i$X="clusteredLightingFunctions";bt$1.IncludesShadersStore[i$X]||(bt$1.IncludesShadersStore[i$X]="struct ClusteredLight {vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;vec4 vLightDirection;vec4 vLightFalloff;};\n#define inline\nClusteredLight getClusteredLight(sampler2D lightDataTexture,int index) {return ClusteredLight(\ntexelFetch(lightDataTexture,ivec2(0,index),0),\ntexelFetch(lightDataTexture,ivec2(1,index),0),\ntexelFetch(lightDataTexture,ivec2(2,index),0),\ntexelFetch(lightDataTexture,ivec2(3,index),0),\ntexelFetch(lightDataTexture,ivec2(4,index),0)\n);}\nint getClusteredSliceIndex(vec2 sliceData,float viewDepth) {return int(log(viewDepth)*sliceData.x+sliceData.y);}\n");const n$1m="lightFragment";bt$1.IncludesShadersStore[n$1m]||(bt$1.IncludesShadersStore[n$1m]="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\nvec4 diffuse{X}=light{X}.vLightDiffuse;\n#define CUSTOM_LIGHT{X}_COLOR \n#if defined(PBR) && defined(CLUSTLIGHT{X}) && defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\n{int sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(\nlightDataTexture{X},\ntileMaskTexture{X},\nlight{X}.vLightData,\nivec2(light{X}.vSliceRanges[sliceIndex]),\nviewDirectionW,\nnormalW,\nvPositionW,\nsurfaceAlbedo,\nreflectivityOut\n#ifdef IRIDESCENCE\n,iridescenceIntensity\n#endif\n#ifdef SS_TRANSLUCENCY\n,subSurfaceOut\n#endif\n#ifdef SPECULARTERM\n,AARoughnessFactors.x\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef SHEEN\n,sheenOut\n#endif\n#ifdef CLEARCOAT\n,clearcoatOut\n#endif\n);}\n#elif defined(PBR)\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\npreInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#endif\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#endif\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\npreInfo.diffuseRoughness=diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission=vec3(0.0);\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);\n#elif defined(AREALIGHT{X})\ninfo.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);\n#elif defined(SS_TRANSLUCENCY)\n#ifndef SS_TRANSLUCENCY_LEGACY\ninfo.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance); \n#else\ninfo.diffuse=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);\n#endif\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);\n#endif\n#ifdef SPECULARTERM\n#if AREALIGHT{X}\ninfo.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);\n#else\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\n{vec3 metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricFresnel=fresnelSchlickGGX(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);}\n#else\ncoloredFresnel=fresnelSchlickGGX(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);\n#endif\n#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION\n{float NdotH=dot(normalW,preInfo.H);vec3 fresnel=fresnelSchlickGGX(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);}\n#endif\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,coloredFresnel,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#endif\n#endif\n#ifndef AREALIGHT{X}\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission*=absorption;\n#endif\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission*=info.clearCoat.w;\n#endif\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\n#ifdef IESLIGHTTEXTURE{X}\ninfo=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X});\n#else\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#endif\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\ninfo=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.rgb,light{X}.vLightHeight.rgb,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,\n#ifdef AREALIGHTNOROUGHTNESS\n0.5\n#else\nvReflectionInfos.y\n#endif\n);\n#elif defined(CLUSTLIGHT{X}) && CLUSTLIGHT_BATCH>0\n{int sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(lightDataTexture{X},tileMaskTexture{X},viewDirectionW,normalW,light{X}.vLightData,ivec2(light{X}.vSliceRanges[sliceIndex]),glossiness);}\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++)\n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;\n#else\ndiff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {index{X}=i;break;}}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nfloat frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{index{X}+=1;float nextShadow=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;shadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\naggShadow+=shadow;numLights+=1.0;\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else\ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SS_TRANSLUCENCY\ndiffuseTransmissionBase+=info.diffuseTransmission*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n");const t$U="lightsFragmentFunctions";bt$1.IncludesShadersStore[t$U]||(bt$1.IncludesShadersStore[t$U]="struct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)\n{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfloat getAttenuation(float cosAngle,float exponent) {return max(0.,pow(cosAngle,exponent));}\nfloat getIESAttenuation(float cosAngle,sampler2D iesLightSampler) {float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}\nlightingInfo basicSpotLighting(vec3 viewDirectionW,vec3 lightVectorW,vec3 vNormal,float attenuation,vec3 diffuseColor,vec3 specularColor,float glossiness) {lightingInfo result; \nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nlightingInfo computeIESSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness,sampler2D iesLightSampler) { \nvec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float dotProduct=dot(lightDirection.xyz,-lightVectorW);float cosAngle=max(0.,dotProduct);if (cosAngle>=lightDirection.w)\n{ \nattenuation*=getIESAttenuation(dotProduct,iesLightSampler);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nlightingInfo result;result.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{ \nattenuation*=getAttenuation(cosAngle,lightData.w);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nlightingInfo result;result.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\nuniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;\n#define inline\nlightingInfo computeAreaLighting(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec3 lightPosition,vec3 halfWidth,vec3 halfHeight,vec3 diffuseColor,vec3 specularColor,float roughness) \n{lightingInfo result;areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nvec3 fresnel=( specularColor*data.Fresnel.x+( vec3( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;\n#endif\nresult.diffuse+=diffuseColor*data.Diffuse;return result;}\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\n#include<clusteredLightingFunctions>\n#define inline\nlightingInfo computeClusteredLighting(\nsampler2D lightDataTexture,\nsampler2D tileMaskTexture,\nvec3 viewDirectionW,\nvec3 vNormal,\nvec4 lightData,\nivec2 sliceRange,\nfloat glossiness\n) {lightingInfo result;ivec2 tilePosition=ivec2(gl_FragCoord.xy*lightData.xy);int maskHeight=int(lightData.z);tilePosition.y=min(tilePosition.y,maskHeight-1);ivec2 batchRange=sliceRange/CLUSTLIGHT_BATCH;int batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tilePosition.y+=maskHeight*batchRange.x;for (int i=batchRange.x; i<=batchRange.y; i+=1) {uint mask=uint(texelFetch(tileMaskTexture,tilePosition,0).r);tilePosition.y+=maskHeight;int maskOffset=max(sliceRange.x-batchOffset,0);int maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while (mask != 0u) {uint bit=mask & -mask;mask ^= bit;int position=onlyBitPosition(bit);ClusteredLight light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+position);lightingInfo info;if (light.vLightDirection.w<0.0) {info=computeLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);} else {info=computeSpotLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDirection,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);}\nresult.diffuse+=info.diffuse;\n#ifdef SPECULARTERM\nresult.specular+=info.specular;\n#endif\n}\nbatchOffset+=CLUSTLIGHT_BATCH;}\nreturn result;}\n#endif\n");const n$1l="fogFragmentDeclaration";bt$1.IncludesShadersStore[n$1l]||(bt$1.IncludesShadersStore[n$1l]="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()\n{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)\n{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}\nelse if (FOGMODE_EXP==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}\nelse if (FOGMODE_EXP2==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}\nreturn clamp(fogCoeff,0.0,1.0);}\n#endif\n");const e$l="logDepthFragment";bt$1.IncludesShadersStore[e$l]||(bt$1.IncludesShadersStore[e$l]="#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif\n");const f$s="fogFragment";bt$1.IncludesShadersStore[f$s]||(bt$1.IncludesShadersStore[f$s]="#ifdef FOG\nfloat fog=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor.rgb=mix(vFogColor,color.rgb,fog);\n#endif\n");const n$1k="backgroundFragmentDeclaration";bt$1.IncludesShadersStore[n$1k]||(bt$1.IncludesShadersStore[n$1k]="uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nuniform vec4 vPrimaryColorShadow;\n#endif\nuniform float shadowLevel;uniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef PROJECTED_GROUND\nuniform vec2 projectedGroundInfos;\n#endif\n");const o$U="intersectionFunctions";bt$1.IncludesShadersStore[o$U]||(bt$1.IncludesShadersStore[o$U]="float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }\nvec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}\nvec2 sphereIntersect(vec3 ro,vec3 rd,vec3 ce,float ra) {vec3 oc=ro-ce;float b=dot(oc,rd);float c=dot(oc,oc)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }\nh=sqrt(h);return vec2(-b+h,-b-h);}\nvec2 sphereIntersectFromOrigin(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }\nh=sqrt(h);return vec2(-b+h,-b-h);}");const i$W="backgroundPixelShader",r$1t="#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#include<helperFunctions>\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#ifdef PROJECTED_GROUND\n#include<intersectionFunctions>\nvec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersectFromOrigin(eyePosition,p,radius).x;vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\nfloat shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvec4 reflectionColor=vec4(1.,1.,1.,1.);\n#ifdef REFLECTION\n#ifdef PROJECTED_GROUND\nvec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);} else {reflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor.rgb=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor.rgb=reflectionColor.bgr;\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#endif\nvec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);\n#else\nvec3 mainColor=vPrimaryColor.rgb;\n#endif\nvec3 finalColor=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\nvec4 color=vec4(finalColor,finalAlpha);\n#else\nvec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);\n#endif\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStore[i$W]||(bt$1.ShadersStore[i$W]=r$1t);const f$r={name:i$W,shader:r$1t};var background_fragmentBQDdXoiV_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,backgroundPixelShader:f$r});const r$1s="passPixelShader",t$T="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);}";bt$1.ShadersStoreWGSL[r$1s]||(bt$1.ShadersStoreWGSL[r$1s]=t$T);const a$M={name:r$1s,shader:t$T};var pass_fragmentBTnRKMbi_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,passPixelShaderWGSL:a$M});const r$1r="passPixelShader",a$L="varying vec2 vUV;uniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);}";bt$1.ShadersStore[r$1r]||(bt$1.ShadersStore[r$1r]=a$L);const n$1j={name:r$1r,shader:a$L};var pass_fragmentY28YD4oC_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,passPixelShader:n$1j});const t$S="passCubePixelShader",r$1q="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f=input.vUV*2.0-1.0;\n#ifdef POSITIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,-1.001));\n#endif\n}";bt$1.ShadersStoreWGSL[t$S]||(bt$1.ShadersStoreWGSL[t$S]=r$1q);const u$m={name:t$S,shader:r$1q};var passCube_fragmentDQB4iKcr_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,passCubePixelShaderWGSL:u$m});const r$1p="passCubePixelShader",n$1i="varying vec2 vUV;uniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";bt$1.ShadersStore[r$1p]||(bt$1.ShadersStore[r$1p]=n$1i);const u$l={name:r$1p,shader:n$1i};var passCube_fragmentCoj5UJcQ_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,passCubePixelShader:u$l});const r$1o="rgbdDecodePixelShader";bt$1.ShadersStoreWGSL[r$1o]||(bt$1.ShadersStoreWGSL[r$1o]="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(fromRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV)),1.0);}");var rgbdDecode_fragmentC93bUglL_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const r$1n="rgbdDecodePixelShader";bt$1.ShadersStore[r$1n]||(bt$1.ShadersStore[r$1n]="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}");var rgbdDecode_fragmentBCFIXNGa_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const r$1m="rgbdEncodePixelShader";bt$1.ShadersStoreWGSL[r$1m]||(bt$1.ShadersStoreWGSL[r$1m]="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=toRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb);}");var rgbdEncode_fragmentDSvE5Q3X_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const r$1l="rgbdEncodePixelShader";bt$1.ShadersStore[r$1l]||(bt$1.ShadersStore[r$1l]="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}");var rgbdEncode_fragmentBiQ_a6bE_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const f$q="pbrUboDeclaration";bt$1.IncludesShadersStoreWGSL[f$q]||(bt$1.IncludesShadersStoreWGSL[f$q]="uniform vAlbedoInfos: vec2f;uniform vBaseWeightInfos: vec2f;uniform vBaseDiffuseRoughnessInfos: vec2f;uniform vAmbientInfos: vec4f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vReflectivityInfos: vec3f;uniform vMicroSurfaceSamplerInfos: vec2f;uniform vBumpInfos: vec3f;uniform albedoMatrix: mat4x4f;uniform baseWeightMatrix: mat4x4f;uniform baseDiffuseRoughnessMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform reflectivityMatrix: mat4x4f;uniform microSurfaceSamplerMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform vAlbedoColor: vec4f;uniform baseWeight: f32;uniform baseDiffuseRoughness: f32;uniform vLightingIntensity: vec4f;uniform pointSize: f32;uniform vReflectivityColor: vec4f;uniform vEmissiveColor: vec3f;uniform vAmbientColor: vec3f;uniform vDebugMode: vec2f;uniform vMetallicReflectanceFactors: vec4f;uniform vMetallicReflectanceInfos: vec2f;uniform metallicReflectanceMatrix: mat4x4f;uniform vReflectanceInfos: vec2f;uniform reflectanceMatrix: mat4x4f;uniform cameraInfo: vec4f;uniform vReflectionInfos: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionDominantDirection: vec3f;uniform vReflectionColor: vec3f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;\n#define ADDITIONAL_UBO_DECLARATION\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n");const n$1h="uvAttributeDeclaration";bt$1.IncludesShadersStoreWGSL[n$1h]||(bt$1.IncludesShadersStoreWGSL[n$1h]="#ifdef UV{X}\nattribute uv{X}: vec2f;\n#endif\n");const i$V="prePassVertexDeclaration";bt$1.IncludesShadersStoreWGSL[i$V]||(bt$1.IncludesShadersStoreWGSL[i$V]="#ifdef PREPASS\n#ifdef PREPASS_LOCAL_POSITION\nvarying vPosition : vec3f;\n#endif\n#ifdef PREPASS_DEPTH\nvarying vViewPos: vec3f;\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\nvarying vNormViewDepth: f32;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nuniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#endif\n");const r$1k="samplerVertexDeclaration";bt$1.IncludesShadersStoreWGSL[r$1k]||(bt$1.IncludesShadersStoreWGSL[r$1k]="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying v_VARYINGNAME_UV: vec2f;\n#endif\n");const t$R="prePassVertex";bt$1.IncludesShadersStoreWGSL[t$R]||(bt$1.IncludesShadersStoreWGSL[t$R]="#ifdef PREPASS_DEPTH\nvertexOutputs.vViewPos=(scene.view*worldPos).rgb;\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\nvertexOutputs.vNormViewDepth=((scene.view*worldPos).z-uniforms.cameraInfo.x)/(uniforms.cameraInfo.y-uniforms.cameraInfo.x);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nvertexOutputs.vPosition=positionUpdated.xyz;\n#endif\n#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nvar previousInfluence: mat4x4f;previousInfluence=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];\n#endif\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);\n#else\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);\n#endif\n#endif\n");const s$m="uvVariableDeclaration";bt$1.IncludesShadersStoreWGSL[s$m]||(bt$1.IncludesShadersStoreWGSL[s$m]="#ifdef MAINUV{X}\n#if !defined(UV{X})\nvar uv{X}: vec2f=vec2f(0.,0.);\n#else\nvar uv{X}: vec2f=vertexInputs.uv{X};\n#endif\nvertexOutputs.vMainUV{X}=uv{X};\n#endif\n");const f$p="samplerVertexImplementation";bt$1.IncludesShadersStoreWGSL[f$p]||(bt$1.IncludesShadersStoreWGSL[f$p]="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (uniforms.v_INFONAME_==0.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uvUpdated,1.0,0.0)).xy;}\n#ifdef UV2\nelse if (uniforms.v_INFONAME_==1.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uv2Updated,1.0,0.0)).xy;}\n#endif\n#ifdef UV3\nelse if (uniforms.v_INFONAME_==2.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv3,1.0,0.0)).xy;}\n#endif\n#ifdef UV4\nelse if (uniforms.v_INFONAME_==3.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv4,1.0,0.0)).xy;}\n#endif\n#ifdef UV5\nelse if (uniforms.v_INFONAME_==4.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv5,1.0,0.0)).xy;}\n#endif\n#ifdef UV6\nelse if (uniforms.v_INFONAME_==5.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv6,1.0,0.0)).xy;}\n#endif\n#endif\n");const u$k="vertexColorMixing";bt$1.IncludesShadersStoreWGSL[u$k]||(bt$1.IncludesShadersStoreWGSL[u$k]="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvertexOutputs.vColor=vec4f(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvertexOutputs.vColor*=vertexInputs.color;\n#else\nvertexOutputs.vColor=vec4f(vertexOutputs.vColor.rgb*vertexInputs.color.rgb,vertexOutputs.vColor.a);\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvertexOutputs.vColor*=vertexInputs.instanceColor;\n#endif\n#endif\n");const e$k="mainUVVaryingDeclaration";bt$1.IncludesShadersStoreWGSL[e$k]||(bt$1.IncludesShadersStoreWGSL[e$k]="#ifdef MAINUV{X}\nvarying vMainUV{X}: vec2f;\n#endif\n");const n$1g="pbrBRDFFunctions";bt$1.IncludesShadersStoreWGSL[n$1g]||(bt$1.IncludesShadersStoreWGSL[n$1g]="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#define BRDF_DIFFUSE_MODEL_EON 0\n#define BRDF_DIFFUSE_MODEL_BURLEY 1\n#define BRDF_DIFFUSE_MODEL_LAMBERT 2\n#define BRDF_DIFFUSE_MODEL_LEGACY 3\n#define DIELECTRIC_SPECULAR_MODEL_GLTF 0\n#define DIELECTRIC_SPECULAR_MODEL_OPENPBR 1\n#define CONDUCTOR_SPECULAR_MODEL_GLTF 0\n#define CONDUCTOR_SPECULAR_MODEL_OPENPBR 1\n#if !defined(PBR_VERTEX_SHADER) && !defined(OPENPBR_VERTEX_SHADER)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nfn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR \nfn getF82Specular(NdotV: f32,F0: vec3f,edgeTint: vec3f,roughness: f32)->vec3f {const cos_theta_max: f32=0.142857143; \nconst one_minus_cos_theta_max_to_the_fifth: f32=0.462664366; \nconst one_minus_cos_theta_max_to_the_sixth: f32=0.396569457; \nlet white_minus_F0: vec3f=vec3f(1.0f)-F0;let b_numerator: vec3f=(F0+white_minus_F0*one_minus_cos_theta_max_to_the_fifth)*(vec3f(1.0)-edgeTint);const b_denominator: f32=cos_theta_max*one_minus_cos_theta_max_to_the_sixth;const b_denominator_reciprocal: f32=1.0f/b_denominator;let b: vec3f=b_numerator*b_denominator_reciprocal; \nlet cos_theta: f32=max(roughness,NdotV);let one_minus_cos_theta: f32=1.0-cos_theta;let offset_from_F0: vec3f=(white_minus_F0-b*cos_theta*one_minus_cos_theta)*pow(one_minus_cos_theta,5.0f);return clamp(F0+offset_from_F0,vec3f(0.0f),vec3f(1.0f));}\n#endif\n#ifdef FUZZENVIRONMENTBRDF\nfn getFuzzBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {let UV: vec2f=vec2f(perceptualRoughness,NdotV);var brdfLookup: vec4f=textureSample(environmentFuzzBrdfSampler,environmentFuzzBrdfSamplerSampler,UV);const RiRange: vec2f=vec2f(0.0f,0.75f);const ARange: vec2f=vec2f(0.005f,0.88f);const BRange: vec2f=vec2f(-0.18f,0.002f);brdfLookup.r=mix(ARange.x, ARange.y, brdfLookup.r);brdfLookup.g=mix(BRange.x, BRange.y, brdfLookup.g);brdfLookup.b=mix(RiRange.x,RiRange.y,brdfLookup.b);return brdfLookup.rgb;}\n#endif\n#ifdef ENVIRONMENTBRDF\nfn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);\n#endif\nreturn brdfLookup.rgb;}\nfn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvar reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nfn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvar reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32\n{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nfn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f\n{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nfn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nfn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nfn getR0RemappedForClearCoat(f0: vec3f)->vec3f {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvar s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst XYZ_TO_REC709: mat3x3f= mat3x3f(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nfn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}\nfn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}\nfn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}\nfn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nvar cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}\nvar phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); \nvar R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}\nif (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}\nif (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}\nvar opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)\n{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}\nreturn max(I, vec3f(0.0));}\n#endif\nfn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32\n{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32\n{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {\n#ifdef MOBILE\nvar GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nvar a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nvar alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32\n{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfn l(x: f32,alphaG: f32)->f32\n{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfn lambdaSheen(cosTheta: f32,alphaG: f32)->f32\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32\n{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nconst constant1_FON: f32=0.5f-2.0f/(3.0f*PI);const constant2_FON: f32=2.0f/3.0f-28.0f/(15.0f*PI);fn E_FON_approx(mu: f32,roughness: f32)->f32\n{var sigma: f32=roughness; \nvar mucomp: f32=1.0f-mu;var mucomp2: f32=mucomp*mucomp;const Gcoeffs: mat2x2f=mat2x2f(0.0571085289f,-0.332181442f,\n0.491881867f,0.0714429953f);var GoverPi: f32=dot(Gcoeffs*vec2f(mucomp,mucomp2),vec2f(1.0f,mucomp2));return (1.0f+sigma*GoverPi)/(1.0f+constant1_FON*sigma);}\nfn diffuseBRDF_EON(albedo: vec3f,roughness: f32,NdotL: f32,NdotV: f32,LdotV: f32)->vec3f\n{var rho: vec3f=albedo;var sigma: f32=roughness; \nvar mu_i: f32=NdotL; \nvar mu_o: f32=NdotV; \nvar s: f32=LdotV-mu_i*mu_o; \nvar sovertF: f32=select(s,s/max(mu_i,mu_o),s>0.0f); \nvar AF: f32=1.0f/(1.0f+constant1_FON*sigma); \nvar f_ss: vec3f=(rho*RECIPROCAL_PI)*AF*(1.0f+sigma*sovertF); \nvar EFo: f32=E_FON_approx(mu_o,sigma); \nvar EFi: f32=E_FON_approx(mu_i,sigma); \nvar avgEF: f32=AF*(1.0f+constant2_FON*sigma); \nvar rho_ms: vec3f=(rho*rho)*avgEF/(vec3f(1.0f)-rho*(1.0f-avgEF));const eps: f32=1.0e-7f;var f_ms: vec3f=(rho_ms*RECIPROCAL_PI)*max(eps,1.0f-EFo) \n* max(eps,1.0f-EFi)\n/ max(eps,1.0f-avgEF);return (f_ss+f_ms);}\nfn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\n#ifdef SS_TRANSLUCENCY\nfn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}\n#endif\n#endif \n");const n$1f="harmonicsFunctions";bt$1.IncludesShadersStoreWGSL[n$1f]||(bt$1.IncludesShadersStoreWGSL[n$1f]="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nfn computeEnvironmentIrradiance(normal: vec3f)->vec3f {return uniforms.vSphericalL00\n+ uniforms.vSphericalL1_1*(normal.y)\n+ uniforms.vSphericalL10*(normal.z)\n+ uniforms.vSphericalL11*(normal.x)\n+ uniforms.vSphericalL2_2*(normal.y*normal.x)\n+ uniforms.vSphericalL2_1*(normal.y*normal.z)\n+ uniforms.vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ uniforms.vSphericalL21*(normal.z*normal.x)\n+ uniforms.vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}\n#else\nfn computeEnvironmentIrradiance(normal: vec3f)->vec3f {var Nx: f32=normal.x;var Ny: f32=normal.y;var Nz: f32=normal.z;var C1: vec3f=uniforms.vSphericalZZ.rgb;var Cx: vec3f=uniforms.vSphericalX.rgb;var Cy: vec3f=uniforms.vSphericalY.rgb;var Cz: vec3f=uniforms.vSphericalZ.rgb;var Cxx_zz: vec3f=uniforms.vSphericalXX_ZZ.rgb;var Cyy_zz: vec3f=uniforms.vSphericalYY_ZZ.rgb;var Cxy: vec3f=uniforms.vSphericalXY.rgb;var Cyz: vec3f=uniforms.vSphericalYZ.rgb;var Czx: vec3f=uniforms.vSphericalZX.rgb;var a1: vec3f=Cyy_zz*Ny+Cy;var a2: vec3f=Cyz*Nz+a1;var b1: vec3f=Czx*Nz+Cx;var b2: vec3f=Cxy*Ny+b1;var b3: vec3f=Cxx_zz*Nx+b2;var t1: vec3f=Cz *Nz+C1;var t2: vec3f=a2 *Ny+t1;var t3: vec3f=b3 *Nx+t2;return t3;}\n#endif\n#endif\n");const n$1e="bumpVertexDeclaration";bt$1.IncludesShadersStoreWGSL[n$1e]||(bt$1.IncludesShadersStoreWGSL[n$1e]="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;\n#endif\n#endif\n");const n$1d="bumpVertex";bt$1.IncludesShadersStoreWGSL[n$1d]||(bt$1.IncludesShadersStoreWGSL[n$1d]="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvar tbnNormal: vec3f=normalize(normalUpdated);var tbnTangent: vec3f=normalize(tangentUpdated.xyz);var tbnBitangent: vec3f=cross(tbnNormal,tbnTangent)*tangentUpdated.w;var matTemp= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)* mat3x3f(tbnTangent,tbnBitangent,tbnNormal);vertexOutputs.vTBN0=matTemp[0];vertexOutputs.vTBN1=matTemp[1];vertexOutputs.vTBN2=matTemp[2];\n#endif\n#endif\n");const n$1c="pbrVertexShader",i$U="#define PBR_VERTEX_SHADER\n#include<pbrUboDeclaration>\n#define CUSTOM_VERTEX_BEGIN\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#ifdef TANGENT\nattribute tangent: vec4f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)\n#endif\nvarying vPositionW: vec3f;\n#if DEBUGMODE>0\nvarying vClipSpacePosition: vec4f;\n#endif\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vEnvironmentIrradiance: vec3f;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<lightVxUboDeclaration>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvarying vViewDepth: f32;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar positionUpdated: vec3f=vertexInputs.position;\n#ifdef NORMAL\nvar normalUpdated: vec3f=vertexInputs.normal;\n#endif\n#ifdef TANGENT\nvar tangentUpdated: vec4f=vertexInputs.tangent;\n#endif\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=vertexInputs.uv2;\n#endif\n#ifdef VERTEXCOLOR\nvar colorUpdated: vec4f=vertexInputs.color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nvar normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY\nvar viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-vertexOutputs.vPositionW);var NdotV: f32=max(dot(vertexOutputs.vNormalW,viewDirectionW),0.0);var roughNormal: vec3f=mix(vertexOutputs.vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*uniforms.baseDiffuseRoughness);var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(roughNormal,0)).xyz;\n#else\nvar reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}\n#else\nvertexOutputs.position=scene.viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvertexOutputs.vClipSpacePosition=vertexOutputs.position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvertexOutputs.vViewDepth=(scene.view*worldPos).z;\n#endif\n#ifndef UV1\nvar uvUpdated: vec2f= vec2f(0.,0.);\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uvUpdated;\n#endif\n#ifndef UV2\nvar uv2Updated: vec2f= vec2f(0.,0.);\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStoreWGSL[n$1c]||(bt$1.ShadersStoreWGSL[n$1c]=i$U);const E$j={name:n$1c,shader:i$U};var pbr_vertexC4arN8R__esm_min=/*#__PURE__*/Object.freeze({__proto__:null,pbrVertexShaderWGSL:E$j});const t$Q="prePassDeclaration";bt$1.IncludesShadersStoreWGSL[t$Q]||(bt$1.IncludesShadersStoreWGSL[t$Q]="#ifdef PREPASS\n#ifdef PREPASS_LOCAL_POSITION\nvarying vPosition : vec3f;\n#endif\n#ifdef PREPASS_DEPTH\nvarying vViewPos: vec3f;\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\nvarying vNormViewDepth: f32;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nvarying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#endif\n");const r$1j="oitDeclaration";bt$1.IncludesShadersStoreWGSL[r$1j]||(bt$1.IncludesShadersStoreWGSL[r$1j]="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#define MAX_DEPTH 99999.0\nvar oitDepthSamplerSampler: sampler;var oitDepthSampler: texture_2d<f32>;var oitFrontColorSamplerSampler: sampler;var oitFrontColorSampler: texture_2d<f32>;\n#endif\n");const n$1b="depthPrePass";bt$1.IncludesShadersStoreWGSL[n$1b]||(bt$1.IncludesShadersStoreWGSL[n$1b]="#ifdef DEPTHPREPASS\nfragmentOutputs.color= vec4f(0.,0.,0.,1.0);return fragmentOutputs;\n#endif\n");const f$o="oitFragment";bt$1.IncludesShadersStoreWGSL[f$o]||(bt$1.IncludesShadersStoreWGSL[f$o]="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nvar fragDepth: f32=fragmentInputs.position.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nvar halfFloat: u32=pack2x16float( vec2f(fragDepth));var full: vec2f=unpack2x16float(halfFloat);fragDepth=full.x;\n#endif\nvar fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var lastDepth: vec2f=textureLoad(oitDepthSampler,fragCoord,0).rg;var lastFrontColor: vec4f=textureLoad(oitFrontColorSampler,fragCoord,0);fragmentOutputs.depth=vec2f(-MAX_DEPTH);fragmentOutputs.frontColor=lastFrontColor;fragmentOutputs.backColor= vec4f(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nvar furthestDepth: f32=-lastDepth.x;var nearestDepth: f32=lastDepth.y;\n#else\nvar nearestDepth: f32=-lastDepth.x;var furthestDepth: f32=lastDepth.y;\n#endif\nvar alphaMultiplier: f32=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn fragmentOutputs;}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\nfragmentOutputs.depth=vec2f(-fragDepth,fragDepth);return fragmentOutputs;}\n#endif\n");const n$1a="pbrFragmentExtraDeclaration";bt$1.IncludesShadersStoreWGSL[n$1a]||(bt$1.IncludesShadersStoreWGSL[n$1a]="varying vPositionW: vec3f;\n#if DEBUGMODE>0\nvarying vClipSpacePosition: vec4f;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vEnvironmentIrradiance: vec3f;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvarying vViewDepth: f32;\n#endif\n");const i$T="subSurfaceScatteringFunctions";bt$1.IncludesShadersStoreWGSL[i$T]||(bt$1.IncludesShadersStoreWGSL[i$T]="fn testLightingForSSS(diffusionProfile: f32)->bool\n{return diffusionProfile<1.;}");const t$P="pbrHelperFunctions";bt$1.IncludesShadersStoreWGSL[t$P]||(bt$1.IncludesShadersStoreWGSL[t$P]="#define MINIMUMVARIANCE 0.0005\nfn convertRoughnessToAverageSlope(roughness: f32)->f32\n{return roughness*roughness+MINIMUMVARIANCE;}\nfn fresnelGrazingReflectance(reflectance0: f32)->f32 {var reflectance90: f32=saturate(reflectance0*25.0);return reflectance90;}\nfn getAARoughnessFactors(normalVector: vec3f)->vec2f {\n#ifdef SPECULARAA\nvar nDfdx: vec3f=dpdx(normalVector.xyz);var nDfdy: vec3f=dpdy(normalVector.xyz);var slopeSquare: f32=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));var geometricRoughnessFactor: f32=pow(saturate(slopeSquare),0.333);var geometricAlphaGFactor: f32=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2f(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2f(0.);\n#endif\n}\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_LEGACY\nfn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}\nfn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var anisotropicFrameDirection: vec3f=select(T,B,anisotropy>=0.0);var anisotropicFrameTangent: vec3f=cross(normalize(anisotropicFrameDirection),V);var anisotropicFrameNormal: vec3f=cross(anisotropicFrameTangent,anisotropicFrameDirection);var anisotropicNormal: vec3f=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}\n#elif ANISOTROPIC_OPENPBR\nfn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=alphaG*sqrt(2.0/(1.0+(1.0-anisotropy)*(1.0-anisotropy)));var alphaB: f32=max(alphaT*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}\n#else\nfn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG,MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}\nfn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var bentNormal: vec3f=cross(B,V);bentNormal=normalize(cross(bentNormal,B));var sq=1.0-anisotropy*(1.0-roughness);var a: f32=sq*sq*sq*sq;bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}\n#endif\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nfn cocaLambertVec3(alpha: vec3f,distance: f32)->vec3f {return exp(-alpha*distance);}\nfn cocaLambert(NdotVRefract: f32,NdotLRefract: f32,alpha: vec3f,thickness: f32)->vec3f {return cocaLambertVec3(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}\nfn computeColorAtDistanceInMedia(color: vec3f,distance: f32)->vec3f {return -log(color)/distance;}\nfn computeClearCoatAbsorption(NdotVRefract: f32,NdotLRefract: f32,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var clearCoatAbsorption: vec3f=mix( vec3f(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);return clearCoatAbsorption;}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfn computeDefaultMicroSurface(microSurface: f32,reflectivityColor: vec3f)->f32\n{const kReflectivityNoAlphaWorkflow_SmoothnessMax: f32=0.95;var reflectivityLuminance: f32=getLuminance(reflectivityColor);var reflectivityLuma: f32=sqrt(reflectivityLuminance);var resultMicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return resultMicroSurface;}\n#endif\n");const f$n="pbrDirectLightingSetupFunctions";bt$1.IncludesShadersStoreWGSL[f$n]||(bt$1.IncludesShadersStoreWGSL[f$n]="struct preLightingInfo\n{lightOffset: vec3f,\nlightDistanceSquared: f32,\nlightDistance: f32,\nattenuation: f32,\nL: vec3f,\nH: vec3f,\nNdotV: f32,\nNdotLUnclamped: f32,\nNdotL: f32,\nVdotH: f32,\nLdotV: f32,\nroughness: f32,\ndiffuseRoughness: f32,\nsurfaceAlbedo: vec3f,\n#ifdef IRIDESCENCE\niridescenceIntensity: f32\n#endif\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nareaLightDiffuse: vec3f,\n#ifdef SPECULARTERM\nareaLightSpecular: vec3f,\nareaLightFresnel: vec4f\n#endif\n#endif\n};fn computePointAndSpotPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f,posW: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\nfn computeDirectionalPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=dot(result.L,V);return result;}\nfn computeHemisphericPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\nvar areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaPreLightingInfo(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightCenter:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->preLightingInfo {var result: preLightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightCenter,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nresult.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;\n#endif\nresult.areaLightDiffuse+=data.Diffuse;return result;}\n#endif\n");const r$1i="pbrDirectLightingFalloffFunctions";bt$1.IncludesShadersStoreWGSL[r$1i]||(bt$1.IncludesShadersStoreWGSL[r$1i]="fn computeDistanceLightFalloff_Standard(lightOffset: vec3f,range: f32)->f32\n{return max(0.,1.0-length(lightOffset)/range);}\nfn computeDistanceLightFalloff_Physical(lightDistanceSquared: f32)->f32\n{return 1.0/maxEps(lightDistanceSquared);}\nfn computeDistanceLightFalloff_GLTF(lightDistanceSquared: f32,inverseSquaredRange: f32)->f32\n{var lightDistanceFalloff: f32=1.0/maxEps(lightDistanceSquared);var factor: f32=lightDistanceSquared*inverseSquaredRange;var attenuation: f32=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}\nfn computeDirectionalLightFalloff_IES(lightDirection: vec3f,directionToLightCenterW: vec3f,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32\n{var cosAngle: f32=dot(-lightDirection,directionToLightCenterW);var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}\nfn computeDistanceLightFalloff(lightOffset: vec3f,lightDistanceSquared: f32,range: f32,inverseSquaredRange: f32)->f32\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfn computeDirectionalLightFalloff_Standard(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32)->f32\n{var falloff: f32=0.0;var cosAngle: f32=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)\n{falloff=max(0.,pow(cosAngle,exponent));}\nreturn falloff;}\nfn computeDirectionalLightFalloff_Physical(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32)->f32\n{const kMinusLog2ConeAngleIntensityRatio: f32=6.64385618977; \nvar concentrationKappa: f32=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);var lightDirectionSpreadSG: vec4f= vec4f(-lightDirection*concentrationKappa,-concentrationKappa);var falloff: f32=exp2(dot( vec4f(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}\nfn computeDirectionalLightFalloff_GLTF(lightDirection: vec3f,directionToLightCenterW: vec3f,lightAngleScale: f32,lightAngleOffset: f32)->f32\n{var cd: f32=dot(-lightDirection,directionToLightCenterW);var falloff: f32=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}\nfn computeDirectionalLightFalloff(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32,lightAngleScale: f32,lightAngleOffset: f32)->f32\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}");const o$T="pbrBlockReflectance0";bt$1.IncludesShadersStoreWGSL[o$T]||(bt$1.IncludesShadersStoreWGSL[o$T]="var reflectanceF0: f32=reflectivityOut.reflectanceF0;var specularEnvironmentR0: vec3f=reflectivityOut.colorReflectanceF0;var specularEnvironmentR90: vec3f= reflectivityOut.reflectanceF90;\n#ifdef ALPHAFRESNEL\nvar reflectance90: f32=fresnelGrazingReflectance(reflectanceF0);specularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n");const a$K="pbrDirectLightingFunctions";bt$1.IncludesShadersStoreWGSL[a$K]||(bt$1.IncludesShadersStoreWGSL[a$K]="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{diffuse: vec3f,\n#ifdef SS_TRANSLUCENCY\ndiffuseTransmission: vec3f,\n#endif\n#ifdef SPECULARTERM\nspecular: vec3f,\n#endif\n#ifdef CLEARCOAT\nclearCoat: vec4f,\n#endif\n#ifdef SHEEN\nsheen: vec3f\n#endif\n};fn adjustRoughnessFromLightProperties(roughness: f32,lightRadius: f32,lightDistance: f32)->f32 {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nvar lightRoughness: f32=lightRadius/lightDistance;var totalRoughness: f32=saturate(lightRoughness+roughness);return totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nfn computeHemisphericDiffuseLighting(info: preLightingInfo,lightColor: vec3f,groundColor: vec3f)->vec3f {return mix(groundColor,lightColor,info.NdotL);}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nfn computeAreaDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {return info.areaLightDiffuse*lightColor;}\n#endif\nfn computeDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {var diffuseTerm: vec3f=vec3f(1.0/PI);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY\ndiffuseTerm=vec3f(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\ndiffuseTerm=vec3f(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nvar clampedAlbedo: vec3f=clamp(info.surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;\n#endif\nreturn diffuseTerm*info.attenuation*info.NdotL*lightColor;}\nfn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f{var strq: vec4f=textureProjectionMatrix* vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return toLinearSpaceVec3(textureColor);}\n#ifdef SS_TRANSLUCENCY\nfn computeDiffuseTransmittedLighting(info: preLightingInfo,lightColor: vec3f,transmittance: vec3f)->vec3f {var transmittanceNdotL=vec3f(0.0);var NdotL: f32=absEps(info.NdotLUnclamped);\n#ifndef SS_TRANSLUCENCY_LEGACY\nif (info.NdotLUnclamped<0.0) {\n#endif\nvar wrapNdotL: f32=computeWrappedDiffuseNdotL(NdotL,0.02);var trAdapt: f32=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL, vec3f(wrapNdotL),trAdapt);\n#ifndef SS_TRANSLUCENCY_LEGACY\n}\nvar diffuseTerm : vec3f=vec3f(1.0/PI);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY\ndiffuseTerm=vec3f(diffuseBRDF_Burley(\ninfo.NdotL,info.NdotV,info.VdotH,info.roughness));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\ndiffuseTerm=vec3f(diffuseBRDF_Burley(\ninfo.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nvar clampedAlbedo: vec3f=clamp(info.surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,\ninfo.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;\n#endif\nreturn (transmittanceNdotL*diffuseTerm)*info.attenuation*lightColor;\n#else\nlet diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;\n#endif\n}\n#endif\n#ifdef SPECULARTERM\nfn computeSpecularLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,fresnel: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var modifiedFresnel: vec3f=fresnel;\n#ifdef IRIDESCENCE\nmodifiedFresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nvar distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar smithVisibility: f32=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nvar smithVisibility: f32=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvar specTerm: vec3f=modifiedFresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nfn computeAreaSpecularLighting(info: preLightingInfo,specularColor: vec3f,reflectance0: vec3f,reflectance90: vec3f)->vec3f {var fresnel:vec3f =reflectance0*specularColor*info.areaLightFresnel.x+( vec3f( 1.0 )-specularColor )*info.areaLightFresnel.y*reflectance90;return specularColor*fresnel*info.areaLightSpecular;}\n#endif\n#endif\n#ifdef FUZZ\nfn evalFuzz(L: vec3f,NdotL: f32,NdotV: f32,T: vec3f,B: vec3f,ltcLut: vec3f)->f32\n{if (NdotL<=0.0f || NdotV<=0.0f) {return 0.0f;}\nlet M=mat3x3f(\nvec3f(ltcLut.r,0.0f,0.0f),\nvec3f(ltcLut.g,1.0f,0.0f),\nvec3f(0.0f,0.0f,1.0f)\n);let Llocal: vec3f=vec3f(dot(L,T),dot(L,B),NdotL);let Lwarp: vec3f=normalize(M*Llocal);let cosThetaWarp: f32=max(Lwarp.z,0.0f);return cosThetaWarp*NdotL;}\n#endif\n#if defined(ANISOTROPIC) && defined(ANISOTROPIC_OPENPBR)\nfn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=vec3f(distribution*smithVisibility);return specTerm*info.attenuation*info.NdotL*lightColor;}\n#elif defined(ANISOTROPIC)\nfn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nvar distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef CLEARCOAT\nfn computeClearCoatLighting(info: preLightingInfo,Ncc: vec3f,geometricRoughnessFactor: f32,clearCoatIntensity: f32,lightColor: vec3f)->vec4f {var NccdotL: f32=saturateEps(dot(Ncc,info.L));var NccdotH: f32=saturateEps(dot(Ncc,info.H));var clearCoatRoughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);var fresnel: f32=fresnelSchlickGGX(info.VdotH,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);var kelemenVisibility: f32=visibility_Kelemen(info.VdotH);var clearCoatTerm: f32=fresnel*distribution*kelemenVisibility;return vec4f(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);}\nfn computeClearCoatLightingAbsorption(NdotVRefract: f32,L: vec3f,Ncc: vec3f,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var LRefract: vec3f=-refract(L,Ncc,uniforms.vClearCoatRefractionParams.y);var NdotLRefract: f32=saturateEps(dot(Ncc,LRefract));var absorption: vec3f=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}\n#endif\n#ifdef SHEEN\nfn computeSheenLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: f32=1.;var distribution: f32=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER\nvar visibility: f32=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nvar visibility: f32=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */\nvar sheenTerm: f32=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\n#include<clusteredLightingFunctions>\nfn computeClusteredLighting(\nlightDataTexture: texture_2d<f32>,\ntileMaskBuffer: ptr<storage,array<u32>>,\nlightData: vec4f,\nsliceRange: vec2u,\nV: vec3f,\nN: vec3f,\nposW: vec3f,\nsurfaceAlbedo: vec3f,\nreflectivityOut: reflectivityOutParams,\n#ifdef IRIDESCENCE\niridescenceIntensity: f32,\n#endif\n#ifdef SS_TRANSLUCENCY\nsubSurfaceOut: subSurfaceOutParams,\n#endif\n#ifdef SPECULARTERM\nAARoughnessFactor: f32,\n#endif\n#ifdef ANISOTROPIC\nanisotropicOut: anisotropicOutParams,\n#endif\n#ifdef SHEEN\nsheenOut: sheenOutParams,\n#endif\n#ifdef CLEARCOAT\nclearcoatOut: clearcoatOutParams,\n#endif\n)->lightingInfo {let NdotV=absEps(dot(N,V));\n#include<pbrBlockReflectance0>\n#ifdef CLEARCOAT\nspecularEnvironmentR0=clearcoatOut.specularEnvironmentR0;\n#endif\nvar result: lightingInfo;let tilePosition=vec2u(fragmentInputs.position.xy*lightData.xy);let maskResolution=vec2u(lightData.zw);var tileIndex=(tilePosition.x*maskResolution.x+tilePosition.y)*maskResolution.y;let batchRange=sliceRange/CLUSTLIGHT_BATCH;var batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tileIndex+=batchRange.x;for (var i=batchRange.x; i<=batchRange.y; i+=1) {var mask=tileMaskBuffer[tileIndex];tileIndex+=1;let maskOffset=max(sliceRange.x,batchOffset)-batchOffset; \nlet maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while mask != 0 {let trailing=firstTrailingBit(mask);mask ^= 1u<<trailing;let light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+trailing);var preInfo=computePointAndSpotPreLightingInfo(light.vLightData,V,N,posW);preInfo.NdotV=NdotV;preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light.vLightFalloff.x,light.vLightFalloff.y);if light.vLightDirection.w>=0.0 {preInfo.attenuation*=computeDirectionalLightFalloff(light.vLightDirection.xyz,preInfo.L,light.vLightDirection.w,light.vLightData.w,light.vLightFalloff.z,light.vLightFalloff.w);}\npreInfo.roughness=adjustRoughnessFromLightProperties(reflectivityOut.roughness,light.vLightSpecular.a,preInfo.lightDistance);preInfo.diffuseRoughness=reflectivityOut.diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\nvar info: lightingInfo;\n#ifdef SS_TRANSLUCENCY\n#ifdef SS_TRANSLUCENCY_LEGACY\ninfo.diffuse=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);info.diffuseTransmission=vec3(0);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);\n#endif\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb);\n#endif\n#ifdef SPECULARTERM\n#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR\nlet metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);let coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);\n#else\nlet coloredFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90);\n#endif\n#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION\nlet NdotH=dot(N,preInfo.H);let fresnel=fresnelSchlickGGXVec3(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);\n#endif\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,V,N,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,N,specularEnvironmentR0,coloredFresnel,AARoughnessFactor,light.vLightDiffuse.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);\n#endif\n#ifdef CLEARCOAT\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light.vLightSpecular.a,preInfo.lightDistance);info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light.vLightDiffuse.rgb);\n#ifdef CLEARCOAT_TINT\nlet absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission*=absorption;\n#endif\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission*=info.clearCoat.w;\n#endif\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\nresult.diffuse+=info.diffuse;\n#ifdef SS_TRANSLUCENCY\nresult.diffuseTransmission+=info.diffuseTransmission;\n#endif\n#ifdef SPECULARTERM\nresult.specular+=info.specular;\n#endif\n#ifdef CLEARCOAT\nresult.clearCoat+=info.clearCoat;\n#endif\n#ifdef SHEEN\nresult.sheen+=info.sheen;\n#endif\n}\nbatchOffset+=CLUSTLIGHT_BATCH;}\nreturn result;}\n#endif\n");const c$j="pbrIBLFunctions";bt$1.IncludesShadersStoreWGSL[c$j]||(bt$1.IncludesShadersStoreWGSL[c$j]="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfn getLodFromAlphaG(cubeMapDimensionPixels: f32,microsurfaceAverageSlope: f32)->f32 {var microsurfaceAverageSlopeTexels: f32=cubeMapDimensionPixels*microsurfaceAverageSlope;var lod: f32=log2(microsurfaceAverageSlopeTexels);return lod;}\nfn getLinearLodFromRoughness(cubeMapDimensionPixels: f32,roughness: f32)->f32 {var lod: f32=log2(cubeMapDimensionPixels)*roughness;return lod;}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfn environmentRadianceOcclusion(ambientOcclusion: f32,NdotVUnclamped: f32)->f32 {var temp: f32=NdotVUnclamped+ambientOcclusion;return saturate(temp*temp-1.0+ambientOcclusion);}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfn environmentHorizonOcclusion(view: vec3f,normal: vec3f,geometricNormal: vec3f)->f32 {var reflection: vec3f=reflect(view,normal);var temp: f32=saturate(1.0+1.1*dot(reflection,geometricNormal));return temp*temp;}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\nfn UNPACK_LOD(x: f32)->f32 {return (1.0-x)*255.0;}\nfn getLodFromAlphaGNdotV(cubeMapDimensionPixels: f32,alphaG: f32,NdotV: f32)->f32 {var microsurfaceAverageSlope: f32=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}\n#endif\n");const l$i="pbrBlockNormalGeometric";bt$1.IncludesShadersStoreWGSL[l$i]||(bt$1.IncludesShadersStoreWGSL[l$i]="var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);\n#ifdef NORMAL\nvar normalW: vec3f=normalize(input.vNormalW);\n#else\nvar normalW: vec3f=normalize(cross(dpdx(input.vPositionW),dpdy(input.vPositionW)))*scene.vEyePosition.w;\n#endif\nvar geometricNormalW: vec3f=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=select(-geometricNormalW,geometricNormalW,fragmentInputs.frontFacing);\n#endif\n");const s$l="pbrBlockImageProcessing";bt$1.IncludesShadersStoreWGSL[s$l]||(bt$1.IncludesShadersStoreWGSL[s$l]="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor=vec4f(clamp(finalColor.rgb,vec3f(0.),vec3f(30.0)),finalColor.a);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor=vec4f(finalColor.rgb,finalColor.a*mesh.visibility);\n#ifdef PREMULTIPLYALPHA\nfinalColor=vec4f(finalColor.rgb*finalColor.a,finalColor.a);;\n#endif\n");const d$m="pbrBlockPrePass";bt$1.IncludesShadersStoreWGSL[d$m]||(bt$1.IncludesShadersStoreWGSL[d$m]="#if SCENE_MRT_COUNT>0\nvar writeGeometryInfo: f32=select(0.0,1.0,finalColor.a>ALPHATESTVALUE);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;\n#ifdef PREPASS_POSITION\nfragData[PREPASS_POSITION_INDEX]= vec4f(fragmentInputs.vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nfragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvar a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvar velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -\n(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\nfragData[PREPASS_ALBEDO_INDEX]=vec4f(surfaceAlbedo,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvar sqAlbedo : vec3f=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvar irradiance : vec3f=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\n#ifdef PREPASS_COLOR\nfragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb-irradiance,finalColor.a); \n#endif\nirradiance/=sqAlbedo;fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo*uniforms.scatteringDiffusionProfile/255.); \n#else\n#ifdef PREPASS_COLOR\nfragData[PREPASS_COLOR_INDEX]=finalColor; \n#endif\nfragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo); \n#endif\n#elif defined(PREPASS_COLOR)\nfragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\nfragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\nfragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\nfragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4f(fragmentInputs.vNormViewDepth,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);\n#else\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\nfragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nfragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqAlbedo,writeGeometryInfo);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(0.0,0.0,0.0,1.0)*writeGeometryInfo;\n#endif\n#endif\n#if SCENE_MRT_COUNT>0\nfragmentOutputs.fragData0=fragData[0];\n#endif\n#if SCENE_MRT_COUNT>1\nfragmentOutputs.fragData1=fragData[1];\n#endif\n#if SCENE_MRT_COUNT>2\nfragmentOutputs.fragData2=fragData[2];\n#endif\n#if SCENE_MRT_COUNT>3\nfragmentOutputs.fragData3=fragData[3];\n#endif\n#if SCENE_MRT_COUNT>4\nfragmentOutputs.fragData4=fragData[4];\n#endif\n#if SCENE_MRT_COUNT>5\nfragmentOutputs.fragData5=fragData[5];\n#endif\n#if SCENE_MRT_COUNT>6\nfragmentOutputs.fragData6=fragData[6];\n#endif\n#if SCENE_MRT_COUNT>7\nfragmentOutputs.fragData7=fragData[7];\n#endif\n#endif\n");const u$j="pbrDebug";bt$1.IncludesShadersStoreWGSL[u$j]||(bt$1.IncludesShadersStoreWGSL[u$j]="#if DEBUGMODE>0\nif (input.vClipSpacePosition.x/input.vClipSpacePosition.w>=uniforms.vDebugMode.x) {var color: vec3f;\n#if DEBUGMODE==1\ncolor=fragmentInputs.vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ncolor=fragmentInputs.vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ncolor=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ncolor=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ncolor=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ncolor= vec3f(input.vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ncolor= vec3f(input.vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ncolor=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ncolor=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ncolor=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ncolor=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ncolor=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ncolor=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ncolor=albedoTexture.rgb;\n#ifndef GAMMAALBEDO\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==21 && defined(AMBIENT)\ncolor=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ncolor=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ncolor=emissiveColorTex.rgb;\n#ifndef GAMMAEMISSIVE\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ncolor=lightmapColor;\n#ifndef GAMMALIGHTMAP\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ncolor=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ncolor=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ncolor= vec3f(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ncolor=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ncolor=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ncolor=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ncolor=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==32 && defined(BUMP)\ncolor=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ncolor=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ncolor=reflectionOut.environmentRadiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ncolor=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ncolor=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ncolor=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ncolor=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ncolor=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ncolor=reflectionOut.environmentIrradiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==60\ncolor=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ncolor=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ncolor= vec3f(reflectivityOut.metallic);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ncolor=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ncolor= vec3f(roughness);\n#elif DEBUGMODE==64\ncolor= vec3f(alphaG);\n#elif DEBUGMODE==65\ncolor= vec3f(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ncolor=clearcoatOut.clearCoatColor;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ncolor= vec3f(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ncolor= vec3f(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ncolor=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ncolor=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==72\ncolor= vec3f(microSurface);\n#elif DEBUGMODE==73\ncolor=uniforms.vAlbedoColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)\ncolor=uniforms.vReflectivityColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==75\ncolor=uniforms.vEmissiveColor;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ncolor= vec3f(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\ncolor= vec3f(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ncolor= vec3f(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ncolor=baseSpecularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ncolor=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ncolor=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ncolor= vec3f(luminanceOverAlpha);\n#elif DEBUGMODE==87\ncolor= vec3f(alpha);\n#elif DEBUGMODE==88 && defined(ALBEDO)\ncolor= vec3f(albedoTexture.a);\n#elif DEBUGMODE==89\ncolor=aoOut.ambientOcclusionColor;\n#else\nvar stripeWidth: f32=30.;var stripePos: f32=abs(floor(input.position.x/stripeWidth));var whichColor: f32=((stripePos)%(2.));var color1: vec3f= vec3f(.6,.2,.2);var color2: vec3f= vec3f(.3,.1,.1);color=mix(color1,color2,whichColor);\n#endif\ncolor*=uniforms.vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ncolor=normalize(color)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ncolor=toGammaSpaceVec3(color);\n#endif\nfragmentOutputs.color=vec4f(color,1.0);\n#ifdef PREPASS\nfragmentOutputs.fragData0=toLinearSpaceVec3(color); \nfragmentOutputs.fragData1=vec4f(0.,0.,0.,0.); \n#endif\n#ifdef DEBUGMODE_FORCERETURN\nreturn fragmentOutputs;\n#endif\n}\n#endif\n");const n$19="samplerFragmentDeclaration";bt$1.IncludesShadersStoreWGSL[n$19]||(bt$1.IncludesShadersStoreWGSL[n$19]="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying v_VARYINGNAME_UV: vec2f;\n#endif\nvar _SAMPLERNAME_SamplerSampler: sampler;var _SAMPLERNAME_Sampler: texture_2d<f32>;\n#endif\n");const n$18="importanceSampling";bt$1.IncludesShadersStoreWGSL[n$18]||(bt$1.IncludesShadersStoreWGSL[n$18]="fn hemisphereCosSample(u: vec2f)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=1.-u.y;var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nfn hemisphereImportanceSampleDggx(u: vec2f,a: f32)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nfn hemisphereImportanceSampleDggxAnisotropic(Xi: vec2f,alphaTangent: f32,alphaBitangent: f32)->vec3f\n{let alphaT: f32=max(alphaTangent,0.0001);let alphaB: f32=max(alphaBitangent,0.0001);var phi: f32=atan(alphaB/alphaT*tan(2.0f*PI*Xi.x));if (Xi.x>0.5) {phi+=PI; }\nlet cosPhi: f32=cos(phi);let sinPhi: f32=sin(phi);let alpha2: f32=(cosPhi*cosPhi)/(alphaTangent*alphaTangent) +\n(sinPhi*sinPhi)/(alphaB*alphaB);let tanTheta2: f32=Xi.y/(1.0f-Xi.y)/alpha2;let cosTheta: f32=1.0f/sqrt(1.0f+tanTheta2);let sinTheta: f32=sqrt(max(0.0f,1.0f-cosTheta*cosTheta));return vec3f(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}\nfn hemisphereImportanceSampleDCharlie(u: vec2f,a: f32)->vec3f { \nvar phi: f32=2.*PI*u.x;var sinTheta: f32=pow(u.y,a/(2.*a+1.));var cosTheta: f32=sqrt(1.-sinTheta*sinTheta);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}");const a$J="hdrFilteringFunctions";bt$1.IncludesShadersStoreWGSL[a$J]||(bt$1.IncludesShadersStoreWGSL[a$J]="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\nfn radicalInverse_VdC(value: u32)->f32 \n{var bits=(value<<16u) | (value>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return f32(bits)*2.3283064365386963e-10; }\nfn hammersley(i: u32,N: u32)->vec2f\n{return vec2f( f32(i)/ f32(N),radicalInverse_VdC(i));}\nfn log4(x: f32)->f32 {return log2(x)/2.;}\nfn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nconst NUM_SAMPLES_FLOAT: f32= f32(NUM_SAMPLES);const NUM_SAMPLES_FLOAT_INVERSED: f32=1./NUM_SAMPLES_FLOAT;const K: f32=4.;fn irradiance(\n#ifdef CUSTOM_IRRADIANCE_FILTERING_INPUT\nCUSTOM_IRRADIANCE_FILTERING_INPUT\n#else\ninputTexture: texture_cube<f32>,inputSampler: sampler,\n#endif\ninputN: vec3f,\nfilteringInfo: vec2f,\ndiffuseRoughness: f32,\nsurfaceAlbedo: vec3f,\ninputV: vec3f\n#ifdef IBL_CDF_FILTERING\n,icdfSampler: texture_2d<f32>,icdfSamplerSampler: sampler\n#endif\n)->vec3f\n{var n: vec3f=normalize(inputN);var result: vec3f= vec3f(0.0);\n#ifndef IBL_CDF_FILTERING\nvar tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var tbnInverse: mat3x3f=transpose(tbn);\n#endif\nvar maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1),vec3f(1.0));for(var i: u32=0u; i<NUM_SAMPLES; i++)\n{var Xi: vec2f=hammersley(i,NUM_SAMPLES);\n#ifdef IBL_CDF_FILTERING\nvar T: vec2f;T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(T.x,Xi.y),0.0).y;var Ls: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var NoL: f32=dot(n,Ls);var NoV: f32=dot(n,inputV);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nvar LoV: f32=dot(Ls,inputV);\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\nvar H: vec3f=(inputV+Ls)*0.5;var VoH: f32=dot(inputV,H);\n#endif \n#else\nvar Ls: vec3f=hemisphereCosSample(Xi);Ls=normalize(Ls);var Ns: vec3f= vec3f(0.,0.,1.);var NoL: f32=dot(Ns,Ls);var V: vec3f=tbnInverse*inputV;var NoV: f32=dot(Ns,V);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nvar LoV: f32=dot(Ls,V);\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\nvar H: vec3f=(V+Ls)*0.5;var VoH: f32=dot(V,H);\n#endif\n#endif\nif (NoL>0.) {\n#ifdef IBL_CDF_FILTERING\nvar pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,Ls,0.0).rgb;\n#else\nvar pdf_inversed: f32=PI/NoL;var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0,maxLevel);\n#ifdef CUSTOM_IRRADIANCE_FILTERING_FUNCTION\nCUSTOM_IRRADIANCE_FILTERING_FUNCTION\n#else\nvar c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*Ls,mipLevel).rgb;\n#endif\n#endif\n#ifdef GAMMA_INPUT\nc=toLinearSpaceVec3(c);\n#endif\nvar diffuseRoughnessTerm: vec3f=vec3f(1.0);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\ndiffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\ndiffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);\n#endif\n#ifdef IBL_CDF_FILTERING\nvar light: vec3f=vec3f(0.0);if (pdf>1e-6) {light=vec3f(1.0)/vec3f(pdf)*c;}\nresult+=NoL*diffuseRoughnessTerm*light;\n#else\nresult+=c*diffuseRoughnessTerm;\n#endif\n}}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nresult=result/clampedAlbedo;\n#endif\nreturn result;}\nfn radiance(alphaG: f32,inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f\n{var n: vec3f=normalize(inputN);var c: vec3f=textureSample(inputTexture,inputSampler,n).rgb; \nif (alphaG==0.) {\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;} else {var result: vec3f= vec3f(0.);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var weight: f32=0.;for(var i: u32=0u; i<NUM_SAMPLES; i++)\n{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var H: vec3f=hemisphereImportanceSampleDggx(Xi,alphaG);var NoV: f32=1.;var NoH: f32=H.z;var NoH2: f32=H.z*H.z;var NoL: f32=2.*NoH2-1.;var L: vec3f= vec3f(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {var pdf_inversed: f32=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp( f32(l),0.0,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}}\n#ifdef ANISOTROPIC\nfn radianceAnisotropic(\nalphaTangent: f32, \nalphaBitangent: f32, \ninputTexture: texture_cube<f32>,\ninputSampler: sampler,\ninputView: vec3f, \ninputTangent: vec3f, \ninputBitangent: vec3f, \ninputNormal: vec3f, \nfilteringInfo: vec2f,\nnoiseInput: vec2f \n)->vec3f {var V: vec3f=inputView;var N: vec3f=inputNormal;var T: vec3f=inputTangent;var B: vec3f=inputBitangent;var R: vec3f=reflect(-V,N);var c: vec3f=textureSample(inputTexture,inputSampler,R).rgb;if (alphaTangent==0.f && alphaBitangent==0.f) {\n#if GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;}\nvar result: vec3f=vec3f(0.f);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var effectiveDim: f32=dim0*sqrt(alphaTangent*alphaBitangent);var omegaP: f32=(4.f*PI)/(6.f*effectiveDim*effectiveDim);let noiseScale: f32=clamp(log2(f32(NUM_SAMPLES))/12.0f,0.0f,1.0f);var weight: f32=0.f;for(var i: u32=0u; i<NUM_SAMPLES; i++)\n{var Xi: vec2f=hammersley(i,NUM_SAMPLES);Xi=fract(Xi+noiseInput*mix(0.5f,0.015f,noiseScale)); \nvar H_tangent: vec3f=hemisphereImportanceSampleDggxAnisotropic(Xi,alphaTangent,alphaBitangent);var H: vec3f=normalize(H_tangent.x*T+H_tangent.y*B+H_tangent.z*N);var L: vec3f=normalize(2.0f*dot(V,H)*H-V);var NoH: f32=max(dot(N,H),0.001f);var VoH: f32=max(dot(V,H),0.001f);var NoL: f32=max(dot(N,L),0.001f);if (NoL>0.f) {var pdf_inversed: f32=4./normalDistributionFunction_BurleyGGX_Anisotropic(\nH_tangent.z,H_tangent.x,H_tangent.y,vec2(alphaTangent,alphaBitangent)\n);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0f,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,L,mipLevel).rgb;\n#if GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}\n#endif\n#endif\n#endif\n");const e$j="bumpFragmentMainFunctions";bt$1.IncludesShadersStoreWGSL[e$j]||(bt$1.IncludesShadersStoreWGSL[e$j]="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f\n{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; \nvar a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; \nvar a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(\n(a11*b11-a12*b10+a13*b09)/det,\n(a02*b10-a01*b11-a03*b09)/det,\n(a31*b05-a32*b04+a33*b03)/det,\n(a22*b04-a21*b05-a23*b03)/det,\n(a12*b08-a10*b11-a13*b07)/det,\n(a00*b11-a02*b08+a03*b07)/det,\n(a32*b02-a30*b05-a33*b01)/det,\n(a20*b05-a22*b02+a23*b01)/det,\n(a10*b10-a11*b08+a13*b06)/det,\n(a01*b08-a00*b10-a03*b06)/det,\n(a30*b04-a31*b02+a33*b00)/det,\n(a21*b02-a20*b04-a23*b00)/det,\n(a11*b07-a10*b09-a12*b06)/det,\n(a00*b09-a01*b07+a02*b06)/det,\n(a31*b01-a30*b03-a32*b00)/det,\n(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\nfn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f\n{var output=normal;\n#ifdef NORMALXYSCALE\noutput=normalize(output* vec3f(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*output);}\nfn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nfn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f\n{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}\n#endif\n");const n$17="bumpFragmentFunctions";bt$1.IncludesShadersStoreWGSL[n$17]||(bt$1.IncludesShadersStoreWGSL[n$17]="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)\n{currSampledHeight=textureSample(bumpSampler,bumpSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nfn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f\n{var height: f32=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n");const r$1h="bumpFragment";bt$1.IncludesShadersStoreWGSL[r$1h]||(bt$1.IncludesShadersStoreWGSL[r$1h]="var uvOffset: vec2f= vec2f(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nvar normalScale: f32=1.0;\n#elif defined(BUMP)\nvar normalScale: f32=uniforms.vBumpInfos.y;\n#else\nvar normalScale: f32=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nvar TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); \n#elif defined(BUMP)\nvar TBNUV: vec2f=select(-fragmentInputs.vBumpUV,fragmentInputs.vBumpUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);\n#else\nvar TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvar TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); \n#else\nvar TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nvar invTBN: mat3x3f=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,fragmentInputs.vBumpUV,uniforms.vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,uniforms.vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvar detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz,uniforms.vBumpInfos.y);\n#else\nvar bumpNormal: vec3f=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);bumpNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,uniforms.vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);\n#endif\n");const a$I="decalFragment";bt$1.IncludesShadersStoreWGSL[a$I]||(bt$1.IncludesShadersStoreWGSL[a$I]="#ifdef DECAL\nvar decalTempColor=decalColor.rgb;var decalTempAlpha=decalColor.a;\n#ifdef GAMMADECAL\ndecalTempColor=toLinearSpaceVec3(decalColor.rgb);\n#endif\n#ifdef DECAL_SMOOTHALPHA\ndecalTempAlpha=decalColor.a*decalColor.a;\n#endif\nsurfaceAlbedo=mix(surfaceAlbedo.rgb,decalTempColor,decalTempAlpha);\n#endif\n");const n$16="samplerFragmentAlternateDeclaration";bt$1.IncludesShadersStoreWGSL[n$16]||(bt$1.IncludesShadersStoreWGSL[n$16]="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying v_VARYINGNAME_UV: vec2f;\n#endif\n#endif\n");const i$S="pbrFragmentSamplersDeclaration";bt$1.IncludesShadersStoreWGSL[i$S]||(bt$1.IncludesShadersStoreWGSL[i$S]="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nvar clearCoatRoughnessSamplerSampler: sampler;var clearCoatRoughnessSampler: texture_2d<f32>;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)\nvar sheenRoughnessSamplerSampler: sampler;var sheenRoughnessSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;\n#endif\n#ifdef USEIRRADIANCEMAP\nvar irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;\n#endif\n#else\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;\n#endif\n#ifdef USEIRRADIANCEMAP\nvar irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nvar environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\nvar refractionSamplerSampler: sampler;var refractionSampler: texture_cube<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_cube<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_cube<f32>;\n#endif\n#else\nvar refractionSamplerSampler: sampler;var refractionSampler: texture_2d<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_2d<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_2d<f32>;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)\n#endif\n#ifdef IBL_CDF_FILTERING\nvar icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;\n#endif\n");const a$H="pbrBlockAlbedoOpacity";bt$1.IncludesShadersStoreWGSL[a$H]||(bt$1.IncludesShadersStoreWGSL[a$H]="struct albedoOpacityOutParams\n{surfaceAlbedo: vec3f,\nalpha: f32};\n#define pbr_inline\nfn albedoOpacityBlock(\nvAlbedoColor: vec4f\n#ifdef ALBEDO\n,albedoTexture: vec4f\n,albedoInfos: vec2f\n#endif\n,baseWeight: f32\n#ifdef BASE_WEIGHT\n,baseWeightTexture: vec4f\n,vBaseWeightInfos: vec2f\n#endif\n#ifdef OPACITY\n,opacityMap: vec4f\n,vOpacityInfos: vec2f\n#endif\n#ifdef DETAIL\n,detailColor: vec4f\n,vDetailInfos: vec4f\n#endif\n#ifdef DECAL\n,decalColor: vec4f\n,vDecalInfos: vec4f\n#endif\n)->albedoOpacityOutParams\n{var outParams: albedoOpacityOutParams;var surfaceAlbedo: vec3f=vAlbedoColor.rgb;var alpha: f32=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpaceVec3(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#ifndef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=fragmentInputs.vColor.rgb;\n#endif\n#ifdef DETAIL\nvar detailAlbedo: f32=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#ifdef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\nsurfaceAlbedo*=baseWeight;\n#ifdef BASE_WEIGHT\nsurfaceAlbedo*=baseWeightTexture.r;\n#endif\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=fragmentInputs.vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE) {discard;}\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}\n");const r$1g="pbrBlockReflectivity";bt$1.IncludesShadersStoreWGSL[r$1g]||(bt$1.IncludesShadersStoreWGSL[r$1g]="struct reflectivityOutParams\n{microSurface: f32,\nroughness: f32,\ndiffuseRoughness: f32,\nreflectanceF0: f32,\nreflectanceF90: vec3f,\ncolorReflectanceF0: vec3f,\ncolorReflectanceF90: vec3f,\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo: vec3f,\nmetallic: f32,\nspecularWeight: f32,\ndielectricColorF0: vec3f,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nambientOcclusionColor: vec3f,\n#endif\n#if DEBUGMODE>0\n#ifdef METALLICWORKFLOW\n#ifdef REFLECTIVITY\nsurfaceMetallicColorMap: vec4f,\n#endif\nmetallicF0: vec3f,\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColorMap: vec4f,\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nfn reflectivityBlock(\nreflectivityColor: vec4f\n#ifdef METALLICWORKFLOW\n,surfaceAlbedo: vec3f\n,metallicReflectanceFactors: vec4f\n#endif\n,baseDiffuseRoughness: f32\n#ifdef BASE_DIFFUSE_ROUGHNESS\n,baseDiffuseRoughnessTexture: f32\n,baseDiffuseRoughnessInfos: vec2f\n#endif\n#ifdef REFLECTIVITY\n,reflectivityInfos: vec3f\n,surfaceMetallicOrReflectivityColorMap: vec4f\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,ambientOcclusionColorIn: vec3f\n#endif\n#ifdef MICROSURFACEMAP\n,microSurfaceTexel: vec4f\n#endif\n#ifdef DETAIL\n,detailColor: vec4f\n,vDetailInfos: vec4f\n#endif\n)->reflectivityOutParams\n{var outParams: reflectivityOutParams;var microSurface: f32=reflectivityColor.a;var surfaceReflectivityColor: vec3f=reflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvar metallicRoughness: vec2f=surfaceReflectivityColor.rg;var ior: f32=surfaceReflectivityColor.b;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvar aoStoreInMetalMap: vec3f= vec3f(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nvar detailRoughness: f32=mix(0.5,detailColor.b,vDetailInfos.w);var loLerp: f32=mix(0.,metallicRoughness.g,detailRoughness*2.);var hiLerp: f32=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;var baseColor: vec3f=surfaceAlbedo;outParams.metallic=metallicRoughness.r;outParams.specularWeight=metallicReflectanceFactors.a;var dielectricF0 : f32=reflectivityColor.a*outParams.specularWeight;surfaceReflectivityColor=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=dielectricF0*surfaceReflectivityColor;\n#endif\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\noutParams.surfaceAlbedo=baseColor.rgb*(vec3f(1.0)-vec3f(dielectricF0)*surfaceReflectivityColor)*(1.0-outParams.metallic);\n#else\noutParams.surfaceAlbedo=baseColor.rgb;\n#endif\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\n{let reflectivityColor: vec3f=mix(dielectricF0*surfaceReflectivityColor,baseColor.rgb,outParams.metallic);outParams.reflectanceF0=max(reflectivityColor.r,max(reflectivityColor.g,reflectivityColor.b));}\n#else\n#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF\nlet maxF0: f32=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF0=mix(dielectricF0*maxF0,1.0f,outParams.metallic);\n#else\noutParams.reflectanceF0=mix(dielectricF0,1.0,outParams.metallic);\n#endif\n#endif\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\noutParams.reflectanceF90=vec3(outParams.specularWeight);var f90Scale: f32=1.0;\n#else\nvar f90Scale: f32=clamp(2.0*(ior-1.0),0.0,1.0);outParams.reflectanceF90=vec3(mix(\noutParams.specularWeight*f90Scale,1.0,outParams.metallic));\n#endif\noutParams.dielectricColorF0=vec3f(dielectricF0*surfaceReflectivityColor);var metallicColorF0: vec3f=baseColor.rgb;outParams.colorReflectanceF0=mix(outParams.dielectricColorF0,metallicColorF0,outParams.metallic);\n#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)\nlet dielectricColorF90\n: vec3f=surfaceReflectivityColor *\nvec3f(outParams.specularWeight*f90Scale);\n#else\nlet dielectricColorF90\n: vec3f=vec3f(outParams.specularWeight*f90Scale);\n#endif\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\nlet conductorColorF90: vec3f=surfaceReflectivityColor;\n#else\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\nlet conductorColorF90: vec3f=outParams.reflectanceF90;\n#else\nlet conductorColorF90: vec3f=vec3f(1.0f);\n#endif\n#endif\noutParams.colorReflectanceF90=mix(dielectricColorF90,conductorColorF90,outParams.metallic);\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\noutParams.colorReflectanceF0=surfaceReflectivityColor;outParams.reflectanceF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF90=vec3f(1.0);\n#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)\noutParams.colorReflectanceF90=surfaceReflectivityColor;\n#else\noutParams.colorReflectanceF90=vec3(1.0);\n#endif\n#endif\nmicroSurface=saturate(microSurface);var roughness: f32=1.-microSurface;var diffuseRoughness: f32=baseDiffuseRoughness;\n#ifdef BASE_DIFFUSE_ROUGHNESS\ndiffuseRoughness*=baseDiffuseRoughnessTexture*baseDiffuseRoughnessInfos.y;\n#endif\noutParams.microSurface=microSurface;outParams.roughness=roughness;outParams.diffuseRoughness=diffuseRoughness;return outParams;}\n");const f$m="pbrBlockAmbientOcclusion";bt$1.IncludesShadersStoreWGSL[f$m]||(bt$1.IncludesShadersStoreWGSL[f$m]="struct ambientOcclusionOutParams\n{ambientOcclusionColor: vec3f,\n#if DEBUGMODE>0 && defined(AMBIENT)\nambientOcclusionColorMap: vec3f\n#endif\n};\n#define pbr_inline\nfn ambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap_: vec3f,\nvAmbientInfos: vec4f\n#endif\n)->ambientOcclusionOutParams\n{ \nvar outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);\n#ifdef AMBIENT\nvar ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}\n");const o$S="pbrBlockAlphaFresnel";bt$1.IncludesShadersStoreWGSL[o$S]||(bt$1.IncludesShadersStoreWGSL[o$S]="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{alpha: f32};fn faceforward(N: vec3<f32>,I: vec3<f32>,Nref: vec3<f32>)->vec3<f32> {return select(N,-N,dot(Nref,I)>0.0);}\n#define pbr_inline\nfn alphaFresnelBlock(\nnormalW: vec3f,\nviewDirectionW: vec3f,\nalpha: f32,\nmicroSurface: f32\n)->alphaFresnelOutParams\n{var outParams: alphaFresnelOutParams;var opacityPerceptual: f32=alpha;\n#ifdef LINEARALPHAFRESNEL\nvar opacity0: f32=opacityPerceptual;\n#else\nvar opacity0: f32=opacityPerceptual*opacityPerceptual;\n#endif\nvar opacity90: f32=fresnelGrazingReflectance(opacity0);var normalForward: vec3f=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)), vec3f(opacity0), vec3f(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE) {discard;}\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\nreturn outParams;}\n#endif\n#endif\n");const t$O="pbrBlockAnisotropic";bt$1.IncludesShadersStoreWGSL[t$O]||(bt$1.IncludesShadersStoreWGSL[t$O]="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{anisotropy: f32,\nanisotropicTangent: vec3f,\nanisotropicBitangent: vec3f,\nanisotropicNormal: vec3f,\n#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)\nanisotropyMapData: vec3f\n#endif\n};\n#define pbr_inline\nfn anisotropicBlock(\nvAnisotropy: vec3f,\nroughness: f32,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData: vec3f,\n#endif\nTBN: mat3x3f,\nnormalW: vec3f,\nviewDirectionW: vec3f\n)->anisotropicOutParams\n{ \nvar outParams: anisotropicOutParams;var anisotropy: f32=vAnisotropy.b;var anisotropyDirection: vec3f= vec3f(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nvar amd=anisotropyMapData.rg;anisotropy*=anisotropyMapData.b;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\namd=amd*2.0-1.0;\n#ifdef ANISOTROPIC_LEGACY\nanisotropyDirection=vec3f(anisotropyDirection.xy*amd,anisotropyDirection.z);\n#else\nanisotropyDirection=vec3f(mat2x2f(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(amd),anisotropyDirection.z);\n#endif\n#endif\nvar anisoTBN: mat3x3f= mat3x3f(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));var anisotropicTangent: vec3f=normalize(anisoTBN*anisotropyDirection);var anisotropicBitangent: vec3f=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}\n#endif\n");const c$i="pbrBlockReflection";bt$1.IncludesShadersStoreWGSL[c$i]||(bt$1.IncludesShadersStoreWGSL[c$i]="#ifdef REFLECTION\nstruct reflectionOutParams\n{environmentRadiance: vec4f\n,environmentIrradiance: vec3f\n#ifdef REFLECTIONMAP_3D\n,reflectionCoords: vec3f\n#else\n,reflectionCoords: vec2f\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,irradianceVector: vec3f\n#endif\n#endif\n#endif\n};\n#define pbr_inline\n#ifdef REFLECTIONMAP_3D\nfn createReflectionCoords(\nvPositionW: vec3f,\nnormalW: vec3f,\n#ifdef ANISOTROPIC\nanisotropicOut: anisotropicOutParams,\n#endif\n)->vec3f\n{var reflectionCoords: vec3f;\n#else\nfn createReflectionCoords(\nvPositionW: vec3f,\nnormalW: vec3f,\n#ifdef ANISOTROPIC\nanisotropicOut: anisotropicOutParams,\n#endif\n)->vec2f\n{ \nvar reflectionCoords: vec2f;\n#endif\n#ifdef ANISOTROPIC\nvar reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvar reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\nreturn reflectionCoords;}\n#define pbr_inline\nfn sampleReflectionTexture(\nalphaG: f32\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped: f32\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness: f32\n#endif\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec3f\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec2f\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler\n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler\n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler\n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#endif \n)->vec4f\n{var environmentRadiance: vec4f;\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nvar reflectionLOD: f32=getLodFromAlphaGNdotV(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nvar reflectionLOD: f32=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nvar reflectionLOD: f32=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nvar automaticReflectionLOD: f32=UNPACK_LOD(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords).a);var requestedReflectionLOD: f32=max(automaticReflectionLOD,reflectionLOD);\n#else\nvar requestedReflectionLOD: f32=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance= vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nvar lodReflectionNormalized: f32=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var environmentMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(\ntextureSample(reflectionHighSampler,reflectionHighSamplerSampler,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);} else {environmentRadiance=mix(\nenvironmentMid,\ntextureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\nvar envRadiance=environmentRadiance.rgb;\n#ifdef RGBDREFLECTION\nenvRadiance=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvRadiance=toLinearSpaceVec3(environmentRadiance.rgb);\n#endif\nenvRadiance*=vReflectionInfos.x;envRadiance*=vReflectionColor.rgb;return vec4f(envRadiance,environmentRadiance.a);}\n#define pbr_inline\nfn reflectionBlock(\nvPositionW: vec3f\n,normalW: vec3f\n,alphaG: f32\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n#ifdef ANISOTROPIC\n,anisotropicOut: anisotropicOutParams\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped: f32\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness: f32\n#endif\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,vEnvironmentIrradiance: vec3f\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,reflectionMatrix: mat4x4f\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,irradianceSampler: texture_cube<f32>\n,irradianceSamplerSampler: sampler \n#else\n,irradianceSampler: texture_2d<f32>\n,irradianceSamplerSampler: sampler \n#endif\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\n,reflectionDominantDirection: vec3f\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler \n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#ifdef IBL_CDF_FILTERING\n,icdfSampler: texture_2d<f32>\n,icdfSamplerSampler: sampler\n#endif\n#endif\n,viewDirectionW: vec3f\n,diffuseRoughness: f32\n,surfaceAlbedo: vec3f\n)->reflectionOutParams\n{var outParams: reflectionOutParams;var environmentRadiance: vec4f= vec4f(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvar reflectionCoords: vec3f= vec3f(0.);\n#else\nvar reflectionCoords: vec2f= vec2f(0.);\n#endif\nreflectionCoords=createReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif \n);environmentRadiance=sampleReflectionTexture(\nalphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness\n#endif\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#else\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#endif\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif \n);var environmentIrradiance: vec3f= vec3f(0.,0.,0.);\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n#ifdef ANISOTROPIC\nvar irradianceVector: vec3f= (reflectionMatrix* vec4f(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvar irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;\n#endif\nvar irradianceView: vec3f= (reflectionMatrix* vec4f(viewDirectionW,0)).xyz;\n#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)\n#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY\nvar NdotV: f32=max(dot(normalW,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);\n#endif\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvar environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,irradianceVector);\n#else\nvar environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);\n#endif\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\nvar Ls: vec3f=normalize(reflectionDominantDirection);var NoL: f32=dot(irradianceVector,Ls);var NoV: f32=dot(irradianceVector,irradianceView);var diffuseRoughnessTerm: vec3f=vec3f(1.0);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nvar LoV: f32=dot(Ls,irradianceView);var mag: f32=length(reflectionDominantDirection)*2.0f;var clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3f(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0f)));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\nvar H: vec3f=(irradianceView+Ls)*0.5f;var VoH: f32=dot(irradianceView,H);diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);\n#endif\nenvironmentIrradiance=environmentIrradiance4.rgb*diffuseRoughnessTerm;\n#else\nenvironmentIrradiance=environmentIrradiance4.rgb;\n#endif\n#ifdef RGBDREFLECTION\nenvironmentIrradiance=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance=toLinearSpaceVec3(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb*vReflectionInfos.x;\n#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE\noutParams.environmentRadiance=vec4f(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);\n#else\noutParams.environmentRadiance=environmentRadiance;\n#endif\noutParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}\n#endif\n");const l$h="pbrBlockSheen";bt$1.IncludesShadersStoreWGSL[l$h]||(bt$1.IncludesShadersStoreWGSL[l$h]="#ifdef SHEEN\nstruct sheenOutParams\n{sheenIntensity: f32\n,sheenColor: vec3f\n,sheenRoughness: f32\n#ifdef SHEEN_LINKWITHALBEDO\n,surfaceAlbedo: vec3f\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\n,sheenAlbedoScaling: f32\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,finalSheenRadianceScaled: vec3f\n#endif\n#if DEBUGMODE>0\n#ifdef SHEEN_TEXTURE\n,sheenMapData: vec4f\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,sheenEnvironmentReflectance: vec3f\n#endif\n#endif\n};\n#define pbr_inline\nfn sheenBlock(\nvSheenColor: vec4f\n#ifdef SHEEN_ROUGHNESS\n,vSheenRoughness: f32\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,sheenMapRoughnessData: vec4f\n#endif\n#endif\n,roughness: f32\n#ifdef SHEEN_TEXTURE\n,sheenMapData: vec4f\n,sheenMapLevel: f32\n#endif\n,reflectance: f32\n#ifdef SHEEN_LINKWITHALBEDO\n,baseColor: vec3f\n,surfaceAlbedo: vec3f\n#endif\n#ifdef ENVIRONMENTBRDF\n,NdotV: f32\n,environmentBrdf: vec3f\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,AARoughnessFactors: vec2f\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n,vLightingIntensity: vec4f\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec3f\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec2f\n#endif\n,NdotVUnclamped: f32\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler \n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,seo: f32\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,eho: f32\n#endif\n#endif\n)->sheenOutParams\n{var outParams: sheenOutParams;var sheenIntensity: f32=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nvar sheenFactor: f32=pow5(1.0-sheenIntensity);var sheenColor: vec3f=baseColor.rgb*(1.0-sheenFactor);var sheenRoughness: f32=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvar sheenColor: vec3f=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor*=toLinearSpaceVec3(sheenMapData.rgb);\n#else\nsheenColor*=sheenMapData.rgb;\n#endif\nsheenColor*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nvar sheenRoughness: f32=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#else\nvar sheenRoughness: f32=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvar environmentSheenBrdf: vec3f= vec3f(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvar environmentSheenBrdf: vec3f=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvar environmentSheenBrdf: vec3f=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvar sheenAlphaG: f32=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvar environmentSheenRadiance: vec4f= vec4f(0.,0.,0.,0.);environmentSheenRadiance=sampleReflectionTexture(\nsheenAlphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,sheenRoughness\n#endif\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n);var sheenEnvironmentReflectance: vec3f=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}\n#endif\n");const d$l="pbrBlockClearcoat";bt$1.IncludesShadersStoreWGSL[d$l]||(bt$1.IncludesShadersStoreWGSL[d$l]="struct clearcoatOutParams\n{specularEnvironmentR0: vec3f,\nconservationFactor: f32,\nclearCoatNormalW: vec3f,\nclearCoatAARoughnessFactors: vec2f,\nclearCoatIntensity: f32,\nclearCoatRoughness: f32,\n#ifdef REFLECTION\nfinalClearCoatRadianceScaled: vec3f,\n#endif\n#ifdef CLEARCOAT_TINT\nabsorption: vec3f,\nclearCoatNdotVRefract: f32,\nclearCoatColor: vec3f,\nclearCoatThickness: f32,\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nenergyConservationFactorClearCoat: vec3f,\n#endif\n#if DEBUGMODE>0\n#ifdef CLEARCOAT_BUMP\nTBNClearCoat: mat3x3f,\n#endif\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData: vec2f,\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nclearCoatTintMapData: vec4f,\n#endif\n#ifdef REFLECTION\nenvironmentClearCoatRadiance: vec4f,\nclearCoatEnvironmentReflectance: vec3f,\n#endif\nclearCoatNdotV: f32\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\nfn clearcoatBlock(\nvPositionW: vec3f\n,geometricNormalW: vec3f\n,viewDirectionW: vec3f\n,vClearCoatParams: vec2f\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,clearCoatMapRoughnessData: vec4f\n#endif\n,specularEnvironmentR0: vec3f\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData: vec2f\n#endif\n#ifdef CLEARCOAT_TINT\n,vClearCoatTintParams: vec4f\n,clearCoatColorAtDistance: f32\n,vClearCoatRefractionParams: vec4f\n#ifdef CLEARCOAT_TINT_TEXTURE\n,clearCoatTintMapData: vec4f\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,vClearCoatBumpInfos: vec2f\n,clearCoatBumpMapData: vec4f\n,vClearCoatBumpUV: vec2f\n#if defined(TANGENT) && defined(NORMAL)\n,vTBN: mat3x3f\n#else\n,vClearCoatTangentSpaceParams: vec2f\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,normalMatrix: mat4x4f\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,faceNormal: vec3f\n#endif\n#ifdef REFLECTION\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n,vLightingIntensity: vec4f\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler \n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,frontFacingMultiplier: f32\n#endif \n)->clearcoatOutParams\n{var outParams: clearcoatOutParams;var clearCoatIntensity: f32=vClearCoatParams.x;var clearCoatRoughness: f32=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvar clearCoatColor: vec3f=vClearCoatTintParams.rgb;var clearCoatThickness: f32=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpaceVec3(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvar specularEnvironmentR0Updated: vec3f=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvar specularEnvironmentR0Updated: vec3f=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);var clearCoatNormalW: vec3f=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nvar clearCoatNormalScale: f32=1.0;\n#else\nvar clearCoatNormalScale: f32=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nvar TBNClearCoat: mat3x3f=vTBN;\n#else\nvar TBNClearCoatUV: vec2f=vClearCoatBumpUV*frontFacingMultiplier;var TBNClearCoat: mat3x3f=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize( mat3x3f(normalMatrix[0].xyz,normalMatrix[1].xyz,normalMatrix[2].xyz)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);var clearCoatNdotVUnclamped: f32=dot(clearCoatNormalW,viewDirectionW);var clearCoatNdotV: f32=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvar clearCoatVRefract: vec3f=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvar environmentClearCoatBrdf: vec3f=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nvar clearCoatAlphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvar environmentClearCoatRadiance: vec4f= vec4f(0.,0.,0.,0.);var clearCoatReflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvar clearCoatReflectionCoords: vec3f=clearCoatReflectionVector;\n#else\nvar clearCoatReflectionCoords: vec2f=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nenvironmentClearCoatRadiance=sampleReflectionTexture(\nclearCoatAlphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,clearCoatNdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,clearCoatRoughness\n#endif\n,reflectionSampler\n,reflectionSamplerSampler\n,clearCoatReflectionCoords\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif \n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvar clearCoatEnvironmentReflectance: vec3f=getReflectanceFromBRDFLookup(vec3f(uniforms.vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nvar clearCoatEho: f32=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvar clearCoatEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV, vec3f(1.), vec3f(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nvar fresnelIBLClearCoat: f32=fresnelSchlickGGX(clearCoatNdotV,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\nreturn outParams;}\n#endif\n");const s$k="pbrBlockIridescence";bt$1.IncludesShadersStoreWGSL[s$k]||(bt$1.IncludesShadersStoreWGSL[s$k]="struct iridescenceOutParams\n{iridescenceIntensity: f32,\niridescenceIOR: f32,\niridescenceThickness: f32,\nspecularEnvironmentR0: vec3f};\n#ifdef IRIDESCENCE\nfn iridescenceBlock(\nvIridescenceParams: vec4f\n,viewAngle_: f32\n,specularEnvironmentR0: vec3f\n#ifdef IRIDESCENCE_TEXTURE\n,iridescenceMapData: vec2f\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,iridescenceThicknessMapData: vec2f\n#endif\n#ifdef CLEARCOAT\n,NdotVUnclamped: f32\n,vClearCoatParams: vec2f\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData: vec2f\n#endif\n#endif\n)->iridescenceOutParams\n{var outParams: iridescenceOutParams;var iridescenceIntensity: f32=vIridescenceParams.x;var iridescenceIOR: f32=vIridescenceParams.y;var iridescenceThicknessMin: f32=vIridescenceParams.z;var iridescenceThicknessMax: f32=vIridescenceParams.w;var iridescenceThicknessWeight: f32=1.;var viewAngle=viewAngle_;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nvar iridescenceThickness: f32=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);var topIor: f32=1.; \n#ifdef CLEARCOAT\nvar clearCoatIntensity: f32=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,uniforms.vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+((1.0/topIor)*(1.0/topIor))*((NdotVUnclamped*NdotVUnclamped)-1.0));\n#endif\nvar iridescenceFresnel: vec3f=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}\n#endif\n");const E$i="pbrBlockSubSurface";bt$1.IncludesShadersStoreWGSL[E$i]||(bt$1.IncludesShadersStoreWGSL[E$i]="struct subSurfaceOutParams\n{specularEnvironmentReflectance: vec3f,\n#ifdef SS_REFRACTION\nfinalRefraction: vec3f,\nsurfaceAlbedo: vec3f,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha: f32,\n#endif\nrefractionOpacity: f32,\n#endif\n#ifdef SS_TRANSLUCENCY\ntransmittance: vec3f,\ntranslucencyIntensity: f32,\n#ifdef REFLECTION\nrefractionIrradiance: vec3f,\n#endif\n#endif\n#if DEBUGMODE>0\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nthicknessMap: vec4f,\n#endif\n#ifdef SS_REFRACTION\nenvironmentRefraction: vec4f,\nrefractionTransmittance: vec3f\n#endif\n#endif\n};\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#define pbr_inline\nfn sampleEnvironmentRefraction(\nior: f32\n,thickness: f32\n,refractionLOD: f32\n,normalW: vec3f\n,vPositionW: vec3f\n,viewDirectionW: vec3f\n,view: mat4x4f\n,vRefractionInfos: vec4f\n,refractionMatrix: mat4x4f\n,vRefractionMicrosurfaceInfos: vec4f\n,alphaG: f32\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler: texture_cube<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_cube<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_cube<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#else\n,refractionSampler: texture_2d<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_2d<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_2d<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut: anisotropicOutParams\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo: vec2f\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition: vec3f\n,refractionSize: vec3f\n#endif\n)->vec4f {var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvar refractionVector: vec3f=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);\n#else\nvar refractionVector: vec3f=refract(-viewDirectionW,normalW,ior);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;var refractionCoords: vec3f=refractionVector;refractionCoords= (refractionMatrix* vec4f(refractionCoords,0)).xyz;\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvar vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*thickness,1.0))).xyz;\n#else\nvar vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*vRefractionInfos.z,1.0))).xyz;\n#endif\nvar refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODBASEDMICROSFURACE\nvar lod=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nvar automaticRefractionLOD: f32=UNPACK_LOD(textureSample(refractionSampler,refractionSamplerSampler,refractionCoords).a);var requestedRefractionLOD: f32=max(automaticRefractionLOD,lod);\n#else\nvar requestedRefractionLOD: f32=lod;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction= vec4f(radiance(alphaG,refractionSampler,refractionSamplerSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=textureSampleLevel(refractionSampler,refractionSamplerSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nvar lodRefractionNormalized: f32=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));var lodRefractionNormalizedDoubled: f32=lodRefractionNormalized*2.0;var environmentRefractionMid: vec4f=textureSample(refractionSampler,refractionSamplerSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(\ntextureSample(refractionHighSampler,refractionHighSamplerSampler,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);} else {environmentRefraction=mix(\nenvironmentRefractionMid,\ntextureSample(refractionLowSampler,refractionLowSamplerSampler,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);}\n#endif\nvar refraction=environmentRefraction.rgb;\n#ifdef SS_RGBDREFRACTION\nrefraction=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nrefraction=toLinearSpaceVec3(environmentRefraction.rgb);\n#endif\nreturn vec4f(refraction,environmentRefraction.a);}\n#endif\n#define pbr_inline\nfn subSurfaceBlock(\nvSubSurfaceIntensity: vec3f\n,vThicknessParam: vec2f\n,vTintColor: vec4f\n,normalW: vec3f\n,specularEnvironmentReflectance: vec3f\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,thicknessMap: vec4f\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,refractionIntensityMap: vec4f\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,translucencyIntensityMap: vec4f\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,reflectionMatrix: mat4x4f\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,irradianceVector_: vec3f\n#endif\n#if defined(REALTIME_FILTERING)\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,vReflectionFilteringInfo: vec2f\n#ifdef IBL_CDF_FILTERING\n,icdfSampler: texture_2d<f32>\n,icdfSamplerSampler: sampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,irradianceSampler: texture_cube<f32>\n,irradianceSamplerSampler: sampler\n#else\n,irradianceSampler: texture_2d<f32>\n,irradianceSamplerSampler: sampler\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,surfaceAlbedo: vec3f\n#endif\n#ifdef SS_REFRACTION\n,vPositionW: vec3f\n,viewDirectionW: vec3f\n,view: mat4x4f\n,vRefractionInfos: vec4f\n,refractionMatrix: mat4x4f\n,vRefractionMicrosurfaceInfos: vec4f\n,vLightingIntensity: vec4f\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,alpha: f32\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,NdotVUnclamped: f32\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,roughness: f32\n#endif\n,alphaG: f32\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler: texture_cube<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_cube<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_cube<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#else\n,refractionSampler: texture_2d<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_2d<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_2d<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut: anisotropicOutParams\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo: vec2f\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition: vec3f\n,refractionSize: vec3f\n#endif\n#ifdef SS_DISPERSION\n,dispersion: f32\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,vDiffusionDistance: vec3f\n,vTranslucencyColor: vec4f\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,translucencyColorMap: vec4f\n#endif\n#endif\n)->subSurfaceOutParams\n{var outParams: subSurfaceOutParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvar refractionIntensity: f32=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);outParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvar translucencyIntensity: f32=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nvar thickness: f32=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nvar thickness: f32=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=thicknessMap.a;\n#else\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nvar thickness: f32=vThicknessParam.y;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=translucencyIntensityMap.a;\n#else\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);var translucencyColor: vec4f=vTranslucencyColor;\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\ntranslucencyColor*=translucencyColorMap;\n#endif\nvar transmittance: vec3f=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvar environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);\n#ifdef SS_HAS_THICKNESS\nvar ior: f32=vRefractionInfos.y;\n#else\nvar ior: f32=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nvar refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaGNdotV(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nvar refractionRoughness: f32=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nvar refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\nvar refraction_ior: f32=vRefractionInfos.y;\n#ifdef SS_DISPERSION\nvar realIOR: f32=1.0/refraction_ior;var iorDispersionSpread: f32=0.04*dispersion*(realIOR-1.0);var iors: vec3f= vec3f(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (var i: i32=0; i<3; i++) {refraction_ior=iors[i];\n#endif\nvar envSample: vec4f=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler\n,refractionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler\n,refractionLowSamplerSampler\n,refractionHighSampler\n,refractionHighSamplerSampler\n#endif\n#else\n,refractionSampler\n,refractionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler\n,refractionLowSamplerSampler\n,refractionHighSampler\n,refractionHighSamplerSampler\n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition\n,refractionSize\n#endif\n);\n#ifdef SS_DISPERSION\nenvironmentRefraction[i]=envSample[i];}\n#else\nenvironmentRefraction=envSample;\n#endif\nenvironmentRefraction=vec4f(environmentRefraction.rgb*vRefractionInfos.x,environmentRefraction.a);\n#endif\n#ifdef SS_REFRACTION\nvar refractionTransmittance: vec3f= vec3f(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvar volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nvar maxChannel: f32=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);var volumeAlbedo: vec3f=saturateVec3(maxChannel*surfaceAlbedo);environmentRefraction=vec4f(environmentRefraction.rgb*volumeAlbedo,environmentRefraction.a);\n#else\nvar volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction=vec4f(environmentRefraction.rgb*surfaceAlbedo.rgb,environmentRefraction.a);\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.refractionOpacity=1.-refractionIntensity;\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\noutParams.surfaceAlbedo*=outParams.refractionOpacity;\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvar bounceSpecularEnvironmentReflectance: vec3f=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;outParams.finalRefraction*=vec3f(1.0)-specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvar irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvar irradianceVector: vec3f=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvar refractionIrradiance: vec3f=irradiance(reflectionSampler,reflectionSamplerSampler,-irradianceVector,vReflectionFilteringInfo,0.0,surfaceAlbedo,irradianceVector\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n);\n#else\nvar refractionIrradiance: vec3f=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvar irradianceCoords: vec3f=irradianceVector;\n#else\nvar irradianceCoords: vec2f=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvar temp: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,-irradianceCoords);var refractionIrradiance=temp.rgb;\n#ifdef RGBDREFLECTION\nrefractionIrradiance=fromRGBD(temp).rgb;\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance=toLinearSpaceVec3(refractionIrradiance);\n#endif\n#else\nvar refractionIrradiance: vec3f= vec3f(0.);\n#endif\nrefractionIrradiance*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance;\n#endif\nreturn outParams;}\n#endif\n");const m$m="pbrBlockNormalFinal";bt$1.IncludesShadersStoreWGSL[m$m]||(bt$1.IncludesShadersStoreWGSL[m$m]="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvar faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\n#if defined(MIRRORED)\nnormalW=select(normalW,-normalW,fragmentInputs.frontFacing);\n#else\nnormalW=select(-normalW,normalW,fragmentInputs.frontFacing);\n#endif\n#endif\n");const R$c="pbrBlockLightmapInit";bt$1.IncludesShadersStoreWGSL[R$c]||(bt$1.IncludesShadersStoreWGSL[R$c]="#ifdef LIGHTMAP\nvar lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor=vec4f(toLinearSpaceVec3(lightmapColor.rgb),lightmapColor.a);\n#endif\nlightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);\n#endif\n");const S$9="pbrBlockGeometryInfo";bt$1.IncludesShadersStoreWGSL[S$9]||(bt$1.IncludesShadersStoreWGSL[S$9]="var NdotVUnclamped: f32=dot(normalW,viewDirectionW);var NdotV: f32=absEps(NdotVUnclamped);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var AARoughnessFactors: vec2f=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvar environmentBrdf: vec3f=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nvar ambientMonochrome: f32=aoOut.ambientOcclusionColor.r;\n#else\nvar ambientMonochrome: f32=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nvar seo: f32=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nvar eho: f32=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n");const C$c="pbrBlockReflectance";bt$1.IncludesShadersStoreWGSL[C$c]||(bt$1.IncludesShadersStoreWGSL[C$c]="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvar baseSpecularEnvironmentReflectance: vec3f=getReflectanceFromBRDFWithEnvLookup(vec3f(reflectanceF0),vec3f(reflectivityOut.reflectanceF90),environmentBrdf);\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\nlet metalEnvironmentReflectance: vec3f=vec3f(reflectivityOut.specularWeight)*getF82Specular(NdotV,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricEnvironmentReflectance=getReflectanceFromBRDFWithEnvLookup(reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90,environmentBrdf);var colorSpecularEnvironmentReflectance: vec3f=mix(dielectricEnvironmentReflectance,metalEnvironmentReflectance,reflectivityOut.metallic);\n#else\nvar colorSpecularEnvironmentReflectance=getReflectanceFromBRDFWithEnvLookup(clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,environmentBrdf);\n#endif\n#ifdef RADIANCEOCCLUSION\ncolorSpecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\ncolorSpecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvar colorSpecularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));var baseSpecularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,vec3f(reflectanceF0),vec3f(reflectivityOut.reflectanceF90),sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\ncolorSpecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\ncolorSpecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n");const u$i="pbrBlockDirectLighting";bt$1.IncludesShadersStoreWGSL[u$i]||(bt$1.IncludesShadersStoreWGSL[u$i]="var diffuseBase: vec3f=vec3f(0.,0.,0.);\n#ifdef SS_TRANSLUCENCY\nvar diffuseTransmissionBase: vec3f=vec3f(0.,0.,0.);\n#endif\n#ifdef SPECULARTERM\nvar specularBase: vec3f=vec3f(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvar clearCoatBase: vec3f=vec3f(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvar sheenBase: vec3f=vec3f(0.,0.,0.);\n#endif\n#if defined(SPECULARTERM) && defined(LIGHT0)\nvar coloredFresnel: vec3f=vec3f(0.,0.,0.);\n#endif\nvar preInfo: preLightingInfo;var info: lightingInfo;var shadow: f32=1.; \nvar aggShadow: f32=0.;var numLights: f32=0.;\n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvar absorption: vec3f=vec3f(0.);\n#endif\n");const v$b="pbrBlockFinalLitComponents";bt$1.IncludesShadersStoreWGSL[v$b]||(bt$1.IncludesShadersStoreWGSL[v$b]="aggShadow=aggShadow/numLights;\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvar baseSpecularEnergyConservationFactor: vec3f=getEnergyConservationFactor(vec3f(reflectanceF0),environmentBrdf);var coloredEnergyConservationFactor: vec3f=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo=vec3f(1.-reflectanceF0)*surfaceAlbedo.rgb;\n#endif\n#endif\n#endif\n#ifdef REFLECTION\nvar finalIrradiance: vec3f=reflectionOut.environmentIrradiance;\n#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION\n#if defined(METALLICWORKFLOW) || defined(SPECULAR_GLOSSINESS_ENERGY_CONSERVATION)\nvar baseSpecularEnergy: vec3f=vec3f(baseSpecularEnvironmentReflectance);\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nbaseSpecularEnergy*=baseSpecularEnergyConservationFactor;\n#endif\n#endif\nfinalIrradiance*=clamp(vec3f(1.0)-baseSpecularEnergy,vec3f(0.0),vec3f(1.0));\n#endif\n#endif\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#ifndef SS_APPLY_ALBEDO_AFTER_SUBSURFACE\nfinalIrradiance*=surfaceAlbedo.rgb;\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionOpacity;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\n#ifdef SS_APPLY_ALBEDO_AFTER_SUBSURFACE\nfinalIrradiance*=surfaceAlbedo.rgb;\n#endif\nfinalIrradiance*=uniforms.vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvar finalSpecular: vec3f=specularBase;finalSpecular=max(finalSpecular,vec3f(0.0));var finalSpecularScaled: vec3f=finalSpecular*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=coloredEnergyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvar finalRadiance: vec3f=reflectionOut.environmentRadiance.rgb;finalRadiance*=colorSpecularEnvironmentReflectance;;var finalRadianceScaled: vec3f=finalRadiance*uniforms.vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=coloredEnergyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvar finalSheen: vec3f=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,vec3f(0.0));var finalSheenScaled: vec3f=finalSheen*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvar finalClearCoat: vec3f=clearCoatBase;finalClearCoat=max(finalClearCoat,vec3f(0.0));var finalClearCoatScaled: vec3f=finalClearCoat*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nvar luminanceOverAlpha: f32=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n");const p$k="pbrBlockFinalUnlitComponents";bt$1.IncludesShadersStoreWGSL[p$k]||(bt$1.IncludesShadersStoreWGSL[p$k]="var finalDiffuse: vec3f=diffuseBase;finalDiffuse*=surfaceAlbedo;\n#if defined(SS_REFRACTION) && !defined(UNLIT) && !defined(LEGACY_SPECULAR_ENERGY_CONSERVATION)\nfinalDiffuse*=subSurfaceOut.refractionOpacity;\n#endif\n#if defined(SS_TRANSLUCENCY) && !defined(UNLIT)\nfinalDiffuse+=diffuseTransmissionBase;\n#endif\nfinalDiffuse=max(finalDiffuse,vec3f(0.0));finalDiffuse*=uniforms.vLightingIntensity.x;var finalAmbient: vec3f=uniforms.vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;var finalEmissive: vec3f=uniforms.vEmissiveColor;\n#ifdef EMISSIVE\nvar emissiveColorTex: vec3f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpaceVec3(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= uniforms.vEmissiveInfos.y;\n#endif\nfinalEmissive*=uniforms.vLightingIntensity.y;\n#ifdef AMBIENT\nvar ambientOcclusionForDirectDiffuse: vec3f=mix( vec3f(1.),aoOut.ambientOcclusionColor,uniforms.vAmbientInfos.w);\n#else\nvar ambientOcclusionForDirectDiffuse: vec3f=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;\n");const A$c="pbrBlockFinalColorComposition";bt$1.IncludesShadersStoreWGSL[A$c]||(bt$1.IncludesShadersStoreWGSL[A$c]="var finalColor: vec4f= vec4f(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor=vec4f(finalColor.rgb*lightmapColor.rgb,finalColor.a);\n#else\nfinalColor=vec4f(finalColor.rgb+lightmapColor.rgb,finalColor.a);\n#endif\n#endif\n#endif\nfinalColor=vec4f(finalColor.rgb+finalEmissive,finalColor.a);\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,vec4f(0.0));\n");const I$d="pbrPixelShader",N$a="#define PBR_FRAGMENT_SHADER\n#define CUSTOM_FRAGMENT_BEGIN\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<pbrUboDeclaration>\n#include<pbrFragmentExtraDeclaration>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nvar albedoOpacityOut: albedoOpacityOutParams;\n#ifdef ALBEDO\nvar albedoTexture: vec4f=textureSample(albedoSampler,albedoSamplerSampler,fragmentInputs.vAlbedoUV+uvOffset);\n#endif\n#ifdef BASE_WEIGHT\nvar baseWeightTexture: vec4f=textureSample(baseWeightSampler,baseWeightSamplerSampler,fragmentInputs.vBaseWeightUV+uvOffset);\n#endif\n#ifdef OPACITY\nvar opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvar decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#endif\nalbedoOpacityOut=albedoOpacityBlock(\nuniforms.vAlbedoColor\n#ifdef ALBEDO\n,albedoTexture\n,uniforms.vAlbedoInfos\n#endif\n,uniforms.baseWeight\n#ifdef BASE_WEIGHT\n,baseWeightTexture\n,uniforms.vBaseWeightInfos\n#endif\n#ifdef OPACITY\n,opacityMap\n,uniforms.vOpacityInfos\n#endif\n#ifdef DETAIL\n,detailColor\n,uniforms.vDetailInfos\n#endif\n#ifdef DECAL\n,decalColor\n,uniforms.vDecalInfos\n#endif\n);var surfaceAlbedo: vec3f=albedoOpacityOut.surfaceAlbedo;var alpha: f32=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nvar aoOut: ambientOcclusionOutParams;\n#ifdef AMBIENT\nvar ambientOcclusionColorMap: vec3f=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb;\n#endif\naoOut=ambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nuniforms.vAmbientInfos\n#endif\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvar diffuseBase: vec3f= vec3f(1.,1.,1.);\n#else\nvar baseColor: vec3f=surfaceAlbedo;var reflectivityOut: reflectivityOutParams;\n#if defined(REFLECTIVITY)\nvar surfaceMetallicOrReflectivityColorMap: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,fragmentInputs.vReflectivityUV+uvOffset);var baseReflectivity: vec4f=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpaceVec4(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap=vec4f(surfaceMetallicOrReflectivityColorMap.rgb*uniforms.vReflectivityInfos.y,surfaceMetallicOrReflectivityColorMap.a);\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvar microSurfaceTexel: vec4f=textureSample(microSurfaceSampler,microSurfaceSamplerSampler,fragmentInputs.vMicroSurfaceSamplerUV+uvOffset)*uniforms.vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef BASE_DIFFUSE_ROUGHNESS\nvar baseDiffuseRoughnessTexture: f32=textureSample(baseDiffuseRoughnessSampler,baseDiffuseRoughnessSamplerSampler,fragmentInputs.vBaseDiffuseRoughnessUV+uvOffset).x;\n#endif\n#ifdef METALLICWORKFLOW\nvar metallicReflectanceFactors: vec4f=uniforms.vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvar reflectanceFactorsMap: vec4f=textureSample(reflectanceSampler,reflectanceSamplerSampler,fragmentInputs.vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpaceVec4(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*reflectanceFactorsMap.rgb,metallicReflectanceFactors.a);\n#endif\n#ifdef METALLIC_REFLECTANCE\nvar metallicReflectanceFactorsMap: vec4f=textureSample(metallicReflectanceSampler,metallicReflectanceSamplerSampler,fragmentInputs.vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpaceVec4(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*metallicReflectanceFactorsMap.rgb,metallicReflectanceFactors.a);\n#endif\nmetallicReflectanceFactors.a*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityOut=reflectivityBlock(\nuniforms.vReflectivityColor\n#ifdef METALLICWORKFLOW\n,surfaceAlbedo\n,metallicReflectanceFactors\n#endif\n,uniforms.baseDiffuseRoughness\n#ifdef BASE_DIFFUSE_ROUGHNESS\n,baseDiffuseRoughnessTexture\n,uniforms.vBaseDiffuseRoughnessInfos\n#endif\n#ifdef REFLECTIVITY\n,uniforms.vReflectivityInfos\n,surfaceMetallicOrReflectivityColorMap\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,aoOut.ambientOcclusionColor\n#endif\n#ifdef MICROSURFACEMAP\n,microSurfaceTexel\n#endif\n#ifdef DETAIL\n,detailColor\n,uniforms.vDetailInfos\n#endif\n);var microSurface: f32=reflectivityOut.microSurface;var roughness: f32=reflectivityOut.roughness;var diffuseRoughness: f32=reflectivityOut.diffuseRoughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nvar alphaFresnelOut: alphaFresnelOutParams;alphaFresnelOut=alphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface\n);alpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nvar anisotropicOut: anisotropicOutParams;\n#ifdef ANISOTROPIC_TEXTURE\nvar anisotropyMapData: vec3f=textureSample(anisotropySampler,anisotropySamplerSampler,fragmentInputs.vAnisotropyUV+uvOffset).rgb*uniforms.vAnisotropyInfos.y;\n#endif\nanisotropicOut=anisotropicBlock(\nuniforms.vAnisotropy,\nroughness,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW\n);\n#endif\n#ifdef REFLECTION\nvar reflectionOut: reflectionOutParams;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionOut=reflectionBlock(\nfragmentInputs.vPositionW\n,normalW\n,alphaG\n,uniforms.vReflectionMicrosurfaceInfos\n,uniforms.vReflectionInfos\n,uniforms.vReflectionColor\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness\n#endif\n,reflectionSampler\n,reflectionSamplerSampler\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,fragmentInputs.vEnvironmentIrradiance\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,uniforms.reflectionMatrix\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n,irradianceSamplerSampler\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\n,uniforms.vReflectionDominantDirection\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n#endif\n,viewDirectionW\n,diffuseRoughness\n,surfaceAlbedo\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nvar sheenOut: sheenOutParams;\n#ifdef SHEEN_TEXTURE\nvar sheenMapData: vec4f=textureSample(sheenSampler,sheenSamplerSampler,fragmentInputs.vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvar sheenMapRoughnessData: vec4f=textureSample(sheenRoughnessSampler,sheenRoughnessSamplerSampler,fragmentInputs.vSheenRoughnessUV+uvOffset)*uniforms.vSheenInfos.w;\n#endif\nsheenOut=sheenBlock(\nuniforms.vSheenColor\n#ifdef SHEEN_ROUGHNESS\n,uniforms.vSheenRoughness\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,sheenMapRoughnessData\n#endif\n#endif\n,roughness\n#ifdef SHEEN_TEXTURE\n,sheenMapData\n,uniforms.vSheenInfos.y\n#endif\n,reflectanceF0\n#ifdef SHEEN_LINKWITHALBEDO\n,baseColor\n,surfaceAlbedo\n#endif\n#ifdef ENVIRONMENTBRDF\n,NdotV\n,environmentBrdf\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,AARoughnessFactors\n,uniforms.vReflectionMicrosurfaceInfos\n,uniforms.vReflectionInfos\n,uniforms.vReflectionColor\n,uniforms.vLightingIntensity\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionOut.reflectionCoords\n,NdotVUnclamped\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,seo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,eho\n#endif\n#endif\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvar clearCoatMapData: vec2f=textureSample(clearCoatSampler,clearCoatSamplerSampler,fragmentInputs.vClearCoatUV+uvOffset).rg*uniforms.vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\nvar iridescenceOut: iridescenceOutParams;\n#ifdef IRIDESCENCE_TEXTURE\nvar iridescenceMapData: vec2f=textureSample(iridescenceSampler,iridescenceSamplerSampler,fragmentInputs.vIridescenceUV+uvOffset).rg*uniforms.vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvar iridescenceThicknessMapData: vec2f=textureSample(iridescenceThicknessSampler,iridescenceThicknessSamplerSampler,fragmentInputs.vIridescenceThicknessUV+uvOffset).rg*uniforms.vIridescenceInfos.w;\n#endif\niridescenceOut=iridescenceBlock(\nuniforms.vIridescenceParams\n,NdotV\n,specularEnvironmentR0\n#ifdef IRIDESCENCE_TEXTURE\n,iridescenceMapData\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,iridescenceThicknessMapData\n#endif\n#ifdef CLEARCOAT\n,NdotVUnclamped\n,uniforms.vClearCoatParams\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#endif\n);var iridescenceIntensity: f32=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nvar clearcoatOut: clearcoatOutParams;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvar clearCoatMapRoughnessData: vec4f=textureSample(clearCoatRoughnessSampler,clearCoatRoughnessSamplerSampler,fragmentInputs.vClearCoatRoughnessUV+uvOffset)*uniforms.vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvar clearCoatTintMapData: vec4f=textureSample(clearCoatTintSampler,clearCoatTintSamplerSampler,fragmentInputs.vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvar clearCoatBumpMapData: vec4f=textureSample(clearCoatBumpSampler,clearCoatBumpSamplerSampler,fragmentInputs.vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatOut=clearcoatBlock(\nfragmentInputs.vPositionW\n,geometricNormalW\n,viewDirectionW\n,uniforms.vClearCoatParams\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,clearCoatMapRoughnessData\n#endif\n,specularEnvironmentR0\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#ifdef CLEARCOAT_TINT\n,uniforms.vClearCoatTintParams\n,uniforms.clearCoatColorAtDistance\n,uniforms.vClearCoatRefractionParams\n#ifdef CLEARCOAT_TINT_TEXTURE\n,clearCoatTintMapData\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,uniforms.vClearCoatBumpInfos\n,clearCoatBumpMapData\n,fragmentInputs.vClearCoatBumpUV\n#if defined(TANGENT) && defined(NORMAL)\n,mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2)\n#else\n,uniforms.vClearCoatTangentSpaceParams\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,uniforms.normalMatrix\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,faceNormal\n#endif\n#ifdef REFLECTION\n,uniforms.vReflectionMicrosurfaceInfos\n,uniforms.vReflectionInfos\n,uniforms.vReflectionColor\n,uniforms.vLightingIntensity\n,reflectionSampler\n,reflectionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,select(-1.,1.,fragmentInputs.frontFacing)\n#endif\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nvar subSurfaceOut: subSurfaceOutParams;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvar thicknessMap: vec4f=textureSample(thicknessSampler,thicknessSamplerSampler,fragmentInputs.vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvar refractionIntensityMap: vec4f=textureSample(refractionIntensitySampler,refractionIntensitySamplerSampler,fragmentInputs.vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvar translucencyIntensityMap: vec4f=textureSample(translucencyIntensitySampler,translucencyIntensitySamplerSampler,fragmentInputs.vTranslucencyIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nvar translucencyColorMap: vec4f=textureSample(translucencyColorSampler,translucencyColorSamplerSampler,fragmentInputs.vTranslucencyColorUV+uvOffset);\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA\ntranslucencyColorMap=toLinearSpaceVec4(translucencyColorMap);\n#endif\n#endif\nsubSurfaceOut=subSurfaceBlock(\nuniforms.vSubSurfaceIntensity\n,uniforms.vThicknessParam\n,uniforms.vTintColor\n,normalW\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\n,vec3f(max(colorSpecularEnvironmentReflectance.r,max(colorSpecularEnvironmentReflectance.g,colorSpecularEnvironmentReflectance.b)))\n#else\n,baseSpecularEnvironmentReflectance\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,thicknessMap\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,refractionIntensityMap\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,translucencyIntensityMap\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,uniforms.reflectionMatrix\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,reflectionOut.irradianceVector\n#endif\n#if defined(REALTIME_FILTERING)\n,reflectionSampler\n,reflectionSamplerSampler\n,uniforms.vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n,irradianceSamplerSampler\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,surfaceAlbedo\n#endif\n#ifdef SS_REFRACTION\n,fragmentInputs.vPositionW\n,viewDirectionW\n,scene.view\n,uniforms.vRefractionInfos\n,uniforms.refractionMatrix\n,uniforms.vRefractionMicrosurfaceInfos\n,uniforms.vLightingIntensity\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,alpha\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,NdotVUnclamped\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,roughness\n#endif\n,alphaG\n,refractionSampler\n,refractionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler\n,refractionLowSamplerSampler\n,refractionHighSampler\n,refractionHighSamplerSampler\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,uniforms.vRefractionPosition\n,uniforms.vRefractionSize\n#endif\n#ifdef SS_DISPERSION\n,uniforms.dispersion\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,uniforms.vDiffusionDistance\n,uniforms.vTranslucencyColor\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,translucencyColorMap\n#endif\n#endif\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=colorSpecularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#include<pbrBlockPrePass>\n#endif\n#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)\nfragmentOutputs.color=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStoreWGSL[I$d]||(bt$1.ShadersStoreWGSL[I$d]=N$a);const O$e={name:I$d,shader:N$a};var pbr_fragmentBMoFW2hA_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,pbrPixelShaderWGSL:O$e});const n$15="decalVertexDeclaration";bt$1.IncludesShadersStore[n$15]||(bt$1.IncludesShadersStore[n$15]="#ifdef DECAL\nuniform vec4 vDecalInfos;uniform mat4 decalMatrix;\n#endif\n");const i$R="uvAttributeDeclaration";bt$1.IncludesShadersStore[i$R]||(bt$1.IncludesShadersStore[i$R]="#ifdef UV{X}\nattribute vec2 uv{X};\n#endif\n");const r$1f="prePassVertexDeclaration";bt$1.IncludesShadersStore[r$1f]||(bt$1.IncludesShadersStore[r$1f]="#ifdef PREPASS\n#ifdef PREPASS_LOCAL_POSITION\nvarying vec3 vPosition;\n#endif\n#ifdef PREPASS_DEPTH\nvarying vec3 vViewPos;\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\nvarying float vNormViewDepth;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#endif\n");const s$j="samplerVertexDeclaration";bt$1.IncludesShadersStore[s$j]||(bt$1.IncludesShadersStore[s$j]="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n");const d$k="prePassVertex";bt$1.IncludesShadersStore[d$k]||(bt$1.IncludesShadersStore[d$k]="#ifdef PREPASS_DEPTH\nvViewPos=(view*worldPos).rgb;\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\nvNormViewDepth=((view*worldPos).z-cameraInfo.x)/(cameraInfo.y-cameraInfo.x);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nvPosition=positionUpdated.xyz;\n#endif\n#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n");const o$R="uvVariableDeclaration";bt$1.IncludesShadersStore[o$R]||(bt$1.IncludesShadersStore[o$R]="#if !defined(UV{X}) && defined(MAINUV{X})\nvec2 uv{X}=vec2(0.,0.);\n#endif\n#ifdef MAINUV{X}\nvMainUV{X}=uv{X};\n#endif\n");const f$l="samplerVertexImplementation";bt$1.IncludesShadersStore[f$l]||(bt$1.IncludesShadersStore[f$l]="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (v_INFONAME_==0.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}\n#ifdef UV2\nelse if (v_INFONAME_==1.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2Updated,1.0,0.0));}\n#endif\n#ifdef UV3\nelse if (v_INFONAME_==2.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}\n#endif\n#ifdef UV4\nelse if (v_INFONAME_==3.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}\n#endif\n#ifdef UV5\nelse if (v_INFONAME_==4.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}\n#endif\n#ifdef UV6\nelse if (v_INFONAME_==5.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}\n#endif\n#endif\n");const t$N="vertexColorMixing";bt$1.IncludesShadersStore[t$N]||(bt$1.IncludesShadersStore[t$N]="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvColor=vec4(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvColor*=colorUpdated;\n#else\nvColor.rgb*=colorUpdated.rgb;\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvColor*=instanceColor;\n#endif\n#endif\n");const c$h="pbrUboDeclaration";bt$1.IncludesShadersStore[c$h]||(bt$1.IncludesShadersStore[c$h]="layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec2 vBaseWeightInfos;vec2 vBaseDiffuseRoughnessInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec3 vBumpInfos;mat4 albedoMatrix;mat4 baseWeightMatrix;mat4 baseDiffuseRoughnessMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;vec4 vAlbedoColor;float baseWeight;float baseDiffuseRoughness;vec4 vLightingIntensity;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec4 cameraInfo;vec2 vReflectionInfos;mat4 reflectionMatrix;vec3 vReflectionMicrosurfaceInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vReflectionFilteringInfo;vec3 vReflectionDominantDirection;vec3 vReflectionColor;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n");const e$i="mainUVVaryingDeclaration";bt$1.IncludesShadersStore[e$i]||(bt$1.IncludesShadersStore[e$i]="#ifdef MAINUV{X}\nvarying vec2 vMainUV{X};\n#endif\n");const t$M="pbrBRDFFunctions";bt$1.IncludesShadersStore[t$M]||(bt$1.IncludesShadersStore[t$M]="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#define BRDF_DIFFUSE_MODEL_EON 0\n#define BRDF_DIFFUSE_MODEL_BURLEY 1\n#define BRDF_DIFFUSE_MODEL_LAMBERT 2\n#define BRDF_DIFFUSE_MODEL_LEGACY 3\n#define DIELECTRIC_SPECULAR_MODEL_GLTF 0\n#define DIELECTRIC_SPECULAR_MODEL_OPENPBR 1\n#define CONDUCTOR_SPECULAR_MODEL_GLTF 0\n#define CONDUCTOR_SPECULAR_MODEL_OPENPBR 1\n#if !defined(PBR_VERTEX_SHADER) && !defined(OPENPBR_VERTEX_SHADER)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR \nvec3 getF82Specular(float NdotV,vec3 F0,vec3 edgeTint,float roughness) {const float cos_theta_max=0.142857143; \nconst float one_minus_cos_theta_max_to_the_fifth=0.462664366; \nconst float one_minus_cos_theta_max_to_the_sixth=0.396569457; \nvec3 white_minus_F0=vec3(1.0)-F0;vec3 b_numerator=(F0+white_minus_F0*one_minus_cos_theta_max_to_the_fifth)*(vec3(1.0)-edgeTint);const float b_denominator=cos_theta_max*one_minus_cos_theta_max_to_the_sixth;const float b_denominator_reciprocal=1.0/b_denominator;vec3 b=b_numerator*b_denominator_reciprocal; \nfloat cos_theta=max(roughness,NdotV);float one_minus_cos_theta=1.0-cos_theta;vec3 offset_from_F0=(white_minus_F0-b*cos_theta*one_minus_cos_theta)*pow(one_minus_cos_theta,5.0);return clamp(F0+offset_from_F0,0.0,1.0);}\n#endif\n#ifdef FUZZENVIRONMENTBRDF\nvec3 getFuzzBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(perceptualRoughness,NdotV);vec4 brdfLookup=texture(environmentFuzzBrdfSampler,UV);const vec2 RiRange=vec2(0.0,0.75);const vec2 ARange =vec2(0.005,0.88);const vec2 BRange =vec2(-0.18,0.002);brdfLookup.r=mix(ARange.x, ARange.y, brdfLookup.r);brdfLookup.g=mix(BRange.x, BRange.y, brdfLookup.g);brdfLookup.b=mix(RiRange.x,RiRange.y,brdfLookup.b);return brdfLookup.rgb;}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfloat getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)\n{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nvec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}\nfloat getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}\nvec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}\nvec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nfloat cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); \nvec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)\n{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}\nreturn max(I,vec3(0.0));}\n#endif\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfloat l(float x,float alphaG)\n{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfloat lambdaSheen(float cosTheta,float alphaG)\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfloat visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)\n{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\nconst float constant1_FON=0.5-2.0/(3.0*PI);const float constant2_FON=2.0/3.0-28.0/(15.0*PI);float E_FON_approx(float mu,float roughness)\n{float sigma=roughness; \nfloat mucomp=1.0-mu;float mucomp2=mucomp*mucomp;const mat2 Gcoeffs=mat2(0.0571085289,-0.332181442,\n0.491881867,0.0714429953);float GoverPi=dot(Gcoeffs*vec2(mucomp,mucomp2),vec2(1.0,mucomp2));return (1.0+sigma*GoverPi)/(1.0+constant1_FON*sigma);}\nvec3 diffuseBRDF_EON(vec3 albedo,float roughness,float NdotL,float NdotV,float LdotV)\n{vec3 rho=albedo;float sigma=roughness; \nfloat mu_i=NdotL; \nfloat mu_o=NdotV; \nfloat s=LdotV-mu_i*mu_o; \nfloat sovertF=s>0.0 ? s/max(mu_i,mu_o) : s; \nfloat AF=1.0/(1.0+constant1_FON*sigma); \nvec3 f_ss=(rho*RECIPROCAL_PI)*AF*(1.0+sigma*sovertF); \nfloat EFo=E_FON_approx(mu_o,sigma); \nfloat EFi=E_FON_approx(mu_i,sigma); \nfloat avgEF=AF*(1.0+constant2_FON*sigma); \nvec3 rho_ms=(rho*rho)*avgEF/(vec3(1.0)-rho*(1.0-avgEF));const float eps=1.0e-7;vec3 f_ms=(rho_ms*RECIPROCAL_PI)*max(eps,1.0-EFo) \n* max(eps,1.0-EFi)\n/ max(eps,1.0-avgEF);return (f_ss+f_ms);}\n#ifdef SS_TRANSLUCENCY\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}\n#endif\n#endif \n");const e$h="harmonicsFunctions";bt$1.IncludesShadersStore[e$h]||(bt$1.IncludesShadersStore[e$h]="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nvec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00\n+ vSphericalL1_1*(normal.y)\n+ vSphericalL10*(normal.z)\n+ vSphericalL11*(normal.x)\n+ vSphericalL2_2*(normal.y*normal.x)\n+ vSphericalL2_1*(normal.y*normal.z)\n+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ vSphericalL21*(normal.z*normal.x)\n+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}\n#else\nvec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}\n#endif\n#endif\n");const n$14="bumpVertexDeclaration";bt$1.IncludesShadersStore[n$14]||(bt$1.IncludesShadersStore[n$14]="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n");const e$g="bumpVertex";bt$1.IncludesShadersStore[e$g]||(bt$1.IncludesShadersStore[e$g]="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n");const n$13="pbrVertexDeclaration";bt$1.IncludesShadersStore[n$13]||(bt$1.IncludesShadersStore[n$13]="uniform mat4 view;uniform mat4 viewProjection;uniform vec4 vEyePosition;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;\n#endif\n#ifdef BASE_WEIGHT\nuniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;\n#endif\nuniform float baseDiffuseRoughness;\n#ifdef BASE_DIFFUSE_ROUGHNESS\nuniform mat4 baseDiffuseRoughnessMatrix;uniform vec2 vBaseDiffuseRoughnessInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef REFLECTANCE\nuniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\nuniform vec4 cameraInfo;\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#ifdef IRIDESCENCE\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nuniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;\n#endif\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n");const i$Q="pbrVertexShader",E$h="#define PBR_VERTEX_SHADER\n#define CUSTOM_VERTEX_EXTENSION\nprecision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)\n#endif\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvarying float vViewDepth;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef VERTEXCOLOR\nvec4 colorUpdated=color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);float NdotV=max(dot(vNormalW,viewDirectionW),0.0);vec3 roughNormal=mix(vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*baseDiffuseRoughness);vec3 reflectionVector=vec3(reflectionMatrix*vec4(roughNormal,0)).xyz;\n#else\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvViewDepth=(view*worldPos).z;\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2Updated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";bt$1.ShadersStore[i$Q]||(bt$1.ShadersStore[i$Q]=E$h);const r$1e={name:i$Q,shader:E$h};var pbr_vertexCVn_VV4N_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,pbrVertexShader:r$1e});const t$L="prePassDeclaration";bt$1.IncludesShadersStore[t$L]||(bt$1.IncludesShadersStore[t$L]="#ifdef PREPASS\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;\n#ifdef PREPASS_LOCAL_POSITION\nvarying highp vec3 vPosition;\n#endif\n#ifdef PREPASS_DEPTH\nvarying highp vec3 vViewPos;\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\nvarying highp float vNormViewDepth;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nvarying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;\n#endif\n#endif\n");const n$12="oitDeclaration";bt$1.IncludesShadersStore[n$12]||(bt$1.IncludesShadersStore[n$12]="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out vec2 depth; \nlayout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;\n#define MAX_DEPTH 99999.0\nhighp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;\n#endif\n");const r$1d="decalFragmentDeclaration";bt$1.IncludesShadersStore[r$1d]||(bt$1.IncludesShadersStore[r$1d]="#ifdef DECAL\nuniform vec4 vDecalInfos;\n#endif\n");const o$Q="depthPrePass";bt$1.IncludesShadersStore[o$Q]||(bt$1.IncludesShadersStore[o$Q]="#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);return;\n#endif\n");const a$G="oitFragment";bt$1.IncludesShadersStore[a$G]||(bt$1.IncludesShadersStore[a$G]="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nfloat fragDepth=gl_FragCoord.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nuint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;\n#endif\nivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfloat furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;\n#else\nfloat nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;\n#endif\nfloat alphaMultiplier=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn;}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\ndepth.rg=vec2(-fragDepth,fragDepth);return;}\n#endif\n");const n$11="pbrFragmentExtraDeclaration";bt$1.IncludesShadersStore[n$11]||(bt$1.IncludesShadersStore[n$11]="varying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvarying float vViewDepth;\n#endif\n");const o$P="subSurfaceScatteringFunctions";bt$1.IncludesShadersStore[o$P]||(bt$1.IncludesShadersStore[o$P]="bool testLightingForSSS(float diffusionProfile)\n{return diffusionProfile<1.;}");const t$K="pbrHelperFunctions";bt$1.IncludesShadersStore[t$K]||(bt$1.IncludesShadersStore[t$K]="#define MINIMUMVARIANCE 0.0005\nfloat convertRoughnessToAverageSlope(float roughness)\n{return square(roughness)+MINIMUMVARIANCE;}\nfloat fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}\nvec2 getAARoughnessFactors(vec3 normalVector) {\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2(0.);\n#endif\n}\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_LEGACY\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection;if (anisotropy>=0.0) {anisotropicFrameDirection=B;} else {anisotropicFrameDirection=T;}\nvec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}\n#elif ANISOTROPIC_OPENPBR\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=alphaG*sqrt(2.0/(1.0+(1.0-anisotropy)*(1.0-anisotropy)));float alphaB=max(alphaT*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\n#else\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}\n#endif\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nvec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}\nvec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}\nvec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}\nvec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);return clearCoatAbsorption;}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}\n#endif\n");const i$P="pbrDirectLightingSetupFunctions";bt$1.IncludesShadersStore[i$P]||(bt$1.IncludesShadersStore[i$P]="struct preLightingInfo\n{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float LdotV;float roughness;float diffuseRoughness;vec3 surfaceAlbedo;\n#ifdef IRIDESCENCE\nfloat iridescenceIntensity;\n#endif\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nvec3 areaLightDiffuse;\n#ifdef SPECULARTERM\nvec3 areaLightSpecular;vec4 areaLightFresnel;\n#endif\n#endif\n};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N,vec3 posW) {preLightingInfo result;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}\npreLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=dot(result.L,V);result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}\npreLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));\n#endif\nresult.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\nuniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;preLightingInfo computeAreaPreLightingInfo(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec4 lightData,vec3 halfWidth,vec3 halfHeight,float roughness )\n{preLightingInfo result;result.lightOffset=lightData.xyz-vPosition;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightData.xyz,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nresult.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;\n#endif\nresult.areaLightDiffuse=data.Diffuse;result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}\n#endif\n");const r$1c="pbrDirectLightingFalloffFunctions";bt$1.IncludesShadersStore[r$1c]||(bt$1.IncludesShadersStore[r$1c]="float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)\n{return max(0.,1.0-length(lightOffset)/range);}\nfloat computeDistanceLightFalloff_Physical(float lightDistanceSquared)\n{return 1.0/maxEps(lightDistanceSquared);}\nfloat computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)\n{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfloat computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)\n{falloff=max(0.,pow(cosAngle,exponent));}\nreturn falloff;}\nfloat computeDirectionalLightFalloff_IES(vec3 lightDirection,vec3 directionToLightCenterW,sampler2D iesLightSampler)\n{float cosAngle=dot(-lightDirection,directionToLightCenterW);float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}\nfloat computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)\n{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}\nfloat computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)\n{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}");const a$F="pbrDirectLightingFunctions";bt$1.IncludesShadersStore[a$F]||(bt$1.IncludesShadersStore[a$F]="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{vec3 diffuse;\n#ifdef SS_TRANSLUCENCY\nvec3 diffuseTransmission;\n#endif\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef CLEARCOAT\nvec4 clearCoat;\n#endif\n#ifdef SHEEN\nvec3 sheen;\n#endif\n};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nfloat lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nvec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nvec3 computeAreaDiffuseLighting(preLightingInfo info,vec3 lightColor) {return info.areaLightDiffuse*lightColor;}\n#endif\nvec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {vec3 diffuseTerm=vec3(1.0/PI);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY\ndiffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\ndiffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nvec3 clampedAlbedo=clamp(info.surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;\n#endif\nreturn diffuseTerm*info.attenuation*info.NdotL*lightColor;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}\n#ifdef SS_TRANSLUCENCY\nvec3 computeDiffuseTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {vec3 transmittanceNdotL=vec3(0.);float NdotL=absEps(info.NdotLUnclamped);\n#ifndef SS_TRANSLUCENCY_LEGACY\nif (info.NdotLUnclamped<0.0) {\n#endif\nfloat wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);\n#ifndef SS_TRANSLUCENCY_LEGACY\n}\nvec3 diffuseTerm=vec3(1.0/PI);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY\ndiffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\ndiffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nvec3 clampedAlbedo=clamp(info.surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;\n#endif\n#else\nfloat diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);\n#endif\nreturn diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}\n#endif\n#ifdef SPECULARTERM\nvec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 fresnel,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nfloat smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nvec3 computeAreaSpecularLighting(preLightingInfo info,vec3 specularColor,vec3 reflectance0,vec3 reflectance90) {vec3 fresnel=specularColor*info.areaLightFresnel.x*reflectance0+( vec3( 1.0 )-specularColor )*info.areaLightFresnel.y*reflectance90;return specularColor*fresnel*info.areaLightSpecular;}\n#endif\n#endif\n#ifdef FUZZ\nfloat evalFuzz(vec3 L,float NdotL,float NdotV,vec3 T,vec3 B,vec3 ltcLut)\n{if (NdotL<=0.0 || NdotV<=0.0)\nreturn 0.0;mat3 M=mat3(\nvec3(ltcLut.r,0.0,0.0),\nvec3(ltcLut.g,1.0,0.0),\nvec3(0.0,0.0,1.0)\n);vec3 Llocal=vec3(dot(L,T),dot(L,B),NdotL);vec3 Lwarp=normalize(M*Llocal);float cosThetaWarp=max(Lwarp.z,0.0);return cosThetaWarp*NdotL;}\n#endif\n#if defined(ANISOTROPIC) && defined(ANISOTROPIC_OPENPBR)\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=vec3(distribution*smithVisibility);return specTerm*info.attenuation*info.NdotL*lightColor;}\n#elif defined(ANISOTROPIC)\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef CLEARCOAT\nvec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);}\nvec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}\n#endif\n#ifdef SHEEN\nvec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER\nfloat visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nfloat visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */\nfloat sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n");const l$g="pbrIBLFunctions";bt$1.IncludesShadersStore[l$g]||(bt$1.IncludesShadersStore[l$g]="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}\nfloat getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}\n#endif\n");const f$k="pbrBlockNormalGeometric";bt$1.IncludesShadersStore[f$k]||(bt$1.IncludesShadersStore[f$k]="vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\nvec3 geometricNormalW=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;\n#endif\n");const c$g="pbrBlockImageProcessing";bt$1.IncludesShadersStore[c$g]||(bt$1.IncludesShadersStore[c$g]="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\nfinalColor.rgb*=finalColor.a;\n#endif\n");const s$i="pbrBlockPrePass";bt$1.IncludesShadersStore[s$i]||(bt$1.IncludesShadersStore[s$i]="#if SCENE_MRT_COUNT>0\nfloat writeGeometryInfo=finalColor.a>ALPHATESTVALUE ? 1.0 : 0.0;\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\ngl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);\n#endif\n#if defined(PREPASS_VELOCITY)\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\ngl_FragData[PREPASS_ALBEDO_INDEX]=vec4(surfaceAlbedo,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvec3 sqAlbedo=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvec3 irradiance=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\n#ifdef PREPASS_COLOR\ngl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb-irradiance,finalColor.a); \n#endif\nirradiance/=sqAlbedo;\n#else\n#ifdef PREPASS_COLOR\ngl_FragData[PREPASS_COLOR_INDEX]=finalColor; \n#endif\nfloat scatteringDiffusionProfile=255.;\n#endif\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); \n#elif defined(PREPASS_COLOR)\ngl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\ngl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\ngl_FragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4(vNormViewDepth,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);\n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\ngl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;\n#endif\n#endif\n#endif\n");const d$j="pbrDebug";bt$1.IncludesShadersStore[d$j]||(bt$1.IncludesShadersStore[d$j]="#if DEBUGMODE>0\nif (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {\n#if DEBUGMODE==1\ngl_FragColor.rgb=vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ngl_FragColor.rgb=vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ngl_FragColor.rgb=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ngl_FragColor.rgb=vec3(vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ngl_FragColor.rgb=vec3(vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ngl_FragColor.rgb=albedoTexture.rgb;\n#ifndef GAMMAALBEDO\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==21 && defined(AMBIENT)\ngl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ngl_FragColor.rgb=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ngl_FragColor.rgb=emissiveColorTex.rgb;\n#ifndef GAMMAEMISSIVE\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ngl_FragColor.rgb=lightmapColor.rgb;\n#ifndef GAMMALIGHTMAP\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ngl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ngl_FragColor.rgb=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ngl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ngl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==32 && defined(BUMP)\ngl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ngl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ngl_FragColor.rgb=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ngl_FragColor.rgb=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ngl_FragColor.rgb=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==60\ngl_FragColor.rgb=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ngl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vec3(reflectivityOut.metallic);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ngl_FragColor.rgb=vec3(roughness);\n#elif DEBUGMODE==64\ngl_FragColor.rgb=vec3(alphaG);\n#elif DEBUGMODE==65\ngl_FragColor.rgb=vec3(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ngl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ngl_FragColor.rgb=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==72\ngl_FragColor.rgb=vec3(microSurface);\n#elif DEBUGMODE==73\ngl_FragColor.rgb=vAlbedoColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vReflectivityColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==75\ngl_FragColor.rgb=vEmissiveColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ngl_FragColor.rgb=vec3(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\ngl_FragColor.rgb=vec3(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ngl_FragColor.rgb=vec3(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=baseSpecularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ngl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ngl_FragColor.rgb=vec3(luminanceOverAlpha);\n#elif DEBUGMODE==87\ngl_FragColor.rgb=vec3(alpha);\n#elif DEBUGMODE==88 && defined(ALBEDO)\ngl_FragColor.rgb=vec3(albedoTexture.a);\n#elif DEBUGMODE==89\ngl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;\n#else\nfloat stripeWidth=30.;float stripePos=floor(gl_FragCoord.x/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);\n#endif\ngl_FragColor.rgb*=vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ngl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ngl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);\n#endif\ngl_FragColor.a=1.0;\n#ifdef PREPASS\ngl_FragData[0]=toLinearSpace(gl_FragColor); \ngl_FragData[1]=vec4(0.,0.,0.,0.); \n#endif\n#ifdef DEBUGMODE_FORCERETURN\nreturn;\n#endif\n}\n#endif\n");const a$E="samplerFragmentDeclaration";bt$1.IncludesShadersStore[a$E]||(bt$1.IncludesShadersStore[a$E]="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\nuniform sampler2D _SAMPLERNAME_Sampler;\n#endif\n");const n$10="bumpFragmentMainFunctions";bt$1.IncludesShadersStore[n$10]||(bt$1.IncludesShadersStore[n$10]="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#if defined(WEBGL2) || defined(WEBGPU)\nmat4 toNormalMatrix(mat4 wMatrix)\n{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}\n#else\nmat4 toNormalMatrix(mat4 m)\n{float\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}\n#endif\n");const t$J="bumpFragmentFunctions";bt$1.IncludesShadersStore[t$J]||(bt$1.IncludesShadersStore[t$J]="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)\n{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n");const r$1b="bumpFragment";bt$1.IncludesShadersStore[r$1b]||(bt$1.IncludesShadersStore[r$1b]="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(BUMP)\nfloat normalScale=vBumpInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(BUMP)\nvec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);\n#else\nvec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n");const n$$="importanceSampling";bt$1.IncludesShadersStore[n$$]||(bt$1.IncludesShadersStore[n$$]="vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDggxAnisotropic(vec2 Xi,float alphaTangent,float alphaBitangent)\n{alphaTangent=max(alphaTangent,0.0001);alphaBitangent=max(alphaBitangent,0.0001);float phi=atan(alphaBitangent/alphaTangent*tan(2.0*3.14159265*Xi.x));if (Xi.x>0.5) phi+=3.14159265; \nfloat cosPhi=cos(phi);float sinPhi=sin(phi);float alpha2=(cosPhi*cosPhi)/(alphaTangent*alphaTangent) +\n(sinPhi*sinPhi)/(alphaBitangent*alphaBitangent);float tanTheta2=Xi.y/(1.0-Xi.y)/alpha2;float cosTheta=1.0/sqrt(1.0+tanTheta2);float sinTheta=sqrt(max(0.0,1.0-cosTheta*cosTheta));return vec3(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}\nvec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { \nfloat phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}");const t$I="hdrFilteringFunctions";bt$1.IncludesShadersStore[t$I]||(bt$1.IncludesShadersStore[t$I]="#if NUM_SAMPLES\n#if NUM_SAMPLES>0\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfloat radicalInverse_VdC(uint bits) \n{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }\nvec2 hammersley(uint i,uint N)\n{return vec2(float(i)/float(N),radicalInverse_VdC(i));}\n#else\nfloat vanDerCorpus(int n,int base)\n{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)\n{if(n>0)\n{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}\nreturn result;}\nvec2 hammersley(int i,int N)\n{return vec2(float(i)/float(N),vanDerCorpus(i,2));}\n#endif\nfloat log4(float x) {return log2(x)/2.;}\nvec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.*PI;float phi=uvRange.y*PI;float sinPhi=sin(phi);N.x=cos(theta)*sinPhi;N.z=sin(theta)*sinPhi;N.y=cos(phi);return N;}\nconst float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;\n#define inline\nvec3 irradiance(\n#ifdef CUSTOM_IRRADIANCE_FILTERING_INPUT\nCUSTOM_IRRADIANCE_FILTERING_INPUT\n#else\nsamplerCube inputTexture,\n#endif\nvec3 inputN,vec2 filteringInfo,\nfloat diffuseRoughness,\nvec3 surfaceAlbedo,\nvec3 inputV\n#if IBL_CDF_FILTERING\n,sampler2D icdfSampler\n#endif\n)\n{vec3 n=normalize(inputN);vec3 result=vec3(0.);\n#ifndef IBL_CDF_FILTERING\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);mat3 tbnInverse=mat3(tangent.x,bitangent.x,n.x,tangent.y,bitangent.y,n.y,tangent.z,bitangent.z,n.z);\n#endif\nfloat maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);\n#if IBL_CDF_FILTERING\nvec2 T;T.x=texture2D(icdfSampler,vec2(Xi.x,0.)).x;T.y=texture2D(icdfSampler,vec2(T.x,Xi.y)).y;vec3 Ls=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));float NoL=dot(n,Ls);float NoV=dot(n,inputV);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nfloat LoV=dot (Ls,inputV);\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\nvec3 H=(inputV+Ls)*0.5;float VoH=dot(inputV,H);\n#endif\n#else\nvec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);float NoL=Ls.z; \nvec3 V=tbnInverse*inputV;float NoV=V.z; \n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nfloat LoV=dot (Ls,V);\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\nvec3 H=(V+Ls)*0.5;float VoH=dot(V,H);\n#endif\n#endif\nif (NoL>0.) {\n#if IBL_CDF_FILTERING\nfloat pdf=texture2D(icdfSampler,T).z;vec3 c=textureCubeLodEXT(inputTexture,Ls,0.).rgb;\n#else\nfloat pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.,maxLevel);\n#ifdef CUSTOM_IRRADIANCE_FILTERING_FUNCTION\nCUSTOM_IRRADIANCE_FILTERING_FUNCTION\n#else\nvec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;\n#endif\n#endif\n#if GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nvec3 diffuseRoughnessTerm=vec3(1.0);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\ndiffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\ndiffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);\n#endif\n#if IBL_CDF_FILTERING\nvec3 light=pdf<1e-6 ? vec3(0.0) : vec3(1.0)/vec3(pdf)*c;result+=NoL*diffuseRoughnessTerm*light;\n#else\nresult+=c*diffuseRoughnessTerm;\n#endif\n}}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nresult=result/clampedAlbedo;\n#endif\nreturn result;}\n#define inline\nvec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; \nif (alphaG==0.) {\n#if GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;\n#if GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}}\n#ifdef ANISOTROPIC\n#define inline\nvec3 radianceAnisotropic(\nfloat alphaTangent, \nfloat alphaBitangent, \nsamplerCube inputTexture,\nvec3 inputView, \nvec3 inputTangent, \nvec3 inputBitangent, \nvec3 inputNormal, \nvec2 filteringInfo,\nvec2 noiseInput \n)\n{vec3 V=inputView;vec3 N=inputNormal;vec3 T=inputTangent;vec3 B=inputBitangent;vec3 R=reflect(-V,N);if (alphaTangent==0. && alphaBitangent==0.) {vec3 c=textureCube(inputTexture,R).rgb;\n#if GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;}\nvec3 result=vec3(0.);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float effectiveDim=dim0*sqrt(alphaTangent*alphaBitangent);float omegaP=(4.*PI)/(6.*effectiveDim*effectiveDim);const float noiseScale=clamp(log2(float(NUM_SAMPLES))/12.0f,0.0f,1.0f);float weight=0.;\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);Xi=fract(Xi+noiseInput*mix(0.5f,0.015f,noiseScale)); \nvec3 H_tangent=hemisphereImportanceSampleDggxAnisotropic(Xi,alphaTangent,alphaBitangent);vec3 H=normalize(H_tangent.x*T+H_tangent.y*B+H_tangent.z*N);vec3 L=normalize(2.0*dot(V,H)*H-V);float NoH=max(dot(N,H),0.001);float VoH=max(dot(V,H),0.001);float NoL=max(dot(N,L),0.001);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_BurleyGGX_Anisotropic(\nH_tangent.z,H_tangent.x,H_tangent.y,vec2(alphaTangent,alphaBitangent)\n);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,L,mipLevel).rgb;\n#if GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}\n#endif\n#endif\n#endif\n");const r$1a="decalFragment";bt$1.IncludesShadersStore[r$1a]||(bt$1.IncludesShadersStore[r$1a]="#ifdef DECAL\n#ifdef GAMMADECAL\ndecalColor.rgb=toLinearSpace(decalColor.rgb);\n#endif\n#ifdef DECAL_SMOOTHALPHA\ndecalColor.a*=decalColor.a;\n#endif\nsurfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);\n#endif\n");const n$_="pbrFragmentDeclaration";bt$1.IncludesShadersStore[n$_]||(bt$1.IncludesShadersStore[n$_]="uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform float baseWeight;uniform float baseDiffuseRoughness;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef BASE_WEIGHT\nuniform vec2 vBaseWeightInfos;\n#endif\n#ifdef BASE_DIFFUSE_ROUGHNESS\nuniform vec2 vBaseDiffuseRoughnessInfos;\n#endif\n#ifdef AMBIENT\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USEIRRADIANCEMAP) && defined(USE_IRRADIANCE_DOMINANT_DIRECTION)\nuniform vec3 vReflectionDominantDirection;\n#endif\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;\n#endif\n#endif\n#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize;\n#endif\n#ifdef CLEARCOAT\nuniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT\nuniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#endif\n#ifdef IRIDESCENCE\nuniform vec4 vIridescenceParams;\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\nuniform vec3 vAnisotropy;\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\nuniform vec4 vSheenColor;\n#ifdef SHEEN_ROUGHNESS\nuniform float vSheenRoughness;\n#endif\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#ifdef REALTIME_FILTERING\nuniform vec2 vRefractionFilteringInfo;\n#endif\n#ifdef SS_DISPERSION\nuniform float dispersion;\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\nuniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nuniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;\n#endif\n#endif\n#ifdef PREPASS\n#ifdef SS_SCATTERING\nuniform float scatteringDiffusionProfile;\n#endif\n#endif\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n");const i$O="samplerFragmentAlternateDeclaration";bt$1.IncludesShadersStore[i$O]||(bt$1.IncludesShadersStore[i$O]="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n#endif\n");const a$D="pbrFragmentSamplersDeclaration";bt$1.IncludesShadersStore[a$D]||(bt$1.IncludesShadersStore[a$D]="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform sampler2D clearCoatRoughnessSampler;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform sampler2D sheenRoughnessSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)\n#endif\n#ifdef IBL_CDF_FILTERING\nuniform sampler2D icdfSampler;\n#endif\n");const r$19="pbrBlockAlbedoOpacity";bt$1.IncludesShadersStore[r$19]||(bt$1.IncludesShadersStore[r$19]="struct albedoOpacityOutParams\n{vec3 surfaceAlbedo;float alpha;};\n#define pbr_inline\nalbedoOpacityOutParams albedoOpacityBlock(\nin vec4 vAlbedoColor\n#ifdef ALBEDO\n,in vec4 albedoTexture\n,in vec2 albedoInfos\n#endif\n,in float baseWeight\n#ifdef BASE_WEIGHT\n,in vec4 baseWeightTexture\n,in vec2 vBaseWeightInfos\n#endif\n#ifdef OPACITY\n,in vec4 opacityMap\n,in vec2 vOpacityInfos\n#endif\n#ifdef DETAIL\n,in vec4 detailColor\n,in vec4 vDetailInfos\n#endif\n#ifdef DECAL\n,in vec4 decalColor\n,in vec4 vDecalInfos\n#endif\n)\n{albedoOpacityOutParams outParams;vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#ifndef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=vColor.rgb;\n#endif\n#ifdef DETAIL\nfloat detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#ifdef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\nsurfaceAlbedo*=baseWeight;\n#ifdef BASE_WEIGHT\nsurfaceAlbedo*=baseWeightTexture.r;\n#endif\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}\n");const f$j="pbrBlockReflectivity";bt$1.IncludesShadersStore[f$j]||(bt$1.IncludesShadersStore[f$j]="struct reflectivityOutParams\n{float microSurface;float roughness;float diffuseRoughness;float reflectanceF0;vec3 reflectanceF90;vec3 colorReflectanceF0;vec3 colorReflectanceF90;\n#ifdef METALLICWORKFLOW\nvec3 surfaceAlbedo;float metallic;float specularWeight;vec3 dielectricColorF0;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nvec3 ambientOcclusionColor;\n#endif\n#if DEBUGMODE>0\n#ifdef METALLICWORKFLOW\n#ifdef REFLECTIVITY\nvec4 surfaceMetallicColorMap;\n#endif\nvec3 metallicF0;\n#else\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nreflectivityOutParams reflectivityBlock(\nin vec4 reflectivityColor\n#ifdef METALLICWORKFLOW\n,in vec3 surfaceAlbedo\n,in vec4 metallicReflectanceFactors\n#endif\n,in float baseDiffuseRoughness\n#ifdef BASE_DIFFUSE_ROUGHNESS\n,in float baseDiffuseRoughnessTexture\n,in vec2 baseDiffuseRoughnessInfos\n#endif\n#ifdef REFLECTIVITY\n,in vec3 reflectivityInfos\n,in vec4 surfaceMetallicOrReflectivityColorMap\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,in vec3 ambientOcclusionColorIn\n#endif\n#ifdef MICROSURFACEMAP\n,in vec4 microSurfaceTexel\n#endif\n#ifdef DETAIL\n,in vec4 detailColor\n,in vec4 vDetailInfos\n#endif\n)\n{reflectivityOutParams outParams;float microSurface=reflectivityColor.a;vec3 surfaceReflectivityColor=reflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;float ior=surfaceReflectivityColor.b;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;outParams.metallic=metallicRoughness.r;outParams.specularWeight=metallicReflectanceFactors.a;float dielectricF0=reflectivityColor.a*outParams.specularWeight;surfaceReflectivityColor=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=vec3(dielectricF0)*surfaceReflectivityColor;\n#endif\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\noutParams.surfaceAlbedo=baseColor.rgb*(vec3(1.0)-vec3(dielectricF0)*surfaceReflectivityColor)*(1.0-outParams.metallic);\n#else\noutParams.surfaceAlbedo=baseColor.rgb;\n#endif\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\n{vec3 reflectivityColor=mix(dielectricF0*surfaceReflectivityColor,baseColor.rgb,outParams.metallic);outParams.reflectanceF0=max(reflectivityColor.r,max(reflectivityColor.g,reflectivityColor.b));}\n#else\n#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF\nfloat maxF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF0=mix(dielectricF0*maxF0,1.0,outParams.metallic);\n#else\noutParams.reflectanceF0=mix(dielectricF0,1.0,outParams.metallic);\n#endif\n#endif\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\noutParams.reflectanceF90=vec3(outParams.specularWeight);float f90Scale=1.0;\n#else\nfloat f90Scale=clamp(2.0*(ior-1.0),0.0,1.0);outParams.reflectanceF90=vec3(mix(outParams.specularWeight*f90Scale,1.0,outParams.metallic));\n#endif\noutParams.dielectricColorF0=vec3(dielectricF0*surfaceReflectivityColor);vec3 metallicColorF0=baseColor.rgb;outParams.colorReflectanceF0=mix(outParams.dielectricColorF0,metallicColorF0,outParams.metallic);\n#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)\nvec3 dielectricColorF90=surfaceReflectivityColor*vec3(outParams.specularWeight)*vec3(f90Scale);\n#else\nvec3 dielectricColorF90=vec3(outParams.specularWeight*f90Scale);\n#endif\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\nvec3 conductorColorF90=surfaceReflectivityColor;\n#else\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\nvec3 conductorColorF90=outParams.reflectanceF90;\n#else\nvec3 conductorColorF90=vec3(1.0);\n#endif\n#endif\noutParams.colorReflectanceF90=mix(dielectricColorF90,conductorColorF90,outParams.metallic);\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\noutParams.colorReflectanceF0=surfaceReflectivityColor;outParams.reflectanceF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF90=vec3(1.0);\n#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)\noutParams.colorReflectanceF90=surfaceReflectivityColor;\n#else\noutParams.colorReflectanceF90=vec3(1.0);\n#endif\n#endif\nmicroSurface=saturate(microSurface);float roughness=1.-microSurface;float diffuseRoughness=baseDiffuseRoughness;\n#ifdef BASE_DIFFUSE_ROUGHNESS\ndiffuseRoughness*=baseDiffuseRoughnessTexture*baseDiffuseRoughnessInfos.y;\n#endif\noutParams.microSurface=microSurface;outParams.roughness=roughness;outParams.diffuseRoughness=diffuseRoughness;return outParams;}\n");const o$O="pbrBlockAmbientOcclusion";bt$1.IncludesShadersStore[o$O]||(bt$1.IncludesShadersStore[o$O]="struct ambientOcclusionOutParams\n{vec3 ambientOcclusionColor;\n#if DEBUGMODE>0 && defined(AMBIENT)\nvec3 ambientOcclusionColorMap;\n#endif\n};ambientOcclusionOutParams ambientOcclusionBlock(\n#ifdef AMBIENT\nin vec3 ambientOcclusionColorMap_,\nin vec4 vAmbientInfos\n#endif\n)\n{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}\n");const t$H="pbrBlockAlphaFresnel";bt$1.IncludesShadersStore[t$H]||(bt$1.IncludesShadersStore[t$H]="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{float alpha;};\n#define pbr_inline\nalphaFresnelOutParams alphaFresnelBlock(\nin vec3 normalW,\nin vec3 viewDirectionW,\nin float alpha,\nin float microSurface\n)\n{alphaFresnelOutParams outParams;float opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\nreturn outParams;}\n#endif\n#endif\n");const c$f="pbrBlockAnisotropic";bt$1.IncludesShadersStore[c$f]||(bt$1.IncludesShadersStore[c$f]="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;\n#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)\nvec3 anisotropyMapData;\n#endif\n};\n#define pbr_inline\nanisotropicOutParams anisotropicBlock(\nin vec3 vAnisotropy,\nin float roughness,\n#ifdef ANISOTROPIC_TEXTURE\nin vec3 anisotropyMapData,\n#endif\nin mat3 TBN,\nin vec3 normalW,\nin vec3 viewDirectionW\n)\n{anisotropicOutParams outParams;float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nanisotropy*=anisotropyMapData.b;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\nanisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;\n#ifdef ANISOTROPIC_LEGACY\nanisotropyDirection.rg*=anisotropyMapData.rg;\n#else\nanisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);\n#endif\n#endif\nmat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}\n#endif\n");const l$f="pbrBlockReflection";bt$1.IncludesShadersStore[l$f]||(bt$1.IncludesShadersStore[l$f]="#ifdef REFLECTION\nstruct reflectionOutParams\n{vec4 environmentRadiance;vec3 environmentIrradiance;\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords;\n#else\nvec2 reflectionCoords;\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nvec3 irradianceVector;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid createReflectionCoords(\nin vec3 vPositionW,\nin vec3 normalW,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REFLECTIONMAP_3D\nout vec3 reflectionCoords\n#else\nout vec2 reflectionCoords\n#endif\n)\n{\n#ifdef ANISOTROPIC\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n}\n#define pbr_inline\n#define inline\nvoid sampleReflectionTexture(\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nconst vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nconst vec2 reflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout vec4 environmentRadiance\n)\n{\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);} else {environmentRadiance=mix(\nenvironmentMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nenvironmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}\n#define pbr_inline\n#define inline\nreflectionOutParams reflectionBlock(\nin vec3 vPositionW\n,in vec3 normalW\n,in float alphaG\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in vec3 vReflectionColor\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,in float NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,in float roughness\n#endif\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n#else\n,in sampler2D reflectionSampler\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,in vec3 vEnvironmentIrradiance\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,in mat4 reflectionMatrix\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,in samplerCube irradianceSampler\n#else\n,in sampler2D irradianceSampler\n#endif\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\n,in vec3 reflectionDominantDirection\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSamplerLow\n,in samplerCube reflectionSamplerHigh\n#else\n,in sampler2D reflectionSamplerLow\n,in sampler2D reflectionSamplerHigh\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,in sampler2D icdfSampler\n#endif\n#endif\n,in vec3 viewDirectionW\n,in float diffuseRoughness\n,in vec3 surfaceAlbedo\n)\n{reflectionOutParams outParams;vec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.);\n#else\nvec2 reflectionCoords=vec2(0.);\n#endif\ncreateReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\nreflectionCoords\n);sampleReflectionTexture(\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionSampler,\nreflectionCoords,\n#else\nreflectionSampler,\nreflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentRadiance\n);vec3 environmentIrradiance=vec3(0.,0.,0.);\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n#ifdef ANISOTROPIC\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#endif\nvec3 irradianceView=vec3(reflectionMatrix*vec4(viewDirectionW,0)).xyz;\n#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)\n#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY\nfloat NdotV=max(dot(normalW,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);\n#endif\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,irradianceVector);\n#else\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);\n#endif\nenvironmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\nvec3 Ls=normalize(reflectionDominantDirection);float NoL=dot(irradianceVector,Ls);float NoV=dot(irradianceVector,irradianceView);vec3 diffuseRoughnessTerm=vec3(1.0);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nfloat LoV=dot (Ls,irradianceView);float mag=length(reflectionDominantDirection)*2.0;vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0)));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\nvec3 H=(irradianceView+Ls)*0.5;float VoH=dot(irradianceView,H);diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);\n#endif\nenvironmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb*vReflectionInfos.x;\n#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE\noutParams.environmentRadiance=vec4(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);\n#else\noutParams.environmentRadiance=environmentRadiance;\n#endif\noutParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}\n#endif\n");const d$i="pbrBlockSheen";bt$1.IncludesShadersStore[d$i]||(bt$1.IncludesShadersStore[d$i]="#ifdef SHEEN\nstruct sheenOutParams\n{float sheenIntensity;vec3 sheenColor;float sheenRoughness;\n#ifdef SHEEN_LINKWITHALBEDO\nvec3 surfaceAlbedo;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfloat sheenAlbedoScaling;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 finalSheenRadianceScaled;\n#endif\n#if DEBUGMODE>0\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 sheenEnvironmentReflectance;\n#endif\n#endif\n};\n#define pbr_inline\n#define inline\nsheenOutParams sheenBlock(\nin vec4 vSheenColor\n#ifdef SHEEN_ROUGHNESS\n,in float vSheenRoughness\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,in vec4 sheenMapRoughnessData\n#endif\n#endif\n,in float roughness\n#ifdef SHEEN_TEXTURE\n,in vec4 sheenMapData\n,in float sheenMapLevel\n#endif\n,in float reflectance\n#ifdef SHEEN_LINKWITHALBEDO\n,in vec3 baseColor\n,in vec3 surfaceAlbedo\n#endif\n#ifdef ENVIRONMENTBRDF\n,in float NdotV\n,in vec3 environmentBrdf\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,in vec2 AARoughnessFactors\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in vec3 vReflectionColor\n,in vec4 vLightingIntensity\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n,in vec3 reflectionCoords\n#else\n,in sampler2D reflectionSampler\n,in vec2 reflectionCoords\n#endif\n,in float NdotVUnclamped\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSamplerLow\n,in samplerCube reflectionSamplerHigh\n#else\n,in sampler2D reflectionSamplerLow\n,in sampler2D reflectionSamplerHigh\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,in float seo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,in float eho\n#endif\n#endif\n)\n{sheenOutParams outParams;float sheenIntensity=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nfloat sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvec3 sheenColor=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor.rgb*=toLinearSpace(sheenMapData.rgb);\n#else\nsheenColor.rgb*=sheenMapData.rgb;\n#endif\nsheenColor.rgb*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nfloat sheenRoughness=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#else\nfloat sheenRoughness=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvec3 environmentSheenBrdf=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nfloat sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(\nsheenAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nsheenRoughness,\n#endif\nreflectionSampler,\nreflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentSheenRadiance\n);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}\n#endif\n");const s$h="pbrBlockClearcoat";bt$1.IncludesShadersStore[s$h]||(bt$1.IncludesShadersStore[s$h]="struct clearcoatOutParams\n{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;\n#ifdef REFLECTION\nvec3 finalClearCoatRadianceScaled;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nvec3 energyConservationFactorClearCoat;\n#endif\n#if DEBUGMODE>0\n#ifdef CLEARCOAT_BUMP\nmat3 TBNClearCoat;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData;\n#endif\n#ifdef REFLECTION\nvec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;\n#endif\nfloat clearCoatNdotV;\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\n#define inline\nclearcoatOutParams clearcoatBlock(\nin vec3 vPositionW\n,in vec3 geometricNormalW\n,in vec3 viewDirectionW\n,in vec2 vClearCoatParams\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,in vec4 clearCoatMapRoughnessData\n#endif\n,in vec3 specularEnvironmentR0\n#ifdef CLEARCOAT_TEXTURE\n,in vec2 clearCoatMapData\n#endif\n#ifdef CLEARCOAT_TINT\n,in vec4 vClearCoatTintParams\n,in float clearCoatColorAtDistance\n,in vec4 vClearCoatRefractionParams\n#ifdef CLEARCOAT_TINT_TEXTURE\n,in vec4 clearCoatTintMapData\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,in vec2 vClearCoatBumpInfos\n,in vec4 clearCoatBumpMapData\n,in vec2 vClearCoatBumpUV\n#if defined(TANGENT) && defined(NORMAL)\n,in mat3 vTBN\n#else\n,in vec2 vClearCoatTangentSpaceParams\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,in mat4 normalMatrix\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,in vec3 faceNormal\n#endif\n#ifdef REFLECTION\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in vec3 vReflectionColor\n,in vec4 vLightingIntensity\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n#else\n,in sampler2D reflectionSampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSamplerLow\n,in samplerCube reflectionSamplerHigh\n#else\n,in sampler2D reflectionSamplerLow\n,in sampler2D reflectionSamplerHigh\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,in float frontFacingMultiplier\n#endif\n)\n{clearcoatOutParams outParams;float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvec3 specularEnvironmentR0Updated=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nfloat clearCoatNormalScale=1.0;\n#else\nfloat clearCoatNormalScale=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBNClearCoat=vTBN;\n#else\nvec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nfloat clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 clearCoatReflectionCoords=clearCoatReflectionVector;\n#else\nvec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nsampleReflectionTexture(\nclearCoatAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nclearCoatNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nclearCoatRoughness,\n#endif\nreflectionSampler,\nclearCoatReflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentClearCoatRadiance\n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nfloat fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\nreturn outParams;}\n#endif\n");const E$g="pbrBlockIridescence";bt$1.IncludesShadersStore[E$g]||(bt$1.IncludesShadersStore[E$g]="struct iridescenceOutParams\n{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};\n#ifdef IRIDESCENCE\n#define pbr_inline\n#define inline\niridescenceOutParams iridescenceBlock(\nin vec4 vIridescenceParams\n,in float viewAngle\n,in vec3 specularEnvironmentR0\n#ifdef IRIDESCENCE_TEXTURE\n,in vec2 iridescenceMapData\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,in vec2 iridescenceThicknessMapData\n#endif\n#ifdef CLEARCOAT\n,in float NdotVUnclamped\n,in vec2 vClearCoatParams\n#ifdef CLEARCOAT_TEXTURE\n,in vec2 clearCoatMapData\n#endif\n#endif\n)\n{iridescenceOutParams outParams;float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nfloat iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; \n#ifdef CLEARCOAT\nfloat clearCoatIntensity=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));\n#endif\nvec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}\n#endif\n");const R$b="pbrBlockSubSurface";bt$1.IncludesShadersStore[R$b]||(bt$1.IncludesShadersStore[R$b]="struct subSurfaceOutParams\n{vec3 specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvec3 finalRefraction;vec3 surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nfloat alpha;\n#endif\nfloat refractionOpacity;\n#endif\n#ifdef SS_TRANSLUCENCY\nvec3 transmittance;float translucencyIntensity;\n#ifdef REFLECTION\nvec3 refractionIrradiance;\n#endif\n#endif\n#if DEBUGMODE>0\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction;vec3 refractionTransmittance;\n#endif\n#endif\n};\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#define pbr_inline\n#define inline\nvec4 sampleEnvironmentRefraction(\nin float ior\n,in float thickness\n,in float refractionLOD\n,in vec3 normalW\n,in vec3 vPositionW\n,in vec3 viewDirectionW\n,in mat4 view\n,in vec4 vRefractionInfos\n,in mat4 refractionMatrix\n,in vec4 vRefractionMicrosurfaceInfos\n,in float alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,in samplerCube refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in samplerCube refractionSamplerLow\n,in samplerCube refractionSamplerHigh\n#endif\n#else\n,in sampler2D refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in sampler2D refractionSamplerLow\n,in sampler2D refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,in vec3 refractionPosition\n,in vec3 refractionSize\n#endif\n) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);\n#else\nvec3 refractionVector=refract(-viewDirectionW,normalW,ior);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\n#endif\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODBASEDMICROSFURACE\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nfloat lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);} else {environmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef SS_RGBDREFRACTION\nenvironmentRefraction.rgb=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nenvironmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);\n#endif\nreturn environmentRefraction;}\n#endif\n#define pbr_inline\n#define inline\nsubSurfaceOutParams subSurfaceBlock(\nin vec3 vSubSurfaceIntensity\n,in vec2 vThicknessParam\n,in vec4 vTintColor\n,in vec3 normalW\n,in vec3 vSpecularEnvironmentReflectance\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,in vec4 thicknessMap\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,in vec4 refractionIntensityMap\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,in vec4 translucencyIntensityMap\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,in mat4 reflectionMatrix\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,in vec3 irradianceVector_\n#endif\n#if defined(REALTIME_FILTERING)\n,in samplerCube reflectionSampler\n,in vec2 vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,in sampler2D icdfSampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,in samplerCube irradianceSampler\n#else\n,in sampler2D irradianceSampler\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,in vec3 surfaceAlbedo\n#endif\n#ifdef SS_REFRACTION\n,in vec3 vPositionW\n,in vec3 viewDirectionW\n,in mat4 view\n,in vec4 vRefractionInfos\n,in mat4 refractionMatrix\n,in vec4 vRefractionMicrosurfaceInfos\n,in vec4 vLightingIntensity\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,in float alpha\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,in float NdotVUnclamped\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,in float roughness\n#endif\n,in float alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,in samplerCube refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in samplerCube refractionSamplerLow\n,in samplerCube refractionSamplerHigh\n#endif\n#else\n,in sampler2D refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in sampler2D refractionSamplerLow\n,in sampler2D refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,in vec3 refractionPosition\n,in vec3 refractionSize\n#endif\n#ifdef SS_DISPERSION\n,in float dispersion\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,in vec3 vDiffusionDistance\n,in vec4 vTranslucencyColor\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,in vec4 translucencyColorMap\n#endif\n#endif\n)\n{subSurfaceOutParams outParams;outParams.specularEnvironmentReflectance=vSpecularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nfloat refractionIntensity=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);outParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nfloat translucencyIntensity=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nfloat thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nfloat thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=thicknessMap.a;\n#else\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nfloat thickness=vThicknessParam.y;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=translucencyIntensityMap.a;\n#else\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\ntranslucencyColor*=translucencyColorMap;\n#endif\nvec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef SS_HAS_THICKNESS\nfloat ior=vRefractionInfos.y;\n#else\nfloat ior=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nfloat refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\nfloat refraction_ior=vRefractionInfos.y;\n#ifdef SS_DISPERSION\nfloat realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];\n#endif\nvec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#else\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition\n,refractionSize\n#endif\n);\n#ifdef SS_DISPERSION\nenvironmentRefraction[i]=envSample[i];}\n#else\nenvironmentRefraction=envSample;\n#endif\nenvironmentRefraction.rgb*=vRefractionInfos.x;\n#endif\n#ifdef SS_REFRACTION\nvec3 refractionTransmittance=vec3(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nfloat maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;\n#else\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.refractionOpacity=1.-refractionIntensity;\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\noutParams.surfaceAlbedo*=outParams.refractionOpacity;\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvec3 bounceSpecularEnvironmentReflectance=(2.0*vSpecularEnvironmentReflectance)/(1.0+vSpecularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,vSpecularEnvironmentReflectance,refractionIntensity);\n#endif\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;outParams.finalRefraction*=vec3(1.0)-vSpecularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvec3 irradianceVector=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo,0.0,surfaceAlbedo,irradianceVector\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n);\n#else\nvec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec3 irradianceCoords=irradianceVector;\n#else\nvec2 irradianceCoords=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);\n#ifdef RGBDREFLECTION\nrefractionIrradiance.rgb=fromRGBD(refractionIrradiance);\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);\n#endif\n#else\nvec4 refractionIrradiance=vec4(0.);\n#endif\nrefractionIrradiance.rgb*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance.rgb;\n#endif\nreturn outParams;}\n#endif\n");const C$b="pbrBlockReflectance0";bt$1.IncludesShadersStore[C$b]||(bt$1.IncludesShadersStore[C$b]="float reflectanceF0=reflectivityOut.reflectanceF0;vec3 specularEnvironmentR0=reflectivityOut.colorReflectanceF0;vec3 specularEnvironmentR90=reflectivityOut.colorReflectanceF90;\n#ifdef ALPHAFRESNEL\nfloat reflectance90=fresnelGrazingReflectance(reflectanceF0);specularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n");const u$h="pbrClusteredLightingFunctions";bt$1.IncludesShadersStore[u$h]||(bt$1.IncludesShadersStore[u$h]="#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\n#include<clusteredLightingFunctions>\n#define inline\nlightingInfo computeClusteredLighting(\nsampler2D lightDataTexture,\nsampler2D tileMaskTexture,\nvec4 lightData,\nivec2 sliceRange,\nvec3 V,\nvec3 N,\nvec3 posW,\nvec3 surfaceAlbedo,\nreflectivityOutParams reflectivityOut\n#ifdef IRIDESCENCE\n,float iridescenceIntensity\n#endif\n#ifdef SS_TRANSLUCENCY\n,subSurfaceOutParams subSurfaceOut\n#endif\n#ifdef SPECULARTERM\n,float AARoughnessFactor\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOutParams anisotropicOut\n#endif\n#ifdef SHEEN\n,sheenOutParams sheenOut\n#endif\n#ifdef CLEARCOAT\n,clearcoatOutParams clearcoatOut\n#endif\n) {float NdotV=absEps(dot(N,V));\n#include<pbrBlockReflectance0>\n#ifdef CLEARCOAT\nspecularEnvironmentR0=clearcoatOut.specularEnvironmentR0;\n#endif\nlightingInfo result;ivec2 tilePosition=ivec2(gl_FragCoord.xy*lightData.xy);int maskHeight=int(lightData.z);tilePosition.y=min(tilePosition.y,maskHeight-1);ivec2 batchRange=sliceRange/CLUSTLIGHT_BATCH;int batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tilePosition.y+=maskHeight*batchRange.x;for (int i=batchRange.x; i<=batchRange.y; i+=1) {uint mask=uint(texelFetch(tileMaskTexture,tilePosition,0).r);tilePosition.y+=maskHeight;int maskOffset=max(sliceRange.x-batchOffset,0);int maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while (mask != 0u) {uint bit=mask & -mask;mask ^= bit;int position=onlyBitPosition(bit);ClusteredLight light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+position);preLightingInfo preInfo=computePointAndSpotPreLightingInfo(light.vLightData,V,N,posW);preInfo.NdotV=NdotV;preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light.vLightFalloff.x,light.vLightFalloff.y);if (light.vLightDirection.w>=0.0) {preInfo.attenuation*=computeDirectionalLightFalloff(light.vLightDirection.xyz,preInfo.L,light.vLightDirection.w,light.vLightData.w,light.vLightFalloff.z,light.vLightFalloff.w);}\npreInfo.roughness=adjustRoughnessFromLightProperties(reflectivityOut.roughness,light.vLightSpecular.a,preInfo.lightDistance);preInfo.diffuseRoughness=reflectivityOut.diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\nlightingInfo info;\n#ifdef SS_TRANSLUCENCY\n#ifdef SS_TRANSLUCENCY_LEGACY\ninfo.diffuse=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);info.diffuseTransmission=vec3(0);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);\n#endif\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb);\n#endif\n#ifdef SPECULARTERM\n#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR\nvec3 metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricFresnel=fresnelSchlickGGX(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);vec3 coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);\n#else\nvec3 coloredFresnel=fresnelSchlickGGX(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90);\n#endif\n#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION\nfloat NdotH=dot(N,preInfo.H);vec3 fresnel=fresnelSchlickGGX(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);\n#endif\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,V,N,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,N,specularEnvironmentR0,coloredFresnel,AARoughnessFactor,light.vLightDiffuse.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);\n#endif\n#ifdef CLEARCOAT\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light.vLightSpecular.a,preInfo.lightDistance);info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light.vLightDiffuse.rgb);\n#ifdef CLEARCOAT_TINT\nfloat absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission*=absorption;\n#endif\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SS_TRANSLUCENCY\ninfo.diffuseTransmission*=info.clearCoat.w;\n#endif\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\nresult.diffuse+=info.diffuse;\n#ifdef SS_TRANSLUCENCY\nresult.diffuseTransmission+=info.diffuseTransmission;\n#endif\n#ifdef SPECULARTERM\nresult.specular+=info.specular;\n#endif\n#ifdef CLEARCOAT\nresult.clearCoat+=info.clearCoat;\n#endif\n#ifdef SHEEN\nresult.sheen+=info.sheen;\n#endif\n}\nbatchOffset+=CLUSTLIGHT_BATCH;}\nreturn result;}\n#endif\n");const S$8="pbrBlockNormalFinal";bt$1.IncludesShadersStore[S$8]||(bt$1.IncludesShadersStore[S$8]="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\n#if defined(MIRRORED)\nnormalW=gl_FrontFacing ? -normalW : normalW;\n#else\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#endif\n");const m$l="pbrBlockLightmapInit";bt$1.IncludesShadersStore[m$l]||(bt$1.IncludesShadersStore[m$l]="#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor.rgb=toLinearSpace(lightmapColor.rgb);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n");const A$b="pbrBlockGeometryInfo";bt$1.IncludesShadersStore[A$b]||(bt$1.IncludesShadersStore[A$b]="float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvec3 environmentBrdf=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=aoOut.ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n");const I$c="pbrBlockReflectance";bt$1.IncludesShadersStore[I$c]||(bt$1.IncludesShadersStore[I$c]="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 baseSpecularEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(reflectanceF0),reflectivityOut.reflectanceF90,environmentBrdf);\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\nvec3 metalEnvironmentReflectance=reflectivityOut.specularWeight*getF82Specular(NdotV,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricEnvironmentReflectance=getReflectanceFromBRDFLookup(reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90,environmentBrdf);vec3 colorSpecularEnvironmentReflectance=mix(dielectricEnvironmentReflectance,metalEnvironmentReflectance,reflectivityOut.metallic);\n#else\nvec3 colorSpecularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,environmentBrdf);\n#endif\n#ifdef RADIANCEOCCLUSION\ncolorSpecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\ncolorSpecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvec3 colorSpecularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));vec3 baseSpecularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,vec3(reflectanceF0),reflectivityOut.reflectanceF90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\ncolorSpecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\ncolorSpecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n");const v$a="pbrBlockDirectLighting";bt$1.IncludesShadersStore[v$a]||(bt$1.IncludesShadersStore[v$a]="vec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SS_TRANSLUCENCY\nvec3 diffuseTransmissionBase=vec3(0.,0.,0.);\n#endif\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatBase=vec3(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvec3 sheenBase=vec3(0.,0.,0.);\n#endif\n#if defined(SPECULARTERM) && defined(LIGHT0)\nvec3 coloredFresnel;\n#endif\npreLightingInfo preInfo;lightingInfo info;float shadow=1.; \nfloat aggShadow=0.;float numLights=0.;\n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvec3 absorption=vec3(0.);\n#endif\n");const N$9="pbrBlockFinalLitComponents";bt$1.IncludesShadersStore[N$9]||(bt$1.IncludesShadersStore[N$9]="aggShadow=aggShadow/numLights;\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 baseSpecularEnergyConservationFactor=getEnergyConservationFactor(vec3(reflectanceF0),environmentBrdf);vec3 coloredEnergyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo.rgb=(1.-reflectanceF0)*surfaceAlbedo.rgb;\n#endif\n#endif\n#endif\n#ifdef REFLECTION\nvec3 finalIrradiance=reflectionOut.environmentIrradiance;\n#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION\n#if defined(METALLICWORKFLOW) || defined(SPECULAR_GLOSSINESS_ENERGY_CONSERVATION)\nvec3 baseSpecularEnergy=vec3(baseSpecularEnvironmentReflectance);\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nbaseSpecularEnergy*=baseSpecularEnergyConservationFactor;\n#endif\n#endif\nfinalIrradiance*=clamp(vec3(1.0)-baseSpecularEnergy,0.0,1.0);\n#endif\n#endif\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#ifndef SS_APPLY_ALBEDO_AFTER_SUBSURFACE\nfinalIrradiance*=surfaceAlbedo.rgb;\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionOpacity;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\n#ifdef SS_APPLY_ALBEDO_AFTER_SUBSURFACE\nfinalIrradiance*=surfaceAlbedo.rgb;\n#endif\nfinalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=coloredEnergyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=colorSpecularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=coloredEnergyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n");const T$a="pbrBlockFinalUnlitComponents";bt$1.IncludesShadersStore[T$a]||(bt$1.IncludesShadersStore[T$a]="vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo;\n#if defined(SS_REFRACTION) && !defined(UNLIT) && !defined(LEGACY_SPECULAR_ENERGY_CONSERVATION)\nfinalDiffuse*=subSurfaceOut.refractionOpacity;\n#endif\n#if defined(SS_TRANSLUCENCY) && !defined(UNLIT)\nfinalDiffuse+=diffuseTransmissionBase;\n#endif\nfinalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= vEmissiveInfos.y;\n#endif\nfinalEmissive*=vLightingIntensity.y;\n#ifdef AMBIENT\nvec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);\n#else\nvec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;\n");const O$d="pbrBlockFinalColorComposition";bt$1.IncludesShadersStore[O$d]||(bt$1.IncludesShadersStore[O$d]="vec4 finalColor=vec4(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor.rgb;\n#else\nfinalColor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\nfinalColor.rgb+=finalEmissive;\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,0.0);\n");const p$j="pbrPixelShader",L$5="#define PBR_FRAGMENT_SHADER\n#define CUSTOM_FRAGMENT_EXTENSION\n#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#if SCENE_MRT_COUNT>0\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#endif\nprecision highp float;\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<__decl__pbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\n#include<pbrClusteredLightingFunctions>\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nalbedoOpacityOutParams albedoOpacityOut;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#endif\n#ifdef BASE_WEIGHT\nvec4 baseWeightTexture=texture2D(baseWeightSampler,vBaseWeightUV+uvOffset);\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#endif\nalbedoOpacityOut=albedoOpacityBlock(\nvAlbedoColor\n#ifdef ALBEDO\n,albedoTexture\n,vAlbedoInfos\n#endif\n,baseWeight\n#ifdef BASE_WEIGHT\n,baseWeightTexture\n,vBaseWeightInfos\n#endif\n#ifdef OPACITY\n,opacityMap\n,vOpacityInfos\n#endif\n#ifdef DETAIL\n,detailColor\n,vDetailInfos\n#endif\n#ifdef DECAL\n,decalColor\n,vDecalInfos\n#endif\n);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;\n#endif\naoOut=ambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nvAmbientInfos\n#endif\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else \nvec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;\n#if defined(REFLECTIVITY)\nvec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvec4 metallicReflectanceFactors=vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;\n#endif\n#ifdef METALLIC_REFLECTANCE\nvec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;\n#endif\nmetallicReflectanceFactors.a*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\n#ifdef BASE_DIFFUSE_ROUGHNESS\nfloat baseDiffuseRoughnessTexture=texture2D(baseDiffuseRoughnessSampler,vBaseDiffuseRoughnessUV+uvOffset).r;\n#endif\nreflectivityOut=reflectivityBlock(\nvReflectivityColor\n#ifdef METALLICWORKFLOW\n,surfaceAlbedo\n,metallicReflectanceFactors\n#endif\n,baseDiffuseRoughness\n#ifdef BASE_DIFFUSE_ROUGHNESS\n,baseDiffuseRoughnessTexture\n,vBaseDiffuseRoughnessInfos\n#endif\n#ifdef REFLECTIVITY\n,vReflectivityInfos\n,surfaceMetallicOrReflectivityColorMap\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,aoOut.ambientOcclusionColor\n#endif\n#ifdef MICROSURFACEMAP\n,microSurfaceTexel\n#endif\n#ifdef DETAIL\n,detailColor\n,vDetailInfos\n#endif\n);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;float diffuseRoughness=reflectivityOut.diffuseRoughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nalphaFresnelOutParams alphaFresnelOut;alphaFresnelOut=alphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface\n);alpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nanisotropicOutParams anisotropicOut;\n#ifdef ANISOTROPIC_TEXTURE\nvec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;\n#endif\nanisotropicOut=anisotropicBlock(\nvAnisotropy,\nroughness,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW\n);\n#endif\n#ifdef REFLECTION\nreflectionOutParams reflectionOut;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionOut=reflectionBlock(\nvPositionW\n,normalW\n,alphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness\n#endif\n,reflectionSampler\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,vEnvironmentIrradiance\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,reflectionMatrix\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\n,vReflectionDominantDirection\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n,reflectionSamplerLow\n,reflectionSamplerHigh\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n#endif\n,viewDirectionW\n,diffuseRoughness\n,baseColor\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nsheenOutParams sheenOut;\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;\n#endif\nsheenOut=sheenBlock(\nvSheenColor\n#ifdef SHEEN_ROUGHNESS\n,vSheenRoughness\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,sheenMapRoughnessData\n#endif\n#endif\n,roughness\n#ifdef SHEEN_TEXTURE\n,sheenMapData\n,vSheenInfos.y\n#endif\n,reflectanceF0\n#ifdef SHEEN_LINKWITHALBEDO\n,baseColor\n,surfaceAlbedo\n#endif\n#ifdef ENVIRONMENTBRDF\n,NdotV\n,environmentBrdf\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,AARoughnessFactors\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n,vLightingIntensity\n,reflectionSampler\n,reflectionOut.reflectionCoords\n,NdotVUnclamped\n#ifndef LODBASEDMICROSFURACE\n,reflectionSamplerLow\n,reflectionSamplerHigh\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,seo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,eho\n#endif\n#endif\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\niridescenceOutParams iridescenceOut;\n#ifdef IRIDESCENCE_TEXTURE\nvec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;\n#endif\niridescenceOut=iridescenceBlock(\nvIridescenceParams\n,NdotV\n,specularEnvironmentR0\n#ifdef IRIDESCENCE_TEXTURE\n,iridescenceMapData\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,iridescenceThicknessMapData\n#endif\n#ifdef CLEARCOAT\n,NdotVUnclamped\n,vClearCoatParams\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#endif\n);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nclearcoatOutParams clearcoatOut;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatOut=clearcoatBlock(\nvPositionW\n,geometricNormalW\n,viewDirectionW\n,vClearCoatParams\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,clearCoatMapRoughnessData\n#endif\n,specularEnvironmentR0\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#ifdef CLEARCOAT_TINT\n,vClearCoatTintParams\n,clearCoatColorAtDistance\n,vClearCoatRefractionParams\n#ifdef CLEARCOAT_TINT_TEXTURE\n,clearCoatTintMapData\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,vClearCoatBumpInfos\n,clearCoatBumpMapData\n,vClearCoatBumpUV\n#if defined(TANGENT) && defined(NORMAL)\n,vTBN\n#else\n,vClearCoatTangentSpaceParams\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,normalMatrix\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,faceNormal\n#endif\n#ifdef REFLECTION\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n,vLightingIntensity\n,reflectionSampler\n#ifndef LODBASEDMICROSFURACE\n,reflectionSamplerLow\n,reflectionSamplerHigh\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,(gl_FrontFacing ? 1. : -1.)\n#endif\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nsubSurfaceOutParams subSurfaceOut;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nvec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA\ntranslucencyColorMap=toLinearSpace(translucencyColorMap);\n#endif\n#endif\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\nvec3 vSpecularEnvironmentReflectance=vec3(max(colorSpecularEnvironmentReflectance.r,max(colorSpecularEnvironmentReflectance.g,colorSpecularEnvironmentReflectance.b)));\n#endif\nsubSurfaceOut=subSurfaceBlock(\nvSubSurfaceIntensity\n,vThicknessParam\n,vTintColor\n,normalW\n#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION\n,vSpecularEnvironmentReflectance\n#else\n,baseSpecularEnvironmentReflectance\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,thicknessMap\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,refractionIntensityMap\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,translucencyIntensityMap\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,reflectionMatrix\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,reflectionOut.irradianceVector\n#endif\n#if defined(REALTIME_FILTERING)\n,reflectionSampler\n,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,surfaceAlbedo\n#endif\n#ifdef SS_REFRACTION\n,vPositionW\n,viewDirectionW\n,view\n,vRefractionInfos\n,refractionMatrix\n,vRefractionMicrosurfaceInfos\n,vLightingIntensity\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,alpha\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,NdotVUnclamped\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,roughness\n#endif\n,alphaG\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,vRefractionPosition\n,vRefractionSize\n#endif\n#ifdef SS_DISPERSION\n,dispersion\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,vDiffusionDistance\n,vTranslucencyColor\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,translucencyColorMap\n#endif\n#endif\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=colorSpecularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#include<pbrBlockPrePass>\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStore[p$j]||(bt$1.ShadersStore[p$j]=L$5);const _$e={name:p$j,shader:L$5};var pbr_fragmentC9RmUGFO_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,pbrPixelShader:_$e});const r$18="glowBlurPostProcessPixelShader",t$G="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform direction: vec2f;uniform blurWidth: f32;fn getLuminance(color: vec3f)->f32\n{return dot(color, vec3f(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var weights: array<f32 ,7>;weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;var texelSize: vec2f= vec2f(1.0/uniforms.screenSize.x,1.0/uniforms.screenSize.y);var texelStep: vec2f=texelSize*uniforms.direction*uniforms.blurWidth;var start: vec2f=input.vUV-3.0*texelStep;var baseColor: vec4f= vec4f(0.,0.,0.,0.);var texelOffset: vec2f= vec2f(0.,0.);for (var i: i32=0; i<7; i++)\n{var texel: vec4f=textureSample(textureSampler,textureSamplerSampler,start+texelOffset);baseColor=vec4f(baseColor.rgb,baseColor.a+texel.a*weights[i]);var luminance: f32=getLuminance(baseColor.rgb);var luminanceTexel: f32=getLuminance(texel.rgb);var choice: f32=step(luminanceTexel,luminance);baseColor=vec4f(choice*baseColor.rgb+(1.0-choice)*texel.rgb,baseColor.a);texelOffset+=texelStep;}\nfragmentOutputs.color=baseColor;}";bt$1.ShadersStoreWGSL[r$18]||(bt$1.ShadersStoreWGSL[r$18]=t$G);const a$C={name:r$18,shader:t$G};var glowBlurPostProcess_fragmentCe2UszEv_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,glowBlurPostProcessPixelShaderWGSL:a$C});const t$F="glowBlurPostProcessPixelShader",r$17="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)\n{return dot(color,vec3(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)\n{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}\ngl_FragColor=baseColor;}";bt$1.ShadersStore[t$F]||(bt$1.ShadersStore[t$F]=r$17);const i$N={name:t$F,shader:r$17};var glowBlurPostProcess_fragmentBoX4p9sr_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,glowBlurPostProcessPixelShader:i$N});Er$1._instancedMeshFactory=(e,t)=>{const s=new g$g(e,t);if(t.instancedBuffers){s.instancedBuffers={};for(const e in t.instancedBuffers)s.instancedBuffers[e]=t.instancedBuffers[e];}return s};let g$g=class g extends ps{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const e of t.getAnimationRanges())null!=e&&this.createAnimationRange(e.name,e.from,e.to);if(this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),t.skeleton||t.morphTargetManager||!t.hasBoundingInfo)this.refreshBoundingInfo(true,true);else {const e=t.getBoundingInfo();this.buildBoundingInfo(e.minimum,e.maximum);}this._syncSubMeshes();}getClassName(){return "InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){this._sourceMesh?.receiveShadows!==e&&Ai.Warn("Setting receiveShadows on an instanced mesh has no effect");}get material(){return this._sourceMesh.material}set material(e){this._sourceMesh?.material!==e&&Ai.Warn("Setting material on an instanced mesh has no effect");}get visibility(){return this._sourceMesh.visibility}set visibility(e){this._sourceMesh?.visibility!==e&&Ai.Warn("Setting visibility on an instanced mesh has no effect");}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){this._sourceMesh?.skeleton!==e&&Ai.Warn("Setting skeleton on an instanced mesh has no effect");}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){this._sourceMesh&&e!==this._sourceMesh.renderingGroupId&&Ie$2.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene");}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}get geometry(){return this._sourceMesh._geometry}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=false){return this._sourceMesh.isReady(e,true)}getVerticesData(e,t,s){return this._sourceMesh.getVerticesData(e,t,s)}copyVerticesData(e,t){this._sourceMesh.copyVerticesData(e,t);}getVertexBuffer(e,t){return this._sourceMesh.getVertexBuffer(e,t)}setVerticesData(e,t,s,n){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,s,n),this.sourceMesh}updateVerticesData(e,t,s,n){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,s,n),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=false,t=false){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let s;s="object"==typeof e?e:{applySkeleton:e,applyMorph:t};const r=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(s,null,Hi.PositionKind),r),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||Ie$2.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=true,true;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=false,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=true,true}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=true,true}return  false}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer);}getWorldMatrix(){if(this._currentLOD&&this._currentLOD!==this._sourceMesh&&this._currentLOD.billboardMode!==ns.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new re$5);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,ae$5.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(true)),this._currentLOD.position.copyFrom(ae$5.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return  true}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(t&&0!==t.length){const t=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,t.boundingSphere);}else this._currentLOD=this.sourceMesh;return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,s,n){const r=(n||this._sourceMesh).createInstance(e);if(ve$3.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo","geometry"],[]),t&&(r.parent=t),!s)for(let e=0;e<this.getScene().meshes.length;e++){const t=this.getScene().meshes[e];t.parent===this&&t.clone(t.name,r);}return r.computeWorldMatrix(true),this.onClonedObservable.notifyObservers(r),r}dispose(e,t=false){this._sourceMesh.removeInstance(this),super.dispose(e,t);}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray;}instantiateHierarchy(e=null,t,s){const n=this.clone("Clone of "+(this.name||this.id),e||this.parent,true,t&&t.newSourcedMesh);n&&s&&s(this,n);for(const e of this.getChildTransformNodes(true))e.instantiateHierarchy(n,t,s);return n}};Er$1.prototype.registerInstancedBuffer=function(e,t){if(this._userInstancedBuffersStorage?.vertexBuffers[e]?.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const e of this.instances)e.instancedBuffers={};}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[e]=null,this._userInstancedBuffersStorage.strides[e]=t,this._userInstancedBuffersStorage.sizes[e]=32*t,this._userInstancedBuffersStorage.data[e]=new Float32Array(this._userInstancedBuffersStorage.sizes[e]),this._userInstancedBuffersStorage.vertexBuffers[e]=new Hi(this.getEngine(),this._userInstancedBuffersStorage.data[e],e,true,false,t,true);for(const t of this.instances)t.instancedBuffers[e]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty();},Er$1.prototype._processInstancedBuffers=function(e,t){const s=e?e.length:0;for(const r in this.instancedBuffers){let o=this._userInstancedBuffersStorage.sizes[r];const i=this._userInstancedBuffersStorage.strides[r],a=(s+1)*i;for(;o<a;)o*=2;this._userInstancedBuffersStorage.data[r].length!=o&&(this._userInstancedBuffersStorage.data[r]=new Float32Array(o),this._userInstancedBuffersStorage.sizes[r]=o,this._userInstancedBuffersStorage.vertexBuffers[r]&&(this._userInstancedBuffersStorage.vertexBuffers[r].dispose(),this._userInstancedBuffersStorage.vertexBuffers[r]=null));const h=this._userInstancedBuffersStorage.data[r];let c=0;if(t){const e=this.instancedBuffers[r];e.toArray?e.toArray(h,c):e.copyToArray?e.copyToArray(h,c):h[c]=e,c+=i;}for(let t=0;t<s;t++){const s=e[t].instancedBuffers[r];s.toArray?s.toArray(h,c):s.copyToArray?s.copyToArray(h,c):h[c]=s,c+=i;}this._userInstancedBuffersStorage.vertexBuffers[r]?this._userInstancedBuffersStorage.vertexBuffers[r].updateDirectly(h,0):(this._userInstancedBuffersStorage.vertexBuffers[r]=new Hi(this.getEngine(),this._userInstancedBuffersStorage.data[r],r,true,false,i,true),this._invalidateInstanceVertexArrayObject());}},Er$1.prototype._invalidateInstanceVertexArrayObject=function(){if(this._userInstancedBuffersStorage&&void 0!==this._userInstancedBuffersStorage.vertexArrayObjects){for(const e in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[e]);this._userInstancedBuffersStorage.vertexArrayObjects={};}},Er$1.prototype._disposeInstanceSpecificData=function(){for(const e in this._instanceDataStorage.renderPasses)this._instanceDataStorage.renderPasses[e].instancesBuffer?.dispose();for(this._instanceDataStorage.renderPasses={};this.instances.length;)this.instances[0].dispose();for(const e in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[e]&&this._userInstancedBuffersStorage.vertexBuffers[e].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={};},P$9("BABYLON.InstancedMesh",g$g);let m$k=class m{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[];}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e;}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(const t of this.skeletons)e=e.concat(t.bones);return e}};let p$i=class p extends m$k{};let _$d=class _{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[];}dispose(){const e=this.rootNodes;for(const t of e)t.dispose();e.length=0;const t=this.skeletons;for(const e of t)e.dispose();t.length=0;const s=this.animationGroups;for(const e of s)e.dispose();s.length=0;}};let M$b=class M extends m$k{constructor(e){super(),this._wasAddedToScene=false,(e=e||L$7.LastCreatedScene)&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add((()=>{this._wasAddedToScene||this.dispose();})),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();for(const e of this.particleSystems)e.rebuild();for(const e of this.textures)e._rebuild();})));}_topologicalSort(e){const t=new Map;for(const s of e)t.set(s.uniqueId,s);const n={dependsOn:new Map,dependedBy:new Map};for(const t of e){const e=t.uniqueId;n.dependsOn.set(e,new Set),n.dependedBy.set(e,new Set);}for(const s of e){const e=s.uniqueId,r=n.dependsOn.get(e);if(s instanceof g$g){const o=s.sourceMesh;t.has(o.uniqueId)&&(r.add(o.uniqueId),n.dependedBy.get(o.uniqueId).add(e));}const o=n.dependedBy.get(e);for(const r of s.getDescendants()){const s=r.uniqueId;if(t.has(s)){o.add(s);n.dependsOn.get(s).add(e);}}}const r=[],o=[];for(const s of e){const e=s.uniqueId;0===n.dependsOn.get(e).size&&(o.push(s),t.delete(e));}const i=o;for(;i.length>0;){const e=i.shift();r.push(e);const s=n.dependedBy.get(e.uniqueId);for(const r of Array.from(s.values())){const s=n.dependsOn.get(r);s.delete(e.uniqueId),0===s.size&&t.get(r)&&(i.push(t.get(r)),t.delete(r));}}return t.size>0&&(Ie$2.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach((e=>{Ie$2.Error(e.name);}))),r}_addNodeAndDescendantsToList(e,t,s,n){if(s&&(!n||n(s))&&!t.has(s.uniqueId)){e.push(s),t.add(s.uniqueId);for(const r of s.getDescendants(true))this._addNodeAndDescendantsToList(e,t,r,n);}}_isNodeInContainer(t){return t instanceof ps&&-1!==this.meshes.indexOf(t)||(t instanceof ns&&-1!==this.transformNodes.indexOf(t)||(t instanceof dn&&-1!==this.lights.indexOf(t)||t instanceof Di&&-1!==this.cameras.indexOf(t)))}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return Ie$2.Warn(`Node ${e.name} has a parent that is not in the container.`),false;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return Ie$2.Warn(`Node ${e.name} has a parent that is not in the container.`),false;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return Ie$2.Warn(`Node ${e.name} has a parent that is not in the container.`),false;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return Ie$2.Warn(`Node ${e.name} has a parent that is not in the container.`),false;return  true}instantiateModelsToScene(e,s=false,n){this._isValidHierarchy()||Ai.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const r={},o={},i=new _$d,a=[],c=[],u={doNotInstantiate:true,...n},d=[],f=new Set;for(const e of this.transformNodes)null===e.parent&&this._addNodeAndDescendantsToList(d,f,e,u.predicate);for(const e of this.meshes)null===e.parent&&this._addNodeAndDescendantsToList(d,f,e,u.predicate);const l=this._topologicalSort(d),g=(t,n)=>{if(((t,s)=>{if(r[t.uniqueId]=s.uniqueId,o[s.uniqueId]=s,e&&(s.name=e(t.name)),s instanceof Er$1){const e=s;if(e.morphTargetManager){const s=t.morphTargetManager;e.morphTargetManager=s.clone();for(let t=0;t<s.numTargets;t++){const n=s.getTarget(t),i=e.morphTargetManager.getTarget(t);r[n.uniqueId]=i.uniqueId,o[i.uniqueId]=i;}}}})(t,n),t.parent){const e=r[t.parent.uniqueId],s=o[e];n.parent=s||t.parent;}if(n.position&&t.position&&n.position.copyFrom(t.position),n.rotationQuaternion&&t.rotationQuaternion&&n.rotationQuaternion.copyFrom(t.rotationQuaternion),n.rotation&&t.rotation&&n.rotation.copyFrom(t.rotation),n.scaling&&t.scaling&&n.scaling.copyFrom(t.scaling),n.material){const i=n;if(i.material)if(s){const s=t.material;if(-1===c.indexOf(s)){let t=s.clone(e?e(s.name):"Clone of "+s.name);if(c.push(s),r[s.uniqueId]=t.uniqueId,o[t.uniqueId]=t,"MultiMaterial"===s.getClassName()){const n=s;for(const s of n.subMaterials)s&&(t=s.clone(e?e(s.name):"Clone of "+s.name),c.push(s),r[s.uniqueId]=t.uniqueId,o[t.uniqueId]=t);n.subMaterials=n.subMaterials.map((e=>e&&o[r[e.uniqueId]]));}}"InstancedMesh"!==i.getClassName()&&(i.material=o[r[s.uniqueId]]);}else "MultiMaterial"===i.material.getClassName()?-1===this.scene.multiMaterials.indexOf(i.material)&&this.scene.addMultiMaterial(i.material):-1===this.scene.materials.indexOf(i.material)&&this.scene.addMaterial(i.material);}null===n.parent&&i.rootNodes.push(n);};for(const e of l)if("InstancedMesh"===e.getClassName()){const t=e,s=t.sourceMesh,n=r[s.uniqueId];g(t,("number"==typeof n?o[n]:s).createInstance(t.name));}else {let t=true;"TransformNode"===e.getClassName()||"Node"===e.getClassName()||e.skeleton||!e.getTotalVertices||0===e.getTotalVertices()?t=false:u.doNotInstantiate&&(t="function"==typeof u.doNotInstantiate?!u.doNotInstantiate(e):!u.doNotInstantiate);const s=t?e.createInstance(`instance of ${e.name}`):e.clone(`Clone of ${e.name}`,null,true);if(!s)throw new Error(`Could not clone or instantiate node on Asset Container ${e.name}`);g(e,s);}for(const t of this.skeletons){if(u.predicate&&!u.predicate(t))continue;const s=t.clone(e?e(t.name):"Clone of "+t.name);for(const e of this.meshes)if(e.skeleton===t&&!e.isAnInstance){const t=o[r[e.uniqueId]];if(!t||t.isAnInstance)continue;if(t.skeleton=s,-1!==a.indexOf(s))continue;a.push(s);for(const e of s.bones)e._linkedTransformNode&&(e._linkedTransformNode=o[r[e._linkedTransformNode.uniqueId]]);}i.skeletons.push(s);}for(const t of this.animationGroups){if(u.predicate&&!u.predicate(t))continue;const s=t.clone(e?e(t.name):"Clone of "+t.name,(e=>o[r[e.uniqueId]]||e));i.animationGroups.push(s);}return i}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||Ai.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=true,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null;}}addToScene(e=null){const t=[];for(const s of this.cameras)e&&!e(s)||(this.scene.addCamera(s),t.push(s));for(const s of this.lights)e&&!e(s)||(this.scene.addLight(s),t.push(s));for(const s of this.meshes)e&&!e(s)||(this.scene.addMesh(s),t.push(s));for(const t of this.skeletons)e&&!e(t)||this.scene.addSkeleton(t);for(const t of this.animations)e&&!e(t)||this.scene.addAnimation(t);for(const t of this.animationGroups)e&&!e(t)||this.scene.addAnimationGroup(t);for(const t of this.multiMaterials)e&&!e(t)||this.scene.addMultiMaterial(t);for(const t of this.materials)e&&!e(t)||this.scene.addMaterial(t);for(const t of this.morphTargetManagers)e&&!e(t)||this.scene.addMorphTargetManager(t);for(const t of this.geometries)e&&!e(t)||this.scene.addGeometry(t);for(const s of this.transformNodes)e&&!e(s)||(this.scene.addTransformNode(s),t.push(s));for(const t of this.actionManagers)e&&!e(t)||this.scene.addActionManager(t);for(const t of this.textures)e&&!e(t)||this.scene.addTexture(t);for(const t of this.reflectionProbes)e&&!e(t)||this.scene.addReflectionProbe(t);if(t.length){const e=new Set(this.scene.meshes);for(const t of this.scene.lights)e.add(t);for(const t of this.scene.cameras)e.add(t);for(const t of this.scene.transformNodes)e.add(t);for(const t of this.skeletons)for(const s of t.bones)e.add(s);for(const s of t)s.parent&&!e.has(s.parent)&&(s.setParent?s.setParent(null):s.parent=null);}}removeAllFromScene(){this._isValidHierarchy()||Ai.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=false,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this);}removeFromScene(e=null){for(const t of this.cameras)e&&!e(t)||this.scene.removeCamera(t);for(const t of this.lights)e&&!e(t)||this.scene.removeLight(t);for(const t of this.meshes)e&&!e(t)||this.scene.removeMesh(t,true);for(const t of this.skeletons)e&&!e(t)||this.scene.removeSkeleton(t);for(const t of this.animations)e&&!e(t)||this.scene.removeAnimation(t);for(const t of this.animationGroups)e&&!e(t)||this.scene.removeAnimationGroup(t);for(const t of this.multiMaterials)e&&!e(t)||this.scene.removeMultiMaterial(t);for(const t of this.materials)e&&!e(t)||this.scene.removeMaterial(t);for(const t of this.morphTargetManagers)e&&!e(t)||this.scene.removeMorphTargetManager(t);for(const t of this.geometries)e&&!e(t)||this.scene.removeGeometry(t);for(const t of this.transformNodes)e&&!e(t)||this.scene.removeTransformNode(t);for(const t of this.actionManagers)e&&!e(t)||this.scene.removeActionManager(t);for(const t of this.textures)e&&!e(t)||this.scene.removeTexture(t);for(const t of this.reflectionProbes)e&&!e(t)||this.scene.removeReflectionProbe(t);}dispose(){const e=this.cameras.slice(0);for(const t of e)t.dispose();this.cameras.length=0;const t=this.lights.slice(0);for(const e of t)e.dispose();this.lights.length=0;const s=this.meshes.slice(0);for(const e of s)e.dispose();this.meshes.length=0;const n=this.skeletons.slice(0);for(const e of n)e.dispose();this.skeletons.length=0;const r=this.animationGroups.slice(0);for(const e of r)e.dispose();this.animationGroups.length=0;const o=this.multiMaterials.slice(0);for(const e of o)e.dispose();this.multiMaterials.length=0;const i=this.materials.slice(0);for(const e of i)e.dispose();this.materials.length=0;const a=this.geometries.slice(0);for(const e of a)e.dispose();this.geometries.length=0;const h=this.transformNodes.slice(0);for(const e of h)e.dispose();this.transformNodes.length=0;const c=this.actionManagers.slice(0);for(const e of c)e.dispose();this.actionManagers.length=0;const u=this.textures.slice(0);for(const e of u)e.dispose();this.textures.length=0;const d=this.reflectionProbes.slice(0);for(const e of d)e.dispose();this.reflectionProbes.length=0;const f=this.morphTargetManagers.slice(0);for(const e of f)e.dispose();this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,true);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null);}_moveAssets(e,t,s){if(e&&t)for(const n of e){let e=true;if(s)for(const t of s)if(n===t){e=false;break}e&&(t.push(n),n._parentContainer=this);}}moveAllFromScene(e){this._wasAddedToScene=false,void 0===e&&(e=new p$i);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||("_environmentTexture"===t?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene();}createRootMesh(){const e=new Er$1("assetContainerRootMesh",this.scene);for(const t of this.meshes)t.parent||e.addChild(t);return this.meshes.unshift(e),e}mergeAnimationsTo(e=L$7.LastCreatedScene,t,n=null){if(!e)return Ie$2.Error("No scene available to merge animations to"),[];const r=n||(t=>{let s=null;const n=t.animations.length?t.animations[0].targetProperty:"",r=t.name.split(".").join("").split("_primitive")[0];switch(n){case "position":case "rotationQuaternion":s=e.getTransformNodeByName(t.name)||e.getTransformNodeByName(r);break;case "influence":s=e.getMorphTargetByName(t.name)||e.getMorphTargetByName(r);break;default:s=e.getNodeByName(t.name)||e.getNodeByName(r);}return s}),o=this.getNodes();for(const e of o){const t=r(e);if(null!==t){for(const s of e.animations){const e=t.animations.filter((e=>e.targetProperty===s.targetProperty));for(const s of e){const e=t.animations.indexOf(s,0);e>-1&&t.animations.splice(e,1);}}t.animations=t.animations.concat(e.animations);}}const i=[],a=this.animationGroups.slice();for(const e of a){i.push(e.clone(e.name,r));for(const t of e.animatables)t.stop();}for(const s of t){const t=r(s.target);t&&(e.beginAnimation(t,s.fromFrame,s.toFrame,s.loopAnimation,s.speedRatio,s.onAnimationEnd?s.onAnimationEnd:void 0,void 0,true,void 0,s.onAnimationLoop?s.onAnimationLoop:void 0),e.stopAnimation(s.target));}return i}populateRootNodes(){this.rootNodes.length=0;for(const e of this.meshes)e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e);for(const e of this.transformNodes)e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e);for(const e of this.lights)e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e);for(const e of this.cameras)e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e);}addAllAssetsToContainer(t){if(!t)return;const s=[],n=new Set;for(s.push(t);s.length>0;){const t=s.pop();if(t instanceof Er$1?(t.geometry&&-1===this.geometries.indexOf(t.geometry)&&this.geometries.push(t.geometry),this.meshes.push(t)):t instanceof g$g?this.meshes.push(t):t instanceof ns?this.transformNodes.push(t):t instanceof dn?this.lights.push(t):t instanceof Di&&this.cameras.push(t),t instanceof ps){if(t.material&&-1===this.materials.indexOf(t.material)){this.materials.push(t.material);for(const e of t.material.getActiveTextures()) -1===this.textures.indexOf(e)&&this.textures.push(e);}t.skeleton&&-1===this.skeletons.indexOf(t.skeleton)&&this.skeletons.push(t.skeleton),t.morphTargetManager&&-1===this.morphTargetManagers.indexOf(t.morphTargetManager)&&this.morphTargetManagers.push(t.morphTargetManager);}for(const e of t.getChildren())n.has(e)||s.push(e);n.add(t);}this.populateRootNodes();}_getByTags(e,t,s){if(void 0===t)return e;const n=[];for(const r in e){const o=e[r];ue$4&&ue$4.MatchesQuery(o,t)&&(!s||s(o))&&n.push(o);}return n}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialsByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}};let r$16=class r extends be$3{get _matrix(){return this._compose(),this._localMatrix}set _matrix(t){(t.updateFlag!==this._localMatrix.updateFlag||this._needToCompose)&&(this._needToCompose=false,this._localMatrix.copyFrom(t),this._markAsDirtyAndDecompose());}constructor(t,i,o=null,s=null,n=null,r=null,a=null){super(t,i.getScene(),false),this.name=t,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=true,this._needToCompose=false,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=i,this._localMatrix=s?.clone()??re$5.Identity(),this._restMatrix=n??this._localMatrix.clone(),this._bindMatrix=r??this._localMatrix.clone(),this._index=a,this._absoluteMatrix=new re$5,this._absoluteBindMatrix=new re$5,this._absoluteInverseBindMatrix=new re$5,this._finalMatrix=new re$5,i.bones.push(this),this.setParent(o,false),this._updateAbsoluteBindMatrices();}getClassName(){return "Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(t){this.setParent(t);}setParent(t,e=true){if(this.parent!==t){if(this.parent){const t=this.parent.children.indexOf(this);-1!==t&&this.parent.children.splice(t,1);}this._parentNode=t,this.parent&&this.parent.children.push(this),e&&this._updateAbsoluteBindMatrices(),this.markAsDirty();}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(t){this._restMatrix.copyFrom(t);}setRestPose(t){this.setRestMatrix(t);}getBindPose(){return this.getBindMatrix()}setBindMatrix(t){this.updateMatrix(t);}setBindPose(t){this.setBindMatrix(t);}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){const t=ae$5.Vector3[0],e=ae$5.Quaternion[0],s=ae$5.Vector3[1];this.getRestMatrix().decompose(t,e,s),this._linkedTransformNode.position.copyFrom(s),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??se$5.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(e),this._linkedTransformNode.scaling.copyFrom(t);}else this._matrix=this._restMatrix;}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._skeleton.computeAbsoluteMatrices(),this._absoluteMatrix}getAbsoluteTransform(){return this.getAbsoluteMatrix()}linkTransformNode(t){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=t,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++;}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(t){this._decompose(),this._localPosition.copyFrom(t),this._markAsDirtyAndCompose();}get rotation(){return this.getRotation()}set rotation(t){this.setRotation(t);}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(t){this.setRotationQuaternion(t);}get scaling(){return this.getScale()}set scaling(t){this.setScale(t);}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=false,this._localScaling||(this._localScaling=te$4.Zero(),this._localRotation=se$5.Zero(),this._localPosition=te$4.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition));}_compose(){this._needToCompose&&(this._localScaling?(this._needToCompose=false,re$5.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)):this._needToCompose=false);}updateMatrix(t,e=true,i=true){this._bindMatrix.copyFrom(t),e&&this._updateAbsoluteBindMatrices(),i?this._matrix=t:this.markAsDirty();}_updateAbsoluteBindMatrices(t,e=true){if(t||(t=this._bindMatrix),this.parent?t.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(t),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),e)for(let t=0;t<this.children.length;t++)this.children[t]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1;}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=true;}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=true;}_updatePosition(t,i=0,o,n=true){const a=this.getLocalMatrix();if(0==i)n?(a.addAtIndex(12,t.x),a.addAtIndex(13,t.y),a.addAtIndex(14,t.z)):a.setTranslationFromFloats(t.x,t.y,t.z);else {const i=r._TmpMats[0],l=r._TmpVecs[0];this.parent?(i.copyFrom(this.parent.getAbsoluteMatrix()),o&&i.multiplyToRef(o.getWorldMatrix(),i)):re$5.IdentityToRef(i),n&&i.setTranslationFromFloats(0,0,0),i.invert(),te$4.TransformCoordinatesToRef(t,i,l),n?(a.addAtIndex(12,l.x),a.addAtIndex(13,l.y),a.addAtIndex(14,l.z)):a.setTranslationFromFloats(l.x,l.y,l.z);}this._markAsDirtyAndDecompose();}translate(t,e=0,i){this._updatePosition(t,e,i,true);}setPosition(t,e=0,i){this._updatePosition(t,e,i,false);}setAbsolutePosition(t,e){this.setPosition(t,1,e);}scale(t,i,o,s=false){const n=this.getLocalMatrix(),a=r._TmpMats[0];re$5.ScalingToRef(t,i,o,a),a.multiplyToRef(n,n),a.invert();for(const e of this.children){const s=e.getLocalMatrix();s.multiplyToRef(a,s),s.multiplyAtIndex(12,t),s.multiplyAtIndex(13,i),s.multiplyAtIndex(14,o),e._markAsDirtyAndDecompose();}if(this._markAsDirtyAndDecompose(),s)for(const e of this.children)e.scale(t,i,o,s);}setScale(t){this._decompose(),this._localScaling.copyFrom(t),this._markAsDirtyAndCompose();}getScale(){return this._decompose(),this._localScaling}getScaleToRef(t){this._decompose(),t.copyFrom(this._localScaling);}setYawPitchRoll(t,i,s,n=0,a){if(0===n){const e=r._TmpQuat;return se$5.RotationYawPitchRollToRef(t,i,s,e),void this.setRotationQuaternion(e,n,a)}const l=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(l,a))return;const h=r._TmpMats[1];re$5.RotationYawPitchRollToRef(t,i,s,h),l.multiplyToRef(h,h),this._rotateWithMatrix(h,n,a);}rotate(t,i,o=0,s){const n=r._TmpMats[0];n.setTranslationFromFloats(0,0,0),re$5.RotationAxisToRef(t,i,n),this._rotateWithMatrix(n,o,s);}setAxisAngle(t,i,s=0,n){if(0===s){const e=r._TmpQuat;return se$5.RotationAxisToRef(t,i,e),void this.setRotationQuaternion(e,s,n)}const a=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(a,n))return;const l=r._TmpMats[1];re$5.RotationAxisToRef(t,i,l),a.multiplyToRef(l,l),this._rotateWithMatrix(l,s,n);}setRotation(t,e=0,i){this.setYawPitchRoll(t.y,t.x,t.z,e,i);}setRotationQuaternion(t,i=0,o){if(0===i)return this._decompose(),this._localRotation.copyFrom(t),void this._markAsDirtyAndCompose();const s=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,o))return;const n=r._TmpMats[1];re$5.FromQuaternionToRef(t,n),s.multiplyToRef(n,n),this._rotateWithMatrix(n,i,o);}setRotationMatrix(t,e=0,i){if(0===e){const s=r._TmpQuat;return se$5.FromRotationMatrixToRef(t,s),void this.setRotationQuaternion(s,e,i)}const s=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const n=r._TmpMats[1];n.copyFrom(t),s.multiplyToRef(t,n),this._rotateWithMatrix(n,e,i);}_rotateWithMatrix(t,e=0,i){const o=this.getLocalMatrix(),s=o.m[12],n=o.m[13],a=o.m[14],l=this.getParent(),h=r._TmpMats[3],c=r._TmpMats[4];l&&1==e?(i?(h.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(h,h)):h.copyFrom(l.getAbsoluteMatrix()),c.copyFrom(h),c.invert(),o.multiplyToRef(h,o),o.multiplyToRef(t,o),o.multiplyToRef(c,o)):1==e&&i?(h.copyFrom(i.getWorldMatrix()),c.copyFrom(h),c.invert(),o.multiplyToRef(h,o),o.multiplyToRef(t,o),o.multiplyToRef(c,o)):o.multiplyToRef(t,o),o.setTranslationFromFloats(s,n,a),this._markAsDirtyAndDecompose();}_getAbsoluteInverseMatrixUnscaledToRef(t,i){const o=r._TmpMats[2];return t.copyFrom(this.getAbsoluteMatrix()),i?(t.multiplyToRef(i.getWorldMatrix(),t),re$5.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,o)):re$5.IdentityToRef(o),t.invert(),!isNaN(t.m[0])&&(o.multiplyAtIndex(0,this._scalingDeterminant),t.multiplyToRef(o,t),true)}getPosition(t=0,e=null){const i=te$4.Zero();return this.getPositionToRef(t,e,i),i}getPositionToRef(t=0,e,i){if(0==t){const t=this.getLocalMatrix();i.x=t.m[12],i.y=t.m[13],i.z=t.m[14];}else {const t=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());e&&t.multiplyToRef(e.getWorldMatrix(),t),i.x=t.m[12],i.y=t.m[13],i.z=t.m[14];}}getAbsolutePosition(t=null){const e=te$4.Zero();return this.getPositionToRef(1,t,e),e}getAbsolutePositionToRef(t,e){this.getPositionToRef(1,t,e);}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else {this._absoluteMatrix.copyFrom(this._localMatrix);const t=this._skeleton.getPoseMatrix();t&&this._absoluteMatrix.multiplyToRef(t,this._absoluteMatrix);}const t=this.children,e=t.length;for(let i=0;i<e;i++)t[i].computeAbsoluteMatrices();}computeAbsoluteTransforms(){this.computeAbsoluteMatrices();}getDirection(t,e=null){const i=te$4.Zero();return this.getDirectionToRef(t,e,i),i}getDirectionToRef(t,e=null,i){const o=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());e&&o.multiplyToRef(e.getWorldMatrix(),o),te$4.TransformNormalToRef(t,o,i),i.normalize();}getRotation(t=0,e=null){const i=te$4.Zero();return this.getRotationToRef(t,e,i),i}getRotationToRef(t=0,e=null,i){const o=r._TmpQuat;this.getRotationQuaternionToRef(t,e,o),o.toEulerAnglesToRef(i);}getRotationQuaternion(t=0,e=null){const i=se$5.Identity();return this.getRotationQuaternionToRef(t,e,i),i}getRotationQuaternionToRef(t=0,e=null,i){if(0==t)this._decompose(),i.copyFrom(this._localRotation);else {const t=r._TmpMats[0],o=this.getAbsoluteMatrix();e?o.multiplyToRef(e.getWorldMatrix(),t):t.copyFrom(o),t.multiplyAtIndex(0,this._scalingDeterminant),t.multiplyAtIndex(1,this._scalingDeterminant),t.multiplyAtIndex(2,this._scalingDeterminant),t.decompose(void 0,i,void 0);}}getRotationMatrix(t=0,i){const o=re$5.Identity();return this.getRotationMatrixToRef(t,i,o),o}getRotationMatrixToRef(t=0,e,i){if(0==t)this.getLocalMatrix().getRotationMatrixToRef(i);else {const t=r._TmpMats[0],o=this.getAbsoluteMatrix();e?o.multiplyToRef(e.getWorldMatrix(),t):t.copyFrom(o),t.multiplyAtIndex(0,this._scalingDeterminant),t.multiplyAtIndex(1,this._scalingDeterminant),t.multiplyAtIndex(2,this._scalingDeterminant),t.getRotationMatrixToRef(i);}}getAbsolutePositionFromLocal(t,e=null){const i=te$4.Zero();return this.getAbsolutePositionFromLocalToRef(t,e,i),i}getAbsolutePositionFromLocalToRef(t,e=null,i){const o=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());e&&o.multiplyToRef(e.getWorldMatrix(),o),te$4.TransformCoordinatesToRef(t,o,i);}getLocalPositionFromAbsolute(t,e=null){const i=te$4.Zero();return this.getLocalPositionFromAbsoluteToRef(t,e,i),i}getLocalPositionFromAbsoluteToRef(t,e=null,i){const o=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());e&&o.multiplyToRef(e.getWorldMatrix(),o),o.invert(),te$4.TransformCoordinatesToRef(t,o,i);}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix());}dispose(){this._linkedTransformNode=null;const t=this._skeleton.bones.indexOf(this);if(-1!==t&&this._skeleton.bones.splice(t,1),this._parentNode&&this._parentNode.children){const t=this._parentNode.children,e=t.indexOf(this);-1!==e&&t.splice(e,1);}super.dispose();}};r$16._TmpVecs=M$d(2,te$4.Zero),r$16._TmpQuat=se$5.Identity(),r$16._TmpMats=M$d(5,re$5.Identity);let E$f=class E extends Is{constructor(E,T,r,i,R,_=true,n=false,s=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,a=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,A,u,M){super(null,R,!_,n,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,A),this.format=i,this._engine&&(this._engine._caps.textureFloatLinearFiltering||a!==Qe$1.TEXTURETYPE_FLOAT||(s=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE),this._engine._caps.textureHalfFloatLinearFiltering||a!==Qe$1.TEXTURETYPE_HALF_FLOAT||(s=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE),this._texture=this._engine.createRawTexture(E,T,r,i,_,n,s,null,a,A??0,u??false),this.wrapU=Is.CLAMP_ADDRESSMODE,this.wrapV=Is.CLAMP_ADDRESSMODE,this._waitingForData=!!M&&!E);}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer),this._waitingForData=false;}clone(){if(!this._texture)return super.clone();const e=new E(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}isReady(){return super.isReady()&&!this._waitingForData}static CreateLuminanceTexture(e,T,r,i,R=true,_=false,n=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE){return new E(e,T,r,Qe$1.TEXTUREFORMAT_LUMINANCE,i,R,_,n)}static CreateLuminanceAlphaTexture(e,T,r,i,R=true,_=false,n=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE){return new E(e,T,r,Qe$1.TEXTUREFORMAT_LUMINANCE_ALPHA,i,R,_,n)}static CreateAlphaTexture(e,T,r,i,R=true,_=false,n=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE){return new E(e,T,r,Qe$1.TEXTUREFORMAT_ALPHA,i,R,_,n)}static CreateRGBTexture(e,T,r,i,R=true,_=false,n=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,s=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,a=0,A=false){return new E(e,T,r,Qe$1.TEXTUREFORMAT_RGB,i,R,_,n,s,a,A)}static CreateRGBATexture(e,T,r,i,R=true,_=false,n=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,s=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,a=0,A=false,u=false){return new E(e,T,r,Qe$1.TEXTUREFORMAT_RGBA,i,R,_,n,s,a,A,u)}static CreateRGBAStorageTexture(e,T,r,i,R=true,_=false,n=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,s=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,a=false){return new E(e,T,r,Qe$1.TEXTUREFORMAT_RGBA,i,R,_,n,s,Qe$1.TEXTURE_CREATIONFLAG_STORAGE,a)}static CreateRTexture(T,r,i,R,_=true,n=false,s=Is.TRILINEAR_SAMPLINGMODE,a=Qe$1.TEXTURETYPE_FLOAT){return new E(T,r,i,Qe$1.TEXTUREFORMAT_R,R,_,n,s,a)}static CreateRStorageTexture(T,r,i,R,_=true,n=false,s=Is.TRILINEAR_SAMPLINGMODE,a=Qe$1.TEXTURETYPE_FLOAT){return new E(T,r,i,Qe$1.TEXTUREFORMAT_R,R,_,n,s,a,Qe$1.TEXTURE_CREATIONFLAG_STORAGE)}};let d$h=class d{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(t){this._useTextureToStoreBoneMatrices=t,this._markAsDirty();}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(t){this._animationPropertiesOverride=t;}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(t,i,r){this.name=t,this.id=i,this.bones=[],this.needInitialSkinMatrix=false,this._isDirty=true,this._meshesWithPoseMatrix=new Array,this._identity=re$5.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=true,this._canUseTextureForBones=false,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=false,this._useTextureToStoreBoneMatrices=true,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new R$g,this.metadata=null,this.bones=[],this._scene=r||L$7.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=true;const a=this._scene.getEngine().getCaps();this._canUseTextureForBones=a.textureFloat&&a.maxVertexTextureImageUnits>0;}getClassName(){return "Skeleton"}getChildren(){return this.bones.filter((t=>!t.getParent()))}getTransformMatrices(t){if(this.needInitialSkinMatrix){if(!t)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return t._bonesTransformMatrices||this.prepare(true),t._bonesTransformMatrices}return this._transformMatrices&&!this._isDirty||this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(t){return this.needInitialSkinMatrix&&t._transformMatrixTexture?t._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(t){let e=`Name: ${this.name}, nBones: ${this.bones.length}`;if(e+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,t){e+=", Ranges: {";let t=true;for(const s in this._ranges)t&&(e+=", ",t=false),e+=s;e+="}";}return e}getBoneIndexByName(t){for(let e=0,s=this.bones.length;e<s;e++)if(this.bones[e].name===t)return e;return  -1}createAnimationRange(t,e,s){if(!this._ranges[t]){this._ranges[t]=new wr$1(t,e,s);for(let n=0,i=this.bones.length;n<i;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].createRange(t,e,s);}}deleteAnimationRange(t,e=true){for(let s=0,n=this.bones.length;s<n;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].deleteRange(t,e);this._ranges[t]=null;}getAnimationRange(t){return this._ranges[t]||null}getAnimationRanges(){const t=[];let e;for(e in this._ranges)t.push(this._ranges[e]);return t}copyAnimationRange(t,e,s=false){if(this._ranges[e]||!t.getAnimationRange(e))return  false;let n=true;const a=this._getHighestAnimationFrame()+1,o={},h=t.bones;let m,l;for(l=0,m=h.length;l<m;l++)o[h[l].name]=h[l];this.bones.length!==h.length&&(Ie$2.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${h.length}`),n=false);const g=s&&this.dimensionsAtRest&&t.dimensionsAtRest?this.dimensionsAtRest.divide(t.dimensionsAtRest):null;for(l=0,m=this.bones.length;l<m;l++){const t=this.bones[l].name,i=o[t];i?n=n&&this.bones[l].copyAnimationRange(i,e,a,s,g):(Ie$2.Warn("copyAnimationRange: not same rig, missing source bone "+t),n=false);}const d=t.getAnimationRange(e);return d&&(this._ranges[e]=new wr$1(e,d.from+a,d.to+a)),n}returnToRest(){for(const t of this.bones) -1!==t._index&&t.returnToRest();}_getHighestAnimationFrame(){let t=0;for(let e=0,s=this.bones.length;e<s;e++)if(this.bones[e].animations[0]){const s=this.bones[e].animations[0].getHighestFrame();t<s&&(t=s);}return t}beginAnimation(t,e,s,n){const i=this.getAnimationRange(t);return i?this._scene.beginAnimation(this,i.from,i.to,e,s,n):null}static MakeAnimationAdditive(t,e=0,s){const n=t.getAnimationRange(s);if(!n)return null;const i=t._scene.getAllAnimatablesByTarget(t);let r=null;for(let t=0;t<i.length;t++){const e=i[t];if(e.fromFrame===n?.from&&e.toFrame===n?.to){r=e;break}}const o=t.getAnimatables();for(let t=0;t<o.length;t++){const n=o[t].animations;if(n)for(let t=0;t<n.length;t++)zr$1.MakeAnimationAdditive(n[t],e,s);}return r&&(r.isAdditive=true),t}_markAsDirty(){this._isDirty=true,this._absoluteTransformIsDirty=true;}_registerMeshWithPoseMatrix(t){this._meshesWithPoseMatrix.push(t);}_unregisterMeshWithPoseMatrix(t){const e=this._meshesWithPoseMatrix.indexOf(t);e>-1&&this._meshesWithPoseMatrix.splice(e,1);}_computeTransformMatrices(t,e){this.onBeforeComputeObservable.notifyObservers(this);for(let s=0;s<this.bones.length;s++){const n=this.bones[s];n._childUpdateId++;const i=n.getParent();if(i?n.getLocalMatrix().multiplyToRef(i.getFinalMatrix(),n.getFinalMatrix()):e?n.getLocalMatrix().multiplyToRef(e,n.getFinalMatrix()):n.getFinalMatrix().copyFrom(n.getLocalMatrix()),-1!==n._index){const e=null===n._index?s:n._index;n.getAbsoluteInverseBindMatrix().multiplyToArray(n.getFinalMatrix(),t,16*e);}}this._identity.copyToArray(t,16*this.bones.length);}prepare(t=false){if(!t){const t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t;}if(this._numBonesWithLinkedTransformNode>0)for(const t of this.bones)if(t._linkedTransformNode){const e=t._linkedTransformNode;t.position=e.position,e.rotationQuaternion?t.rotationQuaternion=e.rotationQuaternion:t.rotation=e.rotation,t.scaling=e.scaling;}if(this.needInitialSkinMatrix)for(const t of this._meshesWithPoseMatrix){const e=t.getPoseMatrix();let s=this._isDirty;if(t._bonesTransformMatrices&&t._bonesTransformMatrices.length===16*(this.bones.length+1)||(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),s=true),s){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(const t of this.bones)if(!t.getParent()){t.getBindMatrix().multiplyToRef(e,ae$5.Matrix[1]),t._updateAbsoluteBindMatrices(ae$5.Matrix[1]);}if(this.isUsingTextureForMatrices){const e=4*(this.bones.length+1);t._transformMatrixTexture&&t._transformMatrixTexture.getSize().width===e||(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=E$f.CreateRGBATexture(t._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,false,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Qe$1.TEXTURETYPE_FLOAT));}}this._computeTransformMatrices(t._bonesTransformMatrices,e),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices);}}else {if(!this._isDirty)return;this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=E$f.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,false,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Qe$1.TEXTURETYPE_FLOAT))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices);}this._isDirty=false;}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let t=0;t<this.bones.length;t++)this._animatables.push(this.bones[t]);}return this._animatables}clone(e,s){const n=new d(e,s||e,this._scene);n.needInitialSkinMatrix=this.needInitialSkinMatrix,n.metadata=this.metadata;for(let e=0;e<this.bones.length;e++){const s=this.bones[e];let i=null;const r=s.getParent();if(r){const t=this.bones.indexOf(r);i=n.bones[t];}const a=new r$16(s.name,n,i,s.getBindMatrix().clone(),s.getRestMatrix().clone());a._index=s._index,s._linkedTransformNode&&a.linkTransformNode(s._linkedTransformNode),ve$3.DeepCopy(s.animations,a.animations);}if(this._ranges){n._ranges={};for(const t in this._ranges){const e=this._ranges[t];e&&(n._ranges[t]=e.clone());}}return this._isDirty=true,n.prepare(true),n}enableBlending(t=.01){for(const e of this.bones)for(const s of e.animations)s.enableBlending=true,s.blendingSpeed=t;}dispose(){if(this._meshesWithPoseMatrix.length=0,this.metadata=null,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const t=this._parentContainer.skeletons.indexOf(this);t>-1&&this._parentContainer.skeletons.splice(t,1),this._parentContainer=null;}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null);}serialize(){const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix,this.metadata&&(t.metadata=this.metadata);for(let e=0;e<this.bones.length;e++){const s=this.bones[e],n=s.getParent(),i={parentBoneIndex:n?this.bones.indexOf(n):-1,index:s.getIndex(),name:s.name,id:s.id,matrix:s.getBindMatrix().asArray(),rest:s.getRestMatrix().asArray(),linkedTransformNodeId:s.getTransformNode()?.id};t.bones.push(i),s.length&&(i.length=s.length),s.metadata&&(i.metadata=s.metadata),s.animations&&s.animations.length>0&&(i.animation=s.animations[0].serialize()),t.ranges=[];for(const e in this._ranges){const s=this._ranges[e];if(!s)continue;const n={};n.name=e,n.from=s.from,n.to=s.to,t.ranges.push(n);}}return t}static Parse(s,n){const i=new d(s.name,s.id,n);let r;for(s.dimensionsAtRest&&(i.dimensionsAtRest=te$4.FromArray(s.dimensionsAtRest)),i.needInitialSkinMatrix=s.needInitialSkinMatrix,s.metadata&&(i.metadata=s.metadata),r=0;r<s.bones.length;r++){const n=s.bones[r],o=s.bones[r].index;let h=null;n.parentBoneIndex>-1&&(h=i.bones[n.parentBoneIndex]);const m=n.rest?re$5.FromArray(n.rest):null,l=new r$16(n.name,i,h,re$5.FromArray(n.matrix),m,null,o);void 0!==n.id&&null!==n.id&&(l.id=n.id),n.length&&(l.length=n.length),n.metadata&&(l.metadata=n.metadata),n.animation&&l.animations.push(zr$1.Parse(n.animation)),void 0!==n.linkedTransformNodeId&&null!==n.linkedTransformNodeId&&(i._hasWaitingData=true,l._waitingTransformNodeId=n.linkedTransformNodeId);}if(s.ranges)for(r=0;r<s.ranges.length;r++){const t=s.ranges[r];i.createAnimationRange(t.name,t.from,t.to);}return i}computeAbsoluteMatrices(t=false){(this._absoluteTransformIsDirty||t)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=false);}computeAbsoluteTransforms(t=false){this.computeAbsoluteMatrices(t);}getPoseMatrix(){let t=null;return this._meshesWithPoseMatrix.length>0&&(t=this._meshesWithPoseMatrix[0].getPoseMatrix()),t}sortBones(){const t=[],e=new Array(this.bones.length);for(let s=0;s<this.bones.length;s++)this._sortBones(s,t,e);this.bones=t;}_sortBones(t,e,s){if(s[t])return;s[t]=true;const n=this.bones[t];if(!n)return;void 0===n._index&&(n._index=t);const i=n.getParent();i&&this._sortBones(this.bones.indexOf(i),e,s),e.push(n);}setCurrentPoseAsRest(){for(const t of this.bones)t.setCurrentPoseAsRest();}};const c$e="Xposition",p$h="Yposition",m$j="Zposition",h$9="Xrotation",d$g="Yrotation",u$g="Zrotation";let E$e=class E{constructor(t){this.loopMode=zr$1.ANIMATIONLOOPMODE_CYCLE,this.list=[],this.root=w$6(),this.numFrames=0,this.frameRate=0,this.skeleton=t;}};function w$6(){return {name:"",type:"",offset:new te$4,channels:[],children:[],frames:[],parent:null}}function N$8(t,r,n){const s=function(e){const t=e.offset.x,r=e.offset.y,n=e.offset.z;return re$5.Translation(t,r,n)}(t),i=new r$16(t.name,n.skeleton,r,s),a=function(t,o){if(0===t.frames.length)return [];const r=[],n=t.channels.some((e=>e===c$e||e===p$h||e===m$j)),s=t.channels.some((e=>e===h$9||e===d$g||e===u$g)),i=new zr$1(`${t.name}_pos`,"position",o.frameRate,zr$1.ANIMATIONTYPE_VECTOR3,o.loopMode),a=new zr$1(`${t.name}_rot`,"rotationQuaternion",o.frameRate,zr$1.ANIMATIONTYPE_QUATERNION,o.loopMode),l=[],f=[];for(let e=0;e<t.frames.length;e++){const o=t.frames[e];n&&o.position&&l.push({frame:o.frame,value:o.position.clone()}),s&&f.push({frame:o.frame,value:o.rotation.clone()});}return l.length>0&&(i.setKeys(l),r.push(i)),f.length>0&&(a.setKeys(f),r.push(a)),r}(t,n);for(const e of a)e.getKeys()&&e.getKeys().length>0&&i.animations.push(e);for(const e of t.children)N$8(e,i,n);}function g$f(e,s,i,a){if("ENDSITE"===i.type)return;const l={frame:0,position:new te$4,rotation:new se$5};l.frame=s,l.position=new te$4,l.rotation=new se$5,i.frames.push(l);let f=re$5.Identity();for(let t=0;t<i.channels.length;++t){const n=i.channels[t],s=e[a.i++];if(!s)continue;const E=parseFloat(s.trim());if(n.endsWith("position"))switch(n){case c$e:l.position.x=E;break;case p$h:l.position.y=E;break;case m$j:l.position.z=E;}else if(n.endsWith("rotation")){const e=Ai.ToRadians(E);let t;switch(n){case h$9:t=re$5.RotationX(e);break;case d$g:t=re$5.RotationY(e);break;case u$g:t=re$5.RotationZ(e);}f=t.multiply(f);}}se$5.FromRotationMatrixToRef(f,l.rotation);for(const t of i.children)g$f(e,s,t,a);}function I$b(e,o,r,n){const s=w$6();s.parent=r,n.list.push(s);let i=o.trim().split(/\s+/);if("END"===i[0].toUpperCase()&&"SITE"===i[1].toUpperCase()?(s.type="ENDSITE",s.name="ENDSITE"):(s.name=i[1],s.type=i[0].toUpperCase()),"{"!=e.shift()?.trim())throw new Error("Expected opening { after type & name");const a=e.shift()?.trim().split(/\s+/);if(!a)throw new Error("Unexpected end of file: missing OFFSET");if(i=a,"OFFSET"!=i[0].toUpperCase())throw new Error("Expected OFFSET, but got: "+i[0]);if(4!=i.length)throw new Error("OFFSET: Invalid number of values");const l=new te$4(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]));if(isNaN(l.x)||isNaN(l.y)||isNaN(l.z))throw new Error("OFFSET: Invalid values");if(s.offset=l,"ENDSITE"!=s.type){if(i=e.shift()?.trim().split(/\s+/),!i)throw new Error("Unexpected end of file: missing CHANNELS");if("CHANNELS"!=i[0].toUpperCase())throw new Error("Expected CHANNELS definition");const t=parseInt(i[1]);s.channels=i.splice(2,t),s.children=[];}for(;e.length>0;){const t=e.shift()?.trim();if("}"===t)return s;t&&s.children.push(I$b(e,t,s,n));}throw new Error("Unexpected end of file: missing closing brace")}function H$4(e,t,o,r){const n=e.split("\n"),{loopMode:s}=r;t._blockEntityCollection=!!o;const i=new d$h("","",t);i._parentContainer=o,t._blockEntityCollection=false;const a=new E$e(i);a.loopMode=s;const l=n.shift();if(!l||"HIERARCHY"!==l.trim().toUpperCase())throw new Error("HIERARCHY expected");const c=n.shift();if(!c)throw new Error("Unexpected end of file after HIERARCHY");const p=I$b(n,c.trim(),null,a),m=n.shift();if(!m||"MOTION"!==m.trim().toUpperCase())throw new Error("MOTION expected");const h=n.shift();if(!h)throw new Error("Unexpected end of file before frame count");const d=h.trim().split(/[\s]+/);if(d.length<2)throw new Error("Invalid frame count line");const u=parseInt(d[1]);if(isNaN(u))throw new Error("Failed to read number of frames.");a.numFrames=u;const w=n.shift();if(!w)throw new Error("Unexpected end of file before frame time");const H=w.trim().split(/[\s]+/);if(H.length<3)throw new Error("Invalid frame time line");const y=parseFloat(H[2]);if(isNaN(y))throw new Error("Failed to read frame time.");if(y<=0)throw new Error("Failed to read frame time. Invalid value "+y);a.frameRate=1/y;for(let e=0;e<u;++e){const t=n.shift();if(!t)continue;g$f(t.trim().split(/[\s]+/)||[],e,p,{i:0});}return a.root=p,N$8(a.root,null,a),a.skeleton.returnToRest(),a.skeleton}let y$b=class y{constructor(e){this.name=nc.name,this.extensions=nc.extensions,this._loadingOptions={...y._DefaultLoadingOptions,...e??{}};}static get _DefaultLoadingOptions(){return {loopMode:zr$1.ANIMATIONLOOPMODE_CYCLE}}createPlugin(e){return new y(e[nc.name])}canDirectLoad(e){return this.isBvhHeader(e)}isBvhHeader(e){return "HIERARCHY"==e.split("\n")[0]}isNotBvhHeader(e){return !this.isBvhHeader(e)}importMeshAsync(e,t,o){if("string"!=typeof o)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(o))return Promise.reject("BVH loader expects HIERARCHY header.");try{const e=H$4(o,t,null,this._loadingOptions);return Promise.resolve({meshes:[],particleSystems:[],skeletons:[e],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})}catch(e){return Promise.reject(e)}}loadAsync(e,t){return "string"!=typeof t?Promise.reject("BVH loader expects string data."):this.isNotBvhHeader(t)?Promise.reject("BVH loader expects HIERARCHY header."):this.importMeshAsync(null,e,t).then((()=>{}))}loadAssetContainerAsync(e,t){if("string"!=typeof t)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(t))return Promise.reject("BVH loader expects HIERARCHY header.");const o=new M$b(e);try{const r=H$4(t,e,o,this._loadingOptions);return o.skeletons.push(r),Promise.resolve(o)}catch(e){return Promise.reject(e)}}};gh(new y$b);var bvhFileLoaderCFXNglAB_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,BVHFileLoader:y$b});be$3.AddNodeConstructor("Light_Type_2",((e,t)=>()=>new m$i(e,te$4.Zero(),te$4.Zero(),0,0,t)));let m$i=class m extends _n{get iesProfileTexture(){return this._iesProfileTexture}set iesProfileTexture(e){this._iesProfileTexture!==e&&(this._iesProfileTexture=e,this._iesProfileTexture&&m._IsTexture(this._iesProfileTexture)&&this._iesProfileTexture.onLoadObservable.addOnce((()=>{this._markMeshesAsLightDirty();})));}get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(.5*e),this._projectionTextureProjectionLightDirty=true,this.forceProjectionMatrixCompute(),this._computeAngleValues();}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues();}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute();}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=true;}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=true;}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=true;}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=true,this._projectionTexture&&!this._projectionTexture.isReady()&&(m._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled((()=>{this._markMeshesAsLightDirty();})):m._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce((()=>{this._markMeshesAsLightDirty();}))));}static _IsProceduralTexture(e){return void 0!==e.onGeneratedObservable}static _IsTexture(e){return void 0!==e.onLoadObservable}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=false,this._projectionTextureDirty=true;}constructor(e,o,i,n,a,s){super(e,s),this._innerAngle=0,this._iesProfileTexture=null,this._projectionTextureMatrix=re$5.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=te$4.Up(),this._projectionTextureViewLightDirty=true,this._projectionTextureProjectionLightDirty=true,this._projectionTextureDirty=true,this._projectionTextureViewTargetVector=te$4.Zero(),this._projectionTextureViewLightMatrix=re$5.Zero(),this._projectionTextureProjectionLightMatrix=re$5.Zero(),this._projectionTextureScalingMatrix=re$5.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=o,this.direction=i,this.angle=n,this.exponent=a;}getClassName(){return "SpotLight"}getTypeID(){return dn.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=true;}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=true;}_setDefaultShadowProjectionMatrix(e,r,o){const i=this.getScene().activeCamera;if(!i)return;this._shadowAngleScale=this._shadowAngleScale||1;const n=this._shadowAngleScale*this._angle,a=void 0!==this.shadowMinZ?this.shadowMinZ:i.minZ,s=void 0!==this.shadowMaxZ?this.shadowMaxZ:i.maxZ,g=this.getScene().getEngine().useReverseDepthBuffer;re$5.PerspectiveFovLHToRef(n,1,g?s:a,g?a:s,e,true,this._scene.getEngine().isNDCHalfZRange,void 0,g);}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=false,this._projectionTextureDirty=true,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),re$5.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix);}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=false,this._projectionTextureDirty=true;const e=this.projectionTextureLightFar,r=this.projectionTextureLightNear,o=e/(e-r),i=-o*r,n=1/Math.tan(this._angle/2);re$5.FromValuesToRef(n/1,0,0,0,0,n,0,0,0,0,o,1,0,0,i,0,this._projectionTextureProjectionLightMatrix);}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=false,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof Is){const e=this._projectionTexture.uScale/2,r=this._projectionTexture.vScale/2;re$5.FromValuesToRef(e,0,0,0,0,r,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix);}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix);}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create();}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(.5*this._innerAngle)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale;}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this._iesProfileTexture&&this._iesProfileTexture.isReady()&&e.setTexture("iesLightTexture"+t,this._iesProfileTexture),this}transferToEffect(e,t){let o;const i=this._scene.floatingOriginOffset;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x-i.x,this.transformedPosition.y-i.y,this.transformedPosition.z-i.z,this.exponent,t),o=te$4.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x-i.x,this.position.y-i.y,this.position.z-i.z,this.exponent,t),o=te$4.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",o.x,o.y,o.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let o;return o=this.computeTransformedInformation()?te$4.Normalize(this.transformedDirection):te$4.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-o.x,-o.y,-o.z):e.setFloat3(t,o.x,o.y,o.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose(),this._iesProfileTexture&&(this._iesProfileTexture.dispose(),this._iesProfileTexture=null);}getDepthMinZ(e){const t=this._scene.getEngine(),r=void 0!==this.shadowMinZ?this.shadowMinZ:e?.minZ??Qe$1.ShadowMinZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?r:this._scene.getEngine().isNDCHalfZRange?0:r}getDepthMaxZ(e){const t=this._scene.getEngine(),r=void 0!==this.shadowMaxZ?this.shadowMaxZ:e?.maxZ??Qe$1.ShadowMaxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:r}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=true,e["PROJECTEDLIGHTTEXTURE"+t]=!(!this.projectionTexture||!this.projectionTexture.isReady()),e["IESLIGHTTEXTURE"+t]=!(!this._iesProfileTexture||!this._iesProfileTexture.isReady());}};e$z([a$$()],m$i.prototype,"angle",null),e$z([a$$()],m$i.prototype,"innerAngle",null),e$z([a$$()],m$i.prototype,"shadowAngleScale",null),e$z([a$$()],m$i.prototype,"exponent",void 0),e$z([a$$()],m$i.prototype,"projectionTextureLightNear",null),e$z([a$$()],m$i.prototype,"projectionTextureLightFar",null),e$z([a$$()],m$i.prototype,"projectionTextureUpDirection",null),e$z([o$19("projectedLightTexture")],m$i.prototype,"_projectionTexture",void 0),P$9("BABYLON.SpotLight",m$i);const p$g=[{regex:new RegExp("^/nodes/\\d+/extensions/")}];let y$a=class y{constructor(e,t){this._gltf=e,this._infoTree=t;}convert(e){let t,r=this._gltf,o=this._infoTree;if(!e.startsWith("/"))throw new Error("Path must start with a /");const i=e.split("/");if(i.shift(),i[i.length-1].includes(".length")){const e=i[i.length-1].split(".");i.pop(),i.push(...e);}let n=false;for(const a of i){const i="length"===a;if(i&&!o.__array__)throw new Error(`Path ${e} is invalid`);if(o.__ignoreObjectTree__&&(n=true),o.__array__&&!i)o=o.__array__;else if(o=o[a],!o)throw new Error(`Path ${e} is invalid`);if(!n)if(void 0===r){if(!p$g.find((t=>t.regex.test(e))))throw new Error(`Path ${e} is invalid`)}else i||(r=r?.[a]);(o.__target__||i)&&(t=r);}return {object:t,info:o}}};function T$9(e,t,r,o){const i=f$i(e);return o?i[r][o]:i[r]}function f$i(e,t,r){return e._data?.[r?.fillMode??Qe$1.MATERIAL_TriangleFillMode]?.babylonMaterial}function x$b(e,t){return {offset:{componentsCount:2,type:"Vector2",get:(r,o,i)=>{const n=T$9(r,0,e,t);return new ee$4(n?.uOffset,n?.vOffset)},getTarget:f$i,set:(r,o,i,n)=>{const a=T$9(o,0,e,t);a.uOffset=r.x,a.vOffset=r.y;},getPropertyName:[()=>`${e}${t?"."+t:""}.uOffset`,()=>`${e}${t?"."+t:""}.vOffset`]},rotation:{type:"number",get:(r,o,i)=>T$9(r,0,e,t)?.wAng,getTarget:f$i,set:(r,o,i,n)=>T$9(o,0,e,t).wAng=r,getPropertyName:[()=>`${e}${t?"."+t:""}.wAng`]},scale:{componentsCount:2,type:"Vector2",get:(r,o,i)=>{const n=T$9(r,0,e,t);return new ee$4(n?.uScale,n?.vScale)},getTarget:f$i,set:(r,o,i,n)=>{const a=T$9(o,0,e,t);a.uScale=r.x,a.vScale=r.y;},getPropertyName:[()=>`${e}${t?"."+t:""}.uScale`,()=>`${e}${t?"."+t:""}.vScale`]}}}const b$d={cameras:{__array__:{__target__:true,orthographic:{xmag:{componentsCount:2,type:"Vector2",get:e=>new ee$4(e._babylonCamera?.orthoLeft??0,e._babylonCamera?.orthoRight??0),set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.orthoLeft=e.x,t._babylonCamera.orthoRight=e.y);},getTarget:e=>e,getPropertyName:[()=>"orthoLeft",()=>"orthoRight"]},ymag:{componentsCount:2,type:"Vector2",get:e=>new ee$4(e._babylonCamera?.orthoBottom??0,e._babylonCamera?.orthoTop??0),set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.orthoBottom=e.x,t._babylonCamera.orthoTop=e.y);},getTarget:e=>e,getPropertyName:[()=>"orthoBottom",()=>"orthoTop"]},zfar:{type:"number",get:e=>e._babylonCamera?.maxZ,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.maxZ=e);},getTarget:e=>e,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:e=>e._babylonCamera?.minZ,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.minZ=e);},getTarget:e=>e,getPropertyName:[()=>"minZ"]}},perspective:{aspectRatio:{type:"number",get:e=>e._babylonCamera?.getEngine().getAspectRatio(e._babylonCamera),getTarget:e=>e,getPropertyName:[()=>"aspectRatio"],isReadOnly:true},yfov:{type:"number",get:e=>e._babylonCamera?.fov,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.fov=e);},getTarget:e=>e,getPropertyName:[()=>"fov"]},zfar:{type:"number",get:e=>e._babylonCamera?.maxZ,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.maxZ=e);},getTarget:e=>e,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:e=>e._babylonCamera?.minZ,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.minZ=e);},getTarget:e=>e,getPropertyName:[()=>"minZ"]}}}},nodes:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map((e=>e._babylonTransformNode)),getPropertyName:[()=>"length"]},__array__:{__target__:true,translation:{type:"Vector3",get:e=>e._babylonTransformNode?.position,set:(e,t)=>t._babylonTransformNode?.position.copyFrom(e),getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"position"]},rotation:{type:"Quaternion",get:e=>e._babylonTransformNode?.rotationQuaternion,set:(e,t)=>t._babylonTransformNode?.rotationQuaternion?.copyFrom(e),getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"rotationQuaternion"]},scale:{type:"Vector3",get:e=>e._babylonTransformNode?.scaling,set:(e,t)=>t._babylonTransformNode?.scaling.copyFrom(e),getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"scaling"]},weights:{length:{type:"number",get:e=>e._numMorphTargets,getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"influence"]},__array__:{__target__:true,type:"number",get:(e,t)=>void 0!==t?e._primitiveBabylonMeshes?.[0].morphTargetManager?.getTarget(t).influence:void 0,getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"influence"]},type:"number[]",get:(e,t)=>[0],getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"influence"]},matrix:{type:"Matrix",get:e=>re$5.Compose(e._babylonTransformNode?.scaling,e._babylonTransformNode?.rotationQuaternion,e._babylonTransformNode?.position),getTarget:e=>e._babylonTransformNode,isReadOnly:true},globalMatrix:{type:"Matrix",get:e=>{const r=re$5.Identity();let o=e.parent;for(;o&&o.parent;)o=o.parent;const i=e._babylonTransformNode?.position._isDirty||e._babylonTransformNode?.rotationQuaternion?._isDirty||e._babylonTransformNode?.scaling._isDirty;if(o){const t=o._babylonTransformNode?.computeWorldMatrix(true).invert();t&&e._babylonTransformNode?.computeWorldMatrix(i)?.multiplyToRef(t,r);}else e._babylonTransformNode&&r.copyFrom(e._babylonTransformNode.computeWorldMatrix(i));return r},getTarget:e=>e._babylonTransformNode,isReadOnly:true},extensions:{EXT_lights_ies:{multiplier:{type:"number",get:e=>e._babylonTransformNode?.getChildren((e=>e instanceof m$i),true)[0]?.intensity,getTarget:e=>e._babylonTransformNode?.getChildren((e=>e instanceof m$i),true)[0],set:(e,t)=>{if(t._babylonTransformNode){const r=t._babylonTransformNode.getChildren((e=>e instanceof m$i),true)[0];r&&(r.intensity=e);}}},color:{type:"Color3",get:e=>e._babylonTransformNode?.getChildren((e=>e instanceof m$i),true)[0]?.diffuse,getTarget:e=>e._babylonTransformNode?.getChildren((e=>e instanceof m$i),true)[0],set:(e,t)=>{if(t._babylonTransformNode){const r=t._babylonTransformNode.getChildren((e=>e instanceof m$i),true)[0];r&&(r.diffuse=e);}}}},KHR_node_visibility:{visible:{type:"boolean",get:e=>!!e._primitiveBabylonMeshes&&e._primitiveBabylonMeshes[0].isVisible,getTarget:()=>{},set:(e,t)=>{t._primitiveBabylonMeshes&&t._primitiveBabylonMeshes.forEach((t=>t.isVisible=e));}}}}}},materials:{__array__:{__target__:true,emissiveFactor:{type:"Color3",get:(e,t,r)=>f$i(e,t,r).emissiveColor,set:(e,t,r,o)=>f$i(t,r,o).emissiveColor.copyFrom(e),getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"emissiveColor"]},emissiveTexture:{extensions:{KHR_texture_transform:x$b("emissiveTexture")}},normalTexture:{scale:{type:"number",get:(e,t,r)=>T$9(e,r,"bumpTexture")?.level,set:(e,t,r,o)=>{const i=T$9(t,o,"bumpTexture");i&&(i.level=e);},getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"level"]},extensions:{KHR_texture_transform:x$b("bumpTexture")}},occlusionTexture:{strength:{type:"number",get:(e,t,r)=>f$i(e,t,r).ambientTextureStrength,set:(e,t,r,o)=>{const i=f$i(t,r,o);i&&(i.ambientTextureStrength=e);},getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"ambientTextureStrength"]},extensions:{KHR_texture_transform:x$b("ambientTexture")}},pbrMetallicRoughness:{baseColorFactor:{type:"Color4",get:(e,t,r)=>{const o=f$i(e,t,r);return me$3.FromColor3(o.albedoColor,o.alpha)},set:(e,t,r,o)=>{const i=f$i(t,r,o);i.albedoColor.set(e.r,e.g,e.b),i.alpha=e.a;},getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"albedoColor",()=>"alpha"]},baseColorTexture:{extensions:{KHR_texture_transform:x$b("albedoTexture")}},metallicFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).metallic,set:(e,t,r,o)=>{const i=f$i(t,r,o);i&&(i.metallic=e);},getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"metallic"]},roughnessFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).roughness,set:(e,t,r,o)=>{const i=f$i(t,r,o);i&&(i.roughness=e);},getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"roughness"]},metallicRoughnessTexture:{extensions:{KHR_texture_transform:x$b("metallicTexture")}}},extensions:{KHR_materials_anisotropy:{anisotropyStrength:{type:"number",get:(e,t,r)=>f$i(e,t,r).anisotropy.intensity,set:(e,t,r,o)=>{f$i(t,r,o).anisotropy.intensity=e;},getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"anisotropy.intensity"]},anisotropyRotation:{type:"number",get:(e,t,r)=>f$i(e,t,r).anisotropy.angle,set:(e,t,r,o)=>{f$i(t,r,o).anisotropy.angle=e;},getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"anisotropy.angle"]},anisotropyTexture:{extensions:{KHR_texture_transform:x$b("anisotropy","texture")}}},KHR_materials_clearcoat:{clearcoatFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).clearCoat.intensity,set:(e,t,r,o)=>{f$i(t,r,o).clearCoat.intensity=e;},getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"clearCoat.intensity"]},clearcoatRoughnessFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).clearCoat.roughness,set:(e,t,r,o)=>{f$i(t,r,o).clearCoat.roughness=e;},getTarget:(e,t,r)=>f$i(e,t,r),getPropertyName:[()=>"clearCoat.roughness"]},clearcoatTexture:{extensions:{KHR_texture_transform:x$b("clearCoat","texture")}},clearcoatNormalTexture:{scale:{type:"number",get:(e,t,r)=>f$i(e,t,r).clearCoat.bumpTexture?.level,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).clearCoat.bumpTexture.level=e},extensions:{KHR_texture_transform:x$b("clearCoat","bumpTexture")}},clearcoatRoughnessTexture:{extensions:{KHR_texture_transform:x$b("clearCoat","textureRoughness")}}},KHR_materials_dispersion:{dispersion:{type:"number",get:(e,t,r)=>f$i(e,t,r).subSurface.dispersion,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).subSurface.dispersion=e}},KHR_materials_emissive_strength:{emissiveStrength:{type:"number",get:(e,t,r)=>f$i(e,t,r).emissiveIntensity,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).emissiveIntensity=e}},KHR_materials_ior:{ior:{type:"number",get:(e,t,r)=>f$i(e,t,r).indexOfRefraction,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).indexOfRefraction=e}},KHR_materials_iridescence:{iridescenceFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).iridescence.intensity,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).iridescence.intensity=e},iridescenceIor:{type:"number",get:(e,t,r)=>f$i(e,t,r).iridescence.indexOfRefraction,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).iridescence.indexOfRefraction=e},iridescenceTexture:{extensions:{KHR_texture_transform:x$b("iridescence","texture")}},iridescenceThicknessMaximum:{type:"number",get:(e,t,r)=>f$i(e,t,r).iridescence.maximumThickness,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).iridescence.maximumThickness=e},iridescenceThicknessMinimum:{type:"number",get:(e,t,r)=>f$i(e,t,r).iridescence.minimumThickness,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).iridescence.minimumThickness=e},iridescenceThicknessTexture:{extensions:{KHR_texture_transform:x$b("iridescence","thicknessTexture")}}},KHR_materials_sheen:{sheenColorFactor:{type:"Color3",get:(e,t,r)=>f$i(e,t,r).sheen.color,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).sheen.color.copyFrom(e)},sheenColorTexture:{extensions:{KHR_texture_transform:x$b("sheen","texture")}},sheenRoughnessFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).sheen.intensity,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).sheen.intensity=e},sheenRoughnessTexture:{extensions:{KHR_texture_transform:x$b("sheen","thicknessTexture")}}},KHR_materials_specular:{specularFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).metallicF0Factor,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).metallicF0Factor=e,getPropertyName:[()=>"metallicF0Factor"]},specularColorFactor:{type:"Color3",get:(e,t,r)=>f$i(e,t,r).metallicReflectanceColor,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).metallicReflectanceColor.copyFrom(e),getPropertyName:[()=>"metallicReflectanceColor"]},specularTexture:{extensions:{KHR_texture_transform:x$b("metallicReflectanceTexture")}},specularColorTexture:{extensions:{KHR_texture_transform:x$b("reflectanceTexture")}}},KHR_materials_transmission:{transmissionFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).subSurface.refractionIntensity,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).subSurface.refractionIntensity=e,getPropertyName:[()=>"subSurface.refractionIntensity"]},transmissionTexture:{extensions:{KHR_texture_transform:x$b("subSurface","refractionIntensityTexture")}}},KHR_materials_diffuse_transmission:{diffuseTransmissionFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).subSurface.translucencyIntensity,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).subSurface.translucencyIntensity=e},diffuseTransmissionTexture:{extensions:{KHR_texture_transform:x$b("subSurface","translucencyIntensityTexture")}},diffuseTransmissionColorFactor:{type:"Color3",get:(e,t,r)=>f$i(e,t,r).subSurface.translucencyColor,getTarget:f$i,set:(e,t,r,o)=>e&&f$i(t,r,o).subSurface.translucencyColor?.copyFrom(e)},diffuseTransmissionColorTexture:{extensions:{KHR_texture_transform:x$b("subSurface","translucencyColorTexture")}}},KHR_materials_volume:{attenuationColor:{type:"Color3",get:(e,t,r)=>f$i(e,t,r).subSurface.tintColor,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).subSurface.tintColor.copyFrom(e)},attenuationDistance:{type:"number",get:(e,t,r)=>f$i(e,t,r).subSurface.tintColorAtDistance,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).subSurface.tintColorAtDistance=e},thicknessFactor:{type:"number",get:(e,t,r)=>f$i(e,t,r).subSurface.maximumThickness,getTarget:f$i,set:(e,t,r,o)=>f$i(t,r,o).subSurface.maximumThickness=e},thicknessTexture:{extensions:{KHR_texture_transform:x$b("subSurface","thicknessTexture")}}}}}},extensions:{KHR_lights_punctual:{lights:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map((e=>e._babylonLight)),getPropertyName:[e=>"length"]},__array__:{__target__:true,color:{type:"Color3",get:e=>e._babylonLight?.diffuse,set:(e,t)=>t._babylonLight?.diffuse.copyFrom(e),getTarget:e=>e._babylonLight,getPropertyName:[e=>"diffuse"]},intensity:{type:"number",get:e=>e._babylonLight?.intensity,set:(e,t)=>t._babylonLight?t._babylonLight.intensity=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"intensity"]},range:{type:"number",get:e=>e._babylonLight?.range,set:(e,t)=>t._babylonLight?t._babylonLight.range=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"range"]},spot:{innerConeAngle:{type:"number",get:e=>e._babylonLight?.innerAngle,set:(e,t)=>t._babylonLight?t._babylonLight.innerAngle=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"innerConeAngle"]},outerConeAngle:{type:"number",get:e=>e._babylonLight?.angle,set:(e,t)=>t._babylonLight?t._babylonLight.angle=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"outerConeAngle"]}}}}},EXT_lights_ies:{lights:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map((e=>e._babylonLight)),getPropertyName:[e=>"length"]}}},EXT_lights_image_based:{lights:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map((e=>e._babylonTexture)),getPropertyName:[e=>"length"]},__array__:{__target__:true,intensity:{type:"number",get:e=>e._babylonTexture?.level,set:(e,t)=>{t._babylonTexture&&(t._babylonTexture.level=e);},getTarget:e=>e._babylonTexture},rotation:{type:"Quaternion",get:e=>e._babylonTexture&&se$5.FromRotationMatrix(e._babylonTexture?.getReflectionTextureMatrix()),set:(e,r)=>{r._babylonTexture&&(r._babylonTexture.getScene()?.useRightHandedSystem||(e=se$5.Inverse(e)),re$5.FromQuaternionToRef(e,r._babylonTexture.getReflectionTextureMatrix()));},getTarget:e=>e._babylonTexture}}}}},animations:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map((e=>e._babylonAnimationGroup)),getPropertyName:[()=>"length"]},__array__:{}},meshes:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map((e=>e.primitives[0]._instanceData?.babylonSourceMesh)),getPropertyName:[()=>"length"]},__array__:{}}};function d$f(e){return new y$a(e,b$d)}function j$4(e){const t=e.split("/").map((e=>e.replace(/{}/g,"__array__")));let r=b$d;for(const e of t)e&&(r=r[e]);if(r&&r.type&&r.get)return r}function P$7(e,t){const r=e.split("/").map((e=>e.replace(/{}/g,"__array__")));let o=b$d;for(const e of r)e&&(o=o[e]);o&&o.type&&o.get&&(o.interpolation=t);}function C$a(e,t){const r=e.split("/").map((e=>e.replace(/{}/g,"__array__")));let o=b$d;for(const e of r)if(e){if(!o[e]){if("?"===e){o.__ignoreObjectTree__=true;continue}o[e]={},"__array__"===e&&(o[e].__target__=true);}o=o[e];}Object.assign(o,t);}let se$4=class se{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array;}attachControl(s){s=Ai.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0;})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((e=>{const n=e.event;if(!n.metaKey)if(e.type===en.KEYDOWN){if(-1!==this.keysUp.indexOf(n.keyCode)||-1!==this.keysDown.indexOf(n.keyCode)||-1!==this.keysLeft.indexOf(n.keyCode)||-1!==this.keysRight.indexOf(n.keyCode)||-1!==this.keysUpward.indexOf(n.keyCode)||-1!==this.keysDownward.indexOf(n.keyCode)||-1!==this.keysRotateLeft.indexOf(n.keyCode)||-1!==this.keysRotateRight.indexOf(n.keyCode)||-1!==this.keysRotateUp.indexOf(n.keyCode)||-1!==this.keysRotateDown.indexOf(n.keyCode)){ -1===this._keys.indexOf(n.keyCode)&&this._keys.push(n.keyCode),s||n.preventDefault();}}else if(-1!==this.keysUp.indexOf(n.keyCode)||-1!==this.keysDown.indexOf(n.keyCode)||-1!==this.keysLeft.indexOf(n.keyCode)||-1!==this.keysRight.indexOf(n.keyCode)||-1!==this.keysUpward.indexOf(n.keyCode)||-1!==this.keysDownward.indexOf(n.keyCode)||-1!==this.keysRotateLeft.indexOf(n.keyCode)||-1!==this.keysRotateRight.indexOf(n.keyCode)||-1!==this.keysRotateUp.indexOf(n.keyCode)||-1!==this.keysRotateDown.indexOf(n.keyCode)){const e=this._keys.indexOf(n.keyCode);e>=0&&this._keys.splice(e,1),s||n.preventDefault();}})));}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0;}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const n=this._keys[t],i=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(n)?e._localDirection.copyFromFloats(-i,0,0):-1!==this.keysUp.indexOf(n)?e._localDirection.copyFromFloats(0,0,i):-1!==this.keysRight.indexOf(n)?e._localDirection.copyFromFloats(i,0,0):-1!==this.keysDown.indexOf(n)?e._localDirection.copyFromFloats(0,0,-i):-1!==this.keysUpward.indexOf(n)?e._localDirection.copyFromFloats(0,i,0):-1!==this.keysDownward.indexOf(n)?e._localDirection.copyFromFloats(0,-i,0):-1!==this.keysRotateLeft.indexOf(n)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(n)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(n)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(n)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),te$4.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection);}}}getClassName(){return "FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0;}getSimpleName(){return "keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}};e$z([a$$()],se$4.prototype,"keysUp",void 0),e$z([a$$()],se$4.prototype,"keysUpward",void 0),e$z([a$$()],se$4.prototype,"keysDown",void 0),e$z([a$$()],se$4.prototype,"keysDownward",void 0),e$z([a$$()],se$4.prototype,"keysLeft",void 0),e$z([a$$()],se$4.prototype,"keysRight",void 0),e$z([a$$()],se$4.prototype,"rotationSpeed",void 0),e$z([a$$()],se$4.prototype,"keysRotateLeft",void 0),e$z([a$$()],se$4.prototype,"keysRotateRight",void 0),e$z([a$$()],se$4.prototype,"keysRotateUp",void 0),e$z([a$$()],se$4.prototype,"keysRotateDown",void 0),qr.FreeCameraKeyboardMoveInput=se$4;let ne$4=class ne{constructor(e=true){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new R$g,this._allowCameraRotation=true,this._currentActiveButton=-1,this._activePointerId=-1;}attachControl(t){t=Ai.BackCompatCameraNoPreventDefault(arguments);const s=this.camera.getEngine(),n=s.getInputElement();this._pointerInput||(this._pointerInput=e=>{const i=e.event,r="touch"===i.pointerType;if(!this.touchEnabled&&r)return;if(e.type!==Ar$1.POINTERMOVE&&-1===this.buttons.indexOf(i.button))return;const o=i.target;if(e.type===Ar$1.POINTERDOWN){if(r&&-1!==this._activePointerId||!r&&-1!==this._currentActiveButton)return;this._activePointerId=i.pointerId;try{o?.setPointerCapture(i.pointerId);}catch(e){} -1===this._currentActiveButton&&(this._currentActiveButton=i.button),this._previousPosition={x:i.clientX,y:i.clientY},t||(i.preventDefault(),n&&n.focus()),s.isPointerLock&&this._onMouseMove&&this._onMouseMove(e.event);}else if(e.type===Ar$1.POINTERUP){if(r&&this._activePointerId!==i.pointerId||!r&&this._currentActiveButton!==i.button)return;try{o?.releasePointerCapture(i.pointerId);}catch(e){}this._currentActiveButton=-1,this._previousPosition=null,t||i.preventDefault(),this._activePointerId=-1;}else if(e.type===Ar$1.POINTERMOVE&&(this._activePointerId===i.pointerId||!r))if(s.isPointerLock&&this._onMouseMove)this._onMouseMove(e.event);else if(this._previousPosition){const e=this.camera._calculateHandednessMultiplier(),s=(i.clientX-this._previousPosition.x)*e,n=(i.clientY-this._previousPosition.y)*e;this._allowCameraRotation&&(this.camera.cameraRotation.y+=s/this.angularSensibility,this.camera.cameraRotation.x+=n/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:s,offsetY:n}),this._previousPosition={x:i.clientX,y:i.clientY},t||i.preventDefault();}}),this._onMouseMove=e=>{if(!s.isPointerLock)return;const n=this.camera._calculateHandednessMultiplier();this.camera.cameraRotation.y+=e.movementX*n/this.angularSensibility,this.camera.cameraRotation.x+=e.movementY*n/this.angularSensibility,this._previousPosition=null,t||e.preventDefault();},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ar$1.POINTERDOWN|Ar$1.POINTERUP|Ar$1.POINTERMOVE),n&&(this._contextMenuBind=e=>this.onContextMenu(e),n.addEventListener("contextmenu",this._contextMenuBind,false));}onContextMenu(e){e.preventDefault();}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind);}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null;}this._activePointerId=-1,this._currentActiveButton=-1;}getClassName(){return "FreeCameraMouseInput"}getSimpleName(){return "mouse"}};e$z([a$$()],ne$4.prototype,"buttons",void 0),e$z([a$$()],ne$4.prototype,"angularSensibility",void 0),qr.FreeCameraMouseInput=ne$4;let ie$4=class ie{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new R$g,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120;}attachControl(t){t=Ai.BackCompatCameraNoPreventDefault(arguments),this._wheel=e=>{if(e.type!==Ar$1.POINTERWHEEL)return;const s=e.event,n=s.deltaMode===nn.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*n*s.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*n*s.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*n*s.deltaZ/this._normalize,s.preventDefault&&(t||s.preventDefault());},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ar$1.POINTERWHEEL);}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear();}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0;}getClassName(){return "BaseCameraMouseWheelInput"}getSimpleName(){return "mousewheel"}};var re$4,oe$4,ae$4,le$3;e$z([a$$()],ie$4.prototype,"wheelPrecisionX",void 0),e$z([a$$()],ie$4.prototype,"wheelPrecisionY",void 0),e$z([a$$()],ie$4.prototype,"wheelPrecisionZ",void 0),function(e){e[e.MoveRelative=0]="MoveRelative",e[e.RotateRelative=1]="RotateRelative",e[e.MoveScene=2]="MoveScene";}(re$4||(re$4={}));let he$4=class he extends ie$4{constructor(){super(...arguments),this._moveRelative=te$4.Zero(),this._rotateRelative=te$4.Zero(),this._moveScene=te$4.Zero(),this._wheelXAction=re$4.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=re$4.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null;}getClassName(){return "FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==re$4.MoveRelative||(this._wheelXAction=re$4.MoveRelative,this._wheelXActionCoordinate=e);}get wheelXMoveRelative(){return this._wheelXAction!==re$4.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==re$4.MoveRelative||(this._wheelYAction=re$4.MoveRelative,this._wheelYActionCoordinate=e);}get wheelYMoveRelative(){return this._wheelYAction!==re$4.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==re$4.MoveRelative||(this._wheelZAction=re$4.MoveRelative,this._wheelZActionCoordinate=e);}get wheelZMoveRelative(){return this._wheelZAction!==re$4.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==re$4.RotateRelative||(this._wheelXAction=re$4.RotateRelative,this._wheelXActionCoordinate=e);}get wheelXRotateRelative(){return this._wheelXAction!==re$4.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==re$4.RotateRelative||(this._wheelYAction=re$4.RotateRelative,this._wheelYActionCoordinate=e);}get wheelYRotateRelative(){return this._wheelYAction!==re$4.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==re$4.RotateRelative||(this._wheelZAction=re$4.RotateRelative,this._wheelZActionCoordinate=e);}get wheelZRotateRelative(){return this._wheelZAction!==re$4.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==re$4.MoveScene||(this._wheelXAction=re$4.MoveScene,this._wheelXActionCoordinate=e);}get wheelXMoveScene(){return this._wheelXAction!==re$4.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==re$4.MoveScene||(this._wheelYAction=re$4.MoveScene,this._wheelYActionCoordinate=e);}get wheelYMoveScene(){return this._wheelYAction!==re$4.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==re$4.MoveScene||(this._wheelZAction=re$4.MoveScene,this._wheelZActionCoordinate=e);}get wheelZMoveScene(){return this._wheelZAction!==re$4.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=re$5.Zero();this.camera.getViewMatrix().invertToRef(e);const t=te$4.Zero();te$4.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs();}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate);}_updateCameraProperty(e,t,s){if(0===e)return;if(null===t||null===s)return;let n=null;switch(t){case re$4.MoveRelative:n=this._moveRelative;break;case re$4.RotateRelative:n=this._rotateRelative;break;case re$4.MoveScene:n=this._moveScene;}switch(s){case 0:n.set(e,0,0);break;case 1:n.set(0,e,0);break;case 2:n.set(0,0,e);}}};e$z([a$$()],he$4.prototype,"wheelXMoveRelative",null),e$z([a$$()],he$4.prototype,"wheelYMoveRelative",null),e$z([a$$()],he$4.prototype,"wheelZMoveRelative",null),e$z([a$$()],he$4.prototype,"wheelXRotateRelative",null),e$z([a$$()],he$4.prototype,"wheelYRotateRelative",null),e$z([a$$()],he$4.prototype,"wheelZRotateRelative",null),e$z([a$$()],he$4.prototype,"wheelXMoveScene",null),e$z([a$$()],he$4.prototype,"wheelYMoveScene",null),e$z([a$$()],he$4.prototype,"wheelZMoveScene",null),qr.FreeCameraMouseWheelInput=he$4;let ce$3=class ce{constructor(t=false){this.allowMouse=t,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=false,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=Ai.IsSafari();}attachControl(t){t=Ai.BackCompatCameraNoPreventDefault(arguments);let s=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null;},this._pointerInput=e=>{const n=e.event,i="mouse"===n.pointerType||this._isSafari&&void 0===n.pointerType;if(this.allowMouse||!i)if(e.type===Ar$1.POINTERDOWN){if(t||n.preventDefault(),this._pointerPressed.push(n.pointerId),1!==this._pointerPressed.length)return;s={x:n.clientX,y:n.clientY};}else if(e.type===Ar$1.POINTERUP){t||n.preventDefault();const e=this._pointerPressed.indexOf(n.pointerId);if(-1===e)return;if(this._pointerPressed.splice(e,1),0!=e)return;s=null,this._offsetX=null,this._offsetY=null;}else if(e.type===Ar$1.POINTERMOVE){if(t||n.preventDefault(),!s)return;if(0!=this._pointerPressed.indexOf(n.pointerId))return;this._offsetX=n.clientX-s.x,this._offsetY=-(n.clientY-s.y);}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ar$1.POINTERDOWN|Ar$1.POINTERUP|Ar$1.POINTERMOVE),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.addEventListener("blur",this._onLostFocus);}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null;}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null;}}checkInputs(){if(null===this._offsetX||null===this._offsetY)return;if(0===this._offsetX&&0===this._offsetY)return;const e=this.camera,t=e._calculateHandednessMultiplier();e.cameraRotation.y=this._offsetX*t/this.touchAngularSensibility;if(this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY*t/this.touchAngularSensibility;else {const t=e._computeLocalCameraSpeed(),n=new te$4(0,0,0!==this.touchMoveSensibility?t*this._offsetY/this.touchMoveSensibility:0);re$5.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(te$4.TransformCoordinates(n,e._cameraRotationMatrix));}}getClassName(){return "FreeCameraTouchInput"}getSimpleName(){return "touch"}};e$z([a$$()],ce$3.prototype,"touchAngularSensibility",void 0),e$z([a$$()],ce$3.prototype,"touchMoveSensibility",void 0),qr.FreeCameraTouchInput=ce$3;let de$2=class de extends Zr{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null;}addKeyboard(){return this.add(new se$4),this}addMouse(e=true){return this._mouseInput||(this._mouseInput=new ne$4(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new he$4,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new ce$3),this}clear(){super.clear(),this._mouseInput=null;}};let ue$3=class ue extends jr{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e);}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e);}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e);}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e);}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e);}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e);}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e);}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e);}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e);}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e);}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e);}constructor(e,t,n,i=true){super(e,t,n,i),this.ellipsoid=new te$4(.5,1,.5),this.ellipsoidOffset=new te$4(0,0,0),this.checkCollisions=false,this.applyGravity=false,this._needMoveForGravity=false,this._oldPosition=te$4.Zero(),this._diffPosition=te$4.Zero(),this._newPosition=te$4.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,s=null)=>{this._newPosition.copyFrom(t),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>jt.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=true:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&s&&this.onCollide(s));},this.inputs=new de$2(this),this.inputs.addKeyboard().addMouse();}attachControl(t,s){s=Ai.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(s);}detachControl(){this.inputs.detachElement(),this.cameraDirection=new te$4(0,0,0),this.cameraRotation=new ee$4(0,0);}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e;}_collideWithWorld(e){let t;t=this.parent?te$4.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let i=e;this.applyGravity&&(i=e.add(this.getScene().gravity)),n.getNewPosition(this._oldPosition,i,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId);}_checkInputs(){this._localDirection||(this._localDirection=te$4.Zero(),this._transformedDirection=te$4.Zero()),this.inputs.checkInputs(),super._checkInputs();}set needMoveForGravity(e){this._needMoveForGravity=e;}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition();}dispose(){this.inputs.clear(),super.dispose();}getClassName(){return "FreeCamera"}};e$z([u$s()],ue$3.prototype,"ellipsoid",void 0),e$z([u$s()],ue$3.prototype,"ellipsoidOffset",void 0),e$z([a$$()],ue$3.prototype,"checkCollisions",void 0),e$z([a$$()],ue$3.prototype,"applyGravity",void 0),P$9("BABYLON.FreeCamera",ue$3);let _e$2=class _e{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e);}get animationPropertiesOverride(){return !this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e;}constructor(e,t=0,s=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uv2s=null,this._colors=null,this._uniqueId=0,this.onInfluenceChanged=new R$g,this._onDataLayoutChanged=new R$g,this._animationPropertiesOverride=null,this.id=e,this._scene=s||L$7.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId());}get uniqueId(){return this._uniqueId}get hasPositions(){return !!this._positions}get hasNormals(){return !!this._normals}get hasTangents(){return !!this._tangents}get hasUVs(){return !!this._uvs}get hasUV2s(){return !!this._uv2s}get hasColors(){return !!this._colors}get vertexCount(){return this._positions?this._positions.length/3:this._normals?this._normals.length/3:this._tangents?this._tangents.length/3:this._uvs?this._uvs.length/2:this._uv2s?this._uv2s.length/2:this._colors?this._colors.length/4:0}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0);}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0);}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0);}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0);}getUVs(){return this._uvs}setUV2s(e){const t=this.hasUV2s;this._uv2s=e,t!==this.hasUV2s&&this._onDataLayoutChanged.notifyObservers(void 0);}getUV2s(){return this._uv2s}setColors(e){const t=this.hasColors;this._colors=e,t!==this.hasColors&&this._onDataLayoutChanged.notifyObservers(void 0);}getColors(){return this._colors}clone(){const e=Ae$3.Clone((()=>new _e(this.name,this.influence,this._scene)),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e._uv2s=this._uv2s,e._colors=this._colors,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),this.hasUV2s&&(e.uv2s=Array.prototype.slice.call(this.getUV2s())),this.hasColors&&(e.colors=Array.prototype.slice.call(this.getColors())),Ae$3.AppendSerializedAnimations(this,e),e}getClassName(){return "MorphTarget"}static Parse(e,t){const s=new _e(e.name,e.influence);if(s.setPositions(e.positions),null!=e.id&&(s.id=e.id),e.normals&&s.setNormals(e.normals),e.tangents&&s.setTangents(e.tangents),e.uvs&&s.setUVs(e.uvs),e.uv2s&&s.setUV2s(e.uv2s),e.colors&&s.setColors(e.colors),e.animations){for(let t=0;t<e.animations.length;t++){const n=e.animations[t],i=O$g("BABYLON.Animation");i&&s.animations.push(i.Parse(n));}e.autoAnimate&&t&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1);}return s}static FromMesh(e,t,s){t||(t=e.name);const n=new _e(t,s,e.getScene());return n.setPositions(e.getVerticesData(Hi.PositionKind)),e.isVerticesDataPresent(Hi.NormalKind)&&n.setNormals(e.getVerticesData(Hi.NormalKind)),e.isVerticesDataPresent(Hi.TangentKind)&&n.setTangents(e.getVerticesData(Hi.TangentKind)),e.isVerticesDataPresent(Hi.UVKind)&&n.setUVs(e.getVerticesData(Hi.UVKind)),e.isVerticesDataPresent(Hi.UV2Kind)&&n.setUV2s(e.getVerticesData(Hi.UV2Kind)),e.isVerticesDataPresent(Hi.ColorKind)&&n.setColors(e.getVerticesData(Hi.ColorKind)),n}};e$z([a$$()],_e$2.prototype,"id",void 0);let pe$2=class pe extends Is{get depth(){return this._depth}constructor(e,t,s,n,i,r,o=true,a=false,l=Is.TRILINEAR_SAMPLINGMODE,h=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,c){super(null,r,!o,a),this.format=i,this._texture=r.getEngine().createRawTexture2DArray(e,t,s,n,i,o,a,l,null,h,c),this._depth=n,this.is2DArray=true;}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type);}static CreateRGBATexture(e,t,s,n,i,r=true,o=false,a=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,l=Qe$1.TEXTURETYPE_UNSIGNED_BYTE){return new pe(e,t,s,n,Qe$1.TEXTUREFORMAT_RGBA,i,r,o,a,l)}};let me$2=class me{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(this._forceUpdateWhenUnfrozen),this._forceUpdateWhenUnfrozen=false));}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new Ii(16),this._supportsPositions=false,this._supportsNormals=false,this._supportsTangents=false,this._supportsUVs=false,this._supportsUV2s=false,this._supportsColors=false,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=false,this._blockCounter=0,this._mustSynchronize=true,this._forceUpdateWhenUnfrozen=false,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=true,this.enablePositionMorphing=true,this.enableNormalMorphing=true,this.enableTangentMorphing=true,this.enableUVMorphing=true,this.enableUV2Morphing=true,this.enableColorMorphing=true,this._numMaxInfluencers=0,this._useTextureToStoreTargets=true,this.metadata=null,this._influencesAreDirty=false,this._needUpdateInfluences=false,e||(e=L$7.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const e=this._scene.getEngine().getCaps();this._canUseTextureForTargets=e.canUseGLVertexID&&e.textureFloat&&e.maxVertexTextureImageUnits>0&&e.texture2DArrayMaxLayerCount>1;}}get numMaxInfluencers(){return me.ConstantTargetCountForTextureMode>0&&this.isUsingTextureForTargets?me.ConstantTargetCountForTextureMode:this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._mustSynchronize=true,this._syncActiveTargets());}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsPositions(){return this._supportsPositions&&this.enablePositionMorphing}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get supportsUV2s(){return this._supportsUV2s&&this.enableUV2Morphing}get supportsColors(){return this._supportsColors&&this.enableColorMorphing}get hasPositions(){return this._supportsPositions}get hasNormals(){return this._supportsNormals}get hasTangents(){return this._supportsTangents}get hasUVs(){return this._supportsUVs}get hasUV2s(){return this._supportsUV2s}get hasColors(){return this._supportsColors}get numTargets(){return this._targets.length}get numInfluencers(){return this._influencesAreDirty&&this._syncActiveTargets(),this._activeTargets.length}get influences(){return this._influencesAreDirty&&this._syncActiveTargets(),this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets!==e&&(this._useTextureToStoreTargets=e,this._mustSynchronize=true,this._syncActiveTargets());}get isUsingTextureForTargets(){return me.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!this._scene?.getEngine().getCaps().disableMorphTargetTexture}getActiveTarget(e){return this._influencesAreDirty&&this._syncActiveTargets(),this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(const t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add((e=>{this.areUpdatesFrozen&&e&&(this._forceUpdateWhenUnfrozen=true),this._influencesAreDirty=true,this._needUpdateInfluences=this._needUpdateInfluences||e;}))),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add((()=>{this._mustSynchronize=true,this._syncActiveTargets();}))),this._mustSynchronize=true,this._syncActiveTargets();}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._mustSynchronize=true,this._syncActiveTargets()),this._scene&&this._scene.stopAnimation(e);}_bind(e){this._influencesAreDirty&&this._syncActiveTargets(),e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setFloat("morphTargetCount",this.numInfluencers);}clone(){const e=new me(this._scene);e.areUpdatesFrozen=true;for(const t of this._targets)e.addTarget(t.clone());return e.areUpdatesFrozen=false,e.enablePositionMorphing=this.enablePositionMorphing,e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e.enableUV2Morphing=this.enableUV2Morphing,e.enableColorMorphing=this.enableColorMorphing,e.metadata=this.metadata,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return this.metadata&&(e.metadata=this.metadata),e}_syncActiveTargets(e=false){if(this.areUpdatesFrozen)return;e=e||this._needUpdateInfluences,this._needUpdateInfluences=false,this._influencesAreDirty=false;const t=!!this._targetStoreTexture,s=this.isUsingTextureForTargets;(this._mustSynchronize||t!==s)&&(this._mustSynchronize=false,this.synchronize());let n=0;this._activeTargets.reset(),this._morphTargetTextureIndices&&this._morphTargetTextureIndices.length===this._targets.length||(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const e of this._targets)if(i++,0!==e.influence||!this.optimizeInfluencers){if(this._activeTargets.length>=me.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(e),this._morphTargetTextureIndices[n]=i,this._tempInfluences[n++]=e.influence;}this._morphTargetTextureIndices.length!==n&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,n)),this._influences&&this._influences.length===n||(this._influences=new Float32Array(n));for(let e=0;e<n;e++)this._influences[e]=this._tempInfluences[e];if(e&&this._scene)for(const e of this._scene.meshes)e.morphTargetManager===this&&(s?e._markSubMeshesAsAttributesDirty():e._syncGeometryWithMorphTargetManager());}synchronize(){if(!this._scene||this.areUpdatesFrozen)return;const e=this._scene.getEngine();this._supportsPositions=true,this._supportsNormals=true,this._supportsTangents=true,this._supportsUVs=true,this._supportsUV2s=true,this._supportsColors=true,this._vertexCount=0,this._targetStoreTexture?.dispose(),this._targetStoreTexture=null,this.isUsingTextureForTargets&&this._targets.length>e.getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=false);for(const e of this._targets){this._supportsPositions=this._supportsPositions&&e.hasPositions,this._supportsNormals=this._supportsNormals&&e.hasNormals,this._supportsTangents=this._supportsTangents&&e.hasTangents,this._supportsUVs=this._supportsUVs&&e.hasUVs,this._supportsUV2s=this._supportsUV2s&&e.hasUV2s,this._supportsColors=this._supportsColors&&e.hasColors;const t=e.vertexCount;if(0===this._vertexCount)this._vertexCount=t;else if(this._vertexCount!==t)return void Ie$2.Error(`Incompatible target. Targets must all have the same vertices count. Current vertex count: ${this._vertexCount}, vertex count for target "${e.name}": ${t}`)}if(this.isUsingTextureForTargets){this._textureVertexStride=0,this._supportsPositions&&this._textureVertexStride++,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._supportsUV2s&&this._textureVertexStride++,this._supportsColors&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;const t=e.getCaps().maxTextureSize;this._textureWidth>t&&(this._textureHeight=Math.ceil(this._textureWidth/t),this._textureWidth=t);const s=this._targets.length,n=new Float32Array(s*this._textureWidth*this._textureHeight*4);let i=0;for(let e=0;e<s;e++){const t=this._targets[e],s=t.getPositions(),r=t.getNormals(),o=t.getUVs(),a=t.getTangents(),l=t.getUV2s(),h=t.getColors();i=e*this._textureWidth*this._textureHeight*4;for(let e=0;e<this._vertexCount;e++)this._supportsPositions&&s&&(n[i]=s[3*e],n[i+1]=s[3*e+1],n[i+2]=s[3*e+2],i+=4),this._supportsNormals&&r&&(n[i]=r[3*e],n[i+1]=r[3*e+1],n[i+2]=r[3*e+2],i+=4),this._supportsUVs&&o&&(n[i]=o[2*e],n[i+1]=o[2*e+1],i+=4),this._supportsTangents&&a&&(n[i]=a[3*e],n[i+1]=a[3*e+1],n[i+2]=a[3*e+2],i+=4),this._supportsUV2s&&l&&(n[i]=l[2*e],n[i+1]=l[2*e+1],i+=4),this._supportsColors&&h&&(n[i]=h[4*e],n[i+1]=h[4*e+1],n[i+2]=h[4*e+2],n[i+3]=h[4*e+3],i+=4);}this._targetStoreTexture=pe$2.CreateRGBATexture(n,this._textureWidth,this._textureHeight,s,this._scene,false,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Qe$1.TEXTURETYPE_FLOAT),this._targetStoreTexture.name=`Morph texture_${this.uniqueId}`;}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager();}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this.metadata=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null;}for(const e of this._targets)this._scene.stopAnimation(e);}}static Parse(e,t){const s=new me(t);for(const n of e.targets)s.addTarget(_e$2.Parse(n,t));return e.metadata&&(s.metadata=e.metadata),s}};me$2.EnableTextureStorage=true,me$2.MaxActiveMorphTargetsInVertexAttributeMode=8,me$2.ConstantTargetCountForTextureMode=0;let fe$2=class fe{constructor(e){this.byteOffset=0,this.buffer=e;}async loadAsync(e){const t=await this.buffer.readAsync(this.byteOffset,e);this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0;}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,true);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return Be$2(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e;}};function ye$2(e,t,s,n){const i={externalResourceFunction:n};return s&&(i.uri="file:"===t?s:t+s),ArrayBuffer.isView(e)?GLTFValidator.validateBytes(e,i):GLTFValidator.validateString(e,i)}function ge$2(){const e=[];onmessage=t=>{const s=t.data;switch(s.id){case "init":importScripts(s.url);break;case "validate":ye$2(s.data,s.rootUrl,s.fileName,(t=>new Promise(((s,n)=>{const i=e.length;e.push({resolve:s,reject:n}),postMessage({id:"getExternalResource",index:i,uri:t});})))).then((e=>{postMessage({id:"validate.resolve",value:e});}),(e=>{postMessage({id:"validate.reject",reason:e});}));break;case "getExternalResource.resolve":e[s.index].resolve(s.value);break;case "getExternalResource.reject":e[s.index].reject(s.reason);}};}let be$2=class be{static ValidateAsync(t,s,n,i){return "function"==typeof Worker?new Promise(((r,o)=>{const a=`${ye$2}(${ge$2})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),h=new Worker(l),c=e=>{h.removeEventListener("error",c),h.removeEventListener("message",d),o(e);},d=e=>{const t=e.data;switch(t.id){case "getExternalResource":i(t.uri).then((e=>{h.postMessage({id:"getExternalResource.resolve",index:t.index,value:e},[e.buffer]);}),(e=>{h.postMessage({id:"getExternalResource.reject",index:t.index,reason:e});}));break;case "validate.resolve":h.removeEventListener("error",c),h.removeEventListener("message",d),r(t.value),h.terminate();break;case "validate.reject":h.removeEventListener("error",c),h.removeEventListener("message",d),o(t.reason),h.terminate();}};if(h.addEventListener("error",c),h.addEventListener("message",d),h.postMessage({id:"init",url:Ai.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(t)){const e=t.slice();h.postMessage({id:"validate",data:e,rootUrl:s,fileName:n},[e.buffer]);}else h.postMessage({id:"validate",data:t,rootUrl:s,fileName:n});})):(this._LoadScriptPromise||(this._LoadScriptPromise=Ai.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then((()=>ye$2(t,s,n,i))))}};function ve$2(e,t,s){try{return Promise.resolve(new Uint8Array(e,t,s))}catch(e){return Promise.reject(e)}}be$2.Configuration={url:`${Ai._DefaultCdnUrl}/gltf_validator.js`},function(e){e[e.AUTO=0]="AUTO",e[e.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED";}(oe$4||(oe$4={})),function(e){e[e.NONE=0]="NONE",e[e.FIRST=1]="FIRST",e[e.ALL=2]="ALL";}(ae$4||(ae$4={})),function(e){e[e.LOADING=0]="LOADING",e[e.READY=1]="READY",e[e.COMPLETE=2]="COMPLETE";}(le$3||(le$3={}));let Ae$2=class Ae{constructor(){this.alwaysComputeBoundingBox=false,this.alwaysComputeSkeletonRootNode=false,this.animationStartMode=ae$4.FIRST,this.compileMaterials=false,this.compileShadowGenerators=false,this.coordinateSystemMode=oe$4.AUTO,this.createInstances=true,this.loadAllMaterials=false,this.loadMorphTargets=true,this.loadNodeAnimations=true,this.loadOnlyMaterials=false,this.loadSkins=true,this.skipMaterials=false,this.targetFps=60,this.transparencyAsCoverage=false,this.useClipPlane=false,this.useGltfTextureNames=false,this.useRangeRequests=false,this.useSRGBBuffers=true,this.validate=false,this.useOpenPBR=false;}};const xe$2=new Ae$2;let Ce$2=class Ce extends Ae$2{constructor(){super(...arguments),this.extensionOptions={},this.preprocessUrlAsync=e=>Promise.resolve(e);}copyFrom(e){e&&(this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.capturePerformanceCounters=e.capturePerformanceCounters??this.capturePerformanceCounters,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.createInstances=e.createInstances??this.createInstances,this.customRootNode=e.customRootNode,this.extensionOptions=e.extensionOptions??this.extensionOptions,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.loadSkins=e.loadSkins??this.loadSkins,this.loggingEnabled=e.loggingEnabled??this.loggingEnabled,this.onCameraLoaded=e.onCameraLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onMeshLoaded=e.onMeshLoaded,this.onParsed=e.onParsed,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onValidated=e.onValidated,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.targetFps=e.targetFps??this.targetFps,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.useOpenPBR=e.useOpenPBR??this.useOpenPBR,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.validate=e.validate??this.validate);}};let we$2=class we extends Ce$2{constructor(e){super(),this.onParsedObservable=new R$g,this.onMeshLoadedObservable=new R$g,this.onSkinLoadedObservable=new R$g,this.onTextureLoadedObservable=new R$g,this.onMaterialLoadedObservable=new R$g,this.onCameraLoadedObservable=new R$g,this.onCompleteObservable=new R$g,this.onErrorObservable=new R$g,this.onDisposeObservable=new R$g,this.onExtensionLoadedObservable=new R$g,this.onValidatedObservable=new R$g,this._loader=null,this._state=null,this._requests=new Array,this.name=oc.name,this.extensions=oc.extensions,this.onLoaderStateChangedObservable=new R$g,this._logIndentLevel=0,this._loggingEnabled=false,this._log=this._logDisabled,this._capturePerformanceCounters=false,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(Object.assign({...xe$2},e));}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e));}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e));}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add((t=>e(t.node,t.skinnedNode))));}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e));}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e));}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e));}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e);}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e);}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e);}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e);}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled);}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled));}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e);}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear();}loadFile(t,s,n,i,r,a,l,h){if(ArrayBuffer.isView(s))return this._loadBinary(t,s,n,i,l,h),null;this._progressCallback=r;const c=s.name||Ai.GetFilename(s);if(a){if(this.useRangeRequests){this.validate&&Ie$2.Warn("glTF validation is not supported when range requests are enabled");const e={abort:()=>{},onCompleteObservable:new R$g},n={readAsync:(e,n)=>new Promise(((i,r)=>{this._loadFile(t,s,(e=>{i(new Uint8Array(e));}),true,(e=>{r(e);}),(t=>{t.setRequestHeader("Range",`bytes=${e}-${e+n-1}`);}));})),byteLength:0};return this._unpackBinaryAsync(new fe$2(n)).then((t=>{e.onCompleteObservable.notifyObservers(e),i(t);}),l?e=>l(void 0,e):void 0),e}return this._loadFile(t,s,(e=>{this._validate(t,new Uint8Array(e,0,e.byteLength),n,c),this._unpackBinaryAsync(new fe$2({readAsync:(t,s)=>ve$2(e,t,s),byteLength:e.byteLength})).then((e=>{i(e);}),l?e=>l(void 0,e):void 0);}),true,l)}return this._loadFile(t,s,(e=>{try{this._validate(t,e,n,c),i({json:this._parseJson(e)});}catch{l&&l();}}),false,l)}_loadBinary(e,t,s,n,i,r){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),s,r),this._unpackBinaryAsync(new fe$2({readAsync:(e,s)=>function(e,t,s){try{if(t<0||t>=e.byteLength)throw new RangeError("Offset is out of range.");if(t+s>e.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(e.buffer,e.byteOffset+t,s))}catch(e){return Promise.reject(e)}}(t,e,s),byteLength:t.byteLength})).then((e=>{n(e);}),i?e=>i(void 0,e):void 0);}importMeshAsync(e,t,s,n,i,r){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(s),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(s),this._loader.importMeshAsync(e,t,null,s,n,i,r))))}loadAsync(e,t,s,n,i){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${i||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,s,n,i))))}loadAssetContainerAsync(e,t,s,n,i){return Promise.resolve().then((()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${i||""}`),this._loader=this._getLoader(t);const r=new M$b(e),o=[];this.onMaterialLoadedObservable.add((e=>{o.push(e);}));const a=[];this.onTextureLoadedObservable.add((e=>{a.push(e);}));const l=[];this.onCameraLoadedObservable.add((e=>{l.push(e);}));const h=[];return this.onMeshLoadedObservable.add((e=>{e.morphTargetManager&&h.push(e.morphTargetManager);})),this._loader.importMeshAsync(null,e,r,t,s,n,i).then((e=>(Array.prototype.push.apply(r.geometries,e.geometries),Array.prototype.push.apply(r.meshes,e.meshes),Array.prototype.push.apply(r.particleSystems,e.particleSystems),Array.prototype.push.apply(r.skeletons,e.skeletons),Array.prototype.push.apply(r.animationGroups,e.animationGroups),Array.prototype.push.apply(r.materials,o),Array.prototype.push.apply(r.textures,a),Array.prototype.push.apply(r.lights,e.lights),Array.prototype.push.apply(r.transformNodes,e.transformNodes),Array.prototype.push.apply(r.cameras,l),Array.prototype.push.apply(r.morphTargetManagers,h),r)))}))}canDirectLoad(e){return oc.canDirectLoad(e)}directLoad(e,t){if(t.startsWith("base64,"+ac)||t.startsWith(";base64,"+ac)||t.startsWith("application/octet-stream;base64,"+ac)||t.startsWith("model/gltf-binary;base64,"+ac)){const s=li(t);return this._validate(e,new Uint8Array(s,0,s.byteLength)),this._unpackBinaryAsync(new fe$2({readAsync:(e,t)=>ve$2(s,e,t),byteLength:s.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new we(e[oc.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise(((e,t)=>{this.onCompleteObservable.addOnce((()=>{e();})),this.onErrorObservable.addOnce((e=>{t(e);}));}))}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(le$3[this._state]));}_loadFile(e,t,s,n,i,r){const o=e._loadFile(t,s,(e=>{this._onProgress(e,o);}),true,n,i,r);return o.onCompleteObservable.add((()=>{o._lengthComputable=true,o._total=o._loaded;})),this._requests.push(o),o}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let s=true,n=0,i=0;for(const e of this._requests){if(void 0===e._lengthComputable||void 0===e._loaded||void 0===e._total)return;s=s&&e._lengthComputable,n+=e._loaded,i+=e._total;}this._progressCallback({lengthComputable:s,loaded:n,total:s?i:0});}_validate(t,s,n="",i=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),be$2.ValidateAsync(s,n,i,(e=>this.preprocessUrlAsync(n+e).then((e=>t._loadFileAsync(e,void 0,true,true).then((e=>new Uint8Array(e,0,e.byteLength))))))).then((e=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(e),this.onValidatedObservable.clear();}),(t=>{this._endPerformanceCounter("Validate JSON"),Ai.Warn(`Failed to validate: ${t.message}`),this.onValidatedObservable.clear();})));}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const s=we._parseVersion(t.version);if(!s)throw new Error("Invalid version: "+t.version);if(void 0!==t.minVersion){const e=we._parseVersion(t.minVersion);if(!e)throw new Error("Invalid minimum version: "+t.minVersion);if(we._compareVersion(e,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const n={1:we._CreateGLTF1Loader,2:we._CreateGLTF2Loader}[s.major];if(!n)throw new Error("Unsupported version: "+t.version);return n(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then((()=>{const t=e.readUint32();if(1179937895!==t)throw new we$3("Unexpected magic: "+t,Fe$2.GLTFLoaderUnexpectedMagicError);const s=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${s}`);const n=e.readUint32();let i;switch(this.useRangeRequests||n===e.buffer.byteLength||Ie$2.Warn(`Length in header does not match actual data length: ${n} != ${e.buffer.byteLength}`),s){case 1:i=this._unpackBinaryV1Async(e,n);break;case 2:i=this._unpackBinaryV2Async(e,n);break;default:throw new Error("Unsupported version: "+s)}return this._endPerformanceCounter("Unpack Binary"),i}))}_unpackBinaryV1Async(e,t){const s=e.readUint32(),n=e.readUint32();if(0!==n)throw new Error(`Unexpected content format: ${n}`);const i=t-e.byteOffset,r={json:this._parseJson(e.readString(s)),bin:null};if(0!==i){const t=e.byteOffset;r.bin={readAsync:(s,n)=>e.buffer.readAsync(t+s,n),byteLength:i};}return Promise.resolve(r)}_unpackBinaryV2Async(e,t){const s=1313821514,n=5130562,i=e.readUint32();if(e.readUint32()!==s)throw new Error("First chunk format is not JSON");return e.byteOffset+i===t?e.loadAsync(i).then((()=>({json:this._parseJson(e.readString(i)),bin:null}))):e.loadAsync(i+8).then((()=>{const r={json:this._parseJson(e.readString(i)),bin:null},o=()=>{const i=e.readUint32();switch(e.readUint32()){case s:throw new Error("Unexpected JSON chunk");case n:{const t=e.byteOffset;r.bin={readAsync:(s,n)=>e.buffer.readAsync(t+s,n),byteLength:i},e.skipBytes(i);break}default:e.skipBytes(i);}return e.byteOffset!==t?e.loadAsync(8).then(o):Promise.resolve(r)};return o()}))}static _parseVersion(e){if("1.0"===e||"1.0.1"===e)return {major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++;}_logClose(){--this._logIndentLevel;}_logEnabled(e){const t=we._logSpaces.substring(0,2*this._logIndentLevel);Ie$2.Log(`${t}${e}`);}_logDisabled(e){}_startPerformanceCounterEnabled(t){Ai.StartPerformanceCounter(t);}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(t){Ai.EndPerformanceCounter(t);}_endPerformanceCounterDisabled(e){}};we$2.IncrementalLoading=true,we$2.HomogeneousCoordinates=false,we$2._logSpaces="                                ",gh(new we$2);const Me$2=new Ol((()=>Promise.resolve().then(function(){return animationGroupCfDOHop1_esm_min}))),Te$2=new Ol((()=>Promise.resolve().then(function(){return glTFLoaderAnimationC7OnUlyq_esm_min})));let Oe$2=class Oe{static Get(e,t,s){if(!t||null==s||!t[s])throw new Error(`${e}: Failed to find index (${s})`);return t[s]}static TryGet(e,t){return e&&null!=t&&e[t]?e[t]:null}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t;}};function Ee$2(e){if(e.min&&e.max){const t=e.min,s=e.max,n=ae$5.Vector3[0].copyFromFloats(t[0],t[1],t[2]),i=ae$5.Vector3[1].copyFromFloats(s[0],s[1],s[2]);if(e.normalized&&5126!==e.componentType){let t=1;switch(e.componentType){case 5120:t=127;break;case 5121:t=255;break;case 5122:t=32767;break;case 5123:t=65535;}const s=1/t;n.scaleInPlace(s),i.scaleInPlace(s);}return new qi(n,i)}return null}let Re$2=class Re{static RegisterExtension(e,t){_c(e,false,t);}static UnregisterExtension(e){return fc(e)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=false,this._skipStartAnimationStep=false,this._extensions=new Array,this._disposed=false,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._materialAdapterCache=new WeakMap,this._pbrMaterialImpl=null,this._parent=e;}_getOrCreateMaterialAdapter(e){let t=this._materialAdapterCache.get(e);if(!t){if(!this._pbrMaterialImpl)throw new Error("Appropriate material adapter class not found");t=new this._pbrMaterialImpl.adapterClass(e),this._materialAdapterCache.set(e,t);}return t}dispose(){this._disposed||(this._disposed=true,this._completePromises.length=0,this._extensions.forEach((e=>e.dispose&&e.dispose())),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose());}async importMeshAsync(e,t,s,n,i,r,o=""){return await Promise.resolve().then((async()=>{this._babylonScene=t,this._assetContainer=s,this._loadData(n);let r=null;if(e){const t={};if(this._gltf.nodes)for(const e of this._gltf.nodes)e.name&&(t[e.name]=e.index);r=(e instanceof Array?e:[e]).map((e=>{const s=t[e];if(void 0===s)throw new Error(`Failed to find node '${e}'`);return s}));}return await this._loadAsync(i,o,r,(()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]})))}))}async loadAsync(e,t,s,n,i=""){return this._babylonScene=e,this._loadData(t),await this._loadAsync(s,i,null,(()=>{}))}async _loadAsync(t,s,n,i){return await Promise.resolve().then((async()=>{this._rootUrl=t,this._uniqueRootUrl=!t.startsWith("file:")&&s?t:`${t}${Date.now()}/`,this._fileName=s,this._allMaterialsDirtyRequired=false,await this._loadExtensionsAsync(),this.parent.skipMaterials||null!=this._pbrMaterialImpl||(this.parent.useOpenPBR||this.isExtensionUsed("KHR_materials_openpbr")?this._pbrMaterialImpl={materialClass:(await Promise.resolve().then(function(){return openpbrMaterialXlELrdGM_esm_min})).OpenPBRMaterial,adapterClass:(await Promise.resolve().then(function(){return openpbrMaterialLoadingAdapter1t_YYXqm_esm_min})).OpenPBRMaterialLoadingAdapter}:this._pbrMaterialImpl={materialClass:(await Promise.resolve().then(function(){return indexANBEaM64_esm_min}).then((function(e){return e.cw}))).PBRMaterial,adapterClass:(await Promise.resolve().then(function(){return pbrMaterialLoadingAdapterMkMWQfCC_esm_min})).PBRMaterialLoadingAdapter});const r=`${le$3[le$3.LOADING]} => ${le$3[le$3.READY]}`,o=`${le$3[le$3.LOADING]} => ${le$3[le$3.COMPLETE]}`;this._parent._startPerformanceCounter(r),this._parent._startPerformanceCounter(o),this._parent._setState(le$3.LOADING),this._extensionsOnLoading();const a=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=true,!this.parent.loadOnlyMaterials)if(n)a.push(this.loadSceneAsync("/nodes",{nodes:n,index:-1}));else if(null!=this._gltf.scene||this._gltf.scenes&&this._gltf.scenes[0]){const e=Oe$2.Get("/scene",this._gltf.scenes,this._gltf.scene||0);a.push(this.loadSceneAsync(`/scenes/${e.index}`,e));}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let e=0;e<this._gltf.materials.length;++e){const t=this._gltf.materials[e],s="/materials/"+e,n=hr$1.TriangleFillMode;a.push(this._loadMaterialAsync(s,t,null,n,(()=>{})));}this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&a.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&a.push(this._compileShadowGeneratorsAsync());const h=Promise.all(a).then((()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(true);for(const e of this._babylonScene.materials){const t=e;void 0!==t.maxSimultaneousLights&&(t.maxSimultaneousLights=Math.max(t.maxSimultaneousLights,this._babylonScene.lights.length));}return this._extensionsOnReady(),this._parent._setState(le$3.READY),this._skipStartAnimationStep||this._startAnimations(),i()}));return await h.then((t=>(this._parent._endPerformanceCounter(r),Ai.SetImmediate((()=>{this._disposed||Promise.all(this._completePromises).then((()=>{this._parent._endPerformanceCounter(o),this._parent._setState(le$3.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose();}),(e=>{this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose();}));})),t)))})).catch((e=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()),e}))}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const s=t[0];(s.byteLength<e.bin.byteLength-3||s.byteLength>e.bin.byteLength)&&Ie$2.Warn(`Binary buffer length (${s.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin;}else Ie$2.Warn("Unexpected BIN chunk");}}_setupData(){if(Oe$2.Assign(this._gltf.accessors),Oe$2.Assign(this._gltf.animations),Oe$2.Assign(this._gltf.buffers),Oe$2.Assign(this._gltf.bufferViews),Oe$2.Assign(this._gltf.cameras),Oe$2.Assign(this._gltf.images),Oe$2.Assign(this._gltf.materials),Oe$2.Assign(this._gltf.meshes),Oe$2.Assign(this._gltf.nodes),Oe$2.Assign(this._gltf.samplers),Oe$2.Assign(this._gltf.scenes),Oe$2.Assign(this._gltf.skins),Oe$2.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const t of this._gltf.nodes)if(t.children)for(const s of t.children)e[s]=t.index;const t=this._createRootNode();for(const s of this._gltf.nodes){const n=e[s.index];s.parent=void 0===n?t:this._gltf.nodes[n];}}}async _loadExtensionsAsync(){const e=[];if(dc.forEach(((t,s)=>{ false===this.parent.extensionOptions[s]?.enabled?t.isGLTFExtension&&this.isExtensionUsed(s)&&Ie$2.Warn(`Extension ${s} is used but has been explicitly disabled.`):t.isGLTFExtension&&!this.isExtensionUsed(s)||e.push((async()=>{const e=await t.factory(this);return e.name!==s&&Ie$2.Warn(`The name of the glTF loader extension instance does not match the registered name: ${e.name} !== ${s}`),this._parent.onExtensionLoadedObservable.notifyObservers(e),e})());})),this._extensions.push(...await Promise.all(e)),this._extensions.sort(((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE))),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired)for(const e of this._gltf.extensionsRequired){if(!this._extensions.some((t=>t.name===e&&t.enabled))){if(false===this.parent.extensionOptions[e]?.enabled)throw new Error(`Required extension ${e} is disabled`);throw new Error(`Required extension ${e} is not available`)}}}_createRootNode(){if(void 0!==this._parent.customRootNode)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:null===this._rootBabylonMesh?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;const e=new Er$1("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,this._rootBabylonMesh.setEnabled(false);const t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case oe$4.AUTO:this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],Re._LoadTransform(t,this._rootBabylonMesh));break;case oe$4.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=true;break;default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){const s=this._extensionsLoadSceneAsync(e,t);if(s)return s;const n=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const s of t.nodes){const t=Oe$2.Get(`${e}/nodes/${s}`,this._gltf.nodes,s);n.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=this._rootBabylonMesh;})));}for(const e of this._postSceneLoadActions)e();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then((()=>{}))}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const s of e._primitiveBabylonMeshes)t(s);}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,(t=>{const s=t.geometry;s&&-1===e.indexOf(s)&&e.push(s);}));return e}_getMeshes(){const e=[];this._rootBabylonMesh instanceof ps&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,(t=>{e.push(t);}));return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const s of t)s._babylonTransformNode&&"TransformNode"===s._babylonTransformNode.getClassName()&&e.push(s._babylonTransformNode),s._babylonTransformNodeForSkin&&e.push(s._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const s of t)s._data&&e.push(s._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const s of t)s._babylonAnimationGroup&&e.push(s._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case ae$4.NONE:break;case ae$4.FIRST:{const e=this._getAnimationGroups();0!==e.length&&e[0].start(true);break}case ae$4.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(true);break}default:return void Ie$2.Error(`Invalid animation start mode (${this._parent.animationStartMode})`)}}loadNodeAsync(e,t,s=()=>{}){const n=this._extensionsLoadNodeAsync(e,t,s);if(n)return n;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const i=new Array;this.logOpen(`${e} ${t.name||""}`);const r=n=>{if(Re.AddPointerMetadata(n,e),Re._LoadTransform(t,n),null!=t.camera){const s=Oe$2.Get(`${e}/camera`,this._gltf.cameras,t.camera);i.push(this.loadCameraAsync(`/cameras/${s.index}`,s,(e=>{e.parent=n,this._babylonScene.useRightHandedSystem||(n.scaling.x=-1);})));}if(t.children)for(const s of t.children){const t=Oe$2.Get(`${e}/children/${s}`,this._gltf.nodes,s);i.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=n;})));}s(n);},o=null!=t.mesh,a=this._parent.loadSkins&&null!=t.skin;if(!o||a){const e=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new ns(e,this._babylonScene);s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,null==t.mesh?t._babylonTransformNode=s:t._babylonTransformNodeForSkin=s,r(s);}if(o)if(a){const s=Oe$2.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);i.push(this._loadMeshAsync(`/meshes/${s.index}`,t,s,(s=>{const n=t._babylonTransformNodeForSkin;s.metadata=Pl(n.metadata,s.metadata||{});const r=Oe$2.Get(`${e}/skin`,this._gltf.skins,t.skin);i.push(this._loadSkinAsync(`/skins/${r.index}`,t,r,(e=>{this._forEachPrimitive(t,(t=>{t.skeleton=e;})),this._postSceneLoadActions.push((()=>{if(null!=r.skeleton){const e=Oe$2.Get(`/skins/${r.index}/skeleton`,this._gltf.nodes,r.skeleton).parent;t.index===e.index?s.parent=n.parent:s.parent=e._babylonTransformNode;}else s.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:n,skinnedNode:s});}));})));})));}else {const s=Oe$2.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);i.push(this._loadMeshAsync(`/meshes/${s.index}`,t,s,r));}return this.logClose(),Promise.all(i).then((()=>(this._forEachPrimitive(t,(e=>{const t=e;!t.isAnInstance&&t.geometry&&t.geometry.useBoundingInfoFromGeometry?e._updateBoundingInfo():e.refreshBoundingInfo(true,true);})),t._babylonTransformNode)))}_loadMeshAsync(e,t,s,n){const i=s.primitives;if(!i||!i.length)throw new Error(`${e}: Primitives are missing`);null==i[0].index&&Oe$2.Assign(i);const r=new Array;this.logOpen(`${e} ${s.name||""}`);const o=t.name||`node${t.index}`;if(1===i.length){const n=s.primitives[0];r.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${n.index}`,o,t,s,n,(e=>{t._babylonTransformNode=e,t._primitiveBabylonMeshes=[e];})));}else {this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new ns(o,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,t._primitiveBabylonMeshes=[];for(const n of i)r.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${n.index}`,`${o}_primitive${n.index}`,t,s,n,(e=>{e.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(e);})));}return n(t._babylonTransformNode),this.logClose(),Promise.all(r).then((()=>t._babylonTransformNode))}_loadMeshPrimitiveAsync(e,t,s,n,i,r){const o=this._extensionsLoadMeshPrimitiveAsync(e,t,s,n,i,r);if(o)return o;this.logOpen(`${e}`);const a=0===this._disableInstancedMesh&&this._parent.createInstances&&null==s.skin&&!n.primitives[0].targets;let l,h;if(a&&i._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,l=i._instanceData.babylonSourceMesh.createInstance(t),l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,h=i._instanceData.promise;else {const r=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new Er$1(t,this._babylonScene);if(o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,o.sideOrientation=this._babylonScene.useRightHandedSystem?hr$1.CounterClockWiseSideOrientation:hr$1.ClockWiseSideOrientation,this._createMorphTargets(e,s,n,i,o),r.push(this._loadVertexDataAsync(e,i,o).then((async t=>await this._loadMorphTargetsAsync(e,i,o,t).then((()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,t.applyToMesh(o),t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false);}))))),!this.parent.skipMaterials){const t=Re._GetDrawMode(e,i.mode);if(null==i.material){let e=this._defaultBabylonMaterialData[t];e||(e=this._createDefaultMaterial("__GLTFLoader._default",t),this._parent.onMaterialLoadedObservable.notifyObservers(e),this._defaultBabylonMaterialData[t]=e),o.material=e;}else {const s=Oe$2.Get(`${e}/material`,this._gltf.materials,i.material);r.push(this._loadMaterialAsync(`/materials/${s.index}`,s,o,t,(e=>{o.material=e;})));}}h=Promise.all(r),a&&(i._instanceData={babylonSourceMesh:o,promise:h}),l=o;}return Re.AddPointerMetadata(l,e),this._parent.onMeshLoadedObservable.notifyObservers(l),r(l),this.logClose(),h.then((()=>l))}_loadVertexDataAsync(e,t,s){const n=this._extensionsLoadVertexDataAsync(e,t,s);if(n)return n;const i=t.attributes;if(!i)throw new Error(`${e}: Attributes are missing`);const r=new Array,o=new rs(s.name,this._babylonScene);if(null==t.indices)s.isUnIndexed=true;else {const s=Oe$2.Get(`${e}/indices`,this._gltf.accessors,t.indices);r.push(this._loadIndicesAccessorAsync(`/accessors/${s.index}`,s).then((e=>{o.setIndices(e);})));}const a=(t,n,a)=>{if(null==i[t])return;s._delayInfo=s._delayInfo||[],-1===s._delayInfo.indexOf(n)&&s._delayInfo.push(n);const l=Oe$2.Get(`${e}/attributes/${t}`,this._gltf.accessors,i[t]);r.push(this._loadVertexAccessorAsync(`/accessors/${l.index}`,l,n).then((e=>{if(e.getKind()===Hi.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!s.skeleton){const e=Ee$2(l);e&&(o._boundingInfo=e,o.useBoundingInfoFromGeometry=true);}o.setVerticesBuffer(e,l.count);}))),n==Hi.MatricesIndicesExtraKind&&(s.numBoneInfluencers=8),a&&a(l);};return a("POSITION",Hi.PositionKind),a("NORMAL",Hi.NormalKind),a("TANGENT",Hi.TangentKind),a("TEXCOORD_0",Hi.UVKind),a("TEXCOORD_1",Hi.UV2Kind),a("TEXCOORD_2",Hi.UV3Kind),a("TEXCOORD_3",Hi.UV4Kind),a("TEXCOORD_4",Hi.UV5Kind),a("TEXCOORD_5",Hi.UV6Kind),a("JOINTS_0",Hi.MatricesIndicesKind),a("WEIGHTS_0",Hi.MatricesWeightsKind),a("JOINTS_1",Hi.MatricesIndicesExtraKind),a("WEIGHTS_1",Hi.MatricesWeightsExtraKind),a("COLOR_0",Hi.ColorKind,(e=>{"VEC4"===e.type&&(s.hasVertexAlpha=true);})),Promise.all(r).then((()=>o))}_createMorphTargets(e,t,s,n,i){if(!n.targets||!this._parent.loadMorphTargets)return;if(null==t._numMorphTargets)t._numMorphTargets=n.targets.length;else if(n.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const r=s.extras?s.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,i.morphTargetManager=new me$2(this._babylonScene),i.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,i.morphTargetManager.areUpdatesFrozen=true;for(let e=0;e<n.targets.length;e++){const n=t.weights?t.weights[e]:s.weights?s.weights[e]:0,o=r?r[e]:`morphTarget${e}`;i.morphTargetManager.addTarget(new _e$2(o,n,i.getScene()));}}_loadMorphTargetsAsync(e,t,s,n){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();const i=new Array,r=s.morphTargetManager;for(let s=0;s<r.numTargets;s++){const o=r.getTarget(s);i.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${s}`,n,t.targets[s],o));}return Promise.all(i).then((()=>{r.areUpdatesFrozen=false;}))}async _loadMorphTargetVertexDataAsync(e,t,s,n){const i=new Array,r=(n,r,o)=>{if(null==s[n])return;const a=t.getVertexBuffer(r);if(!a)return;const l=Oe$2.Get(`${e}/${n}`,this._gltf.accessors,s[n]);i.push(this._loadFloatAccessorAsync(`/accessors/${l.index}`,l).then((e=>{o(a,e);})));};return r("POSITION",Hi.PositionKind,((e,t)=>{const s=new Float32Array(t.length);e.forEach(t.length,((e,n)=>{s[n]=t[n]+e;})),n.setPositions(s);})),r("NORMAL",Hi.NormalKind,((e,t)=>{const s=new Float32Array(t.length);e.forEach(s.length,((e,n)=>{s[n]=t[n]+e;})),n.setNormals(s);})),r("TANGENT",Hi.TangentKind,((e,t)=>{const s=new Float32Array(t.length/3*4);let i=0;e.forEach(t.length/3*4,((e,n)=>{(n+1)%4!=0&&(s[i]=t[i]+e,i++);})),n.setTangents(s);})),r("TEXCOORD_0",Hi.UVKind,((e,t)=>{const s=new Float32Array(t.length);e.forEach(t.length,((e,n)=>{s[n]=t[n]+e;})),n.setUVs(s);})),r("TEXCOORD_1",Hi.UV2Kind,((e,t)=>{const s=new Float32Array(t.length);e.forEach(t.length,((e,n)=>{s[n]=t[n]+e;})),n.setUV2s(s);})),r("COLOR_0",Hi.ColorKind,((t,s)=>{let i=null;const r=t.getSize();if(3===r){i=new Float32Array(s.length/3*4),t.forEach(s.length,((e,t)=>{const n=Math.floor(t/3),r=t%3;i[4*n+r]=s[3*n+r]+e;}));for(let e=0;e<s.length/3;++e)i[4*e+3]=1;}else {if(4!==r)throw new Error(`${e}: Invalid number of components (${r}) for COLOR_0 attribute`);i=new Float32Array(s.length),t.forEach(s.length,((e,t)=>{i[t]=s[t]+e;}));}n.setColors(i);})),await Promise.all(i).then((()=>{}))}static _LoadTransform(e,t){if(null!=e.skin)return;let n=te$4.Zero(),i=se$5.Identity(),r=te$4.One();if(e.matrix){re$5.FromArray(e.matrix).decompose(r,i,n);}else e.translation&&(n=te$4.FromArray(e.translation)),e.rotation&&(i=se$5.FromArray(e.rotation)),e.scale&&(r=te$4.FromArray(e.scale));t.position=n,t.rotationQuaternion=i,t.scaling=r;}_loadSkinAsync(e,t,s,n){if(!this._parent.loadSkins)return Promise.resolve();const i=this._extensionsLoadSkinAsync(e,t,s);if(i)return i;if(s._data)return n(s._data.babylonSkeleton),s._data.promise;const r=`skeleton${s.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new d$h(s.name||r,r,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,this._loadBones(e,s,o);const a=this._loadSkinInverseBindMatricesDataAsync(e,s).then((e=>{this._updateBoneMatrices(o,e);}));return s._data={babylonSkeleton:o,promise:a},n(o),a}_loadBones(e,t,s){if(null==t.skeleton||this._parent.alwaysComputeSkeletonRootNode){const s=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(s)if(void 0===t.skeleton)t.skeleton=s.index;else {const n=(e,t)=>{for(;t.parent;t=t.parent)if(t.parent===e)return  true;return  false},i=Oe$2.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);i===s||n(i,s)||(Ie$2.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=s.index);}else Ie$2.Warn(`${e}: Failed to find common root`);}const n={};for(const i of t.joints){const r=Oe$2.Get(`${e}/joints/${i}`,this._gltf.nodes,i);this._loadBone(r,t,s,n);}}_findSkeletonRootNode(e,t){if(0===t.length)return null;const s={};for(const n of t){const t=[];let i=Oe$2.Get(`${e}/${n}`,this._gltf.nodes,n);for(;-1!==i.index;)t.unshift(i),i=i.parent;s[n]=t;}let n=null;for(let e=0;;++e){let i=s[t[0]];if(e>=i.length)return n;const r=i[e];for(let o=1;o<t.length;++o)if(i=s[t[o]],e>=i.length||r!==i[e])return n;n=r;}}_loadBone(e,t,s,n){e._isJoint=true;let i=n[e.index];if(i)return i;let r=null;e.index!==t.skeleton&&(e.parent&&-1!==e.parent.index?r=this._loadBone(e.parent,t,s,n):void 0!==t.skeleton&&Ie$2.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const o=t.joints.indexOf(e.index);return i=new r$16(e.name||`joint${e.index}`,s,r,this._getNodeMatrix(e),null,null,o),n[e.index]=i,this._postSceneLoadActions.push((()=>{i.linkTransformNode(e._babylonTransformNode);})),i}_loadSkinInverseBindMatricesDataAsync(e,t){if(null==t.inverseBindMatrices)return Promise.resolve(null);const s=Oe$2.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${s.index}`,s)}_updateBoneMatrices(e,t){for(const s of e.bones){const e=re$5.Identity(),n=s._index;t&&-1!==n&&(re$5.FromArrayToRef(t,16*n,e),e.invertToRef(e));const i=s.getParent();i&&e.multiplyToRef(i.getAbsoluteInverseBindMatrix(),e),s.updateMatrix(e,false,false),s._updateAbsoluteBindMatrices(void 0,false);}}_getNodeMatrix(e){return e.matrix?re$5.FromArray(e.matrix):re$5.Compose(e.scale?te$4.FromArray(e.scale):te$4.One(),e.rotation?se$5.FromArray(e.rotation):se$5.Identity(),e.translation?te$4.FromArray(e.translation):te$4.Zero())}loadCameraAsync(e,t,n=()=>{}){const i=this._extensionsLoadCameraAsync(e,t,n);if(i)return i;const r=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new ue$3(t.name||`camera${t.index}`,te$4.Zero(),this._babylonScene,false);switch(o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,t._babylonCamera=o,o.setTarget(new te$4(0,0,-1)),t.type){case "perspective":{const s=t.perspective;if(!s)throw new Error(`${e}: Camera perspective properties are missing`);o.fov=s.yfov,o.minZ=s.znear,o.maxZ=s.zfar||0;break}case "orthographic":if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);o.mode=Di.ORTHOGRAPHIC_CAMERA,o.orthoLeft=-t.orthographic.xmag,o.orthoRight=t.orthographic.xmag,o.orthoBottom=-t.orthographic.ymag,o.orthoTop=t.orthographic.ymag,o.minZ=t.orthographic.znear,o.maxZ=t.orthographic.zfar;break;default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return Re.AddPointerMetadata(o,e),this._parent.onCameraLoadedObservable.notifyObservers(o),n(o),this.logClose(),Promise.all(r).then((()=>o))}_loadAnimationsAsync(){this._parent._startPerformanceCounter("Load animations");const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let s=0;s<e.length;s++){const n=e[s];t.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then((e=>{0===e.targetedAnimations.length&&e.dispose();})));}return Promise.all(t).then((()=>{this._parent._endPerformanceCounter("Load animations");}))}loadAnimationAsync(e,t){this._parent._startPerformanceCounter("Load animation");const s=this._extensionsLoadAnimationAsync(e,t);return s||Me$2.value.then((({AnimationGroup:s})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new s(t.name||`animation${t.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,t._babylonAnimationGroup=n;const i=new Array;Oe$2.Assign(t.channels),Oe$2.Assign(t.samplers);for(const s of t.channels)i.push(this._loadAnimationChannelAsync(`${e}/channels/${s.index}`,e,t,s,((e,t)=>{e.animations=e.animations||[],e.animations.push(t),n.addTargetedAnimation(t,e);})));return this._parent._endPerformanceCounter("Load animation"),Promise.all(i).then((()=>(n.normalize(0),n)))}))}_loadAnimationChannelAsync(e,t,s,n,i){const r=this._extensionsLoadAnimationChannelAsync(e,t,s,n,i);if(r)return r;if(null==n.target.node)return Promise.resolve();const o=Oe$2.Get(`${e}/target/node`,this._gltf.nodes,n.target.node),a=n.target.path,l="weights"===a;return l&&!o._numMorphTargets||!l&&!o._babylonTransformNode?Promise.resolve():this._parent.loadNodeAnimations||l||o._isJoint?Te$2.value.then((()=>{let r;switch(a){case "translation":r=j$4("/nodes/{}/translation")?.interpolation;break;case "rotation":r=j$4("/nodes/{}/rotation")?.interpolation;break;case "scale":r=j$4("/nodes/{}/scale")?.interpolation;break;case "weights":r=j$4("/nodes/{}/weights")?.interpolation;break;default:throw new Error(`${e}/target/path: Invalid value (${n.target.path})`)}if(!r)throw new Error(`${e}/target/path: Could not find interpolation properties for target path (${n.target.path})`);const l={object:o,info:r};return this._loadAnimationChannelFromTargetInfoAsync(e,t,s,n,l,i)})):Promise.resolve()}_loadAnimationChannelFromTargetInfoAsync(e,t,s,n,i,r){const o=this.parent.targetFps,a=1/o,l=Oe$2.Get(`${e}/sampler`,s.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${n.sampler}`,l).then((e=>{let t=0;const l=i.object,h=i.info;for(const i of h){const h=i.getStride(l),c=e.input,d=e.output,u=new Array(c.length);let _=0;switch(e.interpolation){case "STEP":for(let e=0;e<c.length;e++){const t=i.getValue(l,d,_,1);_+=h,u[e]={frame:c[e]*o,value:t,interpolation:1};}break;case "CUBICSPLINE":for(let e=0;e<c.length;e++){const t=i.getValue(l,d,_,a);_+=h;const s=i.getValue(l,d,_,1);_+=h;const n=i.getValue(l,d,_,a);_+=h,u[e]={frame:c[e]*o,inTangent:t,value:s,outTangent:n};}break;case "LINEAR":for(let e=0;e<c.length;e++){const t=i.getValue(l,d,_,1);_+=h,u[e]={frame:c[e]*o,value:t};}}if(_>0){const e=`${s.name||`animation${s.index}`}_channel${n.index}_${t}`,a=i.buildAnimations(l,e,o,u);for(const e of a)t++,r(e.babylonAnimatable,e.babylonAnimation);}}}))}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const s=t.interpolation||"LINEAR";switch(s){case "STEP":case "LINEAR":case "CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const n=Oe$2.Get(`${e}/input`,this._gltf.accessors,t.input),i=Oe$2.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${i.index}`,i)]).then((([e,t])=>({input:e,interpolation:s,output:t}))),t._data}loadBufferAsync(e,t,s,n){const i=this._extensionsLoadBufferAsync(e,t,s,n);if(i)return i;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else {if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength);}return t._data.then((t=>{try{return new Uint8Array(t.buffer,t.byteOffset+s,n)}catch(t){throw new Error(`${e}: ${t.message}`)}}))}loadBufferViewAsync(e,t){const s=this._extensionsLoadBufferViewAsync(e,t);if(s)return s;if(t._data)return t._data;const n=Oe$2.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${n.index}`,n,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,s){if(t._data)return t._data;const n=Re._GetNumComponents(e,t.type),i=n*Hi.GetTypeByteLength(t.componentType),r=n*t.count;if(null==t.bufferView)t._data=Promise.resolve(new s(r));else {const o=Oe$2.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${o.index}`,o).then((a=>{if(5126!==t.componentType||t.normalized||o.byteStride&&o.byteStride!==i){const e=new s(r);return Hi.ForEach(a,t.byteOffset||0,o.byteStride||i,n,t.componentType,e.length,t.normalized||false,((t,s)=>{e[s]=t;})),e}return Re._GetTypedArray(e,t.componentType,a,t.byteOffset,r)}));}if(t.sparse){const r=t.sparse;t._data=t._data.then((o=>{const a=o,l=Oe$2.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,r.indices.bufferView),h=Oe$2.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,r.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${l.index}`,l),this.loadBufferViewAsync(`/bufferViews/${h.index}`,h)]).then((([o,l])=>{const h=Re._GetTypedArray(`${e}/sparse/indices`,r.indices.componentType,o,r.indices.byteOffset,r.count),c=n*r.count;let d;if(5126!==t.componentType||t.normalized){const o=Re._GetTypedArray(`${e}/sparse/values`,t.componentType,l,r.values.byteOffset,c);d=new s(c),Hi.ForEach(o,0,i,n,t.componentType,d.length,t.normalized||false,((e,t)=>{d[t]=e;}));}else d=Re._GetTypedArray(`${e}/sparse/values`,t.componentType,l,r.values.byteOffset,c);let u=0;for(let e=0;e<h.length;e++){let t=h[e]*n;for(let e=0;e<n;e++)a[t++]=d[u++];}return a}))}));}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if("SCALAR"!==t.type)throw new Error(`${e}/type: Invalid value ${t.type}`);if(5121!==t.componentType&&5123!==t.componentType&&5125!==t.componentType)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const s=Re._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,s);}else {const s=Oe$2.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s).then((s=>Re._GetTypedArray(e,t.componentType,s,t.byteOffset,t.count)));}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then((e=>new Vi(t,e,false))),e._babylonBuffer}_loadVertexAccessorAsync(e,t,s){if(t._babylonVertexBuffer?.[s])return t._babylonVertexBuffer[s];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const n=this._babylonScene.getEngine();if(t.sparse||null==t.bufferView)t._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(e,t).then((e=>new Hi(n,e,s,false)));else {const i=Oe$2.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[s]=this._loadVertexBufferViewAsync(i).then((r=>{const o=Re._GetNumComponents(e,t.type);return new Hi(n,r,s,false,void 0,i.byteStride,void 0,t.byteOffset,o,t.componentType,t.normalized,true,void 0,true)}));}return t._babylonVertexBuffer[s]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,s){const n=new Array,i=this._getOrCreateMaterialAdapter(s);return t&&(t.baseColorFactor?(i.baseColor=ge$3.FromArray(t.baseColorFactor),i.geometryOpacity=t.baseColorFactor[3]):i.baseColor=ge$3.White(),i.baseMetalness=null==t.metallicFactor?1:t.metallicFactor,i.specularRoughness=null==t.roughnessFactor?1:t.roughnessFactor,t.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,(e=>{e.name=`${s.name} (Base Color)`,i.baseColorTexture=e;}))),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=true,n.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,(e=>{e.name=`${s.name} (Metallic Roughness)`,i.baseMetalnessTexture=e,i.specularRoughnessTexture=e;}))),i.useRoughnessFromMetallicTextureGreen=true,i.useMetallicFromMetallicTextureBlue=true)),Promise.all(n).then((()=>{}))}_loadMaterialAsync(e,t,s,n,i=()=>{}){const r=this._extensionsLoadMaterialAsync(e,t,s,n,i);if(r)return r;t._data=t._data||{};let o=t._data[n];if(!o){this.logOpen(`${e} ${t.name||""}`);const s=this.createMaterial(e,t,n);o={babylonMaterial:s,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,s)},t._data[n]=o,Re.AddPointerMetadata(s,e),this._parent.onMaterialLoadedObservable.notifyObservers(s),this.logClose();}return s&&(o.babylonMeshes.push(s),s.onDisposeObservable.addOnce((()=>{const e=o.babylonMeshes.indexOf(s);-1!==e&&o.babylonMeshes.splice(e,1);}))),i(o.babylonMaterial),o.promise.then((()=>o.babylonMaterial))}_createDefaultMaterial(e,t){if(!this._pbrMaterialImpl)throw new Error("PBR Material class not loaded");this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new this._pbrMaterialImpl.materialClass(e,this._babylonScene);s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,s.fillMode=t,s.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE;const n=this._getOrCreateMaterialAdapter(s);return n.transparencyAsAlphaCoverage=this._parent.transparencyAsCoverage,n.baseMetalness=1,n.specularRoughness=1,s}createMaterial(e,t,s){const n=this._extensionsCreateMaterial(e,t,s);if(n)return n;const i=t.name||`material${t.index}`;return this._createDefaultMaterial(i,s)}loadMaterialPropertiesAsync(e,t,s){const n=this._extensionsLoadMaterialPropertiesAsync(e,t,s);if(n)return n;const i=new Array;return i.push(this.loadMaterialBasePropertiesAsync(e,t,s)),t.pbrMetallicRoughness&&i.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,s)),this.loadMaterialAlphaProperties(e,t,s),Promise.all(i).then((()=>{}))}loadMaterialBasePropertiesAsync(e,t,s){const n=new Array,i=this._getOrCreateMaterialAdapter(s);let r;i.emissionColor=t.emissiveFactor?ge$3.FromArray(t.emissiveFactor):new ge$3(0,0,0),t.doubleSided&&(i.backFaceCulling=false,i.twoSidedLighting=true),t.normalTexture&&(t.normalTexture.nonColorData=true,n.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,(e=>{e.name=`${s.name} (Normal)`,i.geometryNormalTexture=e,null!=t.normalTexture?.scale&&(e.level=t.normalTexture.scale);}))),i.setNormalMapInversions(!this._babylonScene.useRightHandedSystem,this._babylonScene.useRightHandedSystem));let o,a=1;return t.occlusionTexture&&(t.occlusionTexture.nonColorData=true,n.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,(e=>{e.name=`${s.name} (Occlusion)`,r=e;}))),null!=t.occlusionTexture.strength&&(a=t.occlusionTexture.strength)),t.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,(e=>{e.name=`${s.name} (Emissive)`,o=e;}))),Promise.all(n).then((()=>{r&&(i.ambientOcclusionTexture=r,i.ambientOcclusionTextureStrength=a),o&&(i.emissionColorTexture=o);}))}loadMaterialAlphaProperties(e,t,s){if(!this._pbrMaterialImpl)throw new Error(`${e}: Material type not supported`);const n=this._getOrCreateMaterialAdapter(s),i=n.baseColorTexture;switch(t.alphaMode||"OPAQUE"){case "OPAQUE":s.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE,s.alpha=1;break;case "MASK":s.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHATEST,n.alphaCutOff=null==t.alphaCutoff?.5:t.alphaCutoff,i&&(i.hasAlpha=true);break;case "BLEND":s.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHABLEND,i&&(i.hasAlpha=true,n.useAlphaFromBaseColorTexture=true);break;default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,s=()=>{}){const n=this._extensionsLoadTextureInfoAsync(e,t,s);if(n)return n;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const i=Oe$2.Get(`${e}/index`,this._gltf.textures,t.index);i._textureInfo=t;const r=this._loadTextureAsync(`/textures/${t.index}`,i,(n=>{n.coordinatesIndex=t.texCoord||0,Re.AddPointerMetadata(n,e),this._parent.onTextureLoadedObservable.notifyObservers(n),s(n);}));return this.logClose(),r}_loadTextureAsync(e,t,s=()=>{}){const n=this._extensionsLoadTextureAsync(e,t,s);if(n)return n;this.logOpen(`${e} ${t.name||""}`);const i=null==t.sampler?Re.DefaultSampler:Oe$2.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),r=Oe$2.Get(`${e}/source`,this._gltf.images,t.source),o=this._createTextureAsync(e,i,r,s,void 0,!t._textureInfo.nonColorData);return this.logClose(),o}_createTextureAsync(e,t,s,n=()=>{},i,r){const o=this._loadSampler(`/samplers/${t.index}`,t),a=new Array,l=new Cl;this._babylonScene._blockEntityCollection=!!this._assetContainer;const h={noMipmap:o.noMipMaps,invertY:false,samplingMode:o.samplingMode,onLoad:()=>{this._disposed||l.resolve();},onError:(t,s)=>{this._disposed||l.reject(new Error(`${e}: ${s&&s.message?s.message:t||"Failed to load texture"}`));},mimeType:s.mimeType??ni(s.uri??""),loaderOptions:i,useSRGBBuffer:!!r&&this._parent.useSRGBBuffers},c=new Is(null,this._babylonScene,h);return c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=false,a.push(l.promise),a.push(this.loadImageAsync(`/images/${s.index}`,s).then((e=>{const t=s.uri||`${this._fileName}#image${s.index}`,n=`data:${this._uniqueRootUrl}${t}`;c.updateURL(n,e);const i=c.getInternalTexture();i&&(i.label=s.name);}))),c.wrapU=o.wrapU,c.wrapV=o.wrapV,n(c),this._parent.useGltfTextureNames&&(c.name=s.name||s.uri||`image${s.index}`),Promise.all(a).then((()=>c))}_loadSampler(e,t){return t._data||(t._data={noMipMaps:9728===t.minFilter||9729===t.minFilter,samplingMode:Re._GetTextureSamplingMode(e,t),wrapU:Re._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:Re._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else {const s=Oe$2.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s);}this.logClose();}return t._data}loadUriAsync(e,t,s){const n=this._extensionsLoadUriAsync(e,t,s);if(n)return n;if(!Re._ValidateUri(s))throw new Error(`${e}: '${s}' is invalid`);if(oi(s)){const t=new Uint8Array(li(s));return this.log(`${e}: Decoded ${s.substring(0,64)}... (${t.length} bytes)`),Promise.resolve(t)}return this.log(`${e}: Loading ${s}`),this._parent.preprocessUrlAsync(this._rootUrl+s).then((t=>new Promise(((n,i)=>{this._parent._loadFile(this._babylonScene,t,(t=>{this._disposed||(this.log(`${e}: Loaded ${s} (${t.byteLength} bytes)`),n(new Uint8Array(t)));}),true,(t=>{i(new qt$1(`${e}: Failed to load '${s}'${t?": "+t.status+" "+t.statusText:""}`,t));}));}))))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const s=e._internalMetadata=e._internalMetadata||{},n=s.gltf=s.gltf||{};(n.pointers=n.pointers||[]).push(t);}static _GetTextureWrapMode(e,t){switch(t=null==t?10497:t){case 33071:return Is.CLAMP_ADDRESSMODE;case 33648:return Is.MIRROR_ADDRESSMODE;case 10497:return Is.WRAP_ADDRESSMODE;default:return Ie$2.Warn(`${e}: Invalid value (${t})`),Is.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const s=null==t.magFilter?9729:t.magFilter,n=null==t.minFilter?9987:t.minFilter;if(9729===s)switch(n){case 9728:return Is.LINEAR_NEAREST;case 9729:return Is.LINEAR_LINEAR;case 9984:return Is.LINEAR_NEAREST_MIPNEAREST;case 9985:return Is.LINEAR_LINEAR_MIPNEAREST;case 9986:return Is.LINEAR_NEAREST_MIPLINEAR;case 9987:return Is.LINEAR_LINEAR_MIPLINEAR;default:return Ie$2.Warn(`${e}/minFilter: Invalid value (${n})`),Is.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==s&&Ie$2.Warn(`${e}/magFilter: Invalid value (${s})`),n){case 9728:return Is.NEAREST_NEAREST;case 9729:return Is.NEAREST_LINEAR;case 9984:return Is.NEAREST_NEAREST_MIPNEAREST;case 9985:return Is.NEAREST_LINEAR_MIPNEAREST;case 9986:return Is.NEAREST_NEAREST_MIPLINEAR;case 9987:return Is.NEAREST_LINEAR_MIPLINEAR;default:return Ie$2.Warn(`${e}/minFilter: Invalid value (${n})`),Is.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return Bi(t)}catch(t){throw new Error(`${e}: ${t.message}`)}}static _GetTypedArray(e,t,s,n,i){const r=s.buffer;n=s.byteOffset+(n||0);const o=Re._GetTypedArrayConstructor(`${e}/componentType`,t),a=Hi.GetTypeByteLength(t);return n%a!==0?(Ie$2.Warn(`${e}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${a})`),new o(r.slice(n,n+i*a),0)):new o(r,n,i)}static _GetNumComponents(e,t){switch(t){case "SCALAR":return 1;case "VEC2":return 2;case "VEC3":return 3;case "VEC4":case "MAT2":return 4;case "MAT3":return 9;case "MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(t){return Ai.IsBase64(t)||-1===t.indexOf("..")}static _GetDrawMode(e,t){switch(null==t&&(t=4),t){case 0:return hr$1.PointListDrawMode;case 1:return hr$1.LineListDrawMode;case 2:return hr$1.LineLoopDrawMode;case 3:return hr$1.LineStripDrawMode;case 4:return hr$1.TriangleFillMode;case 5:return hr$1.TriangleStripDrawMode;case 6:return hr$1.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials)for(const t of this._gltf.materials)if(t._data)for(const s in t._data){const n=t._data[s];for(const t of n.babylonMeshes){t.computeWorldMatrix(true);const s=n.babylonMaterial;e.push(s.forceCompilationAsync(t)),e.push(s.forceCompilationAsync(t,{useInstances:true})),this._parent.useClipPlane&&(e.push(s.forceCompilationAsync(t,{clipPlane:true})),e.push(s.forceCompilationAsync(t,{clipPlane:true,useInstances:true})));}}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile materials");}))}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const s of t){const t=s.getShadowGenerator();t&&e.push(t.forceCompilationAsync());}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile shadow generators");}))}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t);}_applyExtensions(e,t,s){for(const n of this._extensions)if(n.enabled){const i=`${n.name}.${t}`,r=e;r._activeLoaderExtensionFunctions=r._activeLoaderExtensionFunctions||{};const o=r._activeLoaderExtensionFunctions;if(!o[i]){o[i]=true;try{const e=s(n);if(e)return e}finally{delete o[i];}}}return null}_extensionsOnLoading(){this._forEachExtensions((e=>e.onLoading&&e.onLoading()));}_extensionsOnReady(){this._forEachExtensions((e=>e.onReady&&e.onReady()));}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",(s=>s.loadSceneAsync&&s.loadSceneAsync(e,t)))}_extensionsLoadNodeAsync(e,t,s){return this._applyExtensions(t,"loadNode",(n=>n.loadNodeAsync&&n.loadNodeAsync(e,t,s)))}_extensionsLoadCameraAsync(e,t,s){return this._applyExtensions(t,"loadCamera",(n=>n.loadCameraAsync&&n.loadCameraAsync(e,t,s)))}_extensionsLoadVertexDataAsync(e,t,s){return this._applyExtensions(t,"loadVertexData",(n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(e,t,s)))}_extensionsLoadMeshPrimitiveAsync(e,t,s,n,i,r){return this._applyExtensions(i,"loadMeshPrimitive",(o=>o._loadMeshPrimitiveAsync&&o._loadMeshPrimitiveAsync(e,t,s,n,i,r)))}_extensionsLoadMaterialAsync(e,t,s,n,i){return this._applyExtensions(t,"loadMaterial",(r=>r._loadMaterialAsync&&r._loadMaterialAsync(e,t,s,n,i)))}_extensionsCreateMaterial(e,t,s){return this._applyExtensions(t,"createMaterial",(n=>n.createMaterial&&n.createMaterial(e,t,s)))}_extensionsLoadMaterialPropertiesAsync(e,t,s){return this._applyExtensions(t,"loadMaterialProperties",(n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(e,t,s)))}_extensionsLoadTextureInfoAsync(e,t,s){return this._applyExtensions(t,"loadTextureInfo",(n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(e,t,s)))}_extensionsLoadTextureAsync(e,t,s){return this._applyExtensions(t,"loadTexture",(n=>n._loadTextureAsync&&n._loadTextureAsync(e,t,s)))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",(s=>s.loadAnimationAsync&&s.loadAnimationAsync(e,t)))}_extensionsLoadAnimationChannelAsync(e,t,s,n,i){return this._applyExtensions(s,"loadAnimationChannel",(r=>r._loadAnimationChannelAsync&&r._loadAnimationChannelAsync(e,t,s,n,i)))}_extensionsLoadSkinAsync(e,t,s){return this._applyExtensions(s,"loadSkin",(n=>n._loadSkinAsync&&n._loadSkinAsync(e,t,s)))}_extensionsLoadUriAsync(e,t,s){return this._applyExtensions(t,"loadUri",(n=>n._loadUriAsync&&n._loadUriAsync(e,t,s)))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",(s=>s.loadBufferViewAsync&&s.loadBufferViewAsync(e,t)))}_extensionsLoadBufferAsync(e,t,s,n){return this._applyExtensions(t,"loadBuffer",(i=>i.loadBufferAsync&&i.loadBufferAsync(e,t,s,n)))}static LoadExtensionAsync(e,t,s,n){if(!t.extensions)return null;const i=t.extensions[s];return i?n(`${e}/extensions/${s}`,i):null}static LoadExtraAsync(e,t,s,n){if(!t.extras)return null;const i=t.extras[s];return i?n(`${e}/extras/${s}`,i):null}isExtensionUsed(e){return !!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)}logOpen(e){this._parent._logOpen(e);}logClose(){this._parent._logClose();}log(e){this._parent._log(e);}startPerformanceCounter(e){this._parent._startPerformanceCounter(e);}endPerformanceCounter(e){this._parent._endPerformanceCounter(e);}};Re$2.DefaultSampler={index:-1},we$2._CreateGLTF2Loader=e=>new Re$2(e);var glTFLoaderDKIjI8R4_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,ArrayItem:Oe$2,GLTFFileLoader:we$2,GLTFLoader:Re$2,LoadBoundingInfoFromPositionAccessor:Ee$2});let p$f=class p extends Ms{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const i=this.getScene();i&&i.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(re$5.RotationY(this._rotationY));}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let s="";for(const t of e)s+=t;return new p(s,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,s=true){const n=t.useDelayedTextureLoading;t.useDelayedTextureLoading=false;const r=new p(e,t,null,false,null,null,null,void 0,true,i,s);return t.useDelayedTextureLoading=n,r}constructor(e,o,a=null,l=false,u=null,h=null,d=null,_=Qe$1.TEXTUREFORMAT_RGBA,x=false,f=null,p=false,c=.8,g=0,m,b){super(o),this.onLoadObservable=new R$g,this.boundingBoxPosition=te$4.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new re$5,this._buffer=null,this.name=e,this.url=e,this._noMipmap=l,this.hasAlpha=false,this.isCube=true,this._textureMatrix=re$5.Identity(),this.coordinatesMode=Is.CUBIC_MODE;let y=null,O=null;null===a||Array.isArray(a)?(this._noMipmap=l,this._format=_,this._createPolynomials=p,y=a,this._loaderOptions=m,this._useSRGBBuffer=b,this._lodScale=c,this._lodOffset=g):(y=a.extensions??null,this._noMipmap=a.noMipmap??false,u=a.files??null,O=a.buffer??null,this._format=a.format??Qe$1.TEXTUREFORMAT_RGBA,x=a.prefiltered??false,f=a.forcedExtension??null,this._createPolynomials=a.createPolynomials??false,this._lodScale=a.lodScale??.8,this._lodOffset=a.lodOffset??0,this._loaderOptions=a.loaderOptions,this._useSRGBBuffer=a.useSRGBBuffer,h=a.onLoad??null,d=a.onError??null),(e||u)&&this.updateURL(e,f,h,x,d,y,this.getScene()?.useDelayedTextureLoading,u,O);}getClassName(){return "CubeTexture"}updateURL(e,i=null,s=null,n=false,r=null,o=null,a=false,l=null,u=null){this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,i&&(this._forcedExtension=i);const h=e.lastIndexOf("."),d=i||(h>-1?e.substring(h).toLowerCase():""),_=0===d.indexOf(".dds"),x=0===d.indexOf(".env"),f=0===d.indexOf(".basis");if(x?(this.gammaSpace=false,this._prefiltered=false,this.anisotropicFilteringLevel=1):(this._prefiltered=n,n&&(this.gammaSpace=false,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(f||x||_||o||(o=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,o){for(let t=0;t<o.length;t++)this._files.push(e+o[t]);this._extensions=o;}this._buffer=u,a?(this.delayLoadState=Qe$1.DELAYLOADSTATE_NOTLOADED,this._delayedOnLoad=s,this._delayedOnError=r):this._loadTexture(s,r);}delayLoad(e){this.delayLoadState===Qe$1.DELAYLOADSTATE_NOTLOADED&&(e&&(this._forcedExtension=e),this.delayLoadState=Qe$1.DELAYLOADSTATE_LOADED,this._loadTexture(this._delayedOnLoad,this._delayedOnError));}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag)return;if(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>-1!==e.getActiveTextures().indexOf(this))),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem)return;const s=ae$5.Vector3[0],n=ae$5.Quaternion[0],r=ae$5.Vector3[1];this._textureMatrix.decompose(s,n,r),n.z*=-1,n.w*=-1,re$5.ComposeToRef(s,n,r,this._textureMatrixRefraction);}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,i=null){const s=this.getScene(),n=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const o=()=>{this.onLoadObservable.notifyObservers(this),n&&(n.dispose(),this.getScene()?.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag)),e&&e();},l=(e,t)=>{this._loadingError=true,this._errorObject={message:e,exception:t},i&&i(e,t),Is.OnTextureLoadErrorObservable.notifyObservers(this);};this._texture?this._texture.isReady?Ai.SetImmediate((()=>o())):this._texture.onLoadedObservable.add((()=>o())):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,s,this._lodScale,this._lodOffset,e,l,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,s,this._files,this._noMipmap,e,l,this._format,this._forcedExtension,false,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add((()=>this.onLoadObservable.notifyObservers(this))));}static Parse(e,t,i){const s=Ae$3.Parse((()=>{let s=false;return e.prefiltered&&(s=e.prefiltered),new p(i+(e.url??e.name),t,e.extensions,false,e.files||null,null,null,void 0,s,e.forcedExtension)}),e,t);if(e.boundingBoxPosition&&(s.boundingBoxPosition=te$4.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=te$4.FromArray(e.boundingBoxSize)),e.animations)for(let t=0;t<e.animations.length;t++){const i=e.animations[t],n=O$g("BABYLON.Animation");n&&s.animations.push(n.Parse(i));}return s}clone(){let e=0;const t=Ae$3.Clone((()=>{const t=new p(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=t.uniqueId,t}),this);return t.uniqueId=e,t}};e$z([a$$()],p$f.prototype,"url",void 0),e$z([u$s()],p$f.prototype,"boundingBoxPosition",void 0),e$z([u$s()],p$f.prototype,"boundingBoxSize",null),e$z([a$$("rotationY")],p$f.prototype,"rotationY",null),e$z([a$$("files")],p$f.prototype,"_files",void 0),e$z([a$$("forcedExtension")],p$f.prototype,"_forcedExtension",void 0),e$z([a$$("extensions")],p$f.prototype,"_extensions",void 0),e$z([p$p("textureMatrix")],p$f.prototype,"_textureMatrix",void 0),e$z([p$p("textureMatrixRefraction")],p$f.prototype,"_textureMatrixRefraction",void 0),Is._CubeTextureParser=p$f.Parse,P$9("BABYLON.CubeTexture",p$f);var cubeTextureQcQtFJtH_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,CubeTexture:p$f});let d$e=class d extends p$f{constructor(t,s,n,r=Qe$1.TEXTUREFORMAT_RGBA,i=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,a=false,o=false,l=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,m=null){super("",t),this._texture=t.getEngine().createRawCubeTexture(s,n,r,i,a,o,l,m);}update(e,t,s,n,r=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,s,n,r);}updateRGBDAsync(e,t=null,s=.8,n=0){return g$i(this._texture,e,t,s,n).then((()=>{}))}clone(){return Ae$3.Clone((()=>{const e=this.getScene(),t=this._texture,s=new d(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return 13===t.source&&s.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),s}),this)}};const u$f="EXT_lights_image_based";let g$e=class g{constructor(e){this.name=u$f,this._loader=e,this.enabled=this._loader.isExtensionUsed(u$f);}dispose(){this._loader=null,delete this._lights;}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights;}}loadSceneAsync(e,t){return Re$2.LoadExtensionAsync(e,t,this.name,(async(s,n)=>{this._loader._allMaterialsDirtyRequired=true;const r=new Array;r.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${s}`);const i=Oe$2.Get(`${s}/light`,this._lights,n.light);return r.push(this._loadLightAsync(`/extensions/${this.name}/lights/${n.light}`,i).then((e=>{this._loader.babylonScene.environmentTexture=e;}))),this._loader.logClose(),await Promise.all(r).then((()=>{}))}))}_loadLightAsync(e,t){if(!t._loaded){const a=new Array;this._loader.logOpen(`${e}`);const o=new Array(t.specularImages.length);for(let s=0;s<t.specularImages.length;s++){const n=t.specularImages[s];o[s]=new Array(n.length);for(let t=0;t<n.length;t++){const r=`${e}/specularImages/${s}/${t}`;this._loader.logOpen(`${r}`);const i=n[t],l=Oe$2.Get(r,this._loader.gltf.images,i);a.push(this._loader.loadImageAsync(`/images/${i}`,l).then((e=>{o[s][t]=e;}))),this._loader.logClose();}}this._loader.logClose(),t._loaded=Promise.all(a).then((async()=>{const a=new d$e(this._loader.babylonScene,null,t.specularImageSize);if(a.name=t.name||"environment",t._babylonTexture=a,null!=t.intensity&&(a.level=t.intensity),t.rotation){let e=se$5.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(e=se$5.Inverse(e)),re$5.FromQuaternionToRef(e,a.getReflectionTextureMatrix());}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const l=za.FromArray(t.irradianceCoefficients);l.scaleInPlace(t.intensity),l.convertIrradianceToLambertianRadiance();const m=Xa.FromHarmonics(l),c=(o.length-1)/Math.log2(t.specularImageSize);return await a.updateRGBDAsync(o,m,c)}));}return t._loaded.then((()=>t._babylonTexture))}};fc(u$f),_c(u$f,true,(e=>new g$e(e)));var EXT_lights_image_basedDnZqov6m_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,EXT_lights_image_based:g$e});Er$1.prototype.thinInstanceAdd=function(t,n=true){if(!this.getScene().getEngine().getCaps().instancedArrays)return Ie$2.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(t)?t.length:1);const a=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(t))for(let e=0;e<t.length;++e)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,t[e],e===t.length-1&&n);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,t,n);return a},Er$1.prototype.thinInstanceAddSelf=function(t=true){return this.thinInstanceAdd(re$5.IdentityReadOnly,t)},Er$1.prototype.thinInstanceRegisterAttribute=function(t,e){t===Hi.ColorKind&&(t=Hi.ColorInstanceKind),this.removeVerticesData(t),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[t]=e,this._userThinInstanceBuffersStorage.sizes[t]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[t]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[t]),this._userThinInstanceBuffersStorage.vertexBuffers[t]=new Hi(this.getEngine(),this._userThinInstanceBuffersStorage.data[t],t,true,false,e,true),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[t]);},Er$1.prototype.thinInstanceSetMatrixAt=function(t,e,n=true){if(!this._thinInstanceDataStorage.matrixData||t>=this._thinInstanceDataStorage.instancesCount)return  false;const a=this._thinInstanceDataStorage.matrixData;return e.copyToArray(a,16*t),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[t]=e),n&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(false)),true},Er$1.prototype.thinInstanceSetAttributeAt=function(t,e,n,s=true){return t===Hi.ColorKind&&(t=Hi.ColorInstanceKind),!(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[t]||e>=this._thinInstanceDataStorage.instancesCount)&&(this._thinInstanceUpdateBufferSize(t,0),this._userThinInstanceBuffersStorage.data[t].set(n,e*this._userThinInstanceBuffersStorage.strides[t]),s&&this.thinInstanceBufferUpdated(t),true)},Object.defineProperty(Er$1.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(t){const e=this._thinInstanceDataStorage.matrixData??this.source?._thinInstanceDataStorage.matrixData;t<=(e?e.length/16:0)&&(this._thinInstanceDataStorage.instancesCount=t);},enumerable:true,configurable:true}),Er$1.prototype._thinInstanceCreateMatrixBuffer=function(t,e,n=true){const a=new Vi(this.getEngine(),e,!n,16,false,true);for(let e=0;e<4;e++)this.setVerticesBuffer(a.createVertexBuffer(t+e,4*e,4));return a},Er$1.prototype.thinInstanceSetBuffer=function(t,e,n=0,s=true){n=n||16,"matrix"===t?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*n,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,null!==e?(this._thinInstanceDataStorage.instancesCount=e.length/n,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,s),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(false)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):"previousMatrix"===t?(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,null!==e&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,s))):(t===Hi.ColorKind&&(t=Hi.ColorInstanceKind),null===e?this._userThinInstanceBuffersStorage?.data[t]&&(this.removeVerticesData(t),delete this._userThinInstanceBuffersStorage.data[t],delete this._userThinInstanceBuffersStorage.strides[t],delete this._userThinInstanceBuffersStorage.sizes[t],delete this._userThinInstanceBuffersStorage.vertexBuffers[t]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[t]=e,this._userThinInstanceBuffersStorage.strides[t]=n,this._userThinInstanceBuffersStorage.sizes[t]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[t]=new Hi(this.getEngine(),e,t,!s,false,n,true),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[t])));},Er$1.prototype.thinInstanceBufferUpdated=function(t){"matrix"===t?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(t),this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):"previousMatrix"===t?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(t),this._thinInstanceDataStorage.previousMatrixBuffer?.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):(t===Hi.ColorKind&&(t=Hi.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[t]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[t].isUpdatable()&&this._thinInstanceRecreateBuffer(t),this._userThinInstanceBuffersStorage.vertexBuffers[t].updateDirectly(this._userThinInstanceBuffersStorage.data[t],0)));},Er$1.prototype.thinInstancePartialBufferUpdate=function(t,e,n){"matrix"===t?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,n):(t===Hi.ColorKind&&(t=Hi.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[t]&&this._userThinInstanceBuffersStorage.vertexBuffers[t].updateDirectly(e,n));},Er$1.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return [];const t=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=re$5.FromArray(t,16*e);}return this._thinInstanceDataStorage.worldMatrices},Er$1.prototype.thinInstanceRefreshBoundingInfo=function(t=false,e=false,a=false){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const s=this._thinInstanceDataStorage.boundingVectors;if(t||!this.rawBoundingInfo){s.length=0,this.refreshBoundingInfo(e,a);const t=this.getBoundingInfo();this.rawBoundingInfo=new qi(t.minimum,t.maximum);}const h=this.getBoundingInfo(),f=this._thinInstanceDataStorage.matrixData;if(0===s.length)for(let t=0;t<h.boundingBox.vectors.length;++t)s.push(h.boundingBox.vectors[t].clone());ae$5.Vector3[0].setAll(Number.POSITIVE_INFINITY),ae$5.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let t=0;t<this._thinInstanceDataStorage.instancesCount;++t){re$5.FromArrayToRef(f,16*t,ae$5.Matrix[0]);for(let t=0;t<s.length;++t)te$4.TransformCoordinatesToRef(s[t],ae$5.Matrix[0],ae$5.Vector3[2]),ae$5.Vector3[0].minimizeInPlace(ae$5.Vector3[2]),ae$5.Vector3[1].maximizeInPlace(ae$5.Vector3[2]);}h.reConstruct(ae$5.Vector3[0],ae$5.Vector3[1]),this._updateBoundingInfo();},Er$1.prototype._thinInstanceRecreateBuffer=function(t,e=true){"matrix"===t?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,e)):"previousMatrix"===t?this._scene.needsPreviousWorldMatrices&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,e)):(t===Hi.ColorKind&&(t=Hi.ColorInstanceKind),this._userThinInstanceBuffersStorage.vertexBuffers[t]?.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[t]=new Hi(this.getEngine(),this._userThinInstanceBuffersStorage.data[t],t,!e,false,this._userThinInstanceBuffersStorage.strides[t],true),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[t]));},Er$1.prototype._thinInstanceUpdateBufferSize=function(t,e=1){t===Hi.ColorKind&&(t=Hi.ColorInstanceKind);const n="matrix"===t;if(!(n||this._userThinInstanceBuffersStorage&&this._userThinInstanceBuffersStorage.strides[t]))return;const s=n?16:this._userThinInstanceBuffersStorage.strides[t],i=n?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[t];let r=n?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[t];const o=(this._thinInstanceDataStorage.instancesCount+e)*s;let h=i;for(;h<o;)h*=2;if(!r||i!=h){if(r){const t=new Float32Array(h);t.set(r,0),r=t;}else r=new Float32Array(h);n?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",r,false),this._thinInstanceDataStorage.matrixData=r,this._thinInstanceDataStorage.matrixBufferSize=h,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",r,false))):(this._userThinInstanceBuffersStorage.vertexBuffers[t]?.dispose(),this._userThinInstanceBuffersStorage.data[t]=r,this._userThinInstanceBuffersStorage.sizes[t]=h,this._userThinInstanceBuffersStorage.vertexBuffers[t]=new Hi(this.getEngine(),r,t,true,false,s,true),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[t]));}},Er$1.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}});},Er$1.prototype._disposeThinInstanceSpecificData=function(){this._thinInstanceDataStorage?.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null),this._thinInstanceDataStorage?.previousMatrixBuffer&&(this._thinInstanceDataStorage.previousMatrixBuffer.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null);};const m$h="EXT_mesh_gpu_instancing";let l$e=class l{constructor(e){this.name=m$h,this._loader=e,this.enabled=this._loader.isExtensionUsed(m$h);}dispose(){this._loader=null;}loadNodeAsync(n,a,m){return Re$2.LoadExtensionAsync(n,a,this.name,(async(n,i)=>{this._loader._disableInstancedMesh++;const l=this._loader.loadNodeAsync(`/nodes/${a.index}`,a,m);if(this._loader._disableInstancedMesh--,!a._primitiveBabylonMeshes)return await l;const d=new Array;let h=0;const u=e=>{if(null==i.attributes[e])return void d.push(Promise.resolve(null));const t=Oe$2.Get(`${n}/attributes/${e}`,this._loader.gltf.accessors,i.attributes[e]);if(d.push(this._loader._loadFloatAccessorAsync(`/accessors/${t.bufferView}`,t)),0===h)h=t.count;else if(h!==t.count)throw new Error(`${n}/attributes: Instance buffer accessors do not have the same count.`)};return u("TRANSLATION"),u("ROTATION"),u("SCALE"),u("_COLOR_0"),await l.then((async n=>{const[i,c,m,l]=await Promise.all(d),u=new Float32Array(16*h);ae$5.Vector3[0].copyFromFloats(0,0,0),ae$5.Quaternion[0].copyFromFloats(0,0,0,1),ae$5.Vector3[1].copyFromFloats(1,1,1);for(let r=0;r<h;++r)i&&te$4.FromArrayToRef(i,3*r,ae$5.Vector3[0]),c&&se$5.FromArrayToRef(c,4*r,ae$5.Quaternion[0]),m&&te$4.FromArrayToRef(m,3*r,ae$5.Vector3[1]),re$5.ComposeToRef(ae$5.Vector3[1],ae$5.Quaternion[0],ae$5.Vector3[0],ae$5.Matrix[0]),ae$5.Matrix[0].copyToArray(u,16*r);for(const e of a._primitiveBabylonMeshes)e.thinInstanceSetBuffer("matrix",u,16,true),l&&(l.length===3*h?e.thinInstanceSetBuffer("color",l,3,true):l.length===4*h?e.thinInstanceSetBuffer("color",l,4,true):Ie$2.Warn("Unexpected size of _COLOR_0 attribute for mesh "+e.name));return n}))}))}};fc(m$h),_c(m$h,true,(e=>new l$e(e)));var EXT_mesh_gpu_instancingCKB7YdY7_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,EXT_mesh_gpu_instancing:l$e});let n$Z=0,a$B=null;let i$M=class i{static get Default(){return i._Default||(i._Default=new i),i._Default}constructor(){const e=i.Configuration.decoder;this._decoderModulePromise=Ai.LoadBabylonScriptAsync(e.url).then((()=>MeshoptDecoder.ready));}dispose(){delete this._decoderModulePromise;}async decodeGltfBufferAsync(e,t,s,o,r){await this._decoderModulePromise,0===n$Z&&(MeshoptDecoder.useWorkers(1),n$Z=1);const i=await MeshoptDecoder.decodeGltfBufferAsync(t,s,e,o,r);return null!==a$B&&clearTimeout(a$B),a$B=setTimeout((()=>{MeshoptDecoder.useWorkers(0),n$Z=0,a$B=null;}),1e3),i}};i$M.Configuration={decoder:{url:`${Ai._DefaultCdnUrl}/meshopt_decoder.js`}},i$M._Default=null;const d$d="EXT_meshopt_compression";let l$d=class l{constructor(e){this.name=d$d,this.enabled=e.isExtensionUsed(d$d),this._loader=e;}dispose(){this._loader=null;}loadBufferViewAsync(s,o){return Re$2.LoadExtensionAsync(s,o,this.name,(async(e,r)=>{const n=o;if(n._meshOptData)return await n._meshOptData;const a=Oe$2.Get(`${s}/buffer`,this._loader.gltf.buffers,r.buffer);return n._meshOptData=this._loader.loadBufferAsync(`/buffers/${a.index}`,a,r.byteOffset||0,r.byteLength).then((async e=>await i$M.Default.decodeGltfBufferAsync(e,r.count,r.byteStride,r.mode,r.filter))),await n._meshOptData}))}};fc(d$d),_c(d$d,true,(e=>new l$d(e)));var EXT_meshopt_compressionCn4BFUXI_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,EXT_meshopt_compression:l$d});const o$N="EXT_texture_avif";let n$Y=class n{constructor(e){this.name=o$N,this._loader=e,this.enabled=e.isExtensionUsed(o$N);}dispose(){this._loader=null;}_loadTextureAsync(t,r,o){return Re$2.LoadExtensionAsync(t,r,this.name,(async(n,i)=>{const a=null==r.sampler?Re$2.DefaultSampler:Oe$2.Get(`${t}/sampler`,this._loader.gltf.samplers,r.sampler),m=Oe$2.Get(`${n}/source`,this._loader.gltf.images,i.source);return await this._loader._createTextureAsync(t,a,m,(e=>{o(e);}),void 0,!r._textureInfo.nonColorData)}))}};fc(o$N),_c(o$N,true,(e=>new n$Y(e)));var EXT_texture_avifDm7QsZfM_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,EXT_texture_avif:n$Y});const o$M="EXT_texture_webp";let n$X=class n{constructor(e){this.name=o$M,this._loader=e,this.enabled=e.isExtensionUsed(o$M);}dispose(){this._loader=null;}_loadTextureAsync(t,r,o){return Re$2.LoadExtensionAsync(t,r,this.name,(async(n,i)=>{const a=null==r.sampler?Re$2.DefaultSampler:Oe$2.Get(`${t}/sampler`,this._loader.gltf.samplers,r.sampler),m=Oe$2.Get(`${n}/source`,this._loader.gltf.images,i.source);return await this._loader._createTextureAsync(t,a,m,(e=>{o(e);}),void 0,!r._textureInfo.nonColorData)}))}};fc(o$M),_c(o$M,true,(e=>new n$X(e)));var EXT_texture_webpBIdVdnIh_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,EXT_texture_webp:n$X});const t$E="ExtrasAsMetadata";let e$f=class e{_assignExtras(a,s){if(s.extras&&Object.keys(s.extras).length>0){const t=a.metadata=a.metadata||{};(t.gltf=t.gltf||{}).extras=s.extras;}}constructor(a){this.name=t$E,this.enabled=true,this._loader=a;}dispose(){this._loader=null;}loadNodeAsync(a,s,t){return this._loader.loadNodeAsync(a,s,(a=>{this._assignExtras(a,s),t(a);}))}loadCameraAsync(a,s,t){return this._loader.loadCameraAsync(a,s,(a=>{this._assignExtras(a,s),t(a);}))}createMaterial(a,s,t){const e=this._loader.createMaterial(a,s,t);return this._assignExtras(e,s),e}};fc(t$E),_c(t$E,false,(a=>new e$f(a)));var ExtrasAsMetadataDlmjm18_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,ExtrasAsMetadata:e$f});function o$L(e,t,a,o){return te$4.FromArray(t,a).scaleInPlace(o)}function i$L(n,t,a,o){return se$5.FromArray(t,a).scaleInPlace(o)}function s$g(n,e,t,a){const o=new Array(n._numMorphTargets);for(let n=0;n<o.length;n++)o[n]=e[t++]*a;return o}let r$15=class r{constructor(n,e,t,a){this.type=n,this.name=e,this.getValue=t,this.getStride=a;}_buildAnimation(n,e,a){const o=new zr$1(n,this.name,e,this.type);return o.setKeys(a),o}};let l$c=class l extends r$15{buildAnimations(n,e,t,a){const o=[];return o.push({babylonAnimatable:n._babylonTransformNode,babylonAnimation:this._buildAnimation(e,t,a)}),o}};let m$g=class m extends r$15{buildAnimations(n,e,a,o){const i=[];if(n._numMorphTargets)for(let s=0;s<n._numMorphTargets;s++){const r=new zr$1(`${e}_${s}`,this.name,a,this.type);if(r.setKeys(o.map((n=>({frame:n.frame,inTangent:n.inTangent?n.inTangent[s]:void 0,value:n.value[s],outTangent:n.outTangent?n.outTangent[s]:void 0,interpolation:n.interpolation})))),n._primitiveBabylonMeshes)for(const e of n._primitiveBabylonMeshes)if(e.morphTargetManager){const n=e.morphTargetManager.getTarget(s),t=r.clone();n.animations.push(t),i.push({babylonAnimatable:n,babylonAnimation:t});}}return i}};P$7("/nodes/{}/translation",[new l$c(zr$1.ANIMATIONTYPE_VECTOR3,"position",o$L,(()=>3))]),P$7("/nodes/{}/rotation",[new l$c(zr$1.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",i$L,(()=>4))]),P$7("/nodes/{}/scale",[new l$c(zr$1.ANIMATIONTYPE_VECTOR3,"scaling",o$L,(()=>3))]),P$7("/nodes/{}/weights",[new m$g(zr$1.ANIMATIONTYPE_FLOAT,"influence",s$g,(n=>n._numMorphTargets))]);var glTFLoaderAnimationC7OnUlyq_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,AnimationPropertyInfo:r$15,TransformNodeAnimationPropertyInfo:l$c,WeightAnimationPropertyInfo:m$g,getQuaternion:i$L,getVector3:o$L,getWeights:s$g});function l$b(e,s,n,a){return ge$3.FromArray(s,n).scale(a)}function m$f(e,t,s,n){return t[s]*n}function _$c(e,t,s,n){return -t[s]*n}function c$d(e,t,s,n){return t[s+1]*n}function u$e(e,t,s,n){return t[s]*n*2}function x$a(t){return {scale:[new f$h(zr$1.ANIMATIONTYPE_FLOAT,`${t}.uScale`,m$f,(()=>2)),new f$h(zr$1.ANIMATIONTYPE_FLOAT,`${t}.vScale`,c$d,(()=>2))],offset:[new f$h(zr$1.ANIMATIONTYPE_FLOAT,`${t}.uOffset`,m$f,(()=>2)),new f$h(zr$1.ANIMATIONTYPE_FLOAT,`${t}.vOffset`,c$d,(()=>2))],rotation:[new f$h(zr$1.ANIMATIONTYPE_FLOAT,`${t}.wAng`,_$c,(()=>1))]}}let T$8=class T extends r$15{buildAnimations(e,t,s,n){return [{babylonAnimatable:e._babylonCamera,babylonAnimation:this._buildAnimation(t,s,n)}]}};let f$h=class f extends r$15{buildAnimations(e,t,s,n){const a=[];for(const r in e._data)a.push({babylonAnimatable:e._data[r].babylonMaterial,babylonAnimation:this._buildAnimation(t,s,n)});return a}};let A$a=class A extends r$15{buildAnimations(e,t,s,n){return [{babylonAnimatable:e._babylonLight,babylonAnimation:this._buildAnimation(t,s,n)}]}};P$7("/cameras/{}/orthographic/xmag",[new T$8(zr$1.ANIMATIONTYPE_FLOAT,"orthoLeft",_$c,(()=>1)),new T$8(zr$1.ANIMATIONTYPE_FLOAT,"orthoRight",c$d,(()=>1))]),P$7("/cameras/{}/orthographic/ymag",[new T$8(zr$1.ANIMATIONTYPE_FLOAT,"orthoBottom",_$c,(()=>1)),new T$8(zr$1.ANIMATIONTYPE_FLOAT,"orthoTop",c$d,(()=>1))]),P$7("/cameras/{}/orthographic/zfar",[new T$8(zr$1.ANIMATIONTYPE_FLOAT,"maxZ",m$f,(()=>1))]),P$7("/cameras/{}/orthographic/znear",[new T$8(zr$1.ANIMATIONTYPE_FLOAT,"minZ",m$f,(()=>1))]),P$7("/cameras/{}/perspective/yfov",[new T$8(zr$1.ANIMATIONTYPE_FLOAT,"fov",m$f,(()=>1))]),P$7("/cameras/{}/perspective/zfar",[new T$8(zr$1.ANIMATIONTYPE_FLOAT,"maxZ",m$f,(()=>1))]),P$7("/cameras/{}/perspective/znear",[new T$8(zr$1.ANIMATIONTYPE_FLOAT,"minZ",m$f,(()=>1))]),P$7("/materials/{}/pbrMetallicRoughness/baseColorFactor",[new f$h(zr$1.ANIMATIONTYPE_COLOR3,"albedoColor",l$b,(()=>4)),new f$h(zr$1.ANIMATIONTYPE_FLOAT,"alpha",(function(e,t,s,n){return t[s+3]*n}),(()=>4))]),P$7("/materials/{}/pbrMetallicRoughness/metallicFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"metallic",m$f,(()=>1))]),P$7("/materials/{}/pbrMetallicRoughness/metallicFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"roughness",m$f,(()=>1))]);const R$a=x$a("albedoTexture");P$7("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale",R$a.scale),P$7("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset",R$a.offset),P$7("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/rotation",R$a.rotation);const h$8=x$a("metallicTexture");P$7("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/scale",h$8.scale),P$7("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/offset",h$8.offset),P$7("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/rotation",h$8.rotation),P$7("/materials/{}/emissiveFactor",[new f$h(zr$1.ANIMATIONTYPE_COLOR3,"emissiveColor",l$b,(()=>3))]);const K$4=x$a("bumpTexture");P$7("/materials/{}/normalTexture/scale",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"bumpTexture.level",m$f,(()=>1))]),P$7("/materials/{}/normalTexture/extensions/KHR_texture_transform/scale",K$4.scale),P$7("/materials/{}/normalTexture/extensions/KHR_texture_transform/offset",K$4.offset),P$7("/materials/{}/normalTexture/extensions/KHR_texture_transform/rotation",K$4.rotation),P$7("/materials/{}/occlusionTexture/strength",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",m$f,(()=>1))]);const H$3=x$a("ambientTexture");P$7("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/scale",H$3.scale),P$7("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/offset",H$3.offset),P$7("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/rotation",H$3.rotation);const O$c=x$a("emissiveTexture");P$7("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/scale",O$c.scale),P$7("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/offset",O$c.offset),P$7("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/rotation",O$c.rotation),P$7("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyStrength",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyRotation",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"anisotropy.angle",m$f,(()=>1))]);const I$a=x$a("anisotropy.texture");P$7("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/scale",I$a.scale),P$7("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/offset",I$a.offset),P$7("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/rotation",I$a.rotation),P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",m$f,(()=>1))]);const N$7=x$a("clearCoat.texture");P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/scale",N$7.scale),P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/offset",N$7.offset),P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/rotation",N$7.rotation);const p$e=x$a("clearCoat.bumpTexture");P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/scale",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/scale",p$e.scale),P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/offset",p$e.offset),P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/rotation",p$e.rotation);const d$c=x$a("clearCoat.textureRoughness");P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/scale",d$c.scale),P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/offset",d$c.offset),P$7("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/rotation",d$c.rotation),P$7("/materials/{}/extensions/KHR_materials_dispersion/dispersionFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_emissive_strength/emissiveStrength",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"emissiveIntensity",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_ior/ior",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"indexOfRefraction",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"iridescence.intensity",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceIor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMinimum",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMaximum",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",m$f,(()=>1))]);const b$c=x$a("iridescence.texture");P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/scale",b$c.scale),P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/offset",b$c.offset),P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/rotation",b$c.rotation);const g$d=x$a("iridescence.thicknessTexture");P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/scale",g$d.scale),P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/offset",g$d.offset),P$7("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/rotation",g$d.rotation),P$7("/materials/{}/extensions/KHR_materials_sheen/sheenColorFactor",[new f$h(zr$1.ANIMATIONTYPE_COLOR3,"sheen.color",l$b,(()=>3))]),P$7("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"sheen.roughness",m$f,(()=>1))]);const M$a=x$a("sheen.texture");P$7("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/scale",M$a.scale),P$7("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/offset",M$a.offset),P$7("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/rotation",M$a.rotation);const F$6=x$a("sheen.textureRoughness");P$7("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/scale",F$6.scale),P$7("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/offset",F$6.offset),P$7("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/rotation",F$6.rotation),P$7("/materials/{}/extensions/KHR_materials_specular/specularFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"metallicF0Factor",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_specular/specularColorFactor",[new f$h(zr$1.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",l$b,(()=>3))]);const w$5=x$a("metallicReflectanceTexture");P$7("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/scale",w$5.scale),P$7("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/offset",w$5.offset),P$7("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/rotation",w$5.rotation);const E$d=x$a("reflectanceTexture");P$7("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/scale",E$d.scale),P$7("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/offset",E$d.offset),P$7("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/rotation",E$d.rotation),P$7("/materials/{}/extensions/KHR_materials_transmission/transmissionFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",m$f,(()=>1))]);const L$4=x$a("subSurface.refractionIntensityTexture");P$7("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/scale",L$4.scale),P$7("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/offset",L$4.offset),P$7("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/rotation",L$4.rotation),P$7("/materials/{}/extensions/KHR_materials_volume/attenuationColor",[new f$h(zr$1.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",l$b,(()=>3))]),P$7("/materials/{}/extensions/KHR_materials_volume/attenuationDistance",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",m$f,(()=>1))]),P$7("/materials/{}/extensions/KHR_materials_volume/thicknessFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",m$f,(()=>1))]);const P$6=x$a("subSurface.thicknessTexture");P$7("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/scale",P$6.scale),P$7("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/offset",P$6.offset),P$7("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/rotation",P$6.rotation),P$7("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionFactor",[new f$h(zr$1.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",m$f,(()=>1))]);const Y$3=x$a("subSurface.translucencyIntensityTexture");P$7("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/scale",Y$3.scale),P$7("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/offset",Y$3.offset),P$7("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/rotation",Y$3.rotation),P$7("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorFactor",[new f$h(zr$1.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",l$b,(()=>3))]);const y$9=x$a("subSurface.translucencyColorTexture");P$7("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/scale",y$9.scale),P$7("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/offset",y$9.offset),P$7("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/rotation",y$9.rotation),P$7("/extensions/KHR_lights_punctual/lights/{}/color",[new A$a(zr$1.ANIMATIONTYPE_COLOR3,"diffuse",l$b,(()=>3))]),P$7("/extensions/KHR_lights_punctual/lights/{}/intensity",[new A$a(zr$1.ANIMATIONTYPE_FLOAT,"intensity",m$f,(()=>1))]),P$7("/extensions/KHR_lights_punctual/lights/{}/range",[new A$a(zr$1.ANIMATIONTYPE_FLOAT,"range",m$f,(()=>1))]),P$7("/extensions/KHR_lights_punctual/lights/{}/spot/innerConeAngle",[new A$a(zr$1.ANIMATIONTYPE_FLOAT,"innerAngle",u$e,(()=>1))]),P$7("/extensions/KHR_lights_punctual/lights/{}/spot/outerConeAngle",[new A$a(zr$1.ANIMATIONTYPE_FLOAT,"angle",u$e,(()=>1))]),P$7("/nodes/{}/extensions/EXT_lights_ies/color",[new A$a(zr$1.ANIMATIONTYPE_COLOR3,"diffuse",l$b,(()=>3))]),P$7("/nodes/{}/extensions/EXT_lights_ies/multiplier",[new A$a(zr$1.ANIMATIONTYPE_FLOAT,"intensity",m$f,(()=>1))]),P$7("/nodes/{}/extensions/KHR_node_visibility/visible",[new class extends r$15{buildAnimations(e,t,s,n){return e._primitiveBabylonMeshes?e._primitiveBabylonMeshes.map((e=>({babylonAnimatable:e,babylonAnimation:this._buildAnimation(t,s,n)}))):[]}}(zr$1.ANIMATIONTYPE_FLOAT,"isVisible",m$f,(()=>1))]);const C$9="KHR_animation_pointer";let v$9=class v{constructor(e){this.name=C$9,this._loader=e,this._pathToObjectConverter=d$f(this._loader.gltf);}get enabled(){return this._loader.isExtensionUsed(C$9)}dispose(){this._loader=null,delete this._pathToObjectConverter;}_loadAnimationChannelAsync(e,t,n,a,r){const i=a.target.extensions?.KHR_animation_pointer;if(!i||!this._pathToObjectConverter)return null;"pointer"!==a.target.path&&Ie$2.Warn(`${e}/target/path: Value (${a.target.path}) must be (pointer) when using the ${this.name} extension`),null!=a.target.node&&Ie$2.Warn(`${e}/target/node: Value (${a.target.node}) must not be present when using the ${this.name} extension`);const o=`${e}/extensions/${this.name}`,l=i.pointer;if(!l)throw new Error(`${o}: Pointer is missing`);try{const s=this._pathToObjectConverter.convert(l);if(!s.info.interpolation)throw new Error(`${o}/pointer: Interpolation is missing`);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,n,a,{object:s.object,info:s.info.interpolation},r)}catch(e){return Ie$2.Warn(`${o}/pointer: Invalid pointer (${l}) skipped`),null}}};fc(C$9),_c(C$9,true,(e=>new v$9(e)));
var KHR_animation_pointerDIJlJSoB_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_animation_pointer:v$9});function c$c(e,t,r,o,s){const a=e;let n=null,i=null,d=null;try{let e;n=new a.Decoder,i=new a.DecoderBuffer,i.Init(t,t.byteLength);const l=n.GetEncodedGeometryType(i);switch(l){case a.TRIANGULAR_MESH:{const t=new a.Mesh;if(e=n.DecodeBufferToMesh(i,t),!e.ok()||0===t.ptr)throw new Error(e.error_msg());const r=3*t.num_faces(),s=4*r,l=a._malloc(s);try{n.GetTrianglesUInt32Array(t,s,l);const e=new Uint32Array(r);e.set(new Uint32Array(a.HEAPF32.buffer,l,r)),o(e);}finally{a._free(l);}d=t;break}case a.POINT_CLOUD:{const t=new a.PointCloud;if(e=n.DecodeBufferToPointCloud(i,t),!e.ok()||!t.ptr)throw new Error(e.error_msg());d=t;break}default:throw new Error(`Invalid geometry type ${l}`)}const c=d.num_points(),m=(e,t,r,o)=>{const n=o.data_type(),i=o.num_components(),d=o.normalized(),l=o.byte_stride(),m=o.byte_offset(),u={[a.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:a.HEAPF32},[a.DT_INT8]:{typedArrayConstructor:Int8Array,heap:a.HEAP8},[a.DT_INT16]:{typedArrayConstructor:Int16Array,heap:a.HEAP16},[a.DT_INT32]:{typedArrayConstructor:Int32Array,heap:a.HEAP32},[a.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:a.HEAPU8},[a.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:a.HEAPU16},[a.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:a.HEAPU32}}[n];if(!u)throw new Error(`Invalid data type ${n}`);const y=c*i,f=y*u.typedArrayConstructor.BYTES_PER_ELEMENT,w=a._malloc(f);try{e.GetAttributeDataArrayForAllPoints(t,o,n,f,w);const a=new u.typedArrayConstructor(u.heap.buffer,w,y);s(r,a.slice(),i,m,l,d);}finally{a._free(w);}};if(r)for(const e in r){const t=r[e],o=n.GetAttributeByUniqueId(d,t);m(n,d,e,o);}else {const e={position:a.POSITION,normal:a.NORMAL,color:a.COLOR,uv:a.TEX_COORD};for(const t in e){const r=n.GetAttributeId(d,e[t]);if(-1!==r){const e=n.GetAttribute(d,r);m(n,d,t,e);}}}return c}finally{d&&a.destroy(d),i&&a.destroy(i),n&&a.destroy(n);}}function m$e(){let e;onmessage=t=>{const r=t.data;switch(r.id){case "init":{r.url&&importScripts(r.url);const t=r.wasmBinary?{wasmBinary:r.wasmBinary}:{};e=DracoDecoderModule(t),postMessage({id:"initDone"});break}case "decodeMesh":if(!e)throw new Error("Draco decoder module is not available");e.then((e=>{const t=c$c(e,r.dataView,r.attributes,(e=>{postMessage({id:"indices",data:e},[e.buffer]);}),((e,t,r,o,s,a)=>{postMessage({id:"attribute",kind:e,data:t,size:r,byteOffset:o,byteStride:s,normalized:a},[t.buffer]);}));postMessage({id:"decodeMeshDone",totalVertices:t});}));}};}let u$d=class u{constructor(t){if(t.workerPool)return void(this._workerPoolPromise=Promise.resolve(t.workerPool));const r=t.wasmBinary,o=t.numWorkers??("object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1),s=o&&"function"==typeof Worker&&"function"==typeof URL,a=s||!t.jsModule,i=t.wasmUrl&&t.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:a?Ai.GetBabylonScriptURL(t.wasmUrl,true):"",wasmBinaryPromise:r?Promise.resolve(r):Ai.LoadFileAsync(Ai.GetBabylonScriptURL(t.wasmBinaryUrl,true))}:{url:a?Ai.GetBabylonScriptURL(t.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};s?this._workerPoolPromise=i.wasmBinaryPromise.then((e=>{const t=this._getWorkerContent(),r=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));return new s$s(o,(()=>async function(e,t,r){return await new Promise(((o,s)=>{const a=t=>{e.removeEventListener("error",a),e.removeEventListener("message",n),s(t);},n=t=>{"initDone"===t.data.id&&(e.removeEventListener("error",a),e.removeEventListener("message",n),o(e));};if(e.addEventListener("error",a),e.addEventListener("message",n),t){const o=t.slice(0);e.postMessage({id:"init",url:r,wasmBinary:o},[o]);}else e.postMessage({id:"init",url:r});}))}(new Worker(r),e,i.url)))})):this._modulePromise=i.wasmBinaryPromise.then((async r=>{if(!this._isModuleAvailable()&&!t.jsModule){if(!i.url)throw new Error("Draco codec module is not available");await Ai.LoadBabylonScriptAsync(i.url);}return await this._createModuleAsync(r,t.jsModule)}));}async whenReadyAsync(){this._workerPoolPromise?await this._workerPoolPromise:this._modulePromise&&await this._modulePromise;}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then((e=>{e.dispose();})),delete this._workerPoolPromise,delete this._modulePromise;}};let y$8=class y extends u$d{static get DefaultAvailable(){return !!((e=y.DefaultConfiguration).wasmUrl&&(e.wasmBinary||e.wasmBinaryUrl)&&"object"==typeof WebAssembly||e.fallbackUrl);var e;}static get Default(){return y._Default??=new y,y._Default}static ResetDefault(e){y._Default&&(e||y._Default.dispose(),y._Default=null);}_isModuleAvailable(){return "undefined"!=typeof DracoDecoderModule}async _createModuleAsync(e,t){return {module:await(t||DracoDecoderModule)({wasmBinary:e})}}_getWorkerContent(){return `${c$c}(${m$e})()`}constructor(e=y.DefaultConfiguration){super(e);}decodeMeshToMeshDataAsync(e,t,r){const s=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength);if(this._workerPoolPromise)return this._workerPoolPromise.then((async e=>await new Promise(((a,n)=>{e.push(((e,i)=>{let d=null;const l=[],c=t=>{e.removeEventListener("error",c),e.removeEventListener("message",m),n(t),i();},m=t=>{const s=t.data;switch(s.id){case "indices":d=s.data;break;case "attribute":l.push({kind:s.kind,data:s.data,size:s.size,byteOffset:s.byteOffset,byteStride:s.byteStride,normalized:(n=s.kind,u=s.normalized,r&&void 0!==r[n]?(u!==r[n]&&Ie$2.Warn(`Normalized flag from Draco data (${u}) does not match normalized flag from glTF accessor (${r[n]}). Using flag from glTF accessor.`),r[n]):u)});break;case "decodeMeshDone":e.removeEventListener("error",c),e.removeEventListener("message",m),a({indices:d,attributes:l,totalVertices:s.totalVertices}),i();}var n,u;};e.addEventListener("error",c),e.addEventListener("message",m);const u=s.slice();e.postMessage({id:"decodeMesh",dataView:u,attributes:t},[u.buffer]);}));}))));if(this._modulePromise)return this._modulePromise.then((e=>{let r=null;const o=[],a=c$c(e.module,s,t,(e=>{r=e;}),((e,t,r,s,a,n)=>{o.push({kind:e,data:t,size:r,byteOffset:s,byteStride:a,normalized:n});}));return {indices:r,attributes:o,totalVertices:a}}));throw new Error("Draco decoder module is not available")}async decodeMeshToGeometryAsync(e,o,s,a){const n=await this.decodeMeshToMeshDataAsync(s,a),i=new rs(e,o);n.indices&&i.setIndices(n.indices);for(const e of n.attributes)i.setVerticesBuffer(new Hi(o.getEngine(),e.data,e.kind,false,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,true),n.totalVertices);return i}async _decodeMeshToGeometryForGltfAsync(e,o,s,a,n,i){const d=await this.decodeMeshToMeshDataAsync(s,a,n),l=new rs(e,o);i&&(l._boundingInfo=i,l.useBoundingInfoFromGeometry=true),d.indices&&l.setIndices(d.indices);for(const e of d.attributes)l.setVerticesBuffer(new Hi(o.getEngine(),e.data,e.kind,false,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,true),d.totalVertices);return l}};y$8.DefaultConfiguration={wasmUrl:`${Ai._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${Ai._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${Ai._DefaultCdnUrl}/draco_decoder_gltf.js`},y$8._Default=null;const f$g="KHR_draco_mesh_compression";let w$4=class w{constructor(e){this.name=f$g,this.useNormalizedFlagFromAccessor=true,this._loader=e,this.enabled=y$8.DefaultAvailable&&this._loader.isExtensionUsed(f$g);}dispose(){delete this.dracoDecoder,this._loader=null;}_loadVertexDataAsync(e,t,o){return Re$2.LoadExtensionAsync(e,t,this.name,(async(s,a)=>{if(null!=t.mode&&4!==t.mode&&5!==t.mode)throw new Error(`${e}: Unsupported mode ${t.mode}`);const n={},i={},c=(e,r)=>{const s=a.attributes[e];if(null!=s&&(o._delayInfo=o._delayInfo||[],-1===o._delayInfo.indexOf(r)&&o._delayInfo.push(r),n[r]=s,this.useNormalizedFlagFromAccessor)){const o=Oe$2.TryGet(this._loader.gltf.accessors,t.attributes[e]);o&&(i[r]=o.normalized||false);}};c("POSITION",Hi.PositionKind),c("NORMAL",Hi.NormalKind),c("TANGENT",Hi.TangentKind),c("TEXCOORD_0",Hi.UVKind),c("TEXCOORD_1",Hi.UV2Kind),c("TEXCOORD_2",Hi.UV3Kind),c("TEXCOORD_3",Hi.UV4Kind),c("TEXCOORD_4",Hi.UV5Kind),c("TEXCOORD_5",Hi.UV6Kind),c("JOINTS_0",Hi.MatricesIndicesKind),c("WEIGHTS_0",Hi.MatricesWeightsKind),c("COLOR_0",Hi.ColorKind);const m=Oe$2.Get(s,this._loader.gltf.bufferViews,a.bufferView);return m._dracoBabylonGeometry||(m._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${m.index}`,m).then((async r=>{const s=this.dracoDecoder||y$8.Default,a=Oe$2.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),c=this._loader.parent.alwaysComputeBoundingBox||o.skeleton||!a?null:Ee$2(a);return await s._decodeMeshToGeometryForGltfAsync(o.name,this._loader.babylonScene,r,n,i,c).catch((t=>{throw new Error(`${e}: ${t.message}`)}))}))),await m._dracoBabylonGeometry}))}};fc(f$g),_c(f$g,true,(e=>new w$4(e)));var KHR_draco_mesh_compressionCTKUQAgQ_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_draco_mesh_compression:w$4});let c$b=class c{constructor(e){this.value=this._toInt(e);}_toInt(e){return 0|e}add(e){return new c(this.value+e.value)}subtract(e){return new c(this.value-e.value)}multiply(e){return new c(Math.imul(this.value,e.value))}divide(e){return new c(this.value/e.value)}getClassName(){return c.ClassName}equals(e){return this.value===e.value}static FromValue(e){return new c(e)}toString(){return this.value.toString()}};c$b.ClassName="FlowGraphInteger",P$9("FlowGraphInteger",c$b);let p$d=class p{constructor(e=[1,0,0,1]){this._m=e;}get m(){return this._m}transformVector(e){return this.transformVectorToRef(e,new ee$4)}transformVectorToRef(e,t){return t.x=e.x*this._m[0]+e.y*this._m[1],t.y=e.x*this._m[2]+e.y*this._m[3],t}asArray(){return this.toArray()}toArray(e=[]){for(let t=0;t<4;t++)e[t]=this._m[t];return e}fromArray(e){for(let t=0;t<4;t++)this._m[t]=e[t];return this}multiplyToRef(e,t){const a=e._m,o=this._m,n=t._m;return n[0]=a[0]*o[0]+a[1]*o[2],n[1]=a[0]*o[1]+a[1]*o[3],n[2]=a[2]*o[0]+a[3]*o[2],n[3]=a[2]*o[1]+a[3]*o[3],t}multiply(e){return this.multiplyToRef(e,new p)}divideToRef(e,t){const a=this._m,o=e._m,n=t._m;return n[0]=a[0]/o[0],n[1]=a[1]/o[1],n[2]=a[2]/o[2],n[3]=a[3]/o[3],t}divide(e){return this.divideToRef(e,new p)}addToRef(e,t){const a=this._m,o=e.m,n=t.m;return n[0]=a[0]+o[0],n[1]=a[1]+o[1],n[2]=a[2]+o[2],n[3]=a[3]+o[3],t}add(e){return this.addToRef(e,new p)}subtractToRef(e,t){const a=this._m,o=e.m,n=t.m;return n[0]=a[0]-o[0],n[1]=a[1]-o[1],n[2]=a[2]-o[2],n[3]=a[3]-o[3],t}subtract(e){return this.subtractToRef(e,new p)}transpose(){const e=this._m;return new p([e[0],e[2],e[1],e[3]])}determinant(){const e=this._m;return e[0]*e[3]-e[1]*e[2]}inverse(){const e=this.determinant();if(0===e)throw new Error("Matrix is not invertible");const t=this._m,a=1/e;return new p([t[3]*a,-t[1]*a,-t[2]*a,t[0]*a])}equals(e,t=0){const a=this._m,o=e.m;return 0===t?a[0]===o[0]&&a[1]===o[1]&&a[2]===o[2]&&a[3]===o[3]:Math.abs(a[0]-o[0])<t&&Math.abs(a[1]-o[1])<t&&Math.abs(a[2]-o[2])<t&&Math.abs(a[3]-o[3])<t}getClassName(){return "FlowGraphMatrix2D"}toString(){return `FlowGraphMatrix2D(${this._m.join(", ")})`}};let m$d=class m{constructor(e=[1,0,0,0,1,0,0,0,1]){this._m=e;}get m(){return this._m}transformVector(e){return this.transformVectorToRef(e,new te$4)}transformVectorToRef(e,t){const a=this._m;return t.x=e.x*a[0]+e.y*a[1]+e.z*a[2],t.y=e.x*a[3]+e.y*a[4]+e.z*a[5],t.z=e.x*a[6]+e.y*a[7]+e.z*a[8],t}multiplyToRef(e,t){const a=e._m,o=this._m,n=t.m;return n[0]=a[0]*o[0]+a[1]*o[3]+a[2]*o[6],n[1]=a[0]*o[1]+a[1]*o[4]+a[2]*o[7],n[2]=a[0]*o[2]+a[1]*o[5]+a[2]*o[8],n[3]=a[3]*o[0]+a[4]*o[3]+a[5]*o[6],n[4]=a[3]*o[1]+a[4]*o[4]+a[5]*o[7],n[5]=a[3]*o[2]+a[4]*o[5]+a[5]*o[8],n[6]=a[6]*o[0]+a[7]*o[3]+a[8]*o[6],n[7]=a[6]*o[1]+a[7]*o[4]+a[8]*o[7],n[8]=a[6]*o[2]+a[7]*o[5]+a[8]*o[8],t}multiply(e){return this.multiplyToRef(e,new m)}divideToRef(e,t){const a=this._m,o=e.m,n=t.m;return n[0]=a[0]/o[0],n[1]=a[1]/o[1],n[2]=a[2]/o[2],n[3]=a[3]/o[3],n[4]=a[4]/o[4],n[5]=a[5]/o[5],n[6]=a[6]/o[6],n[7]=a[7]/o[7],n[8]=a[8]/o[8],t}divide(e){return this.divideToRef(e,new m)}addToRef(e,t){const a=this._m,o=e.m,n=t.m;return n[0]=a[0]+o[0],n[1]=a[1]+o[1],n[2]=a[2]+o[2],n[3]=a[3]+o[3],n[4]=a[4]+o[4],n[5]=a[5]+o[5],n[6]=a[6]+o[6],n[7]=a[7]+o[7],n[8]=a[8]+o[8],t}add(e){return this.addToRef(e,new m)}subtractToRef(e,t){const a=this._m,o=e.m,n=t.m;return n[0]=a[0]-o[0],n[1]=a[1]-o[1],n[2]=a[2]-o[2],n[3]=a[3]-o[3],n[4]=a[4]-o[4],n[5]=a[5]-o[5],n[6]=a[6]-o[6],n[7]=a[7]-o[7],n[8]=a[8]-o[8],t}subtract(e){return this.subtractToRef(e,new m)}toArray(e=[]){for(let t=0;t<9;t++)e[t]=this._m[t];return e}asArray(){return this.toArray()}fromArray(e){for(let t=0;t<9;t++)this._m[t]=e[t];return this}transpose(){const e=this._m;return new m([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]])}determinant(){const e=this._m;return e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6])}inverse(){const e=this.determinant();if(0===e)throw new Error("Matrix is not invertible");const t=this._m,a=1/e;return new m([(t[4]*t[8]-t[5]*t[7])*a,(t[2]*t[7]-t[1]*t[8])*a,(t[1]*t[5]-t[2]*t[4])*a,(t[5]*t[6]-t[3]*t[8])*a,(t[0]*t[8]-t[2]*t[6])*a,(t[2]*t[3]-t[0]*t[5])*a,(t[3]*t[7]-t[4]*t[6])*a,(t[1]*t[6]-t[0]*t[7])*a,(t[0]*t[4]-t[1]*t[3])*a])}equals(e,t=0){const a=this._m,o=e.m;return 0===t?a[0]===o[0]&&a[1]===o[1]&&a[2]===o[2]&&a[3]===o[3]&&a[4]===o[4]&&a[5]===o[5]&&a[6]===o[6]&&a[7]===o[7]&&a[8]===o[8]:Math.abs(a[0]-o[0])<t&&Math.abs(a[1]-o[1])<t&&Math.abs(a[2]-o[2])<t&&Math.abs(a[3]-o[3])<t&&Math.abs(a[4]-o[4])<t&&Math.abs(a[5]-o[5])<t&&Math.abs(a[6]-o[6])<t&&Math.abs(a[7]-o[7])<t&&Math.abs(a[8]-o[8])<t}getClassName(){return "FlowGraphMatrix3D"}toString(){return `FlowGraphMatrix3D(${this._m.join(", ")})`}};var h$7;!function(e){e.Any="any",e.String="string",e.Number="number",e.Boolean="boolean",e.Object="object",e.Integer="FlowGraphInteger",e.Vector2="Vector2",e.Vector3="Vector3",e.Vector4="Vector4",e.Quaternion="Quaternion",e.Matrix="Matrix",e.Matrix2D="Matrix2D",e.Matrix3D="Matrix3D",e.Color3="Color3",e.Color4="Color4";}(h$7||(h$7={}));let f$f=class f{constructor(e,t,a=-1){this.typeName=e,this.defaultValue=t,this.animationType=a;}serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue;}};const b$b=new f$f("any",void 0),g$c=new f$f("string",""),w$3=new f$f("number",0,Qe$1.ANIMATIONTYPE_FLOAT),v$8=new f$f("boolean",false),k$5=new f$f("Vector2",ee$4.Zero(),Qe$1.ANIMATIONTYPE_VECTOR2),d$b=new f$f("Vector3",te$4.Zero(),Qe$1.ANIMATIONTYPE_VECTOR3),B$5=new f$f("Vector4",ie$5.Zero()),F$5=new f$f("Matrix",re$5.Identity(),Qe$1.ANIMATIONTYPE_MATRIX),y$7=new f$f("Matrix2D",new p$d),T$7=new f$f("Matrix3D",new m$d),G$2=new f$f("Color3",ge$3.Black(),Qe$1.ANIMATIONTYPE_COLOR3),x$9=new f$f("Color4",new me$3(0,0,0,0),Qe$1.ANIMATIONTYPE_COLOR4),I$9=new f$f("Quaternion",se$5.Identity(),Qe$1.ANIMATIONTYPE_QUATERNION);I$9.typeTransformer=e=>{if(e.getClassName){if("Vector4"===e.getClassName())return se$5.FromArray(e.asArray());if("Vector3"===e.getClassName())return se$5.FromEulerVector(e);if("Matrix"===e.getClassName())return se$5.FromRotationMatrix(e)}return e};const _$b=new f$f("FlowGraphInteger",new c$b(0),Qe$1.ANIMATIONTYPE_FLOAT);function A$9(e){const t=e;switch(typeof e){case "string":return g$c;case "number":return w$3;case "boolean":return v$8;case "object":if(t.getClassName)switch(t.getClassName()){case "Vector2":return k$5;case "Vector3":return d$b;case "Vector4":return B$5;case "Matrix":return F$5;case "Color3":return G$2;case "Color4":return x$9;case "Quaternion":return I$9;case "FlowGraphInteger":return _$b;case "Matrix2D":return y$7;case "Matrix3D":return T$7}return b$b;default:return b$b}}function V$7(e){switch(e){case "string":return g$c;case "number":return w$3;case "boolean":return v$8;case "Vector2":return k$5;case "Vector3":return d$b;case "Vector4":return B$5;case "Matrix":return F$5;case "Color3":return G$2;case "Color4":return x$9;case "Quaternion":return I$9;case "FlowGraphInteger":return _$b;case "Matrix2D":return y$7;case "Matrix3D":return T$7;default:return b$b}}function P$5(e){switch(e){case Qe$1.ANIMATIONTYPE_FLOAT:return w$3;case Qe$1.ANIMATIONTYPE_VECTOR2:return k$5;case Qe$1.ANIMATIONTYPE_VECTOR3:return d$b;case Qe$1.ANIMATIONTYPE_MATRIX:return F$5;case Qe$1.ANIMATIONTYPE_COLOR3:return G$2;case Qe$1.ANIMATIONTYPE_COLOR4:return x$9;case Qe$1.ANIMATIONTYPE_QUATERNION:return I$9;default:return b$b}}function N$6(e){const[t,a]=e.split(":");return M$9({op:t,extension:a})}function M$9(e,t=true){const a=e.extension?C$8[e.extension]?.[e.op]:O$b[e.op];if(!a&&(Ie$2.Warn(`No mapping found for operation ${e.op} and extension ${e.extension||"KHR_interactivity"}`),t)){const t={},a={flows:{}};if(e.inputValueSockets){t.values={};for(const a in e.inputValueSockets)t.values[a]={name:a};}return e.outputValueSockets&&(a.values={},Object.keys(e.outputValueSockets).forEach((e=>{a.values[e]={name:e};}))),{blocks:[],inputs:t,outputs:a}}return a}function E$c(e,t,a){C$8[t]||={},C$8[t][e]=a;}const C$8={BABYLON:{"flow/log":{blocks:["FlowGraphConsoleLogBlock"],inputs:{values:{message:{name:"message"}}}}}},O$b={"event/onStart":{blocks:["FlowGraphSceneReadyEventBlock"],outputs:{flows:{out:{name:"done"}}}},"event/onTick":{blocks:["FlowGraphSceneTickEventBlock"],inputs:{},outputs:{values:{timeSinceLastTick:{name:"deltaTime",gltfType:"number"}},flows:{out:{name:"done"}}}},"event/send":{blocks:["FlowGraphSendCustomEventBlock"],extraProcessor(e,t,a,o,n){if("event/send"!==t.op||!e.configuration||1!==Object.keys(e.configuration).length)throw new Error("Receive event should have a single configuration object, the event itself");const r=e.configuration.event.value[0];if("number"!=typeof r)throw new Error("Event id should be a number");const l=o.arrays.events[r],u=n[0];return u.config||={},u.config.eventId=l.eventId,u.config.eventData=l.eventData,n}},"event/receive":{blocks:["FlowGraphReceiveCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},validation(e,t){if(!e.configuration)return Ie$2.Error("Receive event should have a configuration object"),{valid:false,error:"Receive event should have a configuration object"};const a=e.configuration.event;if(!a)return Ie$2.Error("Receive event should have a single configuration object, the event itself"),{valid:false,error:"Receive event should have a single configuration object, the event itself"};const o=a.value[0];if("number"!=typeof o)return Ie$2.Error("Event id should be a number"),{valid:false,error:"Event id should be a number"};const n=t.events?.[o];return n?{valid:true}:(Ie$2.Error(`Event with id ${o} not found`),{valid:false,error:`Event with id ${o} not found`})},extraProcessor(e,t,a,o,n){if("event/receive"!==t.op||!e.configuration||1!==Object.keys(e.configuration).length)throw new Error("Receive event should have a single configuration object, the event itself");const r=e.configuration.event.value[0];if("number"!=typeof r)throw new Error("Event id should be a number");const l=o.arrays.events[r],u=n[0];return u.config||={},u.config.eventId=l.eventId,u.config.eventData=l.eventData,n}},"math/E":R$9("FlowGraphEBlock"),"math/Pi":R$9("FlowGraphPIBlock"),"math/Inf":R$9("FlowGraphInfBlock"),"math/NaN":R$9("FlowGraphNaNBlock"),"math/abs":R$9("FlowGraphAbsBlock"),"math/sign":R$9("FlowGraphSignBlock"),"math/trunc":R$9("FlowGraphTruncBlock"),"math/floor":R$9("FlowGraphFloorBlock"),"math/ceil":R$9("FlowGraphCeilBlock"),"math/round":{blocks:["FlowGraphRoundBlock"],configuration:{},inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor:(e,t,a,o,n)=>(n[0].config||={},n[0].config.roundHalfAwayFromZero=true,n)},"math/fract":R$9("FlowGraphFractBlock"),"math/neg":R$9("FlowGraphNegationBlock"),"math/add":R$9("FlowGraphAddBlock",["a","b"],true),"math/sub":R$9("FlowGraphSubtractBlock",["a","b"],true),"math/mul":{blocks:["FlowGraphMultiplyBlock"],extraProcessor(e,t,a,o,n){n[0].config||={},n[0].config.useMatrixPerComponent=true,n[0].config.preventIntegerFloatArithmetic=true;let r=-1;return Object.keys(e.values||{}).find((t=>void 0!==e.values?.[t].type&&(r=e.values[t].type,true))),-1!==r&&(n[0].config.type=o.arrays.types[r].flowGraphType),n},validation:e=>e.values?D$7(e):{valid:true}},"math/div":R$9("FlowGraphDivideBlock",["a","b"],true),"math/rem":R$9("FlowGraphModuloBlock",["a","b"]),"math/min":R$9("FlowGraphMinBlock",["a","b"]),"math/max":R$9("FlowGraphMaxBlock",["a","b"]),"math/clamp":R$9("FlowGraphClampBlock",["a","b","c"]),"math/saturate":R$9("FlowGraphSaturateBlock"),"math/mix":R$9("FlowGraphMathInterpolationBlock",["a","b","c"]),"math/eq":R$9("FlowGraphEqualityBlock",["a","b"]),"math/lt":R$9("FlowGraphLessThanBlock",["a","b"]),"math/le":R$9("FlowGraphLessThanOrEqualBlock",["a","b"]),"math/gt":R$9("FlowGraphGreaterThanBlock",["a","b"]),"math/ge":R$9("FlowGraphGreaterThanOrEqualBlock",["a","b"]),"math/isNaN":R$9("FlowGraphIsNaNBlock"),"math/isInf":R$9("FlowGraphIsInfBlock"),"math/select":{blocks:["FlowGraphConditionalBlock"],inputs:{values:{condition:{name:"condition"},a:{name:"onTrue"},b:{name:"onFalse"}}},outputs:{values:{value:{name:"output"}}}},"math/random":{blocks:["FlowGraphRandomBlock"],outputs:{values:{value:{name:"value"}}}},"math/sin":R$9("FlowGraphSinBlock"),"math/cos":R$9("FlowGraphCosBlock"),"math/tan":R$9("FlowGraphTanBlock"),"math/asin":R$9("FlowGraphASinBlock"),"math/acos":R$9("FlowGraphACosBlock"),"math/atan":R$9("FlowGraphATanBlock"),"math/atan2":R$9("FlowGraphATan2Block",["a","b"]),"math/sinh":R$9("FlowGraphSinhBlock"),"math/cosh":R$9("FlowGraphCoshBlock"),"math/tanh":R$9("FlowGraphTanhBlock"),"math/asinh":R$9("FlowGraphASinhBlock"),"math/acosh":R$9("FlowGraphACoshBlock"),"math/atanh":R$9("FlowGraphATanhBlock"),"math/exp":R$9("FlowGraphExponentialBlock"),"math/log":R$9("FlowGraphLogBlock"),"math/log2":R$9("FlowGraphLog2Block"),"math/log10":R$9("FlowGraphLog10Block"),"math/sqrt":R$9("FlowGraphSquareRootBlock"),"math/cbrt":R$9("FlowGraphCubeRootBlock"),"math/pow":R$9("FlowGraphPowerBlock",["a","b"]),"math/length":R$9("FlowGraphLengthBlock"),"math/normalize":R$9("FlowGraphNormalizeBlock"),"math/dot":R$9("FlowGraphDotBlock",["a","b"]),"math/cross":R$9("FlowGraphCrossBlock",["a","b"]),"math/rotate2D":{blocks:["FlowGraphRotate2DBlock"],inputs:{values:{a:{name:"a"},angle:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/rotate3D":{blocks:["FlowGraphRotate3DBlock"],inputs:{values:{a:{name:"a"},rotation:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/transform":{blocks:["FlowGraphTransformVectorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/combine2":{blocks:["FlowGraphCombineVector2Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine3":{blocks:["FlowGraphCombineVector3Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine4":{blocks:["FlowGraphCombineVector4Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/extract2":{blocks:["FlowGraphExtractVector2Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"}}}},"math/extract3":{blocks:["FlowGraphExtractVector3Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"}}}},"math/extract4":{blocks:["FlowGraphExtractVector4Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/transpose":R$9("FlowGraphTransposeBlock"),"math/determinant":R$9("FlowGraphDeterminantBlock"),"math/inverse":R$9("FlowGraphInvertMatrixBlock"),"math/matMul":R$9("FlowGraphMatrixMultiplicationBlock",["a","b"]),"math/matCompose":{blocks:["FlowGraphMatrixCompose"],inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,a,o,n,r){const l=n[0].dataInputs.find((e=>"rotationQuaternion"===e.name));if(!l)throw new Error("Rotation quaternion input not found");return r._connectionValues[l.uniqueId]&&(r._connectionValues[l.uniqueId].type="Quaternion"),n}},"math/matDecompose":{blocks:["FlowGraphMatrixDecompose"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/quatConjugate":R$9("FlowGraphConjugateBlock",["a"]),"math/quatMul":{blocks:["FlowGraphMultiplyBlock"],inputs:{values:{a:{name:"a",gltfType:"vector4"},b:{name:"b",gltfType:"vector4"}}},outputs:{values:{value:{name:"value"}}},extraProcessor:(e,t,a,o,n)=>(n[0].config||={},n[0].config.type="Quaternion",n)},"math/quatAngleBetween":R$9("FlowGraphAngleBetweenBlock",["a","b"]),"math/quatFromAxisAngle":{blocks:["FlowGraphQuaternionFromAxisAngleBlock"],inputs:{values:{axis:{name:"a",gltfType:"float3"},angle:{name:"b",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/quatToAxisAngle":R$9("FlowGraphAxisAngleFromQuaternionBlock",["a"]),"math/quatFromDirections":R$9("FlowGraphQuaternionFromDirectionsBlock",["a","b"]),"math/combine2x2":{blocks:["FlowGraphCombineMatrix2DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor:(e,t,a,o,n)=>(n[0].config||={},n[0].config.inputIsColumnMajor=true,n)},"math/extract2x2":{blocks:["FlowGraphExtractMatrix2DBlock"],inputs:{values:{a:{name:"input",gltfType:"float2x2"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/combine3x3":{blocks:["FlowGraphCombineMatrix3DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor:(e,t,a,o,n)=>(n[0].config||={},n[0].config.inputIsColumnMajor=true,n)},"math/extract3x3":{blocks:["FlowGraphExtractMatrix3DBlock"],inputs:{values:{a:{name:"input",gltfType:"float3x3"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"}}}},"math/combine4x4":{blocks:["FlowGraphCombineMatrixBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"},j:{name:"input_9",gltfType:"number"},k:{name:"input_10",gltfType:"number"},l:{name:"input_11",gltfType:"number"},m:{name:"input_12",gltfType:"number"},n:{name:"input_13",gltfType:"number"},o:{name:"input_14",gltfType:"number"},p:{name:"input_15",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor:(e,t,a,o,n)=>(n[0].config||={},n[0].config.inputIsColumnMajor=true,n)},"math/extract4x4":{blocks:["FlowGraphExtractMatrixBlock"],configuration:{},inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"},9:{name:"output_9"},10:{name:"output_10"},11:{name:"output_11"},12:{name:"output_12"},13:{name:"output_13"},14:{name:"output_14"},15:{name:"output_15"}}}},"math/not":{blocks:["FlowGraphBitwiseNotBlock"],inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,a,o,n,r){n[0].config||={};const l=n[0].dataInputs[0];return n[0].config.valueType=r._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",n}},"math/and":{blocks:["FlowGraphBitwiseAndBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,a,o,n,r){n[0].config||={};const l=n[0].dataInputs[0],u=n[0].dataInputs[1];return n[0].config.valueType=r._connectionValues[l.uniqueId]?.type??r._connectionValues[u.uniqueId]?.type??"FlowGraphInteger",n}},"math/or":{blocks:["FlowGraphBitwiseOrBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,a,o,n,r){n[0].config||={};const l=n[0].dataInputs[0],u=n[0].dataInputs[1];return n[0].config.valueType=r._connectionValues[l.uniqueId]?.type??r._connectionValues[u.uniqueId]?.type??"FlowGraphInteger",n}},"math/xor":{blocks:["FlowGraphBitwiseXorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,a,o,n,r){n[0].config||={};const l=n[0].dataInputs[0],u=n[0].dataInputs[1];return n[0].config.valueType=r._connectionValues[l.uniqueId]?.type??r._connectionValues[u.uniqueId]?.type??"FlowGraphInteger",n}},"math/asr":R$9("FlowGraphBitwiseRightShiftBlock",["a","b"]),"math/lsl":R$9("FlowGraphBitwiseLeftShiftBlock",["a","b"]),"math/clz":R$9("FlowGraphLeadingZerosBlock"),"math/ctz":R$9("FlowGraphTrailingZerosBlock"),"math/popcnt":R$9("FlowGraphOneBitsCounterBlock"),"math/rad":R$9("FlowGraphDegToRadBlock"),"math/deg":R$9("FlowGraphRadToDegBlock"),"type/boolToInt":R$9("FlowGraphBooleanToInt"),"type/boolToFloat":R$9("FlowGraphBooleanToFloat"),"type/intToBool":R$9("FlowGraphIntToBoolean"),"type/intToFloat":R$9("FlowGraphIntToFloat"),"type/floatToInt":R$9("FlowGraphFloatToInt"),"type/floatToBool":R$9("FlowGraphFloatToBoolean"),"flow/sequence":{blocks:["FlowGraphSequenceBlock"],extraProcessor(e,t,a,o,n){const r=n[0];return r.config||={},r.config.outputSignalCount=Object.keys(e.flows||[]).length,r.signalOutputs.forEach(((e,t)=>{e.name="out_"+t;})),n}},"flow/branch":{blocks:["FlowGraphBranchBlock"],outputs:{flows:{true:{name:"onTrue"},false:{name:"onFalse"}}}},"flow/switch":{blocks:["FlowGraphSwitchBlock"],configuration:{cases:{name:"cases",inOptions:true,defaultValue:[]}},inputs:{values:{selection:{name:"case"},default:{name:"default"}}},validation(e){if(e.configuration&&e.configuration.cases){const t=e.configuration.cases.value;if(!t.every((e=>"number"==typeof e&&/^-?\d+$/.test(e.toString()))))return Ie$2.Warn("Switch cases should be integers. Using empty array instead."),e.configuration.cases.value=[],{valid:true};const a=new Set(t);e.configuration.cases.value=Array.from(a);}return {valid:true}},extraProcessor(e,t,a,o,n){if("flow/switch"!==t.op||!e.flows||0===Object.keys(e.flows).length)throw new Error("Switch should have a single configuration object, the cases array");return n[0].signalOutputs.forEach((e=>{"default"!==e.name&&(e.name="out_"+e.name);})),n}},"flow/while":{blocks:["FlowGraphWhileLoopBlock"],outputs:{flows:{loopBody:{name:"executionFlow"}}}},"flow/for":{blocks:["FlowGraphForLoopBlock"],configuration:{initialIndex:{name:"initialIndex",gltfType:"number",inOptions:true,defaultValue:0}},inputs:{values:{startIndex:{name:"startIndex",gltfType:"number"},endIndex:{name:"endIndex",gltfType:"number"}}},outputs:{values:{index:{name:"index"}},flows:{loopBody:{name:"executionFlow"}}},extraProcessor(e,t,a,o,n){const r=n[0];return r.config||={},r.config.incrementIndexWhenLoopDone=true,n}},"flow/doN":{blocks:["FlowGraphDoNBlock"],configuration:{},inputs:{values:{n:{name:"maxExecutions",gltfType:"number"}}},outputs:{values:{currentCount:{name:"executionCount"}}}},"flow/multiGate":{blocks:["FlowGraphMultiGateBlock"],configuration:{isRandom:{name:"isRandom",gltfType:"boolean",inOptions:true,defaultValue:false},isLoop:{name:"isLoop",gltfType:"boolean",inOptions:true,defaultValue:false}},extraProcessor(e,t,a,o,n){if("flow/multiGate"!==t.op||!e.flows||0===Object.keys(e.flows).length)throw new Error("MultiGate should have a single configuration object, the number of output flows");const r=n[0];return r.config||={},r.config.outputSignalCount=Object.keys(e.flows).length,r.signalOutputs.forEach(((e,t)=>{e.name="out_"+t;})),n}},"flow/waitAll":{blocks:["FlowGraphWaitAllBlock"],configuration:{inputFlows:{name:"inputSignalCount",gltfType:"number",inOptions:true,defaultValue:0}},inputs:{flows:{reset:{name:"reset"},"[segment]":{name:"in_$1"}}},validation:e=>("number"!=typeof e.configuration?.inputFlows?.value[0]&&(e.configuration=e.configuration||{inputFlows:{value:[0]}},e.configuration.inputFlows.value=[0]),{valid:true})},"flow/throttle":{blocks:["FlowGraphThrottleBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/setDelay":{blocks:["FlowGraphSetDelayBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/cancelDelay":{blocks:["FlowGraphCancelDelayBlock"]},"variable/get":{blocks:["FlowGraphGetVariableBlock"],validation:e=>e.configuration?.variable?.value?{valid:true}:(Ie$2.Error("Variable get block should have a variable configuration"),{valid:false,error:"Variable get block should have a variable configuration"}),configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:true,isVariable:true,dataTransformer:(e,t)=>[t.getVariableName(e[0])]}}},"variable/set":{blocks:["FlowGraphSetVariableBlock"],configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:true,isVariable:true,dataTransformer:(e,t)=>[t.getVariableName(e[0])]}}},"variable/setMultiple":{blocks:["FlowGraphSetVariableBlock"],configuration:{variables:{name:"variables",gltfType:"number",flowGraphType:"string",inOptions:true,dataTransformer:(e,t)=>[e[0].map((e=>t.getVariableName(e)))]}},extraProcessor:(e,t,a,o,n)=>(n[0].dataInputs.forEach((e=>{e.name=o.getVariableName(+e.name);})),n)},"variable/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphContextBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing","FlowGraphGetVariableBlock"],configuration:{variable:{name:"propertyName",inOptions:true,isVariable:true,dataTransformer:(e,t)=>[t.getVariableName(e[0])]},useSlerp:{name:"animationType",inOptions:true,defaultValue:false,dataTransformer:e=>true===e[0]?["Quaternion"]:[void 0]}},inputs:{values:{value:{name:"value_1"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"userVariables",inputBlockIndex:2,outputBlockIndex:1,isVariable:true},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:true},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:true},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:4,isVariable:true}],extraProcessor(e,t,a,n,r){const l=r[0],u=e.configuration?.variable.value[0];if("number"!=typeof u)throw Ie$2.Error("Variable index is not defined for variable interpolation block"),new Error("Variable index is not defined for variable interpolation block");const i=n.arrays.staticVariables[u];void 0===l.config.animationType.value&&(n.arrays.staticVariables,l.config.animationType.value=function(e){switch(e){case "number":default:return Qe$1.ANIMATIONTYPE_FLOAT;case "Vector2":return Qe$1.ANIMATIONTYPE_VECTOR2;case "Vector3":return Qe$1.ANIMATIONTYPE_VECTOR3;case "Matrix":return Qe$1.ANIMATIONTYPE_MATRIX;case "Color3":return Qe$1.ANIMATIONTYPE_COLOR3;case "Color4":return Qe$1.ANIMATIONTYPE_COLOR4;case "Quaternion":return Qe$1.ANIMATIONTYPE_QUATERNION}}(i.type));const c=r[4];return c.config||={},c.config.variable||={},c.config.variable.value=n.getVariableName(u),r[3].config||={},r}},"pointer/get":{blocks:["FlowGraphGetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"customGetFunction",output:"getFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:true}],extraProcessor:(e,t,a,o,n)=>(n.forEach((e=>{"FlowGraphJsonPointerParserBlock"===e.className&&(e.config||={},e.config.outputValue=true);})),n)},"pointer/set":{blocks:["FlowGraphSetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"customSetFunction",output:"setFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:true}],extraProcessor:(e,t,a,o,n)=>(n.forEach((e=>{"FlowGraphJsonPointerParserBlock"===e.className&&(e.config||={},e.config.outputValue=true);})),n)},"pointer/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphJsonPointerParserBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value_1"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:2,outputBlockIndex:1,isVariable:true},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"customBuildAnimation",output:"generateAnimationsFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:true},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:true},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:true}],extraProcessor:(e,t,a,o,n)=>(n.forEach((t=>{"FlowGraphJsonPointerParserBlock"===t.className?(t.config||={},t.config.outputValue=true):"FlowGraphInterpolationBlock"===t.className&&(t.config||={},Object.keys(e.values||[]).forEach((a=>{const n=e.values?.[a];if("value"===a&&n){const e=n.type;void 0!==e&&(t.config.animationType=o.arrays.types[e].flowGraphType);}})));})),n)},"animation/start":{blocks:["FlowGraphPlayAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},speed:{name:"speed",gltfType:"number"},startTime:{name:"from",gltfType:"number",dataTransformer:(e,t)=>[e[0]*t._animationTargetFps]},endTime:{name:"to",gltfType:"number",dataTransformer:(e,t)=>[e[0]*t._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:true}],extraProcessor(e,t,a,o,n,r,l){const u=n[n.length-1];return u.config||={},u.config.glTF=l,n}},"animation/stop":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:true}],extraProcessor(e,t,a,o,n,r,l){const u=n[n.length-1];return u.config||={},u.config.glTF=l,n}},"animation/stopAt":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{},inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},stopTime:{name:"stopAtFrame",gltfType:"number",dataTransformer:(e,t)=>[e[0]*t._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:true}],extraProcessor(e,t,a,o,n,r,l){const u=n[n.length-1];return u.config||={},u.config.glTF=l,n}},"math/switch":{blocks:["FlowGraphDataSwitchBlock"],configuration:{cases:{name:"cases",inOptions:true,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(e){if(e.configuration&&e.configuration.cases){const t=e.configuration.cases.value;if(!t.every((e=>"number"==typeof e&&/^-?\d+$/.test(e.toString()))))return Ie$2.Warn("Switch cases should be integers. Using empty array instead."),e.configuration.cases.value=[],{valid:true};const a=new Set(t);e.configuration.cases.value=Array.from(a);}return {valid:true}},extraProcessor(e,t,a,o,n){const r=n[0];return r.dataInputs.forEach((e=>{"default"!==e.name&&"case"!==e.name&&(e.name="in_"+e.name);})),r.config||={},r.config.treatCasesAsIntegers=true,n}},"debug/log":{blocks:["FlowGraphConsoleLogBlock"],configuration:{message:{name:"messageTemplate",inOptions:true}}}};function R$9(e,t=["a"],a){return {blocks:[e],inputs:{values:t.reduce(((e,t)=>(e[t]={name:t},e)),{})},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,o,n,r){if(a){r[0].config||={},r[0].config.preventIntegerFloatArithmetic=true;let t=-1;Object.keys(e.values||{}).find((a=>void 0!==e.values?.[a].type&&(t=e.values[a].type,true))),-1!==t&&(r[0].config.type=n.arrays.types[t].flowGraphType);}return r},validation:e=>a?D$7(e):{valid:true}}}function D$7(e){if(e.values){const t=Object.keys(e.values).map((t=>e.values[t].type)).filter((e=>void 0!==e));if(!t.every((e=>e===t[0])))return {valid:false,error:"All inputs must be of the same type"}}return {valid:true}}function b$a(e){return "Vector2"===e||"Vector3"===e||"Vector4"===e||"Quaternion"===e||"Color3"===e||"Color4"===e}function v$7(e,t,o){const a=t?.getClassName?.()??"";if(b$a(a)||function(e){return "Matrix"===e||"Matrix2D"===e||"Matrix3D"===e}(a))o[e]={value:t.asArray(),className:a};else if("FlowGraphInteger"===a)o[e]={value:t.value,className:a};else if(a&&(t.id||t.name))o[e]={id:t.id,name:t.name,className:a};else {if("object"==typeof t)throw new Error(`Could not serialize value ${t}`);o[e]=t;}}function C$7(i,l,c,h){const p=l[i];let u;const m=p?.type??p?.className;if(function(e){return "Mesh"===e||"AbstractMesh"===e||"GroundMesh"===e||"InstanceMesh"===e||"LinesMesh"===e||"GoldbergMesh"===e||"GreasedLineMesh"===e||"TrailMesh"===e}(m)){let e=h.meshes.filter((e=>p.id?e.id===p.id:e.name===p.name));0===e.length&&(e=h.transformNodes.filter((e=>p.id?e.id===p.id:e.name===p.name))),u=p.uniqueId?e.find((e=>e.uniqueId===p.uniqueId)):e[0];}else if(b$a(m))u=function(e,i,l=false){if("Vector2"===e)return ee$4.FromArray(i);if("Vector3"===e)return l&&(i[2]*=-1),te$4.FromArray(i);if("Vector4"===e)return ie$5.FromArray(i);if("Quaternion"===e)return l&&(i[2]*=-1,i[3]*=-1),se$5.FromArray(i);if("Color3"===e)return new ge$3(i[0],i[1],i[2]);if("Color4"===e)return new me$3(i[0],i[1],i[2],i[3]);throw new Error(`Unknown vector class name ${e}`)}(m,p.value);else if(function(e){return "AnimationGroup"===e}(m)){const e=h.animationGroups.filter((e=>e.name===p.name));u=1===e.length?e[0]:e.find((e=>e.uniqueId===p.uniqueId));}else u="Matrix"===m?re$5.FromArray(p.value):"Matrix2D"===m?new p$d(p.value):"Matrix3D"===m?new m$d(p.value):"FlowGraphInteger"===m?c$b.FromValue(p.value):"number"===m||"string"===m||"boolean"===m?p.value[0]:p&&void 0!==p.value?p.value:Array.isArray(p)?p.reduce(((e,t)=>t.eventData?(e[t.id]={type:V$7(t.type)},void 0!==t.value&&(e[t.id].value=C$7("value",t,c,h)),e):e),{}):p;return u}var x$8,I$8,E$b,T$6;function M$8(e,t,o,a){switch(t){case "Animation":return a?e.animations.find((e=>e.uniqueId===o))??null:e.animations[o]??null;case "AnimationGroup":return a?e.animationGroups.find((e=>e.uniqueId===o))??null:e.animationGroups[o]??null;case "Mesh":return a?e.meshes.find((e=>e.uniqueId===o))??null:e.meshes[o]??null;case "Material":return a?e.materials.find((e=>e.uniqueId===o))??null:e.materials[o]??null;case "Camera":return a?e.cameras.find((e=>e.uniqueId===o))??null:e.cameras[o]??null;case "Light":return a?e.lights.find((e=>e.uniqueId===o))??null:e.lights[o]??null;default:return null}}!function(e){e.Animation="Animation",e.AnimationGroup="AnimationGroup",e.Mesh="Mesh",e.Material="Material",e.Camera="Camera",e.Light="Light";}(x$8||(x$8={})),function(e){e.ExecuteBlock="ExecuteBlock",e.ExecuteEvent="ExecuteEvent",e.TriggerConnection="TriggerConnection",e.ContextVariableSet="ContextVariableSet",e.GlobalVariableSet="GlobalVariableSet",e.GlobalVariableDelete="GlobalVariableDelete",e.GlobalVariableGet="GlobalVariableGet",e.AddConnection="AddConnection",e.GetConnectionValue="GetConnectionValue",e.SetConnectionValue="SetConnectionValue",e.ActivateSignal="ActivateSignal",e.ContextVariableGet="ContextVariableGet";}(I$8||(I$8={}));let V$6=class V{constructor(){this.logToConsole=false,this.log=[];}addLogItem(e){if(e.time||(e.time=Date.now()),this.log.push(e),this.logToConsole){const t=e.payload?.value;"object"==typeof t&&t.getClassName?Ie$2.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(t.getClassName())}: ${t.toString()}`):Ie$2.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(e.payload)}`);}}getItemsOfType(e){return this.log.filter((t=>t.action===e))}};let O$a=class O{get enableLogging(){return this._enableLogging}set enableLogging(e){this._enableLogging!==e&&(this._enableLogging=e,this._enableLogging?(this.logger=new V$6,this.logger.logToConsole=true):this.logger=null);}constructor(e){this.uniqueId=_i(),this._userVariables={},this._executionVariables={},this._globalContextVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new R$g,this.treatDataAsRightHanded=false,this._enableLogging=false,this._configuration=e,this.assetsContext=e.assetsContext??e.scene;}hasVariable(e){return e in this._userVariables}setVariable(e,t){this._userVariables[e]=t,this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableSet",payload:{name:e,value:t}});}getAsset(e,t){return M$8(this.assetsContext,e,t)}getVariable(e){return this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableGet",payload:{name:e,value:this._userVariables[e]}}),this._userVariables[e]}get userVariables(){return this._userVariables}getScene(){return this._configuration.scene}_getUniqueIdPrefixedName(e,t){return `${e.uniqueId}_${t}`}_getGlobalContextVariable(e,t){return this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableGet",payload:{name:e,defaultValue:t,possibleValue:this._globalContextVariables[e]}}),this._hasGlobalContextVariable(e)?this._globalContextVariables[e]:t}_setGlobalContextVariable(e,t){this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableSet",payload:{name:e,value:t}}),this._globalContextVariables[e]=t;}_deleteGlobalContextVariable(e){this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableDelete",payload:{name:e}}),delete this._globalContextVariables[e];}_hasGlobalContextVariable(e){return e in this._globalContextVariables}_setExecutionVariable(e,t,o){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=o;}_getExecutionVariable(e,t,o){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:o}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)];}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){this._connectionValues[e.uniqueId]=t,this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"SetConnectionValue",payload:{connectionPointId:e.uniqueId,value:t}});}_setConnectionValueByKey(e,t){this._connectionValues[e]=t;}_getConnectionValue(e){return this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GetConnectionValue",payload:{connectionPointId:e.uniqueId,value:this._connectionValues[e.uniqueId]}}),this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}get hasPendingBlocks(){return this._pendingBlocks.length>0}_addPendingBlock(e){this._pendingBlocks.includes(e)||(this._pendingBlocks.push(e),this._pendingBlocks.sort(((e,t)=>e.priority-t.priority)));}_removePendingBlock(e){const t=this._pendingBlocks.indexOf(e);-1!==t&&this._pendingBlocks.splice(t,1);}_clearPendingBlocks(){for(const e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0;}_notifyExecuteNode(e){this.onNodeExecutedObservable.notifyObservers(e),this.logger?.addLogItem({time:Date.now(),className:e.getClassName(),uniqueId:e.uniqueId,action:"ExecuteBlock"});}_notifyOnTick(e){this._setGlobalContextVariable("timeSinceStart",e.timeSinceStart),this._setGlobalContextVariable("deltaTime",e.deltaTime);for(const e of this._pendingBlocks)e._executeOnTick?.(this);}_increaseExecutionId(){this._executionId++;}get executionId(){return this._executionId}serialize(e={},t=v$7){e.uniqueId=this.uniqueId,e._userVariables={};for(const o in this._userVariables)t(o,this._userVariables[o],e._userVariables);e._connectionValues={};for(const o in this._connectionValues)t(o,this._connectionValues[o],e._connectionValues);this.assetsContext!==this.getScene()&&(e._assetsContext={meshes:this.assetsContext.meshes.map((e=>e.id)),materials:this.assetsContext.materials.map((e=>e.id)),textures:this.assetsContext.textures.map((e=>e.name)),animations:this.assetsContext.animations.map((e=>e.name)),lights:this.assetsContext.lights.map((e=>e.id)),cameras:this.assetsContext.cameras.map((e=>e.id)),sounds:this.assetsContext.sounds?.map((e=>e.name)),skeletons:this.assetsContext.skeletons.map((e=>e.id)),particleSystems:this.assetsContext.particleSystems.map((e=>e.name)),geometries:this.assetsContext.geometries.map((e=>e.id)),multiMaterials:this.assetsContext.multiMaterials.map((e=>e.id)),transformNodes:this.assetsContext.transformNodes.map((e=>e.id))});}getClassName(){return "FlowGraphContext"}};e$z([a$$()],O$a.prototype,"uniqueId",void 0),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output";}(E$b||(E$b={}));let N$5=class N{constructor(e,t,o){this._ownerBlock=o,this._connectedPoint=[],this.uniqueId=_i(),this.connectedPointIds=[],this.name=e,this._connectionType=t;}get connectionType(){return this._connectionType}_isSingularConnection(){return  true}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw new Error(`Cannot connect two points of type ${this.connectionType}`);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw new Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this);}disconnectFrom(e,t=true){const o=this._connectedPoint.indexOf(e),a=e._connectedPoint.indexOf(this);-1!==o&&-1!==a&&(t&&this._connectedPoint.splice(o,1),e._connectedPoint.splice(a,1));}disconnectFromAll(){for(const e of this._connectedPoint)this.disconnectFrom(e,false);this._connectedPoint.length=0;}dispose(){for(const e of this._connectedPoint)this.disconnectFrom(e);}serialize(e={}){e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName();for(const t of this._connectedPoint)e.connectedPointIds.push(t.uniqueId);}getClassName(){return "FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds;}};let j$3=class j extends N$5{constructor(e,t,o,a,n=a.defaultValue,s=false){super(e,t,o),this.richType=a,this._defaultValue=n,this._optional=s,this._isDisabled=false,this._lastValue=null,this.dataTransformer=null,this.onValueChangedObservable=new R$g;}get optional(){return this._optional}get isDisabled(){return this._isDisabled}set isDisabled(e){this._isDisabled!==e&&(this._isDisabled=e,this._isDisabled&&this.disconnectFromAll());}_isSingularConnection(){return 0===this.connectionType}setValue(e,t){t._getConnectionValue(this)!==e&&(t._setConnectionValue(this,e),this.onValueChangedObservable.notifyObservers(e));}resetToDefaultValue(e){e._setConnectionValue(this,this._defaultValue);}connectTo(e){this._isDisabled||super.connectTo(e);}_getValueOrDefault(e){const t=e._getConnectionValue(this)??this._defaultValue;return this.dataTransformer?this.dataTransformer(t):t}getValue(e){if(1===this.connectionType){e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e);const t=this._getValueOrDefault(e);return this._lastValue=t,this.richType.typeTransformer?this.richType.typeTransformer(t):t}const t=this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e);return this._lastValue=t,this.richType.typeTransformer?this.richType.typeTransformer(t):t}_getLastValue(){return this._lastValue}getClassName(){return "FlowGraphDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType),e.optional=this._optional,v$7("defaultValue",this._defaultValue,e);}};P$9("FlowGraphDataConnection",j$3);let S$7=class S{constructor(e){this.config=e,this.uniqueId=_i(),this.name=this.config?.name??this.getClassName(),this.dataInputs=[],this.dataOutputs=[];}_updateOutputs(e){}registerDataInput(e,t,o){const a=new j$3(e,0,this,t,o);return this.dataInputs.push(a),a}registerDataOutput(e,t,o){const a=new j$3(e,1,this,t,o);return this.dataOutputs.push(a),a}getDataInput(e){return this.dataInputs.find((t=>t.name===e))}getDataOutput(e){return this.dataOutputs.find((t=>t.name===e))}serialize(e={},t=v$7){if(e.uniqueId=this.uniqueId,e.config={},this.config){const o=this.config,a=Object.keys(o);for(const n of a)t(n,o[n],e.config);}e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName();for(const t of this.dataInputs){const o={};t.serialize(o),e.dataInputs.push(o);}for(const t of this.dataOutputs){const o={};t.serialize(o),e.dataOutputs.push(o);}}deserialize(e){}_log(e,t,o){e.logger?.addLogItem({action:t,payload:o,className:this.getClassName(),uniqueId:this.uniqueId});}getClassName(){return "FlowGraphBlock"}};let P$4=class P extends N$5{constructor(){super(...arguments),this.priority=0;}_isSingularConnection(){return  false}connectTo(e){super.connectTo(e),this._connectedPoint.sort(((e,t)=>t.priority-e.priority));}_activateSignal(e){if(e.logger?.addLogItem({action:"ActivateSignal",className:this._ownerBlock.getClassName(),uniqueId:this._ownerBlock.uniqueId,payload:{connectionType:this.connectionType,name:this.name}}),0===this.connectionType)e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId();else for(const t of this._connectedPoint)t._activateSignal(e);}};P$9("FlowGraphSignalConnection",P$4);let A$8=class A extends S$7{constructor(e){super(e),this.priority=0,this.signalInputs=[],this.signalOutputs=[],this.in=this._registerSignalInput("in"),this.error=this._registerSignalOutput("error");}_registerSignalInput(e){const t=new P$4(e,0,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){const t=new P$4(e,1,this);return this.signalOutputs.push(t),t}_unregisterSignalInput(e){const t=this.signalInputs.findIndex((t=>t.name===e));-1!==t&&(this.signalInputs[t].dispose(),this.signalInputs.splice(t,1));}_unregisterSignalOutput(e){const t=this.signalOutputs.findIndex((t=>t.name===e));-1!==t&&(this.signalOutputs[t].dispose(),this.signalOutputs.splice(t,1));}_reportError(e,t){this.error.payload="string"==typeof t?new Error(t):t,this.error._activateSignal(e);}getSignalInput(e){return this.signalInputs.find((t=>t.name===e))}getSignalOutput(e){return this.signalOutputs.find((t=>t.name===e))}serialize(e={}){super.serialize(e),e.signalInputs=[],e.signalOutputs=[];for(const t of this.signalInputs){const o={};t.serialize(o),e.signalInputs.push(o);}for(const t of this.signalOutputs){const o={};t.serialize(o),e.signalOutputs.push(o);}}deserialize(e){for(let t=0;t<e.signalInputs.length;t++){const o=this.getSignalInput(e.signalInputs[t].name);if(!o)throw new Error("Could not find signal input with name "+e.signalInputs[t].name+" in block "+e.className);o.deserialize(e.signalInputs[t]);}for(let t=0;t<e.signalOutputs.length;t++){const o=this.getSignalOutput(e.signalOutputs[t].name);if(!o)throw new Error("Could not find signal output with name "+e.signalOutputs[t].name+" in block "+e.className);o.deserialize(e.signalOutputs[t]);}}getClassName(){return "FlowGraphExecutionBlock"}};let q$4=class q{constructor(e){this.onEventTriggeredObservable=new R$g,this.sceneReadyTriggered=false,this._pointerUnderMeshState={},this._startingTime=0,this._scene=e,this._initialize();}_initialize(){this._sceneReadyObserver=this._scene.onReadyObservable.add((()=>{this.sceneReadyTriggered||(this.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}),this.sceneReadyTriggered=true);})),this._sceneDisposeObserver=this._scene.onDisposeObservable.add((()=>{this.onEventTriggeredObservable.notifyObservers({type:"SceneDispose"});})),this._sceneOnBeforeRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{const e=this._scene.getEngine().getDeltaTime()/1e3;this.onEventTriggeredObservable.notifyObservers({type:"SceneBeforeRender",payload:{timeSinceStart:this._startingTime,deltaTime:e}}),this._startingTime+=e;})),this._meshPickedObserver=this._scene.onPointerObservable.add((e=>{this.onEventTriggeredObservable.notifyObservers({type:"MeshPick",payload:e});}),Ar$1.POINTERPICK),this._meshUnderPointerObserver=this._scene.onMeshUnderPointerUpdatedObservable.add((e=>{const t=e.pointerId,o=e.mesh,a=this._pointerUnderMeshState[t];!a&&o?this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:o}}):a&&!o?this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:a}}):a&&o&&a!==o&&(this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:a,over:o}}),this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:o,out:a}})),this._pointerUnderMeshState[t]=o;}),Ar$1.POINTERMOVE);}dispose(){this._sceneDisposeObserver?.remove(),this._sceneReadyObserver?.remove(),this._sceneOnBeforeRenderObserver?.remove(),this._meshPickedObserver?.remove(),this._meshUnderPointerObserver?.remove(),this.onEventTriggeredObservable.clear();}};function D$6(e,t){return !(!e.parent||e.parent!==t&&!D$6(e.parent,t))}function R$8(e){if(e.getClassName)return e.getClassName()}function L$3(e,t){return e===t&&("Vector2"===e||"Vector3"===e||"Vector4"===e||"Quaternion"===e)}function z$5(e,t){return e===t&&("Matrix"===e||"Matrix2D"===e||"Matrix3D"===e)}function $$4(e,t){return "FlowGraphInteger"===e&&"FlowGraphInteger"===t}function U$3(e,t){const o="number"==typeof e||"number"==typeof e?.value;return o&&!t?!isNaN(H$2(e)):o}function H$2(e){return "number"==typeof e?e:e.value}!function(e){e[e.Stopped=0]="Stopped",e[e.Started=1]="Started";}(T$6||(T$6={}));let W$2=class W{get state(){return this._state}set state(e){this._state=e,this.onStateChangedObservable.notifyObservers(e);}constructor(e){this.onStateChangedObservable=new R$g,this._eventBlocks={SceneReady:[],SceneDispose:[],SceneBeforeRender:[],MeshPick:[],PointerDown:[],PointerUp:[],PointerMove:[],PointerOver:[],PointerOut:[],SceneAfterRender:[],NoTrigger:[]},this._executionContexts=[],this._state=0,this._scene=e.scene,this._sceneEventCoordinator=new q$4(this._scene),this._coordinator=e.coordinator,this._eventObserver=this._sceneEventCoordinator.onEventTriggeredObservable.add((e=>{for(const t of this._executionContexts){const o=this._getContextualOrder(e.type,t);for(const a of o)if(!a._executeEvent(t,e.payload))break}switch(e.type){case "SceneReady":this._sceneEventCoordinator.sceneReadyTriggered=true;break;case "SceneBeforeRender":for(const t of this._executionContexts)t._notifyOnTick(e.payload);break;case "SceneDispose":this.dispose();}}));}createContext(){const e=new O$a({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){if("PointerOver"!==e.type&&"PointerOut"!==e.type||(this._scene.constantlyUpdateMeshUnderPointer=true),"NoTrigger"!==e.type&&this._eventBlocks[e.type].push(e),1===this.state)for(const t of this._executionContexts)e._startPendingTasks(t);else this.onStateChangedObservable.addOnce((t=>{if(1===t)for(const t of this._executionContexts)e._startPendingTasks(t);}));}start(){1!==this.state&&(0===this._executionContexts.length&&this.createContext(),this.onStateChangedObservable.add((e=>{1===e&&(this._startPendingEvents(),this._scene.isReady(true)&&this._sceneEventCoordinator.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}));})),this.state=1);}_startPendingEvents(){for(const e of this._executionContexts)for(const t in this._eventBlocks){const o=this._getContextualOrder(t,e);for(const t of o)t._startPendingTasks(e);}}_getContextualOrder(e,t){const o=this._eventBlocks[e].sort(((e,t)=>t.initPriority-e.initPriority));if("MeshPick"===e){const e=[];for(const a of o){const n=a.asset.getValue(t);let s=0;for(;s<o.length;s++){const e=o[s].asset.getValue(t);if(n&&e&&D$6(n,e))break}e.splice(s,0,a);}return e}return o}dispose(){if(0!==this.state){this.state=0;for(const e of this._executionContexts)e._clearPendingBlocks();this._executionContexts.length=0;for(const e in this._eventBlocks)this._eventBlocks[e].length=0;this._eventObserver?.remove(),this._sceneEventCoordinator.dispose();}}visitAllBlocks(e){const t=[],o=new Set;for(const e in this._eventBlocks)for(const a of this._eventBlocks[e])t.push(a),o.add(a.uniqueId);for(;t.length>0;){const a=t.pop();e(a);for(const e of a.dataInputs)for(const a of e._connectedPoint)o.has(a._ownerBlock.uniqueId)||(t.push(a._ownerBlock),o.add(a._ownerBlock.uniqueId));if(a instanceof A$8)for(const e of a.signalOutputs)for(const a of e._connectedPoint)o.has(a._ownerBlock.uniqueId)||(t.push(a._ownerBlock),o.add(a._ownerBlock.uniqueId));}}serialize(e={},t){e.allBlocks=[],this.visitAllBlocks((t=>{const o={};t.serialize(o),e.allBlocks.push(o);})),e.executionContexts=[];for(const o of this._executionContexts){const a={};o.serialize(a,t),e.executionContexts.push(a);}}};let K$3=class K{constructor(e){this.config=e,this.dispatchEventsSynchronously=true,this._flowGraphs=[],this._customEventsMap=new Map,this._eventExecutionCounter=new Map,this._executeOnNextFrame=[],this._eventUniqueId=0,this._disposeObserver=this.config.scene.onDisposeObservable.add((()=>{this.dispose();})),this._onBeforeRenderObserver=this.config.scene.onBeforeRenderObservable.add((()=>{this._eventExecutionCounter.clear();const e=this._executeOnNextFrame.slice(0);if(e.length)for(const t of e){this.notifyCustomEvent(t.id,t.data,false);const e=this._executeOnNextFrame.findIndex((e=>e.uniqueId===t.uniqueId));-1!==e&&this._executeOnNextFrame.splice(e,1);}}));(K.SceneCoordinators.get(this.config.scene)??[]).push(this);}createGraph(){const e=new W$2({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){const t=this._flowGraphs.indexOf(e);-1!==t&&(e.dispose(),this._flowGraphs.splice(t,1));}start(){for(const e of this._flowGraphs)e.start();}dispose(){for(const e of this._flowGraphs)e.dispose();this._flowGraphs.length=0,this._disposeObserver?.remove(),this._onBeforeRenderObserver?.remove();const e=K.SceneCoordinators.get(this.config.scene)??[],t=e.indexOf(this);-1!==t&&e.splice(t,1);}serialize(e,t){e._flowGraphs=[];for(const o of this._flowGraphs){const a={};o.serialize(a,t),e._flowGraphs.push(a);}e.dispatchEventsSynchronously=this.dispatchEventsSynchronously;}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new R$g,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t,o=!this.dispatchEventsSynchronously){if(o)return void this._executeOnNextFrame.push({id:e,data:t,uniqueId:this._eventUniqueId++});if(this._eventExecutionCounter.has(e)){const t=this._eventExecutionCounter.get(e);if(this._eventExecutionCounter.set(e,t+1),t>=K.MaxEventTypeExecutionPerFrame)return void(t===K.MaxEventTypeExecutionPerFrame&&Ie$2.Warn(`FlowGraphCoordinator: Too many executions of event "${e}".`))}else this._eventExecutionCounter.set(e,1);const a=this._customEventsMap.get(e);a&&a.notifyObservers(t);}};K$3.MaxEventsPerType=30,K$3.MaxEventTypeExecutionPerFrame=30,K$3.SceneCoordinators=new Map;const Q$5={};let J$4=class J extends A$8{constructor(e){super(e),this.out=this._registerSignalOutput("out");}};let Z$2=class Z extends J$4{constructor(e,t){if(super(e),this._eventsSignalOutputs={},this.done=this._registerSignalOutput("done"),t)for(const e of t)this._eventsSignalOutputs[e]=this._registerSignalOutput(e+"Event");}_executeOnTick(e){}_startPendingTasks(e){e._getExecutionVariable(this,"_initialized",false)&&(this._cancelPendingTasks(e),this._resetAfterCanceled(e)),this._preparePendingTasks(e),e._addPendingBlock(this),this.out._activateSignal(e),e._setExecutionVariable(this,"_initialized",true);}_resetAfterCanceled(e){e._deleteExecutionVariable(this,"_initialized"),e._removePendingBlock(this);}};let X$2=class X extends Z$2{constructor(){super(...arguments),this.initPriority=0,this.type="NoTrigger";}_execute(e){e._notifyExecuteNode(this),this.done._activateSignal(e);}};function Y$2(e,t){for(const o of e)for(const e of o.dataOutputs)if(e.uniqueId===t)return e;throw new Error("Could not find data out connection with unique id "+t)}function ee$3(e,t){for(const o of e)if(o instanceof A$8)for(const e of o.signalInputs)if(e.uniqueId===t)return e;throw new Error("Could not find signal in connection with unique id "+t)}async function te$3(e,t){const o=await Promise.all(e.allBlocks.map((async e=>{const t=function(e){switch(e){case "FlowGraphPlayAnimationBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphPlayAnimationBlockBNtj_2yo_esm_min})).FlowGraphPlayAnimationBlock;case "FlowGraphStopAnimationBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphStopAnimationBlockCuu0nFIN_esm_min})).FlowGraphStopAnimationBlock;case "FlowGraphPauseAnimationBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphPauseAnimationBlockBq7PJo9Y_esm_min})).FlowGraphPauseAnimationBlock;case "FlowGraphInterpolationBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphInterpolationBlockCJy8o149_esm_min})).FlowGraphInterpolationBlock;case "FlowGraphSceneReadyEventBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphSceneReadyEventBlockDyzWTyIc_esm_min})).FlowGraphSceneReadyEventBlock;case "FlowGraphSceneTickEventBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphSceneTickEventBlockD3ks8tOz_esm_min})).FlowGraphSceneTickEventBlock;case "FlowGraphSendCustomEventBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphSendCustomEventBlockDK1M7FDg_esm_min})).FlowGraphSendCustomEventBlock;case "FlowGraphReceiveCustomEventBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphReceiveCustomEventBlockDQvFf2RW_esm_min})).FlowGraphReceiveCustomEventBlock;case "FlowGraphMeshPickEventBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMeshPickEventBlockEAfJyeJR_esm_min})).FlowGraphMeshPickEventBlock;case "FlowGraphEBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphEBlock;case "FlowGraphPIBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphPiBlock;case "FlowGraphInfBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphInfBlock;case "FlowGraphNaNBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphNaNBlock;case "FlowGraphRandomBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphRandomBlock;case "FlowGraphAddBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphAddBlock;case "FlowGraphSubtractBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphSubtractBlock;case "FlowGraphMultiplyBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphMultiplyBlock;case "FlowGraphDivideBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphDivideBlock;case "FlowGraphAbsBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphAbsBlock;case "FlowGraphSignBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphSignBlock;case "FlowGraphTruncBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphTruncBlock;case "FlowGraphFloorBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphFloorBlock;case "FlowGraphCeilBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphCeilBlock;case "FlowGraphRoundBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphRoundBlock;case "FlowGraphFractBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphFractionBlock;case "FlowGraphNegationBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphNegationBlock;case "FlowGraphModuloBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphModuloBlock;case "FlowGraphMinBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphMinBlock;case "FlowGraphMaxBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphMaxBlock;case "FlowGraphClampBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphClampBlock;case "FlowGraphSaturateBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphSaturateBlock;case "FlowGraphMathInterpolationBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphMathInterpolationBlock;case "FlowGraphEqualityBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphEqualityBlock;case "FlowGraphLessThanBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphLessThanBlock;case "FlowGraphLessThanOrEqualBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphLessThanOrEqualBlock;case "FlowGraphGreaterThanBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphGreaterThanBlock;case "FlowGraphGreaterThanOrEqualBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphGreaterThanOrEqualBlock;case "FlowGraphIsNaNBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphIsNanBlock;case "FlowGraphIsInfBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphIsInfinityBlock;case "FlowGraphDegToRadBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphDegToRadBlock;case "FlowGraphRadToDegBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphRadToDegBlock;case "FlowGraphSinBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphSinBlock;case "FlowGraphCosBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphCosBlock;case "FlowGraphTanBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphTanBlock;case "FlowGraphASinBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphAsinBlock;case "FlowGraphACosBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphAcosBlock;case "FlowGraphATanBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphAtanBlock;case "FlowGraphATan2Block":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphAtan2Block;case "FlowGraphSinhBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphSinhBlock;case "FlowGraphCoshBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphCoshBlock;case "FlowGraphTanhBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphTanhBlock;case "FlowGraphASinhBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphAsinhBlock;case "FlowGraphACoshBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphAcoshBlock;case "FlowGraphATanhBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphAtanhBlock;case "FlowGraphExponentialBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphExpBlock;case "FlowGraphLogBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphLogBlock;case "FlowGraphLog2Block":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphLog2Block;case "FlowGraphLog10Block":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphLog10Block;case "FlowGraphSquareRootBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphSquareRootBlock;case "FlowGraphPowerBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphPowerBlock;case "FlowGraphCubeRootBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphCubeRootBlock;case "FlowGraphBitwiseAndBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphBitwiseAndBlock;case "FlowGraphBitwiseOrBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphBitwiseOrBlock;case "FlowGraphBitwiseNotBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphBitwiseNotBlock;case "FlowGraphBitwiseXorBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphBitwiseXorBlock;case "FlowGraphBitwiseLeftShiftBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphBitwiseLeftShiftBlock;case "FlowGraphBitwiseRightShiftBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphBitwiseRightShiftBlock;case "FlowGraphLengthBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphLengthBlock;case "FlowGraphNormalizeBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphNormalizeBlock;case "FlowGraphDotBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphDotBlock;case "FlowGraphCrossBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphCrossBlock;case "FlowGraphRotate2DBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphRotate2DBlock;case "FlowGraphRotate3DBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphRotate3DBlock;case "FlowGraphTransposeBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMatrixMathBlocksBPTxkuPQ_esm_min})).FlowGraphTransposeBlock;case "FlowGraphDeterminantBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMatrixMathBlocksBPTxkuPQ_esm_min})).FlowGraphDeterminantBlock;case "FlowGraphInvertMatrixBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMatrixMathBlocksBPTxkuPQ_esm_min})).FlowGraphInvertMatrixBlock;case "FlowGraphMatrixMultiplicationBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMatrixMathBlocksBPTxkuPQ_esm_min})).FlowGraphMatrixMultiplicationBlock;case "FlowGraphBranchBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphBranchBlockB2jn6oMT_esm_min})).FlowGraphBranchBlock;case "FlowGraphSetDelayBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphSetDelayBlockBk29OEvG_esm_min})).FlowGraphSetDelayBlock;case "FlowGraphCancelDelayBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphCancelDelayBlockBymck2nB_esm_min})).FlowGraphCancelDelayBlock;case "FlowGraphCallCounterBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphCounterBlockCJGxxHrp_esm_min})).FlowGraphCallCounterBlock;case "FlowGraphDebounceBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphDebounceBlockDB3Kxk8t_esm_min})).FlowGraphDebounceBlock;case "FlowGraphThrottleBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphThrottleBlockIzkMKHp3_esm_min})).FlowGraphThrottleBlock;case "FlowGraphDoNBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphDoNBlockBDeG1rCu_esm_min})).FlowGraphDoNBlock;case "FlowGraphFlipFlopBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphFlipFlopBlockBSPp6ryu_esm_min})).FlowGraphFlipFlopBlock;case "FlowGraphForLoopBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphForLoopBlockCWDLu2Bj_esm_min})).FlowGraphForLoopBlock;case "FlowGraphMultiGateBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMultiGateBlockLawZTnoo_esm_min})).FlowGraphMultiGateBlock;case "FlowGraphSequenceBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphSequenceBlockCLKhwn2_esm_min})).FlowGraphSequenceBlock;case "FlowGraphSwitchBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphSwitchBlockZecWrsuu_esm_min})).FlowGraphSwitchBlock;case "FlowGraphWaitAllBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphWaitAllBlockNaI49ef8_esm_min})).FlowGraphWaitAllBlock;case "FlowGraphWhileLoopBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphWhileLoopBlockNwXUIADD_esm_min})).FlowGraphWhileLoopBlock;case "FlowGraphConsoleLogBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphConsoleLogBlockDWsmqu2O_esm_min})).FlowGraphConsoleLogBlock;case "FlowGraphConditionalBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphConditionalDataBlockC5_x0TCJ_esm_min})).FlowGraphConditionalDataBlock;case "FlowGraphConstantBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphConstantBlockB3nzkc9c_esm_min})).FlowGraphConstantBlock;case "FlowGraphTransformCoordinatesSystemBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphTransformCoordinatesSystemBlockBUvepez9_esm_min})).FlowGraphTransformCoordinatesSystemBlock;case "FlowGraphGetAssetBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphGetAssetBlockDz4HiN6__esm_min})).FlowGraphGetAssetBlock;case "FlowGraphGetPropertyBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphGetPropertyBlockBNf9w9e3_esm_min})).FlowGraphGetPropertyBlock;case "FlowGraphSetPropertyBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphSetPropertyBlock17XIYH8y_esm_min})).FlowGraphSetPropertyBlock;case "FlowGraphGetVariableBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphGetVariableBlockBtCYEhV1_esm_min})).FlowGraphGetVariableBlock;case "FlowGraphSetVariableBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphSetVariableBlockDKnN4a0W_esm_min})).FlowGraphSetVariableBlock;case "FlowGraphJsonPointerParserBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphJsonPointerParserBlockClF7CkDG_esm_min})).FlowGraphJsonPointerParserBlock;case "FlowGraphLeadingZerosBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphLeadingZerosBlock;case "FlowGraphTrailingZerosBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphTrailingZerosBlock;case "FlowGraphOneBitsCounterBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathBlocksCYTHni62_esm_min})).FlowGraphOneBitsCounterBlock;case "FlowGraphCombineVector2Block":return async()=>(await Promise.resolve().then(function(){return flowGraphMathCombineExtractBlocksJio90hAi_esm_min})).FlowGraphCombineVector2Block;case "FlowGraphCombineVector3Block":return async()=>(await Promise.resolve().then(function(){return flowGraphMathCombineExtractBlocksJio90hAi_esm_min})).FlowGraphCombineVector3Block;case "FlowGraphCombineVector4Block":return async()=>(await Promise.resolve().then(function(){return flowGraphMathCombineExtractBlocksJio90hAi_esm_min})).FlowGraphCombineVector4Block;case "FlowGraphCombineMatrixBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathCombineExtractBlocksJio90hAi_esm_min})).FlowGraphCombineMatrixBlock;case "FlowGraphExtractVector2Block":return async()=>(await Promise.resolve().then(function(){return flowGraphMathCombineExtractBlocksJio90hAi_esm_min})).FlowGraphExtractVector2Block;case "FlowGraphExtractVector3Block":return async()=>(await Promise.resolve().then(function(){return flowGraphMathCombineExtractBlocksJio90hAi_esm_min})).FlowGraphExtractVector3Block;case "FlowGraphExtractVector4Block":return async()=>(await Promise.resolve().then(function(){return flowGraphMathCombineExtractBlocksJio90hAi_esm_min})).FlowGraphExtractVector4Block;case "FlowGraphExtractMatrixBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphMathCombineExtractBlocksJio90hAi_esm_min})).FlowGraphExtractMatrixBlock;case "FlowGraphTransformVectorBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphTransformBlock;case "FlowGraphTransformCoordinatesBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphTransformCoordinatesBlock;case "FlowGraphConjugateBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphConjugateBlock;case "FlowGraphAngleBetweenBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphAngleBetweenBlock;case "FlowGraphQuaternionFromAxisAngleBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphQuaternionFromAxisAngleBlock;case "FlowGraphAxisAngleFromQuaternionBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphAxisAngleFromQuaternionBlock;case "FlowGraphQuaternionFromDirectionsBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphVectorMathBlocksBy2WAaEH_esm_min})).FlowGraphQuaternionFromDirectionsBlock;case "FlowGraphMatrixDecompose":return async()=>(await Promise.resolve().then(function(){return flowGraphMatrixMathBlocksBPTxkuPQ_esm_min})).FlowGraphMatrixDecomposeBlock;case "FlowGraphMatrixCompose":return async()=>(await Promise.resolve().then(function(){return flowGraphMatrixMathBlocksBPTxkuPQ_esm_min})).FlowGraphMatrixComposeBlock;case "FlowGraphBooleanToFloat":return async()=>(await Promise.resolve().then(function(){return flowGraphTypeToTypeBlocksDTO8hY8f_esm_min})).FlowGraphBooleanToFloat;case "FlowGraphBooleanToInt":return async()=>(await Promise.resolve().then(function(){return flowGraphTypeToTypeBlocksDTO8hY8f_esm_min})).FlowGraphBooleanToInt;case "FlowGraphFloatToBoolean":return async()=>(await Promise.resolve().then(function(){return flowGraphTypeToTypeBlocksDTO8hY8f_esm_min})).FlowGraphFloatToBoolean;case "FlowGraphIntToBoolean":return async()=>(await Promise.resolve().then(function(){return flowGraphTypeToTypeBlocksDTO8hY8f_esm_min})).FlowGraphIntToBoolean;case "FlowGraphIntToFloat":return async()=>(await Promise.resolve().then(function(){return flowGraphTypeToTypeBlocksDTO8hY8f_esm_min})).FlowGraphIntToFloat;case "FlowGraphFloatToInt":return async()=>(await Promise.resolve().then(function(){return flowGraphTypeToTypeBlocksDTO8hY8f_esm_min})).FlowGraphFloatToInt;case "FlowGraphEasingBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphEasingBlock24qarDNy_esm_min})).FlowGraphEasingBlock;case "FlowGraphBezierCurveEasing":return async()=>(await Promise.resolve().then(function(){return flowGraphBezierCurveEasingBlockDmiEWNWm_esm_min})).FlowGraphBezierCurveEasingBlock;case "FlowGraphPointerOverEventBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphPointerOverEventBlockB6KbkTUI_esm_min})).FlowGraphPointerOverEventBlock;case "FlowGraphPointerOutEventBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphPointerOutEventBlock4SC9TIrI_esm_min})).FlowGraphPointerOutEventBlock;case "FlowGraphContextBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphContextBlockC3zRewlc_esm_min})).FlowGraphContextBlock;case "FlowGraphArrayIndexBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphArrayIndexBlockVCj_pQ3g_esm_min})).FlowGraphArrayIndexBlock;case "FlowGraphCodeExecutionBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphCodeExecutionBlockDvYos2Gi_esm_min})).FlowGraphCodeExecutionBlock;case "FlowGraphIndexOfBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphIndexOfBlockWf9Ra9iC_esm_min})).FlowGraphIndexOfBlock;case "FlowGraphFunctionReference":return async()=>(await Promise.resolve().then(function(){return flowGraphFunctionReferenceBlockCOA_kkZr_esm_min})).FlowGraphFunctionReferenceBlock;case "FlowGraphDataSwitchBlock":return async()=>(await Promise.resolve().then(function(){return flowGraphDataSwitchBlockJZTza8mo_esm_min})).FlowGraphDataSwitchBlock;default:if(Q$5[e])return Q$5[e];throw new Error(`Unknown block name ${e}`)}}(e.className);return await t()})));return function(e,t,o){const a=t.coordinator.createGraph(),n=[],s=t.valueParseFunction??C$7;for(let r=0;r<e.allBlocks.length;r++){const i=ae$3(e.allBlocks[r],{scene:t.coordinator.config.scene,pathConverter:t.pathConverter,assetsContainer:t.coordinator.config.scene,valueParseFunction:s},o[r]);n.push(i),i instanceof X$2&&a.addEventBlock(i);}for(const e of n){for(const t of e.dataInputs)for(const e of t.connectedPointIds){const o=Y$2(n,e);t.connectTo(o);}if(e instanceof A$8)for(const t of e.signalOutputs)for(const e of t.connectedPointIds){const o=ee$3(n,e);t.connectTo(o);}}for(const t of e.executionContexts)oe$3(t,{graph:a,valueParseFunction:s},e.rightHanded);return a}(e,t,o)}function oe$3(e,t,o){const a=t.graph.createContext();e.enableLogging&&(a.enableLogging=true),a.treatDataAsRightHanded=o||false;const n=t.valueParseFunction??C$7;a.uniqueId=e.uniqueId;const s=a.getScene();if(e._assetsContext){const t=e._assetsContext,o={meshes:t.meshes?.map((e=>s.getMeshById(e))),lights:t.lights?.map((e=>s.getLightByName(e))),cameras:t.cameras?.map((e=>s.getCameraByName(e))),materials:t.materials?.map((e=>s.getMaterialById(e))),textures:t.textures?.map((e=>s.getTextureByName(e))),animations:t.animations?.map((e=>s.animations.find((t=>t.name===e)))),skeletons:t.skeletons?.map((e=>s.getSkeletonByName(e))),particleSystems:t.particleSystems?.map((e=>s.getParticleSystemById(e))),animationGroups:t.animationGroups?.map((e=>s.getAnimationGroupByName(e))),transformNodes:t.transformNodes?.map((e=>s.getTransformNodeById(e))),rootNodes:[],multiMaterials:[],morphTargetManagers:[],geometries:[],actionManagers:[],environmentTexture:null,postProcesses:[],sounds:null,effectLayers:[],layers:[],reflectionProbes:[],lensFlareSystems:[],proceduralTextures:[],getNodes:function(){throw new Error("Function not implemented.")}};a.assetsContext=o;}for(const t in e._userVariables){const o=n(t,e._userVariables,a.assetsContext,s);a.userVariables[t]=o;}for(const t in e._connectionValues){const o=n(t,e._connectionValues,a.assetsContext,s);a._setConnectionValueByKey(t,o);}return a}function ae$3(e,t,o){const a={},n=t.valueParseFunction??C$7;if(e.config)for(const o in e.config)a[o]=n(o,e.config,t.assetsContainer||t.scene,t.scene);if("FlowGraphJsonPointerParserBlock"===e.className){if(!t.pathConverter)throw new Error("Path converter is required for this block");a.pathConverter=t.pathConverter;}const s=new o(a);s.uniqueId=e.uniqueId;for(let t=0;t<e.dataInputs.length;t++){const o=s.getDataInput(e.dataInputs[t].name);if(!o)throw new Error("Could not find data input with name "+e.dataInputs[t].name+" in block "+e.className);o.deserialize(e.dataInputs[t]);}for(let t=0;t<e.dataOutputs.length;t++){const o=s.getDataOutput(e.dataOutputs[t].name);if(!o)throw new Error("Could not find data output with name "+e.dataOutputs[t].name+" in block "+e.className);o.deserialize(e.dataOutputs[t]);}return s.metadata=e.metadata,s.deserialize&&s.deserialize(e),s}const ne$3={float:{length:1,flowGraphType:"number",elementType:"number"},bool:{length:1,flowGraphType:"boolean",elementType:"boolean"},float2:{length:2,flowGraphType:"Vector2",elementType:"number"},float3:{length:3,flowGraphType:"Vector3",elementType:"number"},float4:{length:4,flowGraphType:"Vector4",elementType:"number"},float4x4:{length:16,flowGraphType:"Matrix",elementType:"number"},float2x2:{length:4,flowGraphType:"Matrix2D",elementType:"number"},float3x3:{length:9,flowGraphType:"Matrix3D",elementType:"number"},int:{length:1,flowGraphType:"FlowGraphInteger",elementType:"number"}};let se$3=class se{constructor(e,t,o=60){this._interactivityGraph=e,this._gltf=t,this._animationTargetFps=o,this._types=[],this._mappings=[],this._staticVariables=[],this._events=[],this._internalEventsCounter=0,this._nodes=[],this._parseTypes(),this._parseDeclarations(),this._parseVariables(),this._parseEvents(),this._parseNodes();}get arrays(){return {types:this._types,mappings:this._mappings,staticVariables:this._staticVariables,events:this._events,nodes:this._nodes}}_parseTypes(){if(this._interactivityGraph.types)for(const e of this._interactivityGraph.types)this._types.push(ne$3[e.signature]);}_parseDeclarations(){if(this._interactivityGraph.declarations)for(const e of this._interactivityGraph.declarations){const t=M$9(e);if(!t)throw Ie$2.Error(["No mapping found for declaration",e]),new Error("Error parsing declarations");this._mappings.push({flowGraphMapping:t,fullOperationName:e.extension?e.op+":"+e.extension:e.op});}}_parseVariables(){if(this._interactivityGraph.variables)for(const e of this._interactivityGraph.variables){const t=this._parseVariable(e);this._staticVariables.push(t);}}_parseVariable(e,t){const o=this._types[e.type];if(!o)throw Ie$2.Error(["No type found for variable",e]),new Error("Error parsing variables");if(e.value&&e.value.length!==o.length)throw Ie$2.Error(["Invalid value length for variable",e,o]),new Error("Error parsing variables");const a=e.value||[];if(!a.length)switch(o.flowGraphType){case "boolean":a.push(false);break;case "FlowGraphInteger":a.push(0);break;case "number":a.push(NaN);break;case "Vector2":a.push(NaN,NaN);break;case "Vector3":a.push(NaN,NaN,NaN);break;case "Vector4":case "Matrix2D":case "Quaternion":a.fill(NaN,0,4);break;case "Matrix":a.fill(NaN,0,16);break;case "Matrix3D":a.fill(NaN,0,9);}return "number"===o.elementType&&"string"==typeof a[0]&&(a[0]=parseFloat(a[0])),{type:o.flowGraphType,value:t?t(a,this):a}}_parseEvents(){if(this._interactivityGraph.events)for(const e of this._interactivityGraph.events){const t={eventId:e.id||"internalEvent_"+this._internalEventsCounter++};e.values&&(t.eventData=Object.keys(e.values).map((t=>{const o=e.values?.[t];if(!o)throw Ie$2.Error(["No value found for event key",t]),new Error("Error parsing events");const a=this._types[o.type];if(!a)throw Ie$2.Error(["No type found for event value",o]),new Error("Error parsing events");const n=void 0!==o.value?this._parseVariable(o):void 0;return {id:t,type:a.flowGraphType,eventData:true,value:n}}))),this._events.push(t);}}_parseNodes(){if(this._interactivityGraph.nodes)for(const e of this._interactivityGraph.nodes){if("number"!=typeof e.declaration)throw Ie$2.Error(["No declaration found for node",e]),new Error("Error parsing nodes");const t=this._mappings[e.declaration];if(!t)throw Ie$2.Error(["No mapping found for node",e]),new Error("Error parsing nodes");if(t.flowGraphMapping.validation){const o=t.flowGraphMapping.validation(e,this._interactivityGraph,this._gltf);if(!o.valid)throw new Error(`Error validating interactivity node ${this._interactivityGraph.declarations?.[e.declaration].op} - ${o.error}`)}const o=[];for(const a of t.flowGraphMapping.blocks){const n=this._getEmptyBlock(a,t.fullOperationName);this._parseNodeConfiguration(e,n,t.flowGraphMapping,a),o.push(n);}this._nodes.push({blocks:o,fullOperationName:t.fullOperationName});}}_getEmptyBlock(e,t){return {uniqueId:_i(),className:e,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[],config:{},type:t,metadata:{}}}_parseNodeConfiguration(e,t,o,a){const n=t.config;if(e.configuration){const t=Object.keys(e.configuration);for(const s of t){const t=e.configuration?.[s];if(!t)throw Ie$2.Error(["No value found for node configuration",s]),new Error("Error parsing node configuration");const r=o.configuration?.[s];if(r&&r.toBlock?r.toBlock===a:0===o.blocks.indexOf(a)){const e=r?.name||s;t&&void 0!==t.value||void 0===r?.defaultValue?t.value.length>=0?n[e]={value:1===t.value.length?t.value[0]:t.value}:Ie$2.Warn(["Invalid value for node configuration",t]):n[e]={value:r.defaultValue},r&&r.dataTransformer&&(n[e].value=r.dataTransformer([n[e].value],this)[0]);}}}}_parseNodeConnections(e){for(let t=0;t<this._nodes.length;t++){const o=this._interactivityGraph.nodes?.[t];if(!o)throw Ie$2.Error(["No node found for interactivity node",this._nodes[t]]),new Error("Error parsing node connections");const a=this._nodes[t],n=this._mappings[o.declaration];if(!n)throw Ie$2.Error(["No mapping found for node",o]),new Error("Error parsing node connections");const s=o.flows||{},r=Object.keys(s).sort();for(const e of r){const t=s[e],o=n.flowGraphMapping.outputs?.flows?.[e],r=o?.name||e,l=this._createNewSocketConnection(r,true);(o&&o.toBlock&&a.blocks.find((e=>e.className===o.toBlock))||a.blocks[0]).signalOutputs.push(l);const c=t.node,h=this._nodes[c];if(!h)throw Ie$2.Error(["No node found for input node id",c]),new Error("Error parsing node connections");const p=N$6(h.fullOperationName);if(!p)throw Ie$2.Error(["No mapping found for input node",h]),new Error("Error parsing node connections");let u=p.inputs?.flows?.[t.socket||"in"],m=false;if(!u)for(const e in p.inputs?.flows)e.startsWith("[")&&e.endsWith("]")&&(m=true,u=p.inputs?.flows?.[e]);const w=u?m?u.name.replace("$1",t.socket||""):u.name:t.socket||"in",d=u&&u.toBlock&&h.blocks.find((e=>e.className===u.toBlock))||h.blocks[0];let f=d.signalInputs.find((e=>e.name===w));f||(f=this._createNewSocketConnection(w),d.signalInputs.push(f)),f.connectedPointIds.push(l.uniqueId),l.connectedPointIds.push(f.uniqueId);}const l=o.values||{},c=Object.keys(l);for(const t of c){const o=l[t];let s=n.flowGraphMapping.inputs?.values?.[t],r=false;if(!s)for(const e in n.flowGraphMapping.inputs?.values)e.startsWith("[")&&e.endsWith("]")&&(r=true,s=n.flowGraphMapping.inputs?.values?.[e]);const c=s?r?s.name.replace("$1",t):s.name:t,h=this._createNewSocketConnection(c);if((s&&s.toBlock&&a.blocks.find((e=>e.className===s.toBlock))||a.blocks[0]).dataInputs.push(h),void 0!==o.value){const t=this._parseVariable(o,s&&s.dataTransformer);e._connectionValues[h.uniqueId]=t;}else {if(void 0===o.node)throw Ie$2.Error(["Invalid value for value connection",o]),new Error("Error parsing node connections");{const e=o.node,t=o.socket||"value",a=this._nodes[e];if(!a)throw Ie$2.Error(["No node found for output socket reference",o]),new Error("Error parsing node connections");const n=N$6(a.fullOperationName);if(!n)throw Ie$2.Error(["No mapping found for output socket reference",o]),new Error("Error parsing node connections");let s=n.outputs?.values?.[t],r=false;if(!s)for(const e in n.outputs?.values)e.startsWith("[")&&e.endsWith("]")&&(r=true,s=n.outputs?.values?.[e]);const l=s?r?s.name.replace("$1",t):s?.name:t,c=s&&s.toBlock&&a.blocks.find((e=>e.className===s.toBlock))||a.blocks[0];let p=c.dataOutputs.find((e=>e.name===l));p||(p=this._createNewSocketConnection(l,true),c.dataOutputs.push(p)),h.connectedPointIds.push(p.uniqueId),p.connectedPointIds.push(h.uniqueId);}}}if(n.flowGraphMapping.interBlockConnectors)for(const e of n.flowGraphMapping.interBlockConnectors){const t=e.input,o=e.output,n=e.isVariable;this._connectFlowGraphNodes(t,o,a.blocks[e.inputBlockIndex],a.blocks[e.outputBlockIndex],n);}if(n.flowGraphMapping.extraProcessor){const t=this._interactivityGraph.declarations?.[o.declaration];if(!t)throw Ie$2.Error(["No declaration found for extra processor",o]),new Error("Error parsing node connections");a.blocks=n.flowGraphMapping.extraProcessor(o,t,n.flowGraphMapping,this,a.blocks,e,this._gltf);}}}_createNewSocketConnection(e,t){return {uniqueId:_i(),name:e,_connectionType:t?1:0,connectedPointIds:[]}}_connectFlowGraphNodes(e,t,o,a,n){const s=n?o.dataInputs:o.signalInputs,r=n?a.dataOutputs:a.signalOutputs,i=s.find((t=>t.name===e))||this._createNewSocketConnection(e),l=r.find((e=>e.name===t))||this._createNewSocketConnection(t,true);s.find((t=>t.name===e))||s.push(i),r.find((e=>e.name===t))||r.push(l),i.connectedPointIds.push(l.uniqueId),l.connectedPointIds.push(i.uniqueId);}getVariableName(e){return "staticVariable_"+e}serializeToFlowGraph(){const e={uniqueId:_i(),_userVariables:{},_connectionValues:{}};this._parseNodeConnections(e);for(let t=0;t<this._staticVariables.length;t++){const o=this._staticVariables[t];e._userVariables[this.getVariableName(t)]=o;}return {rightHanded:true,allBlocks:this._nodes.reduce(((e,t)=>e.concat(t.blocks)),[]),executionContexts:[e]}}};const re$3="KHR_interactivity";let ie$3=class ie{constructor(e){this._loader=e,this.name=re$3,this.enabled=this._loader.isExtensionUsed(re$3),this._pathConverter=d$f(this._loader.gltf),e._skipStartAnimationStep=true;const t=e.babylonScene;t&&le$2(t);}dispose(){this._loader=null,delete this._pathConverter;}async onReady(){if(!this._loader.babylonScene||!this._pathConverter)return;const e=this._loader.babylonScene,t=this._loader.gltf.extensions?.KHR_interactivity;if(!t)return;const o=new K$3({scene:e});o.dispatchEventsSynchronously=false;const a=t.graphs.map((e=>new se$3(e,this._loader.gltf,this._loader.parent.targetFps).serializeToFlowGraph()));await Promise.all(a.map((async e=>await te$3(e,{coordinator:o,pathConverter:this._pathConverter})))),o.start();}};function le$2(e){C$a("/extensions/KHR_interactivity/?/activeCamera/rotation",{get:()=>{if(!e.activeCamera)return new se$5(NaN,NaN,NaN,NaN);const t=se$5.FromRotationMatrix(e.activeCamera.getWorldMatrix()).normalize();return e.useRightHandedSystem||(t.w*=-1,t.x*=-1),t},type:"Quaternion",getTarget:()=>e.activeCamera}),C$a("/extensions/KHR_interactivity/?/activeCamera/position",{get:()=>{if(!e.activeCamera)return new te$4(NaN,NaN,NaN);const t=e.activeCamera.getWorldMatrix().getTranslation();return e.useRightHandedSystem||(t.x*=-1),t},type:"Vector3",getTarget:()=>e.activeCamera}),C$a("/animations/{}/extensions/KHR_interactivity/isPlaying",{get:e=>e._babylonAnimationGroup?.isPlaying??false,type:"boolean",getTarget:e=>e._babylonAnimationGroup}),C$a("/animations/{}/extensions/KHR_interactivity/minTime",{get:e=>(e._babylonAnimationGroup?.from??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),C$a("/animations/{}/extensions/KHR_interactivity/maxTime",{get:e=>(e._babylonAnimationGroup?.to??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),C$a("/animations/{}/extensions/KHR_interactivity/playhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),C$a("/animations/{}/extensions/KHR_interactivity/virtualPlayhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup});}var ce$2;ce$2=async()=>(await Promise.resolve().then(function(){return flowGraphGLTFDataProviderD8lCle4__esm_min})).FlowGraphGLTFDataProvider,Q$5[`${re$3}/${"FlowGraphGLTFDataProvider"}`]=ce$2,fc(re$3),_c(re$3,true,(e=>new ie$3(e)));var he$3=Object.freeze({__proto__:null,KHR_interactivity:ie$3,_AddInteractivityObjectModel:le$2});var KHR_interactivityPLcKePSA_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,F:S$7,G:M$8,K:he$3,_:D$6,a:Z$2,b:J$4,c:X$2,d:K$3,e:R$8,f:L$3,g:H$2,h:z$5,i:U$3,j:$$4,k:A$8,l:v$7});be$3.AddNodeConstructor("Light_Type_0",((e,t)=>()=>new g$b(e,te$4.Zero(),t)));let g$b=class g extends _n{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute();}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();true!==t.done;t=e.next()){t.value.recreateShadowMap();}}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t;}getClassName(){return "PointLight"}getTypeID(){return dn.LIGHTTYPEID_POINTLIGHT}needCube(){return !this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new te$4(1,0,0);case 1:return new te$4(-1,0,0);case 2:return new te$4(0,-1,0);case 3:return new te$4(0,1,0);case 4:return new te$4(0,0,1);case 5:return new te$4(0,0,-1)}return te$4.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const n=this.getScene().activeCamera;if(!n)return;const o=void 0!==this.shadowMinZ?this.shadowMinZ:n.minZ,r=void 0!==this.shadowMaxZ?this.shadowMaxZ:n.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;re$5.PerspectiveFovLHToRef(this.shadowAngle,1,a?r:o,a?o:r,e,true,this._scene.getEngine().isNDCHalfZRange,void 0,a);}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create();}transferToEffect(e,t){const i=this._scene.floatingOriginOffset;return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x-i.x,this.transformedPosition.y-i.y,this.transformedPosition.z-i.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x-i.x,this.position.y-i.y,this.position.z-i.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){const i=this._scene.floatingOriginOffset;return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x-i.x,this.transformedPosition.y-i.y,this.transformedPosition.z-i.z):e.setFloat3(t,this.position.x-i.x,this.position.y-i.y,this.position.z-i.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=true;}};e$z([a$$()],g$b.prototype,"shadowAngle",null),P$9("BABYLON.PointLight",g$b);const _$a="KHR_lights_punctual";let p$c=class p{constructor(e){this.name=_$a,this._loader=e,this.enabled=this._loader.isExtensionUsed(_$a);}dispose(){this._loader=null,delete this._lights;}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,Oe$2.Assign(this._lights);}}loadNodeAsync(e,s,n){return Re$2.LoadExtensionAsync(e,s,this.name,(async(o,r)=>(this._loader._allMaterialsDirtyRequired=true,await this._loader.loadNodeAsync(e,s,(e=>{let s;const a=Oe$2.Get(o,this._lights,r.light),d=a.name||e.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,a.type){case "directional":{const e=new fn(d,te$4.Backward(),this._loader.babylonScene);e.position.setAll(0),s=e;break}case "point":s=new g$b(d,te$4.Zero(),this._loader.babylonScene);break;case "spot":{const e=new m$i(d,te$4.Zero(),te$4.Backward(),0,1,this._loader.babylonScene);e.angle=2*(a.spot&&a.spot.outerConeAngle||Math.PI/4),e.innerAngle=2*(a.spot&&a.spot.innerConeAngle||0),s=e;break}default:throw this._loader.babylonScene._blockEntityCollection=false,new Error(`${o}: Invalid light type (${a.type})`)}s._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=false,a._babylonLight=s,s.falloffType=dn.FALLOFF_GLTF,s.diffuse=a.color?ge$3.FromArray(a.color):ge$3.White(),s.intensity=null==a.intensity?1:a.intensity,s.range=null==a.range?Number.MAX_VALUE:a.range,s.parent=e,this._loader._babylonLights.push(s),Re$2.AddPointerMetadata(s,o),n(e);})))))}};fc(_$a),_c(_$a,true,(e=>new p$c(e)));var KHR_lights_punctualNqeob4Z4_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_lights:p$c});const d$a="EXT_lights_ies";let h$6=class h{constructor(e){this.name=d$a,this._loader=e,this.enabled=this._loader.isExtensionUsed(d$a);}dispose(){this._loader=null,delete this._lights;}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const i=e[this.name];this._lights=i.lights,Oe$2.Assign(this._lights);}}loadNodeAsync(o,n,d){return Re$2.LoadExtensionAsync(o,n,this.name,(async(h,m)=>{let _,b;this._loader._allMaterialsDirtyRequired=true;const c=await this._loader.loadNodeAsync(o,n,(t=>{b=Oe$2.Get(h,this._lights,m.light);const o=b.name||t.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,_=new m$i(o,te$4.Zero(),te$4.Backward(),0,1,this._loader.babylonScene),_.angle=Math.PI/2,_.innerAngle=0,_._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=false,b._babylonLight=_,_.falloffType=dn.FALLOFF_GLTF,_.diffuse=m.color?ge$3.FromArray(m.color):ge$3.White(),_.intensity=m.multiplier||1,_.range=Number.MAX_VALUE,_.parent=t,this._loader._babylonLights.push(_),Re$2.AddPointerMetadata(_,h),d(t);}));let f;if(b.uri)f=await this._loader.loadUriAsync(o,b,b.uri);else {const e=Oe$2.Get(`${o}/bufferView`,this._loader.gltf.bufferViews,b.bufferView);f=await this._loader.loadBufferViewAsync(`/bufferViews/${e.index}`,e);}return _.iesProfileTexture=new Is(name+"_iesProfile",this._loader.babylonScene,true,false,void 0,null,null,f,true,void 0,void 0,void 0,void 0,".ies"),c}))}};fc(d$a),_c(d$a,true,(e=>new h$6(e)));var EXT_lights_iesDqJqn21G_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,EXT_lights_ies:h$6});const t$D="KHR_materials_anisotropy";let r$14=class r{constructor(e){this.name=t$D,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(t$D);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(o,s,t){return Re$2.LoadExtensionAsync(o,s,this.name,(async(e,r)=>{const n=new Array;n.push(this._loader.loadMaterialPropertiesAsync(o,s,t)),n.push(this._loadAnisotropyPropertiesAsync(e,r,t)),await Promise.all(n);}))}async _loadAnisotropyPropertiesAsync(e,o,s){const t=this._loader._getOrCreateMaterialAdapter(s),r=new Array,n=o.anisotropyStrength??0,a=o.anisotropyRotation??0;t.specularRoughnessAnisotropy=n,t.geometryTangentAngle=a;const i=o.extensions??{};i.EXT_materials_anisotropy_openpbr&&i.EXT_materials_anisotropy_openpbr.openPbrAnisotropyEnabled||t.configureGltfStyleAnisotropy(true),o.anisotropyTexture&&(o.anisotropyTexture.nonColorData=true,r.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,o.anisotropyTexture,(e=>{e.name=`${s.name} (Anisotropy Intensity)`,t.geometryTangentTexture=e;})))),await Promise.all(r);}};fc(t$D),_c(t$D,true,(e=>new r$14(e)));var KHR_materials_anisotropyCsYiwLfN_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_anisotropy:r$14});const t$C="KHR_materials_clearcoat";let n$W=class n{constructor(e){this.name=t$C,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(t$C);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(a,o,r){return Re$2.LoadExtensionAsync(a,o,this.name,(async(e,t)=>{const n=new Array;n.push(this._loader.loadMaterialPropertiesAsync(a,o,r)),n.push(this._loadClearCoatPropertiesAsync(e,t,r));const s=this._loader._getOrCreateMaterialAdapter(r);if(t.extensions&&t.extensions.KHR_materials_clearcoat_darkening){const a=t.extensions.KHR_materials_clearcoat_darkening;n.push(this._loadClearCoatDarkeningPropertiesAsync(e,a,r));}if(t.extensions&&t.extensions.KHR_materials_clearcoat_ior){const e=t.extensions.KHR_materials_clearcoat_ior;let a=1.5;void 0!==e.clearcoatIor&&(a=e.clearcoatIor),s.coatIor=a;}if(t.extensions&&t.extensions.KHR_materials_clearcoat_anisotropy){const a=t.extensions.KHR_materials_clearcoat_anisotropy;n.push(this._loadClearCoatAnisotropyPropertiesAsync(e,a,r));}if(t.extensions&&t.extensions.KHR_materials_clearcoat_color){const a=t.extensions.KHR_materials_clearcoat_color;n.push(this._loadClearCoatColorPropertiesAsync(e,a,r));}await Promise.all(n);}))}_loadClearCoatPropertiesAsync(e,a,o){const r=this._loader._getOrCreateMaterialAdapter(o),t=new Array;return r.configureCoat(),r.coatWeight=void 0!==a.clearcoatFactor?a.clearcoatFactor:0,r.coatRoughness=void 0!==a.clearcoatRoughnessFactor?a.clearcoatRoughnessFactor:0,a.clearcoatTexture&&t.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,a.clearcoatTexture,(e=>{e.name=`${o.name} (ClearCoat)`,r.coatWeightTexture=e;}))),a.clearcoatRoughnessTexture&&(a.clearcoatRoughnessTexture.nonColorData=true,t.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,a.clearcoatRoughnessTexture,(e=>{e.name=`${o.name} (ClearCoat Roughness)`,r.coatRoughnessTexture=e;})))),a.clearcoatNormalTexture&&(a.clearcoatNormalTexture.nonColorData=true,t.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,a.clearcoatNormalTexture,(e=>{e.name=`${o.name} (ClearCoat Normal)`,r.geometryCoatNormalTexture=e,null!=a.clearcoatNormalTexture?.scale&&(r.geometryCoatNormalTextureScale=a.clearcoatNormalTexture.scale);}))),r.setNormalMapInversions(!o.getScene().useRightHandedSystem,o.getScene().useRightHandedSystem)),Promise.all(t).then((()=>{}))}_loadClearCoatDarkeningPropertiesAsync(e,a,o){const r=this._loader._getOrCreateMaterialAdapter(o),t=new Array;return r.coatDarkening=void 0!==a.clearcoatDarkeningFactor?a.clearcoatDarkeningFactor:1,a.clearcoatDarkeningTexture&&(a.clearcoatDarkeningTexture.nonColorData=true,t.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatDarkeningTexture`,a.clearcoatDarkeningTexture,(e=>{e.name=`${o.name} (ClearCoat Darkening)`,r.coatDarkeningTexture=e;})))),Promise.all(t).then((()=>{}))}_loadClearCoatColorPropertiesAsync(e,o,r){const t=this._loader._getOrCreateMaterialAdapter(r),n=new Array,s=ge$3.White();return void 0!==o.clearcoatColorFactor&&s.fromArray(o.clearcoatColorFactor),t.coatColor=s,o.clearcoatColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatColorTexture`,o.clearcoatColorTexture,(e=>{e.name=`${r.name} (ClearCoat Color)`,t.coatColorTexture=e;}))),Promise.all(n).then((()=>{}))}_loadClearCoatAnisotropyPropertiesAsync(e,a,o){const r=this._loader._getOrCreateMaterialAdapter(o),t=new Array,n=a.clearcoatAnisotropyStrength??0,s=a.clearcoatAnisotropyRotation??0;r.coatRoughnessAnisotropy=n,r.geometryCoatTangentAngle=s;const l=a.extensions??{};return l.EXT_materials_anisotropy_openpbr&&l.EXT_materials_anisotropy_openpbr.openPbrAnisotropyEnabled||r.configureGltfStyleAnisotropy(true),a.clearcoatAnisotropyTexture&&(a.clearcoatAnisotropyTexture.nonColorData=true,t.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatAnisotropyTexture`,a.clearcoatAnisotropyTexture,(e=>{e.name=`${o.name} (Clearcoat Anisotropy)`,r.geometryCoatTangentTexture=e;})))),Promise.all(t).then((()=>{}))}};fc(t$C),_c(t$C,true,(e=>new n$W(e)));var KHR_materials_clearcoatC1QZaAXG_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_clearcoat:n$W});const o$K="KHR_materials_diffuse_roughness";let t$B=class t{constructor(e){this.name=o$K,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(o$K);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(s,r,o){return Re$2.LoadExtensionAsync(s,r,this.name,(async(e,t)=>{const i=new Array;return i.push(this._loader.loadMaterialPropertiesAsync(s,r,o)),i.push(this._loadDiffuseRoughnessPropertiesAsync(e,t,o)),await Promise.all(i).then((()=>{}))}))}_loadDiffuseRoughnessPropertiesAsync(e,s,r){const o=this._loader._getOrCreateMaterialAdapter(r),t=new Array;return o.baseDiffuseRoughness=s.diffuseRoughnessFactor??0,s.diffuseRoughnessTexture&&t.push(this._loader.loadTextureInfoAsync(`${e}/diffuseRoughnessTexture`,s.diffuseRoughnessTexture,(e=>{e.name=`${r.name} (Diffuse Roughness)`,o.baseDiffuseRoughnessTexture=e;}))),Promise.all(t).then((()=>{}))}};fc(o$K),_c(o$K,true,(e=>new t$B(e)));var KHR_materials_diffuse_roughnessCE2DwL0T_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_diffuse_roughness:t$B});const n$V="KHR_materials_diffuse_transmission";let o$J=class o{constructor(s){this.name=n$V,this.order=174,this._loader=s,this.enabled=this._loader.isExtensionUsed(n$V),this.enabled&&(s.parent.transparencyAsCoverage=true);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(e,r,i){return Re$2.LoadExtensionAsync(e,r,this.name,(async(s,n)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,r,i)),o.push(this._loadTranslucentPropertiesAsync(s,r,i,n)),await Promise.all(o).then((()=>{}))}))}_loadTranslucentPropertiesAsync(s,r,i,n){const o=this._loader._getOrCreateMaterialAdapter(i);o.configureSubsurface(),o.subsurfaceWeight=n.diffuseTransmissionFactor??0,o.subsurfaceColor=void 0!==n.diffuseTransmissionColorFactor?ge$3.FromArray(n.diffuseTransmissionColorFactor):ge$3.White();const a=new Array;return n.diffuseTransmissionTexture&&(n.diffuseTransmissionTexture.nonColorData=true,a.push(this._loader.loadTextureInfoAsync(`${s}/diffuseTransmissionTexture`,n.diffuseTransmissionTexture).then((s=>{s.name=`${i.name} (Diffuse Transmission)`,o.subsurfaceWeightTexture=s;})))),n.diffuseTransmissionColorTexture&&a.push(this._loader.loadTextureInfoAsync(`${s}/diffuseTransmissionColorTexture`,n.diffuseTransmissionColorTexture).then((s=>{s.name=`${i.name} (Diffuse Transmission Color)`,o.subsurfaceColorTexture=s;}))),Promise.all(a).then((()=>{}))}};fc(n$V),_c(n$V,true,(s=>new o$J(s)));var KHR_materials_diffuse_transmissionDTyHxs4H_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_diffuse_transmission:o$J});const r$13="KHR_materials_dispersion";let o$I=class o{constructor(s){this.name=r$13,this.order=174,this._loader=s,this.enabled=this._loader.isExtensionUsed(r$13);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(e,i,r){return Re$2.LoadExtensionAsync(e,i,this.name,(async(s,o)=>{const t=new Array;return t.push(this._loader.loadMaterialPropertiesAsync(e,i,r)),t.push(this._loadDispersionPropertiesAsync(s,i,r,o)),await Promise.all(t).then((()=>{}))}))}_loadDispersionPropertiesAsync(s,e,i,r){const o=this._loader._getOrCreateMaterialAdapter(i);return o.transmissionWeight>0||!r.dispersion||(o.transmissionDispersionAbbeNumber=20/r.dispersion),Promise.resolve()}};fc(r$13),_c(r$13,true,(s=>new o$I(s)));var KHR_materials_dispersionOov2u1lo_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_dispersion:o$I});const t$A="KHR_materials_emissive_strength";let r$12=class r{constructor(e){this.name=t$A,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(t$A);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(s,i,t){return Re$2.LoadExtensionAsync(s,i,this.name,(async(e,r)=>(await this._loader.loadMaterialPropertiesAsync(s,i,t),this._loadEmissiveProperties(e,r,t),await Promise.resolve())))}_loadEmissiveProperties(e,s,i){if(void 0!==s.emissiveStrength){this._loader._getOrCreateMaterialAdapter(i).emissionLuminance=s.emissiveStrength;}}};fc(t$A),_c(t$A,true,(e=>new r$12(e)));var KHR_materials_emissive_strengthD5P2AM9z_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_emissive_strength:r$12});const o$H="KHR_materials_ior";let i$K=class i{constructor(e){this.name=o$H,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(o$H);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(s,r,o){return Re$2.LoadExtensionAsync(s,r,this.name,(async(e,i)=>{const t=new Array;return t.push(this._loader.loadMaterialPropertiesAsync(s,r,o)),t.push(this._loadIorPropertiesAsync(e,i,o)),await Promise.all(t).then((()=>{}))}))}_loadIorPropertiesAsync(e,s,r){const o=this._loader._getOrCreateMaterialAdapter(r),t=void 0!==s.ior?s.ior:i._DEFAULT_IOR;return o.specularIor=t,Promise.resolve()}};i$K._DEFAULT_IOR=1.5,fc(o$H),_c(o$H,true,(e=>new i$K(e)));var KHR_materials_iorCBGrQ4sL_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_ior:i$K});const r$11="KHR_materials_iridescence";let n$U=class n{constructor(e){this.name=r$11,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(r$11);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(i,s,r){return Re$2.LoadExtensionAsync(i,s,this.name,(async(e,n)=>{const t=new Array;return t.push(this._loader.loadMaterialPropertiesAsync(i,s,r)),t.push(this._loadIridescencePropertiesAsync(e,n,r)),await Promise.all(t).then((()=>{}))}))}_loadIridescencePropertiesAsync(e,i,s){const r=this._loader._getOrCreateMaterialAdapter(s),n=new Array;return r.thinFilmWeight=i.iridescenceFactor??0,r.thinFilmIor=i.iridescenceIor??i.iridescenceIOR??1.3,r.thinFilmThicknessMinimum=i.iridescenceThicknessMinimum??100,r.thinFilmThicknessMaximum=i.iridescenceThicknessMaximum??400,i.iridescenceTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,i.iridescenceTexture,(e=>{e.name=`${s.name} (Iridescence)`,r.thinFilmWeightTexture=e;}))),i.iridescenceThicknessTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,i.iridescenceThicknessTexture,(e=>{e.name=`${s.name} (Iridescence Thickness)`,r.thinFilmThicknessTexture=e;}))),Promise.all(n).then((()=>{}))}};fc(r$11),_c(r$11,true,(e=>new n$U(e)));var KHR_materials_iridescenceCe7w5fDO_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_iridescence:n$U});const t$z="KHR_materials_pbrSpecularGlossiness";let i$J=class i{constructor(e){this.name=t$z,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(t$z);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(e,s,r){return Re$2.LoadExtensionAsync(e,s,this.name,(async(o,a)=>{const t=new Array;return t.push(this._loader.loadMaterialBasePropertiesAsync(e,s,r)),t.push(this._loadSpecularGlossinessPropertiesAsync(o,a,r)),this._loader.loadMaterialAlphaProperties(e,s,r),await Promise.all(t).then((()=>{}))}))}_loadSpecularGlossinessPropertiesAsync(r,o,a){if(!(a instanceof gl))throw new Error(`${r}: Material type not supported`);const t=new Array;return a.metallic=null,a.roughness=null,o.diffuseFactor?(a.albedoColor=ge$3.FromArray(o.diffuseFactor),a.alpha=o.diffuseFactor[3]):a.albedoColor=ge$3.White(),a.reflectivityColor=o.specularFactor?ge$3.FromArray(o.specularFactor):ge$3.White(),a.microSurface=null==o.glossinessFactor?1:o.glossinessFactor,o.diffuseTexture&&t.push(this._loader.loadTextureInfoAsync(`${r}/diffuseTexture`,o.diffuseTexture,(e=>{e.name=`${a.name} (Diffuse)`,a.albedoTexture=e;}))),o.specularGlossinessTexture&&(t.push(this._loader.loadTextureInfoAsync(`${r}/specularGlossinessTexture`,o.specularGlossinessTexture,(e=>{e.name=`${a.name} (Specular Glossiness)`,a.reflectivityTexture=e,a.reflectivityTexture.hasAlpha=true;}))),a.useMicroSurfaceFromReflectivityMapAlpha=true),Promise.all(t).then((()=>{}))}};fc(t$z),_c(t$z,true,(e=>new i$J(e)));var KHR_materials_pbrSpecularGlossinessWtXBUgb6_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_pbrSpecularGlossiness:i$J});const n$T="KHR_materials_sheen";let t$y=class t{constructor(e){this.name=n$T,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(n$T);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(s,o,r){return Re$2.LoadExtensionAsync(s,o,this.name,(async(e,n)=>{const t=new Array;return t.push(this._loader.loadMaterialPropertiesAsync(s,o,r)),t.push(this._loadSheenPropertiesAsync(e,n,r)),await Promise.all(t).then((()=>{}))}))}_loadSheenPropertiesAsync(e,o,r){const n=this._loader._getOrCreateMaterialAdapter(r),t=new Array;n.configureFuzz();const a=void 0!==o.sheenColorFactor?ge$3.FromArray(o.sheenColorFactor):ge$3.Black(),i=void 0!==o.sheenRoughnessFactor?o.sheenRoughnessFactor:0;return n.fuzzWeight=1,n.fuzzColor=a,n.fuzzRoughness=i,o.sheenColorTexture&&t.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,o.sheenColorTexture,(e=>{e.name=`${r.name} (Sheen Color)`,n.fuzzColorTexture=e;}))),o.sheenRoughnessTexture&&(o.sheenRoughnessTexture.nonColorData=true,t.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,o.sheenRoughnessTexture,(e=>{e.name=`${r.name} (Sheen Roughness)`,n.fuzzRoughnessTexture=e;})))),Promise.all(t).then((()=>{}))}};fc(n$T),_c(n$T,true,(e=>new t$y(e)));var KHR_materials_sheenBqFvYGyK_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_sheen:t$y});const o$G="KHR_materials_specular";let t$x=class t{constructor(e){this.name=o$G,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(o$G);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(r,s,a){return Re$2.LoadExtensionAsync(r,s,this.name,(async(e,o)=>{const t=new Array;t.push(this._loader.loadMaterialPropertiesAsync(r,s,a)),t.push(this._loadSpecularPropertiesAsync(e,o,a));const l=this._loader._getOrCreateMaterialAdapter(a);if(o.extensions&&o.extensions.EXT_materials_specular_edge_color){o.extensions.EXT_materials_specular_edge_color.specularEdgeColorEnabled&&l.enableSpecularEdgeColor(true);}return await Promise.all(t).then((()=>{}))}))}_loadSpecularPropertiesAsync(e,s,a){const o=this._loader._getOrCreateMaterialAdapter(a),t=new Array;return o.specularWeight=s.specularFactor??1,o.specularColor=void 0!==s.specularColorFactor?ge$3.FromArray(s.specularColorFactor):new ge$3(1,1,1),s.specularTexture&&(s.specularTexture.nonColorData=true,t.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,s.specularTexture,(e=>{e.name=`${a.name} (Specular)`,o.specularWeightTexture=e;})))),s.specularColorTexture&&t.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,s.specularColorTexture,(e=>{e.name=`${a.name} (Specular Color)`,o.specularColorTexture=e;}))),Promise.all(t).then((()=>{}))}};fc(o$G),_c(o$G,true,(e=>new t$x(e)));var KHR_materials_specularD8iVKYIB_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_specular:t$x});let o$F=class o{static _GetDefaultOptions(){return {renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:Qe$1.TEXTURETYPE_HALF_FLOAT,generateMipmaps:true}}constructor(e,s){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...o._GetDefaultOptions(),...e},this._scene=s,this._scene._transmissionHelper=this,this.onErrorObservable=new R$g,this._scene.onDisposeObservable.addOnce((()=>{this.dispose();})),this._parseScene(),this._setupRenderTargets();}updateOptions(e){if(!Object.keys(e).filter((s=>this._options[s]!==e[s])).length)return;const s={...this._options,...e},t=this._options;this._options=s,s.renderSize===t.renderSize&&s.renderTargetTextureType===t.renderTargetTextureType&&s.generateMipmaps===t.generateMipmaps&&this._opaqueRenderTarget?(this._opaqueRenderTarget.samples=s.samples,this._opaqueRenderTarget.lodGenerationScale=s.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=s.lodGenerationOffset):this._setupRenderTargets();}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return !!e?.subSurface?.isRefractionEnabled}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),Ai.SetImmediate((()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,-1===this._transparentMeshesCache.indexOf(e)&&this._transparentMeshesCache.push(e)):-1===this._opaqueMeshesCache.indexOf(e)&&this._opaqueMeshesCache.push(e);}));}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let s=this._transparentMeshesCache.indexOf(e);-1!==s&&this._transparentMeshesCache.splice(s,1),s=this._opaqueMeshesCache.indexOf(e),-1!==s&&this._opaqueMeshesCache.splice(s,1);}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this));}_onMeshMaterialChanged(e){const s=this._transparentMeshesCache.indexOf(e),t=this._opaqueMeshesCache.indexOf(e);if(this._shouldRenderAsTransmission(e.material)){if(e.material){const s=e.material.subSurface;s&&(s.refractionTexture=this._opaqueRenderTarget);} -1!==t?(this._opaqueMeshesCache.splice(t,1),this._transparentMeshesCache.push(e)):-1===s&&this._transparentMeshesCache.push(e);}else  -1!==s?(this._transparentMeshesCache.splice(s,1),this._opaqueMeshesCache.push(e)):-1===t&&this._opaqueMeshesCache.push(e);}_isRenderTargetValid(){return null!==this._opaqueRenderTarget?.getInternalTexture()}_setupRenderTargets(){let e;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new ua("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=true,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=this._options.clearColor?.clone()??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=false,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=true,this._opaqueRenderTarget.renderParticles=true,this._opaqueRenderTarget.disableImageProcessing=true,this._opaqueRenderTarget.onBeforeBindObservable.add((s=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?s.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(s.clearColor,this._scene.getEngine().useExactSrgbConversions);})),this._opaqueRenderTarget.onAfterUnbindObservable.add((()=>{this._scene.environmentIntensity=e;}));for(const e of this._transparentMeshesCache)this._shouldRenderAsTransmission(e.material)&&(e.material.refractionTexture=this._opaqueRenderTarget);}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[];}};const h$5="KHR_materials_transmission";let p$b=class p{constructor(e){this.name=h$5,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(h$5),this.enabled&&(e.parent.transparencyAsCoverage=true);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(s,t,r){return Re$2.LoadExtensionAsync(s,t,this.name,(async(e,a)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(s,t,r)),n.push(this._loadTransparentPropertiesAsync(e,t,r,a)),await Promise.all(n).then((()=>{}))}))}_loadTransparentPropertiesAsync(e,s,t,r){const a=this._loader._getOrCreateMaterialAdapter(t),n=void 0!==r.transmissionFactor?r.transmissionFactor:0;if(0===n)return Promise.resolve();if(a.configureTransmission(),a.transmissionWeight=n,n>0){const e=t.getScene();e._transmissionHelper?e._transmissionHelper?._isRenderTargetValid()||e._transmissionHelper?._setupRenderTargets():new o$F({},t.getScene());}let i=Promise.resolve(null);return r.transmissionTexture&&(r.transmissionTexture.nonColorData=true,i=this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,(e=>{e.name=`${t.name} (Transmission)`,a.transmissionWeightTexture=e;}))),i.then((()=>{}))}};fc(h$5),_c(h$5,true,(e=>new p$b(e)));var KHR_materials_transmission7ljGlqUe_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_transmission:p$b});const t$w="KHR_materials_unlit";let a$A=class a{constructor(e){this.name=t$w,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(t$w);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(e,o,r){return Re$2.LoadExtensionAsync(e,o,this.name,(async()=>await this._loadUnlitPropertiesAsync(e,o,r)))}_loadUnlitPropertiesAsync(o,r,s){const t=this._loader._getOrCreateMaterialAdapter(s),a=new Array,i=r.pbrMetallicRoughness;return i&&(i.baseColorFactor&&(t.baseColor=ge$3.FromArray(i.baseColorFactor),t.geometryOpacity=i.baseColorFactor[3]),i.baseColorTexture&&a.push(this._loader.loadTextureInfoAsync(`${o}/baseColorTexture`,i.baseColorTexture,(e=>{e.name=`${s.name} (Base Color)`,t.baseColorTexture=e;})))),t.isUnlit=true,r.doubleSided&&(t.backFaceCulling=false,t.twoSidedLighting=true),this._loader.loadMaterialAlphaProperties(o,r,s),Promise.all(a).then((()=>{}))}};fc(t$w),_c(t$w,true,(e=>new a$A(e)));var KHR_materials_unlit2nBGO9GB_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_unlit:a$A});const i$I="KHR_materials_variants";let r$10=class r{constructor(t){this.name=i$I,this._loader=t,this.enabled=this._loader.isExtensionUsed(i$I)&&!this._loader.parent.skipMaterials;}dispose(){this._loader=null;}static GetAvailableVariants(t){const a=this._GetExtensionMetadata(t);return a?Object.keys(a.variants):[]}getAvailableVariants(t){return r.GetAvailableVariants(t)}static SelectVariant(t,a){const e=this._GetExtensionMetadata(t);if(!e)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${i$I} extension`);const n=t=>{const a=e.variants[t];if(a)for(const t of a)t.mesh.material=t.material;};if(a instanceof Array)for(const t of a)n(t);else n(a);e.lastSelected=a;}selectVariant(t,a){r.SelectVariant(t,a);}static Reset(t){const a=this._GetExtensionMetadata(t);if(!a)throw new Error(`Cannot reset on a glTF mesh that does not have the ${i$I} extension`);for(const t of a.original)t.mesh.material=t.material;a.lastSelected=null;}reset(t){r.Reset(t);}static GetLastSelectedVariant(t){const a=this._GetExtensionMetadata(t);if(!a)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${i$I} extension`);return a.lastSelected}getLastSelectedVariant(t){return r.GetLastSelectedVariant(t)}static _GetExtensionMetadata(t){return t?._internalMetadata?.gltf?.[i$I]||null}onLoading(){const t=this._loader.gltf.extensions;if(t&&t[this.name]){const a=t[this.name];this._variants=a.variants;}}onReady(){const t=this._loader.rootBabylonMesh;if(t){const a=this._loader.parent.extensionOptions[i$I];a?.defaultVariant&&r.SelectVariant(t,a.defaultVariant),a?.onLoaded?.({get variants(){return r.GetAvailableVariants(t)},get selectedVariant(){const a=r.GetLastSelectedVariant(t);return a?Array.isArray(a)?a[0]:a:r.GetAvailableVariants(t)[0]},set selectedVariant(a){r.SelectVariant(t,a);}});}}_loadMeshPrimitiveAsync(n,s,l,o,d,m){return Re$2.LoadExtensionAsync(n,d,this.name,(async(h,c)=>{const f=new Array;return f.push(this._loader._loadMeshPrimitiveAsync(n,s,l,o,d,(s=>{if(m(s),s instanceof Er$1){const e=Re$2._GetDrawMode(n,d.mode),l=this._loader.rootBabylonMesh,o=l?l._internalMetadata=l._internalMetadata||{}:{},m=o.gltf=o.gltf||{},_=m[i$I]=m[i$I]||{lastSelected:null,original:[],variants:{}};_.original.push({mesh:s,material:s.material});for(let t=0;t<c.mappings.length;++t){const n=c.mappings[t],o=Oe$2.Get(`${h}/mappings/${t}/material`,this._loader.gltf.materials,n.material);f.push(this._loader._loadMaterialAsync(`#/materials/${n.material}`,o,s,e,(t=>{for(let e=0;e<n.variants.length;++e){const o=n.variants[e],d=Oe$2.Get(`/extensions/${i$I}/variants/${o}`,this._variants,o);_.variants[d.name]=_.variants[d.name]||[],_.variants[d.name].push({mesh:s,material:t}),s.onClonedObservable.add((t=>{const a=t;let e=null,n=a;do{if(n=n.parent,!n)return;e=r._GetExtensionMetadata(n);}while(null===e);if(l&&e===r._GetExtensionMetadata(l)){n._internalMetadata={};for(const t in l._internalMetadata)n._internalMetadata[t]=l._internalMetadata[t];n._internalMetadata.gltf=[];for(const t in l._internalMetadata.gltf)n._internalMetadata.gltf[t]=l._internalMetadata.gltf[t];n._internalMetadata.gltf[i$I]={lastSelected:null,original:[],variants:{}};for(const t of e.original)n._internalMetadata.gltf[i$I].original.push({mesh:t.mesh,material:t.material});for(const t in e.variants)if(Object.prototype.hasOwnProperty.call(e.variants,t)){n._internalMetadata.gltf[i$I].variants[t]=[];for(const a of e.variants[t])n._internalMetadata.gltf[i$I].variants[t].push({mesh:a.mesh,material:a.material});}e=n._internalMetadata.gltf[i$I];}for(const t of e.original)t.mesh===s&&(t.mesh=a);for(const t of e.variants[d.name])t.mesh===s&&(t.mesh=a);}));}})));}}}))),await Promise.all(f).then((([t])=>t))}))}};fc(i$I),_c(i$I,true,(t=>new r$10(t)));var KHR_materials_variants2EdtXuM9_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_variants:r$10});const i$H="KHR_materials_volume";let o$E=class o{constructor(e){this.name=i$H,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(i$H),this.enabled&&this._loader._disableInstancedMesh++;}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null;}loadMaterialPropertiesAsync(e,s,t){return Re$2.LoadExtensionAsync(e,s,this.name,(async(n,i)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,s,t)),o.push(this._loadVolumePropertiesAsync(n,s,t,i)),await Promise.all(o).then((()=>{}))}))}_loadVolumePropertiesAsync(s,t,n,i){const o=this._loader._getOrCreateMaterialAdapter(n);if(0===o.transmissionWeight&&0===o.subsurfaceWeight||!i.thicknessFactor)return Promise.resolve();o.transmissionDepth=void 0!==i.attenuationDistance?i.attenuationDistance:Number.MAX_VALUE,o.transmissionColor=void 0!==i.attenuationColor&&3==i.attenuationColor.length?ge$3.FromArray(i.attenuationColor):ge$3.White(),o.volumeThickness=i.thicknessFactor??0;const r=new Array;return i.thicknessTexture&&(i.thicknessTexture.nonColorData=true,r.push(this._loader.loadTextureInfoAsync(`${s}/thicknessTexture`,i.thicknessTexture,(e=>{e.name=`${n.name} (Thickness)`,o.volumeThicknessTexture=e;})))),Promise.all(r).then((()=>{}))}};fc(i$H),_c(i$H,true,(e=>new o$E(e)));var KHR_materials_volumeICuwBO4_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_materials_volume:o$E});const n$S="KHR_mesh_quantization";let i$G=class i{constructor(s){this.name=n$S,this.enabled=s.isExtensionUsed(n$S);}dispose(){}};fc(n$S),_c(n$S,true,(s=>new i$G(s)));var KHR_mesh_quantizationC5yW_zvY_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_mesh_quantization:i$G});const r$$="KHR_texture_basisu";let n$R=class n{constructor(e){this.name=r$$,this._loader=e,this.enabled=e.isExtensionUsed(r$$);}dispose(){this._loader=null;}_loadTextureAsync(t,o,r){return Re$2.LoadExtensionAsync(t,o,this.name,(async(n,a)=>{const i=null==o.sampler?Re$2.DefaultSampler:Oe$2.Get(`${t}/sampler`,this._loader.gltf.samplers,o.sampler),m=Oe$2.Get(`${n}/source`,this._loader.gltf.images,a.source);return await this._loader._createTextureAsync(t,i,m,(e=>{r(e);}),o._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:true}:void 0,!o._textureInfo.nonColorData)}))}};fc(r$$),_c(r$$,true,(e=>new n$R(e)));var KHR_texture_basisuCMZNYAJN_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_texture_basisu:n$R});const n$Q="KHR_texture_transform";let r$_=class r{constructor(e){this.name=n$Q,this._loader=e,this.enabled=this._loader.isExtensionUsed(n$Q);}dispose(){this._loader=null;}loadTextureInfoAsync(t,o,n){return Re$2.LoadExtensionAsync(t,o,this.name,(async(s,r)=>await this._loader.loadTextureInfoAsync(t,o,(t=>{if(!(t instanceof Is))throw new Error(`${s}: Texture type not supported`);r.offset&&(t.uOffset=r.offset[0],t.vOffset=r.offset[1]),t.uRotationCenter=0,t.vRotationCenter=0,r.rotation&&(t.wAng=-r.rotation),r.scale&&(t.uScale=r.scale[0],t.vScale=r.scale[1]),null!=r.texCoord&&(t.coordinatesIndex=r.texCoord),n(t);}))))}};fc(n$Q),_c(n$Q,true,(e=>new r$_(e)));var KHR_texture_transformCsBKLYw7_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_texture_transform:r$_});const o$D="KHR_xmp_json_ld";let e$e=class e{constructor(s){this.name=o$D,this.order=100,this._loader=s,this.enabled=this._loader.isExtensionUsed(o$D);}dispose(){this._loader=null;}onLoading(){if(null===this._loader.rootBabylonMesh)return;const s=this._loader.gltf.extensions?.KHR_xmp_json_ld,t=this._loader.gltf.asset?.extensions?.KHR_xmp_json_ld;if(s&&t){const o=+t.packet;s.packets&&o<s.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=s.packets[o]);}}};fc(o$D),_c(o$D,true,(s=>new e$e(s)));var KHR_xmp_json_ldBEXvpjL3_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_xmp_json_ld:e$e});let r$Z=class r{constructor(t){this._mainBuses=new Set,this._nodes=new Set,this._defaultMainBus=null,this._parameterRampDuration=.01,"number"==typeof t.parameterRampDuration&&(this.parameterRampDuration=t.parameterRampDuration);}get defaultMainBus(){return 0===this._mainBuses.size?null:(this._defaultMainBus||(this._defaultMainBus=Array.from(this._mainBuses)[0]),this._defaultMainBus)}get parameterRampDuration(){return this._parameterRampDuration}set parameterRampDuration(t){this._parameterRampDuration=Math.max(0,t);}dispose(){const t=this._nodes.values();for(let e=t.next();!e.done;e=t.next())e.value.dispose();this._mainBuses.clear(),this._nodes.clear(),this._defaultMainBus=null;}unlockAsync(){return this.resumeAsync()}_addMainBus(t){this._mainBuses.add(t),this._addNode(t);}_removeMainBus(t){this._mainBuses.delete(t),this._defaultMainBus=null,this._removeNode(t);}_addNode(t){this._nodes.add(t);}_removeNode(t){this._nodes.delete(t);}};const u$c={position:te$4.Zero(),rotation:te$4.Zero(),rotationQuaternion:new se$5};let d$9=class d{};let h$4=class h{constructor(i){this._attachmentType=3,this._position=new te$4,this._rotationQuaternion=new se$5,this._sceneNode=null,this._useBoundingBox=false,this.dispose=()=>{this.detach();},this._spatialAudioNode=i;}get isAttached(){return null!==this._sceneNode}attach(t,e,i){this._sceneNode!==t&&(this.detach(),t&&(this._attachmentType=i,this._sceneNode=t,this._sceneNode.onDisposeObservable.add(this.dispose),this._useBoundingBox=e));}detach(){this._sceneNode?.onDisposeObservable.removeCallback(this.dispose),this._sceneNode=null;}update(){1&this._attachmentType&&(this._useBoundingBox&&this._sceneNode.getBoundingInfo?this._position.copyFrom(this._sceneNode.getBoundingInfo().boundingBox.centerWorld):this._sceneNode?.getWorldMatrix().getTranslationToRef(this._position),this._spatialAudioNode.position.copyFrom(this._position),this._spatialAudioNode._updatePosition()),2&this._attachmentType&&(this._sceneNode?.getWorldMatrix().decompose(void 0,this._rotationQuaternion),this._spatialAudioNode.rotationQuaternion.copyFrom(this._rotationQuaternion),this._spatialAudioNode._updateRotation());}};let l$a=class l extends d$9{constructor(){super(),this._attacherComponent=null,this._attacherComponent=new h$4(this);}get isAttached(){return null!==this._attacherComponent&&this._attacherComponent.isAttached}attach(t,e=false,i=3){this._attacherComponent||(this._attacherComponent=new h$4(this)),this._attacherComponent.attach(t,e,i);}detach(){this._attacherComponent?.detach();}dispose(){this._attacherComponent?.dispose(),this._attacherComponent=null;}setOptions(t){ void 0!==t.listenerMinUpdateTime&&(this.minUpdateTime=t.listenerMinUpdateTime),t.listenerPosition&&(this.position=t.listenerPosition.clone()),t.listenerRotationQuaternion?this.rotationQuaternion=t.listenerRotationQuaternion.clone():t.listenerRotation?this.rotation=t.listenerRotation.clone():this.rotationQuaternion=u$c.rotationQuaternion.clone(),this.update();}};let _$9=class _{constructor(t,e,s){if(this._autoUpdate=true,this._lastUpdateTime=0,this.minUpdateTime=0,!e)return;this.minUpdateTime=s;const n=()=>{if(!this._autoUpdate)return;let e=false;if(0<this.minUpdateTime){const t=Pe$2.Now;this._lastUpdateTime&&t-this._lastUpdateTime<this.minUpdateTime&&(e=true),this._lastUpdateTime=t;}e||t.update(),requestAnimationFrame(n);};requestAnimationFrame(n);}dispose(){this._autoUpdate=false;}};const m$c=new RegExp("\\.(\\w{3,4})($|\\?)"),p$a=100,c$a=new Float32Array([0,0]);let g$a=null,b$9=null,v$6=null;function A$7(t,e,i){let s;if(g$a||(g$a=new Float32Array(p$a)),"linear"===t)return c$a[0]=e,c$a[1]=i,c$a;if("exponential"===t)s=function(){if(!b$9){b$9=new Float32Array(p$a);const t=1/99;let e=t;for(let i=1;i<p$a;i++)b$9[i]=Math.exp(-11.512925464970227*(1-e)),e+=t;}return b$9}();else {if("logarithmic"!==t)throw new Error(`Unknown ramp shape: ${t}`);s=function(){if(!v$6){v$6=new Float32Array(p$a);const t=.01;let e=t;for(let i=0;i<p$a;i++)v$6[i]=1+Math.log10(e)/Math.log10(p$a),e+=t;}return v$6}();}const n=Math.sign(i-e),a=Math.abs(i-e);if(1===n)for(let t=0;t<s.length;t++)g$a[t]=e+a*s[t];else {let t=99;for(let i=0;i<s.length;i++,t--)g$a[i]=e-a*(1-s[t]);}return g$a}function f$e(t){return t.replace(/#/gm,"%23")}let w$2=class w{constructor(t,e){this._deferredRampOptions={duration:0,shape:"linear"},this._deferredTargetValue=-1,this._isObservingUpdates=false,this._rampEndTime=0,this._applyDeferredRamp=()=>{0<this._deferredRampOptions.duration&&this._rampEndTime<this._engine.currentTime&&this.setTargetValue(this._deferredTargetValue,this._deferredRampOptions);},this._engine=t,this._param=e,this._targetValue=e.value;}get isRamping(){return this._engine.currentTime<this._rampEndTime}get targetValue(){return this._targetValue}set targetValue(t){this.setTargetValue(t);}get value(){return this._param.value}dispose(){this._clearDeferredRamp(),this._param=null,this._engine=null;}setTargetValue(t,e=null){if(this._targetValue===t)return;const i="string"==typeof e?.shape?e.shape:"linear";let s="number"==typeof e?.duration?Math.max(e.duration,this._engine.parameterRampDuration):this._engine.parameterRampDuration;const n=this._engine.currentTime;if(n<this._rampEndTime){if(.011<this._rampEndTime-n)throw new Error("Audio parameter not set. Wait for current ramp to finish.");this._deferRamp(t,s,i);}else (s=Math.max(this._engine.parameterRampDuration,s))<1e-6?this._param.setValueAtTime(this._targetValue=t,n):(this._param.cancelScheduledValues(n),this._param.setValueCurveAtTime(A$7(i,this._targetValue,this._targetValue=t),n,s),this._clearDeferredRamp(),this._rampEndTime=n+s);}_deferRamp(t,e,i){this._deferredRampOptions.duration=e,this._deferredRampOptions.shape=i,this._deferredTargetValue=t,this._isObservingUpdates||(this._engine._addUpdateObserver(this._applyDeferredRamp),this._isObservingUpdates=true);}_clearDeferredRamp(){this._deferredRampOptions.duration=0,this._isObservingUpdates&&(this._engine._removeUpdateObserver(this._applyDeferredRamp),this._isObservingUpdates=false);}};const y$6=re$5.Zero(),C$6=new se$5,O$9=te$4.Zero(),U$2=te$4.Zero();function x$7(t,e,i){const s=t._audioContext.listener;return s.forwardX&&s.forwardY&&s.forwardZ&&s.positionX&&s.positionY&&s.positionZ&&s.upX&&s.upY&&s.upZ?new T$5(t,e,i):new R$7(t,e,i)}let N$4=class N extends l$a{constructor(i,s,n){super(),this._lastPosition=te$4.Zero(),this._lastRotation=te$4.Zero(),this._lastRotationQuaternion=new se$5,this.position=te$4.Zero(),this.rotation=te$4.Zero(),this.rotationQuaternion=new se$5,this._listener=i._audioContext.listener,this.engine=i,this._updaterComponent=new _$9(this,s,n);}dispose(){super.dispose(),this._updaterComponent.dispose(),this._updaterComponent=null;}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(t){this._updaterComponent.minUpdateTime=t;}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation());}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||(this._setWebAudioPosition(this.position),this._lastPosition.copyFrom(this.position));}_updateRotation(){if(this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion)){if(this._lastRotation.equalsWithEpsilon(this.rotation))return;se$5.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,C$6),this._lastRotation.copyFrom(this.rotation);}else C$6.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);re$5.FromQuaternionToRef(C$6,y$6),te$4.TransformNormalToRef(te$4.RightHandedForwardReadOnly,y$6,O$9),te$4.TransformNormalToRef(te$4.Up(),y$6,U$2),this._setWebAudioOrientation(O$9,U$2);}};let T$5=class T extends N$4{constructor(t,e,i){super(t,e,i);const s=t._audioContext.listener;this._forwardX=new w$2(t,s.forwardX),this._forwardY=new w$2(t,s.forwardY),this._forwardZ=new w$2(t,s.forwardZ),this._positionX=new w$2(t,s.positionX),this._positionY=new w$2(t,s.positionY),this._positionZ=new w$2(t,s.positionZ),this._upX=new w$2(t,s.upX),this._upY=new w$2(t,s.upY),this._upZ=new w$2(t,s.upZ);}_setWebAudioPosition(t){this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=t.x,this._positionY.targetValue=t.y,this._positionZ.targetValue=t.z);}_setWebAudioOrientation(t,e){this.isAttached&&(this._forwardX.isRamping||this._forwardY.isRamping||this._forwardZ.isRamping||this._upX.isRamping||this._upY.isRamping||this._upZ.isRamping)||(this._forwardX.targetValue=t.x,this._forwardY.targetValue=t.y,this._forwardZ.targetValue=t.z,this._upX.targetValue=e.x,this._upY.targetValue=e.y,this._upZ.targetValue=e.z);}};let R$7=class R extends N$4{_setWebAudioPosition(t){this._listener.setPosition(t.x,t.y,t.z);}_setWebAudioOrientation(t,e){this._listener.setOrientation(t.x,t.y,t.z,e.x,e.y,e.z);}};var S$6;!function(t){t[t.HAS_INPUTS=1]="HAS_INPUTS",t[t.HAS_OUTPUTS=2]="HAS_OUTPUTS",t[t.HAS_INPUTS_AND_OUTPUTS=3]="HAS_INPUTS_AND_OUTPUTS";}(S$6||(S$6={}));let B$4=class B{constructor(t,e){this.onDisposeObservable=new R$g,this.engine=t,1&e&&(this._upstreamNodes=new Set),2&e&&(this._downstreamNodes=new Set);}dispose(){if(this._downstreamNodes){for(const t of Array.from(this._downstreamNodes))if(!this._disconnect(t))throw new Error("Disconnect failed");this._downstreamNodes.clear();}if(this._upstreamNodes){for(const t of Array.from(this._upstreamNodes))if(!t._disconnect(this))throw new Error("Disconnect failed");this._upstreamNodes.clear();}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear();}_connect(t){return !!this._downstreamNodes&&(!this._downstreamNodes.has(t)&&(!!t._onConnect(this)&&(this._downstreamNodes.add(t),true)))}_disconnect(t){return !!this._downstreamNodes&&(!!this._downstreamNodes.delete(t)&&t._onDisconnect(this))}_onConnect(t){return !!this._upstreamNodes&&(!this._upstreamNodes.has(t)&&(this._upstreamNodes.add(t),true))}_onDisconnect(t){return this._upstreamNodes?.delete(t)??false}};let P$3=class P extends B$4{constructor(t,e,i){super(e,i),this.onNameChangedObservable=new R$g,this._name=t;}get name(){return this._name}set name(t){if(this._name===t)return;const e=this._name;this._name=t,this.onNameChangedObservable.notifyObservers({newName:t,oldName:e,node:this});}dispose(){super.dispose(),this.onNameChangedObservable.clear();}};let M$7=class M extends B$4{constructor(t){super(t,1);}};let E$a=class E extends M$7{constructor(t){super(t),this._setGainNode(new GainNode(t._audioContext));}dispose(){super.dispose(),this._volume.dispose(),this._gainNode.disconnect(),this._destinationNode.disconnect();}get _inNode(){return this._gainNode}set _inNode(t){this._gainNode!==t&&this._setGainNode(t);}get volume(){return this._volume.targetValue}set volume(t){this._volume.targetValue=t;}get _destinationNode(){return this.engine._audioDestination}getClassName(){return "_WebAudioMainOut"}setVolume(t,e=null){this._volume.setTargetValue(t,e);}_setGainNode(t){this._gainNode!==t&&(this._gainNode?.disconnect(),t.connect(this._destinationNode),this._volume=new w$2(this.engine,t.gain),this._gainNode=t);}};let I$7=class I{constructor(t,e){this._button=null,this._enabled=true,this._style=null,this._onStateChanged=()=>{this._button&&("running"===this._engine.state?this._hide():this._show());},this._engine=t;const i=e||L$7.LastCreatedEngine?.getInputElement()?.parentElement||document.body,s=(i?.offsetTop||0)+20;this._style=document.createElement("style"),this._style.appendChild(document.createTextNode(`.babylonUnmute{position:absolute;top:${s}px;margin-left:20px;height:40px;width:60px;background-color:rgba(51,51,51,0.7);background-image:url("data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E");background-size:80%;background-repeat:no-repeat;background-position:center;background-position-y:4px;border:none;outline:none;transition:transform 0.125s ease-out;cursor:pointer;z-index:9999;}.babylonUnmute:hover{transform:scale(1.05)}`)),document.head.appendChild(this._style),this._button=document.createElement("button"),this._button.className="babylonUnmute",this._button.id="babylonUnmuteButton",this._button.addEventListener("click",(()=>{this._engine.unlockAsync();})),i.appendChild(this._button),this._engine.stateChangedObservable.add(this._onStateChanged);}dispose(){this._button?.remove(),this._button=null,this._style?.remove(),this._style=null,this._engine.stateChangedObservable.removeCallback(this._onStateChanged);}get enabled(){return this._enabled}set enabled(t){this._enabled=t,t?"running"!==this._engine.state&&this._show():this._hide();}_show(){this._button&&(this._button.style.display="block");}_hide(){this._button&&(this._button.style.display="none");}};const D$5={aac:"audio/aac",ac3:"audio/ac3",flac:"audio/flac",m4a:"audio/mp4",mp3:'audio/mpeg; codecs="mp3"',mp4:"audio/mp4",ogg:'audio/ogg; codecs="vorbis"',wav:"audio/wav",webm:'audio/webm; codecs="vorbis"'};let k$4=class k extends r$Z{constructor(t={}){super(t),this._audioContextStarted=false,this._destinationNode=null,this._invalidFormats=new Set,this._isUpdating=false,this._listener=null,this._listenerAutoUpdate=true,this._listenerMinUpdateTime=0,this._pauseCalled=false,this._resumeOnInteraction=true,this._resumeOnPause=true,this._resumeOnPauseRetryInterval=1e3,this._resumeOnPauseTimerId=null,this._resumePromise=null,this._silentHtmlAudio=null,this._unmuteUI=null,this._updateObservable=null,this._validFormats=new Set,this._volume=1,this._isUsingOfflineAudioContext=false,this.isReadyPromise=new Promise((t=>{this._resolveIsReadyPromise=t;})),this.stateChangedObservable=new R$g,this.userGestureObservable=new R$g,this._initAudioContextAsync=async()=>{this._audioContext.addEventListener("statechange",this._onAudioContextStateChange),this._mainOut=new E$a(this),this._mainOut.volume=this._volume,await this.createMainBusAsync("default");},this._onAudioContextStateChange=()=>{"running"===this.state&&(clearInterval(this._resumeOnPauseTimerId),this._audioContextStarted=true,this._resumePromise=null),"suspended"!==this.state&&"interrupted"!==this.state||this._audioContextStarted&&this._resumeOnPause&&!this._pauseCalled&&(clearInterval(this._resumeOnPauseTimerId),this._resumeOnPauseTimerId=setInterval((()=>{this.resumeAsync();}),this._resumeOnPauseRetryInterval)),this.stateChangedObservable.notifyObservers(this.state);},this._onUserGestureAsync=async()=>{if(this._resumeOnInteraction&&await this._audioContext.resume(),!this._silentHtmlAudio){this._silentHtmlAudio=document.createElement("audio");const t=this._silentHtmlAudio;t.controls=false,t.preload="auto",t.loop=true,t.src="data:audio/wav;base64,UklGRjAAAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0YQwAAAAAAAEA/v8CAP//AQA=",t.play();}this.userGestureObservable.notifyObservers();},this._startUpdating=()=>{if(!this._isUpdating)if(this._isUpdating=true,"running"===this.state)this._update();else {const t=()=>{"running"===this.state&&(this._update(),this.stateChangedObservable.removeCallback(t));};this.stateChangedObservable.add(t);}},this._update=()=>{this._updateObservable?.hasObservers()?(this._updateObservable.notifyObservers(),requestAnimationFrame(this._update)):this._isUpdating=false;},"boolean"==typeof t.listenerAutoUpdate&&(this._listenerAutoUpdate=t.listenerAutoUpdate),"number"==typeof t.listenerMinUpdateTime&&(this._listenerMinUpdateTime=t.listenerMinUpdateTime),this._volume=t.volume??1,t.audioContext?(this._isUsingOfflineAudioContext=t.audioContext instanceof OfflineAudioContext,this._audioContext=t.audioContext):this._audioContext=new AudioContext,t.disableDefaultUI||(this._unmuteUI=new I$7(this,t.defaultUIParentElement));}async _initAsync(t){this._resumeOnInteraction="boolean"!=typeof t.resumeOnInteraction||t.resumeOnInteraction,this._resumeOnPause="boolean"!=typeof t.resumeOnPause||t.resumeOnPause,this._resumeOnPauseRetryInterval=t.resumeOnPauseRetryInterval??1e3,document.addEventListener("click",this._onUserGestureAsync),await this._initAudioContextAsync(),function(t){return t.listenerEnabled||void 0!==t.listenerMinUpdateTime||void 0!==t.listenerPosition||void 0!==t.listenerRotation||void 0!==t.listenerRotationQuaternion}(t)&&(this._listener=x$7(this,this._listenerAutoUpdate,this._listenerMinUpdateTime),this._listener.setOptions(t)),this._resolveIsReadyPromise();}get currentTime(){return this._audioContext.currentTime??0}get _inNode(){return this._audioContext.destination}get mainOut(){return this._mainOut}get listener(){return this._listener??(this._listener=x$7(this,this._listenerAutoUpdate,this._listenerMinUpdateTime))}get state(){return this._isUsingOfflineAudioContext?"running":this._audioContext.state}get volume(){return this._volume}set volume(t){this._volume!==t&&(this._volume=t,this._mainOut&&(this._mainOut.volume=t));}get _audioDestination(){return this._destinationNode?this._destinationNode:this._destinationNode=this._audioContext.destination}set _audioDestination(t){this._destinationNode=t;}get _unmuteUIEnabled(){return !!this._unmuteUI&&this._unmuteUI.enabled}set _unmuteUIEnabled(t){this._unmuteUI&&(this._unmuteUI.enabled=t);}async createBusAsync(t,e={}){const i=new((await Promise.resolve().then(function(){return webAudioBusBy47r9t9_esm_min}))._WebAudioBus)(t,this,e);return await i._initAsync(e),i}async createMainBusAsync(t,e={}){const i=new((await Promise.resolve().then(function(){return webAudioMainBusBBnaqOx9_esm_min}))._WebAudioMainBus)(t,this);return await i._initAsync(e),i}async createMicrophoneSoundSourceAsync(t,e){let i;try{i=await navigator.mediaDevices.getUserMedia({audio:!0});}catch(t){throw new Error("Unable to access microphone: "+t)}return await this.createSoundSourceAsync(t,new MediaStreamAudioSourceNode(this._audioContext,{mediaStream:i}),{outBusAutoDefault:false,...e})}async createSoundAsync(t,e,i={}){const s=new((await Promise.resolve().then(function(){return webAudioStaticSoundCsNtelmb_esm_min}))._WebAudioStaticSound)(t,this,i);return await s._initAsync(e,i),s}async createSoundBufferAsync(t,e={}){const i=new((await Promise.resolve().then(function(){return webAudioStaticSoundCsNtelmb_esm_min}))._WebAudioStaticSoundBuffer)(this);return await i._initAsync(t,e),i}async createSoundSourceAsync(t,e,i={}){const s=new((await Promise.resolve().then(function(){return webAudioSoundSourceD6xdBBte_esm_min}))._WebAudioSoundSource)(t,e,this,i);return await s._initAsync(i),s}async createStreamingSoundAsync(t,e,i={}){const s=new((await Promise.resolve().then(function(){return webAudioStreamingSoundZ4JvlUkS_esm_min}))._WebAudioStreamingSound)(t,this,i);return await s._initAsync(e,i),s}dispose(){super.dispose(),this._listener?.dispose(),this._listener=null,"closed"===this._audioContext.state||this._isUsingOfflineAudioContext||this._audioContext.close(),document.removeEventListener("click",this._onUserGestureAsync),this._audioContext.removeEventListener("statechange",this._onAudioContextStateChange),this._silentHtmlAudio?.remove(),this._updateObservable?.clear(),this._updateObservable=null,this._unmuteUI?.dispose(),this._unmuteUI=null,this.stateChangedObservable.clear();}flagInvalidFormat(t){this._invalidFormats.add(t);}isFormatValid(t){if(this._validFormats.has(t))return  true;if(this._invalidFormats.has(t))return  false;const e=D$5[t];if(void 0===e)return  false;return ""===(new Audio).canPlayType(e)?(this._invalidFormats.add(t),false):(this._validFormats.add(t),true)}async pauseAsync(){await this._audioContext.suspend(),this._pauseCalled=true;}resumeAsync(){return this._pauseCalled=false,this._resumePromise||(this._resumePromise=this._audioContext.resume()),this._resumePromise}setVolume(t,e=null){if(!this._mainOut)throw new Error("Main output not initialized yet.");this._mainOut.setVolume(t,e);}_addMainBus(t){super._addMainBus(t);}_removeMainBus(t){super._removeMainBus(t);}_addNode(t){super._addNode(t);}_removeNode(t){super._removeNode(t);}_addUpdateObserver(t){this._updateObservable||(this._updateObservable=new R$g),this._updateObservable.add(t),this._startUpdating();}_removeUpdateObserver(t){this._updateObservable&&this._updateObservable.removeCallback(t);}};jt.AudioEngineFactory=(t,e,i)=>new F$4(t,e,i);let F$4=class F{get masterGain(){return this._masterGain}set masterGain(t){this._masterGain=this._v2.mainOut._inNode=t;}get useCustomUnlockedButton(){return this._useCustomUnlockedButton}set useCustomUnlockedButton(t){this._useCustomUnlockedButton=t,this._v2._unmuteUIEnabled=!t;}get audioContext(){return "running"===this._v2.state&&this._triggerRunningStateAsync(),this._v2._audioContext}constructor(t=null,e=null,i=null){this._audioContext=null,this._tryToRun=false,this._useCustomUnlockedButton=false,this.canUseWebAudio=true,this.WarnedWebAudioUnsupported=false,this.isMP3supported=false,this.isOGGsupported=false,this.unlocked=false,this.onAudioUnlockedObservable=new R$g,this.onAudioLockedObservable=new R$g;const s=new k$4({audioContext:e||void 0,defaultUIParentElement:t?.parentElement?t.parentElement:void 0});s._unmuteUIEnabled=false,this._masterGain=new GainNode(s._audioContext),s._audioDestination=i,s.stateChangedObservable.add((t=>{"running"===t?(this.unlocked=true,this.onAudioUnlockedObservable.notifyObservers(this)):(this.unlocked=false,this.onAudioLockedObservable.notifyObservers(this));})),s._initAsync({resumeOnInteraction:false}).then((()=>{const t=s.defaultMainBus._outNode;t&&(t.disconnect(s.mainOut._inNode),t.connect(this._masterGain)),s.mainOut._inNode=this._masterGain,s.stateChangedObservable.notifyObservers(s.state);})),this.isMP3supported=s.isFormatValid("mp3"),this.isOGGsupported=s.isFormatValid("ogg"),this._v2=s;}lock(){this._v2._audioContext.suspend(),this._useCustomUnlockedButton||(this._v2._unmuteUIEnabled=true);}unlock(){"running"!==this._audioContext?.state?this._triggerRunningStateAsync():this.unlocked||(this.unlocked=true,this.onAudioUnlockedObservable.notifyObservers(this));}_resumeAudioContextOnStateChange(){this._audioContext?.addEventListener("statechange",(()=>{this.unlocked&&"running"!==this._audioContext?.state&&this._resumeAudioContextAsync();}),{once:true,passive:true,signal:AbortSignal.timeout(3e3)});}_resumeAudioContextAsync(){return this._v2._isUsingOfflineAudioContext?Promise.resolve():this._v2._audioContext.resume()}dispose(){this._v2.dispose(),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear();}getGlobalVolume(){return this.masterGain.gain.value}setGlobalVolume(t){this.masterGain.gain.value=t;}connectToAnalyser(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=t,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._v2._audioContext.destination);}async _triggerRunningStateAsync(){this._tryToRun||(this._tryToRun=true,await this._resumeAudioContextAsync(),this._tryToRun=false,this.unlocked=true,this.onAudioUnlockedObservable.notifyObservers(this));}};
let f$d=class f{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=false;}_clone(){return new f(this.frame,this.action,this.onlyOnce)}};let A$6=class A{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}));}get currentTime(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(jt.audioEngine?.audioContext&&(this.isPlaying||this.isPaused)){const t=this.isPaused?0:jt.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;const t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play();}constructor(a,r,u,d=null,l){if(this.autoplay=false,this._loop=false,this.useCustomAttenuation=false,this.isPlaying=false,this.isPaused=false,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new R$g,this._spatialSound=false,this._panningModel="equalpower",this._playbackRate=1,this._streaming=false,this._startTime=0,this._currentTime=0,this._position=te$4.Zero(),this._localDirection=new te$4(1,0,0),this._volume=1,this._isReadyToPlay=false,this._isDirectional=false,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=false,this._urlType="Unknown",this.name=a,u=u||L$7.LastCreatedScene)if(this._scene=u,A._SceneComponentInitialization(u),this._readyToPlayCallback=d,this._customAttenuationFunction=(e,t,i,n,o)=>t<i?e*(1-t/i):0,l&&(this.autoplay=l.autoplay||false,this._loop=l.loop||false,void 0!==l.volume&&(this._volume=l.volume),this._spatialSound=l.spatialSound??false,this.maxDistance=l.maxDistance??100,this.useCustomAttenuation=l.useCustomAttenuation??false,this.rolloffFactor=l.rolloffFactor||1,this.refDistance=l.refDistance||1,this.distanceModel=l.distanceModel||"linear",this._playbackRate=l.playbackRate||1,this._streaming=l.streaming??false,this._length=l.length,this._offset=l.offset),jt.audioEngine?.canUseWebAudio&&jt.audioEngine.audioContext){this._soundGain=jt.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let t=true;if(r)try{"string"==typeof r?(this._urlType="String",this._url=r):r instanceof ArrayBuffer?this._urlType="ArrayBuffer":r instanceof HTMLMediaElement?this._urlType="MediaElement":r instanceof MediaStream?this._urlType="MediaStream":r instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(r)&&(this._urlType="Array");let i=[],n=!1;switch(this._urlType){case "MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=jt.audioEngine.audioContext.createMediaElementSource(r),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case "MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=jt.audioEngine.audioContext.createMediaStreamSource(r),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case "ArrayBuffer":r.byteLength>0&&(n=!0,this._soundLoaded(r));break;case "AudioBuffer":this._audioBufferLoaded(r);break;case "String":i.push(r);case "Array":0===i.length&&(i=r);for(let t=0;t<i.length;t++){const a=i[t];if(n=l&&l.skipCodecCheck||-1!==a.indexOf(".mp3",a.length-4)&&jt.audioEngine.isMP3supported||-1!==a.indexOf(".ogg",a.length-4)&&jt.audioEngine.isOGGsupported||-1!==a.indexOf(".wav",a.length-4)||-1!==a.indexOf(".m4a",a.length-4)||-1!==a.indexOf(".mp4",a.length-4)||-1!==a.indexOf("blob:"),n){this._streaming?(this._htmlAudioElement=new Audio(a),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,Ai.SetCorsBehavior(a,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",(()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();}),{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(a,(e=>{this._soundLoaded(e);}),void 0,!0,!0,(e=>{e&&Ie$2.Error("XHR "+e.status+" error on: "+a+"."),Ie$2.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this);}));break}}break;default:t=!1;}t?n||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout((()=>{this._readyToPlayCallback&&this._readyToPlayCallback();}),1e3)):Ie$2.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.");}catch(e){Ie$2.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this);}}else this._scene.mainSoundTrack.addSound(this),jt.audioEngine&&!jt.audioEngine.WarnedWebAudioUnsupported&&(Ie$2.Error("Web Audio is not supported by your browser."),jt.audioEngine.WarnedWebAudioUnsupported=true),this._readyToPlayCallback&&setTimeout((()=>{this._readyToPlayCallback&&this._readyToPlayCallback();}),1e3);}dispose(){jt.audioEngine?.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=false,-1===this.soundTrackId?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers());}isReady(){return this._isReadyToPlay}getClassName(){return "Sound"}_audioBufferLoaded(t){jt.audioEngine?.audioContext&&(this._audioBuffer=t,this._isReadyToPlay=true,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback());}_soundLoaded(t){jt.audioEngine?.audioContext&&jt.audioEngine.audioContext.decodeAudioData(t,(e=>{this._audioBufferLoaded(e);}),(e=>{Ie$2.Error("Error while decoding audio data for: "+this.name+" / Error: "+e);}));}setAudioBuffer(t){jt.audioEngine?.canUseWebAudio&&(this._audioBuffer=t,this._isReadyToPlay=true);}updateOptions(e){e&&(this.loop=e.loop??this.loop,this.maxDistance=e.maxDistance??this.maxDistance,this.useCustomAttenuation=e.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=e.rolloffFactor??this.rolloffFactor,this.refDistance=e.refDistance??this.refDistance,this.distanceModel=e.distanceModel??this.distanceModel,this._playbackRate=e.playbackRate??this._playbackRate,this._length=e.length??void 0,this.spatialSound=e.spatialSound??this._spatialSound,this._setOffset(e.offset??void 0),this.setVolume(e.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),void 0!==this._offset&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),void 0!==this._length&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(0|this._offset)+this._length))));}_createSpatialParameters(){jt.audioEngine?.canUseWebAudio&&jt.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??jt.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner));}_disableSpatialSound(){this._spatialSound&&(this._inputAudioNode=this._soundGain,this._soundPanner?.disconnect(),this._soundPanner=null,this._spatialSound=false);}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters());}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel();}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel();}_switchPanningModel(){jt.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel);}connectToSoundTrackAudioNode(t){jt.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(t),this._isOutputConnected=true);}setDirectionalCone(e,t,i){t<e?Ie$2.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=true,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length)));}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(t){if(t!=this._coneInnerAngle){if(this._coneOuterAngle<t)return void Ie$2.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=t,jt.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle);}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(t){if(t!=this._coneOuterAngle){if(t<this._coneInnerAngle)return void Ie$2.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=t,jt.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle);}}setPosition(t){t.equals(this._position)||(this._position.copyFrom(t),jt.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z));}setLocalDirectionToMesh(t){this._localDirection=t,jt.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection();}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=te$4.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z;}updateDistanceFromListener(){if(jt.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const e=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor);}}setAttenuationFunction(e){this._customAttenuationFunction=e;}play(t,i,n){if(this._isReadyToPlay&&this._scene.audioEnabled&&jt.audioEngine?.audioContext)try{this._clearTimeoutsAndObservers();let o=t?jt.audioEngine?.audioContext.currentTime+t:jt.audioEngine?.audioContext.currentTime;if(this._soundSource&&this._streamingSource||this._spatialSound&&this._soundPanner&&(isNaN(this._position.x)||isNaN(this._position.y)||isNaN(this._position.z)||(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=jt.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended();},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){const t=()=>{if(jt.audioEngine?.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=i??0;const n=this._htmlAudioElement.play();void 0!==n&&n.catch((()=>{jt.audioEngine?.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=jt.audioEngine?.onAudioUnlockedObservable.addOnce((()=>{t();})));}));}else (this.loop||this.autoplay)&&(this._audioUnlockedObserver=jt.audioEngine?.onAudioUnlockedObservable.addOnce((()=>{t();})));};t();}}else {const s=()=>{if(jt.audioEngine?.audioContext){if(n=n||this._length,void 0!==i&&this._setOffset(i),this._soundSource){const e=this._soundSource;e.onended=()=>{e.disconnect();};}if(this._soundSource=jt.audioEngine?.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,void 0!==i&&(this._soundSource.loopStart=i),void 0!==n&&(this._soundSource.loopEnd=(0|i)+n),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended();},o=t?jt.audioEngine?.audioContext.currentTime+t:jt.audioEngine.audioContext.currentTime;const s=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(o,s,this.loop?void 0:n);}}};"suspended"===jt.audioEngine?.audioContext.state?this._tryToPlayTimeout=setTimeout((()=>{"suspended"===jt.audioEngine?.audioContext.state?(jt.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=jt.audioEngine.onAudioUnlockedObservable.addOnce((()=>{s();})))):s();}),500):s();}this._startTime=o,this.isPlaying=!0,this.isPaused=!1;}catch(e){Ie$2.Error("Error while trying to play audio: "+this.name+", "+e.message);}}_onended(){this.isPlaying=false,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this);}stop(t){if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource?.disconnect(),this.isPlaying=false;else if(jt.audioEngine?.audioContext&&this._soundSource){const i=t?jt.audioEngine.audioContext.currentTime+t:void 0;this._soundSource.onended=()=>{this.isPlaying=false,this.isPaused=false,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended();},this._soundSource.stop(i);}else this.isPlaying=false;else this.isPaused&&(this.isPaused=false,this._startTime=0,this._currentTime=0);}pause(){this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource?.disconnect(),this.isPlaying=false,this.isPaused=true):jt.audioEngine?.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=false,this.isPaused=true,this._currentTime+=jt.audioEngine.audioContext.currentTime-this._startTime));}setVolume(t,i){jt.audioEngine?.canUseWebAudio&&this._soundGain&&(i&&jt.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(jt.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,jt.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(t,jt.audioEngine.audioContext.currentTime+i)):this._soundGain.gain.value=t),this._volume=t;}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate));}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=true,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=e=>this._onRegisterAfterWorldMatrixUpdate(e),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc);}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null);}_onRegisterAfterWorldMatrixUpdate(t){if(t.getBoundingInfo){const e=t.getBoundingInfo();this.setPosition(e.boundingSphere.centerWorld);}else this.setPosition(t.absolutePosition);jt.audioEngine?.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection();}clone(){if(this._streaming)return null;{const e=()=>{Rt$1((()=>this._isReadyToPlay),(()=>{i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=true,i.autoplay&&i.play(0,this._offset,this._length);}),void 0,300);},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new A(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,n,o){const s=e.name;let r;r=e.url?n+e.url:n+s;const u={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let d;if(o){const e=()=>{Rt$1((()=>o._isReadyToPlay),(()=>{d._audioBuffer=o.getAudioBuffer(),d._isReadyToPlay=true,d.autoplay&&d.play(0,d._offset,d._length);}),void 0,300);};d=new A(s,new ArrayBuffer(0),t,null,u),e();}else d=new A(s,r,t,(()=>{t.removePendingData(d);}),u),t.addPendingData(d);if(e.position){const t=te$4.FromArray(e.position);d.setPosition(t);}if(e.isDirectional&&(d.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const t=te$4.FromArray(e.localDirectionToMesh);d.setLocalDirectionToMesh(t);}if(e.connectedMeshId){const i=t.getMeshById(e.connectedMeshId);i&&d.attachToMesh(i);}return e.metadata&&(d.metadata=e.metadata),d}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=false),this._offset=e);}_clearTimeoutsAndObservers(){this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&(jt.audioEngine?.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null);}};A$6._SceneComponentInitialization=e=>{throw le$4("AudioSceneComponent")},P$9("BABYLON.Sound",A$6);let y$5=class y{constructor(e,t,i){if(this.loop=false,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=false,this.isPaused=false,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let n=0;for(const e of i)n+=e;const o=n>0?1/n:0;for(let e=0;e<this._weights.length;e++)this._weights[e]*=o;this._sounds=t;for(const e of this._sounds)e.onEndedObservable.add((()=>{this._onended();}));}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e)return void Ie$2.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e;}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle)return void Ie$2.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e;}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e);}_onended(){ void 0!==this._currentIndex&&(this._sounds[this._currentIndex].autoplay=false),this.loop&&this.isPlaying?this.play():this.isPlaying=false;}pause(){this.isPlaying&&(this.isPaused=true,void 0!==this._currentIndex&&this._sounds[this._currentIndex].pause());}stop(){this.isPlaying=false,void 0!==this._currentIndex&&this._sounds[this._currentIndex].stop();}play(e){if(!this.isPaused){this.stop();const e=Math.random();let t=0;for(let i=0;i<this._weights.length;i++)if(t+=this._weights[i],e<=t){this._currentIndex=i;break}}const t=this._sounds[this._currentIndex??0];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=true,this.isPlaying=true,this.isPaused=false;}};let T$4=class T{constructor(e,t={}){this.id=-1,this._isInitialized=false,(e=e||L$7.LastCreatedScene)&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1));}_initializeSoundTrackAudioGraph(){jt.audioEngine?.canUseWebAudio&&jt.audioEngine.audioContext&&(this._outputAudioNode=jt.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(jt.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=true);}dispose(){if(jt.audioEngine&&jt.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null;}}addSound(t){this._isInitialized||this._initializeSoundTrackAudioGraph(),jt.audioEngine?.canUseWebAudio&&this._outputAudioNode&&t.connectToSoundTrackAudioNode(this._outputAudioNode),void 0!==t.soundTrackId&&(-1===t.soundTrackId?this._scene.mainSoundTrack.removeSound(t):this._scene.soundTracks&&this._scene.soundTracks[t.soundTrackId].removeSound(t)),this.soundCollection.push(t),t.soundTrackId=this.id;}removeSound(e){const t=this.soundCollection.indexOf(e);-1!==t&&this.soundCollection.splice(t,1);}setVolume(t){jt.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=t);}switchPanningModelToHRTF(){if(jt.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF();}switchPanningModelToEqualPower(){if(jt.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower();}connectToAnalyser(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=t,jt.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,jt.audioEngine.masterGain));}};Object.defineProperty(ch.prototype,"mainSoundTrack",{get:function(){let e=this._getComponent(cr$1.NAME_AUDIO);return e||(e=new P$2(this),this._addComponent(e)),this._mainSoundTrack||(this._mainSoundTrack=new T$4(this,{mainTrack:true})),this._mainSoundTrack},enumerable:true,configurable:true}),ch.prototype.getSoundByName=function(e){let t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===e)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks)for(let i=0;i<this.soundTracks.length;i++)for(t=0;t<this.soundTracks[i].soundCollection.length;t++)if(this.soundTracks[i].soundCollection[t].name===e)return this.soundTracks[i].soundCollection[t];return null},Object.defineProperty(ch.prototype,"audioEnabled",{get:function(){let e=this._getComponent(cr$1.NAME_AUDIO);return e||(e=new P$2(this),this._addComponent(e)),e.audioEnabled},set:function(e){let t=this._getComponent(cr$1.NAME_AUDIO);t||(t=new P$2(this),this._addComponent(t)),e?t.enableAudio():t.disableAudio();},enumerable:true,configurable:true}),Object.defineProperty(ch.prototype,"headphone",{get:function(){let e=this._getComponent(cr$1.NAME_AUDIO);return e||(e=new P$2(this),this._addComponent(e)),e.headphone},set:function(e){let t=this._getComponent(cr$1.NAME_AUDIO);t||(t=new P$2(this),this._addComponent(t)),e?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers();},enumerable:true,configurable:true}),Object.defineProperty(ch.prototype,"audioListenerPositionProvider",{get:function(){let e=this._getComponent(cr$1.NAME_AUDIO);return e||(e=new P$2(this),this._addComponent(e)),e.audioListenerPositionProvider},set:function(e){let t=this._getComponent(cr$1.NAME_AUDIO);if(t||(t=new P$2(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=e;},enumerable:true,configurable:true}),Object.defineProperty(ch.prototype,"audioListenerRotationProvider",{get:function(){let e=this._getComponent(cr$1.NAME_AUDIO);return e||(e=new P$2(this),this._addComponent(e)),e.audioListenerRotationProvider},set:function(e){let t=this._getComponent(cr$1.NAME_AUDIO);if(t||(t=new P$2(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");t.audioListenerRotationProvider=e;},enumerable:true,configurable:true}),Object.defineProperty(ch.prototype,"audioPositioningRefreshRate",{get:function(){let e=this._getComponent(cr$1.NAME_AUDIO);return e||(e=new P$2(this),this._addComponent(e)),e.audioPositioningRefreshRate},set:function(e){let t=this._getComponent(cr$1.NAME_AUDIO);t||(t=new P$2(this),this._addComponent(t)),t.audioPositioningRefreshRate=e;},enumerable:true,configurable:true});let P$2=class P{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=cr$1.NAME_AUDIO,this._audioEnabled=true,this._headphone=false,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new te$4,this._cachedCameraPosition=new te$4,this._lastCheck=0,this._invertMatrixTemp=new re$5,this._cameraDirectionTemp=new te$4,(e=e||L$7.LastCreatedScene)&&(this.scene=e,e.soundTracks=[],e.sounds=[]);}register(){this.scene._afterRenderStage.registerStep(cr$1.STEP_AFTERRENDER_AUDIO,this,this._afterRender);}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let t=0;t<i.soundCollection.length;t++)e.sounds.push(i.soundCollection[t].serialize());}}addFromContainer(e){if(e.sounds)for(const t of e.sounds)t.play(),t.autoplay=true,this.scene.mainSoundTrack.addSound(t);}removeFromContainer(e,t=false){if(e.sounds)for(const i of e.sounds)i.stop(),i.autoplay=false,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose();}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose();}disableAudio(){const t=this.scene;let i;for(this._audioEnabled=false,jt.audioEngine&&jt.audioEngine.audioContext&&jt.audioEngine.audioContext.suspend(),i=0;i<t.mainSoundTrack.soundCollection.length;i++)t.mainSoundTrack.soundCollection[i].pause();if(t.soundTracks)for(i=0;i<t.soundTracks.length;i++)for(let e=0;e<t.soundTracks[i].soundCollection.length;e++)t.soundTracks[i].soundCollection[e].pause();}enableAudio(){const t=this.scene;let i;for(this._audioEnabled=true,jt.audioEngine&&jt.audioEngine.audioContext&&jt.audioEngine.audioContext.resume(),i=0;i<t.mainSoundTrack.soundCollection.length;i++)t.mainSoundTrack.soundCollection[i].isPaused&&t.mainSoundTrack.soundCollection[i].play();if(t.soundTracks)for(i=0;i<t.soundTracks.length;i++)for(let e=0;e<t.soundTracks[i].soundCollection.length;e++)t.soundTracks[i].soundCollection[e].isPaused&&t.soundTracks[i].soundCollection[e].play();}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=true,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF();}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=false,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower();}_afterRender(){const t=Pe$2.Now;if(this._lastCheck&&t-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=t;const n=this.scene;if(!this._audioEnabled||!n._mainSoundTrack||!n.soundTracks||0===n._mainSoundTrack.soundCollection.length&&1===n.soundTracks.length)return;const o=jt.audioEngine;if(o&&o.audioContext){let e,t=n.activeCamera;if(n.activeCameras&&n.activeCameras.length>0&&(t=n.activeCameras[0]),this.audioListenerPositionProvider){const e=this.audioListenerPositionProvider();o.audioContext.listener.setPosition(e.x||0,e.y||0,e.z||0);}else t?this._cachedCameraPosition.equals(t.globalPosition)||(this._cachedCameraPosition.copyFrom(t.globalPosition),o.audioContext.listener.setPosition(t.globalPosition.x,t.globalPosition.y,t.globalPosition.z)):o.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const e=this.audioListenerRotationProvider();o.audioContext.listener.setOrientation(e.x||0,e.y||0,e.z||0,0,1,0);}else t?(t.rigCameras&&t.rigCameras.length>0&&(t=t.rigCameras[0]),t.getViewMatrix().invertToRef(this._invertMatrixTemp),te$4.TransformNormalToRef(P._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),isNaN(this._cameraDirectionTemp.x)||isNaN(this._cameraDirectionTemp.y)||isNaN(this._cameraDirectionTemp.z)||this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),o.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0))):o.audioContext.listener.setOrientation(0,0,0,0,1,0);for(e=0;e<n.mainSoundTrack.soundCollection.length;e++){const t=n.mainSoundTrack.soundCollection[e];t.useCustomAttenuation&&t.updateDistanceFromListener();}if(n.soundTracks)for(e=0;e<n.soundTracks.length;e++)for(let t=0;t<n.soundTracks[e].soundCollection.length;t++){const i=n.soundTracks[e].soundCollection[t];i.useCustomAttenuation&&i.updateDistanceFromListener();}}}};P$2._CameraDirection=new te$4(0,0,-1),A$6._SceneComponentInitialization=e=>{let t=e._getComponent(cr$1.NAME_AUDIO);t||(t=new P$2(e),e._addComponent(t));};const b$8="MSFT_audio_emitter";let C$5=class C{constructor(e){this.name=b$8,this._loader=e,this.enabled=this._loader.isExtensionUsed(b$8);}dispose(){this._loader=null,this._clips=null,this._emitters=null;}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,Oe$2.Assign(this._clips),Oe$2.Assign(this._emitters);}}loadSceneAsync(e,t){return Re$2.LoadExtensionAsync(e,t,this.name,(async(i,n)=>{const o=new Array;o.push(this._loader.loadSceneAsync(e,t));for(const e of n.emitters){const t=Oe$2.Get(`${i}/emitters`,this._emitters,e);if(null!=t.refDistance||null!=t.maxDistance||null!=t.rolloffFactor||null!=t.distanceModel||null!=t.innerAngle||null!=t.outerAngle)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);o.push(this._loadEmitterAsync(`${i}/emitters/${t.index}`,t));}await Promise.all(o);}))}loadNodeAsync(e,t,n){return Re$2.LoadExtensionAsync(e,t,this.name,(async(e,o)=>{const a=new Array,r=await this._loader.loadNodeAsync(e,t,(t=>{for(const n of o.emitters){const o=Oe$2.Get(`${e}/emitters`,this._emitters,n);a.push(this._loadEmitterAsync(`${e}/emitters/${o.index}`,o).then((()=>{for(const e of o._babylonSounds)e.attachToMesh(t),null==o.innerAngle&&null==o.outerAngle||(e.setLocalDirectionToMesh(te$4.Forward()),e.setDirectionalCone(2*Ai.ToDegrees(null==o.innerAngle?Math.PI:o.innerAngle),2*Ai.ToDegrees(null==o.outerAngle?Math.PI:o.outerAngle),0));})));}n(t);}));return await Promise.all(a),r}))}loadAnimationAsync(e,t){return Re$2.LoadExtensionAsync(e,t,this.name,(async(i,n)=>{const o=await this._loader.loadAnimationAsync(e,t),s=new Array;Oe$2.Assign(n.events);for(const a of n.events)s.push(this._loadAnimationEventAsync(`${i}/events/${a.index}`,e,t,a,o));return await Promise.all(s),o}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let i;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else {const n=Oe$2.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${n.index}`,n);}return t._objectURL=i.then((e=>URL.createObjectURL(new Blob([e],{type:t.mimeType})))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const e=new Array,i=t.name||`emitter${t.index}`,n={loop:false,autoplay:false,volume:null==t.volume?1:t.volume};for(let o=0;o<t.clips.length;o++){const s=`/extensions/${this.name}/clips`,a=Oe$2.Get(s,this._clips,t.clips[o].clip);e.push(this._loadClipAsync(`${s}/${t.clips[o].clip}`,a).then((e=>{const s=t._babylonSounds[o]=new A$6(i,e,this._loader.babylonScene,null,n);s.refDistance=t.refDistance||1,s.maxDistance=t.maxDistance||256,s.rolloffFactor=t.rolloffFactor||1,s.distanceModel=t.distanceModel||"exponential";})));}const o=Promise.all(e).then((()=>{const e=t.clips.map((e=>e.weight||1)),i=new y$5(t.loop||false,t._babylonSounds,e);t.innerAngle&&(i.directionalConeInnerAngle=2*Ai.ToDegrees(t.innerAngle)),t.outerAngle&&(i.directionalConeOuterAngle=2*Ai.ToDegrees(t.outerAngle)),t.volume&&(i.volume=t.volume),t._babylonData.sound=i;}));t._babylonData={loaded:o};}return t._babylonData.loaded}_getEventAction(e,t,i,n,o){switch(i){case "play":return e=>{const i=(o||0)+(e-n);t.play(i);};case "stop":return ()=>{t.stop();};case "pause":return ()=>{t.pause();};default:throw new Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,n,o){if(0==o.targetedAnimations.length)return Promise.resolve();const s=o.targetedAnimations[0],a=n.emitter,r=Oe$2.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,r).then((()=>{const t=r._babylonData.sound;if(t){const i=new f$d(n.time,this._getEventAction(e,t,n.action,n.time,n.startOffset));s.animation.addEvent(i),o.onAnimationGroupEndObservable.add((()=>{t.stop();})),o.onAnimationGroupPauseObservable.add((()=>{t.pause();}));}}))}};fc(b$8),_c(b$8,true,(e=>new C$5(e)));var MSFT_audio_emitterCmDdp9Vo_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,MSFT_audio_emitter:C$5});const n$P="MSFT_lod";let o$C=class o{constructor(s){this.name=n$P,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new R$g,this.onMaterialLODsLoadedObservable=new R$g,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=s,this.maxLODsToLoad=this._loader.parent.extensionOptions[n$P]?.maxLODsToLoad??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(n$P);}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear();}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const s=Promise.all(this._nodePromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve());}));this._loader._completePromises.push(s);}for(let e=0;e<this._materialPromiseLODs.length;e++){const s=Promise.all(this._materialPromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve());}));this._loader._completePromises.push(s);}}loadSceneAsync(e,s){const t=this._loader.loadSceneAsync(e,s);return this._loadBufferLOD(this._bufferLODs,0),t}loadNodeAsync(e,t,i){return Re$2.LoadExtensionAsync(e,t,this.name,(async(e,r)=>{let a;const n=this._getLODs(e,t,this._loader.gltf.nodes,r.ids);this._loader.logOpen(`${e}`);for(let e=0;e<n.length;e++){const t=n[e];0!==e&&(this._nodeIndexLOD=e,this._nodeSignalLODs[e]=this._nodeSignalLODs[e]||new Cl);const r=e=>{i(e),e.setEnabled(false);},o=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,r).then((s=>{if(0!==e){const s=n[e-1];s._babylonTransformNode&&(this._disposeTransformNode(s._babylonTransformNode),delete s._babylonTransformNode);}return s.setEnabled(true),s}));this._nodePromiseLODs[e]=this._nodePromiseLODs[e]||[],0===e?a=o:(this._nodeIndexLOD=null,this._nodePromiseLODs[e].push(o));}return this._loader.logClose(),await a}))}_loadMaterialAsync(e,s,t,i,a){return this._nodeIndexLOD?null:Re$2.LoadExtensionAsync(e,s,this.name,(async(e,r)=>{let n;const o=this._getLODs(e,s,this._loader.gltf.materials,r.ids);this._loader.logOpen(`${e}`);for(let e=0;e<o.length;e++){const s=o[e];0!==e&&(this._materialIndexLOD=e);const r=this._loader._loadMaterialAsync(`/materials/${s.index}`,s,t,i,(s=>{0===e&&a(s);})).then((s=>{if(0!==e){a(s);const t=o[e-1]._data;t[i]&&(this._disposeMaterials([t[i].babylonMaterial]),delete t[i]);}return s}));this._materialPromiseLODs[e]=this._materialPromiseLODs[e]||[],0===e?n=r:(this._materialIndexLOD=null,this._materialPromiseLODs[e].push(r));}return this._loader.logClose(),await n}))}_loadUriAsync(e,t,i){if(null!==this._nodeIndexLOD){this._loader.log("deferred");const r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new Cl,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then((async()=>await this._loader.loadUriAsync(e,t,i)))}if(null!==this._materialIndexLOD){this._loader.log("deferred");const r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new Cl,this._materialSignalLODs[r].promise.then((async()=>await this._loader.loadUriAsync(e,t,i)))}return null}loadBufferAsync(e,t,i,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const t=async(e,t)=>{const a=i,n=a+r-1;let o=e[t];return o?(o.start=Math.min(o.start,a),o.end=Math.max(o.end,n)):(o={start:a,end:n,loaded:new Cl},e[t]=o),await o.loaded.promise.then((e=>new Uint8Array(e.buffer,e.byteOffset+i-o.start,r)))};return this._loader.log("deferred"),null!==this._nodeIndexLOD?t(this._nodeBufferLODs,this._nodeIndexLOD):null!==this._materialIndexLOD?t(this._materialBufferLODs,this._materialIndexLOD):t(this._bufferLODs,0)}return null}_loadBufferLOD(e,s){const t=e[s];t&&(this._loader.log(`Loading buffer range [${t.start}-${t.end}]`),this._loader.bin.readAsync(t.start,t.end-t.start+1).then((e=>{t.loaded.resolve(e);}),(e=>{t.loaded.reject(e);})));}_getLODs(e,s,t,i){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const r=[];for(let s=i.length-1;s>=0;s--)if(r.push(Oe$2.Get(`${e}/ids/${i[s]}`,t,i[s])),r.length===this.maxLODsToLoad)return r;return r.push(s),r}_disposeTransformNode(e){const s=[],t=e.material;t&&s.push(t);for(const t of e.getChildMeshes())t.material&&s.push(t.material);e.dispose();const i=s.filter((e=>this._loader.babylonScene.meshes.every((s=>s.material!=e))));this._disposeMaterials(i);}_disposeMaterials(e){const s={};for(const t of e){for(const e of t.getActiveTextures())s[e.uniqueId]=e;t.dispose();}for(const e in s)for(const t of this._loader.babylonScene.materials)t.hasTexture(s[e])&&delete s[e];for(const e in s)s[e].dispose();}};fc(n$P),_c(n$P,true,(e=>new o$C(e)));var MSFT_lodDL_omRXB_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,MSFT_lod:o$C});const i$F="MSFT_minecraftMesh";let r$Y=class r{constructor(e){this.name=i$F,this._loader=e,this.enabled=this._loader.isExtensionUsed(i$F);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(s,t,i){return Re$2.LoadExtraAsync(s,t,this.name,(async(e,r)=>{if(r){if(!this._loader._pbrMaterialImpl)throw new Error(`${e}: Material type not supported`);const r=this._loader.loadMaterialPropertiesAsync(s,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=true,i.separateCullingPass=true),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=true,await r}}))}};fc(i$F),_c(i$F,true,(e=>new r$Y(e)));var MSFT_minecraftMeshCXum7ogz_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,MSFT_minecraftMesh:r$Y});const o$B="MSFT_sRGBFactors";let t$v=class t{constructor(e){this.name=o$B,this._loader=e,this.enabled=this._loader.isExtensionUsed(o$B);}dispose(){this._loader=null;}loadMaterialPropertiesAsync(s,r,o){return Re$2.LoadExtraAsync(s,r,this.name,(async(e,t)=>{if(t){const e=this._loader._getOrCreateMaterialAdapter(o),t=this._loader.loadMaterialPropertiesAsync(s,r,o),a=o.getScene().getEngine().useExactSrgbConversions;return e.baseColorTexture||e.baseColor.toLinearSpaceToRef(e.baseColor,a),e.specularColorTexture||e.specularColor.toLinearSpaceToRef(e.specularColor,a),await t}}))}};fc(o$B),_c(o$B,true,(e=>new t$v(e)));var MSFT_sRGBFactorsTxXGZyh_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,MSFT_sRGBFactors:t$v});const o$A="KHR_node_visibility";C$a("/nodes/{}/extensions/KHR_node_visibility/visible",{get:i=>{const e=i._babylonTransformNode;return !e||void 0===e.isVisible||e.isVisible},set:(i,e)=>{e._primitiveBabylonMeshes?.forEach((i=>{i.inheritVisibility=true;})),e._babylonTransformNode&&(e._babylonTransformNode.isVisible=i),e._primitiveBabylonMeshes?.forEach((e=>{e.isVisible=i;}));},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"isVisible"],type:"boolean"});let n$O=class n{constructor(i){this.name=o$A,this._loader=i,this.enabled=i.isExtensionUsed(o$A);}onReady(){if(!this._loader)return;const i=this._loader.gltf.nodes;if(i)for(const e of i){const i=e._babylonTransformNode;i&&(i.inheritVisibility=true,e.extensions&&e.extensions.KHR_node_visibility&&false===e.extensions.KHR_node_visibility.visible&&(i.isVisible=false));}}dispose(){delete this._loader;}};fc(o$A),_c(o$A,true,(i=>new n$O(i)));var KHR_node_visibilityCw9XSLCx_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_node_visibility:n$O});const r$X="KHR_node_hoverability",a$z="targetMeshPointerOver_";E$c("event/onHoverIn",r$X,{blocks:["FlowGraphPointerOverEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer:e=>[a$z+e[0]]}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:true},{input:"object",output:"meshUnderPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:true}],extraProcessor(e,o,n,t,r,i,s){const l=r[r.length-1];l.config=l.config||{},l.config.glTF=s;const d=e.configuration?.nodeIndex?.value[0];if(void 0===d||"number"!=typeof d)throw new Error("nodeIndex not found in configuration");const u=a$z+d;return r[1].config.variable=u,i._userVariables[u]={className:"Mesh",id:s?.nodes?.[d]._babylonTransformNode?.id,uniqueId:s?.nodes?.[d]._babylonTransformNode?.uniqueId},r}});const i$E="targetMeshPointerOut_";E$c("event/onHoverOut",r$X,{blocks:["FlowGraphPointerOutEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer:e=>[i$E+e[0]]}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:true},{input:"object",output:"meshOutOfPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:true}],extraProcessor(e,o,n,t,r,a,s){const l=r[r.length-1];l.config=l.config||{},l.config.glTF=s;const d=e.configuration?.nodeIndex?.value[0];if(void 0===d||"number"!=typeof d)throw new Error("nodeIndex not found in configuration");const u=i$E+d;return r[1].config.variable=u,a._userVariables[u]={className:"Mesh",id:s?.nodes?.[d]._babylonTransformNode?.id,uniqueId:s?.nodes?.[d]._babylonTransformNode?.uniqueId},r}}),C$a("/nodes/{}/extensions/KHR_node_hoverability/hoverable",{get:e=>{const o=e._babylonTransformNode;return !o||void 0===o.pointerOverDisableMeshTesting||o.pointerOverDisableMeshTesting},set:(e,o)=>{o._primitiveBabylonMeshes?.forEach((o=>{o.pointerOverDisableMeshTesting=!e;}));},getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"pointerOverDisableMeshTesting"],type:"boolean"});let s$f=class s{constructor(e){this.name=r$X,this._loader=e,this.enabled=e.isExtensionUsed(r$X);}async onReady(){this._loader.gltf.nodes?.forEach((e=>{e.extensions?.KHR_node_hoverability&&false===e.extensions?.KHR_node_hoverability.hoverable&&e._babylonTransformNode?.getChildMeshes().forEach((e=>{e.pointerOverDisableMeshTesting=true;}));}));}dispose(){this._loader=null;}};fc(r$X),_c(r$X,true,(e=>new s$f(e)));var KHR_node_hoverabilityVeW9q7fl_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_node_hoverability:s$f});const t$u="KHR_node_selectability";E$c("event/onSelect",t$u,{blocks:["FlowGraphMeshPickEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer:e=>["pickedMesh_"+e[0]]}},outputs:{values:{selectedNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"},selectionPoint:{name:"pickedPoint"},selectionRayOrigin:{name:"pickOrigin"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"asset",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:true},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:true},{input:"object",output:"pickedMesh",inputBlockIndex:2,outputBlockIndex:0,isVariable:true}],extraProcessor(e,o,n,i,t,a,s){const r=t[t.length-1];r.config=r.config||{},r.config.glTF=s;const l=e.configuration?.nodeIndex?.value[0];if(void 0===l||"number"!=typeof l)throw new Error("nodeIndex not found in configuration");const c="pickedMesh_"+l;return t[1].config.variable=c,a._userVariables[c]={className:"Mesh",id:s?.nodes?.[l]._babylonTransformNode?.id,uniqueId:s?.nodes?.[l]._babylonTransformNode?.uniqueId},t}}),C$a("/nodes/{}/extensions/KHR_node_selectability/selectable",{get:e=>{const o=e._babylonTransformNode;return !o||void 0===o.isPickable||o.isPickable},set:(e,o)=>{o._primitiveBabylonMeshes?.forEach((o=>{o.isPickable=e;}));},getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"isPickable"],type:"boolean"});let a$y=class a{constructor(e){this.name=t$u,this._loader=e,this.enabled=e.isExtensionUsed(t$u);}async onReady(){this._loader.gltf.nodes?.forEach((e=>{e.extensions?.KHR_node_selectability&&false===e.extensions?.KHR_node_selectability.selectable&&e._babylonTransformNode?.getChildMeshes().forEach((e=>{e.isPickable=false;}));}));}dispose(){this._loader=null;}};fc(t$u),_c(t$u,true,(e=>new a$y(e)));var KHR_node_selectabilityDPnTqtNB_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,KHR_node_selectability:a$y});const J$3={effect:null,subMesh:null};let $$3=class $ extends(cl(Eh)){};let q$3=class q extends(Rh($$3)){constructor(e){super(e),this.DIFFUSE=false,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=false,this.AMBIENT=false,this.AMBIENTDIRECTUV=0,this.OPACITY=false,this.OPACITYDIRECTUV=0,this.OPACITYRGB=false,this.REFLECTION=false,this.EMISSIVE=false,this.EMISSIVEDIRECTUV=0,this.SPECULAR=false,this.SPECULARDIRECTUV=0,this.BUMP=false,this.BUMPDIRECTUV=0,this.PARALLAX=false,this.PARALLAX_RHS=false,this.PARALLAXOCCLUSION=false,this.SPECULAROVERALPHA=false,this.CLIPPLANE=false,this.CLIPPLANE2=false,this.CLIPPLANE3=false,this.CLIPPLANE4=false,this.CLIPPLANE5=false,this.CLIPPLANE6=false,this.ALPHATEST=false,this.DEPTHPREPASS=false,this.ALPHAFROMDIFFUSE=false,this.POINTSIZE=false,this.FOG=false,this.SPECULARTERM=false,this.DIFFUSEFRESNEL=false,this.OPACITYFRESNEL=false,this.REFLECTIONFRESNEL=false,this.REFRACTIONFRESNEL=false,this.EMISSIVEFRESNEL=false,this.FRESNEL=false,this.NORMAL=false,this.TANGENT=false,this.VERTEXCOLOR=false,this.VERTEXALPHA=false,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=false,this.BONES_VELOCITY_ENABLED=false,this.INSTANCES=false,this.THIN_INSTANCES=false,this.INSTANCESCOLOR=false,this.GLOSSINESS=false,this.ROUGHNESS=false,this.EMISSIVEASILLUMINATION=false,this.LINKEMISSIVEWITHDIFFUSE=false,this.REFLECTIONFRESNELFROMSPECULAR=false,this.LIGHTMAP=false,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=false,this.USELIGHTMAPASSHADOWMAP=false,this.REFLECTIONMAP_3D=false,this.REFLECTIONMAP_SPHERICAL=false,this.REFLECTIONMAP_PLANAR=false,this.REFLECTIONMAP_CUBIC=false,this.USE_LOCAL_REFLECTIONMAP_CUBIC=false,this.USE_LOCAL_REFRACTIONMAP_CUBIC=false,this.REFLECTIONMAP_PROJECTION=false,this.REFLECTIONMAP_SKYBOX=false,this.REFLECTIONMAP_EXPLICIT=false,this.REFLECTIONMAP_EQUIRECTANGULAR=false,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false,this.REFLECTIONMAP_OPPOSITEZ=false,this.INVERTCUBICMAP=false,this.LOGARITHMICDEPTH=false,this.REFRACTION=false,this.REFRACTIONMAP_3D=false,this.REFLECTIONOVERALPHA=false,this.TWOSIDEDLIGHTING=false,this.SHADOWFLOAT=false,this.MORPHTARGETS=false,this.MORPHTARGETS_POSITION=false,this.MORPHTARGETS_NORMAL=false,this.MORPHTARGETS_TANGENT=false,this.MORPHTARGETS_UV=false,this.MORPHTARGETS_UV2=false,this.MORPHTARGETS_COLOR=false,this.MORPHTARGETTEXTURE_HASPOSITIONS=false,this.MORPHTARGETTEXTURE_HASNORMALS=false,this.MORPHTARGETTEXTURE_HASTANGENTS=false,this.MORPHTARGETTEXTURE_HASUVS=false,this.MORPHTARGETTEXTURE_HASUV2S=false,this.MORPHTARGETTEXTURE_HASCOLORS=false,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=false,this.NONUNIFORMSCALING=false,this.PREMULTIPLYALPHA=false,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=false,this.ALPHABLEND=true,this.PREPASS=false,this.PREPASS_COLOR=false,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=false,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=false,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=false,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=false,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=false,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=false,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=false,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=false,this.PREPASS_WORLD_NORMAL=false,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=false,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=false,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=false,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=false,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=false,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=false,this.RGBDREFLECTION=false,this.RGBDREFRACTION=false,this.MULTIVIEW=false,this.ORDER_INDEPENDENT_TRANSPARENCY=false,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=false,this.CAMERA_ORTHOGRAPHIC=false,this.CAMERA_PERSPECTIVE=false,this.AREALIGHTSUPPORTED=true,this.USE_VERTEX_PULLING=false,this.CLUSTLIGHT_SLICES=0,this.CLUSTLIGHT_BATCH=0,this.IS_REFLECTION_LINEAR=false,this.IS_REFRACTION_LINEAR=false,this.DECAL_AFTER_DETAIL=false,this.rebuild();}};let ee$2=class ee extends(bh(Ah)){};let te$2=class te extends ee$2{get isPrePassCapable(){return !this.disableDepthWrite}get canRenderToMRT(){return  true}constructor(r,a,n=false){super(r,a,void 0,n||te.ForceGLSL),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new ge$3(0,0,0),this.diffuseColor=new ge$3(1,1,1),this.specularColor=new ge$3(1,1,1),this.emissiveColor=new ge$3(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=false,this._useEmissiveAsIllumination=false,this._linkEmissiveWithDiffuse=false,this._useSpecularOverAlpha=false,this._useReflectionOverAlpha=false,this._disableLighting=false,this._useObjectSpaceNormalMap=false,this._useParallax=false,this._useParallaxOcclusion=false,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=true,this.alphaCutOff=.4,this._useLightmapAsShadowmap=false,this._useReflectionFresnelFromSpecular=false,this._useGlossinessFromSpecularMapAlpha=false,this._maxSimultaneousLights=4,this._invertNormalMapX=false,this._invertNormalMapY=false,this._twoSidedLighting=false,this._applyDecalMapAfterDetailMap=false,this._shadersLoaded=false,this._renderTargets=new Ii(16),this._globalAmbientColor=new ge$3(0,0,0),this._cacheHasRenderTargetTextures=false,this.detailMap=new ol(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Kh,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),te.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),te.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets);}get hasRenderTargetTextures(){return !!(te.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||(!!(te.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures)}getClassName(){return "StandardMaterial"}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===hr$1.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==hr$1.MATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=false){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return  true;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new q$3(this._eventInfo.defineNames));const C=this.getScene(),v=t.materialDefines;if(this._isReadyForSubMesh(t))return  true;const g=C.getEngine();v._needNormals=Qs(C,e,v,true,this._maxSimultaneousLights,this._disableLighting),er$1(C,v);const F=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(ir$1(C,v,this.canRenderToMRT&&!F),tr$1(C,v,F),ll.PrepareDefines(g.currentRenderPassId,e,v),v._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=false,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,v._needUVs=false;for(let e=1;e<=Qe$1.MAX_SUPPORTED_UV_SETS;++e)v["MAINUV"+e]=false;if(C.texturesEnabled){if(v.DIFFUSEDIRECTUV=0,v.BUMPDIRECTUV=0,v.AMBIENTDIRECTUV=0,v.OPACITYDIRECTUV=0,v.EMISSIVEDIRECTUV=0,v.SPECULARDIRECTUV=0,v.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&te.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return  false;ks(this._diffuseTexture,v,"DIFFUSE");}else v.DIFFUSE=false;if(this._ambientTexture&&te.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return  false;ks(this._ambientTexture,v,"AMBIENT");}else v.AMBIENT=false;if(this._opacityTexture&&te.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return  false;ks(this._opacityTexture,v,"OPACITY"),v.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;}else v.OPACITY=false;if(this._reflectionTexture&&te.ReflectionTextureEnabled?(v.ROUGHNESS=this._roughness>0,v.REFLECTIONOVERALPHA=this._useReflectionOverAlpha):(v.ROUGHNESS=false,v.REFLECTIONOVERALPHA=false),!qs(C,this._reflectionTexture,v))return  false;if(this._emissiveTexture&&te.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return  false;ks(this._emissiveTexture,v,"EMISSIVE");}else v.EMISSIVE=false;if(this._lightmapTexture&&te.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return  false;ks(this._lightmapTexture,v,"LIGHTMAP"),v.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,v.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;}else v.LIGHTMAP=false;if(this._specularTexture&&te.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return  false;ks(this._specularTexture,v,"SPECULAR"),v.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;}else v.SPECULAR=false;if(C.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&te.BumpTextureEnabled){if(!this._bumpTexture.isReady())return  false;ks(this._bumpTexture,v,"BUMP"),v.PARALLAX=this._useParallax,v.PARALLAX_RHS=C.useRightHandedSystem,v.PARALLAXOCCLUSION=this._useParallaxOcclusion,v.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap;}else v.BUMP=false,v.PARALLAX=false,v.PARALLAX_RHS=false,v.PARALLAXOCCLUSION=false;if(this._refractionTexture&&te.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return  false;v._needUVs=true,v.REFRACTION=true,v.REFRACTIONMAP_3D=this._refractionTexture.isCube,v.RGBDREFRACTION=this._refractionTexture.isRGBD,v.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;}else v.REFRACTION=false;v.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting;}else v.DIFFUSE=false,v.AMBIENT=false,v.OPACITY=false,v.REFLECTION=false,v.EMISSIVE=false,v.LIGHTMAP=false,v.BUMP=false,v.REFRACTION=false;v.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),v.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,v.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,v.SPECULAROVERALPHA=this._useSpecularOverAlpha,v.PREMULTIPLYALPHA=this.alphaMode===Qe$1.ALPHA_PREMULTIPLIED||this.alphaMode===Qe$1.ALPHA_PREMULTIPLIED_PORTERDUFF,v.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,v.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e);}if(this._eventInfo.isReadyForSubMesh=true,this._eventInfo.defines=v,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return  false;if(v._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return  false;this._imageProcessingConfiguration.prepareDefines(v),v.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,v.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace;}if(v._areFresnelDirty&&(te.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(v.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,v.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,v.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,v.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,v.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,v.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,v._needNormals=true,v.FRESNEL=true):v.FRESNEL=false),v.AREALIGHTUSED||v.CLUSTLIGHT_BATCH)for(let t=0;t<e.lightSources.length;t++)if(!e.lightSources[t]._isReady())return  false;js(e,C,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),v,this._applyDecalMapAfterDetailMap,this._useVertexPulling,t.getRenderingMesh(),this._isVertexOutputInvariant),Js(C,g,this,v,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=v,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),$s(e,v,true,true,true),this._callbackPluginEventPrepareDefines(this._eventInfo);let M=false;if(v.isDirty){const i=v._areLightsDisposed;v.markAsProcessed();const r=new ro;v.REFLECTION&&r.addFallback(0,"REFLECTION"),v.SPECULAR&&r.addFallback(0,"SPECULAR"),v.BUMP&&r.addFallback(0,"BUMP"),v.PARALLAX&&r.addFallback(1,"PARALLAX"),v.PARALLAX_RHS&&r.addFallback(1,"PARALLAX_RHS"),v.PARALLAXOCCLUSION&&r.addFallback(0,"PARALLAXOCCLUSION"),v.SPECULAROVERALPHA&&r.addFallback(0,"SPECULAROVERALPHA"),v.FOG&&r.addFallback(1,"FOG"),v.POINTSIZE&&r.addFallback(0,"POINTSIZE"),v.LOGARITHMICDEPTH&&r.addFallback(0,"LOGARITHMICDEPTH"),Ks(v,r,this._maxSimultaneousLights),v.SPECULARTERM&&r.addFallback(0,"SPECULARTERM"),v.DIFFUSEFRESNEL&&r.addFallback(1,"DIFFUSEFRESNEL"),v.OPACITYFRESNEL&&r.addFallback(2,"OPACITYFRESNEL"),v.REFLECTIONFRESNEL&&r.addFallback(3,"REFLECTIONFRESNEL"),v.EMISSIVEFRESNEL&&r.addFallback(4,"EMISSIVEFRESNEL"),v.FRESNEL&&r.addFallback(4,"FRESNEL"),v.MULTIVIEW&&r.addFallback(0,"MULTIVIEW");const a=[Hi.PositionKind];v.NORMAL&&a.push(Hi.NormalKind),v.TANGENT&&a.push(Hi.TangentKind);for(let e=1;e<=Qe$1.MAX_SUPPORTED_UV_SETS;++e)v["UV"+e]&&a.push(`uv${1===e?"":e}`);v.VERTEXCOLOR&&a.push(Hi.ColorKind),Ws(a,e,v,r),Ys(a,v),Ls(a,e,v),Vs(a,e,v);let n="default";const o=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"],l=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"];rr$1(o,l,false);const T=["Material","Scene","Mesh"],p={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:v.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=r,this._eventInfo.fallbackRank=0,this._eventInfo.defines=v,this._eventInfo.uniforms=o,this._eventInfo.attributes=a,this._eventInfo.samplers=l,this._eventInfo.uniformBuffersNames=T,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=p,this._callbackPluginEventGeneric(128,this._eventInfo),ll.AddUniformsAndSamplers(o,l),Kh.AddUniforms(o),En&&(En.PrepareUniforms(o,v),En.PrepareSamplers(l,v)),nr$1({uniformsNames:o,uniformBuffersNames:T,samplers:l,defines:v,maxSimultaneousLights:this._maxSimultaneousLights}),Ts(o);const d={};this.customShaderNameResolve&&(n=this.customShaderNameResolve(n,o,T,l,v,a,d));const f=v.toString(),E=t.effect;let F=C.getEngine().createEffect(n,{attributes:a,uniformsNames:o,uniformBuffersNames:T,samplers:l,defines:f,fallbacks:r,onCompiled:this.onCompiled,onError:this.onError,indexParameters:p,processFinalCode:d.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:v.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(function(){return default_vertexFqVi9KMV_esm_min}),Promise.resolve().then(function(){return default_fragmentC3Z3IUVr_esm_min})]):await Promise.all([Promise.resolve().then(function(){return default_vertexDPjt2Ech_esm_min}),Promise.resolve().then(function(){return default_fragmentBR2WfKiF_esm_min})]),this._shadersLoaded=true;}},g);if(this._eventInfo.customCode=void 0,F)if(this._onEffectCreatedObservable&&(J$3.effect=F,J$3.subMesh=t,this._onEffectCreatedObservable.notifyObservers(J$3)),this.allowShaderHotSwapping&&E&&!F.isReady()){if(F=E,v.markAsUnprocessed(),M=this.isFrozen,i)return v._areLightsDisposed=true,false}else C.resetCachedMaterial(),t.setEffect(F,v,this._materialContext);}return !(!t.effect||!t.effect.isReady())&&(v._renderId=C.getRenderId(),r._wasPreviouslyReady=!M,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),true)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),e.addUniform("cameraInfo",4),ar$1(e,false,true),super.buildUniformLayout();}bindForSubMesh(t,i,s){const r=this.getScene(),a=s.materialDefines;if(!a)return;const n=s.effect;if(!n)return;this._activeEffect=n,i.getMeshUniformBuffer().bindToEffect(n,"Mesh"),i.transferToEffect(t),this._uniformBuffer.bindToEffect(n,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,i,t,this.isFrozen),ll.Bind(r.getEngine().currentRenderPassId,this._activeEffect,i,t,this);const o=r.activeCamera;o?this._uniformBuffer.updateFloat4("cameraInfo",o.minZ,o.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=s,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),a.OBJECTSPACE_NORMALMAP&&(t.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=this._mustRebind(r,n,s,i.visibility);Hs(i,n);const h=this._uniformBuffer;if(l){if(this.bindViewProjection(n),!h.useUbo||!this.isFrozen||!h.isSync||s._drawWrapper._forceRebindOnNextCall){if(te.FresnelEnabled&&a.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(h.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),h.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&h.updateColor4("opacityParts",new ge$3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(h.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),h.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(h.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),h.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(h.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),h.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled&&(this._diffuseTexture&&te.DiffuseTextureEnabled&&(h.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),Gs(this._diffuseTexture,h,"diffuse")),this._ambientTexture&&te.AmbientTextureEnabled&&(h.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),Gs(this._ambientTexture,h,"ambient")),this._opacityTexture&&te.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),Gs(this._opacityTexture,h,"opacity")),this._hasAlphaChannel()&&h.updateFloat("alphaCutOff",this.alphaCutOff),Bs(r,a,h,ge$3.White(),this._reflectionTexture,false,false,true,false,false,false,this.roughness),this._reflectionTexture&&te.ReflectionTextureEnabled||h.updateFloat2("vReflectionInfos",0,this.roughness),this._emissiveTexture&&te.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),Gs(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&te.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),Gs(this._lightmapTexture,h,"lightmap")),this._specularTexture&&te.SpecularTextureEnabled&&(h.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),Gs(this._specularTexture,h,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&te.BumpTextureEnabled&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),Gs(this._bumpTexture,h,"bump"),r._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&te.RefractionTextureEnabled)){let e=1;if(this._refractionTexture.isCube||(h.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(e=this._refractionTexture.depth)),h.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,e,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const e=this._refractionTexture;h.updateVector3("vRefractionPosition",e.boundingBoxPosition),h.updateVector3("vRefractionSize",e.boundingBoxSize);}}this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),h.updateColor4("vSpecularColor",this.specularColor,this.specularPower),h.updateColor3("vEmissiveColor",te.EmissiveTextureEnabled?this.emissiveColor:ge$3.BlackReadOnly),h.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor);}r.texturesEnabled&&(this._diffuseTexture&&te.DiffuseTextureEnabled&&n.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&te.AmbientTextureEnabled&&n.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&te.OpacityTextureEnabled&&n.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&te.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?n.setTexture("reflectionCubeSampler",this._reflectionTexture):n.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&te.EmissiveTextureEnabled&&n.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&te.LightmapTextureEnabled&&n.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&te.SpecularTextureEnabled&&n.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&te.BumpTextureEnabled&&n.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&te.RefractionTextureEnabled&&(this._refractionTexture.isCube?n.setTexture("refractionCubeSampler",this._refractionTexture):n.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(i)&&this.getScene().depthPeelingRenderer.bind(n),this._eventInfo.subMesh=s,this._callbackPluginEventBindForSubMesh(this._eventInfo),As(n,this,r),this.bindEyePosition(n);}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=true);!l&&this.isFrozen||(r.lightsEnabled&&!this._disableLighting&&Xs(r,i,n,a,this._maxSimultaneousLights),(r.fogEnabled&&i.applyFog&&r.fogMode!==ch.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||i.receiveShadows||a.PREPASS||a.CLUSTLIGHT_BATCH)&&this.bindView(n),Os(r,i,n),a.NUM_MORPH_INFLUENCERS&&ws(i,n),a.BAKED_VERTEX_ANIMATION_TEXTURE&&i.bakedVertexAnimationManager?.bind(n,a.INSTANCES),this.useLogarithmicDepth&&Cs(a,n,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(i,this._activeEffect,s),h.update();}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return !!super.hasTexture(e)||(this._diffuseTexture===e||(this._ambientTexture===e||(this._opacityTexture===e||(this._reflectionTexture===e||(this._emissiveTexture===e||(this._specularTexture===e||(this._bumpTexture===e||(this._lightmapTexture===e||this._refractionTexture===e))))))))}dispose(e,t){t&&(this._diffuseTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._specularTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._refractionTexture?.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t);}clone(e,t=true,i=""){const s=Ae$3.Clone((()=>new te(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.name=e,s.id=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}static Parse(e,t,i){const s=Ae$3.Parse((()=>new te(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),hr$1._ParsePlugins(e,s,t,i),s}static get DiffuseTextureEnabled(){return bs.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){bs.DiffuseTextureEnabled=e;}static get DetailTextureEnabled(){return bs.DetailTextureEnabled}static set DetailTextureEnabled(e){bs.DetailTextureEnabled=e;}static get AmbientTextureEnabled(){return bs.AmbientTextureEnabled}static set AmbientTextureEnabled(e){bs.AmbientTextureEnabled=e;}static get OpacityTextureEnabled(){return bs.OpacityTextureEnabled}static set OpacityTextureEnabled(e){bs.OpacityTextureEnabled=e;}static get ReflectionTextureEnabled(){return bs.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){bs.ReflectionTextureEnabled=e;}static get EmissiveTextureEnabled(){return bs.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){bs.EmissiveTextureEnabled=e;}static get SpecularTextureEnabled(){return bs.SpecularTextureEnabled}static set SpecularTextureEnabled(e){bs.SpecularTextureEnabled=e;}static get BumpTextureEnabled(){return bs.BumpTextureEnabled}static set BumpTextureEnabled(e){bs.BumpTextureEnabled=e;}static get LightmapTextureEnabled(){return bs.LightmapTextureEnabled}static set LightmapTextureEnabled(e){bs.LightmapTextureEnabled=e;}static get RefractionTextureEnabled(){return bs.RefractionTextureEnabled}static set RefractionTextureEnabled(e){bs.RefractionTextureEnabled=e;}static get ColorGradingTextureEnabled(){return bs.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){bs.ColorGradingTextureEnabled=e;}static get FresnelEnabled(){return bs.FresnelEnabled}static set FresnelEnabled(e){bs.FresnelEnabled=e;}};te$2.ForceGLSL=false,e$z([o$19("diffuseTexture")],te$2.prototype,"_diffuseTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesAndMiscDirty")],te$2.prototype,"diffuseTexture",void 0),e$z([o$19("ambientTexture")],te$2.prototype,"_ambientTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"ambientTexture",void 0),e$z([o$19("opacityTexture")],te$2.prototype,"_opacityTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesAndMiscDirty")],te$2.prototype,"opacityTexture",void 0),e$z([o$19("reflectionTexture")],te$2.prototype,"_reflectionTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"reflectionTexture",void 0),e$z([o$19("emissiveTexture")],te$2.prototype,"_emissiveTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"emissiveTexture",void 0),e$z([o$19("specularTexture")],te$2.prototype,"_specularTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"specularTexture",void 0),e$z([o$19("bumpTexture")],te$2.prototype,"_bumpTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"bumpTexture",void 0),e$z([o$19("lightmapTexture")],te$2.prototype,"_lightmapTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"lightmapTexture",void 0),e$z([o$19("refractionTexture")],te$2.prototype,"_refractionTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"refractionTexture",void 0),e$z([h$c("ambient")],te$2.prototype,"ambientColor",void 0),e$z([h$c("diffuse")],te$2.prototype,"diffuseColor",void 0),e$z([h$c("specular")],te$2.prototype,"specularColor",void 0),e$z([h$c("emissive")],te$2.prototype,"emissiveColor",void 0),e$z([a$$()],te$2.prototype,"specularPower",void 0),e$z([a$$("useAlphaFromDiffuseTexture")],te$2.prototype,"_useAlphaFromDiffuseTexture",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesAndMiscDirty")],te$2.prototype,"useAlphaFromDiffuseTexture",void 0),e$z([a$$("useEmissiveAsIllumination")],te$2.prototype,"_useEmissiveAsIllumination",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"useEmissiveAsIllumination",void 0),e$z([a$$("linkEmissiveWithDiffuse")],te$2.prototype,"_linkEmissiveWithDiffuse",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"linkEmissiveWithDiffuse",void 0),e$z([a$$("useSpecularOverAlpha")],te$2.prototype,"_useSpecularOverAlpha",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"useSpecularOverAlpha",void 0),e$z([a$$("useReflectionOverAlpha")],te$2.prototype,"_useReflectionOverAlpha",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"useReflectionOverAlpha",void 0),e$z([a$$("disableLighting")],te$2.prototype,"_disableLighting",void 0),e$z([n$1W("_markAllSubMeshesAsLightsDirty")],te$2.prototype,"disableLighting",void 0),e$z([a$$("useObjectSpaceNormalMap")],te$2.prototype,"_useObjectSpaceNormalMap",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"useObjectSpaceNormalMap",void 0),e$z([a$$("useParallax")],te$2.prototype,"_useParallax",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"useParallax",void 0),e$z([a$$("useParallaxOcclusion")],te$2.prototype,"_useParallaxOcclusion",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"useParallaxOcclusion",void 0),e$z([a$$()],te$2.prototype,"parallaxScaleBias",void 0),e$z([a$$("roughness")],te$2.prototype,"_roughness",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"roughness",void 0),e$z([a$$()],te$2.prototype,"indexOfRefraction",void 0),e$z([a$$()],te$2.prototype,"invertRefractionY",void 0),e$z([a$$()],te$2.prototype,"alphaCutOff",void 0),e$z([a$$("useLightmapAsShadowmap")],te$2.prototype,"_useLightmapAsShadowmap",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"useLightmapAsShadowmap",void 0),e$z([l$r("diffuseFresnelParameters")],te$2.prototype,"_diffuseFresnelParameters",void 0),e$z([n$1W("_markAllSubMeshesAsFresnelDirty")],te$2.prototype,"diffuseFresnelParameters",void 0),e$z([l$r("opacityFresnelParameters")],te$2.prototype,"_opacityFresnelParameters",void 0),e$z([n$1W("_markAllSubMeshesAsFresnelAndMiscDirty")],te$2.prototype,"opacityFresnelParameters",void 0),e$z([l$r("reflectionFresnelParameters")],te$2.prototype,"_reflectionFresnelParameters",void 0),e$z([n$1W("_markAllSubMeshesAsFresnelDirty")],te$2.prototype,"reflectionFresnelParameters",void 0),e$z([l$r("refractionFresnelParameters")],te$2.prototype,"_refractionFresnelParameters",void 0),e$z([n$1W("_markAllSubMeshesAsFresnelDirty")],te$2.prototype,"refractionFresnelParameters",void 0),e$z([l$r("emissiveFresnelParameters")],te$2.prototype,"_emissiveFresnelParameters",void 0),e$z([n$1W("_markAllSubMeshesAsFresnelDirty")],te$2.prototype,"emissiveFresnelParameters",void 0),e$z([a$$("useReflectionFresnelFromSpecular")],te$2.prototype,"_useReflectionFresnelFromSpecular",void 0),e$z([n$1W("_markAllSubMeshesAsFresnelDirty")],te$2.prototype,"useReflectionFresnelFromSpecular",void 0),e$z([a$$("useGlossinessFromSpecularMapAlpha")],te$2.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"useGlossinessFromSpecularMapAlpha",void 0),e$z([a$$("maxSimultaneousLights")],te$2.prototype,"_maxSimultaneousLights",void 0),e$z([n$1W("_markAllSubMeshesAsLightsDirty")],te$2.prototype,"maxSimultaneousLights",void 0),e$z([a$$("invertNormalMapX")],te$2.prototype,"_invertNormalMapX",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"invertNormalMapX",void 0),e$z([a$$("invertNormalMapY")],te$2.prototype,"_invertNormalMapY",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"invertNormalMapY",void 0),e$z([a$$("twoSidedLighting")],te$2.prototype,"_twoSidedLighting",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],te$2.prototype,"twoSidedLighting",void 0),e$z([a$$("applyDecalMapAfterDetailMap")],te$2.prototype,"_applyDecalMapAfterDetailMap",void 0),e$z([n$1W("_markAllSubMeshesAsMiscDirty")],te$2.prototype,"applyDecalMapAfterDetailMap",void 0),P$9("BABYLON.StandardMaterial",te$2),ch.DefaultMaterialFactory=e=>new te$2("default material",e);let u$b=class u{constructor(){this.materials=[];}parseMTL(t,e,i,o){if(e instanceof ArrayBuffer)return;const r=e.split("\n"),n=/\s+/;let a,l=null;for(let e=0;e<r.length;e++){const h=r[e].trim();if(0===h.length||"#"===h.charAt(0))continue;const _=h.indexOf(" ");let p=_>=0?h.substring(0,_):h;p=p.toLowerCase();const m=_>=0?h.substring(_+1).trim():"";if("newmtl"===p)l&&this.materials.push(l),t._blockEntityCollection=!!o,l=new te$2(m,t),l._parentContainer=o,t._blockEntityCollection=false;else if("kd"===p&&l)a=m.split(n,3).map(parseFloat),l.diffuseColor=ge$3.FromArray(a);else if("ka"===p&&l)a=m.split(n,3).map(parseFloat),l.ambientColor=ge$3.FromArray(a);else if("ks"===p&&l)a=m.split(n,3).map(parseFloat),l.specularColor=ge$3.FromArray(a);else if("ke"===p&&l)a=m.split(n,3).map(parseFloat),l.emissiveColor=ge$3.FromArray(a);else if("ns"===p&&l)l.specularPower=parseFloat(m);else if("d"===p&&l)l.alpha=parseFloat(m);else if("map_ka"===p&&l)l.ambientTexture=u._GetTexture(i,m,t);else if("map_kd"===p&&l)l.diffuseTexture=u._GetTexture(i,m,t);else if("map_ks"===p&&l)l.specularTexture=u._GetTexture(i,m,t);else if("map_ns"===p);else if("map_bump"===p&&l){const s=m.split(n),e=s.indexOf("-bm");let o=null;e>=0&&(o=s[e+1],s.splice(e,2)),l.bumpTexture=u._GetTexture(i,s.join(" "),t),l.bumpTexture&&null!==o&&(l.bumpTexture.level=parseFloat(o));}else "map_d"===p&&l&&(l.opacityTexture=u._GetTexture(i,m,t));}l&&this.materials.push(l);}static _GetTexture(s,e,i){if(!e)return null;let o=s;if("file:"===s){let s=e.lastIndexOf("\\");-1===s&&(s=e.lastIndexOf("/")),o+=s>-1?e.substring(s+1):e;}else o+=e;return new Is(o,i,false,u.INVERT_TEXTURE_Y)}};u$b.INVERT_TEXTURE_Y=true;let F$3=class F{constructor(s,t,i){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._extColors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=false,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=true,this._grayColor=new me$3(.5,.5,.5,1),this._hasLineData=false,this._materialToUse=s,this._babylonMeshesArray=t,this._loadingOptions=i;}_isInArray(s,t){s[t[0]]||(s[t[0]]={normals:[],idx:[]});const e=s[t[0]].normals.indexOf(t[1]);return  -1===e?-1:s[t[0]].idx[e]}_isInArrayUV(s,t){s[t[0]]||(s[t[0]]={normals:[],idx:[],uv:[]});const e=s[t[0]].normals.indexOf(t[1]);return 1!=e&&t[2]===s[t[0]].uv[e]?s[t[0]].idx[e]:-1}_setData(s){let t;s.indiceUvsFromObj??=-1,s.indiceNormalFromObj??=-1,t=this._loadingOptions.optimizeWithUV?this._isInArrayUV(this._tuplePosNorm,[s.indicePositionFromObj,s.indiceNormalFromObj,s.indiceUvsFromObj]):this._isInArray(this._tuplePosNorm,[s.indicePositionFromObj,s.indiceNormalFromObj]),-1===t?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(s.positionVectorFromOBJ),void 0!==s.textureVectorFromOBJ&&this._wrappedUvsForBabylon.push(s.textureVectorFromOBJ),void 0!==s.normalsVectorFromOBJ&&this._wrappedNormalsForBabylon.push(s.normalsVectorFromOBJ),void 0!==s.positionColorsFromOBJ&&this._wrappedColorsForBabylon.push(s.positionColorsFromOBJ),this._tuplePosNorm[s.indicePositionFromObj].normals.push(s.indiceNormalFromObj),this._tuplePosNorm[s.indicePositionFromObj].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[s.indicePositionFromObj].uv.push(s.indiceUvsFromObj)):this._indicesForBabylon.push(t);}_unwrapData(){try{for(let s=0;s<this._wrappedPositionForBabylon.length;s++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[s].x*this._handednessSign,this._wrappedPositionForBabylon[s].y,this._wrappedPositionForBabylon[s].z),this._wrappedNormalsForBabylon.length&&this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[s].x*this._handednessSign,this._wrappedNormalsForBabylon[s].y,this._wrappedNormalsForBabylon[s].z),this._wrappedUvsForBabylon.length&&this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[s].x,this._wrappedUvsForBabylon[s].y),this._unwrappedColorsForBabylon.length&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[s].r,this._wrappedColorsForBabylon[s].g,this._wrappedColorsForBabylon[s].b,this._wrappedColorsForBabylon[s].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0;}catch(s){throw new Error("Unable to unwrap data while parsing OBJ data.")}}_getTriangles(s,t){for(let e=t;e<s.length-1;e++)this._pushTriangle(s,e);}_getColor(s){return this._loadingOptions.importVertexColors?this._extColors[s]??this._colors[s]:void 0}_setDataForCurrentFaceWithPattern1(s,t){this._getTriangles(s,t);for(let s=0;s<this._triangles.length;s++){const t=parseInt(this._triangles[s])-1;this._setData({indicePositionFromObj:t,positionVectorFromOBJ:this._positions[t],positionColorsFromOBJ:this._getColor(t)});}this._triangles.length=0;}_setDataForCurrentFaceWithPattern2(s,t){this._getTriangles(s,t);for(let s=0;s<this._triangles.length;s++){const t=this._triangles[s].split("/"),e=parseInt(t[0])-1,i=parseInt(t[1])-1;this._setData({indicePositionFromObj:e,indiceUvsFromObj:i,positionVectorFromOBJ:this._positions[e],textureVectorFromOBJ:this._uvs[i],positionColorsFromOBJ:this._getColor(e)});}this._triangles.length=0;}_setDataForCurrentFaceWithPattern3(s,t){this._getTriangles(s,t);for(let s=0;s<this._triangles.length;s++){const t=this._triangles[s].split("/"),e=parseInt(t[0])-1,i=parseInt(t[1])-1,o=parseInt(t[2])-1;this._setData({indicePositionFromObj:e,indiceUvsFromObj:i,indiceNormalFromObj:o,positionVectorFromOBJ:this._positions[e],textureVectorFromOBJ:this._uvs[i],normalsVectorFromOBJ:this._normals[o]});}this._triangles.length=0;}_setDataForCurrentFaceWithPattern4(s,t){this._getTriangles(s,t);for(let s=0;s<this._triangles.length;s++){const t=this._triangles[s].split("//"),e=parseInt(t[0])-1,i=parseInt(t[1])-1;this._setData({indicePositionFromObj:e,indiceNormalFromObj:i,positionVectorFromOBJ:this._positions[e],normalsVectorFromOBJ:this._normals[i],positionColorsFromOBJ:this._getColor(e)});}this._triangles.length=0;}_setDataForCurrentFaceWithPattern5(s,t){this._getTriangles(s,t);for(let s=0;s<this._triangles.length;s++){const t=this._triangles[s].split("/"),e=this._positions.length+parseInt(t[0]),i=this._uvs.length+parseInt(t[1]),o=this._normals.length+parseInt(t[2]);this._setData({indicePositionFromObj:e,indiceUvsFromObj:i,indiceNormalFromObj:o,positionVectorFromOBJ:this._positions[e],textureVectorFromOBJ:this._uvs[i],normalsVectorFromOBJ:this._normals[o],positionColorsFromOBJ:this._getColor(e)});}this._triangles.length=0;}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._unwrappedNormalsForBabylon.length&&(this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice()),this._unwrappedUVForBabylon.length&&(this._handledMesh.uvs=this._unwrappedUVForBabylon.slice()),this._unwrappedColorsForBabylon.length&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._handledMesh.hasLines=this._hasLineData,this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0,this._hasLineData=false);}_optimizeNormals(s){const t=s.getVerticesData(Hi.PositionKind),e=s.getVerticesData(Hi.NormalKind),r={};if(!t||!e)return;for(let s=0;s<t.length/3;s++){const e=t[3*s+0]+"_"+t[3*s+1]+"_"+t[3*s+2];let i=r[e];i||(i=[],r[e]=i),i.push(s);}const n=new te$4;for(const s in r){const t=r[s];if(t.length<2)continue;const i=t[0];for(let s=1;s<t.length;++s){const o=t[s];e[3*i+0]+=e[3*o+0],e[3*i+1]+=e[3*o+1],e[3*i+2]+=e[3*o+2];}n.copyFromFloats(e[3*i+0],e[3*i+1],e[3*i+2]),n.normalize();for(let s=0;s<t.length;++s){const i=t[s];e[3*i+0]=n.x,e[3*i+1]=n.y,e[3*i+2]=n.z;}}s.setVerticesData(Hi.NormalKind,e);}static _IsLineElement(s){return s.startsWith("l")}static _IsObjectElement(s){return s.startsWith("o")}static _IsGroupElement(s){return s.startsWith("g")}static _GetZbrushMRGB(s,t){if(!s.startsWith("mrgb"))return null;if(s=s.replace("mrgb","").trim(),t)return [];const i=s.match(/[a-z0-9]/g);if(!i||i.length%8!=0)return [];const o=[];for(let s=0;s<i.length/8;s++){const t=i[8*s+2]+i[8*s+3],r=i[8*s+4]+i[8*s+5],n=i[8*s+6]+i[8*s+7];o.push(new me$3(parseInt(t,16)/255,parseInt(r,16)/255,parseInt(n,16)/255,1));}return o}parse(t,i,_,p,m){i=(i=i.replace(/#MRGB/g,"mrgb")).replace(/#.*$/gm,"").trim(),this._loadingOptions.useLegacyBehavior?(this._pushTriangle=(s,t)=>this._triangles.push(s[0],s[t],s[t+1]),this._handednessSign=1):_.useRightHandedSystem?(this._pushTriangle=(s,t)=>this._triangles.push(s[0],s[t+1],s[t]),this._handednessSign=1):(this._pushTriangle=(s,t)=>this._triangles.push(s[0],s[t],s[t+1]),this._handednessSign=-1);const d=i.split("\n"),u=[];let b=[];u.push(b);for(let s=0;s<d.length;s++){const t=d[s].trim().replace(/\s\s/g," ");if(0!==t.length&&"#"!==t.charAt(0))if((F._IsGroupElement(t)||F._IsObjectElement(t))&&(b=[],u.push(b)),F._IsLineElement(t)){const s=t.split(" ");for(let t=1;t<s.length-1;t++)b.push(`l ${s[t]} ${s[t+1]}`);}else b.push(t);}const g=u.flat();for(let s=0;s<g.length;s++){const t=g[s].trim().replace(/\s\s/g," ");let i;if(0!==t.length&&"#"!==t.charAt(0))if(F.VertexPattern.test(t)){if(i=t.match(/[^ ]+/g),this._positions.push(new te$4(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]))),this._loadingOptions.importVertexColors)if(i.length>=7){const s=parseFloat(i[4]),t=parseFloat(i[5]),o=parseFloat(i[6]);this._colors.push(new me$3(s>1?s/255:s,t>1?t/255:t,o>1?o/255:o,7===i.length||void 0===i[7]?1:parseFloat(i[7])));}else this._colors.push(this._grayColor);}else if(null!==(i=F.NormalPattern.exec(t)))this._normals.push(new te$4(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3])));else if(null!==(i=F.UVPattern.exec(t)))this._uvs.push(new ee$4(parseFloat(i[1])*this._loadingOptions.UVScaling.x,parseFloat(i[2])*this._loadingOptions.UVScaling.y));else if(null!==(i=F.FacePattern3.exec(t)))this._setDataForCurrentFaceWithPattern3(i[1].trim().split(" "),1);else if(null!==(i=F.FacePattern4.exec(t)))this._setDataForCurrentFaceWithPattern4(i[1].trim().split(" "),1);else if(null!==(i=F.FacePattern5.exec(t)))this._setDataForCurrentFaceWithPattern5(i[1].trim().split(" "),1);else if(null!==(i=F.FacePattern2.exec(t)))this._setDataForCurrentFaceWithPattern2(i[1].trim().split(" "),1);else if(null!==(i=F.FacePattern1.exec(t)))this._setDataForCurrentFaceWithPattern1(i[1].trim().split(" "),1);else if(null!==(i=F.LinePattern1.exec(t)))this._setDataForCurrentFaceWithPattern1(i[1].trim().split(" "),0),this._hasLineData=true;else if(null!==(i=F.LinePattern2.exec(t)))this._setDataForCurrentFaceWithPattern2(i[1].trim().split(" "),0),this._hasLineData=true;else if(i=F._GetZbrushMRGB(t,!this._loadingOptions.importVertexColors))for(const s of i)this._extColors.push(s);else if(null!==(i=F.LinePattern3.exec(t)))this._setDataForCurrentFaceWithPattern3(i[1].trim().split(" "),0),this._hasLineData=true;else if(F.GroupDescriptor.test(t)||F.ObjectDescriptor.test(t)){const s={name:t.substring(2).trim(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:F.ObjectDescriptor.test(t)};this._addPreviousObjMesh(),this._meshesFromObj.push(s),this._hasMeshes=true,this._isFirstMaterial=true,this._increment=1;}else if(F.UseMtlDescriptor.test(t)){if(this._materialNameFromObj=t.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();const s={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:false};this._increment++,this._meshesFromObj.push(s),this._hasMeshes=true;}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=false);}else F.MtlLibGroupDescriptor.test(t)?m(t.substring(7).trim()):F.SmoothDescriptor.test(t)||Ie$2.Log("Unhandled expression at line : "+t);}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._unwrappedNormalsForBabylon.length&&(this._handledMesh.normals=this._unwrappedNormalsForBabylon),this._unwrappedUVForBabylon.length&&(this._handledMesh.uvs=this._unwrappedUVForBabylon),this._unwrappedColorsForBabylon.length&&(this._handledMesh.colors=this._unwrappedColorsForBabylon),this._handledMesh.hasLines=this._hasLineData),!this._hasMeshes){let t=null;if(this._indicesForBabylon.length)this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData();else {for(const s of this._positions)this._unwrappedPositionsForBabylon.push(s.x,s.y,s.z);if(this._normals.length)for(const s of this._normals)this._unwrappedNormalsForBabylon.push(s.x,s.y,s.z);if(this._uvs.length)for(const s of this._uvs)this._unwrappedUVForBabylon.push(s.x,s.y);if(this._extColors.length)for(const s of this._extColors)this._unwrappedColorsForBabylon.push(s.r,s.g,s.b,s.a);else if(this._colors.length)for(const s of this._colors)this._unwrappedColorsForBabylon.push(s.r,s.g,s.b,s.a);this._materialNameFromObj||(t=new te$2(rs.RandomId(),_),t.pointsCloud=true,this._materialNameFromObj=t.name,this._normals.length||(t.disableLighting=true,t.emissiveColor=ge$3.White()));}this._meshesFromObj.push({name:rs.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:t,isObject:true,hasLines:this._hasLineData});}for(let s=0;s<this._meshesFromObj.length;s++){if(t&&this._meshesFromObj[s].name)if(t instanceof Array){if(-1===t.indexOf(this._meshesFromObj[s].name))continue}else if(this._meshesFromObj[s].name!==t)continue;this._handledMesh=this._meshesFromObj[s],_._blockEntityCollection=!!p;const e=new Er$1(this._meshesFromObj[s].name,_);if(e._parentContainer=p,_._blockEntityCollection=false,this._handledMesh._babylonMesh=e,!this._handledMesh.isObject)for(let t=s-1;t>=0;--t)if(this._meshesFromObj[t].isObject&&this._meshesFromObj[t]._babylonMesh){e.parent=this._meshesFromObj[t]._babylonMesh;break}if(this._materialToUse.push(this._meshesFromObj[s].materialName),this._handledMesh.hasLines&&(e._internalMetadata??={},e._internalMetadata._isLine=true),0===this._handledMesh.positions?.length){this._babylonMeshesArray.push(e);continue}const i=new is;if(i.indices=this._handledMesh.indices,i.positions=this._handledMesh.positions,this._loadingOptions.computeNormals||!this._handledMesh.normals){const s=new Array;is.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,s),i.normals=s;}else i.normals=this._handledMesh.normals;this._handledMesh.uvs&&(i.uvs=this._handledMesh.uvs),this._handledMesh.colors&&(i.colors=this._handledMesh.colors),i.applyToMesh(e),this._loadingOptions.invertY&&(e.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(e),this._babylonMeshesArray.push(e),this._handledMesh.directMaterial&&(e.material=this._handledMesh.directMaterial);}}};F$3.ObjectDescriptor=/^o/,F$3.GroupDescriptor=/^g/,F$3.MtlLibGroupDescriptor=/^mtllib /,F$3.UseMtlDescriptor=/^usemtl /,F$3.SmoothDescriptor=/^s /,F$3.VertexPattern=/^v(\s+[\d|.|+|\-|e|E]+){3,7}/,F$3.NormalPattern=/^vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/,F$3.UVPattern=/^vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/,F$3.FacePattern1=/^f\s+(([\d]{1,}[\s]?){3,})+/,F$3.FacePattern2=/^f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,F$3.FacePattern3=/^f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,F$3.FacePattern4=/^f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/,F$3.FacePattern5=/^f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/,F$3.LinePattern1=/^l\s+(([\d]{1,}[\s]?){2,})+/,F$3.LinePattern2=/^l\s+((([\d]{1,}\/[\d]{1,}[\s]?){2,})+)/,F$3.LinePattern3=/^l\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;let b$7=class b{static get INVERT_TEXTURE_Y(){return u$b.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(s){u$b.INVERT_TEXTURE_Y=s;}constructor(s){this.name=hc.name,this.extensions=hc.extensions,this._assetContainer=null,this._loadingOptions={...b._DefaultLoadingOptions,...s??{}};}static get _DefaultLoadingOptions(){return {computeNormals:b.COMPUTE_NORMALS,optimizeNormals:b.OPTIMIZE_NORMALS,importVertexColors:b.IMPORT_VERTEX_COLORS,invertY:b.INVERT_Y,invertTextureY:b.INVERT_TEXTURE_Y,UVScaling:b.UV_SCALING,materialLoadingFailsSilently:b.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:b.OPTIMIZE_WITH_UV,skipMaterials:b.SKIP_MATERIALS,useLegacyBehavior:b.USE_LEGACY_BEHAVIOR}}_loadMTL(s,t,e,i){const o=t+s;Ai.LoadFile(o,e,void 0,void 0,false,((s,t)=>{i(o,t);}));}createPlugin(s){return new b(s[hc.name])}canDirectLoad(){return  false}importMeshAsync(s,t,e,i){return this._parseSolidAsync(s,t,e,i).then((s=>({meshes:s,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})))}loadAsync(s,t,e){return this.importMeshAsync(null,s,t,e).then((()=>{}))}loadAssetContainerAsync(s,t,e){const i=new M$b(s);return this._assetContainer=i,this.importMeshAsync(null,s,t,e).then((s=>(s.meshes.forEach((s=>i.meshes.push(s))),s.meshes.forEach((s=>{const t=s.material;if(t&&-1==i.materials.indexOf(t)){i.materials.push(t);t.getActiveTextures().forEach((s=>{ -1==i.textures.indexOf(s)&&i.textures.push(s);}));}})),this._assetContainer=null,i))).catch((s=>{throw this._assetContainer=null,s}))}_parseSolidAsync(s,t,e,i){let o="";const r=new u$b,n=[],a=[];e=e.replace(/#.*$/gm,"").trim();new F$3(n,a,this._loadingOptions).parse(s,e,t,this._assetContainer,(s=>{o=s;}));const l=[];return ""===o||this._loadingOptions.skipMaterials||l.push(new Promise(((s,e)=>{this._loadMTL(o,i,(l=>{try{r.parseMTL(t,l,i,this._assetContainer);for(let s=0;s<r.materials.length;s++){let t=0;const e=[];let i;for(;(i=n.indexOf(r.materials[s].name,t))>-1;)e.push(i),t=i+1;if(-1===i&&0===e.length)r.materials[s].dispose();else for(let t=0;t<e.length;t++){const i=a[e[t]],o=r.materials[s];i.material=o,i.getTotalIndices()||(o.pointsCloud=!0);}}s();}catch(t){Ai.Warn(`Error processing MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?s():e(t);}}),((t,i)=>{Ai.Warn(`Error downloading MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?s():e(i);}));}))),Promise.all(l).then((()=>{const s=s=>Boolean(s._internalMetadata?._isLine??false);return a.forEach((e=>{if(s(e)){let i=e.material??new te$2(e.name+"_line",t);i.getBindedMeshes().filter((t=>!s(t))).length>0&&(i=i.clone(i.name+"_line")??i),i.wireframe=true,e.material=i,e._internalMetadata&&(e._internalMetadata._isLine=void 0);}})),a}))}};b$7.OPTIMIZE_WITH_UV=true,b$7.INVERT_Y=false,b$7.IMPORT_VERTEX_COLORS=false,b$7.COMPUTE_NORMALS=false,b$7.OPTIMIZE_NORMALS=false,b$7.UV_SCALING=new ee$4(1,1),b$7.SKIP_MATERIALS=false,b$7.MATERIAL_LOADING_FAILS_SILENTLY=true,b$7.USE_LEGACY_BEHAVIOR=false,gh(new b$7);
var objFileLoaderCeQH81_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,OBJFileLoader:b$7});const M$6={effect:null,subMesh:null};let O$8=class O extends Ah{constructor(s,e,r,i={},o=true){super(s,e,o),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new re$5,this._cachedWorldViewProjectionMatrix=new re$5,this._multiview=false,this._materialHelperNeedsPreviousMatrices=false,this._shaderPath=r,this._options={needAlphaBlending:false,needAlphaTesting:false,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:false,...i};}get shaderPath(){return this._shaderPath}set shaderPath(s){this._shaderPath=s;}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return "ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(s){ -1===this._options.uniforms.indexOf(s)&&this._options.uniforms.push(s);}setTexture(s,t){return  -1===this._options.samplers.indexOf(s)&&this._options.samplers.push(s),this._textures[s]=t,this}removeTexture(s){delete this._textures[s];}setTextureArray(s,t){return  -1===this._options.samplers.indexOf(s)&&this._options.samplers.push(s),this._checkUniform(s),this._textureArrays[s]=t,this}setExternalTexture(s,t){return  -1===this._options.externalTextures.indexOf(s)&&this._options.externalTextures.push(s),this._externalTextures[s]=t,this}setFloat(s,t){return this._checkUniform(s),this._floats[s]=t,this}setInt(s,t){return this._checkUniform(s),this._ints[s]=t,this}setUInt(s,t){return this._checkUniform(s),this._uints[s]=t,this}setFloats(s,t){return this._checkUniform(s),this._floatsArrays[s]=t,this}setColor3(s,t){return this._checkUniform(s),this._colors3[s]=t,this}setColor3Array(s,t){return this._checkUniform(s),this._colors3Arrays[s]=t.reduce(((s,t)=>(s.push(t.r,t.g,t.b),s)),[]),this}setColor4(s,t){return this._checkUniform(s),this._colors4[s]=t,this}setColor4Array(s,t){return this._checkUniform(s),this._colors4Arrays[s]=t.reduce(((s,t)=>(s.push(t.r,t.g,t.b,t.a),s)),[]),this}setVector2(s,t){return this._checkUniform(s),this._vectors2[s]=t,this}setVector3(s,t){return this._checkUniform(s),this._vectors3[s]=t,this}setVector4(s,t){return this._checkUniform(s),this._vectors4[s]=t,this}setQuaternion(s,t){return this._checkUniform(s),this._quaternions[s]=t,this}setQuaternionArray(s,t){return this._checkUniform(s),this._quaternionsArrays[s]=t.reduce(((s,t)=>(t.toArray(s,s.length),s)),[]),this}setMatrix(s,t){return this._checkUniform(s),this._matrices[s]=t,this}setMatrices(s,t){this._checkUniform(s);const e=new Float32Array(16*t.length);for(let s=0;s<t.length;s++){t[s].copyToArray(e,16*s);}return this._matrixArrays[s]=e,this}setMatrix3x3(s,t){return this._checkUniform(s),this._matrices3x3[s]=t,this}setMatrix2x2(s,t){return this._checkUniform(s),this._matrices2x2[s]=t,this}setArray2(s,t){return this._checkUniform(s),this._vectors2Arrays[s]=t,this}setArray3(s,t){return this._checkUniform(s),this._vectors3Arrays[s]=t,this}setArray4(s,t){return this._checkUniform(s),this._vectors4Arrays[s]=t,this}setUniformBuffer(s,t){return  -1===this._options.uniformBuffers.indexOf(s)&&this._options.uniformBuffers.push(s),this._uniformBuffers[s]=t,this}setTextureSampler(s,t){return  -1===this._options.samplerObjects.indexOf(s)&&this._options.samplerObjects.push(s),this._textureSamplers[s]=t,this}setStorageBuffer(s,t){return  -1===this._options.storageBuffers.indexOf(s)&&this._options.storageBuffers.push(s),this._storageBuffers[s]=t,this}setDefine(s,t){const e=s.trimEnd()+" ",r=this.options.defines.findIndex((t=>t===s||t.startsWith(e)));return r>=0&&this.options.defines.splice(r,1),("boolean"!=typeof t||t)&&this.options.defines.push(e+t),this}isReadyForSubMesh(s,t,e){return this.isReady(s,e,t)}isReady(s,t,c){const f=c&&this._storeEffectOnSubMeshes;if(this.isFrozen){const s=f?c._drawWrapper:this._drawWrapper;if(s.effect&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===t)return  true}const u=this.getScene(),_=u.getEngine(),l=[],x=[];let p=null,d=this._shaderPath,m=this._options.uniforms,y=this._options.uniformBuffers,A=this._options.samplers;_.getCaps().multiview&&u.activeCamera&&u.activeCamera.outputRenderTarget&&u.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=true,l.push("#define MULTIVIEW"),-1!==m.indexOf("viewProjection")&&-1===m.indexOf("viewProjectionR")&&m.push("viewProjectionR"));for(let s=0;s<this._options.defines.length;s++){const t=0===this._options.defines[s].indexOf("#define")?this._options.defines[s]:`#define ${this._options.defines[s]}`;l.push(t);}for(let s=0;s<this._options.attributes.length;s++)x.push(this._options.attributes[s]);if(s&&s.isVerticesDataPresent(Hi.ColorKind)&&(-1===x.indexOf(Hi.ColorKind)&&x.push(Hi.ColorKind),l.push("#define VERTEXCOLOR")),t&&(l.push("#define INSTANCES"),Fs(x,this._materialHelperNeedsPreviousMatrices),s?.hasThinInstances&&(l.push("#define THIN_INSTANCES"),s&&s.isVerticesDataPresent(Hi.ColorInstanceKind)&&(x.push(Hi.ColorInstanceKind),l.push("#define INSTANCESCOLOR")))),s&&s.useBones&&s.computeBonesUsingShaders&&s.skeleton){x.push(Hi.MatricesIndicesKind),x.push(Hi.MatricesWeightsKind),s.numBoneInfluencers>4&&(x.push(Hi.MatricesIndicesExtraKind),x.push(Hi.MatricesWeightsExtraKind));const t=s.skeleton;l.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),p=new ro,p.addCPUSkinningFallback(0,s),t.isUsingTextureForMatrices?(l.push("#define BONETEXTURE"),-1===m.indexOf("boneTextureWidth")&&m.push("boneTextureWidth"),-1===this._options.samplers.indexOf("boneSampler")&&this._options.samplers.push("boneSampler")):(l.push("#define BonesPerMesh "+(t.bones.length+1)),-1===m.indexOf("mBones")&&m.push("mBones"));}else l.push("#define NUM_BONE_INFLUENCERS 0");let v=0;const T=s?s.morphTargetManager:null;if(T){const t=-1!==l.indexOf("#define UV1"),e=-1!==l.indexOf("#define UV2"),r=-1!==l.indexOf("#define TANGENT"),o=-1!==l.indexOf("#define NORMAL"),n=-1!==l.indexOf("#define VERTEXCOLOR");v=Ds(T,l,x,s,true,o,r,t,e,n),T.isUsingTextureForTargets&&(-1===m.indexOf("morphTargetTextureIndices")&&m.push("morphTargetTextureIndices"),-1===this._options.samplers.indexOf("morphTargets")&&this._options.samplers.push("morphTargets")),v>0&&(m=m.slice(),m.push("morphTargetInfluences"),m.push("morphTargetCount"),m.push("morphTargetTextureInfo"),m.push("morphTargetTextureIndices"));}else l.push("#define NUM_MORPH_INFLUENCERS 0");if(s){const t=s.bakedVertexAnimationManager;t&&t.isEnabled&&(l.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===m.indexOf("bakedVertexAnimationSettings")&&m.push("bakedVertexAnimationSettings"),-1===m.indexOf("bakedVertexAnimationTextureSizeInverted")&&m.push("bakedVertexAnimationTextureSizeInverted"),-1===m.indexOf("bakedVertexAnimationTime")&&m.push("bakedVertexAnimationTime"),-1===this._options.samplers.indexOf("bakedVertexAnimationTexture")&&this._options.samplers.push("bakedVertexAnimationTexture")),Vs(x,s,l);}for(const s in this._textures)if(!this._textures[s].isReady())return  false;s&&this.needAlphaTestingForMesh(s)&&l.push("#define ALPHATEST"),false!==this._options.useClipPlane&&(Ts(m),Es(this,u,l)),u.fogEnabled&&s?.applyFog&&u.fogMode!==ch.FOGMODE_NONE&&(l.push("#define FOG"),-1===m.indexOf("view")&&m.push("view"),-1===m.indexOf("vFogInfos")&&m.push("vFogInfos"),-1===m.indexOf("vFogColor")&&m.push("vFogColor")),this._useLogarithmicDepth&&(l.push("#define LOGARITHMICDEPTH"),-1===m.indexOf("logarithmicDepthConstant")&&m.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(m=m.slice(),y=y.slice(),A=A.slice(),d=this.customShaderNameResolve(this.name,m,y,A,l,x));const O=c?c.getRenderingMesh():s;if(O&&this.useVertexPulling){l.push("#define USE_VERTEX_PULLING");const s=O.geometry?.getIndexBuffer();s&&(l.push("#define VERTEX_PULLING_USE_INDEX_BUFFER"),s.is32Bits&&l.push("#define VERTEX_PULLING_INDEX_BUFFER_32BITS"));}const E=f?c._getDrawWrapper(void 0,true):this._drawWrapper,b=E?.effect??null,S=E?.defines??null,w=l.join("\n");let U=b;return S!==w&&(U=_.createEffect(d,{attributes:x,uniformsNames:m,uniformBuffersNames:y,samplers:A,defines:w,fallbacks:p,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:v},shaderLanguage:this._options.shaderLanguage,extraInitializationsAsync:this._options.extraInitializationsAsync},_),f?c.setEffect(U,w,this._materialContext):E&&E.setEffect(U,w),this._onEffectCreatedObservable&&(M$6.effect=U,M$6.subMesh=c??s?.subMeshes[0]??null,this._onEffectCreatedObservable.notifyObservers(M$6))),E._wasPreviouslyUsingInstances=!!t,!!U?.isReady()&&(b!==U&&u.resetCachedMaterial(),E._wasPreviouslyReady=true,true)}bindOnlyWorldMatrix(s,t){const e=t??this.getEffect();if(!e)return;const r=this._options.uniforms;-1!==r.indexOf("world")&&e.setMatrix("world",s);const i=this.getScene();-1!==r.indexOf("worldView")&&(s.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),e.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==r.indexOf("worldViewProjection")&&(s.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),e.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),-1!==r.indexOf("view")&&e.setMatrix("view",i.getViewMatrix());}bindForSubMesh(s,t,e){this.bind(s,t,e._drawWrapperOverride?.effect,e);}bind(s,t,e,r){const i=r&&this._storeEffectOnSubMeshes,o=e??(i?r.effect:this.getEffect());if(!o)return;const n=this.getScene();this._activeEffect=o,this.bindOnlyWorldMatrix(s,e);const a=this._options.uniformBuffers;let h=false;if(o&&a&&a.length>0&&n.getEngine().supportsUniformBuffers)for(let e=0;e<a.length;++e){switch(a[e]){case "Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(s));break;case "Scene":Ns(o,n.getSceneUniformBuffer()),n.finalizeSceneUbo(),h=true;}}const p=t&&i?this._mustRebind(n,o,r,t.visibility):n.getCachedMaterial()!==this;if(o&&p){let s;for(s in h||-1===this._options.uniforms.indexOf("view")||o.setMatrix("view",n.getViewMatrix()),h||-1===this._options.uniforms.indexOf("projection")||o.setMatrix("projection",n.getProjectionMatrix()),h||-1===this._options.uniforms.indexOf("viewProjection")||(o.setMatrix("viewProjection",n.getTransformMatrix()),this._multiview&&o.setMatrix("viewProjectionR",n._transformMatrixR)),n.activeCamera&&-1!==this._options.uniforms.indexOf("cameraPosition")&&o.setVector3("cameraPosition",n.activeCamera.globalPosition),Hs(t,o),As(o,this,n),this._useLogarithmicDepth&&Cs(i?r.materialDefines:o.defines,o,n),t&&Os(n,t,o),this._textures)o.setTexture(s,this._textures[s]);for(s in this._textureArrays)o.setTextureArray(s,this._textureArrays[s]);for(s in this._ints)o.setInt(s,this._ints[s]);for(s in this._uints)o.setUInt(s,this._uints[s]);for(s in this._floats)o.setFloat(s,this._floats[s]);for(s in this._floatsArrays)o.setArray(s,this._floatsArrays[s]);for(s in this._colors3)o.setColor3(s,this._colors3[s]);for(s in this._colors3Arrays)o.setArray3(s,this._colors3Arrays[s]);for(s in this._colors4){const t=this._colors4[s];o.setFloat4(s,t.r,t.g,t.b,t.a);}for(s in this._colors4Arrays)o.setArray4(s,this._colors4Arrays[s]);for(s in this._vectors2)o.setVector2(s,this._vectors2[s]);for(s in this._vectors3)o.setVector3(s,this._vectors3[s]);for(s in this._vectors4)o.setVector4(s,this._vectors4[s]);for(s in this._quaternions)o.setQuaternion(s,this._quaternions[s]);for(s in this._matrices)o.setMatrix(s,this._matrices[s]);for(s in this._matrixArrays)o.setMatrices(s,this._matrixArrays[s]);for(s in this._matrices3x3)o.setMatrix3x3(s,this._matrices3x3[s]);for(s in this._matrices2x2)o.setMatrix2x2(s,this._matrices2x2[s]);for(s in this._vectors2Arrays)o.setArray2(s,this._vectors2Arrays[s]);for(s in this._vectors3Arrays)o.setArray3(s,this._vectors3Arrays[s]);for(s in this._vectors4Arrays)o.setArray4(s,this._vectors4Arrays[s]);for(s in this._quaternionsArrays)o.setArray4(s,this._quaternionsArrays[s]);for(s in this._uniformBuffers){const t=this._uniformBuffers[s].getBuffer();t&&o.bindUniformBuffer(t,s);}const e=n.getEngine(),a=e.setExternalTexture;if(a)for(s in this._externalTextures)a.call(e,s,this._externalTextures[s]);const c=e.setTextureSampler;if(c)for(s in this._textureSamplers)c.call(e,s,this._textureSamplers[s]);const x=e.setStorageBuffer;if(x)for(s in this._storageBuffers)x.call(e,s,this._storageBuffers[s]);}if(o&&t&&(p||!this.isFrozen)){ws(t,o),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(o);const s=t.bakedVertexAnimationManager;if(s&&s.isEnabled){const s=i?r._drawWrapper:this._drawWrapper;t.bakedVertexAnimationManager?.bind(o,!!s._wasPreviouslyUsingInstances);}}this._afterBind(t,o,r);}getActiveTextures(){const s=super.getActiveTextures();for(const t in this._textures)s.push(this._textures[t]);for(const t in this._textureArrays){const e=this._textureArrays[t];for(let t=0;t<e.length;t++)s.push(e[t]);}return s}hasTexture(s){if(super.hasTexture(s))return  true;for(const t in this._textures)if(this._textures[t]===s)return  true;for(const t in this._textureArrays){const e=this._textureArrays[t];for(let t=0;t<e.length;t++)if(e[t]===s)return  true}return  false}clone(s){const t=Ae$3.Clone((()=>new O(s,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes)),this);t.name=s,t.id=s,"object"==typeof t._shaderPath&&(t._shaderPath={...t._shaderPath}),this._options={...this._options};const e=Object.keys(this._options);for(const s of e){const t=this._options[s];Array.isArray(t)&&(this._options[s]=t.slice(0));}this.stencil.copyTo(t.stencil);for(const s in this._textures)t.setTexture(s,this._textures[s]);for(const s in this._textureArrays)t.setTextureArray(s,this._textureArrays[s]);for(const s in this._externalTextures)t.setExternalTexture(s,this._externalTextures[s]);for(const s in this._ints)t.setInt(s,this._ints[s]);for(const s in this._uints)t.setUInt(s,this._uints[s]);for(const s in this._floats)t.setFloat(s,this._floats[s]);for(const s in this._floatsArrays)t.setFloats(s,this._floatsArrays[s]);for(const s in this._colors3)t.setColor3(s,this._colors3[s]);for(const s in this._colors3Arrays)t._colors3Arrays[s]=this._colors3Arrays[s];for(const s in this._colors4)t.setColor4(s,this._colors4[s]);for(const s in this._colors4Arrays)t._colors4Arrays[s]=this._colors4Arrays[s];for(const s in this._vectors2)t.setVector2(s,this._vectors2[s]);for(const s in this._vectors3)t.setVector3(s,this._vectors3[s]);for(const s in this._vectors4)t.setVector4(s,this._vectors4[s]);for(const s in this._quaternions)t.setQuaternion(s,this._quaternions[s]);for(const s in this._quaternionsArrays)t._quaternionsArrays[s]=this._quaternionsArrays[s];for(const s in this._matrices)t.setMatrix(s,this._matrices[s]);for(const s in this._matrixArrays)t._matrixArrays[s]=this._matrixArrays[s].slice();for(const s in this._matrices3x3)t.setMatrix3x3(s,this._matrices3x3[s]);for(const s in this._matrices2x2)t.setMatrix2x2(s,this._matrices2x2[s]);for(const s in this._vectors2Arrays)t.setArray2(s,this._vectors2Arrays[s]);for(const s in this._vectors3Arrays)t.setArray3(s,this._vectors3Arrays[s]);for(const s in this._vectors4Arrays)t.setArray4(s,this._vectors4Arrays[s]);for(const s in this._uniformBuffers)t.setUniformBuffer(s,this._uniformBuffers[s]);for(const s in this._textureSamplers)t.setTextureSampler(s,this._textureSamplers[s]);for(const s in this._storageBuffers)t.setStorageBuffer(s,this._storageBuffers[s]);return t}dispose(s,t,e){if(t){let s;for(s in this._textures)this._textures[s].dispose();for(s in this._textureArrays){const t=this._textureArrays[s];for(let s=0;s<t.length;s++)t[s].dispose();}}this._textures={},super.dispose(s,t,e);}serialize(){const s=Ae$3.Serialize(this);let t;for(t in s.customType="BABYLON.ShaderMaterial",s.uniqueId=this.uniqueId,s.options=this._options,s.shaderPath=this._shaderPath,s.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes,s.stencil=this.stencil.serialize(),s.textures={},this._textures)s.textures[t]=this._textures[t].serialize();for(t in s.textureArrays={},this._textureArrays){s.textureArrays[t]=[];const e=this._textureArrays[t];for(let r=0;r<e.length;r++)s.textureArrays[t].push(e[r].serialize());}for(t in s.ints={},this._ints)s.ints[t]=this._ints[t];for(t in s.uints={},this._uints)s.uints[t]=this._uints[t];for(t in s.floats={},this._floats)s.floats[t]=this._floats[t];for(t in s.floatsArrays={},this._floatsArrays)s.floatsArrays[t]=this._floatsArrays[t];for(t in s.colors3={},this._colors3){const e=this._colors3[t];s.colors3[t]=[e.r,e.g,e.b];}for(t in s.colors3Arrays={},this._colors3Arrays)s.colors3Arrays[t]=this._colors3Arrays[t];for(t in s.colors4={},this._colors4){const e=this._colors4[t];s.colors4[t]=[e.r,e.g,e.b,e.a];}for(t in s.colors4Arrays={},this._colors4Arrays)s.colors4Arrays[t]=this._colors4Arrays[t];for(t in s.vectors2={},this._vectors2){const e=this._vectors2[t];s.vectors2[t]=[e.x,e.y];}for(t in s.vectors3={},this._vectors3){const e=this._vectors3[t];s.vectors3[t]=[e.x,e.y,e.z];}for(t in s.vectors4={},this._vectors4){const e=this._vectors4[t];s.vectors4[t]=[e.x,e.y,e.z,e.w];}for(t in s.quaternions={},this._quaternions)s.quaternions[t]=this._quaternions[t].asArray();for(t in s.matrices={},this._matrices)s.matrices[t]=this._matrices[t].asArray();for(t in s.matrixArray={},this._matrixArrays)s.matrixArray[t]=this._matrixArrays[t];for(t in s.matrices3x3={},this._matrices3x3)s.matrices3x3[t]=this._matrices3x3[t];for(t in s.matrices2x2={},this._matrices2x2)s.matrices2x2[t]=this._matrices2x2[t];for(t in s.vectors2Arrays={},this._vectors2Arrays)s.vectors2Arrays[t]=this._vectors2Arrays[t];for(t in s.vectors3Arrays={},this._vectors3Arrays)s.vectors3Arrays[t]=this._vectors3Arrays[t];for(t in s.vectors4Arrays={},this._vectors4Arrays)s.vectors4Arrays[t]=this._vectors4Arrays[t];for(t in s.quaternionsArrays={},this._quaternionsArrays)s.quaternionsArrays[t]=this._quaternionsArrays[t];return s}static Parse(s,e,r){const i=Ae$3.Parse((()=>new O(s.name,e,s.shaderPath,s.options,s.storeEffectOnSubMeshes)),s,e,r);let o;for(o in s.stencil&&i.stencil.parse(s.stencil,e,r),s.textures)i.setTexture(o,Is.Parse(s.textures[o],e,r));for(o in s.textureArrays){const t=s.textureArrays[o],n=[];for(let s=0;s<t.length;s++)n.push(Is.Parse(t[s],e,r));i.setTextureArray(o,n);}for(o in s.ints)i.setInt(o,s.ints[o]);for(o in s.uints)i.setUInt(o,s.uints[o]);for(o in s.floats)i.setFloat(o,s.floats[o]);for(o in s.floatsArrays)i.setFloats(o,s.floatsArrays[o]);for(o in s.colors3){const t=s.colors3[o];i.setColor3(o,{r:t[0],g:t[1],b:t[2]});}for(o in s.colors3Arrays){const t=s.colors3Arrays[o].reduce(((s,t,e)=>(e%3==0?s.push([t]):s[s.length-1].push(t),s)),[]).map((s=>({r:s[0],g:s[1],b:s[2]})));i.setColor3Array(o,t);}for(o in s.colors4){const t=s.colors4[o];i.setColor4(o,{r:t[0],g:t[1],b:t[2],a:t[3]});}for(o in s.colors4Arrays){const t=s.colors4Arrays[o].reduce(((s,t,e)=>(e%4==0?s.push([t]):s[s.length-1].push(t),s)),[]).map((s=>({r:s[0],g:s[1],b:s[2],a:s[3]})));i.setColor4Array(o,t);}for(o in s.vectors2){const t=s.vectors2[o];i.setVector2(o,{x:t[0],y:t[1]});}for(o in s.vectors3){const t=s.vectors3[o];i.setVector3(o,{x:t[0],y:t[1],z:t[2]});}for(o in s.vectors4){const t=s.vectors4[o];i.setVector4(o,{x:t[0],y:t[1],z:t[2],w:t[3]});}for(o in s.quaternions)i.setQuaternion(o,se$5.FromArray(s.quaternions[o]));for(o in s.matrices)i.setMatrix(o,re$5.FromArray(s.matrices[o]));for(o in s.matrixArray)i._matrixArrays[o]=new Float32Array(s.matrixArray[o]);for(o in s.matrices3x3)i.setMatrix3x3(o,s.matrices3x3[o]);for(o in s.matrices2x2)i.setMatrix2x2(o,s.matrices2x2[o]);for(o in s.vectors2Arrays)i.setArray2(o,s.vectors2Arrays[o]);for(o in s.vectors3Arrays)i.setArray3(o,s.vectors3Arrays[o]);for(o in s.vectors4Arrays)i.setArray4(o,s.vectors4Arrays[o]);for(o in s.quaternionsArrays)i.setArray4(o,s.quaternionsArrays[o]);return i}static async ParseFromFileAsync(s,t,e,r=""){return await new Promise(((i,o)=>{const n=new Oe$3;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const t=JSON.parse(n.responseText),o=this.Parse(t,e||L$7.LastCreatedScene,r);s&&(o.name=s),i(o);}else o("Unable to load the ShaderMaterial");})),n.open("GET",t),n.send();}))}static async ParseFromSnippetAsync(s,t,e=""){return await new Promise(((r,i)=>{const o=new Oe$3;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const i=JSON.parse(JSON.parse(o.responseText).jsonPayload),n=JSON.parse(i.shaderMaterial),a=this.Parse(n,t||L$7.LastCreatedScene,e);a.snippetId=s,r(a);}else i("Unable to load the snippet "+s);})),o.open("GET",this.SnippetUrl+"/"+s.replace(/#/g,"/")),o.send();}))}};O$8.SnippetUrl=Qe$1.SnippetUrl,O$8.CreateFromSnippetAsync=O$8.ParseFromSnippetAsync,P$9("BABYLON.ShaderMaterial",O$8);var shaderMaterialB2PRHxGe_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,ShaderMaterial:O$8});let u$a=class u{constructor(t,e,n=Number.MAX_VALUE,r=x$d){this.origin=t,this.direction=e,this.length=n,this.epsilon=r;}clone(){return new u(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(t,e,i=0){const n=u._TmpVector3[0].copyFromFloats(t.x-i,t.y-i,t.z-i),r=u._TmpVector3[1].copyFromFloats(e.x+i,e.y+i,e.z+i);let o,s,a,c,h=0,l=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<n.x||this.origin.x>r.x)return  false}else if(o=1/this.direction.x,s=(n.x-this.origin.x)*o,a=(r.x-this.origin.x)*o,a===-1/0&&(a=1/0),s>a&&(c=s,s=a,a=c),h=Math.max(s,h),l=Math.min(a,l),h>l)return  false;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<n.y||this.origin.y>r.y)return  false}else if(o=1/this.direction.y,s=(n.y-this.origin.y)*o,a=(r.y-this.origin.y)*o,a===-1/0&&(a=1/0),s>a&&(c=s,s=a,a=c),h=Math.max(s,h),l=Math.min(a,l),h>l)return  false;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<n.z||this.origin.z>r.z)return  false}else if(o=1/this.direction.z,s=(n.z-this.origin.z)*o,a=(r.z-this.origin.z)*o,a===-1/0&&(a=1/0),s>a&&(c=s,s=a,a=c),h=Math.max(s,h),l=Math.min(a,l),h>l)return  false;return  true}intersectsBox(t,e=0){return this.intersectsBoxMinMax(t.minimum,t.maximum,e)}intersectsSphere(t,e=0){const i=t.center.x-this.origin.x,n=t.center.y-this.origin.y,r=t.center.z-this.origin.z,o=i*i+n*n+r*r,s=t.radius+e,a=s*s;if(o<=a)return  true;const c=i*this.direction.x+n*this.direction.y+r*this.direction.z;if(c<0)return  false;return o-c*c<=a}intersectsTriangle(t,i,r){const o=u._TmpVector3[0],s=u._TmpVector3[1],a=u._TmpVector3[2],c=u._TmpVector3[3],h=u._TmpVector3[4];i.subtractToRef(t,o),r.subtractToRef(t,s),te$4.CrossToRef(this.direction,s,a);const l=te$4.Dot(o,a);if(0===l)return null;const f=1/l;this.origin.subtractToRef(t,c);const m=te$4.Dot(c,a)*f;if(m<-this.epsilon||m>1+this.epsilon)return null;te$4.CrossToRef(c,o,h);const y=te$4.Dot(this.direction,h)*f;if(y<-this.epsilon||m+y>1+this.epsilon)return null;const d=te$4.Dot(s,h)*f;return d>this.length?null:new zi(1-m-y,m,d)}intersectsPlane(t){let i;const n=te$4.Dot(t.normal,this.direction);if(Math.abs(n)<9.99999997475243e-7)return null;{const r=te$4.Dot(t.normal,this.origin);return i=(-t.d-r)/n,i<0?i<-9.99999997475243e-7?null:0:i}}intersectsAxis(t,i=0){switch(t){case "y":{const t=(this.origin.y-i)/this.direction.y;return t>0?null:new te$4(this.origin.x+this.direction.x*-t,i,this.origin.z+this.direction.z*-t)}case "x":{const t=(this.origin.x-i)/this.direction.x;return t>0?null:new te$4(i,this.origin.y+this.direction.y*-t,this.origin.z+this.direction.z*-t)}case "z":{const t=(this.origin.z-i)/this.direction.z;return t>0?null:new te$4(this.origin.x+this.direction.x*-t,this.origin.y+this.direction.y*-t,i)}default:return null}}intersectsMesh(t,e,i,n=false,o,s=false){const a=ae$5.Matrix[0];return t.getWorldMatrix().invertToRef(a),this._tmpRay?u.TransformToRef(this,a,this._tmpRay):this._tmpRay=u.Transform(this,a),t.intersects(this._tmpRay,e,i,n,o,s)}intersectsMeshes(t,e,i){i?i.length=0:i=[];for(let n=0;n<t.length;n++){const r=this.intersectsMesh(t[n],e);r.hit&&i.push(r);}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(t,e){return t.distance<e.distance?-1:t.distance>e.distance?1:0}intersectionSegment(t,i,n){const o=this.origin,s=ae$5.Vector3[0],a=ae$5.Vector3[1],c=ae$5.Vector3[2],h=ae$5.Vector3[3];i.subtractToRef(t,s),this.direction.scaleToRef(u._Rayl,c),o.addToRef(c,a),t.subtractToRef(o,h);const l=te$4.Dot(s,s),f=te$4.Dot(s,c),m=te$4.Dot(c,c),y=te$4.Dot(s,h),d=te$4.Dot(c,h),g=l*m-f*f;let R,p,T=g,x=g;g<u._Smallnum?(R=0,T=1,p=d,x=m):(R=f*d-m*y,p=l*d-f*y,R<0?(R=0,p=d,x=m):R>T&&(R=T,p=d+f,x=m)),p<0?(p=0,-y<0?R=0:-y>l?R=T:(R=-y,T=l)):p>x&&(p=x,-y+f<0?R=0:-y+f>l?R=T:(R=-y+f,T=l));const _=Math.abs(R)<u._Smallnum?0:R/T,M=Math.abs(p)<u._Smallnum?0:p/x,I=ae$5.Vector3[4];c.scaleToRef(M,I);const k=ae$5.Vector3[5];s.scaleToRef(_,k),k.addInPlace(h);const v=ae$5.Vector3[6];k.subtractToRef(I,v);return M>0&&M<=this.length&&v.lengthSquared()<n*n?k.length():-1}update(t,e,i,n,s,a,c,h=false){if(h){u._RayDistant||(u._RayDistant=u.Zero()),u._RayDistant.unprojectRayToRef(t,e,i,n,re$5.IdentityReadOnly,a,c);const h=ae$5.Matrix[0];s.invertToRef(h),u.TransformToRef(u._RayDistant,h,this);}else this.unprojectRayToRef(t,e,i,n,s,a,c);return this}static Zero(){return new u(te$4.Zero(),te$4.Zero())}static CreateNew(t,e,i,n,r,o,s){return u.Zero().update(t,e,i,n,r,o,s)}static CreateNewFromTo(t,i,n=re$5.IdentityReadOnly){const r=new u(new te$4(0,0,0),new te$4(0,0,0));return u.CreateFromToToRef(t,i,r,n)}static CreateFromToToRef(t,e,i,n=re$5.IdentityReadOnly){i.origin.copyFrom(t);const r=e.subtractToRef(t,i.direction),s=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);return i.length=s,i.direction.normalize(),u.TransformToRef(i,n,i)}static Transform(t,i){const n=new u(new te$4(0,0,0),new te$4(0,0,0));return u.TransformToRef(t,i,n),n}static TransformToRef(t,i,n){te$4.TransformCoordinatesToRef(t.origin,i,n.origin),te$4.TransformNormalToRef(t.direction,i,n.direction),n.length=t.length,n.epsilon=t.epsilon;const r=n.direction,o=r.length();if(0!==o&&1!==o){const t=1/o;r.x*=t,r.y*=t,r.z*=t,n.length*=o;}return n}unprojectRayToRef(t,i,n,o,a,c,h){const l=ae$5.Matrix[0];a.multiplyToRef(c,l),l.multiplyToRef(h,l),l.invert();const u=L$7.LastCreatedEngine,f=ae$5.Vector3[0];f.x=t/n*2-1,f.y=-(i/o*2-1),f.z=u?.useReverseDepthBuffer?1:u?.isNDCHalfZRange?0:-1;const m=ae$5.Vector3[1].copyFromFloats(f.x,f.y,1-1e-8),y=ae$5.Vector3[2],d=ae$5.Vector3[3];te$4.TransformCoordinatesToRef(f,l,y),te$4.TransformCoordinatesToRef(m,l,d),this.origin.copyFrom(y),d.subtractToRef(y,this.direction),this.direction.normalize();}};function f$c(t,e,i,n,r,o=false){const s=u$a.Zero();return m$b(t,e,i,n,s,r,o),s}function m$b(t,e,i,n,r,s,a=false,c=false){const h=t.getEngine();if(!s&&!(s=t.activeCamera))return t;const l=s.viewport,u=h.getRenderHeight(),{x:f,y:m,width:y,height:d}=l.toGlobal(h.getRenderWidth(),u),g=1/h.getHardwareScalingLevel();return e=e*g-f,i=i*g-(u-m-d),r.update(e,i,y,d,n||re$5.IdentityReadOnly,a?re$5.IdentityReadOnly:s.getViewMatrix(),s.getProjectionMatrix(),c),t}function y$4(t,e,i,n){const r=u$a.Zero();return d$8(t,e,i,r,n),r}function d$8(t,e,i,n,r){if(!ls)return t;const s=t.getEngine();if(!r&&!(r=t.activeCamera))throw new Error("Active camera not set");const a=r.viewport,h=s.getRenderHeight(),{x:l,y:u,width:f,height:m}=a.toGlobal(s.getRenderWidth(),h),y=re$5.Identity(),d=1/s.getHardwareScalingLevel();return e=e*d-l,i=i*d-(h-u-m),n.update(e,i,f,m,y,y,r.getProjectionMatrix()),t}function g$9(t,e,i,n,r,o,s,a){const c=e(n,i.enableDistantPicking),h=i.intersects(c,r,s,o,n,a);return h&&h.hit?!r&&null!=t&&h.distance>=t.distance?null:h:null}function R$6(t,e,i,n,o,s){let a=null;const h=!!(t.activeCameras&&t.activeCameras.length>1&&t.cameraToUseForPointers!==t.activeCamera),l=t.cameraToUseForPointers||t.activeCamera,u=g$9;for(let c=0;c<t.meshes.length;c++){const f=t.meshes[c];if(i){if(!i(f,-1))continue}else if(!f.isEnabled()||!f.isVisible||!f.isPickable)continue;const m=h&&f.isWorldMatrixCameraDependent(),y=f.computeWorldMatrix(m,l);if(f.hasThinInstances&&f.thinInstanceEnablePicking){const t=u(a,e,f,y,true,true,s);if(t){if(o)return t;const c=ae$5.Matrix[1],h=f.thinInstanceGetWorldMatrices();for(let t=0;t<h.length;t++){if(i&&!i(f,t))continue;h[t].multiplyToRef(y,c);const r=u(a,e,f,c,n,o,s,true);if(r&&(a=r,a.thinInstanceIndex=t,n))return a}}}else {const t=u(a,e,f,y,n,o,s);if(t&&(a=t,n))return a}}return a||new ls}function p$9(t,e,i,n){if(!ls)return null;const o=[],s=!!(t.activeCameras&&t.activeCameras.length>1&&t.cameraToUseForPointers!==t.activeCamera),a=t.cameraToUseForPointers||t.activeCamera,h=g$9;for(let c=0;c<t.meshes.length;c++){const l=t.meshes[c];if(i){if(!i(l,-1))continue}else if(!l.isEnabled()||!l.isVisible||!l.isPickable)continue;const u=s&&l.isWorldMatrixCameraDependent(),f=l.computeWorldMatrix(u,a);if(l.hasThinInstances&&l.thinInstanceEnablePicking){if(h(null,e,l,f,true,true,n)){const t=ae$5.Matrix[1],s=l.thinInstanceGetWorldMatrices();for(let r=0;r<s.length;r++){if(i&&!i(l,r))continue;s[r].multiplyToRef(f,t);const a=h(null,e,l,t,false,false,n,true);a&&(a.thinInstanceIndex=r,o.push(a));}}}else {const t=h(null,e,l,f,false,false,n);t&&o.push(t);}}return o}function T$3(t,e,i,n,r,s){if(!ls)return null;const a=R$6(t,(n=>(t._tempPickingRay||(t._tempPickingRay=u$a.Zero()),m$b(t,e,i,n,t._tempPickingRay,s||null),t._tempPickingRay)),n,r,true);return a&&(a.ray=f$c(t,e,i,re$5.Identity(),s||null)),a}function x$6(t,e,i,n,r,s,a,c=false){const h=R$6(t,((n,r)=>(t._tempPickingRay||(t._tempPickingRay=u$a.Zero()),m$b(t,e,i,n,t._tempPickingRay,s||null,false,r),t._tempPickingRay)),n,r,false,a);return h&&(h.ray=f$c(t,e,i,re$5.Identity(),s||null)),h}function _$8(t,e,i,n,r){const s=R$6(t,(i=>(t._pickWithRayInverseMatrix||(t._pickWithRayInverseMatrix=re$5.Identity()),i.invertToRef(t._pickWithRayInverseMatrix),t._cachedRayForTransform||(t._cachedRayForTransform=u$a.Zero()),u$a.TransformToRef(e,t._pickWithRayInverseMatrix,t._cachedRayForTransform),t._cachedRayForTransform)),i,n,false,r);return s&&(s.ray=e),s}function M$5(t,e,i,n,r,o){return p$9(t,(n=>f$c(t,e,i,n,r||null)),n,o)}function I$6(t,e,i,n){return p$9(t,(i=>(t._pickWithRayInverseMatrix||(t._pickWithRayInverseMatrix=re$5.Identity()),i.invertToRef(t._pickWithRayInverseMatrix),t._cachedRayForTransform||(t._cachedRayForTransform=u$a.Zero()),u$a.TransformToRef(e,t._pickWithRayInverseMatrix,t._cachedRayForTransform),t._cachedRayForTransform)),i,n)}function k$3(t,i,n=100,o,s){o||(o=t.getWorldMatrix()),i.length=n,s?i.origin.copyFrom(s):i.origin.copyFrom(t.position);const a=ae$5.Vector3[2];a.set(0,0,t._scene.useRightHandedSystem?-1:1);const c=ae$5.Vector3[3];return te$4.TransformNormalToRef(a,o,c),te$4.NormalizeToRef(c,i.direction),i}function v$5(t,i){i&&(i.prototype.getForwardRay=function(t=100,i,n){return k$3(this,new u$a(te$4.Zero(),te$4.Zero(),t),t,i,n)},i.prototype.getForwardRayToRef=function(t,e=100,i,n){return k$3(this,t,e,i,n)}),t&&(ea._IsPickingAvailable=true,t.prototype.createPickingRay=function(t,e,i,n,r=false){return f$c(this,t,e,i,n,r)});}u$a._TmpVector3=M$d(6,te$4.Zero),u$a._RayDistant=u$a.Zero(),u$a._Smallnum=1e-8,u$a._Rayl=1e9,v$5(ch,Di),ch.prototype.createPickingRayToRef=function(t,e,i,n,r,o=false,s=false){return m$b(this,t,e,i,n,r,o,s)},ch.prototype.createPickingRayInCameraSpace=function(t,e,i){return y$4(this,t,e,i)},ch.prototype.createPickingRayInCameraSpaceToRef=function(t,e,i,n){return d$8(this,t,e,i,n)},ch.prototype.pickWithBoundingInfo=function(t,e,i,n,r){return T$3(this,t,e,i,n,r)},ch.prototype.pick=function(t,e,i,n,r,o,s=false){return x$6(this,t,e,i,n,r,o,s)},ch.prototype.pickWithRay=function(t,e,i,n){return _$8(this,t,e,i,n)},ch.prototype.multiPick=function(t,e,i,n,r){return M$5(this,t,e,i,n,r)},ch.prototype.multiPickWithRay=function(t,e,i){return I$6(this,t,e,i)};var rayBVwnQLmQ_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,AddRayExtensions:v$5,CreatePickingRay:f$c,CreatePickingRayInCameraSpace:y$4,CreatePickingRayInCameraSpaceToRef:d$8,CreatePickingRayToRef:m$b,GetForwardRayToRef:k$3,MultiPick:M$5,MultiPickWithRay:I$6,Pick:x$6,PickWithBoundingInfo:T$3,PickWithRay:_$8,Ray:u$a});let K$2=class K{constructor(){this.mm=new Map;}get(e,t){const s=this.mm.get(e);if(void 0!==s)return s.get(t)}set(e,t,s){let n=this.mm.get(e);void 0===n&&this.mm.set(e,n=new Map),n.set(t,s);}};let q$2=class q{get standalone(){return this._options?.standalone??false}get baseMaterial(){return this._baseMaterial}get doNotInjectCode(){return this._options?.doNotInjectCode??false}constructor(t,s,n){this._baseMaterial=t,this._scene=s??L$7.LastCreatedScene,this._options=n,this._subMeshToEffect=new Map,this._subMeshToDepthWrapper=new K$2,this._meshes=new Map,this._onEffectCreatedObserver=this._baseMaterial.onEffectCreatedObservable.add((e=>{const t=e.subMesh?.getMesh();t&&!this._meshes.has(t)&&this._meshes.set(t,t.onDisposeObservable.add((e=>{const t=this._subMeshToEffect.keys();for(let s=t.next();true!==s.done;s=t.next()){const t=s.value;t?.getMesh()===e&&(this._subMeshToEffect.delete(t),this._deleteDepthWrapperEffect(t));}}))),this._subMeshToEffect.get(e.subMesh)?.[0]!==e.effect&&(this._subMeshToEffect.set(e.subMesh,[e.effect,this._scene.getEngine().currentRenderPassId]),this._deleteDepthWrapperEffect(e.subMesh));}));}_deleteDepthWrapperEffect(e){const t=this._subMeshToDepthWrapper.mm.get(e);t&&(t.forEach((e=>{e.mainDrawWrapper.effect?.dispose();})),this._subMeshToDepthWrapper.mm.delete(e));}getEffect(e,s,n){const r=this._subMeshToDepthWrapper.mm.get(e)?.get(s);if(!r)return null;let a=r.drawWrapper[n];return a||(a=r.drawWrapper[n]=new $i(this._scene.getEngine()),a.setEffect(r.mainDrawWrapper.effect,r.mainDrawWrapper.defines)),a}isReadyForSubMesh(e,t,s,n,r){return !(this.standalone&&!this._baseMaterial.isReadyForSubMesh(e.getMesh(),e,n))&&(this._makeEffect(e,t,s,r)?.isReady()??false)}dispose(){this._baseMaterial.onEffectCreatedObservable.remove(this._onEffectCreatedObserver),this._onEffectCreatedObserver=null;const e=this._meshes.entries();for(let t=e.next();true!==t.done;t=e.next()){const[e,s]=t.value;e.onDisposeObservable.remove(s);}}_makeEffect(e,r,a,i){const o=this._scene.getEngine(),c=this._subMeshToEffect.get(e);if(!c)return null;const[l,h]=c;if(!l.isReady())return null;let u=this._subMeshToDepthWrapper.get(e,a);if(!u){const n=new $i(o);n.defines=e._getDrawWrapper(h)?.defines??null,u={drawWrapper:[],mainDrawWrapper:n,depthDefines:"",token:_i()},u.drawWrapper[i]=n,this._subMeshToDepthWrapper.set(e,a,u);}const d=r.join("\n");if(u.mainDrawWrapper.effect&&d===u.depthDefines)return u.mainDrawWrapper.effect;u.depthDefines=d;const p=l.getUniformNames().slice();let f=l.vertexSourceCodeBeforeMigration,_=l.fragmentSourceCodeBeforeMigration;if(!f&&!_)return null;if(!this.doNotInjectCode){const e=this._options&&this._options.remappedVariables?`#include<shadowMapVertexNormalBias>(${this._options.remappedVariables.join(",")})`:"#include<shadowMapVertexNormalBias>",t=this._options&&this._options.remappedVariables?`#include<shadowMapVertexMetric>(${this._options.remappedVariables.join(",")})`:"#include<shadowMapVertexMetric>",s=this._options&&this._options.remappedVariables?`#include<shadowMapFragmentSoftTransparentShadow>(${this._options.remappedVariables.join(",")})`:"#include<shadowMapFragmentSoftTransparentShadow>",r="#include<shadowMapFragment>",a="#include<shadowMapVertexExtraDeclaration>";f=0===l.shaderLanguage?f.replace(/void\s+?main/g,`\n${a}\nvoid main`):f.replace(/@vertex/g,`\n${a}\n@vertex`),f=f.replace(/#define SHADOWDEPTH_NORMALBIAS|#define CUSTOM_VERTEX_UPDATE_WORLDPOS/g,e),f=-1!==f.indexOf("#define SHADOWDEPTH_METRIC")?f.replace(/#define SHADOWDEPTH_METRIC/g,t):f.replace(/}\s*$/g,t+"\n}"),f=f.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");const i=_.indexOf("#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW")>=0||_.indexOf("#define CUSTOM_FRAGMENT_BEFORE_FOG")>=0,o=-1!==_.indexOf("#define SHADOWDEPTH_FRAGMENT");let c="";i?_=_.replace(/#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW|#define CUSTOM_FRAGMENT_BEFORE_FOG/g,s):c=s+"\n",_=_.replace(/void\s+?main/g,Nt$1.IncludesShadersStore.shadowMapFragmentExtraDeclaration+"\nvoid main"),o?_=_.replace(/#define SHADOWDEPTH_FRAGMENT/g,r):c+=r+"\n",c&&(_=_.replace(/}\s*$/g,c+"}")),p.push("biasAndScaleSM","depthValuesSM","lightDataSM","softTransparentShadowSM");}u.mainDrawWrapper.effect=o.createEffect({vertexSource:f,fragmentSource:_,vertexToken:u.token,fragmentToken:u.token},{attributes:l.getAttributesNames(),uniformsNames:p,uniformBuffersNames:l.getUniformBuffersNames(),samplers:l.getSamplers(),defines:d+"\n"+l.defines.replace("#define SHADOWS","").replace(/#define SHADOW\d/g,""),indexParameters:l.getIndexParameters(),shaderLanguage:l.shaderLanguage},o);for(let e=0;e<u.drawWrapper.length;++e)e!==i&&u.drawWrapper[e]?.setEffect(u.mainDrawWrapper.effect,u.mainDrawWrapper.defines);return u.mainDrawWrapper.effect}};const $$2="gaussianSplattingFragmentDeclaration";bt$1.IncludesShadersStore[$$2]||(bt$1.IncludesShadersStore[$$2]="vec4 gaussianColor(vec4 inColor)\n{float A=-dot(vPosition,vPosition);if (A<-4.0) discard;float B=exp(A)*inColor.a;\n#include<logDepthFragment>\nvec3 color=inColor.rgb;\n#ifdef FOG\n#include<fogFragment>\n#endif\nreturn vec4(color,B);}\n");const Q$4="gaussianSplattingPixelShader",J$2="#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\nvarying vec4 vColor;varying vec2 vPosition;\n#include<gaussianSplattingFragmentDeclaration>\nvoid main () { \n#include<clipPlaneFragment>\ngl_FragColor=gaussianColor(vColor);}\n";bt$1.ShadersStore[Q$4]||(bt$1.ShadersStore[Q$4]=J$2);const ee$1={name:Q$4,shader:J$2};var te$1=Object.freeze({__proto__:null,gaussianSplattingPixelShader:ee$1});const se$2="gaussianSplattingVertexDeclaration";bt$1.IncludesShadersStore[se$2]||(bt$1.IncludesShadersStore[se$2]="attribute vec2 position;uniform mat4 view;uniform mat4 projection;uniform mat4 world;uniform vec4 vEyePosition;");const ne$2="gaussianSplattingUboDeclaration";bt$1.IncludesShadersStore[ne$2]||(bt$1.IncludesShadersStore[ne$2]="#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\nattribute vec2 position;");const re$2="gaussianSplatting";bt$1.IncludesShadersStore[re$2]||(bt$1.IncludesShadersStore[re$2]="#if !defined(WEBGL2) && !defined(WEBGPU) && !defined(NATIVE)\nmat3 transpose(mat3 matrix) {return mat3(matrix[0][0],matrix[1][0],matrix[2][0],\nmatrix[0][1],matrix[1][1],matrix[2][1],\nmatrix[0][2],matrix[1][2],matrix[2][2]);}\n#endif\nvec2 getDataUV(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return vec2((x+0.5)/textureSize.x,(y+0.5)/textureSize.y);}\n#if SH_DEGREE>0\nivec2 getDataUVint(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return ivec2(uint(x+0.5),uint(y+0.5));}\n#endif\nstruct Splat {vec4 center;\n#ifndef GS_DISABLE_COLOR\nvec4 color;\n#endif\nvec4 covA;vec4 covB;\n#if SH_DEGREE>0\nuvec4 sh0; \n#endif\n#if SH_DEGREE>1\nuvec4 sh1;\n#endif\n#if SH_DEGREE>2\nuvec4 sh2;\n#endif\n};Splat readSplat(float splatIndex)\n{Splat splat;vec2 splatUV=getDataUV(splatIndex,dataTextureSize);splat.center=texture2D(centersTexture,splatUV);\n#ifndef GS_DISABLE_COLOR\nsplat.color=texture2D(colorsTexture,splatUV);\n#endif\nsplat.covA=texture2D(covariancesATexture,splatUV)*splat.center.w;splat.covB=texture2D(covariancesBTexture,splatUV)*splat.center.w;\n#if SH_DEGREE>0\nivec2 splatUVint=getDataUVint(splatIndex,dataTextureSize);splat.sh0=texelFetch(shTexture0,splatUVint,0);\n#endif\n#if SH_DEGREE>1\nsplat.sh1=texelFetch(shTexture1,splatUVint,0);\n#endif\n#if SH_DEGREE>2\nsplat.sh2=texelFetch(shTexture2,splatUVint,0);\n#endif\nreturn splat;}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nvec3 computeColorFromSHDegree(vec3 dir,const vec3 sh[16])\n{const float SH_C0=0.28209479;const float SH_C1=0.48860251;float SH_C2[5];SH_C2[0]=1.092548430;SH_C2[1]=-1.09254843;SH_C2[2]=0.315391565;SH_C2[3]=-1.09254843;SH_C2[4]=0.546274215;float SH_C3[7];SH_C3[0]=-0.59004358;SH_C3[1]=2.890611442;SH_C3[2]=-0.45704579;SH_C3[3]=0.373176332;SH_C3[4]=-0.45704579;SH_C3[5]=1.445305721;SH_C3[6]=-0.59004358;vec3 result=/*SH_C0**/sh[0];\n#if SH_DEGREE>0\nfloat x=dir.x;float y=dir.y;float z=dir.z;result+=- SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];\n#if SH_DEGREE>1\nfloat xx=x*x,yy=y*y,zz=z*z;float xy=x*y,yz=y*z,xz=x*z;result+=\nSH_C2[0]*xy*sh[4] +\nSH_C2[1]*yz*sh[5] +\nSH_C2[2]*(2.0*zz-xx-yy)*sh[6] +\nSH_C2[3]*xz*sh[7] +\nSH_C2[4]*(xx-yy)*sh[8];\n#if SH_DEGREE>2\nresult+=\nSH_C3[0]*y*(3.0*xx-yy)*sh[9] +\nSH_C3[1]*xy*z*sh[10] +\nSH_C3[2]*y*(4.0*zz-xx-yy)*sh[11] +\nSH_C3[3]*z*(2.0*zz-3.0*xx-3.0*yy)*sh[12] +\nSH_C3[4]*x*(4.0*zz-xx-yy)*sh[13] +\nSH_C3[5]*z*(xx-yy)*sh[14] +\nSH_C3[6]*x*(xx-3.0*yy)*sh[15];\n#endif\n#endif\n#endif\nreturn result;}\nvec4 decompose(uint value)\n{vec4 components=vec4(\nfloat((value ) & 255u),\nfloat((value>>uint( 8)) & 255u),\nfloat((value>>uint(16)) & 255u),\nfloat((value>>uint(24)) & 255u));return components*vec4(2./255.)-vec4(1.);}\nvec3 computeSH(Splat splat,vec3 dir)\n{vec3 sh[16];sh[0]=vec3(0.,0.,0.);\n#if SH_DEGREE>0\nvec4 sh00=decompose(splat.sh0.x);vec4 sh01=decompose(splat.sh0.y);vec4 sh02=decompose(splat.sh0.z);sh[1]=vec3(sh00.x,sh00.y,sh00.z);sh[2]=vec3(sh00.w,sh01.x,sh01.y);sh[3]=vec3(sh01.z,sh01.w,sh02.x);\n#endif\n#if SH_DEGREE>1\nvec4 sh03=decompose(splat.sh0.w);vec4 sh04=decompose(splat.sh1.x);vec4 sh05=decompose(splat.sh1.y);sh[4]=vec3(sh02.y,sh02.z,sh02.w);sh[5]=vec3(sh03.x,sh03.y,sh03.z);sh[6]=vec3(sh03.w,sh04.x,sh04.y);sh[7]=vec3(sh04.z,sh04.w,sh05.x);sh[8]=vec3(sh05.y,sh05.z,sh05.w);\n#endif\n#if SH_DEGREE>2\nvec4 sh06=decompose(splat.sh1.z);vec4 sh07=decompose(splat.sh1.w);vec4 sh08=decompose(splat.sh2.x);vec4 sh09=decompose(splat.sh2.y);vec4 sh10=decompose(splat.sh2.z);vec4 sh11=decompose(splat.sh2.w);sh[9]=vec3(sh06.x,sh06.y,sh06.z);sh[10]=vec3(sh06.w,sh07.x,sh07.y);sh[11]=vec3(sh07.z,sh07.w,sh08.x);sh[12]=vec3(sh08.y,sh08.z,sh08.w);sh[13]=vec3(sh09.x,sh09.y,sh09.z);sh[14]=vec3(sh09.w,sh10.x,sh10.y);sh[15]=vec3(sh10.z,sh10.w,sh11.x); \n#endif\nreturn computeColorFromSHDegree(dir,sh);}\n#else\nvec3 computeSH(Splat splat,vec3 dir)\n{return vec3(0.,0.,0.);}\n#endif\nvec4 gaussianSplatting(vec2 meshPos,vec3 worldPos,vec2 scale,vec3 covA,vec3 covB,mat4 worldMatrix,mat4 viewMatrix,mat4 projectionMatrix)\n{mat4 modelView=viewMatrix*worldMatrix;vec4 camspace=viewMatrix*vec4(worldPos,1.);vec4 pos2d=projectionMatrix*camspace;float bounds=1.2*pos2d.w;if (pos2d.z<-pos2d.w || pos2d.x<-bounds || pos2d.x>bounds\n|| pos2d.y<-bounds || pos2d.y>bounds) {return vec4(0.0,0.0,2.0,1.0);}\nmat3 Vrk=mat3(\ncovA.x,covA.y,covA.z,\ncovA.y,covB.x,covB.y,\ncovA.z,covB.y,covB.z\n);bool isOrtho=abs(projectionMatrix[3][3]-1.0)<0.001;mat3 J;if (isOrtho) {J=mat3(\nfocal.x,0.,0.,\n0.,focal.y,0.,\n0.,0.,0.\n);} else {J=mat3(\nfocal.x/camspace.z,0.,-(focal.x*camspace.x)/(camspace.z*camspace.z),\n0.,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),\n0.,0.,0.\n);}\nmat3 invy=mat3(1,0,0,0,-1,0,0,0,1);mat3 T=invy*transpose(mat3(modelView))*J;mat3 cov2d=transpose(T)*Vrk*T;\n#if COMPENSATION\nfloat c00=cov2d[0][0];float c11=cov2d[1][1];float c01=cov2d[0][1];float detOrig=c00*c11-c01*c01;\n#endif\ncov2d[0][0]+=kernelSize;cov2d[1][1]+=kernelSize;\n#if COMPENSATION\nvec3 c2d=vec3(cov2d[0][0],c01,cov2d[1][1]);float detBlur=c2d.x*c2d.z-c2d.y*c2d.y;float compensation=sqrt(max(0.,detOrig/detBlur));vColor.w*=compensation;\n#endif\nfloat mid=(cov2d[0][0]+cov2d[1][1])/2.0;float radius=length(vec2((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));float epsilon=0.0001;float lambda1=mid+radius+epsilon,lambda2=mid-radius+epsilon;if (lambda2<0.0)\n{return vec4(0.0,0.0,2.0,1.0);}\nvec2 diagonalVector=normalize(vec2(cov2d[0][1],lambda1-cov2d[0][0]));vec2 majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;vec2 minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2(diagonalVector.y,-diagonalVector.x);vec2 vCenter=vec2(pos2d);float scaleFactor=isOrtho ? 1.0 : pos2d.w;return vec4(\nvCenter \n+ ((meshPos.x*majorAxis\n+ meshPos.y*minorAxis)*invViewport*scaleFactor)*scale,pos2d.zw);}");const ae$2="gaussianSplattingVertexShader",ie$2="#include<__decl__gaussianSplattingVertex>\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\nattribute float splatIndex;uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform float kernelSize;uniform vec3 eyePosition;uniform vec3 viewDirectionFactor;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;uniform sampler2D colorsTexture;\n#if SH_DEGREE>0\nuniform highp usampler2D shTexture0;\n#endif\n#if SH_DEGREE>1\nuniform highp usampler2D shTexture1;\n#endif\n#if SH_DEGREE>2\nuniform highp usampler2D shTexture2;\n#endif\nvarying vec4 vColor;varying vec2 vPosition;\n#include<gaussianSplatting>\nvoid main () {Splat splat=readSplat(splatIndex);vec3 covA=splat.covA.xyz;vec3 covB=vec3(splat.covA.w,splat.covB.xy);vec4 worldPos=world*vec4(splat.center.xyz,1.0);vColor=splat.color;vPosition=position;\n#if SH_DEGREE>0\nmat3 worldRot=mat3(world);mat3 normWorldRot=inverseMat3(worldRot);vec3 dir=normalize(normWorldRot*(worldPos.xyz-eyePosition));dir*=viewDirectionFactor;vColor.xyz=splat.color.xyz+computeSH(splat,dir);\n#endif\ngl_Position=gaussianSplatting(position,worldPos.xyz,vec2(1.,1.),covA,covB,world,view,projection);\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n}\n";bt$1.ShadersStore[ae$2]||(bt$1.ShadersStore[ae$2]=ie$2);const oe$2={name:ae$2,shader:ie$2};var ce$1=Object.freeze({__proto__:null,gaussianSplattingVertexShader:oe$2});const le$1="gaussianSplattingFragmentDeclaration";bt$1.IncludesShadersStoreWGSL[le$1]||(bt$1.IncludesShadersStoreWGSL[le$1]="fn gaussianColor(inColor: vec4f,inPosition: vec2f)->vec4f\n{var A : f32=-dot(inPosition,inPosition);if (A>-4.0)\n{var B: f32=exp(A)*inColor.a;\n#include<logDepthFragment>\nvar color: vec3f=inColor.rgb;\n#ifdef FOG\n#include<fogFragment>\n#endif\nreturn vec4f(color,B);} else {return vec4f(0.0);}}\n");const he$2="gaussianSplattingPixelShader",ue$2="#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\nvarying vColor: vec4f;varying vPosition: vec2f;\n#include<gaussianSplattingFragmentDeclaration>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\nfragmentOutputs.color=gaussianColor(input.vColor,input.vPosition);}\n";bt$1.ShadersStoreWGSL[he$2]||(bt$1.ShadersStoreWGSL[he$2]=ue$2);const de$1={name:he$2,shader:ue$2};var pe$1=Object.freeze({__proto__:null,gaussianSplattingPixelShaderWGSL:de$1});const fe$1="gaussianSplatting";bt$1.IncludesShadersStoreWGSL[fe$1]||(bt$1.IncludesShadersStoreWGSL[fe$1]="fn getDataUV(index: f32,dataTextureSize: vec2f)->vec2<f32> {let y: f32=floor(index/dataTextureSize.x);let x: f32=index-y*dataTextureSize.x;return vec2f((x+0.5),(y+0.5));}\nstruct Splat {center: vec4f,\n#ifndef GS_DISABLE_COLOR\ncolor: vec4f,\n#endif\ncovA: vec4f,\ncovB: vec4f,\n#if SH_DEGREE>0\nsh0: vec4<u32>,\n#endif\n#if SH_DEGREE>1\nsh1: vec4<u32>,\n#endif\n#if SH_DEGREE>2\nsh2: vec4<u32>,\n#endif\n};fn readSplat(splatIndex: f32,dataTextureSize: vec2f)->Splat {var splat: Splat;let splatUV=getDataUV(splatIndex,dataTextureSize);let splatUVi32=vec2<i32>(i32(splatUV.x),i32(splatUV.y));splat.center=textureLoad(centersTexture,splatUVi32,0);\n#ifndef GS_DISABLE_COLOR\nsplat.color=textureLoad(colorsTexture,splatUVi32,0);\n#endif\nsplat.covA=textureLoad(covariancesATexture,splatUVi32,0)*splat.center.w;splat.covB=textureLoad(covariancesBTexture,splatUVi32,0)*splat.center.w;\n#if SH_DEGREE>0\nsplat.sh0=textureLoad(shTexture0,splatUVi32,0);\n#endif\n#if SH_DEGREE>1\nsplat.sh1=textureLoad(shTexture1,splatUVi32,0);\n#endif\n#if SH_DEGREE>2\nsplat.sh2=textureLoad(shTexture2,splatUVi32,0);\n#endif\nreturn splat;}\nfn computeColorFromSHDegree(dir: vec3f,sh: array<vec3<f32>,16>)->vec3f\n{let SH_C0: f32=0.28209479;let SH_C1: f32=0.48860251;var SH_C2: array<f32,5>=array<f32,5>(\n1.092548430,\n-1.09254843,\n0.315391565,\n-1.09254843,\n0.546274215\n);var SH_C3: array<f32,7>=array<f32,7>(\n-0.59004358,\n2.890611442,\n-0.45704579,\n0.373176332,\n-0.45704579,\n1.445305721,\n-0.59004358\n);var result: vec3f=/*SH_C0**/sh[0];\n#if SH_DEGREE>0\nlet x: f32=dir.x;let y: f32=dir.y;let z: f32=dir.z;result+=-SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];\n#if SH_DEGREE>1\nlet xx: f32=x*x;let yy: f32=y*y;let zz: f32=z*z;let xy: f32=x*y;let yz: f32=y*z;let xz: f32=x*z;result+=\nSH_C2[0]*xy*sh[4] +\nSH_C2[1]*yz*sh[5] +\nSH_C2[2]*(2.0f*zz-xx-yy)*sh[6] +\nSH_C2[3]*xz*sh[7] +\nSH_C2[4]*(xx-yy)*sh[8];\n#if SH_DEGREE>2\nresult+=\nSH_C3[0]*y*(3.0f*xx-yy)*sh[9] +\nSH_C3[1]*xy*z*sh[10] +\nSH_C3[2]*y*(4.0f*zz-xx-yy)*sh[11] +\nSH_C3[3]*z*(2.0f*zz-3.0f*xx-3.0f*yy)*sh[12] +\nSH_C3[4]*x*(4.0f*zz-xx-yy)*sh[13] +\nSH_C3[5]*z*(xx-yy)*sh[14] +\nSH_C3[6]*x*(xx-3.0f*yy)*sh[15];\n#endif\n#endif\n#endif\nreturn result;}\nfn decompose(value: u32)->vec4f\n{let components : vec4f=vec4f(\nf32((value ) & 255u),\nf32((value>>u32( 8)) & 255u),\nf32((value>>u32(16)) & 255u),\nf32((value>>u32(24)) & 255u));return components*vec4f(2./255.)-vec4f(1.);}\nfn computeSH(splat: Splat,dir: vec3f)->vec3f\n{var sh: array<vec3<f32>,16>;sh[0]=vec3f(0.,0.,0.);\n#if SH_DEGREE>0\nlet sh00: vec4f=decompose(splat.sh0.x);let sh01: vec4f=decompose(splat.sh0.y);let sh02: vec4f=decompose(splat.sh0.z);sh[1]=vec3f(sh00.x,sh00.y,sh00.z);sh[2]=vec3f(sh00.w,sh01.x,sh01.y);sh[3]=vec3f(sh01.z,sh01.w,sh02.x);\n#endif\n#if SH_DEGREE>1\nlet sh03: vec4f=decompose(splat.sh0.w);let sh04: vec4f=decompose(splat.sh1.x);let sh05: vec4f=decompose(splat.sh1.y);sh[4]=vec3f(sh02.y,sh02.z,sh02.w);sh[5]=vec3f(sh03.x,sh03.y,sh03.z);sh[6]=vec3f(sh03.w,sh04.x,sh04.y);sh[7]=vec3f(sh04.z,sh04.w,sh05.x);sh[8]=vec3f(sh05.y,sh05.z,sh05.w);\n#endif\n#if SH_DEGREE>2\nlet sh06: vec4f=decompose(splat.sh1.z);let sh07: vec4f=decompose(splat.sh1.w);let sh08: vec4f=decompose(splat.sh2.x);let sh09: vec4f=decompose(splat.sh2.y);let sh10: vec4f=decompose(splat.sh2.z);let sh11: vec4f=decompose(splat.sh2.w);sh[9]=vec3f(sh06.x,sh06.y,sh06.z);sh[10]=vec3f(sh06.w,sh07.x,sh07.y);sh[11]=vec3f(sh07.z,sh07.w,sh08.x);sh[12]=vec3f(sh08.y,sh08.z,sh08.w);sh[13]=vec3f(sh09.x,sh09.y,sh09.z);sh[14]=vec3f(sh09.w,sh10.x,sh10.y);sh[15]=vec3f(sh10.z,sh10.w,sh11.x); \n#endif\nreturn computeColorFromSHDegree(dir,sh);}\nfn gaussianSplatting(\nmeshPos: vec2<f32>,\nworldPos: vec3<f32>,\nscale: vec2<f32>,\ncovA: vec3<f32>,\ncovB: vec3<f32>,\nworldMatrix: mat4x4<f32>,\nviewMatrix: mat4x4<f32>,\nprojectionMatrix: mat4x4<f32>,\nfocal: vec2f,\ninvViewport: vec2f,\nkernelSize: f32\n)->vec4f {let modelView=viewMatrix*worldMatrix;let camspace=viewMatrix*vec4f(worldPos,1.0);let pos2d=projectionMatrix*camspace;let bounds=1.2*pos2d.w;if (pos2d.z<0. || pos2d.x<-bounds || pos2d.x>bounds || pos2d.y<-bounds || pos2d.y>bounds) {return vec4f(0.0,0.0,2.0,1.0);}\nlet Vrk=mat3x3<f32>(\ncovA.x,covA.y,covA.z,\ncovA.y,covB.x,covB.y,\ncovA.z,covB.y,covB.z\n);let isOrtho=abs(projectionMatrix[3][3]-1.0)<0.001;var J: mat3x3<f32>;if (isOrtho) {J=mat3x3<f32>(\nfocal.x,0.0,0.0,\n0.0,focal.y,0.0,\n0.0,0.0,0.0\n);} else {J=mat3x3<f32>(\nfocal.x/camspace.z,0.0,-(focal.x*camspace.x)/(camspace.z*camspace.z),\n0.0,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),\n0.0,0.0,0.0\n);}\nlet invy=mat3x3<f32>(\n1.0,0.0,0.0,\n0.0,-1.0,0.0,\n0.0,0.0,1.0\n);let T=invy*transpose(mat3x3<f32>(\nmodelView[0].xyz,\nmodelView[1].xyz,\nmodelView[2].xyz))*J;var cov2d=transpose(T)*Vrk*T;\n#if COMPENSATION\nlet c00: f32=cov2d[0][0];let c11: f32=cov2d[1][1];let c01: f32=cov2d[0][1];let detOrig: f32=c00*c11-c01*c01;\n#endif\ncov2d[0][0]+=kernelSize;cov2d[1][1]+=kernelSize;\n#if COMPENSATION\nlet c2d: vec3f=vec3f(cov2d[0][0],c01,cov2d[1][1]);let detBlur: f32=c2d.x*c2d.z-c2d.y*c2d.y;let compensation: f32=sqrt(max(0.,detOrig/detBlur));vertexOutputs.vColor.w*=compensation;\n#endif\nlet mid=(cov2d[0][0]+cov2d[1][1])/2.0;let radius=length(vec2<f32>((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));let lambda1=mid+radius;let lambda2=mid-radius;if (lambda2<0.0) {return vec4f(0.0,0.0,2.0,1.0);}\nlet diagonalVector=normalize(vec2<f32>(cov2d[0][1],lambda1-cov2d[0][0]));let majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;let minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2<f32>(diagonalVector.y,-diagonalVector.x);let vCenter=vec2<f32>(pos2d.x,pos2d.y);let scaleFactor=select(pos2d.w,1.0,isOrtho);return vec4f(\nvCenter+((meshPos.x*majorAxis+meshPos.y*minorAxis)*invViewport*scaleFactor)*scale,\npos2d.z,\npos2d.w\n);}");const _e$1="gaussianSplattingVertexShader",me$1="#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n#include<helperFunctions>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\nattribute splatIndex: f32;attribute position: vec2f;uniform invViewport: vec2f;uniform dataTextureSize: vec2f;uniform focal: vec2f;uniform kernelSize: f32;uniform eyePosition: vec3f;uniform viewDirectionFactor: vec3f;var covariancesATexture: texture_2d<f32>;var covariancesBTexture: texture_2d<f32>;var centersTexture: texture_2d<f32>;var colorsTexture: texture_2d<f32>;\n#if SH_DEGREE>0\nvar shTexture0: texture_2d<u32>;\n#endif\n#if SH_DEGREE>1\nvar shTexture1: texture_2d<u32>;\n#endif\n#if SH_DEGREE>2\nvar shTexture2: texture_2d<u32>;\n#endif\nvarying vColor: vec4f;varying vPosition: vec2f;\n#include<gaussianSplatting>\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var splat: Splat=readSplat(input.splatIndex,uniforms.dataTextureSize);var covA: vec3f=splat.covA.xyz;var covB: vec3f=vec3f(splat.covA.w,splat.covB.xy);let worldPos: vec4f=mesh.world*vec4f(splat.center.xyz,1.0);vertexOutputs.vPosition=input.position;\n#if SH_DEGREE>0\nlet worldRot: mat3x3f= mat3x3f(mesh.world[0].xyz,mesh.world[1].xyz,mesh.world[2].xyz);let normWorldRot: mat3x3f=inverseMat3(worldRot);var dir: vec3f=normalize(normWorldRot*(worldPos.xyz-uniforms.eyePosition.xyz));dir*=uniforms.viewDirectionFactor;vertexOutputs.vColor=vec4f(splat.color.xyz+computeSH(splat,dir),splat.color.w);\n#else\nvertexOutputs.vColor=splat.color;\n#endif\nvertexOutputs.position=gaussianSplatting(input.position,worldPos.xyz,vec2f(1.0,1.0),covA,covB,mesh.world,scene.view,scene.projection,uniforms.focal,uniforms.invViewport,uniforms.kernelSize);\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n}\n";bt$1.ShadersStoreWGSL[_e$1]||(bt$1.ShadersStoreWGSL[_e$1]=me$1);const xe$1={name:_e$1,shader:me$1};var ve$1=Object.freeze({__proto__:null,gaussianSplattingVertexShaderWGSL:xe$1});const Se$1="gaussianSplattingDepthPixelShader";bt$1.ShadersStore[Se$1]||(bt$1.ShadersStore[Se$1]="precision highp float;varying vec2 vPosition;void main(void) {float A=-dot(vPosition,vPosition);if (A<-1.) discard;}");const ge$1="gaussianSplattingDepthVertexShader";bt$1.ShadersStore[ge$1]||(bt$1.ShadersStore[ge$1]="#include<__decl__gaussianSplattingVertex>\nattribute float splatIndex;uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform float kernelSize;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;varying vec2 vPosition;\n#include<gaussianSplatting>\nvoid main(void) {Splat splat=readSplat(splatIndex);vec3 covA=splat.covA.xyz;vec3 covB=vec3(splat.covA.w,splat.covB.xy);vec4 worldPosGS=world*vec4(splat.center.xyz,1.0);vPosition=position.xy;gl_Position=gaussianSplatting(position.xy,worldPosGS.xyz,vec2(1.,1.),covA,covB,world,view,projection);}");const ye$1="gaussianSplattingDepthPixelShader";bt$1.ShadersStoreWGSL[ye$1]||(bt$1.ShadersStoreWGSL[ye$1]="#include<gaussianSplattingFragmentDeclaration>\nvarying vPosition: vec2f;fn checkDiscard(inPosition: vec2f)->vec4f {var A : f32=-dot(inPosition,inPosition);if (A<-1.) {discard;}\nreturn vec4f(0.0);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=checkDiscard(fragmentInputs.vPosition);}\n");const we$1="gaussianSplattingDepthVertexShader";bt$1.ShadersStoreWGSL[we$1]||(bt$1.ShadersStoreWGSL[we$1]="#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\nattribute splatIndex: f32;attribute position: vec2f;uniform invViewport: vec2f;uniform dataTextureSize: vec2f;uniform focal: vec2f;uniform kernelSize: f32;var covariancesATexture: texture_2d<f32>;var covariancesBTexture: texture_2d<f32>;var centersTexture: texture_2d<f32>;varying vPosition: vec2f;\n#include<gaussianSplatting>\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var splat: Splat=readSplat(input.splatIndex,uniforms.dataTextureSize);var covA: vec3f=splat.covA.xyz;var covB: vec3f=vec3f(splat.covA.w,splat.covB.xy);let worldPos: vec4f=mesh.world*vec4f(splat.center.xyz,1.0);vertexOutputs.vPosition=input.position;vertexOutputs.position=gaussianSplatting(input.position,worldPos.xyz,vec2f(1.0,1.0),covA,covB,mesh.world,scene.view,scene.projection,uniforms.focal,uniforms.invViewport,uniforms.kernelSize);}");let Ce$1=class Ce extends Eh{constructor(){super(),this.FOG=false,this.THIN_INSTANCES=true,this.LOGARITHMICDEPTH=false,this.CLIPPLANE=false,this.CLIPPLANE2=false,this.CLIPPLANE3=false,this.CLIPPLANE4=false,this.CLIPPLANE5=false,this.CLIPPLANE6=false,this.SH_DEGREE=0,this.COMPENSATION=false,this.rebuild();}};let Te$1=class Te extends Ah{constructor(e,t){super(e,t),this.kernelSize=Te.KernelSize,this._compensation=Te.Compensation,this._isDirty=false,this.backFaceCulling=false,this.shadowDepthWrapper=Te._MakeGaussianSplattingShadowDepthWrapper(t,this.shaderLanguage);}set compensation(e){this._isDirty=this._isDirty!=e,this._compensation=e;}get compensation(){return this._compensation}get hasRenderTargetTextures(){return  false}needAlphaTesting(){return  false}needAlphaBlending(){return  true}isReadyForSubMesh(e,t){const s=true,n=t._drawWrapper;let r=t.materialDefines;if(r&&this._isDirty&&r.markAsUnprocessed(),n.effect&&this.isFrozen&&n._wasPreviouslyReady&&n._wasPreviouslyUsingInstances===s)return  true;t.materialDefines||(r=t.materialDefines=new Ce$1);const a=this.getScene();if(this._isReadyForSubMesh(t))return  true;const d=a.getEngine(),p=e;js(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,false,r,void 0,void 0,void 0,this._isVertexOutputInvariant),Js(a,d,this,r,s,null,true),$s(e,r,false,false),(d.version>1||d.isWebGPU)&&(r.SH_DEGREE=p.shDegree);const f=p.material;if(r.COMPENSATION=f&&f.compensation?f.compensation:Te.Compensation,r.isDirty){r.markAsProcessed(),a.resetCachedMaterial(),Ys(Te._Attribs,r),nr$1({uniformsNames:Te._Uniforms,uniformBuffersNames:Te._UniformBuffers,samplers:Te._Samplers,defines:r}),Ts(Te._Uniforms);const e=r.toString(),s=a.getEngine().createEffect("gaussianSplatting",{attributes:Te._Attribs,uniformsNames:Te._Uniforms,uniformBuffersNames:Te._UniformBuffers,samplers:Te._Samplers,defines:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then((function(){return pe$1})),Promise.resolve().then((function(){return ve$1}))]):await Promise.all([Promise.resolve().then((function(){return te$1})),Promise.resolve().then((function(){return ce$1}))]);}},d);t.setEffect(s,r,this._materialContext);}return !(!t.effect||!t.effect.isReady())&&(r._renderId=a.getRenderId(),n._wasPreviouslyReady=true,n._wasPreviouslyUsingInstances=s,this._isDirty=false,true)}static BindEffect(e,t,s){const n=s.getEngine(),r=s.activeCamera,a=n.getRenderWidth(),i=n.getRenderHeight(),o=e,c=o.material,l=r?.rigParent?.rigCameras.length||1;t.setFloat2("invViewport",1/(a/l),1/i);let h=1e3;if(r){const e=r.getProjectionMatrix().m[5];h=r.fovMode==Di.FOVMODE_VERTICAL_FIXED?i*e/2:a*e/2;}if(t.setFloat2("focal",h,h),t.setVector3("viewDirectionFactor",o.viewDirectionFactor),t.setFloat("kernelSize",c&&c.kernelSize?c.kernelSize:Te.KernelSize),s.bindEyePosition(t,"eyePosition",true),o.covariancesATexture){const e=o.covariancesATexture.getSize();if(t.setFloat2("dataTextureSize",e.width,e.height),t.setTexture("covariancesATexture",o.covariancesATexture),t.setTexture("covariancesBTexture",o.covariancesBTexture),t.setTexture("centersTexture",o.centersTexture),t.setTexture("colorsTexture",o.colorsTexture),o.shTextures)for(let e=0;e<o.shTextures?.length;e++)t.setTexture(`shTexture${e}`,o.shTextures[e]);}}bindForSubMesh(e,t,s){const n=this.getScene(),r=s.materialDefines;if(!r)return;const a=s.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e);this._mustRebind(n,a,s,t.visibility)?(this.bindView(a),this.bindViewProjection(a),Te.BindEffect(t,this._activeEffect,n),As(a,this,n)):n.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=true),Os(n,t,a),this.useLogarithmicDepth&&Cs(r,a,n),this._afterBind(t,this._activeEffect,s);}static _MakeGaussianSplattingShadowDepthWrapper(e,t){const s=new O$8("gaussianSplattingDepth",e,{vertex:"gaussianSplattingDepth",fragment:"gaussianSplattingDepth"},{attributes:Te._Attribs,uniforms:Te._Uniforms,samplers:Te._Samplers,uniformBuffers:Te._UniformBuffers,shaderLanguage:t,defines:["#define GS_DISABLE_COLOR"]}),n=new q$2(s,e,{standalone:true});return s.onBindObservable.add((t=>{const n=s.getEffect(),r=t.material,a=t;t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),s.bindView(n),s.bindViewProjection(n);const i=e.getEngine().getRenderWidth(),o=e.getEngine().getRenderHeight();n.setFloat2("invViewport",1/i,1/o);const c=i*e.getProjectionMatrix().m[5]/2;if(n.setFloat2("focal",c,c),n.setFloat("kernelSize",r&&r.kernelSize?r.kernelSize:Te.KernelSize),a.covariancesATexture){const e=a.covariancesATexture.getSize();n.setFloat2("dataTextureSize",e.width,e.height),n.setTexture("covariancesATexture",a.covariancesATexture),n.setTexture("covariancesBTexture",a.covariancesBTexture),n.setTexture("centersTexture",a.centersTexture);}})),n}clone(e){return Ae$3.Clone((()=>new Te(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.GaussianSplattingMaterial",e}getClassName(){return "GaussianSplattingMaterial"}static Parse(e,t,s){return Ae$3.Parse((()=>new Te(e.name,t)),e,t,s)}};Te$1.KernelSize=.3,Te$1.Compensation=false,Te$1._Attribs=[Hi.PositionKind,"splatIndex"],Te$1._Samplers=["covariancesATexture","covariancesBTexture","centersTexture","colorsTexture","shTexture0","shTexture1","shTexture2"],Te$1._UniformBuffers=["Scene","Mesh"],Te$1._Uniforms=["world","view","projection","vFogInfos","vFogColor","logarithmicDepthConstant","invViewport","dataTextureSize","focal","eyePosition","kernelSize","viewDirectionFactor"],P$9("BABYLON.GaussianSplattingMaterial",Te$1);const Ee$1=W$4,Ae$1={...Y$5,TwoPi:2*Math.PI,Sign:Math.sign,Log2:Math.log2,HCF:Ee$1},be$1=(e,t)=>{const s=(1<<t)-1;return (e&s)/s},Me$1=(e,t)=>{t.x=be$1(e>>>21,11),t.y=be$1(e>>>11,10),t.z=be$1(e,11);},De$1=(e,t)=>{t[0]=255*be$1(e>>>24,8),t[1]=255*be$1(e>>>16,8),t[2]=255*be$1(e>>>8,8),t[3]=255*be$1(e,8);},Pe$1=(e,t)=>{const s=1/(.5*Math.sqrt(2)),n=(be$1(e>>>20,10)-.5)*s,r=(be$1(e>>>10,10)-.5)*s,a=(be$1(e,10)-.5)*s,i=Math.sqrt(1-(n*n+r*r+a*a));switch(e>>>30){case 0:t.set(i,n,r,a);break;case 1:t.set(n,i,r,a);break;case 2:t.set(n,r,i,a);break;case 3:t.set(n,r,a,i);}};var ze$1,He$1,Ie$1;!function(e){e[e.FLOAT=0]="FLOAT",e[e.INT=1]="INT",e[e.UINT=2]="UINT",e[e.DOUBLE=3]="DOUBLE",e[e.UCHAR=4]="UCHAR",e[e.UNDEFINED=5]="UNDEFINED";}(ze$1||(ze$1={})),function(e){e[e.MIN_X=0]="MIN_X",e[e.MIN_Y=1]="MIN_Y",e[e.MIN_Z=2]="MIN_Z",e[e.MAX_X=3]="MAX_X",e[e.MAX_Y=4]="MAX_Y",e[e.MAX_Z=5]="MAX_Z",e[e.MIN_SCALE_X=6]="MIN_SCALE_X",e[e.MIN_SCALE_Y=7]="MIN_SCALE_Y",e[e.MIN_SCALE_Z=8]="MIN_SCALE_Z",e[e.MAX_SCALE_X=9]="MAX_SCALE_X",e[e.MAX_SCALE_Y=10]="MAX_SCALE_Y",e[e.MAX_SCALE_Z=11]="MAX_SCALE_Z",e[e.PACKED_POSITION=12]="PACKED_POSITION",e[e.PACKED_ROTATION=13]="PACKED_ROTATION",e[e.PACKED_SCALE=14]="PACKED_SCALE",e[e.PACKED_COLOR=15]="PACKED_COLOR",e[e.X=16]="X",e[e.Y=17]="Y",e[e.Z=18]="Z",e[e.SCALE_0=19]="SCALE_0",e[e.SCALE_1=20]="SCALE_1",e[e.SCALE_2=21]="SCALE_2",e[e.DIFFUSE_RED=22]="DIFFUSE_RED",e[e.DIFFUSE_GREEN=23]="DIFFUSE_GREEN",e[e.DIFFUSE_BLUE=24]="DIFFUSE_BLUE",e[e.OPACITY=25]="OPACITY",e[e.F_DC_0=26]="F_DC_0",e[e.F_DC_1=27]="F_DC_1",e[e.F_DC_2=28]="F_DC_2",e[e.F_DC_3=29]="F_DC_3",e[e.ROT_0=30]="ROT_0",e[e.ROT_1=31]="ROT_1",e[e.ROT_2=32]="ROT_2",e[e.ROT_3=33]="ROT_3",e[e.MIN_COLOR_R=34]="MIN_COLOR_R",e[e.MIN_COLOR_G=35]="MIN_COLOR_G",e[e.MIN_COLOR_B=36]="MIN_COLOR_B",e[e.MAX_COLOR_R=37]="MAX_COLOR_R",e[e.MAX_COLOR_G=38]="MAX_COLOR_G",e[e.MAX_COLOR_B=39]="MAX_COLOR_B",e[e.SH_0=40]="SH_0",e[e.SH_1=41]="SH_1",e[e.SH_2=42]="SH_2",e[e.SH_3=43]="SH_3",e[e.SH_4=44]="SH_4",e[e.SH_5=45]="SH_5",e[e.SH_6=46]="SH_6",e[e.SH_7=47]="SH_7",e[e.SH_8=48]="SH_8",e[e.SH_9=49]="SH_9",e[e.SH_10=50]="SH_10",e[e.SH_11=51]="SH_11",e[e.SH_12=52]="SH_12",e[e.SH_13=53]="SH_13",e[e.SH_14=54]="SH_14",e[e.SH_15=55]="SH_15",e[e.SH_16=56]="SH_16",e[e.SH_17=57]="SH_17",e[e.SH_18=58]="SH_18",e[e.SH_19=59]="SH_19",e[e.SH_20=60]="SH_20",e[e.SH_21=61]="SH_21",e[e.SH_22=62]="SH_22",e[e.SH_23=63]="SH_23",e[e.SH_24=64]="SH_24",e[e.SH_25=65]="SH_25",e[e.SH_26=66]="SH_26",e[e.SH_27=67]="SH_27",e[e.SH_28=68]="SH_28",e[e.SH_29=69]="SH_29",e[e.SH_30=70]="SH_30",e[e.SH_31=71]="SH_31",e[e.SH_32=72]="SH_32",e[e.SH_33=73]="SH_33",e[e.SH_34=74]="SH_34",e[e.SH_35=75]="SH_35",e[e.SH_36=76]="SH_36",e[e.SH_37=77]="SH_37",e[e.SH_38=78]="SH_38",e[e.SH_39=79]="SH_39",e[e.SH_40=80]="SH_40",e[e.SH_41=81]="SH_41",e[e.SH_42=82]="SH_42",e[e.SH_43=83]="SH_43",e[e.SH_44=84]="SH_44",e[e.UNDEFINED=85]="UNDEFINED";}(He$1||(He$1={}));let Re$1=class Re extends Er$1{get viewDirectionFactor(){return this._viewDirectionFactor}get shDegree(){return this._shDegree}get splatCount(){return this._splatIndex?.length}get splatsData(){return this._splatsData}get covariancesATexture(){return this._covariancesATexture}get covariancesBTexture(){return this._covariancesBTexture}get centersTexture(){return this._centersTexture}get colorsTexture(){return this._colorsTexture}get shTextures(){return this._shTextures}get kernelSize(){return this._material instanceof Te$1?this._material.kernelSize:0}get compensation(){return this._material instanceof Te$1&&this._material.compensation}set material(e){this._material=e,this._material.backFaceCulling=true,this._material.cullBackFaces=false,e.resetDrawCache();}get material(){return this._material}constructor(e,t=null,s=null,n=false){super(e,s),this._vertexCount=0,this._worker=null,this._frameIdLastUpdate=-1,this._modelViewMatrix=re$5.Identity(),this._canPostToWorker=true,this._readyToDisplay=false,this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._splatPositions=null,this._splatIndex=null,this._shTextures=null,this._splatsData=null,this._sh=null,this._keepInRam=false,this._delayedTextureUpdate=null,this._oldDirection=new te$4,this._useRGBACovariants=false,this._material=null,this._tmpCovariances=[0,0,0,0,0,0],this._sortIsDirty=false,this._shDegree=0,this._viewDirectionFactor=new te$4(1,1,-1);const r=new is;r.positions=[-2,-2,0,2,-2,0,2,2,0,-2,2,0],r.indices=[0,1,2,0,2,3],r.applyToMesh(this),this.subMeshes=[],new es(0,0,4,0,6,this),this.setEnabled(false),this._useRGBACovariants=!this.getEngine().isWebGPU&&1===this.getEngine().version,this._keepInRam=n,t&&this.loadFileAsync(t),this._material=new Te$1(this.name+"_material",this._scene);}getClassName(){return "GaussianSplattingMesh"}getTotalVertices(){return this._vertexCount}isReady(e=false){return !!super.isReady(e,true)&&(!!this._readyToDisplay||(this._postToWorker(true),false))}_postToWorker(e=false){const t=this.getScene().getFrameId();if((e||t!==this._frameIdLastUpdate)&&this._worker&&this._scene.activeCamera&&this._canPostToWorker){const s=this._scene.activeCamera.getViewMatrix();this.getWorldMatrix().multiplyToRef(s,this._modelViewMatrix),s.invertToRef(ae$5.Matrix[0]),this.getWorldMatrix().multiplyToRef(ae$5.Matrix[0],ae$5.Matrix[1]),te$4.TransformNormalToRef(te$4.Forward(this._scene.useRightHandedSystem),ae$5.Matrix[1],ae$5.Vector3[2]),ae$5.Vector3[2].normalize();const n=te$4.Dot(ae$5.Vector3[2],this._oldDirection);(e||Math.abs(n-1)>=.01)&&(this._oldDirection.copyFrom(ae$5.Vector3[2]),this._frameIdLastUpdate=t,this._canPostToWorker=false,this._worker.postMessage({view:this._modelViewMatrix.m,depthMix:this._depthMix,useRightHandedSystem:this._scene.useRightHandedSystem},[this._depthMix.buffer]));}}render(e,t,s){return this._postToWorker(),super.render(e,t,s)}static _TypeNameToEnum(e){switch(e){case "float":return 0;case "int":return 1;case "uint":return 2;case "double":return 3;case "uchar":return 4}return 5}static _ValueNameToEnum(e){switch(e){case "min_x":return 0;case "min_y":return 1;case "min_z":return 2;case "max_x":return 3;case "max_y":return 4;case "max_z":return 5;case "min_scale_x":return 6;case "min_scale_y":return 7;case "min_scale_z":return 8;case "max_scale_x":return 9;case "max_scale_y":return 10;case "max_scale_z":return 11;case "packed_position":return 12;case "packed_rotation":return 13;case "packed_scale":return 14;case "packed_color":return 15;case "x":return 16;case "y":return 17;case "z":return 18;case "scale_0":return 19;case "scale_1":return 20;case "scale_2":return 21;case "diffuse_red":case "red":return 22;case "diffuse_green":case "green":return 23;case "diffuse_blue":case "blue":return 24;case "f_dc_0":return 26;case "f_dc_1":return 27;case "f_dc_2":return 28;case "f_dc_3":return 29;case "opacity":return 25;case "rot_0":return 30;case "rot_1":return 31;case "rot_2":return 32;case "rot_3":return 33;case "min_r":return 34;case "min_g":return 35;case "min_b":return 36;case "max_r":return 37;case "max_g":return 38;case "max_b":return 39;case "f_rest_0":return 40;case "f_rest_1":return 41;case "f_rest_2":return 42;case "f_rest_3":return 43;case "f_rest_4":return 44;case "f_rest_5":return 45;case "f_rest_6":return 46;case "f_rest_7":return 47;case "f_rest_8":return 48;case "f_rest_9":return 49;case "f_rest_10":return 50;case "f_rest_11":return 51;case "f_rest_12":return 52;case "f_rest_13":return 53;case "f_rest_14":return 54;case "f_rest_15":return 55;case "f_rest_16":return 56;case "f_rest_17":return 57;case "f_rest_18":return 58;case "f_rest_19":return 59;case "f_rest_20":return 60;case "f_rest_21":return 61;case "f_rest_22":return 62;case "f_rest_23":return 63;case "f_rest_24":return 64;case "f_rest_25":return 65;case "f_rest_26":return 66;case "f_rest_27":return 67;case "f_rest_28":return 68;case "f_rest_29":return 69;case "f_rest_30":return 70;case "f_rest_31":return 71;case "f_rest_32":return 72;case "f_rest_33":return 73;case "f_rest_34":return 74;case "f_rest_35":return 75;case "f_rest_36":return 76;case "f_rest_37":return 77;case "f_rest_38":return 78;case "f_rest_39":return 79;case "f_rest_40":return 80;case "f_rest_41":return 81;case "f_rest_42":return 82;case "f_rest_43":return 83;case "f_rest_44":return 84}return 85}static ParseHeader(e){const t=new Uint8Array(e),s=(new TextDecoder).decode(t.slice(0,10240)),n="end_header\n",r=s.indexOf(n);if(r<0||!s)return null;const a=parseInt(/element vertex (\d+)\n/.exec(s)[1]),i=/element chunk (\d+)\n/.exec(s);let o=0;i&&(o=parseInt(i[1]));let c=0,l=0;const h={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};let u;!function(e){e[e.Vertex=0]="Vertex",e[e.Chunk=1]="Chunk",e[e.SH=2]="SH";}(u||(u={}));let d=1;const p=[],f=[],_=s.slice(0,r).split("\n");let m=0;for(const e of _)if(e.startsWith("property ")){const[,t,s]=e.split(" "),n=Re._ValueNameToEnum(s);85!=n&&(n>=84?m=3:n>=64?m=2:n>=48&&(m=1));const r=Re._TypeNameToEnum(t);1==d?(f.push({value:n,type:r,offset:l}),l+=h[t]):0==d?(p.push({value:n,type:r,offset:c}),c+=h[t]):2==d&&p.push({value:n,type:r,offset:c}),h[t]||Ie$2.Warn(`Unsupported property type: ${t}.`);}else if(e.startsWith("element ")){const[,t]=e.split(" ");"chunk"==t?d=1:"vertex"==t?d=0:"sh"==t&&(d=2);}const x=new DataView(e,r+11),v=new ArrayBuffer(Re._RowOutputLength*a);let S=null,g=0;if(m){g=3*((m+1)*(m+1)-1),S=new ArrayBuffer(g*a);}return {vertexCount:a,chunkCount:o,rowVertexLength:c,rowChunkLength:l,vertexProperties:p,chunkProperties:f,dataView:x,buffer:v,shDegree:m,shCoefficientCount:g,shBuffer:S}}static _GetCompressedChunks(e,t){if(!e.chunkCount)return null;const s=e.dataView,n=new Array(e.chunkCount);for(let r=0;r<e.chunkCount;r++){const a={min:new te$4,max:new te$4,minScale:new te$4,maxScale:new te$4,minColor:new te$4(0,0,0),maxColor:new te$4(1,1,1)};n[r]=a;for(let n=0;n<e.chunkProperties.length;n++){const r=e.chunkProperties[n];let i;if(0===r.type)switch(i=s.getFloat32(r.offset+t.value,true),r.value){case 0:a.min.x=i;break;case 1:a.min.y=i;break;case 2:a.min.z=i;break;case 3:a.max.x=i;break;case 4:a.max.y=i;break;case 5:a.max.z=i;break;case 6:a.minScale.x=i;break;case 7:a.minScale.y=i;break;case 8:a.minScale.z=i;break;case 9:a.maxScale.x=i;break;case 10:a.maxScale.y=i;break;case 11:a.maxScale.z=i;break;case 34:a.minColor.x=i;break;case 35:a.minColor.y=i;break;case 36:a.minColor.z=i;break;case 37:a.maxColor.x=i;break;case 38:a.maxColor.y=i;break;case 39:a.maxColor.z=i;}}t.value+=e.rowChunkLength;}return n}static _GetSplat(e,t,s,n){const r=ae$5.Quaternion[0],a=ae$5.Vector3[0],i=Re._RowOutputLength,o=e.buffer,c=e.dataView,l=new Float32Array(o,t*i,3),h=new Float32Array(o,t*i+12,3),u=new Uint8ClampedArray(o,t*i+24,4),d=new Uint8ClampedArray(o,t*i+28,4);let p=null;e.shBuffer&&(p=new Uint8ClampedArray(e.shBuffer,t*e.shCoefficientCount,e.shCoefficientCount));const f=t>>8;let _=255,m=0,x=0,v=0;const S=[];for(let i=0;i<e.vertexProperties.length;i++){const o=e.vertexProperties[i];let d;switch(o.type){case 0:d=c.getFloat32(n.value+o.offset,true);break;case 1:d=c.getInt32(n.value+o.offset,true);break;case 2:d=c.getUint32(n.value+o.offset,true);break;case 3:d=c.getFloat64(n.value+o.offset,true);break;case 4:d=c.getUint8(n.value+o.offset);break;default:continue}switch(o.value){case 12:{const e=s[f];Me$1(d,a),l[0]=Ae$1.Lerp(e.min.x,e.max.x,a.x),l[1]=Ae$1.Lerp(e.min.y,e.max.y,a.y),l[2]=Ae$1.Lerp(e.min.z,e.max.z,a.z);}break;case 13:Pe$1(d,r),_=r.x,m=r.y,x=r.z,v=r.w;break;case 14:{const e=s[f];Me$1(d,a),h[0]=Math.exp(Ae$1.Lerp(e.minScale.x,e.maxScale.x,a.x)),h[1]=Math.exp(Ae$1.Lerp(e.minScale.y,e.maxScale.y,a.y)),h[2]=Math.exp(Ae$1.Lerp(e.minScale.z,e.maxScale.z,a.z));}break;case 15:{const e=s[f];De$1(d,u),u[0]=255*Ae$1.Lerp(e.minColor.x,e.maxColor.x,u[0]/255),u[1]=255*Ae$1.Lerp(e.minColor.y,e.maxColor.y,u[1]/255),u[2]=255*Ae$1.Lerp(e.minColor.z,e.maxColor.z,u[2]/255);}break;case 16:l[0]=d;break;case 17:l[1]=d;break;case 18:l[2]=d;break;case 19:h[0]=Math.exp(d);break;case 20:h[1]=Math.exp(d);break;case 21:h[2]=Math.exp(d);break;case 22:u[0]=d;break;case 23:u[1]=d;break;case 24:u[2]=d;break;case 26:u[0]=255*(.5+Re._SH_C0*d);break;case 27:u[1]=255*(.5+Re._SH_C0*d);break;case 28:u[2]=255*(.5+Re._SH_C0*d);break;case 29:u[3]=255*(.5+Re._SH_C0*d);break;case 25:u[3]=1/(1+Math.exp(-d))*255;break;case 30:_=d;break;case 31:m=d;break;case 32:x=d;break;case 33:v=d;}if(p&&o.value>=40&&o.value<=84){const s=o.value-40;if(4==o.type&&e.chunkCount){const n=c.getUint8(e.rowChunkLength*e.chunkCount+e.vertexCount*e.rowVertexLength+t*e.shCoefficientCount+s);S[s]=127.5*(n*(8/255)-4)+127.5;}else {const e=Ae$1.Clamp(127.5*d+127.5,0,255);S[s]=e;}}}if(p){const t=1==e.shDegree?3:2==e.shDegree?8:15;for(let e=0;e<t;e++)p[3*e+0]=S[e],p[3*e+1]=S[e+t],p[3*e+2]=S[e+2*t];}r.set(m,x,v,_),r.normalize(),d[0]=127.5*r.w+127.5,d[1]=127.5*r.x+127.5,d[2]=127.5*r.y+127.5,d[3]=127.5*r.z+127.5,n.value+=e.rowVertexLength;}static*ConvertPLYWithSHToSplat(t,s=false){const n=Re.ParseHeader(t);if(!n)return {buffer:t};const r={value:0},a=Re._GetCompressedChunks(n,r);for(let e=0;e<n.vertexCount;e++)Re._GetSplat(n,e,a,r),e%Re._PlyConversionBatchSize===0&&s&&(yield);let i=null;if(n.shDegree&&n.shBuffer){const t=Math.ceil(n.shCoefficientCount/16);let s=0;const r=new Uint8Array(n.shBuffer);i=[];const a=n.vertexCount,o=L$7.LastCreatedEngine;if(o){const e=o.getCaps().maxTextureSize,c=Math.ceil(a/e);for(let s=0;s<t;s++){const t=new Uint8Array(c*e*4*4);i.push(t);}for(let e=0;e<a;e++)for(let t=0;t<n.shCoefficientCount;t++){const n=r[s++];i[Math.floor(t/16)][t%16+16*e]=n;}}}return {buffer:n.buffer,sh:i}}static*ConvertPLYToSplat(e,t=false){const s=Re.ParseHeader(e);if(!s)return e;const n={value:0},r=Re._GetCompressedChunks(s,n);for(let e=0;e<s.vertexCount;e++)Re._GetSplat(s,e,r,n),e%Re._PlyConversionBatchSize===0&&t&&(yield);return s.buffer}static async ConvertPLYToSplatAsync(e){return await yi(Re.ConvertPLYToSplat(e,true),Si())}static async ConvertPLYWithSHToSplatAsync(e){return await yi(Re.ConvertPLYWithSHToSplat(e,true),Si())}async loadDataAsync(e){return await this.updateDataAsync(e)}async loadFileAsync(e){const t=await Ai.LoadFileAsync(e,true),s=await Re.ConvertPLYWithSHToSplatAsync(t);await this.updateDataAsync(s.buffer,s.sh);}dispose(e){if(this._covariancesATexture?.dispose(),this._covariancesBTexture?.dispose(),this._centersTexture?.dispose(),this._colorsTexture?.dispose(),this._shTextures)for(const e of this._shTextures)e.dispose();this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._shTextures=null,this._worker?.terminate(),this._worker=null,super.dispose(e,true);}_copyTextures(e){if(this._covariancesATexture=e.covariancesATexture?.clone(),this._covariancesBTexture=e.covariancesBTexture?.clone(),this._centersTexture=e.centersTexture?.clone(),this._colorsTexture=e.colorsTexture?.clone(),e._shTextures){this._shTextures=[];for(const e of this._shTextures)this._shTextures?.push(e.clone());}}clone(e=""){const t=new Re(e,void 0,this.getScene());t._copySource(this),t.makeGeometryUnique(),t._vertexCount=this._vertexCount,t._copyTextures(this),t._modelViewMatrix=re$5.Identity(),t._splatPositions=this._splatPositions,t._readyToDisplay=false,t._instanciateWorker();const s=this.getBoundingInfo();return t.getBoundingInfo().reConstruct(s.minimum,s.maximum,this.getWorldMatrix()),t.forcedInstanceCount=t._vertexCount,t.setEnabled(true),t}_makeSplat(e,t,s,n,r,a,i,o){const c=ae$5.Matrix[0],l=ae$5.Matrix[1],h=ae$5.Quaternion[0],u=this._useRGBACovariants?4:2,d=t[8*e+0],p=-t[8*e+1],f=t[8*e+2];this._splatPositions[4*e+0]=d,this._splatPositions[4*e+1]=p,this._splatPositions[4*e+2]=f,i.minimizeInPlaceFromFloats(d,p,f),o.maximizeInPlaceFromFloats(d,p,f),h.set((s[32*e+28+1]-127.5)/127.5,(s[32*e+28+2]-127.5)/127.5,(s[32*e+28+3]-127.5)/127.5,-(s[32*e+28+0]-127.5)/127.5),h.normalize(),h.toRotationMatrix(c),re$5.ScalingToRef(2*t[8*e+3+0],2*t[8*e+3+1],2*t[8*e+3+2],l);const _=c.multiplyToRef(l,ae$5.Matrix[0]).m,m=this._tmpCovariances;m[0]=_[0]*_[0]+_[1]*_[1]+_[2]*_[2],m[1]=_[0]*_[4]+_[1]*_[5]+_[2]*_[6],m[2]=_[0]*_[8]+_[1]*_[9]+_[2]*_[10],m[3]=_[4]*_[4]+_[5]*_[5]+_[6]*_[6],m[4]=_[4]*_[8]+_[5]*_[9]+_[6]*_[10],m[5]=_[8]*_[8]+_[9]*_[9]+_[10]*_[10];let x=-1e4;for(let e=0;e<6;e++)x=Math.max(x,Math.abs(m[e]));this._splatPositions[4*e+3]=x;const v=x;n[4*e+0]=Lh(m[0]/v),n[4*e+1]=Lh(m[1]/v),n[4*e+2]=Lh(m[2]/v),n[4*e+3]=Lh(m[3]/v),r[e*u+0]=Lh(m[4]/v),r[e*u+1]=Lh(m[5]/v),a[4*e+0]=s[32*e+24+0],a[4*e+1]=s[32*e+24+1],a[4*e+2]=s[32*e+24+2],a[4*e+3]=s[32*e+24+3];}_updateTextures(e,t,s,n){const r=this._getTextureSize(this._vertexCount),a=(e,t,s,n)=>new E$f(e,t,s,n,this._scene,false,false,Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,Qe$1.TEXTURETYPE_FLOAT),i=(e,t,s,n)=>new E$f(e,t,s,n,this._scene,false,false,Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,Qe$1.TEXTURETYPE_UNSIGNED_BYTE),o=(e,t,s,n)=>new E$f(e,t,s,n,this._scene,false,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Qe$1.TEXTURETYPE_UNSIGNED_INTEGER),c=(e,t,s,n)=>new E$f(e,t,s,n,this._scene,false,false,Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,Qe$1.TEXTURETYPE_HALF_FLOAT);if(this._covariancesATexture){this._delayedTextureUpdate={covA:e,covB:t,colors:s,centers:this._splatPositions,sh:n};const r=Float32Array.from(this._splatPositions),a=this._vertexCount;this._worker.postMessage({positions:r,vertexCount:a},[r.buffer]),this._postToWorker(true);}else {if(this._covariancesATexture=c(e,r.x,r.y,Qe$1.TEXTUREFORMAT_RGBA),this._covariancesBTexture=c(t,r.x,r.y,this._useRGBACovariants?Qe$1.TEXTUREFORMAT_RGBA:Qe$1.TEXTUREFORMAT_RG),this._centersTexture=a(this._splatPositions,r.x,r.y,Qe$1.TEXTUREFORMAT_RGBA),this._colorsTexture=i(s,r.x,r.y,Qe$1.TEXTUREFORMAT_RGBA),n){this._shTextures=[];for(const e of n){const t=o(new Uint32Array(e.buffer),r.x,r.y,Qe$1.TEXTUREFORMAT_RGBA_INTEGER);t.wrapU=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,t.wrapV=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,this._shTextures.push(t);}}this._instanciateWorker();}}*_updateData(e,t,s){this._covariancesATexture||(this._readyToDisplay=false);const n=new Uint8Array(e),r=new Float32Array(n.buffer);this._keepInRam&&(this._splatsData=e,s&&(this._sh=s));const a=n.length/Re._RowOutputLength;a!=this._vertexCount&&this._updateSplatIndexBuffer(a),this._vertexCount=a,this._shDegree=s?s.length:0;const i=this._getTextureSize(a),o=i.x*i.y,c=Re.ProgressiveUpdateAmount??i.y,l=i.x*c;this._splatPositions=new Float32Array(4*o);const h=new Uint16Array(4*o),u=new Uint16Array((this._useRGBACovariants?4:2)*o),d=new Uint8Array(4*o),p=new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),f=new te$4(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(Re.ProgressiveUpdateAmount){this._updateTextures(h,u,d,s),this.setEnabled(true);const e=Math.ceil(i.y/c);for(let s=0;s<e;s++){const e=s*c,a=e*i.x;for(let e=0;e<l;e++)this._makeSplat(a+e,r,n,h,u,d,p,f);this._updateSubTextures(this._splatPositions,h,u,d,e,Math.min(c,i.y-e)),this.getBoundingInfo().reConstruct(p,f,this.getWorldMatrix()),t&&(yield);}const a=Float32Array.from(this._splatPositions),o=this._vertexCount;this._worker.postMessage({positions:a,vertexCount:o},[a.buffer]),this._sortIsDirty=true;}else {for(let e=0;e<a;e++)this._makeSplat(e,r,n,h,u,d,p,f),t&&e%Re._SplatBatchSize===0&&(yield);this._updateTextures(h,u,d,s),this.getBoundingInfo().reConstruct(p,f,this.getWorldMatrix()),this.setEnabled(true);}this._postToWorker(true);}async updateDataAsync(e,t){return await yi(this._updateData(e,true,t),Si())}updateData(e,t){Mi(this._updateData(e,false,t));}refreshBoundingInfo(){return this.thinInstanceRefreshBoundingInfo(false),this}_updateSplatIndexBuffer(e){(!this._splatIndex||e>this._splatIndex.length)&&(this._splatIndex=new Float32Array(e),this.thinInstanceSetBuffer("splatIndex",this._splatIndex,1,false)),this.forcedInstanceCount=e;}_updateSubTextures(e,t,s,n,r,a,i){const o=(e,t,s,n,r)=>{this.getEngine().updateTextureData(e.getInternalTexture(),t,0,n,s,r,0,0,false);},c=this._getTextureSize(this._vertexCount),l=this._useRGBACovariants?4:2,h=r*c.x,u=a*c.x,d=new Uint16Array(t.buffer,4*h*Uint16Array.BYTES_PER_ELEMENT,4*u),p=new Uint16Array(s.buffer,h*l*Uint16Array.BYTES_PER_ELEMENT,u*l),f=new Uint8Array(n.buffer,4*h,4*u),_=new Float32Array(e.buffer,4*h*Float32Array.BYTES_PER_ELEMENT,4*u);if(o(this._covariancesATexture,d,c.x,r,a),o(this._covariancesBTexture,p,c.x,r,a),o(this._centersTexture,_,c.x,r,a),o(this._colorsTexture,f,c.x,r,a),i)for(let e=0;e<i.length;e++){const t=4,s=new Uint8Array(this._sh[e].buffer,h*t,u*t);o(this._shTextures[e],s,c.x,r,a);}}_instanciateWorker(){if(!this._vertexCount)return;this._updateSplatIndexBuffer(this._vertexCount),this._worker?.terminate(),this._worker=new Worker(URL.createObjectURL(new Blob(["(",Re._CreateWorker.toString(),")(self)"],{type:"application/javascript"}))),this._depthMix=new BigInt64Array(this._vertexCount);const e=Float32Array.from(this._splatPositions),t=this._vertexCount;this._worker.postMessage({positions:e,vertexCount:t},[e.buffer]),this._worker.onmessage=e=>{this._depthMix=e.data.depthMix;const s=new Uint32Array(e.data.depthMix.buffer);if(this._splatIndex)for(let e=0;e<this._vertexCount;e++)this._splatIndex[e]=s[2*e];if(this._delayedTextureUpdate){const e=this._getTextureSize(t);this._updateSubTextures(this._delayedTextureUpdate.centers,this._delayedTextureUpdate.covA,this._delayedTextureUpdate.covB,this._delayedTextureUpdate.colors,0,e.y,this._delayedTextureUpdate.sh),this._delayedTextureUpdate=null;}this.thinInstanceBufferUpdated("splatIndex"),this._canPostToWorker=true,this._readyToDisplay=true,this._sortIsDirty&&(this._postToWorker(true),this._sortIsDirty=false);};}_getTextureSize(e){const t=this._scene.getEngine(),s=t.getCaps().maxTextureSize;let n=1;if(1!==t.version||t.isWebGPU)n=Math.ceil(e/s);else for(;s*n<e;)n*=2;return n>s&&(Ie$2.Error("GaussianSplatting texture size: ("+s+", "+n+"), maxTextureSize: "+s),n=s),new ee$4(s,n)}};Re$1._RowOutputLength=32,Re$1._SH_C0=.28209479177387814,Re$1._SplatBatchSize=327680,Re$1._PlyConversionBatchSize=32768,Re$1.ProgressiveUpdateAmount=0,Re$1._CreateWorker=function(e){let t,s,n,r,a=0;e.onmessage=i=>{if(i.data.positions)t=i.data.positions,a=i.data.vertexCount;else {const o=i.data.view;if(!t||!o)throw new Error("positions or view is not defined!");s=i.data.depthMix,n=new Uint32Array(s.buffer),r=new Float32Array(s.buffer);for(let e=0;e<a;e++)n[2*e]=e;let c=-1;i.data.useRightHandedSystem&&(c=1);for(let e=0;e<a;e++)r[2*e+1]=1e4+(o[2]*t[4*e+0]+o[6]*t[4*e+1]+o[10]*t[4*e+2])*c;s.sort(),e.postMessage({depthMix:s},[s.buffer]);}};};let Fe$1=class Fe{constructor(e,t,s,n,r){this.idx=0,this.color=new me$3(1,1,1,1),this.position=te$4.Zero(),this.rotation=te$4.Zero(),this.uv=new ee$4(0,0),this.velocity=te$4.Zero(),this.pivot=te$4.Zero(),this.translateFromPivot=false,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=false,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=te$4.Zero(),this.idx=e,this._group=t,this.groupId=s,this.idxInGroup=n,this._pcs=r;}get size(){return this.size}set size(e){this.size=e;}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e;}intersectsMesh(e,t){if(!e.hasBoundingInfo)return  false;if(!this._pcs.mesh)throw new Error("Point Cloud System doesnt contain the Mesh");if(t)return e.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));const s=e.getBoundingInfo().boundingBox,n=s.maximumWorld.x,r=s.minimumWorld.x,a=s.maximumWorld.y,i=s.minimumWorld.y,o=s.maximumWorld.z,c=s.minimumWorld.z,l=this.position.x+this._pcs.mesh.position.x,h=this.position.y+this._pcs.mesh.position.y,u=this.position.z+this._pcs.mesh.position.z;return r<=l&&l<=n&&i<=h&&h<=a&&c<=u&&u<=o}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else {t=ae$5.Quaternion[0];const e=this.rotation;se$5.RotationYawPitchRollToRef(e.y,e.x,e.z,t);}t.toRotationMatrix(e);}};let Oe$1=class Oe{get groupID(){return this.groupId}set groupID(e){this.groupId=e;}constructor(e,t){this.groupId=e,this._positionFunction=t;}};!function(e){e[e.Color=2]="Color",e[e.UV=1]="UV",e[e.Random=0]="Random",e[e.Stated=3]="Stated";}(Ie$1||(Ie$1={}));let Ue$1=class Ue{get positions(){return this._positions32}get colors(){return this._colors32}get uvs(){return this._uvs32}constructor(t,s,n,r){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=true,this._isVisibilityBoxLocked=false,this._alwaysVisible=false,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=true,this._computeParticleTexture=true,this._computeParticleRotation=true,this._computeBoundingBox=false,this._isReady=false,this.name=t,this._size=s,this._scene=n||L$7.LastCreatedScene,r&&void 0!==r.updatable?this._updatable=r.updatable:this._updatable=true;}async buildMeshAsync(e){return await Promise.all(this._promises),this._isReady=true,await this._buildMeshAsync(e)}async _buildMeshAsync(e){0===this.nbParticles&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);const t=new is;t.set(this._positions32,Hi.PositionKind),this._uvs32.length>0&&t.set(this._uvs32,Hi.UVKind);let s=0;this._colors32.length>0&&(s=1,t.set(this._colors32,Hi.ColorKind));const n=new Er$1(this.name,this._scene);t.applyToMesh(n,this._updatable),this.mesh=n,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);let r=e;return r||(r=new te$2("point cloud material",this._scene),r.emissiveColor=new ge$3(s,s,s),r.disableLighting=true,r.pointsCloud=true,r.pointSize=this._size),n.material=r,n}_addParticle(e,t,s,n){const r=new Fe$1(e,t,s,n,this);return this.particles.push(r),r}_randomUnitVector(e){e.position=new te$4(Math.random(),Math.random(),Math.random()),e.color=new me$3(1,1,1,1);}_getColorIndicesForCoord(e,t,s,n){const r=e._groupImageData,a=s*(4*n)+4*t,i=[a,a+1,a+2,a+3],o=i[1],c=i[2],l=i[3],h=r[i[0]],u=r[o],d=r[c],p=r[l];return new me$3(h/255,u/255,d/255,p)}_setPointsColorOrUV(e,t,s,n,r,a,i,o){o=o??0,s&&e.updateFacetData();const c=2*e.getBoundingInfo().boundingSphere.radius;let l=e.getVerticesData(Hi.PositionKind);const h=e.getIndices(),u=e.getVerticesData(Hi.UVKind+(o?o+1:"")),d=e.getVerticesData(Hi.ColorKind),p=te$4.Zero();e.computeWorldMatrix();const f=e.getWorldMatrix();if(!f.isIdentity()){l=l.slice(0);for(let e=0;e<l.length/3;e++)te$4.TransformCoordinatesFromFloatsToRef(l[3*e],l[3*e+1],l[3*e+2],f,p),l[3*e]=p.x,l[3*e+1]=p.y,l[3*e+2]=p.z;}let _=0,m=0,x=0,S=0,g=0,y=0,w=0,C=0,E=0,A=0,b=0,M=0,D=0;const P=te$4.Zero(),z=te$4.Zero(),H=te$4.Zero(),I=te$4.Zero(),R=te$4.Zero();let U=0,L=0,N=0,G=0,W=0,j=0;const X=ee$4.Zero(),Y=ee$4.Zero(),K=ee$4.Zero(),q=ee$4.Zero(),$=ee$4.Zero();let Q=0,J=0,ee=0,te=0,se=0,ne=0,re=0,ae=0,ie=0,oe=0,ce=0,le=0;const he=ie$5.Zero(),ue=ie$5.Zero(),de=ie$5.Zero(),pe=ie$5.Zero(),fe=ie$5.Zero();let _e,me,xe=0,ve=0;i=i||0;let Se=new ie$5(0,0,0,0),ge=te$4.Zero(),ye=te$4.Zero(),we=te$4.Zero(),Ce=0,Te=te$4.Zero(),Ee=0,Ae=0;const be=new u$a(te$4.Zero(),new te$4(1,0,0));let Me,De=te$4.Zero();for(let o=0;o<h.length/3;o++){let p,f,v,F,k,Z,Pe,ze;m=h[3*o],x=h[3*o+1],S=h[3*o+2],g=l[3*m],y=l[3*m+1],w=l[3*m+2],C=l[3*x],E=l[3*x+1],A=l[3*x+2],b=l[3*S],M=l[3*S+1],D=l[3*S+2],P.set(g,y,w),z.set(C,E,A),H.set(b,M,D),z.subtractToRef(P,I),H.subtractToRef(z,R),u&&(U=u[2*m],L=u[2*m+1],N=u[2*x],G=u[2*x+1],W=u[2*S],j=u[2*S+1],X.set(U,L),Y.set(N,G),K.set(W,j),Y.subtractToRef(X,q),K.subtractToRef(Y,$)),d&&n&&(Q=d[4*m],J=d[4*m+1],ee=d[4*m+2],te=d[4*m+3],se=d[4*x],ne=d[4*x+1],re=d[4*x+2],ae=d[4*x+3],ie=d[4*S],oe=d[4*S+1],ce=d[4*S+2],le=d[4*S+3],he.set(Q,J,ee,te),ue.set(se,ne,re,ae),de.set(ie,oe,ce,le),ue.subtractToRef(he,pe),de.subtractToRef(ue,fe));const He=new ge$3(0,0,0),Ie=new ge$3(0,0,0);let Re,Fe;for(let l=0;l<t._groupDensity[o];l++)_=this.particles.length,this._addParticle(_,t,this._groupCounter,o+l),Fe=this.particles[_],xe=Math.sqrt(w$8(0,1)),ve=w$8(0,1),_e=P.add(I.scale(xe)).add(R.scale(xe*ve)),s&&(ge=e.getFacetNormal(o).normalize().scale(-1),ye=I.clone().normalize(),we=te$4.Cross(ge,ye),Ce=w$8(0,2*Math.PI),Te=ye.scale(Math.cos(Ce)).add(we.scale(Math.sin(Ce))),Ce=w$8(.1,Math.PI/2),De=Te.scale(Math.cos(Ce)).add(ge.scale(Math.sin(Ce))),be.origin=_e.add(De.scale(1e-5)),be.direction=De,be.length=c,Me=be.intersectsMesh(e),Me.hit&&(Ae=Me.pickedPoint.subtract(_e).length(),Ee=w$8(0,1)*Ae,_e.addInPlace(De.scale(Ee)))),Fe.position=_e.clone(),this._positions.push(Fe.position.x,Fe.position.y,Fe.position.z),void 0!==n?u&&(me=X.add(q.scale(xe)).add($.scale(xe*ve)),n?r&&null!==t._groupImageData?(p=t._groupImgWidth,f=t._groupImgHeight,Re=this._getColorIndicesForCoord(t,Math.round(me.x*p),Math.round(me.y*f),p),Fe.color=Re,this._colors.push(Re.r,Re.g,Re.b,Re.a)):d?(Se=he.add(pe.scale(xe)).add(fe.scale(xe*ve)),Fe.color=new me$3(Se.x,Se.y,Se.z,Se.w),this._colors.push(Se.x,Se.y,Se.z,Se.w)):(Se=he.set(Math.random(),Math.random(),Math.random(),1),Fe.color=new me$3(Se.x,Se.y,Se.z,Se.w),this._colors.push(Se.x,Se.y,Se.z,Se.w)):(Fe.uv=me.clone(),this._uvs.push(Fe.uv.x,Fe.uv.y))):(a?(He.set(a.r,a.g,a.b),v=w$8(-i,i),F=w$8(-i,i),ze=He.toHSV(),k=ze.r,Z=ze.g+v,Pe=ze.b+F,Z<0&&(Z=0),Z>1&&(Z=1),Pe<0&&(Pe=0),Pe>1&&(Pe=1),ge$3.HSVtoRGBToRef(k,Z,Pe,Ie),Se.set(Ie.r,Ie.g,Ie.b,1)):Se=he.set(Math.random(),Math.random(),Math.random(),1),Fe.color=new me$3(Se.x,Se.y,Se.z,Se.w),this._colors.push(Se.x,Se.y,Se.z,Se.w));}}_colorFromTexture(e,t,s){if(null===e.material)return Ie$2.Warn(e.name+"has no material."),t._groupImageData=null,void this._setPointsColorOrUV(e,t,s,true,false);const n=e.material.getActiveTextures();if(0===n.length)return Ie$2.Warn(e.name+"has no usable texture."),t._groupImageData=null,void this._setPointsColorOrUV(e,t,s,true,false);const r=e.clone();r.setEnabled(false),this._promises.push(new Promise((e=>{Ms.WhenAllReady(n,(()=>{let a=t._textureNb;a<0&&(a=0),a>n.length-1&&(a=n.length-1);const i=()=>{t._groupImgWidth=n[a].getSize().width,t._groupImgHeight=n[a].getSize().height,this._setPointsColorOrUV(r,t,s,true,true,void 0,void 0,n[a].coordinatesIndex),r.dispose(),e();};t._groupImageData=null;const o=n[a].readPixels();o?o.then((e=>{t._groupImageData=e,i();})):i();}));})));}_calculateDensity(e,t,s){let n,r,a,i,o,c,l,h,u,d,p,f;const _=te$4.Zero(),m=te$4.Zero(),x=te$4.Zero(),v=te$4.Zero(),S=te$4.Zero(),g=te$4.Zero();let y;const w=[];let C=0;const E=s.length/3;for(let e=0;e<E;e++)n=s[3*e],r=s[3*e+1],a=s[3*e+2],i=t[3*n],o=t[3*n+1],c=t[3*n+2],l=t[3*r],h=t[3*r+1],u=t[3*r+2],d=t[3*a],p=t[3*a+1],f=t[3*a+2],_.set(i,o,c),m.set(l,h,u),x.set(d,p,f),m.subtractToRef(_,v),x.subtractToRef(m,S),te$4.CrossToRef(v,S,g),y=.5*g.length(),C+=y,w[e]=C;const A=new Array(E);let b=e;for(let e=E-1;e>0;e--){const t=w[e];if(0===t)A[e]=0;else {const s=(t-w[e-1])/t*b,n=Math.floor(s),r=s-n,a=n+Number(Math.random()<r);A[e]=a,b-=a;}}return A[0]=b,A}addPoints(e,t=this._randomUnitVector){const s=new Oe$1(this._groupCounter,t);let n,r=this.nbParticles;for(let t=0;t<e;t++)n=this._addParticle(r,s,this._groupCounter,t),s&&s._positionFunction&&s._positionFunction(n,r,t),this._positions.push(n.position.x,n.position.y,n.position.z),n.color&&this._colors.push(n.color.r,n.color.g,n.color.b,n.color.a),n.uv&&this._uvs.push(n.uv.x,n.uv.y),r++;return this.nbParticles+=e,this._groupCounter++,this._groupCounter}addSurfacePoints(e,t,s,n,r){let a=s||0;(isNaN(a)||a<0||a>3)&&(a=0);const i=e.getVerticesData(Hi.PositionKind),o=e.getIndices();this._groups.push(this._groupCounter);const c=new Oe$1(this._groupCounter,null);switch(c._groupDensity=this._calculateDensity(t,i,o),2===a?c._textureNb=n||0:n=n||new me$3(1,1,1,1),a){case 2:this._colorFromTexture(e,c,false);break;case 1:this._setPointsColorOrUV(e,c,false,false,false);break;case 0:this._setPointsColorOrUV(e,c,false);break;case 3:this._setPointsColorOrUV(e,c,false,void 0,void 0,n,r);}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}addVolumePoints(e,t,s,n,r){let a=s||0;(isNaN(a)||a<0||a>3)&&(a=0);const i=e.getVerticesData(Hi.PositionKind),o=e.getIndices();this._groups.push(this._groupCounter);const c=new Oe$1(this._groupCounter,null);switch(c._groupDensity=this._calculateDensity(t,i,o),2===a?c._textureNb=n||0:n=n||new me$3(1,1,1,1),a){case 2:this._colorFromTexture(e,c,true);break;case 1:this._setPointsColorOrUV(e,c,true,false,false);break;case 0:this._setPointsColorOrUV(e,c,true);break;case 3:this._setPointsColorOrUV(e,c,true,void 0,void 0,n,r);}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}setParticles(e=0,t=this.nbParticles-1,s=true){if(!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(e,t,s);const n=ae$5.Matrix[0],r=this.mesh,a=this._colors32,i=this._positions32,o=this._uvs32,c=ae$5.Vector3,l=c[5].copyFromFloats(1,0,0),h=c[6].copyFromFloats(0,1,0),u=c[7].copyFromFloats(0,0,1),d=c[8].setAll(Number.MAX_VALUE),p=c[9].setAll(-Number.MAX_VALUE);re$5.IdentityToRef(n);let f=0;if(this.mesh?.isFacetDataEnabled&&(this._computeBoundingBox=true),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(0!=e||t!=this.nbParticles-1)){const e=this.mesh?.getBoundingInfo();e&&(d.copyFrom(e.minimum),p.copyFrom(e.maximum));}f=0;let _=0,m=0,x=0;for(let s=e;s<=t;s++){const e=this.particles[s];f=e.idx,_=3*f,m=4*f,x=2*f,this.updateParticle(e);const t=e._rotationMatrix,r=e.position,a=e._globalPosition;this._computeParticleRotation&&e.getRotationMatrix(n);if(null!==e.parentId){const s=this.particles[e.parentId],i=s._rotationMatrix,o=s._globalPosition,c=r.x*i[1]+r.y*i[4]+r.z*i[7],l=r.x*i[0]+r.y*i[3]+r.z*i[6],h=r.x*i[2]+r.y*i[5]+r.z*i[8];if(a.x=o.x+l,a.y=o.y+c,a.z=o.z+h,this._computeParticleRotation){const e=n.m;t[0]=e[0]*i[0]+e[1]*i[3]+e[2]*i[6],t[1]=e[0]*i[1]+e[1]*i[4]+e[2]*i[7],t[2]=e[0]*i[2]+e[1]*i[5]+e[2]*i[8],t[3]=e[4]*i[0]+e[5]*i[3]+e[6]*i[6],t[4]=e[4]*i[1]+e[5]*i[4]+e[6]*i[7],t[5]=e[4]*i[2]+e[5]*i[5]+e[6]*i[8],t[6]=e[8]*i[0]+e[9]*i[3]+e[10]*i[6],t[7]=e[8]*i[1]+e[9]*i[4]+e[10]*i[7],t[8]=e[8]*i[2]+e[9]*i[5]+e[10]*i[8];}}else if(a.x=0,a.y=0,a.z=0,this._computeParticleRotation){const e=n.m;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10];}const o=c[11];e.translateFromPivot?o.setAll(0):o.copyFrom(e.pivot);const v=c[0];v.copyFrom(e.position);const S=v.x-e.pivot.x,g=v.y-e.pivot.y,y=v.z-e.pivot.z;let w=S*t[0]+g*t[3]+y*t[6],C=S*t[1]+g*t[4]+y*t[7],T=S*t[2]+g*t[5]+y*t[8];w+=o.x,C+=o.y,T+=o.z;const E=i[_]=a.x+l.x*w+h.x*C+u.x*T,A=i[_+1]=a.y+l.y*w+h.y*C+u.y*T,b=i[_+2]=a.z+l.z*w+h.z*C+u.z*T;if(this._computeBoundingBox&&(d.minimizeInPlaceFromFloats(E,A,b),p.maximizeInPlaceFromFloats(E,A,b)),this._computeParticleColor&&e.color){const t=e.color,s=this._colors32;s[m]=t.r,s[m+1]=t.g,s[m+2]=t.b,s[m+3]=t.a;}if(this._computeParticleTexture&&e.uv){const t=e.uv,s=this._uvs32;s[x]=t.x,s[x+1]=t.y;}}return r&&(s&&(this._computeParticleColor&&r.updateVerticesData(Hi.ColorKind,a,false,false),this._computeParticleTexture&&r.updateVerticesData(Hi.UVKind,o,false,false),r.updateVerticesData(Hi.PositionKind,i,false,false)),this._computeBoundingBox&&(r.hasBoundingInfo?r.getBoundingInfo().reConstruct(d,p,r._worldMatrix):r.buildBoundingInfo(d,p,r._worldMatrix))),this.afterUpdateParticles(e,t,s),this}dispose(){this.mesh?.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null;}refreshVisibleSize(){return this._isVisibilityBoxLocked||this.mesh?.refreshBoundingInfo(),this}setVisibilityBox(e){if(!this.mesh)return;const t=e/2;this.mesh.buildBoundingInfo(new te$4(-t,-t,-t),new te$4(t,t,t));}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){this.mesh&&(this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e);}set computeParticleRotation(e){this._computeParticleRotation=e;}set computeParticleColor(e){this._computeParticleColor=e;}set computeParticleTexture(e){this._computeParticleTexture=e;}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}set computeBoundingBox(e){this._computeBoundingBox=e;}get computeBoundingBox(){return this._computeBoundingBox}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}beforeUpdateParticles(e,t,s){}afterUpdateParticles(e,t,s){}};const Be$1=.28209479177387814;async function ke$1(e,t,s){const n=new Promise(((n,r)=>{const a=s.createCanvasImage();if(!a)throw new Error("Failed to create ImageBitmap");let i;if(a.onload=()=>{try{const e=s.createCanvas(a.width,a.height);if(!e)throw new Error("Failed to create canvas");const t=e.getContext("2d");if(!t)throw new Error("Failed to get 2D context");t.drawImage(a,0,0);const r=t.getImageData(0,0,e.width,e.height);n({bits:new Uint8Array(r.data.buffer),width:r.width});}catch(e){r(`Error loading image ${a.src} with exception: ${e}`);}},a.onerror=e=>{r(`Error loading image ${a.src} with exception: ${e}`);},a.crossOrigin="anonymous","string"==typeof e){if(!t)throw new Error("filename is required when using a URL");a.src=e+t;}else {const t=new Blob([e],{type:"image/webp"});i=URL.createObjectURL(t),a.src=i;}}));return await n}async function Ve$1(e,t,s){let n,r;if(e instanceof Map){r=e;const t=r.get("meta.json");if(!t)throw new Error("meta.json not found in files Map");n=JSON.parse((new TextDecoder).decode(t));}else n=e;const a=[...n.means.files,...n.scales.files,...n.quats.files,...n.sh0.files];n.shN&&a.push(...n.shN.files);const i=await Promise.all(a.map((async e=>{if(r&&r.has(e)){const t=r.get(e);return await ke$1(t,e,s.getEngine())}return await ke$1(t,e,s.getEngine())})));return await async function(e,t,s){const n=e.count?e.count:e.means.shape[0],r=new ArrayBuffer(32*n),a=new Float32Array(r),i=new Float32Array(r),o=new Uint8ClampedArray(r),c=new Uint8ClampedArray(r),l=e=>Math.sign(e)*(Math.exp(Math.abs(e))-1),h=t[0].bits,u=t[1].bits;if(!Array.isArray(e.means.mins)||!Array.isArray(e.means.maxs))throw new Error("Missing arrays in SOG data.");for(let t=0;t<n;t++){const s=4*t;for(let n=0;n<3;n++){const r=e.means.mins[n],i=e.means.maxs[n],o=u[s+n]<<8|h[s+n],c=Ae$1.Lerp(r,i,o/65535);a[8*t+n]=l(c);}}const d=t[2].bits;if(2===e.version){if(!e.scales.codebook)throw new Error("Missing codebook in SOG version 2 scales data.");for(let t=0;t<n;t++){const s=4*t;for(let n=0;n<3;n++){const r=e.scales.codebook[d[s+n]],a=Math.exp(r);i[8*t+3+n]=a;}}}else {if(!Array.isArray(e.scales.mins)||!Array.isArray(e.scales.maxs))throw new Error("Missing arrays in SOG scales data.");for(let t=0;t<n;t++){const s=4*t;for(let n=0;n<3;n++){const r=d[s+n],a=Ae$1.Lerp(e.scales.mins[n],e.scales.maxs[n],r/255),o=Math.exp(a);i[8*t+3+n]=o;}}}const p=t[4].bits;if(2===e.version){if(!e.sh0.codebook)throw new Error("Missing codebook in SOG version 2 sh0 data.");for(let t=0;t<n;t++){const s=4*t;for(let n=0;n<3;n++){const r=.5+e.sh0.codebook[p[s+n]]*Be$1;o[32*t+24+n]=Math.max(0,Math.min(255,Math.round(255*r)));}o[32*t+24+3]=p[s+3];}}else {if(!Array.isArray(e.sh0.mins)||!Array.isArray(e.sh0.maxs))throw new Error("Missing arrays in SOG sh0 data.");for(let t=0;t<n;t++){const s=4*t;for(let n=0;n<4;n++){const r=e.sh0.mins[n],a=e.sh0.maxs[n],i=p[s+n],c=Ae$1.Lerp(r,a,i/255);let l;l=n<3?.5+c*Be$1:1/(1+Math.exp(-c)),o[32*t+24+n]=Math.max(0,Math.min(255,Math.round(255*l)));}}}const f=e=>2*(e/255-.5)/Math.SQRT2,_=t[3].bits;for(let e=0;e<n;e++){const t=_[4*e+0],s=_[4*e+1],n=_[4*e+2],r=_[4*e+3],a=f(t),i=f(s),o=f(n),l=r-252,h=a*a+i*i+o*o,u=Math.sqrt(Math.max(0,1-h));let d;switch(l){case 0:d=[u,a,i,o];break;case 1:d=[a,u,i,o];break;case 2:d=[a,i,u,o];break;case 3:d=[a,i,o,u];break;default:throw new Error("Invalid quaternion mode")}c[32*e+28+0]=127.5*d[0]+127.5,c[32*e+28+1]=127.5*d[1]+127.5,c[32*e+28+2]=127.5*d[2]+127.5,c[32*e+28+3]=127.5*d[3]+127.5;}if(e.shN){const a=[0,3,8,15],i=e.shN.bands?a[e.shN.bands]:e.shN.shape[1]/3,o=t[5].bits,c=t[6].bits,l=t[5].width,h=3*i,u=Math.ceil(h/16),d=[],p=s.getEngine().getCaps().maxTextureSize,f=Math.ceil(n/p);for(let e=0;e<u;e++){const e=new Uint8Array(f*p*4*4);d.push(e);}if(2===e.version){if(!e.shN.codebook)throw new Error("Missing codebook in SOG version 2 shN data.");for(let t=0;t<n;t++){const s=c[4*t+0]+(c[4*t+1]<<8),n=s%64*i,r=Math.floor(s/64);for(let s=0;s<i;s++)for(let a=0;a<3;a++){const i=3*s+a,c=Math.floor(i/16),h=d[c],u=i%16,p=16*t,f=127.5*e.shN.codebook[o[4*(n+s)+a+r*l*4]]+127.5;h[u+p]=Math.max(0,Math.min(255,f));}}}else for(let t=0;t<n;t++){const s=c[4*t+0]+(c[4*t+1]<<8),n=s%64*i,r=Math.floor(s/64),a=e.shN.mins,h=e.shN.maxs;for(let e=0;e<3;e++)for(let s=0;s<i/3;s++){const i=3*s+e,c=Math.floor(i/16),u=d[c],p=i%16,f=16*t,_=127.5*Ae$1.Lerp(a,h,o[4*(n+s)+e+r*l*4]/255)+127.5;u[p+f]=Math.max(0,Math.min(255,_));}}return await new Promise((e=>{e({mode:0,data:r,hasVertexColors:false,sh:d});}))}return await new Promise((e=>{e({mode:0,data:r,hasVertexColors:false});}))}(n,i,s)}let Le$1=class Le{constructor(e=Le._DefaultLoadingOptions){this.name=lc.name,this._assetContainer=null,this.extensions=lc.extensions,this._loadingOptions=e;}createPlugin(e){return new Le(e[lc.name])}async importMeshAsync(e,t,s,n,r,a){return await this._parseAsync(e,t,s,n).then((e=>({meshes:e,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})))}static _BuildPointCloud(e,t){if(!t.byteLength)return  false;const s=new Uint8Array(t),n=new Float32Array(t),r=s.length/32;return e.addPoints(r,(function(e,t){const r=n[8*t+0],a=n[8*t+1],i=n[8*t+2];e.position=new te$4(r,a,i);const o=s[32*t+24+0]/255,c=s[32*t+24+1]/255,l=s[32*t+24+2]/255;e.color=new me$3(o,c,l,1);})),true}static _BuildMesh(e,t){const s=new Er$1("PLYMesh",e),n=new Uint8Array(t.data),r=new Float32Array(t.data),a=n.length/32,i=[],o=new is;for(let e=0;e<a;e++){const t=r[8*e+0],s=r[8*e+1],n=r[8*e+2];i.push(t,s,n);}if(t.hasVertexColors){const e=new Float32Array(4*a);for(let t=0;t<a;t++){const s=n[32*t+24+0]/255,r=n[32*t+24+1]/255,a=n[32*t+24+2]/255;e[4*t+0]=s,e[4*t+1]=r,e[4*t+2]=a,e[4*t+3]=1;}o.colors=e;}return o.positions=i,o.indices=t.faces,o.applyToMesh(s),s}async _unzipWithFFlateAsync(e){let t=this._loadingOptions.fflate;t||(void 0===window.fflate&&await Ai.LoadScriptAsync(this._loadingOptions.deflateURL??"https://unpkg.com/fflate/umd/index.js"),t=window.fflate);const{unzipSync:s}=t,n=s(e),r=new Map;for(const[e,t]of Object.entries(n))r.set(e,t);return r}_parseAsync(e,t,s,n){const r=[],a=e=>{t._blockEntityCollection=!!this._assetContainer;const s=new Re$1("GaussianSplatting",null,t,this._loadingOptions.keepInRam);s._parentContainer=this._assetContainer,s.viewDirectionFactor.set(1,-1,1),r.push(s),s.updateData(e.data,e.sh),t._blockEntityCollection=false;};if("string"==typeof s){const e=JSON.parse(s);if(e&&e.means&&e.scales&&e.quats&&e.sh0)return new Promise((s=>{Ve$1(e,n,t).then((e=>{a(e),s(r);})).catch((()=>{throw new Error("Failed to parse SOG data.")}));}))}const i=s instanceof ArrayBuffer?new Uint8Array(s):s;if(80===i[0]&&75===i[1])return new Promise((e=>{this._unzipWithFFlateAsync(i).then((s=>{Ve$1(s,n,t).then((t=>{a(t),e(r);})).catch((()=>{throw new Error("Failed to parse SOG zip data.")}));}));}));const o=new ReadableStream({start(e){e.enqueue(new Uint8Array(s)),e.close();}}),c=new DecompressionStream("gzip"),l=o.pipeThrough(c);return new Promise((e=>{new Response(l).arrayBuffer().then((s=>{(function(e,t,s){const n=new Uint8Array(e),r=new Uint32Array(e.slice(0,12)),a=r[2],i=n[12],o=n[13],c=n[14],l=n[15],h=r[1];if(l||1347635022!=r[0]||2!=h&&3!=h)return new Promise((e=>{e({mode:3,data:u,hasVertexColors:false});}));const u=new ArrayBuffer(32*a),d=1/(1<<o),p=new Int32Array(1),f=new Uint8Array(p.buffer),_=function(e,t){return f[0]=e[t+0],f[1]=e[t+1],f[2]=e[t+2],f[3]=128&e[t+2]?255:0,p[0]*d};let m=16;const x=new Float32Array(u),v=new Float32Array(u),S=new Uint8ClampedArray(u),g=new Uint8ClampedArray(u);let y=1,w=0;s.flipY||(y=-1,w=255);for(let e=0;e<a;e++)x[8*e+0]=_(n,m+0),x[8*e+1]=y*_(n,m+3),x[8*e+2]=y*_(n,m+6),m+=9;for(let e=0;e<a;e++){for(let t=0;t<3;t++){const s=(n[m+a+3*e+t]-127.5)/38.25;S[32*e+24+t]=Ae$1.Clamp(255*(.5+.282*s),0,255);}S[32*e+24+3]=n[m+e];}m+=4*a;for(let e=0;e<a;e++)v[8*e+3+0]=Math.exp(n[m+0]/16-10),v[8*e+3+1]=Math.exp(n[m+1]/16-10),v[8*e+3+2]=Math.exp(n[m+2]/16-10),m+=3;if(h>=3){const e=Math.SQRT1_2;for(let t=0;t<a;t++){const s=[n[m+0],n[m+1],n[m+2],n[m+3]],r=s[0]+(s[1]<<8)+(s[2]<<16)+(s[3]<<24),a=511,i=[],o=r>>>30;let c=r,l=0;for(let t=3;t>=0;--t)if(t!==o){const s=c&a,n=c>>>9&1;c>>>=10,i[t]=e*(s/a),1===n&&(i[t]=-i[t]),l+=i[t]*i[t];}const h=1-l;i[o]=Math.sqrt(Math.max(h,0)),i[1]*=y,i[2]*=y;const u=[3,0,1,2];for(let e=0;e<4;e++)g[32*t+28+e]=Math.round(127.5+127.5*i[u[e]]);m+=4;}}else for(let e=0;e<a;e++){const t=n[m+0],s=n[m+1]*y+w,r=n[m+2]*y+w,a=t/127.5-1,i=s/127.5-1,o=r/127.5-1;g[32*e+28+1]=t,g[32*e+28+2]=s,g[32*e+28+3]=r;const c=1-(a*a+i*i+o*o);g[32*e+28+0]=127.5+127.5*Math.sqrt(c<0?0:c),m+=3;}if(i){const e=3*((i+1)*(i+1)-1),s=Math.ceil(e/16);let r=m;const o=[],l=t.getEngine().getCaps().maxTextureSize,h=Math.ceil(a/l);for(let e=0;e<s;e++){const e=new Uint8Array(h*l*4*4);o.push(e);}for(let t=0;t<a;t++)for(let s=0;s<e;s++){const e=n[r++],a=Math.floor(s/16);o[a][s%16+16*t]=e;}return new Promise((e=>{e({mode:0,data:u,hasVertexColors:false,sh:o,trainedWithAntialiasing:!!c});}))}return new Promise((e=>{e({mode:0,data:u,hasVertexColors:false,trainedWithAntialiasing:!!c});}))})(s,t,this._loadingOptions).then((s=>{t._blockEntityCollection=!!this._assetContainer;const n=new Re$1("GaussianSplatting",null,t,this._loadingOptions.keepInRam);if(s.trainedWithAntialiasing){const e=n.material;e.kernelSize=.1,e.compensation=true;}n._parentContainer=this._assetContainer,r.push(n),n.updateData(s.data,s.sh),t._blockEntityCollection=false,e(r);}));})).catch((()=>{Le._ConvertPLYToSplat(s).then((async s=>{switch(t._blockEntityCollection=!!this._assetContainer,s.mode){case 0:{const e=new Re$1("GaussianSplatting",null,t,this._loadingOptions.keepInRam);e._parentContainer=this._assetContainer,r.push(e),e.updateData(s.data,s.sh),!s.compressed&&s.rawSplat||e.viewDirectionFactor.set(-1,-1,1);}break;case 1:{const e=new Ue$1("PointCloud",1,t);Le._BuildPointCloud(e,s.data)?await e.buildMeshAsync().then((e=>{r.push(e);})):e.dispose();}break;case 2:if(!s.faces)throw new Error("PLY mesh doesn't contain face informations.");r.push(Le._BuildMesh(t,s));break;default:throw new Error("Unsupported Splat mode")}t._blockEntityCollection=false,e(r);}));}));}))}loadAssetContainerAsync(e,t,s){const n=new M$b(e);return this._assetContainer=n,this.importMeshAsync(null,e,t,s).then((e=>{for(const t of e.meshes)n.meshes.push(t);return this._assetContainer=null,n})).catch((e=>{throw this._assetContainer=null,e}))}loadAsync(e,t,s){return this.importMeshAsync(null,e,t,s).then((()=>{}))}static _ConvertPLYToSplat(e){const t=new Uint8Array(e),s=(new TextDecoder).decode(t.slice(0,10240)),n="end_header\n",r=s.indexOf(n);if(r<0||!s)return new Promise((t=>{t({mode:0,data:e,rawSplat:true});}));const a=parseInt(/element vertex (\d+)\n/.exec(s)[1]),i=/element face (\d+)\n/.exec(s);let o=0;i&&(o=parseInt(i[1]));const c=/element chunk (\d+)\n/.exec(s);let l=0;c&&(l=parseInt(c[1]));let h=0,u=0;const d={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};let p;!function(e){e[e.Vertex=0]="Vertex",e[e.Chunk=1]="Chunk",e[e.SH=2]="SH";}(p||(p={}));let f=1;const _=[],m=s.slice(0,r).split("\n");for(const e of m)if(e.startsWith("property ")){const[,t,s]=e.split(" ");1==f?u+=d[t]:0==f?(_.push({name:s,type:t,offset:h}),h+=d[t]):2==f&&_.push({name:s,type:t,offset:h}),d[t]||Ie$2.Warn(`Unsupported property type: ${t}.`);}else if(e.startsWith("element ")){const[,t]=e.split(" ");"chunk"==t?f=1:"vertex"==t?f=0:"sh"==t&&(f=2);}const x=h,v=u;return Re$1.ConvertPLYWithSHToSplatAsync(e).then((async t=>{const s=new DataView(e,r+11);let n=v*l+x*a;const i=[];if(o)for(let e=0;e<o;e++){const e=s.getUint8(n);if(3==e){n+=1;for(let t=0;t<e;t++){const e=s.getUint32(n+4*(2-t),true);i.push(e);}n+=12;}}if(l)return await new Promise((e=>{e({mode:0,data:t.buffer,sh:t.sh,faces:i,hasVertexColors:false,compressed:true,rawSplat:false});}));let c=0,h=0;const u=["x","y","z","scale_0","scale_1","scale_2","opacity","rot_0","rot_1","rot_2","rot_3"],d=["red","green","blue","f_dc_0","f_dc_1","f_dc_2"];for(let e=0;e<_.length;e++){const t=_[e];u.includes(t.name)&&c++,d.includes(t.name)&&h++;}const p=c==u.length&&3==h,f=o?2:p?0:1;return await new Promise((e=>{e({mode:f,data:t.buffer,sh:t.sh,faces:i,hasVertexColors:!!h,compressed:false,rawSplat:false});}))}))}};Le$1._DefaultLoadingOptions={keepInRam:false,flipY:false},gh(new Le$1);
var splatFileLoaderD3EpyLgL_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,SPLATFileLoader:Le$1});let a$x=class a{constructor(){this.solidPattern=/solid (\S*)([\S\s]*?)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.name=cc.name,this.extensions=cc.extensions;}importMesh(t,n,r,i,a){let o;if("string"!=typeof r){if(this._isBinary(r)){const t=new Er$1("stlmesh",n);return this._parseBinary(t,r),a&&a.push(t),true}r=(new TextDecoder).decode(new Uint8Array(r));}for(;o=this.solidPattern.exec(r);){let r=o[1];const i=o[3];if(i&&r!=i)return Ai.Error("Error in STL, solid name != endsolid name"),false;if(t&&r)if(t instanceof Array){if(!t.indexOf(r))continue}else if(r!==t)continue;r=r||"stlmesh";const l=new Er$1(r,n);this._parseASCII(l,o[2]),a&&a.push(l);}return  true}load(t,e,s){return this.importMesh(null,t,e,s,null)}loadAssetContainer(t,e,s){const n=new M$b(t);return t._blockEntityCollection=true,this.importMesh(null,t,e,s,n.meshes),t._blockEntityCollection=false,n}_isBinary(t){const e=new DataView(t);if(e.byteLength<=80)return  false;if(84+50*e.getUint32(80,true)===e.byteLength)return  true;const s=[115,111,108,105,100];for(let t=0;t<5;t++)if(e.getUint8(t)!==s[t])return  true;return  false}_parseBinary(t,e){const s=new DataView(e),r=s.getUint32(80,true);let i=0;const o=new Float32Array(3*r*3),l=new Float32Array(3*r*3),c=new Uint32Array(3*r);let m=0;for(let t=0;t<r;t++){const e=84+50*t,n=s.getFloat32(e,true),r=s.getFloat32(e+4,true),u=s.getFloat32(e+8,true);for(let t=1;t<=3;t++){const c=e+12*t;o[i]=s.getFloat32(c,true),l[i]=n,a.DO_NOT_ALTER_FILE_COORDINATES?(o[i+1]=s.getFloat32(c+4,true),o[i+2]=s.getFloat32(c+8,true),l[i+1]=r,l[i+2]=u):(o[i+2]=s.getFloat32(c+4,true),o[i+1]=s.getFloat32(c+8,true),l[i+2]=r,l[i+1]=u),i+=3;}a.DO_NOT_ALTER_FILE_COORDINATES?(c[m]=m,c[m+1]=m+2,c[m+2]=m+1,m+=3):(c[m]=m++,c[m]=m++,c[m]=m++);}t.setVerticesData(Hi.PositionKind,o),t.setVerticesData(Hi.NormalKind,l),t.setIndices(c),t.computeWorldMatrix(true);}_parseASCII(t,e){const s=[],r=[],i=[];let o,l=0;for(;o=this.facetsPattern.exec(e);){const t=o[1],e=this.normalPattern.exec(t);if(this.normalPattern.lastIndex=0,!e)continue;const n=[Number(e[1]),Number(e[5]),Number(e[3])];let c;for(;c=this.vertexPattern.exec(t);)a.DO_NOT_ALTER_FILE_COORDINATES?(s.push(Number(c[1]),Number(c[3]),Number(c[5])),r.push(n[0],n[2],n[1])):(s.push(Number(c[1]),Number(c[5]),Number(c[3])),r.push(n[0],n[1],n[2]));a.DO_NOT_ALTER_FILE_COORDINATES?(i.push(l,l+2,l+1),l+=3):i.push(l++,l++,l++),this.vertexPattern.lastIndex=0;}this.facetsPattern.lastIndex=0,t.setVerticesData(Hi.PositionKind,s),t.setVerticesData(Hi.NormalKind,r),t.setIndices(i),t.computeWorldMatrix(true);}};a$x.DO_NOT_ALTER_FILE_COORDINATES=false,gh(new a$x);var stlFileLoaderCQ_DxrvQ_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,STLFileLoader:a$x});let a$w=class a{get name(){return this._name}get cameras(){return this._cameras}get engine(){return this._engine}constructor(e,t){this._engine=e,this.uniqueId=ra.UniqueId,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[];}getClassName(){return "PostProcessRenderPipeline"}get isSupported(){for(const s in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,s)&&!this._renderEffects[s].isSupported)return  false;return  true}addEffect(s){this._renderEffects[s._name]=s;}_rebuild(){}_enableEffect(s,t){const r=this._renderEffects[s];r&&r._enable(Ai.MakeArray(t||this._cameras));}_disableEffect(s,t){const r=this._renderEffects[s];r&&r._disable(Ai.MakeArray(t||this._cameras));}_attachCameras(s,t){const r=Ai.MakeArray(s||this._cameras);if(!r)return;const a=[];let n;for(n=0;n<r.length;n++){const s=r[n];s&&(-1===this._cameras.indexOf(s)?this._cameras.push(s):t&&a.push(n));}for(n=0;n<a.length;n++)r.splice(a[n],1);for(const s in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,s)&&this._renderEffects[s]._attachCameras(r);}_detachCameras(s){const t=Ai.MakeArray(s||this._cameras);if(t){for(const s in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,s)&&this._renderEffects[s]._detachCameras(t);for(let s=0;s<t.length;s++)this._cameras.splice(this._cameras.indexOf(t[s]),1);}}_update(){for(const s in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,s)&&this._renderEffects[s]._update();for(let s=0;s<this._cameras.length;s++){if(!this._cameras[s])continue;const e=this._cameras[s].name;this._renderEffectsForIsolatedPass[e]&&this._renderEffectsForIsolatedPass[e]._update();}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array;}_enableMSAAOnFirstPostProcess(s){if(!this._engine._features.supportMSAA)return  false;const e=Object.keys(this._renderEffects);if(e.length>0){const t=this._renderEffects[e[0]].getPostProcesses();t&&(t[0].samples=s);}return  true}_adaptPostProcessesToViewPort(){const s=Object.keys(this._renderEffects);for(const e of s){const s=this._renderEffects[e].getPostProcesses();if(s)for(const e of s)e.adaptScaleToCurrentViewport=true;}}setPrePassRenderer(s){return  false}dispose(){}};e$z([a$$()],a$w.prototype,"_name",void 0);let n$N=class n{constructor(s,e,t,r=true){this._name=e,this._singleInstance=r,this._getPostProcesses=t,this._cameras={},this._indicesForCamera={},this._postProcesses={};}get isSupported(){for(const s in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,s)){const e=this._postProcesses[s];for(let s=0;s<e.length;s++)if(!e[s].isSupported)return  false}return  true}_update(){}_attachCameras(s){let t;const r=Ai.MakeArray(s||this._cameras);if(r)for(let s=0;s<r.length;s++){const e=r[s];if(!e)continue;const a=e.name;if(t=this._singleInstance?0:a,!this._postProcesses[t]){const s=this._getPostProcesses();s&&(this._postProcesses[t]=Array.isArray(s)?s:[s]);}this._indicesForCamera[a]||(this._indicesForCamera[a]=[]);const n=this._postProcesses[t];for(const s of n){const t=e.attachPostProcess(s);this._indicesForCamera[a].push(t);}this._cameras[a]||(this._cameras[a]=e);}}_detachCameras(s){const t=Ai.MakeArray(s||this._cameras);if(t)for(let s=0;s<t.length;s++){const e=t[s],r=e.name,a=this._postProcesses[this._singleInstance?0:r];if(a)for(const s of a)e.detachPostProcess(s);this._cameras[r]&&(this._cameras[r]=null),delete this._indicesForCamera[r];}}_enable(s){const t=Ai.MakeArray(s||this._cameras);if(t)for(let s=0;s<t.length;s++){const e=t[s],r=e.name,a=this._singleInstance?0:r;for(let n=0;n<this._indicesForCamera[r].length;n++){const o=this._indicesForCamera[r][n],c=e._postProcesses[o];null==c&&t[s].attachPostProcess(this._postProcesses[a][n],o);}}}_disable(s){const t=Ai.MakeArray(s||this._cameras);if(t)for(let s=0;s<t.length;s++){const e=t[s],r=e.name,a=this._postProcesses[this._singleInstance?0:r];for(const s of a)e.detachPostProcess(s);}}getPostProcesses(s){return this._singleInstance?this._postProcesses[0]:s?this._postProcesses[s.name]:null}};Pa.prototype.restoreSingleAttachment=function(){const e=this._gl;this.bindAttachments([e.BACK]);},Pa.prototype.restoreSingleAttachmentForRenderTarget=function(){const e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0]);},Pa.prototype.buildTextureLayout=function(e,t=false){const r=this._gl,T=[];if(t)T.push(r.BACK);else for(let t=0;t<e.length;t++)e[t]?T.push(r["COLOR_ATTACHMENT"+t]):T.push(r.NONE);return T},Pa.prototype.bindAttachments=function(e){this._gl.drawBuffers(e);},Pa.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=false,r){this._currentRenderTarget=null,e.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(e),t||this.generateMipMapsMultiFramebuffer(e),r&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),r()),this._bindUnboundFramebuffer(null);},Pa.prototype.createMultipleRenderTarget=function(e,E,a=true){let i,n=false,_=true,s=false,f=false,u=1,l=1;const o=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,h=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,R=Qe$1.TEXTUREFORMAT_RGBA,A=Qe$1.TEXTURE_2D;let p=[],d=[],m=[],M=[],b=[],F=[],c=[],U=[],D=[],S=false;const N=this._createHardwareRenderTargetWrapper(true,false,e);void 0!==E&&(n=void 0!==E.generateMipMaps&&E.generateMipMaps,_=void 0===E.generateDepthBuffer||E.generateDepthBuffer,s=void 0!==E.generateStencilBuffer&&E.generateStencilBuffer,f=void 0!==E.generateDepthTexture&&E.generateDepthTexture,u=E.textureCount??1,l=E.samples??l,p=E.types||p,d=E.samplingModes||d,m=E.useSRGBBuffers||m,M=E.formats||M,b=E.targetTypes||b,F=E.faceIndex||F,c=E.layerIndex||c,U=E.layerCounts||U,D=E.labels||D,S=E.dontCreateTextures??false,this.webGLVersion>1&&(E.depthTextureFormat===Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8||E.depthTextureFormat===Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8||E.depthTextureFormat===Qe$1.TEXTUREFORMAT_DEPTH24||E.depthTextureFormat===Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT||E.depthTextureFormat===Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8)&&(i=E.depthTextureFormat)),void 0===i&&(i=s?Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT);const g=this._gl,O=this._currentFramebuffer,L=g.createFramebuffer();this._bindUnboundFramebuffer(L);const C=e.width??e,P=e.height??e,B=[],x=[],I=this.webGLVersion>1&&(i===Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8||i===Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8||i===Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8);N.label=E?.label??"MultiRenderTargetWrapper",N._framebuffer=L,N._generateDepthBuffer=f||_,N._generateStencilBuffer=f?I:s,N._depthStencilBuffer=this._setupFramebufferDepthAttachments(N._generateStencilBuffer,N._generateDepthBuffer,C,P,1,i),N._attachments=x;for(let e=0;e<u;e++){let E=d[e]||h,a=p[e]||o,i=m[e]||false;const _=M[e]||R,s=b[e]||A,f=U[e]??1;(a!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering)&&(a!==Qe$1.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering)||(E=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE);const u=this._getSamplingParameters(E,n);a!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloat||(a=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,Ie$2.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),i=i&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const l=this.webGLVersion>1,F=g[l?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];if(x.push(F),-1===s||S)continue;const c=new zt(this,6);B[e]=c,g.activeTexture(g["TEXTURE"+e]),g.bindTexture(s,c._hardwareTexture.underlyingResource),g.texParameteri(s,g.TEXTURE_MAG_FILTER,u.mag),g.texParameteri(s,g.TEXTURE_MIN_FILTER,u.min),g.texParameteri(s,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(s,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE);const O=this._getRGBABufferInternalSizedFormat(a,_,i),L=this._getInternalFormat(_),I=this._getWebGLTextureType(a);if(!l||s!==Qe$1.TEXTURE_2D_ARRAY&&s!==Qe$1.TEXTURE_3D)if(s===Qe$1.TEXTURE_CUBE_MAP){for(let e=0;e<6;e++)g.texImage2D(g.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,O,C,P,0,L,I,null);c.isCube=true;}else g.texImage2D(g.TEXTURE_2D,0,O,C,P,0,L,I,null);else s===Qe$1.TEXTURE_2D_ARRAY?c.is2DArray=true:c.is3D=true,c.baseDepth=c.depth=f,g.texImage3D(s,0,O,C,P,f,0,L,I,null);n&&g.generateMipmap(s),this._bindTextureDirectly(s,null),c.baseWidth=C,c.baseHeight=P,c.width=C,c.height=P,c.isReady=true,c.samples=1,c.generateMipMaps=n,c.samplingMode=E,c.type=a,c._useSRGBBuffer=i,c.format=_,c.label=D[e]??N.label+"-Texture"+e,this._internalTexturesCache.push(c);}if(f&&this._caps.depthTextureExtension&&!S){const e=new zt(this,14);let r=Qe$1.TEXTURETYPE_UNSIGNED_SHORT,E=g.DEPTH_COMPONENT16,a=g.DEPTH_COMPONENT,_=g.UNSIGNED_SHORT,s=g.DEPTH_ATTACHMENT;this.webGLVersion<2?E=g.DEPTH_COMPONENT:i===Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT?(r=Qe$1.TEXTURETYPE_FLOAT,_=g.FLOAT,E=g.DEPTH_COMPONENT32F):i===Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8?(r=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,_=g.FLOAT_32_UNSIGNED_INT_24_8_REV,E=g.DEPTH32F_STENCIL8,a=g.DEPTH_STENCIL,s=g.DEPTH_STENCIL_ATTACHMENT):i===Qe$1.TEXTUREFORMAT_DEPTH24?(r=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,_=g.UNSIGNED_INT,E=g.DEPTH_COMPONENT24,s=g.DEPTH_ATTACHMENT):i!==Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8&&i!==Qe$1.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8||(r=Qe$1.TEXTURETYPE_UNSIGNED_INT_24_8,_=g.UNSIGNED_INT_24_8,E=g.DEPTH24_STENCIL8,a=g.DEPTH_STENCIL,s=g.DEPTH_STENCIL_ATTACHMENT),this._bindTextureDirectly(g.TEXTURE_2D,e,true),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),g.texImage2D(g.TEXTURE_2D,0,E,C,P,0,a,_,null),g.framebufferTexture2D(g.FRAMEBUFFER,s,g.TEXTURE_2D,e._hardwareTexture.underlyingResource,0),this._bindTextureDirectly(g.TEXTURE_2D,null),N._depthStencilTexture=e,N._depthStencilTextureWithStencil=I,e.baseWidth=C,e.baseHeight=P,e.width=C,e.height=P,e.isReady=true,e.samples=1,e.generateMipMaps=n,e.samplingMode=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,e.format=i,e.type=r,e.label=N.label+"-DepthStencil",B[u]=e,this._internalTexturesCache.push(e);}if(N.setTextures(B),a&&g.drawBuffers(x),this._bindUnboundFramebuffer(O),N.setLayerAndFaceIndices(c,F),this.resetTextureCache(),S){if(l>1){const e=g.createFramebuffer();if(!e)throw new Error("Unable to create multi sampled framebuffer");N._samples=l,N._MSAAFramebuffer=e,u>0&&a&&(this._bindUnboundFramebuffer(e),g.drawBuffers(x),this._bindUnboundFramebuffer(O));}}else this.updateMultipleRenderTargetTextureSampleCount(N,l,a);return N},Pa.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,r=true){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;const T=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(T.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(T.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const E=e._attachments.length;for(let t=0;t<E;t++){const r=e.textures[t]._hardwareTexture;r?.releaseMSAARenderBuffers();}if(t>1&&"function"==typeof T.renderbufferStorageMultisample){const a=T.createFramebuffer();if(!a)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=a,this._bindUnboundFramebuffer(a);const i=[];for(let r=0;r<E;r++){const E=e.textures[r],a=E._hardwareTexture,n=T[this.webGLVersion>1?"COLOR_ATTACHMENT"+r:"COLOR_ATTACHMENT"+r+"_WEBGL"],_=this._createRenderBuffer(E.width,E.height,t,-1,this._getRGBABufferInternalSizedFormat(E.type,E.format,E._useSRGBBuffer),n);if(!_)throw new Error("Unable to create multi sampled framebuffer");a.addMSAARenderBuffer(_),E.samples=t,i.push(n);}r&&T.drawBuffers(i);}else this._bindUnboundFramebuffer(e._framebuffer);const a=e._depthStencilTexture?e._depthStencilTexture.format:void 0;return e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t,a),this._bindUnboundFramebuffer(null),e._samples=t,t},Pa.prototype.generateMipMapsMultiFramebuffer=function(e){const t=e,r=this._gl;if(t.isMulti)for(let e=0;e<t._attachments.length;e++){const T=t.textures[e];!T?.generateMipMaps||T?.isCube||T?.is3D||(this._bindTextureDirectly(r.TEXTURE_2D,T,true),r.generateMipmap(r.TEXTURE_2D),this._bindTextureDirectly(r.TEXTURE_2D,null));}},Pa.prototype.resolveMultiFramebuffer=function(e){const t=e,r=this._gl;if(!t._MSAAFramebuffer||!t.isMulti)return;let T=t.resolveMSAAColors?r.COLOR_BUFFER_BIT:0;T|=t._generateDepthBuffer&&t.resolveMSAADepth?r.DEPTH_BUFFER_BIT:0,T|=t._generateStencilBuffer&&t.resolveMSAAStencil?r.STENCIL_BUFFER_BIT:0;const E=t._attachments,a=E.length;r.bindFramebuffer(r.READ_FRAMEBUFFER,t._MSAAFramebuffer),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,t._framebuffer);for(let e=0;e<a;e++){const i=t.textures[e];for(let e=0;e<a;e++)E[e]=r.NONE;E[e]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"],r.readBuffer(E[e]),r.drawBuffers(E),r.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,T,r.NEAREST);}for(let e=0;e<a;e++)E[e]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];r.drawBuffers(E),r.bindFramebuffer(this._gl.FRAMEBUFFER,t._MSAAFramebuffer);};var engine_multiRenderBa06RCov_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});let E$9=class E extends ua{get isSupported(){return this._engine?.getCaps().drawBuffersExtension??false}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e;}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e;}constructor(e,i,n,s,r,a){const o=!(!r||!r.generateMipMaps)&&r.generateMipMaps,l=!(!r||!r.generateDepthTexture)&&r.generateDepthTexture,u=r&&r.depthTextureFormat?r.depthTextureFormat:Qe$1.TEXTUREFORMAT_DEPTH16,d=!r||void 0===r.doNotChangeAspectRatio||r.doNotChangeAspectRatio,h=!(!r||!r.drawOnlyOnFirstAttachmentByDefault)&&r.drawOnlyOnFirstAttachmentByDefault;if(super(e,i,s,o,d,void 0,void 0,void 0,void 0,void 0,void 0,void 0,true),!this.isSupported)return void this.dispose();this._textureNames=a;const f=[],c=[],T=[],_=[],p=[],E=[],m=[],g=[];this._initTypes(n,f,c,T,_,p,E,m,g,r);const v=!r||void 0===r.generateDepthBuffer||r.generateDepthBuffer,x=!(!r||void 0===r.generateStencilBuffer)&&r.generateStencilBuffer,R=r&&r.samples?r.samples:1;this._multiRenderTargetOptions={samplingModes:c,generateMipMaps:o,generateDepthBuffer:v,generateStencilBuffer:x,generateDepthTexture:l,depthTextureFormat:u,types:f,textureCount:n,useSRGBBuffers:T,samples:R,formats:_,targetTypes:p,faceIndex:E,layerIndex:m,layerCounts:g,labels:a,label:e},this._count=n,this._drawOnlyOnFirstAttachmentByDefault=h,n>0&&(this._createInternalTextures(),this._createTextures(a));}_initTypes(e,n,s,r,a,o,l,u,d,h){for(let f=0;f<e;f++)h&&h.types&&void 0!==h.types[f]?n.push(h.types[f]):n.push(h&&h.defaultType?h.defaultType:Qe$1.TEXTURETYPE_UNSIGNED_BYTE),h&&h.samplingModes&&void 0!==h.samplingModes[f]?s.push(h.samplingModes[f]):s.push(Is.BILINEAR_SAMPLINGMODE),h&&h.useSRGBBuffers&&void 0!==h.useSRGBBuffers[f]?r.push(h.useSRGBBuffers[f]):r.push(false),h&&h.formats&&void 0!==h.formats[f]?a.push(h.formats[f]):a.push(Qe$1.TEXTUREFORMAT_RGBA),h&&h.targetTypes&&void 0!==h.targetTypes[f]?o.push(h.targetTypes[f]):o.push(Qe$1.TEXTURE_2D),h&&h.faceIndex&&void 0!==h.faceIndex[f]?l.push(h.faceIndex[f]):l.push(0),h&&h.layerIndex&&void 0!==h.layerIndex[f]?u.push(h.layerIndex[f]):u.push(0),h&&h.layerCounts&&void 0!==h.layerCounts[f]?d.push(h.layerCounts[f]):d.push(1);}_createInternaTextureIndexMapping(){const e={},t=[];if(!this._renderTarget)return t;const i=this._renderTarget.textures;for(let n=0;n<i.length;n++){const s=i[n];if(!s)continue;const r=e[s.uniqueId];void 0!==r?t[n]=r:e[s.uniqueId]=n;}return t}_rebuild(e=false,t=false,i){if(this._count<1||e)return;const n=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),t&&(this._releaseTextures(),this._createTextures(i));const s=this._renderTarget.textures;for(let e=0;e<s.length;e++){const t=this._textures[e];void 0!==n[e]&&this._renderTarget.setTexture(s[n[e]],e),t._texture=s[e],t._texture&&(t._noMipmap=!t._texture.useMipMaps,t._useSRGBBuffer=t._texture._useSRGBBuffer);}1!==this.samples&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,true);}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture;}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose();}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let n=0;n<t.length;n++){const s=new Is(null,this.getScene());e?.[n]&&(s.name=e[n]),s._texture=t[n],s._texture&&(s._noMipmap=!s._texture.useMipMaps,s._useSRGBBuffer=s._texture._useSRGBBuffer),this._textures.push(s);}}setInternalTexture(e,n,s=true){if(this.renderTarget&&(0===n&&(this._texture=e),this.renderTarget.setTexture(e,n,s),this.textures[n]||(this.textures[n]=new Is(null,this.getScene()),this.textures[n].name=this._textureNames?.[n]??this.textures[n].name),this.textures[n]._texture=e,this.textures[n]._noMipmap=!e.useMipMaps,this.textures[n]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[n]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[n]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[n]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&-1!==this._multiRenderTargetOptions.targetTypes[n])){let i=0;i=e.is2DArray?Qe$1.TEXTURE_2D_ARRAY:e.isCube?Qe$1.TEXTURE_CUBE_MAP:e.is3D?Qe$1.TEXTURE_3D:Qe$1.TEXTURE_2D,this._multiRenderTargetOptions.targetTypes[n]=i;}}setLayerAndFaceIndex(e,t=-1,i=-1){this.textures[e]&&this.renderTarget&&(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i));}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t));}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e;}resize(e){this._processSizeParameter(e),this._rebuild(false,void 0,this._textureNames);}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const n=[],s=[],r=[],a=[],o=[],l=[],u=[],d=[];this._textureNames=i,this._initTypes(e,n,s,r,a,o,l,u,d,t),this._multiRenderTargetOptions.types=n,this._multiRenderTargetOptions.samplingModes=s,this._multiRenderTargetOptions.useSRGBBuffers=r,this._multiRenderTargetOptions.formats=a,this._multiRenderTargetOptions.targetTypes=o,this._multiRenderTargetOptions.faceIndex=l,this._multiRenderTargetOptions.layerIndex=u,this._multiRenderTargetOptions.layerCounts=d,this._multiRenderTargetOptions.labels=i,this._rebuild(false,true,i);}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t);}));}dispose(e=false){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose();}releaseInternalTextures(){const e=this._renderTarget?.textures;if(e){for(let t=e.length-1;t>=0;t--)this._textures[t]._texture=null;this._renderTarget?.dispose(),this._renderTarget=null;}}};const m$a="mrtFragmentDeclaration";bt$1.IncludesShadersStore[m$a]||(bt$1.IncludesShadersStore[m$a]="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n");const g$8="geometryPixelShader",v$4="#extension GL_EXT_draw_buffers : require\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n#ifdef BUMP\nvarying mat4 vWorldView;varying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nvarying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nuniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;\n#else\n#ifdef METALLIC_TEXTURE\nuniform sampler2D metallicSampler;varying vec2 vMetallicUV;\n#endif\n#ifdef ROUGHNESS_TEXTURE\nuniform sampler2D roughnessSampler;varying vec2 vRoughnessUV;\n#endif\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vec2 vAlbedoUV;uniform sampler2D albedoSampler;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform vec3 reflectivityColor;\n#endif\n#ifdef ALBEDOCOLOR\nuniform vec3 albedoColor;\n#endif\n#ifdef METALLIC\nuniform float metallic;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform float glossiness;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<mrtFragmentDeclaration>[SCENE_MRT_COUNT]\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\nvoid main() {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nvec3 normalOutput;\n#ifdef BUMP\nvec3 normalW=normalize(vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));\n#endif\n#elif defined(HAS_NORMAL_ATTRIBUTE)\nnormalOutput=normalize(vNormalV);\n#elif defined(POSITION)\nnormalOutput=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#ifdef ENCODE_NORMAL\nnormalOutput=normalOutput*0.5+0.5;\n#endif\n#ifdef DEPTH\ngl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef NORMAL\ngl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);\n#endif\n#ifdef SCREENSPACE_DEPTH\ngl_FragData[SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,1.0);\n#endif\n#ifdef POSITION\ngl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef VELOCITY_LINEAR\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w) -\n(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvec4 reflectivity=vec4(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nfloat metal=1.0;float roughness=1.0;\n#ifdef ORMTEXTURE\nmetal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;\n#else\n#ifdef METALLIC_TEXTURE\nmetal*=texture2D(metallicSampler,vMetallicUV).r;\n#endif\n#ifdef ROUGHNESS_TEXTURE\nroughness*=texture2D(roughnessSampler,vRoughnessUV).r;\n#endif\n#endif\n#ifdef METALLIC\nmetal*=metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-glossiness); \n#endif\nreflectivity.a-=roughness;vec3 color=vec3(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=texture2D(albedoSampler,vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpace(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=albedoColor.xyz;\n#endif\nreflectivity.rgb=mix(vec3(0.04),color,metal);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=texture2D(reflectivitySampler,vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity.a*=glossiness; \n#endif\n#endif\ngl_FragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n}\n";bt$1.ShadersStore[g$8]||(bt$1.ShadersStore[g$8]=v$4);const x$5={name:g$8,shader:v$4};var R$5=Object.freeze({__proto__:null,geometryPixelShader:x$5});const I$5="geometryVertexDeclaration";bt$1.IncludesShadersStore[I$5]||(bt$1.IncludesShadersStore[I$5]="uniform mat4 viewProjection;uniform mat4 view;");const M$4="geometryUboDeclaration";bt$1.IncludesShadersStore[M$4]||(bt$1.IncludesShadersStore[M$4]="#include<sceneUboDeclaration>\n");const S$5="geometryVertexShader",L$2="precision highp float;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<__decl__geometryVertex>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;\n#ifdef HAS_NORMAL_ATTRIBUTE\nattribute vec3 normal;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#ifdef ALPHATEST\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef BUMP\nuniform mat4 bumpMatrix;varying vec2 vBumpUV;\n#endif\n#ifdef REFLECTIVITY\nuniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;\n#endif\n#ifdef METALLIC_TEXTURE\nvarying vec2 vMetallicUV;uniform mat4 metallicMatrix;\n#endif\n#ifdef ROUGHNESS_TEXTURE\nvarying vec2 vRoughnessUV;uniform mat4 roughnessMatrix;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef BUMP\nvarying mat4 vWorldView;\n#endif\n#ifdef BUMP\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef HAS_NORMAL_ATTRIBUTE\nvec3 normalUpdated=normal;\n#else\nvec3 normalUpdated=vec3(0.0,0.0,0.0);\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));\n#ifdef BUMP\nvWorldView=view*finalWorld;mat3 normalWorld=mat3(finalWorld);vNormalW=normalize(normalWorld*normalUpdated);\n#else\n#ifdef NORMAL_WORLDSPACE\nvNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));\n#else\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));\n#endif\n#endif\nvViewPos=view*worldPos;\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvPositionW=worldPos.xyz/worldPos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#else\nvUV=uvUpdated;\n#endif\n#ifdef BUMP_UV1\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV1\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n#else\n#ifdef METALLIC_UV1\nvMetallicUV=vec2(metallicMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef ROUGHNESS_UV1\nvRoughnessUV=vec2(roughnessMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef ALBEDO_UV1\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#else\nvUV=uv2Updated;\n#endif\n#ifdef BUMP_UV2\nvBumpUV=vec2(bumpMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV2\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2Updated,1.0,0.0));\n#else\n#ifdef METALLIC_UV2\nvMetallicUV=vec2(metallicMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#ifdef ROUGHNESS_UV2\nvRoughnessUV=vec2(roughnessMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#ifdef ALBEDO_UV2\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";bt$1.ShadersStore[S$5]||(bt$1.ShadersStore[S$5]=L$2);const O$7={name:S$5,shader:L$2};var U$1=Object.freeze({__proto__:null,geometryVertexShader:O$7});const P$1=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];Ts(P$1);let y$3=class y{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(e){this._linkedWithPrePass=true,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add((()=>{})));}_unlinkPrePassRenderer(){this._linkedWithPrePass=false,this._createRenderTargets();}_resetLayout(){this._enableDepth=true,this._enableNormal=true,this._enablePosition=false,this._enableReflectivity=false,this._enableVelocity=false,this._enableVelocityLinear=false,this._enableScreenspaceDepth=false,this._attachmentsFromPrePass=[];}_forceTextureType(e,t){e===y.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=true):e===y.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=true):e===y.VELOCITY_LINEAR_TEXTURE_TYPE?(this._velocityLinearIndex=t,this._enableVelocityLinear=true):e===y.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=true):e===y.DEPTH_TEXTURE_TYPE?(this._depthIndex=t,this._enableDepth=true):e===y.NORMAL_TEXTURE_TYPE?(this._normalIndex=t,this._enableNormal=true):e===y.SCREENSPACE_DEPTH_TEXTURE_TYPE&&(this._screenspaceDepthIndex=t,this._enableScreenspaceDepth=true);}_setAttachments(e){this._attachmentsFromPrePass=e;}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,false);}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e;}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case y.POSITION_TEXTURE_TYPE:return this._positionIndex;case y.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case y.VELOCITY_LINEAR_TEXTURE_TYPE:return this._velocityLinearIndex;case y.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case y.DEPTH_TEXTURE_TYPE:return this._depthIndex;case y.NORMAL_TEXTURE_TYPE:return this._normalIndex;case y.SCREENSPACE_DEPTH_TEXTURE_TYPE:return this._screenspaceDepthIndex;default:return  -1}}get enableDepth(){return this._enableDepth}set enableDepth(e){this._enableDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets());}get enableNormal(){return this._enableNormal}set enableNormal(e){this._enableNormal=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets());}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets());}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e;}get enableVelocityLinear(){return this._enableVelocityLinear}set enableVelocityLinear(e){this._enableVelocityLinear=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets());}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets());}get enableScreenspaceDepth(){return this._enableScreenspaceDepth}set enableScreenspaceDepth(e){this._enableScreenspaceDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets());}get scene(){return this._scene}get ratio(){return "object"==typeof this._ratioOrDimensions?1:this._ratioOrDimensions}get shaderLanguage(){return this._shaderLanguage}constructor(e,i=1,n=Qe$1.TEXTUREFORMAT_DEPTH16,r){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=true,this.generateNormalsInWorldSpace=false,this._normalsAreUnsigned=false,this._resizeObserver=null,this._enableDepth=true,this._enableNormal=true,this._enablePosition=false,this._enableVelocity=false,this._enableVelocityLinear=false,this._enableReflectivity=false,this._enableScreenspaceDepth=false,this._clearColor=new me$3(0,0,0,0),this._clearDepthColor=new me$3(0,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._velocityLinearIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._screenspaceDepthIndex=-1,this._linkedWithPrePass=false,this.useSpecificClearForDepthTexture=false,this._shaderLanguage=0,this._shadersLoaded=false,this._scene=e,this._ratioOrDimensions=i,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=n,this._textureTypesAndFormats=r||{},this._initShaderSourceAsync(),y._SceneComponentInitialization(this._scene),this._createRenderTargets();}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!y.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(function(){return geometry_vertexD0_PY1nf_esm_min}),Promise.resolve().then(function(){return geometry_fragmentDg2VktW8_esm_min})])):await Promise.all([Promise.resolve().then((function(){return U$1})),Promise.resolve().then((function(){return R$5}))]),this._shadersLoaded=true;}isReady(e,t){if(!this._shadersLoaded)return  false;const i=e.getMaterial();if(i&&i.disableDepthWrite)return  false;const n=[],s=[Hi.PositionKind],d=e.getMesh();d.isVerticesDataPresent(Hi.NormalKind)&&(n.push("#define HAS_NORMAL_ATTRIBUTE"),s.push(Hi.NormalKind));let h=false,f=false;if(i){let e=false;if(i.needAlphaTestingForMesh(d)&&i.getAlphaTestTexture()&&(n.push("#define ALPHATEST"),n.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),e=true),(i.bumpTexture||i.normalTexture||i.geometryNormalTexture)&&bs.BumpTextureEnabled){const t=i.bumpTexture||i.normalTexture||i.geometryNormalTexture;n.push("#define BUMP"),n.push(`#define BUMP_UV${t.coordinatesIndex+1}`),e=true;}if(this._enableReflectivity){let t=false;if("PBRMetallicRoughnessMaterial"===i.getClassName())i.metallicRoughnessTexture&&(n.push("#define ORMTEXTURE"),n.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),n.push("#define METALLICWORKFLOW"),e=true,t=true),null!=i.metallic&&(n.push("#define METALLIC"),n.push("#define METALLICWORKFLOW"),t=true),null!=i.roughness&&(n.push("#define ROUGHNESS"),n.push("#define METALLICWORKFLOW"),t=true),t&&(i.baseTexture&&(n.push("#define ALBEDOTEXTURE"),n.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&n.push("#define GAMMAALBEDO"),e=true),i.baseColor&&n.push("#define ALBEDOCOLOR"));else if("PBRSpecularGlossinessMaterial"===i.getClassName())i.specularGlossinessTexture?(n.push("#define SPECULARGLOSSINESSTEXTURE"),n.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),e=true,i.specularGlossinessTexture.gammaSpace&&n.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor&&n.push("#define REFLECTIVITYCOLOR"),null!=i.glossiness&&n.push("#define GLOSSINESS");else if("PBRMaterial"===i.getClassName())i.metallicTexture&&(n.push("#define ORMTEXTURE"),n.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),n.push("#define METALLICWORKFLOW"),e=true,t=true),null!=i.metallic&&(n.push("#define METALLIC"),n.push("#define METALLICWORKFLOW"),t=true),null!=i.roughness&&(n.push("#define ROUGHNESS"),n.push("#define METALLICWORKFLOW"),t=true),t?(i.albedoTexture&&(n.push("#define ALBEDOTEXTURE"),n.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&n.push("#define GAMMAALBEDO"),e=true),i.albedoColor&&n.push("#define ALBEDOCOLOR")):(i.reflectivityTexture?(n.push("#define SPECULARGLOSSINESSTEXTURE"),n.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&n.push("#define GAMMAREFLECTIVITYTEXTURE"),e=true):i.reflectivityColor&&n.push("#define REFLECTIVITYCOLOR"),null!=i.microSurface&&n.push("#define GLOSSINESS"));else if("StandardMaterial"===i.getClassName())i.specularTexture&&(n.push("#define REFLECTIVITYTEXTURE"),n.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&n.push("#define GAMMAREFLECTIVITYTEXTURE"),e=true),i.specularColor&&n.push("#define REFLECTIVITYCOLOR");else if("OpenPBRMaterial"===i.getClassName()){const s=i;n.push("#define METALLICWORKFLOW"),t=true,n.push("#define METALLIC"),n.push("#define ROUGHNESS"),s._useRoughnessFromMetallicTextureGreen&&s.baseMetalnessTexture?(n.push("#define ORMTEXTURE"),n.push(`#define REFLECTIVITY_UV${s.baseMetalnessTexture.coordinatesIndex+1}`),e=true):s.baseMetalnessTexture?(n.push("#define METALLIC_TEXTURE"),n.push(`#define METALLIC_UV${s.baseMetalnessTexture.coordinatesIndex+1}`),e=true):s.specularRoughnessTexture&&(n.push("#define ROUGHNESS_TEXTURE"),n.push(`#define ROUGHNESS_UV${s.specularRoughnessTexture.coordinatesIndex+1}`),e=true),s.baseColorTexture&&(n.push("#define ALBEDOTEXTURE"),n.push(`#define ALBEDO_UV${s.baseColorTexture.coordinatesIndex+1}`),s.baseColorTexture.gammaSpace&&n.push("#define GAMMAALBEDO"),e=true),s.baseColor&&n.push("#define ALBEDOCOLOR");}}e&&(n.push("#define NEED_UV"),d.isVerticesDataPresent(Hi.UVKind)&&(s.push(Hi.UVKind),n.push("#define UV1"),h=true),d.isVerticesDataPresent(Hi.UV2Kind)&&(s.push(Hi.UV2Kind),n.push("#define UV2"),f=true));}this._enableDepth&&(n.push("#define DEPTH"),n.push("#define DEPTH_INDEX "+this._depthIndex)),this._enableNormal&&(n.push("#define NORMAL"),n.push("#define NORMAL_INDEX "+this._normalIndex)),this._enablePosition&&(n.push("#define POSITION"),n.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(n.push("#define VELOCITY"),n.push("#define VELOCITY_INDEX "+this._velocityIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(d)&&n.push("#define BONES_VELOCITY_ENABLED")),this._enableVelocityLinear&&(n.push("#define VELOCITY_LINEAR"),n.push("#define VELOCITY_LINEAR_INDEX "+this._velocityLinearIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(d)&&n.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(n.push("#define REFLECTIVITY"),n.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this._enableScreenspaceDepth&&-1!==this._screenspaceDepthIndex&&(n.push("#define SCREENSPACE_DEPTH_INDEX "+this._screenspaceDepthIndex),n.push("#define SCREENSPACE_DEPTH")),this.generateNormalsInWorldSpace&&n.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&n.push("#define ENCODE_NORMAL"),d.useBones&&d.computeBonesUsingShaders&&d.skeleton?(s.push(Hi.MatricesIndicesKind),s.push(Hi.MatricesWeightsKind),d.numBoneInfluencers>4&&(s.push(Hi.MatricesIndicesExtraKind),s.push(Hi.MatricesWeightsExtraKind)),n.push("#define NUM_BONE_INFLUENCERS "+d.numBoneInfluencers),n.push("#define BONETEXTURE "+d.skeleton.isUsingTextureForMatrices),n.push("#define BonesPerMesh "+(d.skeleton.bones.length+1))):(n.push("#define NUM_BONE_INFLUENCERS 0"),n.push("#define BONETEXTURE false"),n.push("#define BonesPerMesh 0"));const c=d.morphTargetManager?Ds(d.morphTargetManager,n,s,d,true,true,false,h,f,false):0;t&&(n.push("#define INSTANCES"),Fs(s,this._enableVelocity||this._enableVelocityLinear),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES")),this._linkedWithPrePass?n.push("#define SCENE_MRT_COUNT "+this._attachmentsFromPrePass.length):n.push("#define SCENE_MRT_COUNT "+this._multiRenderTarget.textures.length),Es(i,this._scene,n);const T=this._scene.getEngine(),_=e._getDrawWrapper(void 0,true),p=_.defines,E=n.join("\n");return p!==E&&_.setEffect(T.createEffect("geometry",{attributes:s,uniformsNames:P$1,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:E,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:c},shaderLanguage:this.shaderLanguage},T),E),_.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e;}dispose(){if(this._resizeObserver){this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null;}this.getGBuffer().dispose();}_assignRenderTargetIndices(){const e=[],t=[];let i=0;return this._enableDepth&&(this._depthIndex=i,i++,e.push("gBuffer_Depth"),t.push(this._textureTypesAndFormats[y.DEPTH_TEXTURE_TYPE])),this._enableNormal&&(this._normalIndex=i,i++,e.push("gBuffer_Normal"),t.push(this._textureTypesAndFormats[y.NORMAL_TEXTURE_TYPE])),this._enablePosition&&(this._positionIndex=i,i++,e.push("gBuffer_Position"),t.push(this._textureTypesAndFormats[y.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=i,i++,e.push("gBuffer_Velocity"),t.push(this._textureTypesAndFormats[y.VELOCITY_TEXTURE_TYPE])),this._enableVelocityLinear&&(this._velocityLinearIndex=i,i++,e.push("gBuffer_VelocityLinear"),t.push(this._textureTypesAndFormats[y.VELOCITY_LINEAR_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=i,i++,e.push("gBuffer_Reflectivity"),t.push(this._textureTypesAndFormats[y.REFLECTIVITY_TEXTURE_TYPE])),this._enableScreenspaceDepth&&(this._screenspaceDepthIndex=i,i++,e.push("gBuffer_ScreenspaceDepth"),t.push(this._textureTypesAndFormats[y.SCREENSPACE_DEPTH_TEXTURE_TYPE])),[i,e,t]}_createRenderTargets(){const e=this._scene.getEngine(),[n,s,r]=this._assignRenderTargetIndices();let o=Qe$1.TEXTURETYPE_UNSIGNED_BYTE;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?o=Qe$1.TEXTURETYPE_FLOAT:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(o=Qe$1.TEXTURETYPE_HALF_FLOAT);const l=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions},u=[],_=[];for(const e of r)e?(u.push(e.textureType),_.push(e.textureFormat)):(u.push(o),_.push(Qe$1.TEXTUREFORMAT_RGBA));if(this._normalsAreUnsigned=u[y.NORMAL_TEXTURE_TYPE]===Qe$1.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV||u[y.NORMAL_TEXTURE_TYPE]===Qe$1.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV,this._multiRenderTarget=new E$9("gBuffer",l,n,this._scene,{generateMipMaps:false,generateDepthTexture:true,types:u,formats:_,depthTextureFormat:this._depthFormat},s.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=Is.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=Is.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=false,this._multiRenderTarget.renderList=null;const p=[true],m=[false],g=[true];for(let e=1;e<n;++e)p.push(true),g.push(false),m.push(true);const v=e.buildTextureLayout(p),x=e.buildTextureLayout(m),R=e.buildTextureLayout(g);this._multiRenderTarget.onClearObservable.add((e=>{e.bindAttachments(this.useSpecificClearForDepthTexture?x:v),e.clear(this._clearColor,true,true,true),this.useSpecificClearForDepthTexture&&(e.bindAttachments(R),e.clear(this._clearDepthColor,true,true,true)),e.bindAttachments(v);})),this._resizeObserver=e.onResizeObservable.add((()=>{if(this._multiRenderTarget){const t=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(t);}}));const I=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),n=this._scene,s=n.getEngine(),r=e.getMaterial();if(!r)return;if(i._internalAbstractMeshDataInfo._isActiveIntermediate=false,(this._enableVelocity||this._enableVelocityLinear)&&!this._previousTransformationMatrices[i.uniqueId]&&(this._previousTransformationMatrices[i.uniqueId]={world:re$5.Identity(),viewProjection:n.getTransformMatrix()},t.skeleton)){const e=t.skeleton.getTransformMatrices(t);this._previousBonesTransformationMatrices[t.uniqueId]=this._copyBonesTransformationMatrices(e,new Float32Array(e.length));}const o=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(o.mustReturn)return;const l=s.getCaps().instancedArrays&&(null!==o.visibleInstances[e._id]||t.hasThinInstances),u=i.getWorldMatrix();if(this.isReady(e,l)){const d=e._getDrawWrapper();if(!d)return;const _=d.effect;let p;s.enableEffect(d),l||t._bind(e,_,r.fillMode),this._useUbo?(Ns(_,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(_.setMatrix("viewProjection",n.getTransformMatrix()),_.setMatrix("view",n.getViewMatrix()));if(t._instanceDataStorage.isFrozen||!r.backFaceCulling&&null===r.sideOrientation)p=t._effectiveSideOrientation;else {const e=i._getWorldMatrixDeterminant();p=r._getEffectiveOrientation(t),e<0&&(p=p===hr$1.ClockWiseSideOrientation?hr$1.CounterClockWiseSideOrientation:hr$1.ClockWiseSideOrientation);}if(r._preBind(d,p),r.needAlphaTestingForMesh(i)){const e=r.getAlphaTestTexture();e&&(_.setTexture("diffuseSampler",e),_.setMatrix("diffuseMatrix",e.getTextureMatrix()));}if((r.bumpTexture||r.normalTexture||r.geometryNormalTexture)&&n.getEngine().getCaps().standardDerivatives&&bs.BumpTextureEnabled){const e=r.bumpTexture||r.normalTexture||r.geometryNormalTexture;_.setFloat3("vBumpInfos",e.coordinatesIndex,1/e.level,r.parallaxScaleBias),_.setMatrix("bumpMatrix",e.getTextureMatrix()),_.setTexture("bumpSampler",e),_.setFloat2("vTangentSpaceParams",r.invertNormalMapX?-1:1,r.invertNormalMapY?-1:1);}if(this._enableReflectivity)if("PBRMetallicRoughnessMaterial"===r.getClassName())null!==r.metallicRoughnessTexture&&(_.setTexture("reflectivitySampler",r.metallicRoughnessTexture),_.setMatrix("reflectivityMatrix",r.metallicRoughnessTexture.getTextureMatrix())),null!==r.metallic&&_.setFloat("metallic",r.metallic),null!==r.roughness&&_.setFloat("glossiness",1-r.roughness),null!==r.baseTexture&&(_.setTexture("albedoSampler",r.baseTexture),_.setMatrix("albedoMatrix",r.baseTexture.getTextureMatrix())),null!==r.baseColor&&_.setColor3("albedoColor",r.baseColor);else if("PBRSpecularGlossinessMaterial"===r.getClassName())null!==r.specularGlossinessTexture?(_.setTexture("reflectivitySampler",r.specularGlossinessTexture),_.setMatrix("reflectivityMatrix",r.specularGlossinessTexture.getTextureMatrix())):null!==r.specularColor&&_.setColor3("reflectivityColor",r.specularColor),null!==r.glossiness&&_.setFloat("glossiness",r.glossiness);else if("PBRMaterial"===r.getClassName())null!==r.metallicTexture&&(_.setTexture("reflectivitySampler",r.metallicTexture),_.setMatrix("reflectivityMatrix",r.metallicTexture.getTextureMatrix())),null!==r.metallic&&_.setFloat("metallic",r.metallic),null!==r.roughness&&_.setFloat("glossiness",1-r.roughness),null!==r.roughness||null!==r.metallic||null!==r.metallicTexture?(null!==r.albedoTexture&&(_.setTexture("albedoSampler",r.albedoTexture),_.setMatrix("albedoMatrix",r.albedoTexture.getTextureMatrix())),null!==r.albedoColor&&_.setColor3("albedoColor",r.albedoColor)):(null!==r.reflectivityTexture?(_.setTexture("reflectivitySampler",r.reflectivityTexture),_.setMatrix("reflectivityMatrix",r.reflectivityTexture.getTextureMatrix())):null!==r.reflectivityColor&&_.setColor3("reflectivityColor",r.reflectivityColor),null!==r.microSurface&&_.setFloat("glossiness",r.microSurface));else if("StandardMaterial"===r.getClassName())null!==r.specularTexture&&(_.setTexture("reflectivitySampler",r.specularTexture),_.setMatrix("reflectivityMatrix",r.specularTexture.getTextureMatrix())),null!==r.specularColor&&_.setColor3("reflectivityColor",r.specularColor);else if("OpenPBRMaterial"===r.getClassName()){const e=r;e._useRoughnessFromMetallicTextureGreen&&e.baseMetalnessTexture?(_.setTexture("reflectivitySampler",e.baseMetalnessTexture),_.setMatrix("reflectivityMatrix",e.baseMetalnessTexture.getTextureMatrix())):e.baseMetalnessTexture?(_.setTexture("metallicSampler",e.baseMetalnessTexture),_.setMatrix("metallicMatrix",e.baseMetalnessTexture.getTextureMatrix())):e.specularRoughnessTexture&&(_.setTexture("roughnessSampler",e.specularRoughnessTexture),_.setMatrix("roughnessMatrix",e.specularRoughnessTexture.getTextureMatrix())),_.setFloat("metallic",e.baseMetalness),_.setFloat("glossiness",1-e.specularRoughness),null!==e.baseColorTexture&&(_.setTexture("albedoSampler",e.baseColorTexture),_.setMatrix("albedoMatrix",e.baseColorTexture.getTextureMatrix())),null!==e.baseColor&&_.setColor3("albedoColor",e.baseColor);}if(As(_,r,this._scene),t.useBones&&t.computeBonesUsingShaders&&t.skeleton){const e=t.skeleton;if(e.isUsingTextureForMatrices&&_.getUniformIndex("boneTextureWidth")>-1){const i=e.getTransformMatrixTexture(t);_.setTexture("boneSampler",i),_.setFloat("boneTextureWidth",4*(e.bones.length+1));}else _.setMatrices("mBones",t.skeleton.getTransformMatrices(t));(this._enableVelocity||this._enableVelocityLinear)&&_.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[t.uniqueId]);}ws(t,_),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(_),(this._enableVelocity||this._enableVelocityLinear)&&(_.setMatrix("previousWorld",this._previousTransformationMatrices[i.uniqueId].world),_.setMatrix("previousViewProjection",this._previousTransformationMatrices[i.uniqueId].viewProjection)),l&&t.hasThinInstances&&_.setMatrix("world",u),t._processRendering(i,e,_,r.fillMode,o,l,((e,t)=>{e||_.setMatrix("world",t);}));}(this._enableVelocity||this._enableVelocityLinear)&&(this._previousTransformationMatrices[i.uniqueId].world=u.clone(),this._previousTransformationMatrices[i.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),t.skeleton&&this._copyBonesTransformationMatrices(t.skeleton.getTransformMatrices(t),this._previousBonesTransformationMatrices[i.uniqueId]));};this._multiRenderTarget.customIsReadyFunction=(t,i,n)=>{if((n||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const n=t.subMeshes[i],s=n.getMaterial(),r=n.getRenderingMesh();if(!s)continue;const a=r._getInstancesRenderList(n._id,!!n.getReplacementMesh()),o=e.getCaps().instancedArrays&&(null!==a.visibleInstances[n._id]||r.hasThinInstances);if(!this.isReady(n,o))return  false}return  true},this._multiRenderTarget.customRenderFunction=(t,i,n,s)=>{let r;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass);}if(s.length){for(e.setColorWrite(false),r=0;r<s.length;r++)I(s.data[r]);e.setColorWrite(true);}for(r=0;r<t.length;r++)I(t.data[r]);for(e.setDepthWrite(false),r=0;r<i.length;r++)I(i.data[r]);if(this.renderTransparentMeshes)for(r=0;r<n.length;r++)I(n.data[r]);e.setDepthWrite(true);};}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}};y$3.ForceGLSL=false,y$3.DEPTH_TEXTURE_TYPE=0,y$3.NORMAL_TEXTURE_TYPE=1,y$3.POSITION_TEXTURE_TYPE=2,y$3.VELOCITY_TEXTURE_TYPE=3,y$3.REFLECTIVITY_TEXTURE_TYPE=4,y$3.SCREENSPACE_DEPTH_TEXTURE_TYPE=5,y$3.VELOCITY_LINEAR_TEXTURE_TYPE=6,y$3._SceneComponentInitialization=e=>{throw le$4("GeometryBufferRendererSceneComponent")};let n$M=class n{constructor(){this._renderPipelines={},this._onNewPipelineAddedObservable=new R$g,this._onPipelineRemovedObservable=new R$g;}get onNewPipelineAddedObservable(){return this._onNewPipelineAddedObservable}get onPipelineRemovedObservable(){return this._onPipelineRemovedObservable}get supportedPipelines(){const e=[];for(const i in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,i)){const s=this._renderPipelines[i];s.isSupported&&e.push(s);}return e}addPipeline(e){this.removePipeline(e._name),this._renderPipelines[e._name]=e,this._onNewPipelineAddedObservable.notifyObservers(e);}removePipeline(e){const i=this._renderPipelines[e];i&&(this._onPipelineRemovedObservable.notifyObservers(i),delete this._renderPipelines[e]);}attachCamerasToRenderPipeline(e,i,s=false){const n=this._renderPipelines[e];n&&n._attachCameras(i,s);}detachCamerasFromRenderPipeline(e,i){const s=this._renderPipelines[e];s&&s._detachCameras(i);}enableEffectInPipeline(e,i,s){const n=this._renderPipelines[e];n&&n._enableEffect(i,s);}disableEffectInPipeline(e,i,s){const n=this._renderPipelines[e];n&&n._disableEffect(i,s);}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const i=this._renderPipelines[e];i.isSupported?i._update():(i.dispose(),delete this._renderPipelines[e]);}}_rebuild(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){this._renderPipelines[e]._rebuild();}}dispose(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){this._renderPipelines[e].dispose();}}};Object.defineProperty(ch.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(cr$1.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new r$W(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new n$M;}return this._postProcessRenderPipelineManager},enumerable:true,configurable:true});let r$W=class r{constructor(e){this.name=cr$1.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e;}register(){this.scene._gatherRenderTargetsStage.registerStep(cr$1.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets);}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild();}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose();}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update();}};var postProcessRenderPipelineManagerSceneComponentCqIiRFQN_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,PostProcessRenderPipelineManagerSceneComponent:r$W});let b$6=class b{constructor(){this.enabled=false,this.name="ssao2",this.texturesRequired=[Qe$1.PREPASS_NORMAL_TEXTURE_TYPE,Qe$1.PREPASS_DEPTH_TEXTURE_TYPE];}};let E$8=class E extends Ea{_gatherImports(e,s){e?(this._webGPUReady=true,s.push(Promise.resolve().then(function(){return ssao2_fragmentBIBkoGKC_esm_min}))):s.push(Promise.resolve().then(function(){return ssao2_fragmentDZXQh7gf_esm_min}));}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e);}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e);}set samples(e){this._samples=e,this.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere();}get samples(){return this._samples}set epsilon(e){this._epsilon=e,this.updateEffect(this._getDefinesForSSAO());}get epsilon(){return this._epsilon}constructor(e,s,t){super({...t,name:e,engine:s.getEngine(),useShaderStore:true,useAsPostProcess:true,fragmentShader:E.FragmentUrl,uniforms:E.Uniforms,samplers:E.Samplers,defines:"#define SSAO\n#define SAMPLES 8\n#define EPSILON 0.0001",shaderLanguage:s.getEngine().isWebGPU?1:0}),this.camera=null,this._textureWidth=0,this._textureHeight=0,this._samples=8,this.totalStrength=1,this.radius=2,this.maxZ=100,this.minZAspect=.2,this.base=0,this._epsilon=.02,this._bits=new Uint32Array(1),this._scene=s,this._createRandomTexture(),this.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere();}bind(e=false){super.bind(e);const s=this._drawWrapper.effect,r=this.camera;if(!r)return;const i=r.getProjectionMatrix();if(s.setArray3("sampleSphere",this._sampleSphere),s.setFloat("randTextureTiles",32),s.setFloat("samplesFactor",1/this.samples),s.setFloat("totalStrength",this.totalStrength),s.setFloat2("texelSize",1/this.textureWidth,1/this.textureHeight),s.setFloat("radius",this.radius),s.setFloat("maxZ",this.maxZ),s.setFloat("minZAspect",this.minZAspect),s.setFloat("base",this.base),s.setFloat("near",r.minZ),r.mode===Di.PERSPECTIVE_CAMERA)s.setMatrix3x3("depthProjection",E.PERSPECTIVE_DEPTH_PROJECTION),s.setFloat("xViewport",Math.tan(r.fov/2)*this._scene.getEngine().getAspectRatio(r,true)),s.setFloat("yViewport",Math.tan(r.fov/2));else {const e=this._scene.getEngine().getRenderWidth()/2,t=this._scene.getEngine().getRenderHeight()/2,i=r.orthoLeft??-e,n=r.orthoRight??e,o=r.orthoBottom??-t,a=r.orthoTop??t;s.setMatrix3x3("depthProjection",E.ORTHO_DEPTH_PROJECTION),s.setFloat4("viewport",i,n,o,a);}s.setMatrix("projection",i),s.setTexture("randomSampler",this._randomTexture);}dispose(){this._randomTexture.dispose(),super.dispose();}_createRandomTexture(){const s=128,t=new Uint8Array(65536),o=ee$4.Zero();for(let e=0;e<t.length;)o.set(w$8(0,1),w$8(0,1)).normalize().scaleInPlace(255),t[e++]=Math.floor(o.x),t[e++]=Math.floor(o.y),t[e++]=0,t[e++]=255;const a=E$f.CreateRGBATexture(t,s,s,this._scene,false,false,Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE);a.name="SSAORandomTexture",a.wrapU=Is.WRAP_ADDRESSMODE,a.wrapV=Is.WRAP_ADDRESSMODE,this._randomTexture=a;}_radicalInverseVdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]}_hammersley(e,s){return [e/s,this._radicalInverseVdC(e)]}_hemisphereSampleUniform(e,s){const t=2*s*Math.PI,r=1-.85*e,i=Math.sqrt(1-r*r);return new te$4(Math.cos(t)*i,Math.sin(t)*i,r)}_generateHemisphere(){const e=this.samples,s=[];let t,r=0;for(;r<e;){if(e<16)t=this._hemisphereSampleUniform(Math.random(),Math.random());else {const s=this._hammersley(r,e);t=this._hemisphereSampleUniform(s[0],s[1]);}s.push(t.x,t.y,t.z),r++;}return s}_getDefinesForSSAO(){let e=`#define SSAO\n#define SAMPLES ${this.samples}\n#define EPSILON ${this.epsilon.toFixed(4)}`;return this.camera?.mode===Di.ORTHOGRAPHIC_CAMERA&&(e+="\n#define ORTHOGRAPHIC_CAMERA"),e}};E$8.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],E$8.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],E$8.FragmentUrl="ssao2",E$8.Uniforms=["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","viewport","maxZ","minZAspect","depthProjection"],E$8.Samplers=["randomSampler","depthSampler","normalSampler"];let x$4=class x extends Ea{_gatherImports(e,s){e?(this._webGPUReady=true,s.push(Promise.resolve().then(function(){return ssao2_fragmentBIBkoGKC_esm_min}))):s.push(Promise.resolve().then(function(){return ssao2_fragmentDZXQh7gf_esm_min}));}constructor(e,s=null,t,r){super({...r,name:e,engine:s||eo.LastCreatedEngine,useShaderStore:true,useAsPostProcess:true,fragmentShader:x.FragmentUrl,uniforms:x.Uniforms,samplers:x.Samplers,defines:"#define BLUR\n"+(t?"#define BLUR_H\n":"")}),this._bypassBlur=false,this.textureSize=0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._expensiveBlur=true,this._isHorizontal=t;const i=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),n=this._getSamplersForBlur(this.bypassBlur);this.updateEffect(i,null,n);}set bypassBlur(e){const s=this._getDefinesForBlur(this.expensiveBlur,e),t=this._getSamplersForBlur(e);this.updateEffect(s,null,t),this._bypassBlur=e;}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const s=this._getDefinesForBlur(e,this._bypassBlur);this.updateEffect(s),this._expensiveBlur=e;}get expensiveBlur(){return this._expensiveBlur}bind(e=false){super.bind(e);const s=this._drawWrapper.effect;s.setFloat("outSize",this.textureSize),s.setInt("samples",this.bilateralSamples),s.setFloat("soften",this.bilateralSoften),s.setFloat("tolerance",this.bilateralTolerance);}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,s){let t="#define BLUR\n";return s&&(t+="#define BLUR_BYPASS\n"),e||(t+="#define BLUR_LEGACY\n"),this._isHorizontal?t+"#define BLUR_H\n":t}};x$4.FragmentUrl="ssao2",x$4.Uniforms=["outSize","samples","soften","tolerance"],x$4.Samplers=["textureSampler","depthSampler"];let A$5=class A extends Ea{_gatherImports(e,s){e?(this._webGPUReady=true,s.push(Promise.resolve().then(function(){return ssaoCombine_fragmentCE5xXQBp_esm_min}))):s.push(Promise.resolve().then(function(){return ssaoCombine_fragmentDA81_Hvc_esm_min}));}constructor(e,s=null,t){super({...t,name:e,engine:s||eo.LastCreatedEngine,useShaderStore:true,useAsPostProcess:true,fragmentShader:A.FragmentUrl,uniforms:A.Uniforms,samplers:A.Samplers}),this.camera=null,this.useViewportInCombineStage=true;}bind(e=false){super.bind(e);const s=this._drawWrapper.effect;if(this.camera){const e=this.camera.viewport;this.useViewportInCombineStage?s.setVector4("viewport",ae$5.Vector4[0].copyFromFloats(e.x,e.y,e.width,e.height)):s.setVector4("viewport",ae$5.Vector4[0].copyFromFloats(0,0,1,1));}}};A$5.FragmentUrl="ssaoCombine",A$5.Uniforms=["viewport"],A$5.Samplers=["originalColor"];let B$3=class B{get camera(){return this._ssaoPostProcess.camera}set camera(e){this._ssaoPostProcess.camera=e,this._ssaoCombinePostProcess.camera=e;}set samples(e){this._ssaoPostProcess.samples=e;}get samples(){return this._ssaoPostProcess.samples}get totalStrength(){return this._ssaoPostProcess.totalStrength}set totalStrength(e){this._ssaoPostProcess.totalStrength=e;}get radius(){return this._ssaoPostProcess.radius}set radius(e){this._ssaoPostProcess.radius=e;}get maxZ(){return this._ssaoPostProcess.maxZ}set maxZ(e){this._ssaoPostProcess.maxZ=e;}get minZAspect(){return this._ssaoPostProcess.minZAspect}set minZAspect(e){this._ssaoPostProcess.minZAspect=e;}get base(){return this._ssaoPostProcess.base}set base(e){this._ssaoPostProcess.base=e;}get epsilon(){return this._ssaoPostProcess.epsilon}set epsilon(e){this._ssaoPostProcess.epsilon=e;}set bypassBlur(e){this._ssaoBlurXPostProcess.bypassBlur=e,this._ssaoBlurYPostProcess.bypassBlur=e;}get bypassBlur(){return this._ssaoBlurXPostProcess.bypassBlur}set expensiveBlur(e){this._ssaoBlurXPostProcess.expensiveBlur=e,this._ssaoBlurYPostProcess.expensiveBlur=e;}get expensiveBlur(){return this._ssaoBlurXPostProcess.expensiveBlur}get bilateralSamples(){return this._ssaoBlurXPostProcess.bilateralSamples}set bilateralSamples(e){this._ssaoBlurXPostProcess.bilateralSamples=e,this._ssaoBlurYPostProcess.bilateralSamples=e;}get bilateralSoften(){return this._ssaoBlurXPostProcess.bilateralSoften}set bilateralSoften(e){this._ssaoBlurXPostProcess.bilateralSoften=e,this._ssaoBlurYPostProcess.bilateralSoften=e;}get bilateralTolerance(){return this._ssaoBlurXPostProcess.bilateralTolerance}set bilateralTolerance(e){this._ssaoBlurXPostProcess.bilateralTolerance=e,this._ssaoBlurYPostProcess.bilateralTolerance=e;}get useViewportInCombineStage(){return this._ssaoCombinePostProcess.useViewportInCombineStage}set useViewportInCombineStage(e){this._ssaoCombinePostProcess.useViewportInCombineStage=e;}isReady(){return this._ssaoPostProcess.isReady()&&this._ssaoBlurXPostProcess.isReady()&&this._ssaoBlurYPostProcess.isReady()&&this._ssaoCombinePostProcess.isReady()}constructor(e,s){this.name=e,this._scene=s,this._ssaoPostProcess=new E$8(this.name,this._scene),this._ssaoBlurXPostProcess=new x$4(this.name+" BlurX",this._scene.getEngine(),true),this._ssaoBlurYPostProcess=new x$4(this.name+" BlurY",this._scene.getEngine(),false),this._ssaoCombinePostProcess=new A$5(this.name+" Combiner",this._scene.getEngine());}dispose(){this._ssaoPostProcess?.dispose(),this._ssaoBlurXPostProcess?.dispose(),this._ssaoBlurYPostProcess?.dispose(),this._ssaoCombinePostProcess?.dispose();}};let O$6=class O extends a$w{get totalStrength(){return this._thinSSAORenderingPipeline.totalStrength}set totalStrength(e){this._thinSSAORenderingPipeline.totalStrength=e;}get maxZ(){return this._thinSSAORenderingPipeline.maxZ}set maxZ(e){this._thinSSAORenderingPipeline.maxZ=e;}get minZAspect(){return this._thinSSAORenderingPipeline.minZAspect}set minZAspect(e){this._thinSSAORenderingPipeline.minZAspect=e;}set epsilon(e){this._thinSSAORenderingPipeline.epsilon=e;}get epsilon(){return this._thinSSAORenderingPipeline.epsilon}set samples(e){this._thinSSAORenderingPipeline.samples=e;}get samples(){return this._thinSSAORenderingPipeline.samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e;}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._forcedGeometryBuffer??this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get radius(){return this._thinSSAORenderingPipeline.radius}set radius(e){this._thinSSAORenderingPipeline.radius=e;}get base(){return this._thinSSAORenderingPipeline.base}set base(e){this._thinSSAORenderingPipeline.base=e;}set bypassBlur(e){this._thinSSAORenderingPipeline.bypassBlur=e;}get bypassBlur(){return this._thinSSAORenderingPipeline.bypassBlur}set expensiveBlur(e){this._thinSSAORenderingPipeline.expensiveBlur=e;}get expensiveBlur(){return this._thinSSAORenderingPipeline.expensiveBlur}get bilateralSamples(){return this._thinSSAORenderingPipeline.bilateralSamples}set bilateralSamples(e){this._thinSSAORenderingPipeline.bilateralSamples=e;}get bilateralSoften(){return this._thinSSAORenderingPipeline.bilateralSoften}set bilateralSoften(e){this._thinSSAORenderingPipeline.bilateralSoften=e;}get bilateralTolerance(){return this._thinSSAORenderingPipeline.bilateralTolerance}set bilateralTolerance(e){this._thinSSAORenderingPipeline.bilateralTolerance=e;}static get IsSupported(){const e=L$7.LastCreatedEngine;return !!e&&e._features.supportSSAO2}get useViewportInCombineStage(){return this._thinSSAORenderingPipeline.useViewportInCombineStage}set useViewportInCombineStage(e){this._thinSSAORenderingPipeline.useViewportInCombineStage=e;}get scene(){return this._scene}constructor(s,t,r,i,o=false,a=Qe$1.TEXTURETYPE_UNSIGNED_BYTE){if(super(t.getEngine(),s),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this._textureSamples=1,this._forcedGeometryBuffer=null,this._forceGeometryBuffer=false,this._thinSSAORenderingPipeline=new B$3(s,t),this._scene=t,this._ratio=r,this._textureType=a,o instanceof y$3?(this._forceGeometryBuffer=true,this._forcedGeometryBuffer=o):this._forceGeometryBuffer=o,!this.isSupported)return void Ie$2.Error("The current engine does not support SSAO 2.");const l=this._ratio.ssaoRatio||r,h=this._ratio.blurRatio||r;this._forceGeometryBuffer?(this._forcedGeometryBuffer||t.enableGeometryBufferRenderer(),t.geometryBufferRenderer?.generateNormalsInWorldSpace&&Ie$2.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),t.prePassRenderer?.generateNormalsInWorldSpace&&Ie$2.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._originalColorPostProcess=new vh("SSAOOriginalSceneColor",1,null,Is.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,a),this._createBlurPostProcess(l,h,this._textureType),this._createSSAOCombinePostProcess(h,this._textureType),this.addEffect(new n$N(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),true)),this.addEffect(new n$N(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),true)),this.addEffect(new n$N(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),true)),this.addEffect(new n$N(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),true)),this.addEffect(new n$N(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),true)),t.postProcessRenderPipelineManager.addPipeline(this),i&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(s,i);}getClassName(){return "SSAO2RenderingPipeline"}dispose(e=false){for(let e=0;e<this._scene.cameras.length;e++){const s=this._scene.cameras[e];this._originalColorPostProcess.dispose(s),this._ssaoPostProcess.dispose(s),this._blurHPostProcess.dispose(s),this._blurVPostProcess.dispose(s),this._ssaoCombinePostProcess.dispose(s);}e&&!this._forcedGeometryBuffer&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._scene.postProcessRenderPipelineManager.removePipeline(this._name),this._thinSSAORenderingPipeline.dispose(),super.dispose();}_rebuild(){super._rebuild();}_createBlurPostProcess(e,s,t){this._blurHPostProcess=this._createBlurFilter("BlurH",e,t,true),this._blurVPostProcess=this._createBlurFilter("BlurV",s,t,false);}_createBlurFilter(s,t,r,i){const n=new Aa(s,x$4.FragmentUrl,{size:t,samplingMode:Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),textureType:this._textureType,effectWrapper:i?this._thinSSAORenderingPipeline._ssaoBlurXPostProcess:this._thinSSAORenderingPipeline._ssaoBlurYPostProcess});return n.onApply=s=>{const t=this._ratio.blurRatio||this._ratio,r=i?this._originalColorPostProcess.width*t:this._originalColorPostProcess.height*t,n=i?this._originalColorPostProcess.width:this._originalColorPostProcess.height;this._thinSSAORenderingPipeline._ssaoBlurXPostProcess.textureSize=r>0?r:n,this._thinSSAORenderingPipeline._ssaoBlurYPostProcess.textureSize=r>0?r:n,this._geometryBufferRenderer?s.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&s.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(Qe$1.PREPASS_DEPTH_TEXTURE_TYPE)]);},n.samples=this.textureSamples,n.autoClear=false,n}_getTextureSize(){const s=this._scene.getEngine(),t=this._prePassRenderer;let r={width:s.getRenderWidth(),height:s.getRenderHeight()};if(t&&this._scene.activeCamera?._getFirstPostProcess()===this._ssaoPostProcess){const s=t.getRenderTarget();s&&s.textures&&(r=s.textures[t.getIndex(Qe$1.PREPASS_COLOR_TEXTURE_TYPE)].getSize());}else this._ssaoPostProcess.inputTexture&&(r.width=this._ssaoPostProcess.inputTexture.width,r.height=this._ssaoPostProcess.inputTexture.height);return r}_createSSAOPostProcess(s,t){this._ssaoPostProcess=new Aa("ssao",E$8.FragmentUrl,{size:s,samplingMode:Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),textureType:t,effectWrapper:this._thinSSAORenderingPipeline._ssaoPostProcess}),this._ssaoPostProcess.autoClear=false,this._ssaoPostProcess.onApply=s=>{this._thinSSAORenderingPipeline._ssaoPostProcess.camera=this._scene.activeCamera,this._geometryBufferRenderer?(s.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),s.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(s.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(Qe$1.PREPASS_DEPTH_TEXTURE_TYPE)]),s.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(Qe$1.PREPASS_NORMAL_TEXTURE_TYPE)]));const t=this._getTextureSize();this._thinSSAORenderingPipeline._ssaoPostProcess.textureWidth=t.width,this._thinSSAORenderingPipeline._ssaoPostProcess.textureHeight=t.height;},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new b$6);}_createSSAOCombinePostProcess(s,t){this._ssaoCombinePostProcess=new Aa("ssaoCombine",A$5.FragmentUrl,{size:s,samplingMode:Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),textureType:t,effectWrapper:this._thinSSAORenderingPipeline._ssaoCombinePostProcess}),this._ssaoCombinePostProcess.onApply=e=>{this._thinSSAORenderingPipeline._ssaoCombinePostProcess.camera=this._scene.activeCamera,e.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess);},this._ssaoCombinePostProcess.autoClear=false,this._ssaoCombinePostProcess.samples=this.textureSamples;}serialize(){const e=Ae$3.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,s,t){return Ae$3.Parse((()=>new O(e._name,s,e._ratio,void 0,e._forceGeometryBuffer,e._textureType)),e,s,t)}};e$z([a$$()],O$6.prototype,"totalStrength",null),e$z([a$$()],O$6.prototype,"maxZ",null),e$z([a$$()],O$6.prototype,"minZAspect",null),e$z([a$$("epsilon")],O$6.prototype,"epsilon",null),e$z([a$$("samples")],O$6.prototype,"samples",null),e$z([a$$("textureSamples")],O$6.prototype,"_textureSamples",void 0),e$z([a$$()],O$6.prototype,"_forceGeometryBuffer",void 0),e$z([a$$()],O$6.prototype,"_ratio",void 0),e$z([a$$()],O$6.prototype,"_textureType",void 0),e$z([a$$()],O$6.prototype,"radius",null),e$z([a$$()],O$6.prototype,"base",null),e$z([a$$("bypassBlur")],O$6.prototype,"bypassBlur",null),e$z([a$$("expensiveBlur")],O$6.prototype,"expensiveBlur",null),e$z([a$$()],O$6.prototype,"bilateralSamples",null),e$z([a$$()],O$6.prototype,"bilateralSoften",null),e$z([a$$()],O$6.prototype,"bilateralTolerance",null),P$9("BABYLON.SSAO2RenderingPipeline",O$6);var ssao2RenderingPipelineEUwrxTfo_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,SSAO2RenderingPipeline:O$6});let p$8=class p extends Ea{_gatherImports(e,t){e?(this._webGPUReady=true,t.push(Promise.resolve().then(function(){return imageProcessing_fragmentCIV7_WN1_esm_min}))):t.push(Promise.resolve().then(function(){return imageProcessing_fragmentDZlWa1Ar_esm_min}));}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=true,this._attachImageProcessingConfiguration(e);}_attachImageProcessingConfiguration(e,s=false){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else {let e=this.options.scene;if(!e){const r=this.options.engine;if(r&&r.scenes){const t=r.scenes;e=t[t.length-1];}else e=L$7.LastCreatedScene;}this._imageProcessingConfiguration=e?e.imageProcessingConfiguration:new En;}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateParameters();}))),s||this._updateParameters();}}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e;}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e;}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e;}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e;}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e;}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e;}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e;}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e;}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e;}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e;}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e;}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e;}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e;}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e;}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e;}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e;}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e;}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e;}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e;}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e;}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters());}get outputTextureWidth(){return this.imageProcessingConfiguration.outputTextureWidth}set outputTextureWidth(e){this.imageProcessingConfiguration.outputTextureWidth=e;}get outputTextureHeight(){return this.imageProcessingConfiguration.outputTextureHeight}set outputTextureHeight(e){this.imageProcessingConfiguration.outputTextureHeight=e;}constructor(e,t=null,r){super({...r,name:e,engine:t||eo.LastCreatedEngine,useShaderStore:true,useAsPostProcess:true,fragmentShader:p.FragmentUrl}),this._fromLinearSpace=true,this._defines={IMAGEPROCESSING:false,VIGNETTE:false,VIGNETTEBLENDMODEMULTIPLY:false,VIGNETTEBLENDMODEOPAQUE:false,TONEMAPPING:0,CONTRAST:false,COLORCURVES:false,COLORGRADING:false,COLORGRADING3D:false,FROMLINEARSPACE:false,SAMPLER3DGREENDEPTH:false,SAMPLER3DBGRMAP:false,DITHER:false,IMAGEPROCESSINGPOSTPROCESS:false,EXPOSURE:false,SKIPFINALCOLORCLAMP:false};const i=r?.imageProcessingConfiguration;i?(i.applyByPostProcess=true,this._attachImageProcessingConfiguration(i,true),this._updateParameters()):(this._attachImageProcessingConfiguration(null,true),this.imageProcessingConfiguration.applyByPostProcess=true);}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,true);let e="";for(const t in this._defines){const r=this._defines[t];switch(typeof r){case "number":case "string":e+=`#define ${t} ${r};\n`;break;default:r&&(e+=`#define ${t};\n`);}}const t=["textureSampler"],s=["scale"];En&&(En.PrepareSamplers(t,this._defines),En.PrepareUniforms(s,this._defines)),this.updateEffect(e,s,t);}bind(e=false){super.bind(e),this.imageProcessingConfiguration.bind(this.effect,this.overrideAspectRatio);}dispose(){super.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=false);}};p$8.FragmentUrl="imageProcessing";let d$7=class d extends Aa{get _imageProcessingConfiguration(){return this._effectWrapper.imageProcessingConfiguration}get imageProcessingConfiguration(){return this._effectWrapper.imageProcessingConfiguration}set imageProcessingConfiguration(e){this._effectWrapper.imageProcessingConfiguration=e;}get isSupported(){const e=this.getEffect();return !e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e;}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e;}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e;}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e;}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e;}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e;}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e;}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e;}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e;}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e;}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e;}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e;}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e;}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e;}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e;}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e;}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e;}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e;}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e;}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e;}get fromLinearSpace(){return this._effectWrapper.fromLinearSpace}set fromLinearSpace(e){this._effectWrapper.fromLinearSpace=e;}constructor(e,t,r=null,s,i,n,o=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,g){const h={size:"number"==typeof t?t:void 0,camera:r,samplingMode:s,engine:i,reusable:n,textureType:o,imageProcessingConfiguration:g,scene:r?.getScene(),...t,blockCompilation:true};super(e,p$8.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new p$8(e,i,h),...h}),this.onApply=()=>{this._effectWrapper.overrideAspectRatio=this.aspectRatio;};}getClassName(){return "ImageProcessingPostProcess"}_updateParameters(){this._effectWrapper._updateParameters();}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=false);}};e$z([a$$()],d$7.prototype,"fromLinearSpace",null);let m$9=class m extends E$9{constructor(e,t,r,s,i,n){super(e,r,s,i,n),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=false,this.enabled=false,this.renderTargetTexture=null,this.renderTargetTexture=t;}_createCompositionEffect(){this.imageProcessingPostProcess=new d$7("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters();}_checkSize(){const e=this._engine.getRenderWidth(true),t=this._engine.getRenderHeight(true),r=this.getRenderWidth(),s=this.getRenderHeight();r===e&&s===t||(this.resize({width:e,height:t}),this._internalTextureDirty=true);}updateCount(e,t,r){super.updateCount(e,t,r),this._internalTextureDirty=true;}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0;}dispose(){const e=this._scene;if(super.dispose(),e&&e.prePassRenderer){const t=e.prePassRenderer.renderTargets.indexOf(this);-1!==t&&e.prePassRenderer.renderTargets.splice(t,1);}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=true,this._outputPostProcess.restoreDefaultInputTexture());}};let l$9=class l{get generateNormalsInWorldSpace(){return this._generateNormalsInWorldSpace}set generateNormalsInWorldSpace(e){this._generateNormalsInWorldSpace!==e&&(this._generateNormalsInWorldSpace=e,this._markAllMaterialsAsPrePassDirty());}getIndex(e){return this._textureIndices[e]}get samples(){return this.defaultRT.samples}set samples(e){this.defaultRT.samples=e;}get useSpecificClearForDepthTexture(){return this._useSpecificClearForDepthTexture}set useSpecificClearForDepthTexture(e){this._useSpecificClearForDepthTexture!==e&&(this._useSpecificClearForDepthTexture=e,this._isDirty=true);}getRenderTarget(){return this._currentTarget}_setRenderTarget(e){e?this._currentTarget=e:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=this._scene.activeCamera?.renderPassId??this._currentTarget.renderPassId);}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else {if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer)return void(this.doNotUseGeometryRendererFallback=true);this._geometryBuffer._linkPrePassRenderer(this);}}get enabled(){return this._enabled}constructor(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtTypes=[],this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._generateNormalsInWorldSpace=false,this._useSpecificClearForDepthTexture=false,this._isDirty=true,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=true,this.renderTargets=[],this._clearColor=new me$3(0,0,0,0),this._clearDepthColor=new me$3(0,0,0,1),this._enabled=false,this._needsCompositionForThisPass=false,this.disableGammaTransform=false,this._scene=e,this._engine=e.getEngine();let t=Qe$1.TEXTURETYPE_UNSIGNED_BYTE;this._engine._caps.textureFloat&&this._engine._caps.textureFloatLinearFiltering?t=Qe$1.TEXTURETYPE_FLOAT:this._engine._caps.textureHalfFloat&&this._engine._caps.textureHalfFloatLinearFiltering&&(t=Qe$1.TEXTURETYPE_HALF_FLOAT);for(let e=0;e<l.TextureFormats.length;++e){const r=l.TextureFormats[e].format;l.TextureFormats[e].type===Qe$1.TEXTURETYPE_FLOAT&&(l.TextureFormats[e].type=t,t!==Qe$1.TEXTURETYPE_FLOAT||r!==Qe$1.TEXTUREFORMAT_R&&r!==Qe$1.TEXTUREFORMAT_RG&&r!==Qe$1.TEXTUREFORMAT_RGBA||this._engine._caps.supportFloatTexturesResolve||(l.TextureFormats[e].type=Qe$1.TEXTURETYPE_HALF_FLOAT));}l._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT;}_createRenderTarget(e,t){const r=new m$9(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:false,generateStencilBuffer:this._engine.isStencilEnable,defaultType:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,types:[],drawOnlyOnFirstAttachmentByDefault:true});return this.renderTargets.push(r),this._enabled&&this._update(),r}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(e,t){const r=t.getMaterial(),s=r&&r.isPrePassCapable,i=r&&-1!==this.excludedMaterials.indexOf(r);this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&s&&!i?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!i&&this._geometryBuffer.renderList.push(t.getRenderingMesh())));}_reinitializeAttachments(){const e=[],t=[false],r=[false],s=[true];for(let i=0;i<this.mrtCount;i++)e.push(true),i>0&&(this._useSpecificClearForDepthTexture&&this._mrtLayout[i]===Qe$1.PREPASS_DEPTH_TEXTURE_TYPE?(t.push(false),r.push(true)):(t.push(true),r.push(false)),s.push(false));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._clearDepthAttachments=this._engine.buildTextureLayout(r),this._defaultAttachments=this._engine.buildTextureLayout(s);}_resetLayout(){for(let e=0;e<l.TextureFormats.length;e++)this._textureIndices[l.TextureFormats[e].purpose]=-1;this._textureIndices[Qe$1.PREPASS_COLOR_TEXTURE_TYPE]=0,this._mrtLayout=[Qe$1.PREPASS_COLOR_TEXTURE_TYPE],this._mrtTypes=[l.TextureFormats[Qe$1.PREPASS_COLOR_TEXTURE_TYPE].type],this._mrtFormats=[l.TextureFormats[Qe$1.PREPASS_COLOR_TEXTURE_TYPE].format],this._mrtNames=[l.TextureFormats[Qe$1.PREPASS_COLOR_TEXTURE_TYPE].name],this.mrtCount=1;}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();const e=[];for(let t=0;t<this._mrtLayout.length;t++)e.push(false);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());const t=[{prePassConstant:Qe$1.PREPASS_DEPTH_TEXTURE_TYPE,geometryBufferConstant:y$3.DEPTH_TEXTURE_TYPE},{prePassConstant:Qe$1.PREPASS_NORMAL_TEXTURE_TYPE,geometryBufferConstant:y$3.NORMAL_TEXTURE_TYPE},{prePassConstant:Qe$1.PREPASS_POSITION_TEXTURE_TYPE,geometryBufferConstant:y$3.POSITION_TEXTURE_TYPE},{prePassConstant:Qe$1.PREPASS_REFLECTIVITY_TEXTURE_TYPE,geometryBufferConstant:y$3.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:Qe$1.PREPASS_VELOCITY_TEXTURE_TYPE,geometryBufferConstant:y$3.VELOCITY_TEXTURE_TYPE}];for(let r=0;r<t.length;r++){const s=this._mrtLayout.indexOf(t[r].prePassConstant);-1!==s&&(this._geometryBuffer._forceTextureType(t[r].geometryBufferConstant,s),e[s]=true);}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e));}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment());}_beforeDraw(e,t,r){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e));}_prepareFrame(e,t,r){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,r,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer();}setCustomOutput(e){const t=this._postProcessesSourceForThisPass[0];return !!t&&(t.inputTexture=e.renderTarget,true)}_renderPostProcesses(e,t){const r=this._postProcessesSourceForThisPass[0],s=r?r.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null;let i=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(i=i.concat([this._currentTarget.imageProcessingPostProcess])),i.length&&(this._scene.postProcessManager._prepareFrame(this._currentTarget.renderTarget?.texture,i),this._scene.postProcessManager.directRender(i,s,false,t));}_afterDraw(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e));}_clear(){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,true,false,false),this._useSpecificClearForDepthTexture&&(this._engine.bindAttachments(this._clearDepthAttachments),this._engine.clear(this._clearDepthColor,true,false,false)),this._engine.bindAttachments(this._defaultAttachments));}_bindFrameBuffer(){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();const e=this._currentTarget.renderTarget;e&&this._engine.bindFramebuffer(e);}}_setEnabled(e){this._enabled=e;}_setRenderTargetEnabled(e,t){e.enabled=t,t||this._unlinkInternalTexture(e);}addEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e.clearColor&&this._clearColor.copyFrom(e.clearColor),e}getEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e)return this._effectConfigurations[t];return null}_enable(){const e=this.mrtCount;for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&this._enableTextures(this._effectConfigurations[e].texturesRequired);for(let t=0;t<this.renderTargets.length;t++){this.mrtCount===e&&this.renderTargets[t].count===this.mrtCount||this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtTypes,formats:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&(!this._effectConfigurations[e].postProcess&&this._effectConfigurations[e].createPostProcess&&this._effectConfigurations[e].createPostProcess(),this._effectConfigurations[e].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[e].postProcess));}this._reinitializeAttachments(),this._setEnabled(true),this._updateGeometryBufferLayout();}_disable(){this._setEnabled(false);for(let e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],false);this._resetLayout();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=false;}_getPostProcessesSource(e,t){if(t)return t._postProcesses;if(e.renderTargetTexture){if(e.renderTargetTexture.useCameraPostProcesses){const t=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return t?t._postProcesses:[]}return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[]}return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(e,t){const r=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&0!==this._scene.activeCameras.indexOf(t);this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter((e=>null!=e)),this._scene.autoClear=true;const s=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!s&&!this.disableGammaTransform&&this._needsImageProcessing()&&!r;const i=this._getFirstPostProcess(this._postProcessesSourceForThisPass),n=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0];let o=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||s,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),n?o=n:this._needsCompositionForThisPass?o=e.imageProcessingPostProcess:i&&(o=i),this._bindFrameBuffer(),this._linkInternalTexture(e,o);}_linkInternalTexture(e,t){t&&(t.autoClear=false,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=false);}_unlinkInternalTexture(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=true,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null);}_needsImageProcessing(){for(let e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return  true;return  false}_hasImageProcessing(e){let t=false;if(e)for(let r=0;r<e.length;r++)if("ImageProcessingPostProcess"===e[r]?.getClassName()){t=true;break}return t}_getFirstPostProcess(e){for(let t=0;t<e.length;t++)if(null!==e[t])return e[t];return null}markAsDirty(){this._isDirty=true;}_enableTextures(e){this._scene.needsPreviousWorldMatrices=false;for(let t=0;t<e.length;t++){const r=e[t];-1===this._textureIndices[r]&&(this._textureIndices[r]=this._mrtLayout.length,this._mrtLayout.push(r),this._mrtTypes.push(l.TextureFormats[r].type),this._mrtFormats.push(l.TextureFormats[r].format),this._mrtNames.push(l.TextureFormats[r].name),this.mrtCount++),r!==Qe$1.PREPASS_VELOCITY_TEXTURE_TYPE&&r!==Qe$1.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE||(this._scene.needsPreviousWorldMatrices=true);}}update(){this._isDirty&&this._update();}_update(){this._disable();let e,t=false;this._scene.imageProcessingConfiguration.applyByPostProcess=false,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),t=true);for(let e=0;e<this._scene.materials.length;e++)this._scene.materials[e].setPrePassRenderer(this)&&(t=true);t&&this._setRenderTargetEnabled(this.defaultRT,true);for(let r=0;r<this.renderTargets.length;r++){if(this.renderTargets[r].renderTargetTexture)e=this._getPostProcessesSource(this.renderTargets[r]);else {const t=this._scene.activeCamera;if(!t)continue;e=t._postProcesses;}if(e&&(e=e.filter((e=>null!=e)),e)){for(let s=0;s<e.length;s++)e[s].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[r],true),t=true);this._hasImageProcessing(e)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=true);}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=false,t&&this._enable();}_markAllMaterialsAsPrePassDirty(){const e=this._scene.materials;for(let t=0;t<e.length;t++)e[t].markAsDirty(hr$1.PrePassDirtyFlag);}dispose(){for(let e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose();}};l$9._SceneComponentInitialization=e=>{throw le$4("PrePassRendererSceneComponent")},l$9.TextureFormats=[{purpose:Qe$1.PREPASS_IRRADIANCE_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_HALF_FLOAT,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_Irradiance"},{purpose:Qe$1.PREPASS_POSITION_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_HALF_FLOAT,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_Position"},{purpose:Qe$1.PREPASS_VELOCITY_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_Velocity"},{purpose:Qe$1.PREPASS_REFLECTIVITY_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_Reflectivity"},{purpose:Qe$1.PREPASS_COLOR_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_HALF_FLOAT,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_Color"},{purpose:Qe$1.PREPASS_DEPTH_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_FLOAT,format:Qe$1.TEXTUREFORMAT_R,name:"prePass_Depth"},{purpose:Qe$1.PREPASS_NORMAL_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_HALF_FLOAT,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_Normal"},{purpose:Qe$1.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_Albedo"},{purpose:Qe$1.PREPASS_WORLD_NORMAL_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_WorldNormal"},{purpose:Qe$1.PREPASS_LOCAL_POSITION_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_HALF_FLOAT,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_LocalPosition"},{purpose:Qe$1.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_FLOAT,format:Qe$1.TEXTUREFORMAT_R,name:"prePass_ScreenDepth"},{purpose:Qe$1.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE,type:Qe$1.TEXTURETYPE_HALF_FLOAT,format:Qe$1.TEXTUREFORMAT_RGBA,name:"prePass_VelocityLinear"}],Object.defineProperty(ch.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(e){e&&e.isSupported&&(this._prePassRenderer=e);},enumerable:true,configurable:true}),ch.prototype.enablePrePassRenderer=function(){return this._prePassRenderer||(this._prePassRenderer=new l$9(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,Ie$2.Error("PrePassRenderer needs WebGL 2 support.\nMaybe you tried to use the following features that need the PrePassRenderer :\n + Subsurface Scattering"))),this._prePassRenderer},ch.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null);};let E$7=class E{constructor(e){this.name=cr$1.NAME_PREPASSRENDERER,this.scene=e;}register(){this.scene._beforeCameraDrawStage.registerStep(cr$1.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(cr$1.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(cr$1.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(cr$1.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(cr$1.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(cr$1.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(cr$1.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(cr$1.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage);}_beforeRenderTargetDraw(e,t,r){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,r));}_afterRenderTargetDraw(e,t,r){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,r);}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear());}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e));}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw();}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear());}_beforeRenderingMeshStage(e,t,r,s){if(!s)return;const i=e.getScene();i.prePassRenderer&&i.prePassRenderer.bindAttachmentsForEffect(s,t);}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments();}rebuild(){}dispose(){this.scene.disablePrePassRenderer();}};l$9._SceneComponentInitialization=e=>{let t=e._getComponent(cr$1.NAME_PREPASSRENDERER);t||(t=new E$7(e),e._addComponent(t));};var prePassRendererSceneComponentBdLeH256_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,PrePassRendererSceneComponent:E$7});Object.defineProperty(ch.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e);},enumerable:true,configurable:true}),ch.prototype.enableGeometryBufferRenderer=function(e=1,r=Qe$1.TEXTUREFORMAT_DEPTH16,s){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new y$3(this,e,r,s),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},ch.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null);};let s$e=class s{constructor(r){this.name=cr$1.NAME_GEOMETRYBUFFERRENDERER,this.scene=r;}register(){this.scene._gatherRenderTargetsStage.registerStep(cr$1.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets);}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer());}};y$3._SceneComponentInitialization=r=>{let t=r._getComponent(cr$1.NAME_GEOMETRYBUFFERRENDERER);t||(t=new s$e(r),r._addComponent(t));};var geometryBufferRendererSceneComponentGhcZfRxY_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,GeometryBufferRendererSceneComponent:s$e});const r$V="fresnelFunction";bt$1.IncludesShadersStoreWGSL[r$V]||(bt$1.IncludesShadersStoreWGSL[r$V]="#ifdef FRESNEL\nfn computeFresnelTerm(viewDirection: vec3f,worldNormal: vec3f,bias: f32,power: f32)->f32\n{let fresnelTerm: f32=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}\n#endif\n");let W$1=class W{static ComputeNumMipmapLevels(t,r){return V$8(Math.max(t,r))+1}static GetTextureTypeFromFormat(e){switch(e){case "r8unorm":case "r8uint":case "rg8unorm":case "rg8uint":case "rgba8unorm":case "rgba8unorm-srgb":case "rgba8uint":case "bgra8unorm":case "bgra8unorm-srgb":case "rgb10a2uint":case "rgb10a2unorm":case "rgb9e5ufloat":case "rg11b10ufloat":case "bc7-rgba-unorm":case "bc7-rgba-unorm-srgb":case "bc6h-rgb-ufloat":case "bc5-rg-unorm":case "bc3-rgba-unorm":case "bc3-rgba-unorm-srgb":case "bc2-rgba-unorm":case "bc2-rgba-unorm-srgb":case "bc4-r-unorm":case "bc1-rgba-unorm":case "bc1-rgba-unorm-srgb":case "etc2-rgb8unorm":case "etc2-rgb8unorm-srgb":case "etc2-rgb8a1unorm":case "etc2-rgb8a1unorm-srgb":case "etc2-rgba8unorm":case "etc2-rgba8unorm-srgb":case "eac-r11unorm":case "eac-rg11unorm":case "astc-4x4-unorm":case "astc-4x4-unorm-srgb":case "astc-5x4-unorm":case "astc-5x4-unorm-srgb":case "astc-5x5-unorm":case "astc-5x5-unorm-srgb":case "astc-6x5-unorm":case "astc-6x5-unorm-srgb":case "astc-6x6-unorm":case "astc-6x6-unorm-srgb":case "astc-8x5-unorm":case "astc-8x5-unorm-srgb":case "astc-8x6-unorm":case "astc-8x6-unorm-srgb":case "astc-8x8-unorm":case "astc-8x8-unorm-srgb":case "astc-10x5-unorm":case "astc-10x5-unorm-srgb":case "astc-10x6-unorm":case "astc-10x6-unorm-srgb":case "astc-10x8-unorm":case "astc-10x8-unorm-srgb":case "astc-10x10-unorm":case "astc-10x10-unorm-srgb":case "astc-12x10-unorm":case "astc-12x10-unorm-srgb":case "astc-12x12-unorm":case "astc-12x12-unorm-srgb":case "stencil8":return Qe$1.TEXTURETYPE_UNSIGNED_BYTE;case "r8snorm":case "r8sint":case "rg8snorm":case "rg8sint":case "rgba8snorm":case "rgba8sint":case "bc6h-rgb-float":case "bc5-rg-snorm":case "bc4-r-snorm":case "eac-r11snorm":case "eac-rg11snorm":return Qe$1.TEXTURETYPE_BYTE;case "r16uint":case "r16unorm":case "rg16unorm":case "rgba16unorm":case "rg16uint":case "rgba16uint":case "depth16unorm":return Qe$1.TEXTURETYPE_UNSIGNED_SHORT;case "r16sint":case "r16snorm":case "rg16snorm":case "rgba16snorm":case "rg16sint":case "rgba16sint":return Qe$1.TEXTURETYPE_SHORT;case "r16float":case "rg16float":case "rgba16float":return Qe$1.TEXTURETYPE_HALF_FLOAT;case "r32uint":case "rg32uint":case "rgba32uint":case "r32sint":case "rg32sint":case "rgba32sint":return Qe$1.TEXTURETYPE_UNSIGNED_INTEGER;case "r32float":case "rg32float":case "rgba32float":case "depth32float":case "depth32float-stencil8":case "depth24plus":case "depth24plus-stencil8":return Qe$1.TEXTURETYPE_FLOAT}return Qe$1.TEXTURETYPE_UNSIGNED_BYTE}static GetBlockInformationFromFormat(e){switch(e){case "r8unorm":case "r8snorm":case "r8uint":case "r8sint":return {width:1,height:1,length:1};case "r16uint":case "r16sint":case "r16unorm":case "r16snorm":case "r16float":case "rg8unorm":case "rg8snorm":case "rg8uint":case "rg8sint":case "depth16unorm":return {width:1,height:1,length:2};case "r32uint":case "r32sint":case "r32float":case "rg16uint":case "rg16sint":case "rg16float":case "rg16unorm":case "rg16snorm":case "rgba8unorm":case "rgba8unorm-srgb":case "rgba8snorm":case "rgba8uint":case "rgba8sint":case "bgra8unorm":case "bgra8unorm-srgb":case "rgb9e5ufloat":case "rgb10a2uint":case "rgb10a2unorm":case "rg11b10ufloat":case "depth32float":return {width:1,height:1,length:4};case "rg32uint":case "rg32sint":case "rg32float":case "rgba16uint":case "rgba16sint":case "rgba16float":case "rgba16unorm":case "rgba16snorm":return {width:1,height:1,length:8};case "rgba32uint":case "rgba32sint":case "rgba32float":return {width:1,height:1,length:16};case "stencil8":throw "No fixed size for Stencil8 format!";case "depth24plus":throw "No fixed size for Depth24Plus format!";case "depth24plus-stencil8":throw "No fixed size for Depth24PlusStencil8 format!";case "depth32float-stencil8":return {width:1,height:1,length:5};case "bc7-rgba-unorm":case "bc7-rgba-unorm-srgb":case "bc6h-rgb-ufloat":case "bc6h-rgb-float":case "bc5-rg-unorm":case "bc5-rg-snorm":case "bc3-rgba-unorm":case "bc3-rgba-unorm-srgb":case "bc2-rgba-unorm":case "bc2-rgba-unorm-srgb":case "etc2-rgba8unorm":case "etc2-rgba8unorm-srgb":case "eac-rg11unorm":case "eac-rg11snorm":case "astc-4x4-unorm":case "astc-4x4-unorm-srgb":return {width:4,height:4,length:16};case "bc4-r-unorm":case "bc4-r-snorm":case "bc1-rgba-unorm":case "bc1-rgba-unorm-srgb":case "etc2-rgb8unorm":case "etc2-rgb8unorm-srgb":case "etc2-rgb8a1unorm":case "etc2-rgb8a1unorm-srgb":case "eac-r11unorm":case "eac-r11snorm":return {width:4,height:4,length:8};case "astc-5x4-unorm":case "astc-5x4-unorm-srgb":return {width:5,height:4,length:16};case "astc-5x5-unorm":case "astc-5x5-unorm-srgb":return {width:5,height:5,length:16};case "astc-6x5-unorm":case "astc-6x5-unorm-srgb":return {width:6,height:5,length:16};case "astc-6x6-unorm":case "astc-6x6-unorm-srgb":return {width:6,height:6,length:16};case "astc-8x5-unorm":case "astc-8x5-unorm-srgb":return {width:8,height:5,length:16};case "astc-8x6-unorm":case "astc-8x6-unorm-srgb":return {width:8,height:6,length:16};case "astc-8x8-unorm":case "astc-8x8-unorm-srgb":return {width:8,height:8,length:16};case "astc-10x5-unorm":case "astc-10x5-unorm-srgb":return {width:10,height:5,length:16};case "astc-10x6-unorm":case "astc-10x6-unorm-srgb":return {width:10,height:6,length:16};case "astc-10x8-unorm":case "astc-10x8-unorm-srgb":return {width:10,height:8,length:16};case "astc-10x10-unorm":case "astc-10x10-unorm-srgb":return {width:10,height:10,length:16};case "astc-12x10-unorm":case "astc-12x10-unorm-srgb":return {width:12,height:10,length:16};case "astc-12x12-unorm":case "astc-12x12-unorm-srgb":return {width:12,height:12,length:16}}return {width:1,height:1,length:4}}static IsHardwareTexture(e){return !!e.release}static IsInternalTexture(e){return !!e.dispose}static IsImageBitmap(e){return void 0!==e.close}static IsImageBitmapArray(e){return Array.isArray(e)&&void 0!==e[0].close}static IsCompressedFormat(e){switch(e){case "bc7-rgba-unorm-srgb":case "bc7-rgba-unorm":case "bc6h-rgb-float":case "bc6h-rgb-ufloat":case "bc5-rg-snorm":case "bc5-rg-unorm":case "bc4-r-snorm":case "bc4-r-unorm":case "bc3-rgba-unorm-srgb":case "bc3-rgba-unorm":case "bc2-rgba-unorm-srgb":case "bc2-rgba-unorm":case "bc1-rgba-unorm-srgb":case "bc1-rgba-unorm":case "etc2-rgb8unorm":case "etc2-rgb8unorm-srgb":case "etc2-rgb8a1unorm":case "etc2-rgb8a1unorm-srgb":case "etc2-rgba8unorm":case "etc2-rgba8unorm-srgb":case "eac-r11unorm":case "eac-r11snorm":case "eac-rg11unorm":case "eac-rg11snorm":case "astc-4x4-unorm":case "astc-4x4-unorm-srgb":case "astc-5x4-unorm":case "astc-5x4-unorm-srgb":case "astc-5x5-unorm":case "astc-5x5-unorm-srgb":case "astc-6x5-unorm":case "astc-6x5-unorm-srgb":case "astc-6x6-unorm":case "astc-6x6-unorm-srgb":case "astc-8x5-unorm":case "astc-8x5-unorm-srgb":case "astc-8x6-unorm":case "astc-8x6-unorm-srgb":case "astc-8x8-unorm":case "astc-8x8-unorm-srgb":case "astc-10x5-unorm":case "astc-10x5-unorm-srgb":case "astc-10x6-unorm":case "astc-10x6-unorm-srgb":case "astc-10x8-unorm":case "astc-10x8-unorm-srgb":case "astc-10x10-unorm":case "astc-10x10-unorm-srgb":case "astc-12x10-unorm":case "astc-12x10-unorm-srgb":case "astc-12x12-unorm":case "astc-12x12-unorm-srgb":return  true}return  false}static GetWebGPUTextureFormat(e,r,s=false){switch(r){case Qe$1.TEXTUREFORMAT_DEPTH16:return "depth16unorm";case Qe$1.TEXTUREFORMAT_DEPTH24:return "depth24plus";case Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:return "depth24plus-stencil8";case Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT:return "depth32float";case Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8:return "depth32float-stencil8";case Qe$1.TEXTUREFORMAT_STENCIL8:return "stencil8";case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM:return s?"bc7-rgba-unorm-srgb":"bc7-rgba-unorm";case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT:return "bc6h-rgb-ufloat";case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT:return "bc6h-rgb-float";case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5:return s?"bc3-rgba-unorm-srgb":"bc3-rgba-unorm";case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3:return s?"bc2-rgba-unorm-srgb":"bc2-rgba-unorm";case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1:case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1:return s?"bc1-rgba-unorm-srgb":"bc1-rgba-unorm";case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4:return s?"astc-4x4-unorm-srgb":"astc-4x4-unorm";case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL:case Qe$1.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2:return s?"etc2-rgb8unorm-srgb":"etc2-rgb8unorm";case Qe$1.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC:return s?"etc2-rgba8unorm-srgb":"etc2-rgba8unorm"}switch(e){case Qe$1.TEXTURETYPE_BYTE:switch(r){case Qe$1.TEXTUREFORMAT_RED:return "r8snorm";case Qe$1.TEXTUREFORMAT_RG:return "rg8snorm";case Qe$1.TEXTUREFORMAT_RGB:throw "RGB format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RED_INTEGER:return "r8sint";case Qe$1.TEXTUREFORMAT_RG_INTEGER:return "rg8sint";case Qe$1.TEXTUREFORMAT_RGB_INTEGER:throw "RGB_INTEGER format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:return "rgba8sint";default:return "rgba8snorm"}case Qe$1.TEXTURETYPE_UNSIGNED_BYTE:switch(r){case Qe$1.TEXTUREFORMAT_RED:return "r8unorm";case Qe$1.TEXTUREFORMAT_RG:return "rg8unorm";case Qe$1.TEXTUREFORMAT_RGB:throw "TEXTUREFORMAT_RGB format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RGBA:return s?"rgba8unorm-srgb":"rgba8unorm";case Qe$1.TEXTUREFORMAT_BGRA:return s?"bgra8unorm-srgb":"bgra8unorm";case Qe$1.TEXTUREFORMAT_RED_INTEGER:return "r8uint";case Qe$1.TEXTUREFORMAT_RG_INTEGER:return "rg8uint";case Qe$1.TEXTUREFORMAT_RGB_INTEGER:throw "RGB_INTEGER format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:return "rgba8uint";case Qe$1.TEXTUREFORMAT_ALPHA:throw "TEXTUREFORMAT_ALPHA format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_LUMINANCE:throw "TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_LUMINANCE_ALPHA:throw "TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return "rgba8unorm"}case Qe$1.TEXTURETYPE_SHORT:switch(r){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return "r16sint";case Qe$1.TEXTUREFORMAT_RG_INTEGER:return "rg16sint";case Qe$1.TEXTUREFORMAT_RGB_INTEGER:throw "TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return "rgba16sint"}case Qe$1.TEXTURETYPE_UNSIGNED_SHORT:switch(r){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return "r16uint";case Qe$1.TEXTUREFORMAT_RG_INTEGER:return "rg16uint";case Qe$1.TEXTUREFORMAT_RGB_INTEGER:throw "TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return "rgba16uint"}case Qe$1.TEXTURETYPE_INT:switch(r){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return "r32sint";case Qe$1.TEXTUREFORMAT_RG_INTEGER:return "rg32sint";case Qe$1.TEXTUREFORMAT_RGB_INTEGER:throw "TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return "rgba32sint"}case Qe$1.TEXTURETYPE_UNSIGNED_INTEGER:switch(r){case Qe$1.TEXTUREFORMAT_RED_INTEGER:return "r32uint";case Qe$1.TEXTUREFORMAT_RG_INTEGER:return "rg32uint";case Qe$1.TEXTUREFORMAT_RGB_INTEGER:throw "TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:default:return "rgba32uint"}case Qe$1.TEXTURETYPE_FLOAT:switch(r){case Qe$1.TEXTUREFORMAT_RED:return "r32float";case Qe$1.TEXTUREFORMAT_RG:return "rg32float";case Qe$1.TEXTUREFORMAT_RGB:throw "TEXTUREFORMAT_RGB format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RGBA:default:return "rgba32float"}case Qe$1.TEXTURETYPE_HALF_FLOAT:switch(r){case Qe$1.TEXTUREFORMAT_RED:return "r16float";case Qe$1.TEXTUREFORMAT_RG:return "rg16float";case Qe$1.TEXTUREFORMAT_RGB:throw "TEXTUREFORMAT_RGB format not supported in WebGPU";case Qe$1.TEXTUREFORMAT_RGBA:default:return "rgba16float"}case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:throw "TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case Qe$1.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:switch(r){case Qe$1.TEXTUREFORMAT_RGBA:return "rg11b10ufloat";case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:throw "TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV";default:return "rg11b10ufloat"}case Qe$1.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:switch(r){case Qe$1.TEXTUREFORMAT_RGBA:return "rgb9e5ufloat";case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:throw "TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV";default:return "rgb9e5ufloat"}case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:throw "TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case Qe$1.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:throw "TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case Qe$1.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:switch(r){case Qe$1.TEXTUREFORMAT_RGBA:return "rgb10a2unorm";case Qe$1.TEXTUREFORMAT_RGBA_INTEGER:return "rgb10a2uint";default:return "rgb10a2unorm"}}return s?"rgba8unorm-srgb":"rgba8unorm"}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case "r8unorm":case "r8snorm":case "r8uint":case "r8sint":case "bc4-r-unorm":case "bc4-r-snorm":case "r16uint":case "r16sint":case "depth16unorm":case "r16float":case "r16unorm":case "r16snorm":case "r32uint":case "r32sint":case "r32float":case "depth32float":case "stencil8":case "depth24plus":case "eac-r11unorm":case "eac-r11snorm":return 1;case "rg8unorm":case "rg8snorm":case "rg8uint":case "rg8sint":case "depth32float-stencil8":case "bc5-rg-unorm":case "bc5-rg-snorm":case "rg16uint":case "rg16sint":case "rg16float":case "rg16unorm":case "rg16snorm":case "rg32uint":case "rg32sint":case "rg32float":case "depth24plus-stencil8":case "eac-rg11unorm":case "eac-rg11snorm":return 2;case "rgb9e5ufloat":case "rg11b10ufloat":case "bc6h-rgb-ufloat":case "bc6h-rgb-float":case "etc2-rgb8unorm":case "etc2-rgb8unorm-srgb":return 3;case "rgba8unorm":case "rgba8unorm-srgb":case "rgba8snorm":case "rgba8uint":case "rgba8sint":case "bgra8unorm":case "bgra8unorm-srgb":case "rgba16unorm":case "rgba16snorm":case "rgb10a2uint":case "rgb10a2unorm":case "bc7-rgba-unorm":case "bc7-rgba-unorm-srgb":case "bc3-rgba-unorm":case "bc3-rgba-unorm-srgb":case "bc2-rgba-unorm":case "bc2-rgba-unorm-srgb":case "bc1-rgba-unorm":case "bc1-rgba-unorm-srgb":case "rgba16uint":case "rgba16sint":case "rgba16float":case "rgba32uint":case "rgba32sint":case "rgba32float":case "etc2-rgb8a1unorm":case "etc2-rgb8a1unorm-srgb":case "etc2-rgba8unorm":case "etc2-rgba8unorm-srgb":case "astc-4x4-unorm":case "astc-4x4-unorm-srgb":case "astc-5x4-unorm":case "astc-5x4-unorm-srgb":case "astc-5x5-unorm":case "astc-5x5-unorm-srgb":case "astc-6x5-unorm":case "astc-6x5-unorm-srgb":case "astc-6x6-unorm":case "astc-6x6-unorm-srgb":case "astc-8x5-unorm":case "astc-8x5-unorm-srgb":case "astc-8x6-unorm":case "astc-8x6-unorm-srgb":case "astc-8x8-unorm":case "astc-8x8-unorm-srgb":case "astc-10x5-unorm":case "astc-10x5-unorm-srgb":case "astc-10x6-unorm":case "astc-10x6-unorm-srgb":case "astc-10x8-unorm":case "astc-10x8-unorm-srgb":case "astc-10x10-unorm":case "astc-10x10-unorm-srgb":case "astc-12x10-unorm":case "astc-12x10-unorm-srgb":case "astc-12x12-unorm":case "astc-12x12-unorm-srgb":return 4}throw `Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case "stencil8":case "depth32float-stencil8":case "depth24plus-stencil8":return  true}return  false}static HasDepthAndStencilAspects(e){switch(e){case "depth32float-stencil8":case "depth24plus-stencil8":return  true}return  false}static GetDepthFormatOnly(e){switch(e){case "depth16unorm":return "depth16unorm";case "depth24plus":case "depth24plus-stencil8":return "depth24plus";case "depth32float":case "depth32float-stencil8":return "depth32float"}return e}static GetSample(e){return e>1?4:1}};let V$5=class V{constructor(){this._gpuTimeInFrameId=-1,this.counter=new sa;}_addDuration(e,t){e<this._gpuTimeInFrameId||(this._gpuTimeInFrameId!==e?(this.counter._fetchResult(),this.counter.fetchNewFrame(),this.counter.addCount(t,false),this._gpuTimeInFrameId=e):this.counter.addCount(t,false));}};let $$1=class $ extends jt{constructor(){super(...arguments),this.dbgShowShaderCode=false,this.dbgSanityChecks=true,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=true,this.dbgShowEmptyEnableEffectCalls=true,this.dbgVerboseLogsForFirstFrames=false,this._currentRenderPass=null,this._snapshotRenderingMode=Qe$1.SNAPSHOTRENDERING_STANDARD,this._timestampIndex=0,this._debugStackRenderPass=[];}get enableGPUTimingMeasurements(){return this._timestampQuery.enable}set enableGPUTimingMeasurements(e){this._timestampQuery.enable!==e&&(this.gpuTimeInFrameForMainPass=e?new V$5:void 0,this._timestampQuery.enable=e);}_currentPassIsMainPass(){return null===this._currentRenderTarget}_endCurrentRenderPass(){if(!this._currentRenderPass)return 0;if(0!==this._debugStackRenderPass.length)for(let e=0;e<this._debugStackRenderPass.length;++e)this._currentRenderPass.popDebugGroup();const e=this._currentPassIsMainPass()?2:1;return this._snapshotRendering.endRenderPass(this._currentRenderPass)||this.compatibilityMode||(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this._timestampQuery.endPass(this._timestampIndex,this._currentRenderTarget&&this._currentRenderTarget.gpuTimeInFrame?this._currentRenderTarget.gpuTimeInFrame:this.gpuTimeInFrameForMainPass),this._timestampIndex+=2,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log("frame #"+this._count+" - "+(2===e?"main":"render target")+" end pass"+(1===e?" - internalTexture.uniqueId="+this._currentRenderTarget?.texture?.uniqueId:""))),this._debugPopGroup?.(0),this._currentRenderPass=null,e}_generateMipmaps(e,t){t=t??this._renderEncoder;const r=e._hardwareTexture;if(!r)return;t===this._renderEncoder&&this._endCurrentRenderPass();const s=e._hardwareTexture.format,i=W$1.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(r,s,i,t):this._textureHelper.generateMipmaps(r,s,i,0,e.is3D,t);}};var k$2,X$1,H$1,Y$1,q$1,Q$3,z$4,K$1,j$2,J$1,Z$1,ee,te,re$1,se$1,ne$1,ie$1,ae$1,oe$1,ue$1,ce,he$1,le,de,pe,_e,ge,fe,me,be,xe,Te,ye,Ee,Re,Se,Ce,Ae,Ie,ve,we;!function(e){e.LowPower="low-power",e.HighPerformance="high-performance";}(k$2||(k$2={})),function(e){e.CoreFeaturesAndLimits="core-features-and-limits",e.DepthClipControl="depth-clip-control",e.Depth32FloatStencil8="depth32float-stencil8",e.TextureCompressionBC="texture-compression-bc",e.TextureCompressionBCSliced3D="texture-compression-bc-sliced-3d",e.TextureCompressionETC2="texture-compression-etc2",e.TextureCompressionASTC="texture-compression-astc",e.TextureCompressionASTCSliced3D="texture-compression-astc-sliced-3d",e.TimestampQuery="timestamp-query",e.IndirectFirstInstance="indirect-first-instance",e.ShaderF16="shader-f16",e.RG11B10UFloatRenderable="rg11b10ufloat-renderable",e.BGRA8UnormStorage="bgra8unorm-storage",e.Float32Filterable="float32-filterable",e.Float32Blendable="float32-blendable",e.ClipDistances="clip-distances",e.DualSourceBlending="dual-source-blending",e.Subgroups="subgroups",e.TextureFormatsTier1="texture-formats-tier1",e.TextureFormatsTier2="texture-formats-tier2";}(X$1||(X$1={})),function(e){e.Unmapped="unmapped",e.Pending="pending",e.Mapped="mapped";}(H$1||(H$1={})),function(e){e[e.MapRead=1]="MapRead",e[e.MapWrite=2]="MapWrite",e[e.CopySrc=4]="CopySrc",e[e.CopyDst=8]="CopyDst",e[e.Index=16]="Index",e[e.Vertex=32]="Vertex",e[e.Uniform=64]="Uniform",e[e.Storage=128]="Storage",e[e.Indirect=256]="Indirect",e[e.QueryResolve=512]="QueryResolve";}(Y$1||(Y$1={})),function(e){e[e.Read=1]="Read",e[e.Write=2]="Write";}(q$1||(q$1={})),function(e){e.E1d="1d",e.E2d="2d",e.E3d="3d";}(Q$3||(Q$3={})),function(e){e[e.CopySrc=1]="CopySrc",e[e.CopyDst=2]="CopyDst",e[e.TextureBinding=4]="TextureBinding",e[e.StorageBinding=8]="StorageBinding",e[e.RenderAttachment=16]="RenderAttachment";}(z$4||(z$4={})),function(e){e.E1d="1d",e.E2d="2d",e.E2dArray="2d-array",e.Cube="cube",e.CubeArray="cube-array",e.E3d="3d";}(K$1||(K$1={})),function(e){e.All="all",e.StencilOnly="stencil-only",e.DepthOnly="depth-only";}(j$2||(j$2={})),function(e){e.R8Unorm="r8unorm",e.R8Snorm="r8snorm",e.R8Uint="r8uint",e.R8Sint="r8sint",e.R16Uint="r16uint",e.R16Sint="r16sint",e.R16Float="r16float",e.RG8Unorm="rg8unorm",e.RG8Snorm="rg8snorm",e.RG8Uint="rg8uint",e.RG8Sint="rg8sint",e.R16Unorm="r16unorm",e.R16Snorm="r16snorm",e.R32Uint="r32uint",e.R32Sint="r32sint",e.R32Float="r32float",e.RG16Uint="rg16uint",e.RG16Sint="rg16sint",e.RG16Float="rg16float",e.RGBA8Unorm="rgba8unorm",e.RGBA8UnormSRGB="rgba8unorm-srgb",e.RGBA8Snorm="rgba8snorm",e.RGBA8Uint="rgba8uint",e.RGBA8Sint="rgba8sint",e.BGRA8Unorm="bgra8unorm",e.BGRA8UnormSRGB="bgra8unorm-srgb",e.RG16Unorm="rg16unorm",e.RG16Snorm="rg16snorm",e.RGB9E5UFloat="rgb9e5ufloat",e.RGB10A2UINT="rgb10a2uint",e.RGB10A2Unorm="rgb10a2unorm",e.RG11B10UFloat="rg11b10ufloat",e.RG32Uint="rg32uint",e.RG32Sint="rg32sint",e.RG32Float="rg32float",e.RGBA16Uint="rgba16uint",e.RGBA16Sint="rgba16sint",e.RGBA16Float="rgba16float",e.RGBA16Unorm="rgba16unorm",e.RGBA16Snorm="rgba16snorm",e.RGBA32Uint="rgba32uint",e.RGBA32Sint="rgba32sint",e.RGBA32Float="rgba32float",e.Stencil8="stencil8",e.Depth16Unorm="depth16unorm",e.Depth24Plus="depth24plus",e.Depth24PlusStencil8="depth24plus-stencil8",e.Depth32Float="depth32float",e.BC1RGBAUnorm="bc1-rgba-unorm",e.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",e.BC2RGBAUnorm="bc2-rgba-unorm",e.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",e.BC3RGBAUnorm="bc3-rgba-unorm",e.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",e.BC4RUnorm="bc4-r-unorm",e.BC4RSnorm="bc4-r-snorm",e.BC5RGUnorm="bc5-rg-unorm",e.BC5RGSnorm="bc5-rg-snorm",e.BC6HRGBUFloat="bc6h-rgb-ufloat",e.BC6HRGBFloat="bc6h-rgb-float",e.BC7RGBAUnorm="bc7-rgba-unorm",e.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",e.ETC2RGB8Unorm="etc2-rgb8unorm",e.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",e.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",e.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",e.ETC2RGBA8Unorm="etc2-rgba8unorm",e.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",e.EACR11Unorm="eac-r11unorm",e.EACR11Snorm="eac-r11snorm",e.EACRG11Unorm="eac-rg11unorm",e.EACRG11Snorm="eac-rg11snorm",e.ASTC4x4Unorm="astc-4x4-unorm",e.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",e.ASTC5x4Unorm="astc-5x4-unorm",e.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",e.ASTC5x5Unorm="astc-5x5-unorm",e.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",e.ASTC6x5Unorm="astc-6x5-unorm",e.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",e.ASTC6x6Unorm="astc-6x6-unorm",e.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",e.ASTC8x5Unorm="astc-8x5-unorm",e.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",e.ASTC8x6Unorm="astc-8x6-unorm",e.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",e.ASTC8x8Unorm="astc-8x8-unorm",e.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",e.ASTC10x5Unorm="astc-10x5-unorm",e.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",e.ASTC10x6Unorm="astc-10x6-unorm",e.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",e.ASTC10x8Unorm="astc-10x8-unorm",e.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",e.ASTC10x10Unorm="astc-10x10-unorm",e.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",e.ASTC12x10Unorm="astc-12x10-unorm",e.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",e.ASTC12x12Unorm="astc-12x12-unorm",e.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",e.Depth32FloatStencil8="depth32float-stencil8";}(J$1||(J$1={})),function(e){e.ClampToEdge="clamp-to-edge",e.Repeat="repeat",e.MirrorRepeat="mirror-repeat";}(Z$1||(Z$1={})),function(e){e.Nearest="nearest",e.Linear="linear";}(ee||(ee={})),function(e){e.Nearest="nearest",e.Linear="linear";}(te||(te={})),function(e){e.Never="never",e.Less="less",e.Equal="equal",e.LessEqual="less-equal",e.Greater="greater",e.NotEqual="not-equal",e.GreaterEqual="greater-equal",e.Always="always";}(re$1||(re$1={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Compute=4]="Compute";}(se$1||(se$1={})),function(e){e.Uniform="uniform",e.Storage="storage",e.ReadOnlyStorage="read-only-storage";}(ne$1||(ne$1={})),function(e){e.Filtering="filtering",e.NonFiltering="non-filtering",e.Comparison="comparison";}(ie$1||(ie$1={})),function(e){e.Float="float",e.UnfilterableFloat="unfilterable-float",e.Depth="depth",e.Sint="sint",e.Uint="uint";}(ae$1||(ae$1={})),function(e){e.WriteOnly="write-only",e.ReadOnly="read-only",e.ReadWrite="read-write";}(oe$1||(oe$1={})),function(e){e.Error="error",e.Warning="warning",e.Info="info";}(ue$1||(ue$1={})),function(e){e.Validation="validation",e.Internal="internal";}(ce||(ce={})),function(e){e.Auto="auto";}(he$1||(he$1={})),function(e){e.PointList="point-list",e.LineList="line-list",e.LineStrip="line-strip",e.TriangleList="triangle-list",e.TriangleStrip="triangle-strip";}(le||(le={})),function(e){e.CCW="ccw",e.CW="cw";}(de||(de={})),function(e){e.None="none",e.Front="front",e.Back="back";}(pe||(pe={})),function(e){e[e.Red=1]="Red",e[e.Green=2]="Green",e[e.Blue=4]="Blue",e[e.Alpha=8]="Alpha",e[e.All=15]="All";}(_e||(_e={})),function(e){e.Zero="zero",e.One="one",e.Src="src",e.OneMinusSrc="one-minus-src",e.SrcAlpha="src-alpha",e.OneMinusSrcAlpha="one-minus-src-alpha",e.Dst="dst",e.OneMinusDst="one-minus-dst",e.DstAlpha="dst-alpha",e.OneMinusDstAlpha="one-minus-dst-alpha",e.SrcAlphaSaturated="src-alpha-saturated",e.Constant="constant",e.OneMinusConstant="one-minus-constant",e.Src1="src1",e.OneMinusSrc1="one-minus-src1",e.Src1Alpha="src1-alpha",e.OneMinusSrc1Alpha="one-minus-src1-alpha";}(ge||(ge={})),function(e){e.Add="add",e.Subtract="subtract",e.ReverseSubtract="reverse-subtract",e.Min="min",e.Max="max";}(fe||(fe={})),function(e){e.Keep="keep",e.Zero="zero",e.Replace="replace",e.Invert="invert",e.IncrementClamp="increment-clamp",e.DecrementClamp="decrement-clamp",e.IncrementWrap="increment-wrap",e.DecrementWrap="decrement-wrap";}(me||(me={})),function(e){e.Uint16="uint16",e.Uint32="uint32";}(be||(be={})),function(e){e.Uint8="uint8",e.Uint8x2="uint8x2",e.Uint8x4="uint8x4",e.Sint8="sint8",e.Sint8x2="sint8x2",e.Sint8x4="sint8x4",e.Unorm8="unorm8",e.Unorm8x2="unorm8x2",e.Unorm8x4="unorm8x4",e.Snorm8="snorm8",e.Snorm8x2="snorm8x2",e.Snorm8x4="snorm8x4",e.Uint16="uint16",e.Uint16x2="uint16x2",e.Uint16x4="uint16x4",e.Sint16="sint16",e.Sint16x2="sint16x2",e.Sint16x4="sint16x4",e.Unorm16="unorm16",e.Unorm16x2="unorm16x2",e.Unorm16x4="unorm16x4",e.Snorm16="snorm16",e.Snorm16x2="snorm16x2",e.Snorm16x4="snorm16x4",e.Float16="float16",e.Float16x2="float16x2",e.Float16x4="float16x4",e.Float32="float32",e.Float32x2="float32x2",e.Float32x3="float32x3",e.Float32x4="float32x4",e.Uint32="uint32",e.Uint32x2="uint32x2",e.Uint32x3="uint32x3",e.Uint32x4="uint32x4",e.Sint32="sint32",e.Sint32x2="sint32x2",e.Sint32x3="sint32x3",e.Sint32x4="sint32x4",e.UNORM10x10x10x2="unorm10-10-10-2",e.UNORM8x4BGRA="unorm8x4-bgra";}(xe||(xe={})),function(e){e.Vertex="vertex",e.Instance="instance";}(Te||(Te={})),function(e){e.Beginning="beginning",e.End="end";}(ye||(ye={})),function(e){e.Beginning="beginning",e.End="end";}(Ee||(Ee={})),function(e){e.Load="load",e.Clear="clear";}(Re||(Re={})),function(e){e.Store="store",e.Discard="discard";}(Se||(Se={})),function(e){e.Occlusion="occlusion",e.Timestamp="timestamp";}(Ce||(Ce={})),function(e){e.Opaque="opaque",e.Premultiplied="premultiplied";}(Ae||(Ae={})),function(e){e.Standard="standard",e.Extended="extended";}(Ie||(Ie={})),function(e){e.Unknown="unknown",e.Destroyed="destroyed";}(ve||(ve={})),function(e){e.Validation="validation",e.OutOfMemory="out-of-memory",e.Internal="internal";}(we||(we={}));class Be{constructor(){this.shaderLanguage=0;}_addUniformToLeftOverUBO(e,t,r){let s=0;[e,t,s]=this._getArraySize(e,t,r);for(let t=0;t<this._webgpuProcessingContext.leftOverUniforms.length;t++)if(this._webgpuProcessingContext.leftOverUniforms[t].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:s});}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return "";const e=Be.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,"uniform",true),this._addBufferBindingDescription(e,t,"uniform",false)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(void 0!==t)for(let r=0;r<t.length;r++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e][r],s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].name,n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].nameInArrayOfTexture;t&&(t.texture||t.externalTexture||t.storageTexture?this._webgpuProcessingContext.textureNames.push(n):t.sampler?this._webgpuProcessingContext.samplerNames.push(s):t.buffer&&this._webgpuProcessingContext.bufferNames.push(s));}else this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[];}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[t],s=[];for(let e=0;e<r.length;e++){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[t][e];r.sampler||r.texture||r.storageTexture||r.externalTexture?s.push({binding:r.binding,resource:void 0}):r.buffer&&s.push({binding:r.binding,resource:{buffer:void 0,offset:0,size:0}});}e[t]=s;}}_addTextureBindingDescription(e,t,r,s,n,i){let{groupIndex:a,bindingIndex:o}=t.textures[r];if(this._webgpuProcessingContext.bindGroupLayoutEntries[a]||(this._webgpuProcessingContext.bindGroupLayoutEntries[a]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]){let i;i=null===s?this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,externalTexture:{}}):n?this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,storageTexture:{access:"write-only",format:n,viewDimension:s}}):this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,texture:{sampleType:t.sampleType,viewDimension:s,multisampled:false}});const u=t.isTextureArray?e+r:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]={name:e,index:i-1,nameInArrayOfTexture:u};}o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o].index,this._webgpuProcessingContext.bindGroupLayoutEntries[a][o].visibility|=i?1:2;}_addSamplerBindingDescription(e,t,r){let{groupIndex:s,bindingIndex:n}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n]){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:n,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n]={name:e,index:r-1};}n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n].index,this._webgpuProcessingContext.bindGroupLayoutEntries[s][n].visibility|=r?1:2;}_addBufferBindingDescription(e,t,r,s){let{groupIndex:n,bindingIndex:i}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[n]||(this._webgpuProcessingContext.bindGroupLayoutEntries[n]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][i]){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[n].push({binding:i,visibility:0,buffer:{type:r}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][i]={name:e,index:t-1};}i=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][i].index,this._webgpuProcessingContext.bindGroupLayoutEntries[n][i].visibility|=s?1:2;}}Be.LeftOvertUBOName="LeftOver",Be.InternalsUBOName="Internals",Be.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16,mat2x2f:4,mat3x3f:12,mat4x4f:16,vec2i:2,vec3i:3,vec4i:4,vec2u:2,vec3u:3,vec4u:4,vec2f:2,vec3f:3,vec4f:4,vec2h:1,vec3h:2,vec4h:2},Be._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},Be._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},Be._GpuTextureViewDimensionByWebGPUTextureType={textureCube:"cube",textureCubeArray:"cube-array",texture2D:"2d",texture2DArray:"2d-array",texture3D:"3d"},Be._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},Be._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:true,samplerArrayShadow:true,sampler:false};class Fe{get isAsync(){return  false}get isReady(){return !!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={};}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,r,s,n,i,a,o){const u=this.engine;u._doNotHandleContextLost&&(e._fragmentSourceCode="",e._vertexSourceCode="");const c=this.shaderProcessingContext.availableTextures;let h;for(h=0;h<n.length;h++){const e=n[h],t=c[n[h]];null==t||null==t?(n.splice(h,1),h--):i[e]=h;}for(const e of u.getAttributes(this,a))o.push(e);this.buildUniformLayout();const l=[],d=[];for(h=0;h<a.length;h++){const e=o[h];e>=0&&(l.push(a[h]),d.push(e));}this.shaderProcessingContext.attributeNamesFromEffect=l,this.shaderProcessingContext.attributeLocationsFromEffect=d;}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer?.dispose(),this.uniformBuffer=new cs(this.engine,void 0,void 0,"leftOver-"+this._name);for(const e of this.shaderProcessingContext.leftOverUniforms){const t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),r=Be.UniformSizes[t];this.uniformBuffer.addUniform(e.name,r,e.length),this._leftOverUniformsByName[e.name]=e.type;}this.uniformBuffer.create();}}setEngine(e){this.engine=e;}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose();}setInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt(e,t);}setInt2(e,t,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt2(e,t,r);}setInt3(e,t,r,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt3(e,t,r,s);}setInt4(e,t,r,s,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt4(e,t,r,s,n);}setIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateIntArray(e,t);}setIntArray2(e,t){this.setIntArray(e,t);}setIntArray3(e,t){this.setIntArray(e,t);}setIntArray4(e,t){this.setIntArray(e,t);}setUInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt(e,t);}setUInt2(e,t,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt2(e,t,r);}setUInt3(e,t,r,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt3(e,t,r,s);}setUInt4(e,t,r,s,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt4(e,t,r,s,n);}setUIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUIntArray(e,t);}setUIntArray2(e,t){this.setUIntArray(e,t);}setUIntArray3(e,t){this.setUIntArray(e,t);}setUIntArray4(e,t){this.setUIntArray(e,t);}setArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateArray(e,t);}setArray2(e,t){this.setArray(e,t);}setArray3(e,t){this.setArray(e,t);}setArray4(e,t){this.setArray(e,t);}setMatrices(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrices(e,t);}setMatrix(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix(e,t);}setMatrix3x3(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix3x3(e,t);}setMatrix2x2(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix2x2(e,t);}setFloat(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat(e,t);}setVector2(e,t){this.setFloat2(e,t.x,t.y);}setFloat2(e,t,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat2(e,t,r);}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z);}setFloat3(e,t,r,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat3(e,t,r,s);}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w);}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w);}setFloat4(e,t,r,s,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat4(e,t,r,s,n);}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b);}setColor4(e,t,r){this.setFloat4(e,t.r,t.g,t.b,r);}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a);}_getVertexShaderCode(){return this.sources?.vertex}_getFragmentShaderCode(){return this.sources?.fragment}}const Pe={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class De{static get KnownUBOs(){return De._SimplifiedKnownBindings?De._SimplifiedKnownUBOs:De._KnownUBOs}constructor(e,t=false){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],t||this._findStartingGroupBinding();}_findStartingGroupBinding(){const e=De.KnownUBOs,t=[];for(const r in e){const s=e[r].binding;-1!==s.groupIndex&&(void 0===t[s.groupIndex]?t[s.groupIndex]=s.bindingIndex:t[s.groupIndex]=Math.max(t[s.groupIndex],s.bindingIndex));}this.freeGroupIndex=t.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1;}getAttributeNextLocation(e,t=0){const r=this._attributeNextLocation;return this._attributeNextLocation+=(Pe[e]??1)*(t||1),r}getVaryingNextLocation(e,t=0){const r=this._varyingNextLocation;return this._varyingNextLocation+=(Pe[e]??1)*(t||1),r}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>65536-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw "Too many textures or UBOs have been declared and it is not supported in WebGPU.";const t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}function Le(e,t,r,s){let n=s,i=0,a="";for(;n<r.length;){const s=r.charAt(n);if(a)s===a?'"'===a||"'"===a?"\\"!==r.charAt(n-1)&&(a=""):a="":"*/"===a&&"*"===s&&n+1<r.length&&("/"===r.charAt(n+1)&&(a=""),""===a&&n++);else switch(s){case e:i++;break;case t:i--;break;case '"':case "'":case "`":a=s;break;case "/":if(n+1<r.length){const e=r.charAt(n+1);"/"===e?a="\n":"*"===e&&(a="*/");}}if(n++,0===i)break}return 0===i?n-1:-1}function Me(e,t){for(;t<e.length;){const r=e[t];if(" "!==r&&"\n"!==r&&"\r"!==r&&"\t"!==r&&"\n"!==r&&""!==r)break;t++;}return t}function Ue(e){const t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122||95==t}function Oe(e){let t=0,r="",s=false;const n=[];for(;t<e.length;){const i=e.charAt(t);if(r)i===r?'"'===r||"'"===r?("\\"!==e.charAt(t-1)&&(r=""),n.push(i)):(r="",s=false):"*/"===r&&"*"===i&&t+1<e.length?("/"===e.charAt(t+1)&&(r=""),""===r&&(s=false,t++)):s||n.push(i);else {switch(i){case '"':case "'":case "`":r=i;break;case "/":if(t+1<e.length){const n=e.charAt(t+1);"/"===n?(r="\n",s=true):"*"===n&&(r="*/",s=true);}}s||n.push(i);}t++;}return n.join("")}function Ge(e,t,r,s){for(;t>=0&&e.charAt(t)!==r&&e.charAt(t)!==s;)t--;return t}function Ne(e,t,r,s){let n=e.indexOf(t);if(n<0)return e;if(r){for(;n++<e.length&&"{"!=e.charAt(n););if(n<e.length){const t=e.substring(0,n+1),s=e.substring(n+1);e=t+r+s;}}if(s){const t=e.lastIndexOf("}");e=e.substring(0,t),e+=s+"\n}";}return e}De._SimplifiedKnownBindings=true,De._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},De._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}};class We extends Be{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=false,this._fragmentIsGLES3=false,this.shaderLanguage=0,this.parseGLES3=true;}_getArraySize(e,t,r){let s=0;const n=e.indexOf("["),i=e.indexOf("]");if(n>0&&i>0){const t=e.substring(n+1,i);s=+t,isNaN(s)&&(s=+r[t.trim()]),e=e.substring(0,n);}return [e,t,s]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0;}preProcessShaderCode(e,t){const r=`// Internals UBO\nuniform ${Be.InternalsUBOName} {\nfloat yFactor_;\nfloat textureOutputHeight_;\n};\n`,s=-1!==e.indexOf("// Internals UBO");return t?(this._fragmentIsGLES3=-1!==e.indexOf("#version 3"),this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),s?e:r+"##INJECTCODE##\n"+e):(this._vertexIsGLES3=-1!==e.indexOf("#version 3"),this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),s?e:r+e)}varyingCheck(e,t){return (t&&this._fragmentIsGLES3?/(flat\s)?\s*\bin\b/:!t&&this._vertexIsGLES3?/(flat\s)?\s*\bout\b/:/(flat\s)?\s*\bvarying\b/).test(e)}varyingProcessor(e,t,r){this._preProcessors=r;const s=(t&&this._fragmentIsGLES3?/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!t&&this._vertexIsGLES3?/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==s){const i=s[1]??"",a=s[2],o=s[3];let u;t?(u=this._webgpuProcessingContext.availableVaryings[o],this._missingVaryings[u]="",void 0===u&&Ie$2.Warn(`Invalid fragment shader: The varying named "${o}" is not declared in the vertex shader! This declaration will be ignored.`)):(u=this._webgpuProcessingContext.getVaryingNextLocation(a,this._getArraySize(o,a,r)[2]),this._webgpuProcessingContext.availableVaryings[o]=u,this._missingVaryings[u]=`layout(location = ${u}) ${i} in ${a} ${o};`),e=e.replace(s[0],void 0===u?"":`layout(location = ${u}) ${i} ${t?"in":"out"} ${a} ${o};`);}return e}attributeProcessor(e,t){this._preProcessors=t;const r=(this._vertexIsGLES3?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==r){const s=r[1],n=r[2],i=this._webgpuProcessingContext.getAttributeNextLocation(s,this._getArraySize(n,s,t)[2]);this._webgpuProcessingContext.availableAttributes[n]=i,this._webgpuProcessingContext.orderedAttributes[i]=n;const a=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[n];if(void 0!==a){const t=a<0?-1===a?"int":"ivec"+-a:1===a?"uint":"uvec"+a,o=`_int_${n}_`;e=e.replace(r[0],`layout(location = ${i}) in ${t} ${o}; ${s} ${n} = ${s}(${o});`);}else e=e.replace(r[0],`layout(location = ${i}) in ${s} ${n};`);}return e}uniformProcessor(e,r,s){this._preProcessors=s;const n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==n){let i=n[1],a=n[2];if(0===i.indexOf("sampler")||1===i.indexOf("sampler")){let n=0;[a,i,n]=this._getArraySize(a,i,s);let o=this._webgpuProcessingContext.availableTextures[a];if(!o){o={autoBindSampler:true,isTextureArray:n>0,isStorageTexture:false,textures:[],sampleType:"float"};for(let e=0;e<(n||1);++e)o.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding());}const u=Be._SamplerTypeByWebGLSamplerType[i]??"sampler",c=!!Be._IsComparisonSamplerByWebGPUSamplerType[u],h=c?"comparison":"filtering",l=a+Qe$1.AUTOSAMPLERSUFFIX;let d=this._webgpuProcessingContext.availableSamplers[l];d||(d={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:h});const p="u"===i.charAt(0)?"u":"i"===i.charAt(0)?"i":"";p&&(i=i.substring(1));const _=c?"depth":"u"===p?"uint":"i"===p?"sint":"float";o.sampleType=_;const g=n>0,f=d.binding.groupIndex,m=d.binding.bindingIndex,b=Be._SamplerFunctionByWebGLSamplerType[i],x=Be._TextureTypeByWebGLSamplerType[i],T=Be._GpuTextureViewDimensionByWebGPUTextureType[x];if(g){const t=[];t.push(`layout(set = ${f}, binding = ${m}) uniform ${p}${u} ${l};`),e="\n";for(let r=0;r<n;++r){const s=o.textures[r].groupIndex,n=o.textures[r].bindingIndex;t.push(`layout(set = ${s}, binding = ${n}) uniform ${x} ${a}Texture${r};`),e+=`${r>0?"\n":""}#define ${a}${r} ${p}${b}(${a}Texture${r}, ${l})`;}e=t.join("\n")+e,this._textureArrayProcessing.push(a);}else n=1,e=`layout(set = ${f}, binding = ${m}) uniform ${u} ${l};\n                        layout(set = ${o.textures[0].groupIndex}, binding = ${o.textures[0].bindingIndex}) uniform ${p}${x} ${a}Texture;\n                        #define ${a} ${p}${b}(${a}Texture, ${l})`;this._webgpuProcessingContext.availableTextures[a]=o,this._webgpuProcessingContext.availableSamplers[l]=d,this._addSamplerBindingDescription(l,d,!r);for(let e=0;e<n;++e)this._addTextureBindingDescription(a,o,e,T,null,!r);}else this._addUniformToLeftOverUBO(a,i,s),e="";}return e}uniformBufferProcessor(e,t){const r=/uniform\s+(\w+)/gm.exec(e);if(null!==r){const s=r[1];let n=this._webgpuProcessingContext.availableBuffers[s];if(!n){const e=De.KnownUBOs[s];let t;t=e&&-1!==e.binding.groupIndex?e.binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),n={binding:t},this._webgpuProcessingContext.availableBuffers[s]=n;}this._addBufferBindingDescription(s,n,"uniform",!t),e=e.replace("uniform",`layout(set = ${n.binding.groupIndex}, binding = ${n.binding.bindingIndex}) uniform`);}return e}postProcessor(e,t,r,s,n,i){const a=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),r){const t=e.indexOf("gl_FragCoord")>=0,r="\n                glFragCoord_ = gl_FragCoord;\n                if (yFactor_ == 1.) {\n                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;\n                }\n            ",s=t?"vec4 glFragCoord_;\n":"",n=-1!==e.search(/layout *\(location *= *0\) *out/g);if(e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this._fragmentIsGLES3){const t=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);null!==t&&(e=e.substring(0,t.index)+"layout(location = 0) "+e.substring(t.index));}else e=e.replace(/void\s+?main\s*\(/g,(a||n?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");e=(e=e.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",s),t&&(e=Ne(e,"void main",r));}else {"VERTEXOUTPUT_INVARIANT"in i&&(e="invariant gl_Position;\n"+e),e=(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex");if(-1!==t.indexOf("#define MULTIVIEW"))return "#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e}if(!r){const t=e.lastIndexOf("}");e=e.substring(0,t),e+="gl_Position.y *= yFactor_;\n",e+="}";}return e}_applyTextureArrayProcessing(e,t){const r=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let s=r.exec(e);for(;null!==s;){const n=s[1];let i=+n;this._preProcessors&&isNaN(i)&&(i=+this._preProcessors[n.trim()]),e=e.replace(s[0],t+i),s=r.exec(e);}return e}_generateLeftOverUBOCode(e,t){let r=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {\n    `;for(const e of this._webgpuProcessingContext.leftOverUniforms)e.length>0?r+=`    ${e.type} ${e.name}[${e.length}];\n`:r+=`    ${e.type} ${e.name};\n`;return r+="};\n\n",r}finalizeShaders(e,t){for(let r=0;r<this._textureArrayProcessing.length;++r){const s=this._textureArrayProcessing[r];e=this._applyTextureArrayProcessing(e,s),t=this._applyTextureArrayProcessing(t,s);}for(let e=0;e<this._missingVaryings.length;++e){const r=this._missingVaryings[e];r&&r.length>0&&(t=r+"\n"+t);}const r=this._buildLeftOverUBO();return e=r+e,t=r+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}const Ve="fragmentOutputs.fragDepth",$e={texture_1d:"1d",texture_2d:"2d",texture_2d_array:"2d-array",texture_3d:"3d",texture_cube:"cube",texture_cube_array:"cube-array",texture_multisampled_2d:"2d",texture_depth_2d:"2d",texture_depth_2d_array:"2d-array",texture_depth_cube:"cube",texture_depth_cube_array:"cube-array",texture_depth_multisampled_2d:"2d",texture_storage_1d:"1d",texture_storage_2d:"2d",texture_storage_2d_array:"2d-array",texture_storage_3d:"3d",texture_external:null};class ke extends Be{constructor(){super(...arguments),this.shaderLanguage=1,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=true,this.pureMode=false;}_getArraySize(e,t,r){let s=0;const n=t.lastIndexOf(">");if(t.indexOf("array")>=0&&n>0){let e=n;for(;e>0&&" "!==t.charAt(e)&&","!==t.charAt(e);)e--;const i=t.substring(e+1,n);for(s=+i,isNaN(s)&&(s=+r[i.trim()]);e>0&&(" "===t.charAt(e)||","===t.charAt(e));)e--;t=t.substring(t.indexOf("<")+1,e+1);}return [e,t,s]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=false,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[];}preProcessShaderCode(e){const t=this.pureMode?"":`struct ${Be.InternalsUBOName} {\n  yFactor_: f32,\n  textureOutputHeight_: f32,\n};\nvar<uniform> internals : ${Be.InternalsUBOName};\n`;return  -1!==e.indexOf(t)?e:t+Oe(e)}varyingCheck(e){return /(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,r){const s=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==s){const i=s[1]??"perspective",a=s[2]??"center",o=s[4],u=s[3],c="flat"===i?`@interpolate(${i})`:`@interpolate(${i}, ${a})`;let h;t?(h=this._webgpuProcessingContext.availableVaryings[u],void 0===h&&Ie$2.Warn(`Invalid fragment shader: The varying named "${u}" is not declared in the vertex shader! This declaration will be ignored.`)):(h=this._webgpuProcessingContext.getVaryingNextLocation(o,this._getArraySize(u,o,r)[2]),this._webgpuProcessingContext.availableVaryings[u]=h,this._varyingsWGSL.push(`  @location(${h}) ${c} ${u} : ${o},`),this._varyingNamesWGSL.push(u)),e="";}return e}attributeProcessor(e,t){const r=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==r){const s=r[2],n=r[1],i=this._webgpuProcessingContext.getAttributeNextLocation(s,this._getArraySize(n,s,t)[2]);this._webgpuProcessingContext.availableAttributes[n]=i,this._webgpuProcessingContext.orderedAttributes[i]=n;const a=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[n];if(void 0!==a){const e=a<0?-1===a?"i32":"vec"+-a+"<i32>":1===a?"u32":"vec"+a+"<u32>",t=`_int_${n}_`;this._attributesInputWGSL.push(`@location(${i}) ${t} : ${e},`),this._attributesWGSL.push(`${n} : ${s},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${n} = ${s}(vertexInputs_.${t});`),this._hasNonFloatAttribute=true;}else this._attributesInputWGSL.push(`@location(${i}) ${n} : ${s},`),this._attributesWGSL.push(`${n} : ${s},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${n} = vertexInputs_.${n};`);e="";}return e}uniformProcessor(e,t,r){const s=this.uniformRegexp.exec(e);if(null!==s){const t=s[2],n=s[1];this._addUniformToLeftOverUBO(n,t,r),e="";}return e}textureProcessor(e,t,r){const s=this.textureRegexp.exec(e);if(null!==s){const n=s[1],i=s[2],a=!!s[3],o=s[4],u=o.indexOf("storage")>0,c=s[6],h=u?c.substring(0,c.indexOf(",")).trim():null;let l=a?this._getArraySize(n,i,r)[2]:0,d=this._webgpuProcessingContext.availableTextures[n];if(d)l=d.textures.length;else {d={isTextureArray:l>0,isStorageTexture:u,textures:[],sampleType:"float"},l=l||1;for(let e=0;e<l;++e)d.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding());}this._webgpuProcessingContext.availableTextures[n]=d;const p=o.indexOf("depth")>0,_=$e[o],g=p?"depth":"u32"===c?"uint":"i32"===c?"sint":"float";if(d.sampleType=g,void 0===_)throw `Can't get the texture dimension corresponding to the texture function "${o}"!`;for(let r=0;r<l;++r){const{groupIndex:s,bindingIndex:i}=d.textures[r];0===r&&(e=`@group(${s}) @binding(${i}) ${e}`),this._addTextureBindingDescription(n,d,r,_,h,!t);}}return e}_convertDefinesToConst(e){let t="";for(const r in e){const s=e[r];r.startsWith("__")||(isNaN(parseInt(s))&&isNaN(parseFloat(s))?r&&""===s&&(t+=`const ${r} = true;\n`):t+=`const ${r} = ${s};\n`);}return t}postProcessor(e,t,r,s,n,i,a){const o=[];for(const e in a){"true"!==a[e]&&o.push(e);}o.sort(((e,t)=>e.length-t.length>0?-1:e.length===t.length?0:1));for(const t of o){const r=e.indexOf("#define "+t);let s=e.indexOf("\n",r);-1===s&&(s=e.length);const n=e.substring(r+8+t.length+1,s);e=e.replace(new RegExp(t,"g"),n);}return e=this._convertDefinesToConst(i)+e,"VERTEXOUTPUT_INVARIANT"in i&&(e="#define VERTEXOUTPUT_INVARIANT\n"+e),e}finalizeShaders(e,r){const s=[],n=r.indexOf("fragmentInputs.position")>=0&&!this.pureMode?"\n            if (internals.yFactor_ == 1.) {\n                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;\n            }\n        ":"";e=this._processSamplers(e,true),r=this._processSamplers(r,false),e=this._processCustomBuffers(e,true),r=this._processCustomBuffers(r,false);const i=this._buildLeftOverUBO();r=i+r,e=(e=i+e).replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let a="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this._attributesInputWGSL.length>0&&(a+=this._attributesInputWGSL.join("\n")),a+="\n};\nvar<private> vertexInputs"+(this._hasNonFloatAttribute?"_":"")+" : VertexInputs;\n",this._hasNonFloatAttribute&&(a+="struct VertexInputs_ {\n  vertexIndex : u32, instanceIndex : u32,\n",a+=this._attributesWGSL.join("\n"),a+="\n};\nvar<private> vertexInputs : VertexInputs_;\n");let o="struct FragmentInputs {\n  @builtin(position)"+(e.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0?" @invariant":"")+" position : vec4<f32>,\n";this._varyingsWGSL.length>0&&(o+=this._varyingsWGSL.join("\n")),o+="\n};\nvar<private> vertexOutputs : FragmentInputs;\n",e=a+o+e;let u=`\n  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;\n`;this._hasNonFloatAttribute&&(u+="vertexInputs.vertexIndex = vertexInputs_.vertexIndex;\nvertexInputs.instanceIndex = vertexInputs_.instanceIndex;\n",u+=this._attributesConversionCodeWGSL.join("\n"),u+="\n");const c=this.pureMode?"  return vertexOutputs;":"  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;\n  return vertexOutputs;";let h=-1!==e.indexOf(Qe$1.DISABLEUA);e=(h?"diagnostic(off, derivative_uniformity);\n":"")+"diagnostic(off, chromium.unreachable_code);\n"+Ne(e,"fn main",u,c),r=r.replace(/#define /g,"//#define "),r=this._processStridedUniformArrays(r),this.pureMode||(r=r.replace(/dpdy/g,"(-internals.yFactor_)*dpdy"));let l="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this._varyingsWGSL.length>0&&(l+=this._varyingsWGSL.join("\n")),l+="\n};\nvar<private> fragmentInputs : FragmentInputs;\n";let d="struct FragmentOutputs {\n";const p="fragmentOutputs\\.fragData";let _=r.match(new RegExp(p+"0","g")),g=0;if(_){d+=` @location(${g}) fragData0 : vec4<f32>,\n`,g++;for(let e=1;e<8;e++)_=r.match(new RegExp(p+e,"g")),_&&(d+=` @location(${g}) fragData${g} : vec4<f32>,\n`,g++);-1!==r.indexOf("MRT_AND_COLOR")&&(d+=`  @location(${g}) color : vec4<f32>,\n`,g++);}if(_=r.match(/oitDepthSampler/),_&&(d+=` @location(${g++}) depth : vec2<f32>,\n`,d+=` @location(${g++}) frontColor : vec4<f32>,\n`,d+=` @location(${g++}) backColor : vec4<f32>,\n`),0===g){ -1!==r.indexOf("DUAL_SOURCE_BLENDING")?(s.push("dual_source_blending"),d+="  @location(0) @blend_src(0) color : vec4<f32>,\n",d+="  @location(0) @blend_src(1) color2 : vec4<f32>,\n"):d+="  @location(0) color : vec4<f32>,\n",g++;}let f=false,m=0;for(;!(f||(m=r.indexOf(Ve,m),m<0));){const e=m;for(f=true;m>1&&"\n"!==r.charAt(m);){if("/"===r.charAt(m)&&"/"===r.charAt(m-1)){f=false;break}m--;}m=e+25;}f&&(d+="  @builtin(frag_depth) fragDepth: f32,\n"),d+="};\nvar<private> fragmentOutputs : FragmentOutputs;\n";const b="  fragmentInputs = input;\n  "+n;return h=-1!==(r=l+d+r).indexOf(Qe$1.DISABLEUA),s.length>0&&(r="enable "+s.join(";\nenable ")+";\n"+r),r=(h?"diagnostic(off, derivative_uniformity);\n":"")+"diagnostic(off, chromium.unreachable_code);\n"+Ne(r,"fn main",b,"  return fragmentOutputs;"),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:r}}_generateLeftOverUBOCode(e,t){let r="",s=`struct ${e} {\n`;for(const t of this._webgpuProcessingContext.leftOverUniforms){const n=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=Be.UniformSizes[n];if(t.length>0)if(i<=2){const i=`${e}_${this._stridedUniformArrays.length}_strided_arr`;r+=`struct ${i} {\n                        @size(16)\n                        el: ${n},\n                    }`,this._stridedUniformArrays.push(t.name),s+=` @align(16) ${t.name} : array<${i}, ${t.length}>,\n`;}else s+=` ${t.name} : array<${t.type}, ${t.length}>,\n`;else s+=`  ${t.name} : ${t.type},\n`;}return s+="};\n",s=`${r}\n${s}`,s+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> uniforms : ${e};\n`,s}_processSamplers(e,r){const s=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const n=s.exec(e);if(null===n)break;const i=n[1],a=n[2],o=i.length-Qe$1.AUTOSAMPLERSUFFIX.length,u=i.lastIndexOf(Qe$1.AUTOSAMPLERSUFFIX)===o?i.substring(0,o):null,c="sampler_comparison"===a?"comparison":"filtering";if(u){const e=this._webgpuProcessingContext.availableTextures[u];e&&(e.autoBindSampler=true);}let h=this._webgpuProcessingContext.availableSamplers[i];h||(h={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:c},this._webgpuProcessingContext.availableSamplers[i]=h),this._addSamplerBindingDescription(i,h,r);const l=e.substring(0,n.index),d=`@group(${h.binding.groupIndex}) @binding(${h.binding.bindingIndex}) `,p=e.substring(n.index);e=l+d+p,s.lastIndex+=d.length;}return e}_processCustomBuffers(e,t){const r=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const s=r.exec(e);if(null===s)break;const n=s[1],i=s[3];let a=s[4];const o=s[5];let u=this._webgpuProcessingContext.availableBuffers[a];if(!u){const e="uniform"===n?De.KnownUBOs[o]:null;let t;e?(a=o,t=e.binding,-1===t.groupIndex&&(t=this._webgpuProcessingContext.availableBuffers[a]?.binding,t||(t=this._webgpuProcessingContext.getNextFreeUBOBinding()))):t=this._webgpuProcessingContext.getNextFreeUBOBinding(),u={binding:t},this._webgpuProcessingContext.availableBuffers[a]=u;}this._addBufferBindingDescription(a,this._webgpuProcessingContext.availableBuffers[a],"read_write"===i?"storage":"storage"===n?"read-only-storage":"uniform",t);const c=u.binding.groupIndex,h=u.binding.bindingIndex,l=e.substring(0,s.index),d=`@group(${c}) @binding(${h}) `,p=e.substring(s.index);e=l+d+p,r.lastIndex+=d.length;}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}}class Xe{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e){return this._webgpuMSAATexture?.[e]??null}setMSAATexture(e,t){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),this._webgpuMSAATexture[t]=e;}releaseMSAATexture(e){if(this._webgpuMSAATexture)if(void 0!==e)this._engine._textureHelper.releaseTexture(this._webgpuMSAATexture[e]),delete this._webgpuMSAATexture[e];else {for(const e of this._webgpuMSAATexture)this._engine._textureHelper.releaseTexture(e);this._webgpuMSAATexture=null;}}constructor(e,t=null){this._engine=e,this._originalFormatIsRGB=false,this.format="rgba8unorm",this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=t,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null;}set(e){this._webgpuTexture=e;}setUsage(t,r,s,n,i,a,o,u){let c="2d",h=1;n?(c=s?"cube-array":"cube",h=6*(u||1)):i?(c="3d",h=1):s&&(c="2d-array",h=u);const l=W$1.GetDepthFormatOnly(this.format),d=W$1.HasDepthAndStencilAspects(this.format)?"depth-only":"all";this.createView({label:`TextureView${i?"3D":n?"Cube":"2D"}${s?"_Array"+h:""}_${a}x${o}_${r?"wmips":"womips"}_${this.format}_${c}`,format:l,dimension:c,mipLevelCount:r?V$8(Math.max(a,o))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:h,aspect:d});}createView(e,t=false){if(this.view=this._webgpuTexture.createView(e),t&&e){const t=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=t;}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null;}release(){this._webgpuTexture?.destroy(),this.releaseMSAATexture(),this._copyInvertYTempTexture?.destroy(),this.reset();}}const He="\n    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));\n    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));\n\n    var img: texture_2d<f32>;\n\n    #ifdef INVERTY\n        varying vTextureSize: vec2f;\n    #endif\n\n    @vertex\n    fn main(input : VertexInputs) -> FragmentInputs {\n        #ifdef INVERTY\n            vertexOutputs.vTextureSize = vec2f(textureDimensions(img, 0));\n        #endif\n        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);\n    }\n    ",Ye=He;var qe,Qe;!function(e){e[e.MipMap=0]="MipMap",e[e.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",e[e.Clear=2]="Clear",e[e.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst";}(qe||(qe={})),function(e){e[e.DontInvertY=0]="DontInvertY",e[e.InvertY=1]="InvertY";}(Qe||(Qe={}));const ze=[{vertex:"\n    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));\n    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));\n\n    varying vTex: vec2f;\n\n    @vertex\n    fn main(input : VertexInputs) -> FragmentInputs {\n        vertexOutputs.vTex = tex[input.vertexIndex];\n        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    var imgSampler: sampler;\n    var img: texture_2d<f32>;\n\n    varying vTex: vec2f;\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n        fragmentOutputs.color = textureSample(img, imgSampler, input.vTex);\n    }\n    "},{vertex:He,fragment:"\n    var img: texture_2d<f32>;\n\n    #ifdef INVERTY\n        varying vTextureSize: vec2f;\n    #endif\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n    #ifdef INVERTY\n        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(input.vTextureSize.y - input.position.y)), 0);\n    #else\n        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color = vec4f(color.rgb * color.a, color.a);\n    #endif\n        fragmentOutputs.color = color;\n    }\n    "},{vertex:"\n    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));\n\n    @vertex\n    fn main(input : VertexInputs) -> FragmentInputs {\n        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    uniform color: vec4f;\n\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n        fragmentOutputs.color = uniforms.color;\n    }\n    "},{vertex:Ye,fragment:"\n    var img: texture_2d<f32>;\n    uniform ofstX: f32;\n    uniform ofstY: f32;\n    uniform width: f32;\n    uniform height: f32;\n\n    #ifdef INVERTY\n        varying vTextureSize: vec2f;\n    #endif\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n        if (input.position.x < uniforms.ofstX || input.position.x >= uniforms.ofstX + uniforms.width) {\n            discard;\n        }\n        if (input.position.y < uniforms.ofstY || input.position.y >= uniforms.ofstY + uniforms.height) {\n            discard;\n        }\n    #ifdef INVERTY\n        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(uniforms.ofstY + uniforms.height - (input.position.y - uniforms.ofstY))), 0);\n    #else\n        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color = vec4f(color.rgb * color.a, color.a);\n    #endif\n        fragmentOutputs.color = color;\n    }\n    "}],Ke={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38,r16unorm:39,rg16unorm:40,rgba16unorm:41,r16snorm:42,rg16snorm:43,rgba16snorm:44};class je{constructor(e,t,r,s){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._bufferManager=r,-1!==s.indexOf("rg11b10ufloat-renderable")){const e=Object.keys(Ke);Ke.rg11b10ufloat=Ke[e[e.length-1]]+1;}this._mipmapSampler=t.createSampler({minFilter:"linear"}),this._videoSampler=t.createSampler({minFilter:"linear"}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,Y$1.Uniform|Y$1.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline("rgba8unorm"),this._getVideoPipeline("rgba8unorm");}_getPipeline(e,t=qe.MipMap,r){const s=t===qe.MipMap?1:t===qe.InvertYPremultiplyAlpha?((r.invertY?1:0)<<1)+((r.premultiplyAlpha?1:0)<<2):t===qe.Clear?8:t===qe.InvertYPremultiplyAlphaWithOfst?((r.invertY?1:0)<<4)+((r.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let n=this._pipelines[e][s];if(!n){let i="";t!==qe.InvertYPremultiplyAlpha&&t!==qe.InvertYPremultiplyAlphaWithOfst||(r.invertY&&(i+="#define INVERTY\n"),r.premultiplyAlpha&&(i+="#define PREMULTIPLYALPHA\n"));let c=this._compiledShaders[s];if(!c){let e=ze[t].vertex,r=ze[t].fragment;const n={defines:i.split("\n"),indexParameters:null,isFragment:false,shouldUseHighPrecisionShader:true,processor:this._engine._getShaderProcessor(1),supportsUniformBuffers:true,shadersRepository:"",includesShadersStore:{},version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._engine._getShaderProcessingContext(1,true),isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};lt$1(n),n.processor.pureMode=true,ct$1(e,n,(t=>{e=t;}),this._engine),n.isFragment=true,ct$1(r,n,(e=>{r=e;}),this._engine);const h=ut$1(e,r,n);n.processor.pureMode=false;const l=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVertexShader_${s}`,code:h.vertexCode}),d=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalFragmentShader_${s}`,code:h.fragmentCode});c=this._compiledShaders[s]=[l,d];}const h=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalPipeline_${e}_${s}`,layout:"auto",vertex:{module:c[0],entryPoint:"main"},fragment:{module:c[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});n=this._pipelines[e][s]=[h,h.getBindGroupLayout(0)];}return n}_getVideoPipeline(e,t=Qe.DontInvertY){const r=t===Qe.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let s=this._videoPipelines[e][r];if(!s){let t=this._videoCompiledShaders[r];if(!t){const e=this._device.createShaderModule({code:"\n    struct VertexOutput {\n        @builtin(position) Position : vec4<f32>,\n        @location(0) fragUV : vec2<f32>\n    }\n\n    @vertex\n    fn main(\n        @builtin(vertex_index) VertexIndex : u32\n    ) -> VertexOutput {\n        var pos = array<vec2<f32>, 4>(\n            vec2(-1.0,  1.0),\n            vec2( 1.0,  1.0),\n            vec2(-1.0, -1.0),\n            vec2( 1.0, -1.0)\n        );\n        var tex = array<vec2<f32>, 4>(\n            vec2(0.0, 0.0),\n            vec2(1.0, 0.0),\n            vec2(0.0, 1.0),\n            vec2(1.0, 1.0)\n        );\n\n        var output: VertexOutput;\n\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.fragUV = tex[VertexIndex];\n\n        return output;\n    }\n    ",label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_VertexShader`}),s=this._device.createShaderModule({code:0===r?"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\n    }\n    ":"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\n    }\n    ",label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_FragmentShader_${0===r?"DontInvertY":"InvertY"}`});t=this._videoCompiledShaders[r]=[e,s];}const n=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVideoPipeline_${e}_${0===r?"DontInvertY":"InvertY"}`,layout:"auto",vertex:{module:t[0],entryPoint:"main"},fragment:{module:t[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});s=this._videoPipelines[e][r]=[n,n.getBindGroupLayout(0)];}return s}setCommandEncoder(e){this._commandEncoderForCreation=e;}copyVideoToTexture(e,t,r,s=false,n){const i=void 0===n,[a,o]=this._getVideoPipeline(r,s?Qe.InvertY:Qe.DontInvertY);i&&(n=this._device.createCommandEncoder({})),n.pushDebugGroup?.(`copy video to texture - invertY=${s}`);const u=t._hardwareTexture,c={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${r}_${s?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:u.underlyingResource.createView({format:r,dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"}),loadOp:"load",storeOp:"store"}]},h=n.beginRenderPass(c),l={layout:o,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},d=this._device.createBindGroup(l);h.setPipeline(a),h.setBindGroup(0,d),h.draw(4,1,0,0),h.end(),n.popDebugGroup?.(),i&&(this._device.queue.submit([n.finish()]),n=null);}invertYPreMultiplyAlpha(e,t,r,s,n=false,i=false,a=0,o=0,u=1,c=0,h=0,l=0,d=0,p,_){const g=0!==l,f=void 0===p,[m,b]=this._getPipeline(s,g?qe.InvertYPremultiplyAlphaWithOfst:qe.InvertYPremultiplyAlpha,{invertY:n,premultiplyAlpha:i});let x;if(a=Math.max(a,0),f&&(p=this._device.createCommandEncoder({})),p.pushDebugGroup?.(`internal process texture - invertY=${n} premultiplyAlpha=${i}`),W$1.IsHardwareTexture(e)?(x=e.underlyingResource,n&&!i&&1===u&&0===a||(e=void 0)):(x=e,e=void 0),!x)return;g&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([c,h,l,d]),0,16);const T=e,y=T?._copyInvertYTempTexture??this.createTexture({width:t,height:r,layers:1},false,false,false,false,false,s,1,p,21,void 0,"TempTextureForCopyWithInvertY"),E=T?._copyInvertYRenderPassDescr??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${s}_${n?"InvertY":"DontInvertY"}_${i?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:y.createView({format:s,dimension:"2d",baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:"load",storeOp:"store"}]},R=p.beginRenderPass(E);let S=g?T?._copyInvertYBindGroupWithOfst:T?._copyInvertYBindGroup;if(!S){const e={layout:b,entries:[{binding:0,resource:x.createView({format:s,dimension:"2d",baseMipLevel:o,mipLevelCount:1,arrayLayerCount:u,baseArrayLayer:a})}]};g&&e.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),S=this._device.createBindGroup(e);}R.setPipeline(m),R.setBindGroup(0,S),R.draw(4,1,0,0),R.end(),p.copyTextureToTexture({texture:y},{texture:x,mipLevel:o,origin:{x:0,y:0,z:a}},{width:l||t,height:d||r,depthOrArrayLayers:1}),T?(T._copyInvertYTempTexture=y,T._copyInvertYRenderPassDescr=E,g?T._copyInvertYBindGroupWithOfst=S:T._copyInvertYBindGroup=S):this._deferredReleaseTextures.push([y,null]),p.popDebugGroup?.(),f&&(this._device.queue.submit([p.finish()]),p=null);}createTexture(e,t=false,r=false,s=false,n=false,i=false,a="rgba8unorm",o=1,u,c=-1,h=0,l){o=W$1.GetSample(o);const d=e.layers||1,p={width:e.width,height:e.height,depthOrArrayLayers:d},_=Ke[a]?16:0,g=W$1.IsCompressedFormat(a),f=t?W$1.ComputeNumMipmapLevels(e.width,e.height):1,m=c>=0?c:7;h|=t&&!g?1|_:0,g||i||(h|=2|_);const b=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${i?"3D":"2D"}_${l?l+"_":""}${p.width}x${p.height}x${p.depthOrArrayLayers}_${t?"wmips":"womips"}_${a}_samples${o}`,size:p,dimension:i?"3d":"2d",format:a,usage:m|h,sampleCount:o,mipLevelCount:f});return W$1.IsImageBitmap(e)&&(this.updateTexture(e,b,e.width,e.height,d,a,0,0,s,n,0,0),t&&r&&this.generateMipmaps(b,a,f,0,i,u)),b}createCubeTexture(e,t=false,r=false,s=false,n=false,i="rgba8unorm",a=1,o,u=-1,c=0,h){a=W$1.GetSample(a);const l=W$1.IsImageBitmapArray(e)?e[0].width:e.width,d=W$1.IsImageBitmapArray(e)?e[0].height:e.height,p=Ke[i]?16:0,_=W$1.IsCompressedFormat(i),g=t?W$1.ComputeNumMipmapLevels(l,d):1,f=u>=0?u:7;c|=t&&!_?1|p:0,_||(c|=2|p);const m=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${h?h+"_":""}${l}x${d}x6_${t?"wmips":"womips"}_${i}_samples${a}`,size:{width:l,height:d,depthOrArrayLayers:6},dimension:"2d",format:i,usage:f|c,sampleCount:a,mipLevelCount:g});return W$1.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,m,l,d,i,s,n,0,0),t&&r&&this.generateCubeMipmaps(m,i,g,o)),m}generateCubeMipmaps(e,t,r,s){const n=void 0===s;n&&(s=this._device.createCommandEncoder({})),s.pushDebugGroup?.(`create cube mipmaps - ${r} levels`);for(let n=0;n<6;++n)this.generateMipmaps(e,t,r,n,false,s);s.popDebugGroup?.(),n&&(this._device.queue.submit([s.finish()]),s=null);}generateMipmaps(e,t,r,s=0,n=false,i){const a=void 0===i,[o,u]=this._getPipeline(t);let c;if(s=Math.max(s,0),a&&(i=this._device.createCommandEncoder({})),i.pushDebugGroup?.(`create mipmaps for face #${s} - ${r} levels`),W$1.IsHardwareTexture(e)?(c=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(c=e,e=void 0),!c)return;const h=e;for(let e=1;e<r;++e){const r=h?._mipmapGenRenderPassDescr[s]?.[e-1]??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${t}_faceIndex${s}_level${e}`,colorAttachments:[{view:c.createView({format:t,dimension:n?"3d":"2d",baseMipLevel:e,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s}),loadOp:"load",storeOp:"store"}]};h&&(h._mipmapGenRenderPassDescr[s]=h._mipmapGenRenderPassDescr[s]||[],h._mipmapGenRenderPassDescr[s][e-1]=r);const a=i.beginRenderPass(r),l=h?._mipmapGenBindGroup[s]?.[e-1]??this._device.createBindGroup({layout:u,entries:[{binding:0,resource:c.createView({format:t,dimension:n?"3d":"2d",baseMipLevel:e-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s})},{binding:1,resource:this._mipmapSampler}]});h&&(h._mipmapGenBindGroup[s]=h._mipmapGenBindGroup[s]||[],h._mipmapGenBindGroup[s][e-1]=l),a.setPipeline(o),a.setBindGroup(0,l),a.draw(4,1,0,0),a.end();}i.popDebugGroup?.(),a&&(this._device.queue.submit([i.finish()]),i=null);}createGPUTextureForInternalTexture(e,r,s,n,i,a){e._hardwareTexture||(e._hardwareTexture=new Xe(this._engine)),void 0===r&&(r=e.width),void 0===s&&(s=e.height),void 0===n&&(n=e.depth);const o=e._hardwareTexture,u=0!==((i??0)&Qe$1.TEXTURE_CREATIONFLAG_STORAGE);o.format=W$1.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),o.textureUsages=5===e._source||6===e.source?21:12===e._source?20:-1,o.textureAdditionalUsages=u?8:0;const c=e.generateMipMaps,h=n||1;let l;if(l=null!==e._maxLodLevel?e._maxLodLevel:c?W$1.ComputeNumMipmapLevels(r,s):1,e.isCube){const t=this.createCubeTexture({width:r,height:s},e.generateMipMaps,e.generateMipMaps,e.invertY,false,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(t);const n=e.is3D?1:h,i=W$1.GetDepthFormatOnly(o.format),a=W$1.HasDepthAndStencilAspects(o.format)?"depth-only":"all",d=e.is2DArray?"cube-array":"cube";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+n:""}_${r}x${s}_${c?"wmips":"womips"}_${i}_${d}_${a}_${e.label??"noname"}`,format:i,dimension:d,mipLevelCount:l,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:a},u);}else {const t=this.createTexture({width:r,height:s,layers:h},e.generateMipMaps,e.generateMipMaps,e.invertY,false,e.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(t);const n=e.is3D?1:h,i=W$1.GetDepthFormatOnly(o.format),a=W$1.HasDepthAndStencilAspects(o.format)?"depth-only":"all",d=e.is2DArray?"2d-array":e.is3D?"3d":"2d";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+n:""}_${r}x${s}${e.is3D?"x"+h:""}_${c?"wmips":"womips"}_${i}_${d}_${a}_${e.label??"noname"}`,format:i,dimension:d,mipLevelCount:l,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:n,aspect:a},u);}return e.width=e.baseWidth=r,e.height=e.baseHeight=s,e.depth=e.baseDepth=n,a||this.createMSAATexture(e,e.samples),o}createMSAATexture(e,t,r=true,s=0){const n=e._hardwareTexture;if(r&&n?.releaseMSAATexture(),!n||(t??1)<=1)return;const i=e.width,a=e.height,o=this.createTexture({width:i,height:a,layers:1},false,false,false,false,false,n.format,t,this._commandEncoderForCreation,16,0,e.label?"MSAA_"+e.label:"MSAA");n.setMSAATexture(o,s);}updateCubeTextures(e,t,r,s,n,i=false,a=false,o=0,u=0){const c=[0,3,1,4,2,5];for(let h=0;h<c.length;++h){const l=e[c[h]];this.updateTexture(l,t,r,s,1,n,h,0,i,a,o,u);}}updateTexture(e,t,r,s,n,i,a=0,o=0,u=false,c=false,h=0,l=0,d){const p=W$1.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,_=W$1.GetBlockInformationFromFormat(i),g=W$1.IsInternalTexture(t)?t._hardwareTexture:t,f={texture:p,origin:{x:h,y:l,z:Math.max(a,0)},mipLevel:o,premultipliedAlpha:c},m={width:Math.ceil(r/_.width)*_.width,height:Math.ceil(s/_.height)*_.height,depthOrArrayLayers:n||1};if(void 0!==e.byteLength){const b=Math.ceil(r/_.width)*_.length;if(256*Math.ceil(b/256)===b){const t=this._device.createCommandEncoder({}),r=this._bufferManager.createRawBuffer(e.byteLength,Y$1.MapWrite|Y$1.CopySrc,true,"TempBufferForUpdateTexture"+(p?"_"+p.label:"")),n=r.getMappedRange();new Uint8Array(n).set(e),r.unmap(),t.copyBufferToTexture({buffer:r,offset:0,bytesPerRow:b,rowsPerImage:s},f,m),this._device.queue.submit([t.finish()]),this._bufferManager.releaseBuffer(r);}else this._device.queue.writeTexture(f,e,{offset:0,bytesPerRow:b,rowsPerImage:s},m);if(u||c){if(!W$1.IsInternalTexture(t))throw "updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!";{const e=0===h&&0===l&&r===t.width&&s===t.height;this.invertYPreMultiplyAlpha(g,t.width,t.height,i,u,c,a,o,n||1,h,l,e?0:r,e?0:s,void 0,d);}}}else this._device.queue.copyExternalImageToTexture({source:e,flipY:u},f,m);}readPixels(e,t,r,s,n,i,a=0,o=0,u=null,c=false){const h=W$1.GetBlockInformationFromFormat(i),l=Math.ceil(s/h.width)*h.length,d=256*Math.ceil(l/256),p=d*n,_=this._bufferManager.createRawBuffer(p,Y$1.MapRead|Y$1.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),g=this._device.createCommandEncoder({});return g.copyTextureToBuffer({texture:e,mipLevel:o,origin:{x:t,y:r,z:Math.max(a,0)}},{buffer:_,offset:0,bytesPerRow:d},{width:s,height:n,depthOrArrayLayers:1}),this._device.queue.submit([g.finish()]),this._bufferManager.readDataFromBuffer(_,p,s,n,l,d,W$1.GetTextureTypeFromFormat(i),0,u,true,c)}releaseTexture(e){if(W$1.IsInternalTexture(e)){const t=e._hardwareTexture,r=e._irradianceTexture;this._deferredReleaseTextures.push([t,r]);}else this._deferredReleaseTextures.push([e,null]);}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,r]=this._deferredReleaseTextures[e];t&&(W$1.IsHardwareTexture(t)?t.release():t.destroy()),r?.dispose();}this._deferredReleaseTextures.length=0;}}class Je extends Li{set buffer(e){this._buffer=e;}constructor(e,t=0){super(),this.engineId=-1,this.capacity=t,e&&(this._buffer=e);}get underlyingResource(){return this._buffer}}class Ze{static _IsGPUBuffer(e){return void 0===e.underlyingResource}static _FlagsToString(e,t=""){let r=t;for(let t=0;t<=9;++t)e&1<<t&&(r&&(r+="_"),r+=Y$1[1<<t]);return r}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t;}createRawBuffer(e,t,r=false,s){const n=void 0!==e.byteLength?e.byteLength+3&-4:e+3&-4,i={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+Ze._FlagsToString(t,s??"Buffer")+"_size"+n,mappedAtCreation:r,size:n,usage:t};return this._device.createBuffer(i)}createBuffer(e,t,r){const s=void 0!==e.byteLength,n=new Je,i="DataBufferUniqueId="+n.uniqueId;return n.buffer=this.createRawBuffer(e,t,void 0,r?i+"-"+r:i),n.references=1,n.capacity=s?e.byteLength:e,n.engineId=this._engine.uniqueId,s&&this.setSubData(n,0,e),n}setRawData(e,t,r,s,n){s+=r.byteOffset,this._device.queue.writeBuffer(e,t,r.buffer,s,n);}setSubData(e,t,r,s=0,n=0){const i=e.underlyingResource;n=n||r.byteLength-s;const a=3&t;s-=a,t-=a;const o=n;n=n+a+3&-4;if(r.buffer.byteLength-r.byteOffset<n){const e=new Uint8Array(n);e.set(new Uint8Array(r.buffer,r.byteOffset+s,o)),r=e,s=0;}this.setRawData(i,t,r,s,n);}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,r){r?e=Math.min(e,r.length):r=new Float32Array(e);const s=new Uint16Array(t);for(;e--;)r[e]=Fh(s[e]);return r}readDataFromBuffer(e,r,s,n,i,a,o=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,u=0,c=null,h=true,d=false){const p=o===Qe$1.TEXTURETYPE_FLOAT?2:o===Qe$1.TEXTURETYPE_HALF_FLOAT?1:0,_=this._engine.uniqueId;return new Promise(((t,s)=>{e.mapAsync(1,u,r).then((()=>{const s=e.getMappedRange(u,r);let _=c;if(d)_=null===_?et$1(o,r,true,s):et$1(o,_.buffer,void 0,s);else if(null===_)switch(p){case 0:_=new Uint8Array(r),_.set(new Uint8Array(s));break;case 1:_=this._getHalfFloatAsFloatRGBAArrayBuffer(r/2,s);break;case 2:_=new Float32Array(r/4),_.set(new Float32Array(s));}else switch(p){case 0:_=new Uint8Array(_.buffer),_.set(new Uint8Array(s,0,Math.min(_.byteLength,r)));break;case 1:_=this._getHalfFloatAsFloatRGBAArrayBuffer(r/2,s,c);break;case 2:_=new Float32Array(_.buffer),_.set(new Float32Array(s,0,_.byteLength/4));}if(i!==a){1!==p||d||(i*=2,a*=2);const e=new Uint8Array(_.buffer);let t=i,r=0;for(let s=1;s<n;++s){r=s*a;for(let s=0;s<i;++s)e[t++]=e[r++];}_=0===p||d?new Uint8Array(e.buffer,0,t):new Float32Array(e.buffer,0,t/4);}e.unmap(),h&&this.releaseBuffer(e),t(_);}),(e=>{this._engine.isDisposed||this._engine.uniqueId!==_?t(new Uint8Array):s(e);}));}))}releaseBuffer(e){return Ze._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),true):(e.references--,0===e.references&&(this._deferredReleaseBuffers.push(e.underlyingResource),true))}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0;}}const et=[0,0,3,7,0,2,6,2,4,1,5,3,1],tt=[0,64,32,96,16,80,48,112,8],rt=[0,128,128,0,0,0,0,128,0,0,0,0,128];class st{constructor(e){this._samplers={},this._device=e,this.disabled=false;}static GetSamplerHashCode(e){const t=e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;return et[e.samplingMode]+tt[(e._comparisonFunction||514)-512+1]+rt[e.samplingMode]+((e._cachedWrapU??1)<<8)+((e._cachedWrapV??1)<<10)+((e._cachedWrapR??1)<<12)+((e.useMipMaps?1:0)<<14)+(t<<15)}static _GetSamplerFilterDescriptor(e,r){let s,n,i,a,o;const u=e.useMipMaps;switch(e.samplingMode){case Qe$1.TEXTURE_LINEAR_LINEAR_MIPNEAREST:s="linear",n="linear",i="nearest",u||(a=o=0);break;case Qe$1.TEXTURE_LINEAR_LINEAR_MIPLINEAR:case Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE:s="linear",n="linear",u?i="linear":(i="nearest",a=o=0);break;case Qe$1.TEXTURE_NEAREST_NEAREST_MIPLINEAR:s="nearest",n="nearest",u?i="linear":(i="nearest",a=o=0);break;case Qe$1.TEXTURE_NEAREST_NEAREST_MIPNEAREST:s="nearest",n="nearest",i="nearest",u||(a=o=0);break;case Qe$1.TEXTURE_NEAREST_LINEAR_MIPNEAREST:s="nearest",n="linear",i="nearest",u||(a=o=0);break;case Qe$1.TEXTURE_NEAREST_LINEAR_MIPLINEAR:s="nearest",n="linear",u?i="linear":(i="nearest",a=o=0);break;case Qe$1.TEXTURE_NEAREST_LINEAR:s="nearest",n="linear",i="nearest",a=o=0;break;case Qe$1.TEXTURE_NEAREST_NEAREST:case Qe$1.TEXTURE_NEAREST_SAMPLINGMODE:s="nearest",n="nearest",i="nearest",a=o=0;break;case Qe$1.TEXTURE_LINEAR_NEAREST_MIPNEAREST:s="linear",n="nearest",i="nearest",u||(a=o=0);break;case Qe$1.TEXTURE_LINEAR_NEAREST_MIPLINEAR:s="linear",n="nearest",u?i="linear":(i="nearest",a=o=0);break;case Qe$1.TEXTURE_LINEAR_LINEAR:case Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE:s="linear",n="linear",r>1?i="linear":(i="nearest",a=o=0);break;case Qe$1.TEXTURE_LINEAR_NEAREST:s="linear",n="nearest",i="nearest",a=o=0;break;default:s="nearest",n="nearest",i="nearest",a=o=0;}return r>1&&(0!==a||0!==o)?{magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",anisotropyEnabled:true}:{magFilter:s,minFilter:n,mipmapFilter:i,lodMinClamp:a,lodMaxClamp:o}}static _GetWrappingMode(e){switch(e){case Qe$1.TEXTURE_WRAP_ADDRESSMODE:return "repeat";case Qe$1.TEXTURE_CLAMP_ADDRESSMODE:return "clamp-to-edge";case Qe$1.TEXTURE_MIRROR_ADDRESSMODE:return "mirror-repeat"}return "repeat"}static _GetSamplerWrappingDescriptor(e){return {addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,r){let s=(e.useMipMaps||e.samplingMode===Qe$1.TEXTURE_LINEAR_LINEAR)&&e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;e.samplingMode!==Qe$1.TEXTURE_LINEAR_LINEAR_MIPNEAREST&&e.samplingMode!==Qe$1.TEXTURE_LINEAR_LINEAR_MIPLINEAR&&e.samplingMode!==Qe$1.TEXTURE_LINEAR_LINEAR&&(s=1);const n=this._GetSamplerFilterDescriptor(e,s);return {label:r,...n,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?st.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:n.anisotropyEnabled?s:1}}static GetCompareFunction(e){switch(e){case Qe$1.ALWAYS:return "always";case Qe$1.EQUAL:return "equal";case Qe$1.GREATER:return "greater";case Qe$1.GEQUAL:return "greater-equal";case Qe$1.LESS:return "less";case Qe$1.LEQUAL:return "less-equal";case Qe$1.NEVER:return "never";case Qe$1.NOTEQUAL:return "not-equal";default:return "less"}}getSampler(e,t=false,r=0,s){if(this.disabled)return this._device.createSampler(st._GetSamplerDescriptor(e,s));t?r=0:0===r&&(r=st.GetSamplerHashCode(e));let n=t?void 0:this._samplers[r];return n||(n=this._device.createSampler(st._GetSamplerDescriptor(e,s)),t||(this._samplers[r]=n)),n}}const nt={[Hi.PositionKind]:true,[Hi.NormalKind]:true,[Hi.TangentKind]:true,[Hi.UVKind]:true,[Hi.UV2Kind]:true,[Hi.UV3Kind]:true,[Hi.UV4Kind]:true,[Hi.UV5Kind]:true,[Hi.UV6Kind]:true,[Hi.ColorKind]:true,[Hi.ColorInstanceKind]:true,[Hi.MatricesIndicesKind]:true,[Hi.MatricesWeightsKind]:true,[Hi.MatricesIndicesExtraKind]:true,[Hi.MatricesWeightsExtraKind]:true};function it(e){switch(e){case Hi.BYTE:case Hi.SHORT:case Hi.INT:case Hi.FLOAT:return  true;case Hi.UNSIGNED_BYTE:case Hi.UNSIGNED_SHORT:case Hi.UNSIGNED_INT:return  false;default:throw new Error(`Invalid type '${e}'`)}}var at;!function(e){e[e.StencilReadMask=0]="StencilReadMask",e[e.StencilWriteMask=1]="StencilWriteMask",e[e.DepthBias=2]="DepthBias",e[e.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",e[e.DepthStencilState=4]="DepthStencilState",e[e.MRTAttachments=5]="MRTAttachments",e[e.RasterizationState=6]="RasterizationState",e[e.ColorStates1=7]="ColorStates1",e[e.ColorStates2=8]="ColorStates2",e[e.ColorStates3=9]="ColorStates3",e[e.ColorStates4=10]="ColorStates4",e[e.ShaderStage=11]="ShaderStage",e[e.TextureStage=12]="TextureStage",e[e.VertexState=13]="VertexState",e[e.NumStates=14]="NumStates";}(at||(at={}));const ot={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:14,32772:15,35065:16,35066:17,34185:18,35067:19},ut={32774:0,32775:1,32776:2,32778:3,32779:4},ct={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},ht=[0,0,0,0];class lt{constructor(e,t){this.mrtTextureCount=0,this._device=e,this._useTextureStage=true,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=false,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset();}reset(){this._isDirty=true,this.vertexBuffers.length=0,this.setAlphaToCoverage(false),this.resetDepthCullingState(),this.setClampDepth(false),this.setDepthBias(0),this._webgpuColorFormat=["bgra8unorm"],this.setColorFormat("bgra8unorm"),this.setMRT([]),this.setAlphaBlendEnabled([false],1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat("depth24plus-stencil8"),this.setStencilEnabled(false),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0);}get colorFormats(){return this._mrtAttachments>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,r,s=0){if(r=W$1.GetSample(r),this.disabled){const n=lt._GetTopology(e);return this._setVertexState(t),this._setTextureState(s),this._parameter.pipeline=this._createRenderPipeline(t,n,r),lt.NumCacheMiss++,lt._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,r),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(s),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,lt.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=false,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return lt.NumCacheHitWithHash++,this._parameter.pipeline;const n=lt._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,n,r),this._setRenderPipeline(this._parameter),lt.NumCacheMiss++,lt._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){lt.NumPipelineCreationLastFrame=lt._NumPipelineCreationCurrentFrame,lt._NumPipelineCreationCurrentFrame=0;}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e;}setFrontFace(e){this._frontFace=e;}setCullEnabled(e){this._cullEnabled=e;}setCullFace(e){this._cullFace=e;}setClampDepth(e){this._clampDepth=e;}resetDepthCullingState(){this.setDepthCullingState(false,2,1,0,0,true,true,Qe$1.ALWAYS);}setDepthCullingState(e,r,s,n,i,a,o,u){this._depthWriteEnabled=o,this._depthTestEnabled=a,this._depthCompare=(u??Qe$1.ALWAYS)-512,this._cullFace=s,this._cullEnabled=e,this._frontFace=r,this.setDepthBiasSlopeScale(n),this.setDepthBias(i);}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[at.DepthBias]=e,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.DepthBias));}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[at.DepthBiasSlopeScale]=e,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.DepthBiasSlopeScale));}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=Ke[e??""];}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let r=0;r<e.length;++r)0!==e[r]&&(t+=1<<r);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.MRTAttachments));}setMRT(e,t){if((t=t??e.length)>8)throw new Error("Can't handle more than 8 attachments for a MRT in cache render pipeline!");this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;let r=0,s=0;for(let n=0;n<t;++n){const t=e[n],i=t?._hardwareTexture;this._mrtFormats[n]=i?.format??this._webgpuColorFormat[0],r+=Ke[this._mrtFormats[n]??""]*2**s,s+=6;}this._mrtFormats.length=t,this._mrtAttachments!==r&&(this._mrtAttachments=r,this._states[at.MRTAttachments]=r,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.MRTAttachments));}setAlphaBlendEnabled(e,t){this._alphaBlendEnabled=e,this._numAlphaBlendTargetsEnabled=t;}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t;}setWriteMask(e){this._writeMask=e;}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=void 0===e?0:Ke[e];}setDepthTestEnabled(e){this._depthTestEnabled=e;}setDepthWriteEnabled(e){this._depthWriteEnabled=e;}setDepthCompare(e){this._depthCompare=(e??Qe$1.ALWAYS)-512;}setStencilEnabled(e){this._stencilEnabled=e;}setStencilCompare(e){this._stencilFrontCompare=(e??Qe$1.ALWAYS)-512;}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=null===e?1:ct[e];}setStencilPassOp(e){this._stencilFrontPassOp=null===e?2:ct[e];}setStencilFailOp(e){this._stencilFrontFailOp=null===e?1:ct[e];}setStencilBackCompare(e){this._stencilBackCompare=(e??Qe$1.ALWAYS)-512;}setStencilBackDepthFailOp(e){this._stencilBackDepthFailOp=null===e?1:ct[e];}setStencilBackPassOp(e){this._stencilBackPassOp=null===e?2:ct[e];}setStencilBackFailOp(e){this._stencilBackFailOp=null===e?1:ct[e];}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[at.StencilReadMask]=e,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.StencilReadMask));}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[at.StencilWriteMask]=e,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.StencilWriteMask));}resetStencilState(){this.setStencilState(false,Qe$1.ALWAYS,Qe$1.KEEP,Qe$1.REPLACE,Qe$1.KEEP,255,255);}setStencilState(e,r,s,n,i,a,o,u=null,c=null,h=null,l=null){this._stencilEnabled=e,this._stencilFrontCompare=(r??Qe$1.ALWAYS)-512,this._stencilFrontDepthFailOp=null===s?1:ct[s],this._stencilFrontPassOp=null===n?2:ct[n],this._stencilFrontFailOp=null===i?1:ct[i],this._stencilBackCompare=(u??Qe$1.ALWAYS)-512,this._stencilBackDepthFailOp=null===c?1:ct[c],this._stencilBackPassOp=null===h?2:ct[h],this._stencilBackFailOp=null===l?1:ct[l],this.setStencilReadMask(a),this.setStencilWriteMask(o);}setBuffers(e,t,r){this._vertexBuffers=e,this._overrideVertexBuffers=r,this.indexBuffer=t;}static _GetTopology(e){switch(e){case Qe$1.MATERIAL_TriangleFillMode:return "triangle-list";case Qe$1.MATERIAL_PointFillMode:return "point-list";case Qe$1.MATERIAL_WireFrameFillMode:return "line-list";case Qe$1.MATERIAL_PointListDrawMode:return "point-list";case Qe$1.MATERIAL_LineListDrawMode:return "line-list";case Qe$1.MATERIAL_LineLoopDrawMode:throw "LineLoop is an unsupported fillmode in WebGPU";case Qe$1.MATERIAL_LineStripDrawMode:return "line-strip";case Qe$1.MATERIAL_TriangleStripDrawMode:return "triangle-strip";case Qe$1.MATERIAL_TriangleFanDrawMode:throw "TriangleFan is an unsupported fillmode in WebGPU";default:return "triangle-list"}}static _GetAphaBlendOperation(e){switch(e){case Qe$1.GL_ALPHA_EQUATION_ADD:return "add";case Qe$1.GL_ALPHA_EQUATION_SUBTRACT:return "subtract";case Qe$1.GL_ALPHA_EQUATION_REVERSE_SUBTRACT:return "reverse-subtract";case Qe$1.GL_ALPHA_EQUATION_MIN:return "min";case Qe$1.GL_ALPHA_EQUATION_MAX:return "max";default:return "add"}}static _GetAphaBlendFactor(e){switch(e){case 0:return "zero";case 1:return "one";case Qe$1.GL_ALPHA_FUNCTION_SRC:return "src";case Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR:return "one-minus-src";case Qe$1.GL_ALPHA_FUNCTION_SRC_ALPHA:return "src-alpha";case Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA:return "one-minus-src-alpha";case Qe$1.GL_ALPHA_FUNCTION_DST_ALPHA:return "dst-alpha";case Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA:return "one-minus-dst-alpha";case Qe$1.GL_ALPHA_FUNCTION_DST_COLOR:return "dst";case Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR:return "one-minus-dst";case Qe$1.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED:return "src-alpha-saturated";case Qe$1.GL_ALPHA_FUNCTION_CONSTANT_COLOR:case Qe$1.GL_ALPHA_FUNCTION_CONSTANT_ALPHA:return "constant";case Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR:case Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA:return "one-minus-constant";case Qe$1.GL_ALPHA_FUNCTION_SRC1_COLOR:return "src1";case Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_COLOR:return "one-minus-src1";case Qe$1.GL_ALPHA_FUNCTION_SRC1_ALPHA:return "src1-alpha";case Qe$1.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_ALPHA:return "one-minus-src1-alpha";default:return "one"}}static _GetCompareFunction(e){switch(e){case 0:return "never";case 1:return "less";case 2:return "equal";case 3:return "less-equal";case 4:return "greater";case 5:return "not-equal";case 6:return "greater-equal";case 7:return "always"}return "never"}static _GetStencilOpFunction(e){switch(e){case 0:return "zero";case 1:return "keep";case 2:return "replace";case 3:return "increment-clamp";case 4:return "decrement-clamp";case 5:return "invert";case 6:return "increment-wrap";case 7:return "decrement-wrap"}return "keep"}static _GetVertexInputDescriptorFormat(e){const t=e.type,r=e.normalized,s=e.getSize();switch(t){case Hi.BYTE:switch(s){case 1:case 2:return r?"snorm8x2":"sint8x2";case 3:case 4:return r?"snorm8x4":"sint8x4"}break;case Hi.UNSIGNED_BYTE:switch(s){case 1:case 2:return r?"unorm8x2":"uint8x2";case 3:case 4:return r?"unorm8x4":"uint8x4"}break;case Hi.SHORT:switch(s){case 1:case 2:return r?"snorm16x2":"sint16x2";case 3:case 4:return r?"snorm16x4":"sint16x4"}break;case Hi.UNSIGNED_SHORT:switch(s){case 1:case 2:return r?"unorm16x2":"uint16x2";case 3:case 4:return r?"unorm16x4":"uint16x4"}break;case Hi.INT:switch(s){case 1:return "sint32";case 2:return "sint32x2";case 3:return "sint32x3";case 4:return "sint32x4"}break;case Hi.UNSIGNED_INT:switch(s){case 1:return "uint32";case 2:return "uint32x2";case 3:return "uint32x3";case 4:return "uint32x4"}break;case Hi.FLOAT:switch(s){case 1:return "float32";case 2:return "float32x2";case 3:return "float32x3";case 4:return "float32x4"}}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${r}, size=${s}`)}_getAphaBlendState(e){return this._alphaBlendEnabled[e]?{srcFactor:lt._GetAphaBlendFactor(this._alphaBlendFuncParams[4*e+2]),dstFactor:lt._GetAphaBlendFactor(this._alphaBlendFuncParams[4*e+3]),operation:lt._GetAphaBlendOperation(this._alphaBlendEqParams[2*e+1])}:null}_getColorBlendState(e){return this._alphaBlendEnabled?{srcFactor:lt._GetAphaBlendFactor(this._alphaBlendFuncParams[4*e+0]),dstFactor:lt._GetAphaBlendFactor(this._alphaBlendFuncParams[4*e+1]),operation:lt._GetAphaBlendOperation(this._alphaBlendEqParams[2*e+0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[at.ShaderStage]=e,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.ShaderStage));}_setRasterizationState(e,t){const r=this._frontFace-1+((this._cullEnabled?this._cullFace:0)<<1)+((this._clampDepth?1:0)<<3)+((this._alphaToCoverageEnabled?1:0)<<4)+(e<<5)+(t<<8);this._rasterizationState!==r&&(this._rasterizationState=r,this._states[at.RasterizationState]=this._rasterizationState,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.RasterizationState));}_setColorStates(){ht[0]=(this._writeMask?1:0)*2**53,ht[1]=(this._depthWriteEnabled?1:0)*2**53,ht[2]=(7&this._colorFormat)*2**50,ht[3]=(56&this._colorFormat)*2**47;let e=0,t=false;for(let r=0;r<8;r++){if(this._alphaBlendEnabled[r]){const t=4*r+0,s=4*r+1,n=4*r+2,i=4*r+3,a=2*r+0,o=2*r+1,u=null===this._alphaBlendEqParams[a]?0:ut[this._alphaBlendEqParams[a]],c=null===this._alphaBlendEqParams[o]?0:ut[this._alphaBlendEqParams[o]];ht[e]+=((null===this._alphaBlendFuncParams[t]?1:ot[this._alphaBlendFuncParams[t]])|0)+((null===this._alphaBlendFuncParams[s]?1:ot[this._alphaBlendFuncParams[s]])<<5)+((null===this._alphaBlendFuncParams[n]?1:ot[this._alphaBlendFuncParams[n]])<<10)+((null===this._alphaBlendFuncParams[i]?1:ot[this._alphaBlendFuncParams[i]])<<15)+(u+5*c)*(1<<20);}1&r&&(t=t||this._states[at.ColorStates1+e]!==ht[e],this._states[at.ColorStates1+e]=ht[e],e++);}t&&(this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.ColorStates1));}_setDepthStencilState(){const e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9)+(this._stencilBackCompare<<12)+(this._stencilBackDepthFailOp<<15)+(this._stencilBackPassOp<<18)+(this._stencilBackFailOp<<21):2421327,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+1024*e;this._depthStencilState!==t&&(this._depthStencilState=t,this._states[at.DepthStencilState]=this._depthStencilState,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.DepthStencilState));}_setVertexState(e){const t=this._statesLength;let r=at.VertexState;const s=e._pipelineContext,i=s.shaderProcessingContext.attributeNamesFromEffect,a=s.shaderProcessingContext.attributeLocationsFromEffect;let o,u=0;for(let e=0;e<i.length;e++){const t=a[e];let s=(this._overrideVertexBuffers&&this._overrideVertexBuffers[i[e]])??this._vertexBuffers[i[e]];s||(s=this._emptyVertexBuffer,lt.LogErrorIfNoVertexBuffer&&Ie$2.Error(`No vertex buffer is provided for the "${i[e]}" attribute. A default empty vertex buffer will be used, but this may generate errors in some browsers.`));const c=s.effectiveBuffer?.underlyingResource;if(void 0===s._validOffsetRange){const e=s.effectiveByteOffset,t=s.getSize(true),r=s.effectiveByteStride;s._validOffsetRange=e+t<=this._kMaxVertexBufferStride&&0===r||0!==r&&e+t<=r;}o&&o===c&&s._validOffsetRange||(this.vertexBuffers[u++]=s,o=s._validOffsetRange?c:null);const h=s.hashCode+(t<<7);this._isDirty=this._isDirty||this._states[r]!==h,this._states[r++]=h;}this.vertexBuffers.length=u,this._statesLength=r,this._isDirty=this._isDirty||r!==t,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.VertexState));}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[at.TextureStage]=this._textureState,this._isDirty=true,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,at.TextureStage));}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);const t=[],r=e.shaderProcessingContext.bindGroupLayoutEntries;for(let e=0;e<r.length;e++){const s=r[e];t[e]=this._device.createBindGroupLayout({entries:s});}return e.bindGroupLayouts[0]=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){const r=e.shaderProcessingContext,s=r.bindGroupLayoutEntries;let n=1;for(let e=0;e<s.length;e++){const i=s[e];for(let a=0;a<i.length;a++){const i=s[e][a];if(i.texture){const a=r.bindGroupLayoutEntryInfo[e][i.binding].name,o=r.availableTextures[a],u=o.autoBindSampler?r.availableSamplers[a+Qe$1.AUTOSAMPLERSUFFIX]:null;let c=o.sampleType,h=u?.type??"filtering";if(this._textureState&n&&"depth"!==c&&(o.autoBindSampler&&(h="non-filtering"),c="unfilterable-float"),i.texture.sampleType=c,u){const e=r.bindGroupLayoutEntryInfo[u.binding.groupIndex][u.binding.bindingIndex].index;s[u.binding.groupIndex][e].sampler.type=h;}n<<=1;}}}const i=[];for(let e=0;e<s.length;++e)i[e]=this._device.createBindGroupLayout({entries:s[e]});return e.bindGroupLayouts[this._textureState]=i,this._device.createPipelineLayout({bindGroupLayouts:i})}_getVertexInputDescriptor(e){const t=[],r=e._pipelineContext,s=r.shaderProcessingContext.attributeNamesFromEffect,n=r.shaderProcessingContext.attributeLocationsFromEffect;let i,a;for(let e=0;e<s.length;e++){const r=n[e];let o=(this._overrideVertexBuffers&&this._overrideVertexBuffers[s[e]])??this._vertexBuffers[s[e]];o||(o=this._emptyVertexBuffer);let u=o.effectiveBuffer?.underlyingResource,c=o.effectiveByteOffset;const h=!o._validOffsetRange;if(!i||!a||i!==u||h){const e={arrayStride:o.effectiveByteStride,stepMode:o.getIsInstanced()?"instance":"vertex",attributes:[]};t.push(e),a=e.attributes,h&&(c=0,u=null);}a.push({shaderLocation:r,offset:c,format:lt._GetVertexInputDescriptorFormat(o)}),i=u;}return t}_createRenderPipeline(e,t,r){const s=e._pipelineContext,n=this._getVertexInputDescriptor(e),i=this._createPipelineLayout(s),a=[];if(this._vertexBuffers&&function(e,t){const r=t.getEngine(),s=t._pipelineContext;if(!s?.vertexBufferKindToType)return;let n=null;for(const i in e){const a=e[i];if(!a||!nt[i])continue;const o=a.normalized?Hi.FLOAT:a.type,u=s.vertexBufferKindToType[i];(o!==Hi.FLOAT&&void 0===u||void 0!==u&&u!==o)&&(n||(n=r._getShaderProcessingContext(t.shaderLanguage,false)),s.vertexBufferKindToType[i]=o,o!==Hi.FLOAT&&(n.vertexBufferKindToNumberOfComponents[i]=Hi.DeduceStride(i),it(o)&&(n.vertexBufferKindToNumberOfComponents[i]*=-1)));}if(n){const e=r._caps.parallelShaderCompile;r._caps.parallelShaderCompile=void 0,t._processShaderCodeAsync(null,r._features._checkNonFloatVertexBuffersDontRecreatePipelineContext,n),r._caps.parallelShaderCompile=e;}}(this._vertexBuffers,e),this._mrtAttachments>0)for(let e=0;e<this._mrtFormats.length;++e){const t=this._mrtFormats[e];if(t){const r={format:t,writeMask:this._mrtEnabledMask&1<<e?this._writeMask:0},s=this._getAphaBlendState(e<this._numAlphaBlendTargetsEnabled?e:0),n=this._getColorBlendState(e<this._numAlphaBlendTargetsEnabled?e:0);s&&n&&(r.blend={alpha:s,color:n}),a.push(r);}else a.push(null);}else if(this._webgpuColorFormat[0]){const e={format:this._webgpuColorFormat[0],writeMask:this._writeMask},t=this._getAphaBlendState(0),r=this._getColorBlendState(0);t&&r&&(e.blend={alpha:t,color:r}),a.push(e);}else a.push(null);const o={compare:lt._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)},u={compare:lt._GetCompareFunction(this._stencilEnabled?this._stencilBackCompare:7),depthFailOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilBackDepthFailOp:1),failOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilBackFailOp:1),passOp:lt._GetStencilOpFunction(this._stencilEnabled?this._stencilBackPassOp:1)},c="triangle-list"===t||"triangle-strip"===t;let h;"line-strip"!==t&&"triangle-strip"!==t||(h=!this.indexBuffer||this.indexBuffer.is32Bits?"uint32":"uint16");const l=!!this._webgpuDepthStencilFormat&&W$1.HasStencilAspect(this._webgpuDepthStencilFormat);return this._device.createRenderPipeline({label:`RenderPipeline_${a[0]?.format??"nooutput"}_${this._webgpuDepthStencilFormat??"nodepth"}_samples${r}_textureState${this._textureState}`,layout:i,vertex:{module:s.stages.vertexStage.module,entryPoint:s.stages.vertexStage.entryPoint,buffers:n},primitive:{topology:t,stripIndexFormat:h,frontFace:1===this._frontFace?"ccw":"cw",cullMode:this._cullEnabled?2===this._cullFace?"front":"back":"none"},fragment:s.stages.fragmentStage?{module:s.stages.fragmentStage.module,entryPoint:s.stages.fragmentStage.entryPoint,targets:a}:void 0,multisample:{count:r},depthStencil:void 0===this._webgpuDepthStencilFormat?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?lt._GetCompareFunction(this._depthCompare):"always",format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&l?o:void 0,stencilBack:this._stencilEnabled&&l?u:void 0,stencilReadMask:this._stencilEnabled&&l?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&l?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:c?this._depthBiasClamp:0,depthBiasSlopeScale:c?this._depthBiasSlopeScale:0}})}}lt.LogErrorIfNoVertexBuffer=false,lt.NumCacheHitWithoutHash=0,lt.NumCacheHitWithHash=0,lt.NumCacheMiss=0,lt.NumPipelineCreationLastFrame=0,lt._NumPipelineCreationCurrentFrame=0;class dt{constructor(){this.values={};}count(){let e=0,t=this.pipeline?1:0;for(const r in this.values){const s=this.values[r],[n,i]=s.count();e+=n,t+=i,e++;}return [e,t]}}class pt extends lt{static GetNodeCounts(){const e=pt._Cache.count();return {nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,r,s){if(e.pipeline){const e=r.slice();e.length=s,t.push(e);}for(const n in e.values){const i=e.values[n];r[s]=parseInt(n),pt._GetPipelines(i,t,r,s+1);}}static GetPipelines(){const e=[];return pt._GetPipelines(pt._Cache,e,[],0),e}static ResetCache(){pt._Cache=new dt;}reset(){this._nodeStack=[],this._nodeStack[0]=pt._Cache,super.reset();}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let e=this._stateDirtyLowestIndex;e<this._statesLength;++e){let r=t.values[this._states[e]];r||(r=new dt,t.values[this._states[e]]=r),t=r,this._nodeStack[e+1]=t;}e.token=t,e.pipeline=t.pipeline;}_setRenderPipeline(e){e.token.pipeline=e.pipeline;}}pt._Cache=new dt;class _t extends Ut$1{constructor(e){super(false),this._cache=e,this.reset();}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e));}get backFunc(){return this._backFunc}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._cache.setStencilBackCompare(e));}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e));}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e));}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e));}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e));}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._cache.setStencilBackFailOp(e));}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._cache.setStencilBackDepthFailOp(e));}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._cache.setStencilBackPassOp(e));}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e));}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e));}reset(){super.reset(),this._cache.resetStencilState();}apply(){const e=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backFunc=e?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.backOpStencilFail=e?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=e?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=e?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass);}}class gt extends Bt$1{constructor(e){super(false),this._cache=e,this.reset();}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=true,this._cache.setDepthBiasSlopeScale(e));}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=true,this._cache.setDepthBias(e));}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=true,this._cache.setCullFace(e??1));}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=true,this._cache.setCullEnabled(!!e));}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=true,this._cache.setDepthCompare(e));}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=true,this._cache.setDepthWriteEnabled(e));}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=true,this._cache.setDepthTestEnabled(e));}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=true,this._cache.setFrontFace(e??2));}reset(){super.reset(),this._cache.resetDepthCullingState();}apply(){}}class ft{static IsExternalTexture(e){return void 0!==e.underlyingResource}getClassName(){return "ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=false,this.type=Qe$1.TEXTURETYPE_UNDEFINED,this.format=Qe$1.TEXTUREFORMAT_UNDEFINED,this._video=e,this.uniqueId=zt._Counter++;}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}class mt{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.useVertexPulling=false,this.uniqueId=mt._Counter++,this.updateId=0,this.textureState=0,this.reset();}reset(){this.samplers={},this.textures={},this.isDirty=true,this._numFloatOrDepthTextures=0,this._numExternalTextures=0;}setSampler(e,t){let r=this.samplers[e],s=-1;r?s=r.hashCode:this.samplers[e]=r={sampler:t,hashCode:0},r.sampler=t,r.hashCode=t?st.GetSamplerHashCode(t):0;const n=s!==r.hashCode;n&&this.updateId++,this.isDirty||=n;}setTexture(e,r){let s=this.textures[e],n=-1;s?n=s.texture?.uniqueId??-1:this.textures[e]=s={texture:r,isFloatOrDepthTexture:false,isExternalTexture:false},s.isExternalTexture&&this._numExternalTextures--,s.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,r?(s.isFloatOrDepthTexture=r.type===Qe$1.TEXTURETYPE_FLOAT||r.format>=Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8&&r.format<=Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8,s.isExternalTexture=ft.IsExternalTexture(r),s.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,s.isExternalTexture&&this._numExternalTextures++):(s.isFloatOrDepthTexture=false,s.isExternalTexture=false),s.texture=r;const i=n!==(r?.uniqueId??-1);i&&this.updateId++,this.isDirty||=i;}}mt._Counter=0;class bt{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=false,this._materialContextUpdateId=e;}get enableIndirectDraw(){return this._enableIndirectDraw}set enableIndirectDraw(e){this._enableIndirectDrawInCompatMode=true,this._enableIndirectDraw!==e&&(this._enableIndirectDraw=e,e||this._useInstancing||!this.indirectDrawBuffer?e&&!this.indirectDrawBuffer&&(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,Y$1.CopyDst|Y$1.Indirect|Y$1.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0));}get useInstancing(){return this._useInstancing}set useInstancing(e){if(this._useInstancing===e)return;this._useInstancing=e,this._currentInstanceCount=-1;const t=this._enableIndirectDrawInCompatMode;this.enableIndirectDraw=e,this._enableIndirectDrawInCompatMode=t;}constructor(e,t){this._dummyIndexBuffer=t,this._enableIndirectDrawInCompatMode=false,this._bufferManager=e,this.uniqueId=bt._Counter++,this._useInstancing=false,this._currentInstanceCount=0,this._enableIndirectDraw=false,this._vertexPullingEnabled=false,this.reset();}reset(){this.buffers={},this._isDirty=true,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0,this._vertexPullingEnabled=false;}setBuffer(e,t){this._isDirty||=t?.uniqueId!==this.buffers[e]?.uniqueId,this.buffers[e]=t;}setIndirectData(e,t,r,s=false){(s||t!==this._currentInstanceCount)&&this.indirectDrawBuffer&&this._indirectDrawData&&(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=r,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20));}setVertexPulling(e,t,r,s,n){if(this._vertexPullingEnabled===e)return;this._vertexPullingEnabled=e,this._isDirty=true;const i=t.shaderProcessingContext.bufferNames;if(n)for(const t in n){const r=n[t];if(!r||-1===i.indexOf(t))continue;const s=r.effectiveBuffer;this.setBuffer(t,e?s:null);}for(const t in r){if(n&&t in n)continue;const s=r[t];if(!s||-1===i.indexOf(t))continue;const a=s.effectiveBuffer;this.setBuffer(t,e?a:null);} -1!==i.indexOf("indices")&&this.setBuffer("indices",e?s??this._dummyIndexBuffer:null);}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0,this._enableIndirectDraw=false;}}bt._Counter=0;const xt=2**35;class Tt{constructor(){this.values={};}}class yt{static get Statistics(){return {totalCreated:yt.NumBindGroupsCreatedTotal,lastFrameCreated:yt.NumBindGroupsCreatedLastFrame,lookupLastFrame:yt.NumBindGroupsLookupLastFrame,noLookupLastFrame:yt.NumBindGroupsNoLookupLastFrame}}static ResetCache(){yt._Cache=new Tt,yt.NumBindGroupsCreatedTotal=0,yt.NumBindGroupsCreatedLastFrame=0,yt.NumBindGroupsLookupLastFrame=0,yt.NumBindGroupsNoLookupLastFrame=0,yt._NumBindGroupsCreatedCurrentFrame=0,yt._NumBindGroupsLookupCurrentFrame=0,yt._NumBindGroupsNoLookupCurrentFrame=0;}constructor(e,t,r){this.disabled=false,this._device=e,this._cacheSampler=t,this._engine=r;}endFrame(){yt.NumBindGroupsCreatedLastFrame=yt._NumBindGroupsCreatedCurrentFrame,yt.NumBindGroupsLookupLastFrame=yt._NumBindGroupsLookupCurrentFrame,yt.NumBindGroupsNoLookupLastFrame=yt._NumBindGroupsNoLookupCurrentFrame,yt._NumBindGroupsCreatedCurrentFrame=0,yt._NumBindGroupsLookupCurrentFrame=0,yt._NumBindGroupsNoLookupCurrentFrame=0;}getBindGroups(e,t,r){let s,i=yt._Cache;const a=this.disabled||r.forceBindGroupCreation;if(!a){if(!t.isDirty(r.updateId)&&!r.isDirty)return yt._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const r of e.shaderProcessingContext.bufferNames){const e=(t.buffers[r]?.uniqueId??0)+1048576;let s=i.values[e];s||(s=new Tt,i.values[e]=s),i=s;}for(const t of e.shaderProcessingContext.samplerNames){const e=r.samplers[t]?.hashCode??0;let s=i.values[e];s||(s=new Tt,i.values[e]=s),i=s;}for(const t of e.shaderProcessingContext.textureNames){const e=(r.textures[t]?.texture?.uniqueId??0)+xt;let s=i.values[e];s||(s=new Tt,i.values[e]=s),i=s;}s=i.bindGroups;}if(t.resetIsDirty(r.updateId),r.isDirty=false,s)return t.bindGroups=s,yt._NumBindGroupsLookupCurrentFrame++,s;s=[],t.bindGroups=s,a||(i.bindGroups=s),yt.NumBindGroupsCreatedTotal++,yt._NumBindGroupsCreatedCurrentFrame++;const o=e.bindGroupLayouts[r.textureState];for(let i=0;i<e.shaderProcessingContext.bindGroupLayoutEntries.length;i++){const a=e.shaderProcessingContext.bindGroupLayoutEntries[i],u=e.shaderProcessingContext.bindGroupEntries[i];for(let s=0;s<a.length;s++){const a=e.shaderProcessingContext.bindGroupLayoutEntries[i][s],o=e.shaderProcessingContext.bindGroupLayoutEntryInfo[i][a.binding],c=o.nameInArrayOfTexture??o.name;if(a.sampler){const e=r.samplers[c];if(e){const t=e.sampler;if(!t){this._engine.dbgSanityChecks&&Ie$2.Error(`Trying to bind a null sampler! entry=${JSON.stringify(a)}, name=${c}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${r.uniqueId}`,50);continue}u[s].resource=this._cacheSampler.getSampler(t,false,e.hashCode,t.label);}else Ie$2.Error(`Sampler "${c}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(a)}, materialContext=${JSON.stringify(r,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50);}else if(a.texture||a.storageTexture){const e=r.textures[c];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){Ie$2.Error(`Trying to bind a null texture! name="${c}", entry=${JSON.stringify(a)}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${r.uniqueId}`,50);continue}const t=e.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!t||a.texture&&!t.view||a.storageTexture&&!t.viewForWriting)){Ie$2.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(a)}, name=${c}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, isReady=${e.texture?.isReady}, materialContext.uniqueId=${r.uniqueId}`,50);continue}u[s].resource=a.storageTexture?t.viewForWriting:t.view;}else Ie$2.Error(`Texture "${c}" not found in the material context. Make sure you bound it (something like effect.setTexture("${c}", texture)). entry=${JSON.stringify(a)}, materialContext=${JSON.stringify(r,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50);}else if(a.externalTexture){const e=r.textures[c];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){Ie$2.Error(`Trying to bind a null external texture! entry=${JSON.stringify(a)}, name=${c}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${r.uniqueId}`,50);continue}const t=e.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!t){Ie$2.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(a)}, name=${c}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, isReady=${e.texture?.isReady}, materialContext.uniqueId=${r.uniqueId}`,50);continue}u[s].resource=this._device.importExternalTexture({source:t});}else Ie$2.Error(`External texture "${c}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(a)}, materialContext=${JSON.stringify(r,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50);}else if(a.buffer){const e=t.buffers[c];if(e){const t=e.underlyingResource;u[s].resource.buffer=t,u[s].resource.size=e.capacity;}else Ie$2.Error(`Can't find buffer "${c}" in the draw context. Make sure you bound it. entry=${JSON.stringify(a)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50);}}const c=o[i];s[i]=this._device.createBindGroup({layout:c,entries:u});}return s}}yt.NumBindGroupsCreatedTotal=0,yt.NumBindGroupsCreatedLastFrame=0,yt.NumBindGroupsLookupLastFrame=0,yt.NumBindGroupsNoLookupLastFrame=0,yt._Cache=new Tt,yt._NumBindGroupsCreatedCurrentFrame=0,yt._NumBindGroupsLookupCurrentFrame=0,yt._NumBindGroupsNoLookupCurrentFrame=0;const Et="clearQuadVertexShader";bt$1.ShadersStoreWGSL[Et]||(bt$1.ShadersStoreWGSL[Et]="uniform depthValue: f32;const pos=array(\nvec2f(-1.0,1.0),\nvec2f(1.0,1.0),\nvec2f(-1.0,-1.0),\nvec2f(1.0,-1.0)\n);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.position=vec4f(pos[input.vertexIndex],uniforms.depthValue,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n");const Rt="clearQuadPixelShader";bt$1.ShadersStoreWGSL[Rt]||(bt$1.ShadersStoreWGSL[Rt]="uniform color: vec4f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=uniforms.color;}\n");class St{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e);}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e);}setMRTAttachments(e,t,r){this._cacheRenderPipeline.setMRT(t,r),this._cacheRenderPipeline.setMRTAttachments(e);}constructor(e,t,r){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new pt(this._device,r),this._cacheRenderPipeline.setDepthTestEnabled(false),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,1);}clear(e,r,s,n,i=1){let a,o,u=null;const c=!!this._engine._currentRenderTarget;if(e)a=e;else {let e=0;this._keyTemp.length=0;for(let t=0;t<this._cacheRenderPipeline.colorFormats.length;++t)this._keyTemp[e++]=Ke[this._cacheRenderPipeline.colorFormats[t]??""];const t=Ke[this._depthTextureFormat??0];if(this._keyTemp[e]=(r?r.r+256*r.g+256*r.b*256+256*r.a*256*256:0)+(s?2**32:0)+(n?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(c?2**35:0)+(i>1?2**36:0)+t*2**37,o=this._keyTemp.join("_"),u=this._bundleCache[o],u)return u;a=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:W$1.GetSample(i)});}this._cacheRenderPipeline.setDepthWriteEnabled(!!s),this._cacheRenderPipeline.setStencilEnabled(!!n&&!!this._depthTextureFormat&&W$1.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(n?255:0),this._cacheRenderPipeline.setStencilCompare(n?Qe$1.ALWAYS:Qe$1.NEVER),this._cacheRenderPipeline.setStencilPassOp(n?Qe$1.REPLACE:Qe$1.KEEP),this._cacheRenderPipeline.setWriteMask(r?15:0);const h=this._cacheRenderPipeline.getRenderPipeline(Qe$1.MATERIAL_TriangleStripDrawMode,this._effect,i),l=this._effect._pipelineContext;r&&this._effect.setDirectColor4("color",r),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),l.uniformBuffer.update();const d=c?this._engine._ubInvertY:this._engine._ubDontInvertY,p=l.uniformBuffer.getBuffer(),_=p.uniqueId+"-"+d.uniqueId;let g=this._bindGroups[_];if(!g){const e=l.bindGroupLayouts[0];g=this._bindGroups[_]=[],g.push(this._device.createBindGroup({label:`clearQuadBindGroup0-${_}`,layout:e[0],entries:[]})),De._SimplifiedKnownBindings||g.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${_}`,layout:e[1],entries:[]})),g.push(this._device.createBindGroup({label:`clearQuadBindGroup${De._SimplifiedKnownBindings?1:2}-${_}`,layout:e[De._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:d.underlyingResource,size:d.capacity}},{binding:1,resource:{buffer:p.underlyingResource,size:p.capacity}}]}));}a.setPipeline(h);for(let e=0;e<g.length;++e)a.setBindGroup(e,g[e]);return a.draw(4,1,0,0),e||(u=a.finish(),this._bundleCache[o]=u),u}}class Ct{constructor(e,t,r,s){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(r),this.h=Math.floor(s);}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1);}clone(){return new Ct(this.x,this.y,this.w,this.h)}}class At{constructor(e,t,r,s){this.x=e,this.y=t,this.w=r,this.h=s;}run(e){e.setScissorRect(this.x,this.y,this.w,this.h);}clone(){return new At(this.x,this.y,this.w,this.h)}}class It{constructor(e){this.ref=e;}run(e){e.setStencilReference(this.ref);}clone(){return new It(this.ref)}}class vt{constructor(e){this.color=e;}run(e){e.setBlendConstant(this.color);}clone(){return new vt(this.color)}}class wt{constructor(e){this.query=e;}run(e){e.beginOcclusionQuery(this.query);}clone(){return new wt(this.query)}}class Bt{constructor(){}run(e){e.endOcclusionQuery();}clone(){return new Bt}}class Ft{constructor(){this.bundles=[];}run(e){e.executeBundles(this.bundles);}clone(){const e=new Ft;return e.bundles=this.bundles,e}}class Pt{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0;}addBundle(e){if(!this._currentItemIsBundle){const e=new Ft;this._list[this._listLength++]=e,this._currentBundleList=e.bundles,this._currentItemIsBundle=true;}e&&this._currentBundleList.push(e);}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=false);}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=false;}getBundleEncoder(e,t,r){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:W$1.GetSample(r)})),this._bundleEncoder}close(){this._finishBundle();}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e);}reset(){this._listLength=0,this._currentItemIsBundle=false,this.numDrawCalls=0;}clone(){this.close();const e=new Pt(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class Dt{get querySet(){return this._querySet}constructor(e,t,r,s,n,i=true,a){this._dstBuffers=[],this._engine=e,this._device=s,this._bufferManager=n,this._count=t,this._canUseMultipleBuffers=i,this._querySet=s.createQuerySet({label:a??"QuerySet",type:r,count:t}),this._queryBuffer=n.createRawBuffer(8*t,Y$1.QueryResolve|Y$1.CopySrc,void 0,"QueryBuffer"),i||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,Y$1.MapRead|Y$1.CopyDst,void 0,"QueryBufferNoMultipleBuffers"));}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&0===this._dstBuffers.length)return null;const r=this._device.createCommandEncoder();let s;return 0===this._dstBuffers.length?s=this._bufferManager.createRawBuffer(8*this._count,Y$1.MapRead|Y$1.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(s=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),r.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),r.copyBufferToBuffer(this._queryBuffer,0,s,0,8*t),this._device.queue.submit([r.finish()]),s}async readValues(e=0,t=1){const r=this._getBuffer(e,t);if(null===r)return null;const s=this._engine.uniqueId;try{await r.mapAsync(1);const e=new BigUint64Array(r.getMappedRange()).slice();return r.unmap(),this._dstBuffers[this._dstBuffers.length]=r,e}catch(e){if(this._engine.isDisposed||this._engine.uniqueId!==s)return null;throw e}}async readValue(e=0){const t=this._getBuffer(e,1);if(null===t)return null;const r=this._engine.uniqueId;try{await t.mapAsync(1);const e=new BigUint64Array(t.getMappedRange()),r=Number(e[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,r}catch(e){if(this._engine.isDisposed||this._engine.uniqueId!==r)return 0;throw e}}async readTwoValuesAndSubtract(e=0){const t=this._getBuffer(e,2);if(null===t)return null;const r=this._engine.uniqueId;try{await t.mapAsync(1);const e=new BigUint64Array(t.getMappedRange()),r=Number(e[1]-e[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,r}catch(e){if(this._engine.isDisposed||this._engine.uniqueId!==r)return 0;throw e}}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e]);}}class Lt{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,s){this._enabled=false,this._gpuFrameTimeCounter=new sa,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=s;}get enable(){return this._enabled}set enable(e){if(this._enabled!==e)if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new Mt(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery");}catch(e){return this._enabled=false,void Ie$2.Error("Could not create a WebGPUDurationMeasure!\nError: "+e.message+"\nMake sure timestamp query is supported and enabled in your browser.")}else this._measureDuration.dispose();}startFrame(e){this._enabled&&0===this._measureDurationState&&(this._measureDuration.start(e),this._measureDurationState=1);}endFrame(e){1===this._measureDurationState&&(this._measureDurationState=2,this._measureDuration.stop(e).then((e=>{null!==e&&e>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(e,true)),this._measureDurationState=0;})));}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0;}endPass(e,t){if(!this._enabled||!t)return;const r=this._engine.frameId;this._measureDuration.stopPass(e).then((e=>{t._addDuration(r,null!==e&&e>0?e:0);}));}dispose(){this._measureDuration?.dispose();}}class Mt{constructor(e,t,r,s=2,n){this._count=s,this._querySet=new Dt(e,s,"timestamp",t,r,true,n);}start(e){e.writeTimestamp?.(this._querySet.querySet,0);}async stop(e){return e.writeTimestamp?.(this._querySet.querySet,1),e.writeTimestamp?await this._querySet.readTwoValuesAndSubtract(0):0}startPass(e,t){if(t+3>this._count)throw new Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3};}async stopPass(e){return await this._querySet.readTwoValuesAndSubtract(e+2)}dispose(){this._querySet.dispose();}}class Ut{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return  false;const t=void 0!==this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,r,s=50,n=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=r,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=n,this._allocateNewIndices(s);}createQuery(){0===this._availableIndices.length&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e;}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){return Number(this._lastBuffer?.[e]??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then((e=>{this._lastBuffer=e;})));}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new Dt(this._engine,this._currentTotalIndices,"occlusion",this._device,this._bufferManager,false,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId;}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout((()=>e.dispose),1e3);}dispose(){this._querySet?.dispose(),this._availableIndices.length=0;}}class Ot{get code(){return this._sourceCode}constructor(e,t=20){this.debug=false,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline";}processCode(){this.debug&&Ie$2.Log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&Ie$2.Log("End of inlining process.");}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){const t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;const r=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(r<0){this.debug&&Ie$2.Warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}const s=Ot._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,r));if(!s){this.debug&&Ie$2.Warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,r)}`),e=t+this.inlineToken.length;continue}const[i,a]=[s[3],s[4]],o=Le("(",")",this._sourceCode,r);if(o<0){this.debug&&Ie$2.Warn(`Could not extract the parameters the function '${a}' (type=${i}). funcParamsStartIndex=${r}`),e=t+this.inlineToken.length;continue}const u=this._sourceCode.substring(r+1,o),c=Me(this._sourceCode,o+1);if(c===this._sourceCode.length){this.debug&&Ie$2.Warn(`Could not extract the body of the function '${a}' (type=${i}). funcParamsEndIndex=${o}`),e=t+this.inlineToken.length;continue}const h=Le("{","}",this._sourceCode,c);if(h<0){this.debug&&Ie$2.Warn(`Could not extract the body of the function '${a}' (type=${i}). funcBodyStartIndex=${c}`),e=t+this.inlineToken.length;continue}const l=this._sourceCode.substring(c,h+1),d=Oe(u).split(","),p=[];for(let e=0;e<d.length;++e){const t=d[e].trim(),r=t.lastIndexOf(" ");r>=0&&p.push(t.substring(r+1));}"void"!==i&&p.push("return"),this._functionDescr.push({name:a,type:i,parameters:p,body:l,callIndex:0}),e=h+1;const _=t>0?this._sourceCode.substring(0,t):"",g=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";this._sourceCode=_+g,e-=h+1-t;}this.debug&&Ie$2.Log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=${this._functionDescr}`);}_processInlining(e=20){for(;e-- >=0&&this._replaceFunctionCallsByCode(););return this.debug&&Ie$2.Log(`numMaxIterations is ${e} after inlining process`),e>=0}_replaceFunctionCallsByCode(){let e=false;for(const t of this._functionDescr){const{name:r,type:s,parameters:i,body:a}=t;let o=0;for(;o<this._sourceCode.length;){const u=this._sourceCode.indexOf(r,o);if(u<0)break;if(0===u||Ue(this._sourceCode.charAt(u-1))){o=u+r.length;continue}const c=Me(this._sourceCode,u+r.length);if(c===this._sourceCode.length||"("!==this._sourceCode.charAt(c)){o=u+r.length;continue}const h=Le("(",")",this._sourceCode,c);if(h<0){this.debug&&Ie$2.Warn(`Could not extract the parameters of the function call. Function '${r}' (type=${s}). callParamsStartIndex=${c}`),o=u+r.length;continue}const l=this._sourceCode.substring(c+1,h),d=e=>{const t=[];let r=0,s=0;for(;r<e.length;){if("("===e.charAt(r)){const t=Le("(",")",e,r);if(t<0)return null;r=t;}else ","===e.charAt(r)&&(t.push(e.substring(s,r)),s=r+1);r++;}return s<r&&t.push(e.substring(s,r)),t},p=d(Oe(l));if(null===p){this.debug&&Ie$2.Warn(`Invalid function call: can't extract the parameters of the function call. Function '${r}' (type=${s}). callParamsStartIndex=${c}, callParams=`+l),o=u+r.length;continue}const _=[];for(let e=0;e<p.length;++e){const t=p[e].trim();_.push(t);}const g="void"!==s?r+"_"+t.callIndex++:null;if(g&&_.push(g+" ="),_.length!==i.length){this.debug&&Ie$2.Warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${r}' (type=${s}). function parameters=${i}, call parameters=${_}`),o=u+r.length;continue}o=h+1;const f=this._replaceNames(a,i,_);let m=u>0?this._sourceCode.substring(0,u):"";const b=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";if(g){const e=Ge(this._sourceCode,u-1,"\n","{");m=this._sourceCode.substring(0,e+1);const t=this._sourceCode.substring(e+1,u);this._sourceCode=m+s+" "+g+";\n"+f+"\n"+t+g+b,this.debug&&Ie$2.Log(`Replace function call by code. Function '${r}' (type=${s}). injectDeclarationIndex=${e}, call parameters=${_}`);}else this._sourceCode=m+f+b,o+=f.length-(h+1-u),this.debug&&Ie$2.Log(`Replace function call by code. Function '${r}' (type=${s}). functionCallIndex=${u}, call parameters=${_}`);e=true;}}return e}_replaceNames(e,t,r){for(let s=0;s<t.length;++s){const n=new RegExp(t[s].replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),i=t[s].length,a=r[s];e=e.replace(n,((r,...n)=>{const o=n[0];return Ue(e.charAt(o-1))||Ue(e.charAt(o+i))?t[s]:a}));}return e}}Ot._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/;class Gt{async initTwgsl(e){if(!Gt._Twgsl)if(e=e||{},(e={...Gt._TwgslDefaultOptions,...e}).twgsl)Gt._Twgsl=e.twgsl;else {if(e.jsPath&&e.wasmPath&&await Ai.LoadBabylonScriptAsync(e.jsPath),!self.twgsl)throw new Error("twgsl is not available.");Gt._Twgsl=await self.twgsl(Ai.GetBabylonScriptURL(e.wasmPath));}}convertSpirV2WGSL(e,t=false){const r=Gt._Twgsl.convertSpirV2WGSL(e,Gt.DisableUniformityAnalysis||t);return Gt.ShowWGSLShaderCode&&(Ie$2.Log(r),Ie$2.Log("***********************************************")),Gt.DisableUniformityAnalysis||t?"diagnostic(off, derivative_uniformity);\n"+r:r}}Gt._TwgslDefaultOptions={jsPath:`${Ai._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${Ai._DefaultCdnUrl}/twgsl/twgsl.wasm`},Gt.ShowWGSLShaderCode=false,Gt.DisableUniformityAnalysis=false,Gt._Twgsl=null;class Nt{constructor(e,t,r){this._record=false,this._play=false,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=false,this.showDebugLogs=false,this._engine=e,this._mode=t,this._bundleList=r;}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._log("enabled",`activate=${e}, mode=${this._mode}`),this._allBundleLists.length=0,this._record=this._enabled=e,this._play=false,e&&(this._modeSaved=this._mode,this._mode=Qe$1.SNAPSHOTRENDERING_STANDARD);}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e;}endRenderPass(e){if(!this._record&&!this._play)return  false;let r=null;return this._record?(r=this._bundleList.clone(),this._allBundleLists.push(r),this._bundleList.reset(),this._log("endRenderPass","bundleList recorded at position #"+(this._allBundleLists.length-1))):this._playBundleListIndex>=this._allBundleLists.length?this._log("endRenderPass",`empty or out-of-sync bundleList (_allBundleLists.length=${this._allBundleLists.length}, playBundleListIndex=${this._playBundleListIndex})`):(this._log("endRenderPass",`run bundleList #${this._playBundleListIndex}`),r=this._allBundleLists[this._playBundleListIndex++]),r&&(r.run(e),this._mode===Qe$1.SNAPSHOTRENDERING_FAST&&this._engine._reportDrawCall(r.numDrawCalls)),true}endFrame(){this._record&&(this._record=false,this._play=true,this._mode=this._modeSaved,this._log("endFrame","bundles recorded, switching to play mode")),this._playBundleListIndex=0;}reset(){this._log("reset","called"),this._record&&(this._mode=this._modeSaved),this.enabled=false,this.enabled=true;}_log(e,t){this.showDebugLogs&&Ie$2.Log(`[Frame: ${this._engine.frameId}] WebGPUSnapshotRendering:${e} - ${t}`);}}const Wt=(()=>{const e=new Uint8Array(4);return !!((new Uint32Array(e.buffer)[0]=1)&e[0])})();Object.defineProperty(Hi.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:true,configurable:true}),Object.defineProperty(Hi.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:true,configurable:true}),Object.defineProperty(Hi.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:true,configurable:true}),Hi.prototype._rebuild=function(){this._buffer?._rebuild(),this._alignedBuffer?._rebuild();},Hi.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose(),this._alignedBuffer?.dispose(),this._alignedBuffer=void 0,this._isDisposed=true;},Hi.prototype.getWrapperBuffer=function(){return this._alignedBuffer||this._buffer},Hi.prototype._alignBuffer=function(){const e=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideAndOffsetMultiple4Bytes||this.byteStride%4==0&&this.byteOffset%4==0||!e)return;const t=Ni(this.type),r=this.byteStride+3&-4,s=r/t,n=this._maxVerticesCount,i=n*r/t;let a,o;if(Array.isArray(e)){const t=new Float32Array(e);a=new DataView(t.buffer,t.byteOffset,t.byteLength);}else a=e instanceof ArrayBuffer?new DataView(e,0,e.byteLength):new DataView(e.buffer,e.byteOffset,e.byteLength);o=this.type===Hi.BYTE?new Int8Array(i):this.type===Hi.UNSIGNED_BYTE?new Uint8Array(i):this.type===Hi.SHORT?new Int16Array(i):this.type===Hi.UNSIGNED_SHORT?new Uint16Array(i):this.type===Hi.INT?new Int32Array(i):this.type===Hi.UNSIGNED_INT?new Uint32Array(i):new Float32Array(i);const u=this.getSize();let c=this.byteOffset;for(let e=0;e<n;++e){for(let t=0;t<u;++t)switch(this.type){case Hi.BYTE:o[e*s+t]=a.getInt8(c+t);break;case Hi.UNSIGNED_BYTE:o[e*s+t]=a.getUint8(c+t);break;case Hi.SHORT:o[e*s+t]=a.getInt16(c+2*t,Wt);break;case Hi.UNSIGNED_SHORT:o[e*s+t]=a.getUint16(c+2*t,Wt);break;case Hi.INT:o[e*s+t]=a.getInt32(c+4*t,Wt);break;case Hi.UNSIGNED_INT:o[e*s+t]=a.getUint32(c+4*t,Wt);break;case Hi.FLOAT:o[e*s+t]=a.getFloat32(c+4*t,Wt);}c+=this.byteStride;}this._alignedBuffer?.dispose(),this._alignedBuffer=new Vi(this.engine,o,false,r,false,this.getIsInstanced(),true,this.instanceDivisor,(this._label??"VertexBuffer")+"_aligned");};class Vt extends ft{constructor(e){super(e);}}function $t(e,r,s,n){let i,a=1;n===Qe$1.TEXTURETYPE_FLOAT?i=new Float32Array(r*s*4):n===Qe$1.TEXTURETYPE_HALF_FLOAT?(i=new Uint16Array(r*s*4),a=15360):i=n===Qe$1.TEXTURETYPE_UNSIGNED_INTEGER?new Uint32Array(r*s*4):new Uint8Array(r*s*4);for(let t=0;t<r;t++)for(let n=0;n<s;n++){const s=3*(n*r+t),o=4*(n*r+t);i[o+0]=e[s+0],i[o+1]=e[s+1],i[o+2]=e[s+2],i[o+3]=a;}return i}$$1.prototype.setAlphaMode=function(e,r=false,s=0){const n=this._alphaState._alphaBlend[s];if(this._alphaMode[s]===e&&(e===Qe$1.ALPHA_DISABLE&&!n||e!==Qe$1.ALPHA_DISABLE&&n)){if(!r){const r=e===Qe$1.ALPHA_DISABLE;this.depthCullingState.depthMask!==r&&(this.setDepthWrite(r),this._cacheRenderPipeline.setDepthWriteEnabled(r));}return}const i=e===Qe$1.ALPHA_DISABLE;this._alphaState.setAlphaBlend(!i,s),this._alphaState.setAlphaMode(e,s),r||(this.setDepthWrite(i),this._cacheRenderPipeline.setDepthWriteEnabled(i)),this._alphaMode[s]=e,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters);},$$1.prototype.setAlphaEquation=function(e,t=0){jt.prototype.setAlphaEquation.call(this,e,t),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters);},$$1.prototype.createRawTexture=function(e,r,s,n,i,a,o,u=null,c=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,h=0,l=false){const d=new zt(this,3);return d.baseWidth=r,d.baseHeight=s,d.width=r,d.height=s,d.format=n,d.generateMipMaps=i,d.samplingMode=o,d.invertY=a,d._compression=u,d.type=c,d._creationFlags=h,d._useSRGBBuffer=l,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,r,s,void 0,h),this.updateRawTexture(d,e,n,a,u,c,l),this._internalTexturesCache.push(d),d},$$1.prototype.updateRawTexture=function(e,r,s,n,i=null,a=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,o=false){if(e){if(this._doNotHandleContextLost||(e._bufferView=r,e.invertY=n,e._compression=i,e._useSRGBBuffer=o),r){const i=e._hardwareTexture;s===Qe$1.TEXTUREFORMAT_RGB&&(r=$t(r,e.width,e.height,a));const o=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);this._textureHelper.updateTexture(o,e,e.width,e.height,e.depth,i.format,0,0,n,false,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder);}e.isReady=true;}},$$1.prototype.createRawCubeTexture=function(e,r,s,i,a,o,u,c=null){const h=new zt(this,8);if(i!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering?i!==Qe$1.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering?i!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloatRender?i!==Qe$1.TEXTURETYPE_HALF_FLOAT||this._caps.colorBufferFloat||(a=false,Ie$2.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(a=false,Ie$2.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(a=false,u=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Ie$2.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(a=false,u=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Ie$2.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),h.isCube=true,h._originalFormat=s,h.format=s===Qe$1.TEXTUREFORMAT_RGB?Qe$1.TEXTUREFORMAT_RGBA:s,h.type=i,h.generateMipMaps=a,h.width=r,h.height=r,h.samplingMode=u,this._doNotHandleContextLost||(h._bufferViewArray=e),h.invertY=o,h._compression=c,h._cachedWrapU=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,h._cachedWrapV=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,this._textureHelper.createGPUTextureForInternalTexture(h),s===Qe$1.TEXTUREFORMAT_RGB){h._hardwareTexture._originalFormatIsRGB=true;}return e&&this.updateRawCubeTexture(h,e,s,i,o,c),h.isReady=true,h},$$1.prototype.updateRawCubeTexture=function(e,t,r,s,n,i=null){e._bufferViewArray=t,e.invertY=n,e._compression=i;const a=e._hardwareTexture,o=a._originalFormatIsRGB,u=[0,2,4,1,3,5],c=[];for(let r=0;r<t.length;++r){let n=t[u[r]];o&&(n=$t(n,e.width,e.height,s)),c.push(new Uint8Array(n.buffer,n.byteOffset,n.byteLength));}this._textureHelper.updateCubeTextures(c,a.underlyingResource,e.width,e.height,a.format,n,false,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=true;},$$1.prototype.createRawCubeTextureFromUrl=function(e,r,s,n,i,a,o,u,c=null,h=null,l=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,d=false){const p=this.createRawCubeTexture(null,s,n,i,!a,d,l,null);r?.addPendingData(p),p.url=e,p.isReady=false,this._internalTexturesCache.push(p);const _=(e,t)=>{r?.removePendingData(p),h&&e&&h(e.status+" "+e.statusText,t);},g=async e=>{const s=o(e);if(!s)return;const a=s instanceof Promise?await s:s,h=p.width;if(u){const e=n===Qe$1.TEXTUREFORMAT_RGB,r=u(a),s=p._hardwareTexture,o=[0,1,2,3,4,5];for(let t=0;t<r.length;t++){const n=h>>t,a=[];for(let s=0;s<6;s++){let u=r[t][o[s]];e&&(u=$t(u,n,n,i)),a.push(new Uint8Array(u.buffer,u.byteOffset,u.byteLength));}this._textureHelper.updateCubeTextures(a,s.underlyingResource,n,n,s.format,d,false,0,0);}}else this.updateRawCubeTexture(p,a,n,i,d);p.isReady=true,r?.removePendingData(p),c&&c();};return this._loadFile(e,(e=>{g(e).catch((e=>{_(void 0,e);}));}),void 0,r?.offlineProvider,true,_),p},$$1.prototype.createRawTexture3D=function(e,r,s,n,i,a,o,u,c=null,h=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,l=0){const d=new zt(this,10);return d.baseWidth=r,d.baseHeight=s,d.baseDepth=n,d.width=r,d.height=s,d.depth=n,d.format=i,d.type=h,d.generateMipMaps=a,d.samplingMode=u,d.is3D=true,d._creationFlags=l,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,r,s,void 0,l),this.updateRawTexture3D(d,e,i,o,c,h),this._internalTexturesCache.push(d),d},$$1.prototype.updateRawTexture3D=function(e,r,s,n,i=null,a=Qe$1.TEXTURETYPE_UNSIGNED_BYTE){if(this._doNotHandleContextLost||(e._bufferView=r,e.format=s,e.invertY=n,e._compression=i),r){const i=e._hardwareTexture;s===Qe$1.TEXTUREFORMAT_RGB&&(r=$t(r,e.width,e.height,a));const o=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);this._textureHelper.updateTexture(o,e,e.width,e.height,e.depth,i.format,0,0,n,false,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder);}e.isReady=true;},$$1.prototype.createRawTexture2DArray=function(e,r,s,n,i,a,o,u,c=null,h=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,l=0){const d=new zt(this,11);return d.baseWidth=r,d.baseHeight=s,d.baseDepth=n,d.width=r,d.height=s,d.depth=n,d.format=i,d.type=h,d.generateMipMaps=a,d.samplingMode=u,d.is2DArray=true,d._creationFlags=l,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,r,s,n,l),this.updateRawTexture2DArray(d,e,i,o,c,h),this._internalTexturesCache.push(d),d},$$1.prototype.updateRawTexture2DArray=function(e,r,s,n,i=null,a=Qe$1.TEXTURETYPE_UNSIGNED_BYTE){if(this._doNotHandleContextLost||(e._bufferView=r,e.format=s,e.invertY=n,e._compression=i),r){const i=e._hardwareTexture;s===Qe$1.TEXTUREFORMAT_RGB&&(r=$t(r,e.width,e.height,a));const o=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);this._textureHelper.updateTexture(o,e,e.width,e.height,e.depth,i.format,0,0,n,false,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder);}e.isReady=true;},$$1.prototype._readTexturePixels=function(e,t,r,s=-1,n=0,i=null,a=true,o=false,u=0,c=0){const h=e._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(h.underlyingResource,u,c,t,r,h.format,s,n,i,o)},$$1.prototype._readTexturePixelsSync=function(){throw "_readTexturePixelsSync is unsupported in WebGPU!"},$$1.prototype._createDepthStencilCubeTexture=function(e,r){const s=new zt(this,r.generateStencil?12:14);s.isCube=true,s.label=r.label;const n={bilinearFiltering:false,comparisonFunction:0,samples:1,depthTextureFormat:r.generateStencil?Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT,...r};s.format=n.depthTextureFormat,this._setupDepthStencilTexture(s,e,n.bilinearFiltering,n.comparisonFunction,n.samples),this._textureHelper.createGPUTextureForInternalTexture(s);const i=s._hardwareTexture;return s.type=W$1.GetTextureTypeFromFormat(i.format),this._internalTexturesCache.push(s),s},$$1.prototype.createCubeTexture=function(e,t,r,s,n=null,i=null,a,o=null,u=false,c=0,h=0,l=null,d,p=false,_=null){return this.createCubeTextureBase(e,t,r,!!s,n,i,a,o,u,c,h,l,null,((e,t)=>{const r=t,i=r[0].width,o=i;this._setCubeMapTextureParams(e,!s),e.format=a??-1;const u=this._textureHelper.createGPUTextureForInternalTexture(e,i,o);this._textureHelper.updateCubeTextures(r,u.underlyingResource,i,o,u.format,false,false,0,0),s||this._generateMipmaps(e,this._uploadEncoder),e.isReady=true,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),n&&n();}),!!p,_)},$$1.prototype._setCubeMapTextureParams=function(e,r,s){e.samplingMode=r?Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE:Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,e._cachedWrapU=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,e._cachedWrapV=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,s&&(e._maxLodLevel=s);},$$1.prototype.generateMipMapsForCubemap=function(e){if(e.generateMipMaps){const t=e._hardwareTexture?.underlyingResource;t||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e);}};class kt extends Ba{constructor(e,t,r,s,n){super(e,t,r,s,n),s.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new V$5);}}$$1.prototype._createHardwareRenderTargetWrapper=function(e,t,r){const s=new kt(e,t,r,this);return this._renderTargetWrapperCache.push(s),s},$$1.prototype.createRenderTargetTexture=function(e,r){const s=this._createHardwareRenderTargetWrapper(false,false,e),n={};void 0!==r&&"object"==typeof r?(n.generateMipMaps=r.generateMipMaps,n.generateDepthBuffer=void 0===r.generateDepthBuffer||r.generateDepthBuffer,n.generateStencilBuffer=n.generateDepthBuffer&&r.generateStencilBuffer,n.samplingMode=void 0===r.samplingMode?Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE:r.samplingMode,n.creationFlags=r.creationFlags??0,n.noColorAttachment=!!r.noColorAttachment,n.colorAttachment=r.colorAttachment,n.samples=r.samples,n.label=r.label,n.format=r.format,n.type=r.type):(n.generateMipMaps=r,n.generateDepthBuffer=true,n.generateStencilBuffer=false,n.samplingMode=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,n.creationFlags=0,n.noColorAttachment=false);const i=n.colorAttachment||(n.noColorAttachment?null:this._createInternalTexture(e,n,true,5));return s.label=n.label??"RenderTargetWrapper",s._samples=n.colorAttachment?.samples??n.samples??1,s._generateDepthBuffer=n.generateDepthBuffer,s._generateStencilBuffer=!!n.generateStencilBuffer,s.setTextures(i),(s._generateDepthBuffer||s._generateStencilBuffer)&&s.createDepthStencilTexture(0,false,s._generateStencilBuffer,s.samples,n.generateStencilBuffer?Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT,n.label?n.label+"-DepthStencil":void 0),i&&!n.colorAttachment&&(void 0!==r&&"object"==typeof r&&r.createMipMaps&&!n.generateMipMaps&&(i.generateMipMaps=true),this._textureHelper.createGPUTextureForInternalTexture(i,void 0,void 0,void 0,n.creationFlags),void 0!==r&&"object"==typeof r&&r.createMipMaps&&!n.generateMipMaps&&(i.generateMipMaps=false)),s},$$1.prototype._createDepthStencilTexture=function(e,r,s){const n={bilinearFiltering:false,comparisonFunction:0,samples:1,depthTextureFormat:r.generateStencil?Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT,...r},i=Ca(n.depthTextureFormat);s._depthStencilTextureWithStencil=i;const a=new zt(this,i?12:14);return a.label=r.label,a.format=n.depthTextureFormat,a.type=Ia(a.format),this._setupDepthStencilTexture(a,e,n.bilinearFiltering,n.comparisonFunction,n.samples),this._textureHelper.createGPUTextureForInternalTexture(a),this._internalTexturesCache.push(a),a},$$1.prototype._setupDepthStencilTexture=function(e,r,s,n,i=1){const a=r.width??r,o=r.height??r,u=r.layers||0,c=r.depth||0;e.baseWidth=a,e.baseHeight=o,e.width=a,e.height=o,e.is2DArray=u>0,e.is3D=c>0,e.depth=u||c,e.isReady=true,e.samples=i,e.generateMipMaps=false,e.samplingMode=s?Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,e.type=Qe$1.TEXTURETYPE_FLOAT,e._comparisonFunction=n,e._cachedWrapU=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,e._cachedWrapV=Qe$1.TEXTURE_CLAMP_ADDRESSMODE;},$$1.prototype.updateRenderTargetTextureSampleCount=function(e,t){return e&&e.texture&&e.samples!==t?(t=Math.min(t,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(e.texture,t),e._depthStencilTexture&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,e.texture.samples=t,t):t},$$1.prototype.setDepthStencilTexture=function(e,t,r,s){r&&r.depthStencilTexture?this._setTexture(e,r,false,true,s):this._setTexture(e,null,void 0,void 0,s);},$$1.prototype.createRenderTargetCubeTexture=function(e,r){const s=this._createHardwareRenderTargetWrapper(false,true,e),n={generateMipMaps:true,generateDepthBuffer:true,generateStencilBuffer:false,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,samplingMode:Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,format:Qe$1.TEXTUREFORMAT_RGBA,samples:1,...r};n.generateStencilBuffer=n.generateDepthBuffer&&n.generateStencilBuffer,s.label=n.label??"RenderTargetWrapper",s._generateDepthBuffer=n.generateDepthBuffer,s._generateStencilBuffer=n.generateStencilBuffer;const i=new zt(this,5);return i.width=e,i.height=e,i.depth=0,i.isReady=true,i.isCube=true,i.samples=n.samples,i.generateMipMaps=n.generateMipMaps,i.samplingMode=n.samplingMode,i.type=n.type,i.format=n.format,this._internalTexturesCache.push(i),s.setTextures(i),(s._generateDepthBuffer||s._generateStencilBuffer)&&s.createDepthStencilTexture(0,void 0===n.samplingMode||n.samplingMode===Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE||n.samplingMode===Qe$1.TEXTURE_LINEAR_LINEAR||n.samplingMode===Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE||n.samplingMode===Qe$1.TEXTURE_LINEAR_LINEAR_MIPLINEAR||n.samplingMode===Qe$1.TEXTURE_NEAREST_LINEAR_MIPNEAREST||n.samplingMode===Qe$1.TEXTURE_NEAREST_LINEAR_MIPLINEAR||n.samplingMode===Qe$1.TEXTURE_NEAREST_LINEAR||n.samplingMode===Qe$1.TEXTURE_LINEAR_LINEAR_MIPNEAREST,s._generateStencilBuffer,s.samples),r&&r.createMipMaps&&!n.generateMipMaps&&(i.generateMipMaps=true),this._textureHelper.createGPUTextureForInternalTexture(i),r&&r.createMipMaps&&!n.generateMipMaps&&(i.generateMipMaps=false),s};class Xt{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=false,this.isOccluded=false,this.occlusionRetryCount=-1,this.occlusionType=ps.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=ps.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=false;}}jt.prototype.createQuery=function(){return null},jt.prototype.deleteQuery=function(e){return this},jt.prototype.isQueryResultAvailable=function(e){return  false},jt.prototype.getQueryResult=function(e){return 0},jt.prototype.beginOcclusionQuery=function(e,t){return  false},jt.prototype.endOcclusionQuery=function(e){return this},Object.defineProperty(ps.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(e){this._occlusionDataStorage.isOcclusionQueryInProgress=e;},enumerable:false,configurable:true}),Object.defineProperty(ps.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new Xt),this.__occlusionDataStorage},enumerable:false,configurable:true}),Object.defineProperty(ps.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(e){this._occlusionDataStorage.isOccluded=e;},enumerable:true,configurable:true}),Object.defineProperty(ps.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(e){this._occlusionDataStorage.occlusionQueryAlgorithmType=e;},enumerable:true,configurable:true}),Object.defineProperty(ps.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(e){this._occlusionDataStorage.occlusionType=e;},enumerable:true,configurable:true}),Object.defineProperty(ps.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(e){this._occlusionDataStorage.occlusionRetryCount=e;},enumerable:true,configurable:true}),Object.defineProperty(ps.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(e){this._occlusionDataStorage.forceRenderingWhenOccluded=e;},enumerable:true,configurable:true}),ps.prototype._checkOcclusionQuery=function(){const e=this._occlusionDataStorage;if(e.occlusionType===ps.OCCLUSION_TYPE_NONE)return e.isOccluded=false,false;const t=this.getEngine();if(!t.getCaps().supportOcclusionQuery)return e.isOccluded=false,false;if(!t.isQueryResultAvailable)return e.isOccluded=false,false;if(this.isOcclusionQueryInProgress&&null!==this._occlusionQuery&&void 0!==this._occlusionQuery){if(t.isQueryResultAvailable(this._occlusionQuery)){const r=t.getQueryResult(this._occlusionQuery);e.isOcclusionQueryInProgress=false,e.occlusionInternalRetryCounter=0,e.isOccluded=!(r>0);}else {if(e.occlusionInternalRetryCounter++,!(-1!==e.occlusionRetryCount&&e.occlusionInternalRetryCounter>e.occlusionRetryCount))return e.occlusionType!==ps.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded;e.isOcclusionQueryInProgress=false,e.occlusionInternalRetryCounter=0,e.isOccluded=e.occlusionType!==ps.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded;}}const r=this.getScene();if(r.getBoundingBoxRenderer){const s=r.getBoundingBoxRenderer();null===this._occlusionQuery&&(this._occlusionQuery=t.createQuery()),this._occlusionQuery&&t.beginOcclusionQuery(e.occlusionQueryAlgorithmType,this._occlusionQuery)&&(s.renderOcclusionBoundingBox(this),t.endOcclusionQuery(e.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=true);}return e.isOccluded},$$1.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter},$$1.prototype.captureGPUFrameTime=function(e){this._timestampQuery.enable=e&&!!this._caps.timerQuery;},$$1.prototype.createQuery=function(){return this._occlusionQuery.createQuery()},$$1.prototype.deleteQuery=function(e){return this._occlusionQuery.deleteQuery(e),this},$$1.prototype.isQueryResultAvailable=function(e){return this._occlusionQuery.isQueryResultAvailable(e)},$$1.prototype.getQueryResult=function(e){return this._occlusionQuery.getQueryResult(e)},$$1.prototype.beginOcclusionQuery=function(e,t){return this.compatibilityMode?!!this._occlusionQuery.canBeginQuery(t)&&(this._currentRenderPass?.beginOcclusionQuery(t),true):(this._bundleList.addItem(new wt(t)),true)},$$1.prototype.endOcclusionQuery=function(){return this.compatibilityMode?this._currentRenderPass?.endOcclusionQuery():this._bundleList.addItem(new Bt),this};const Ht={label:"TextureView_SwapChain_ResolveTarget",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},Yt={label:"TextureView_SwapChain",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},qt=new me$3;class Qt extends $$1{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e;}snapshotRenderingReset(){this._snapshotRendering.reset();}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e;}get disableCacheSamplers(){return !!this._cacheSampler&&this._cacheSampler.disabled}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e);}get disableCacheRenderPipelines(){return !!this._cacheRenderPipeline&&this._cacheRenderPipeline.disabled}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e);}get disableCacheBindGroups(){return !!this._cacheBindGroups&&this._cacheBindGroups.disabled}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e);}areAllEffectsReady(){return  true}getFontOffset(e){return Ka(e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then((e=>!!e),(()=>false)).catch((()=>false)):Promise.resolve(false)}static get IsSupported(){return Ie$2.Warn("You must call IsSupportedAsync for WebGPU!"),false}get supportsUniformBuffers(){return  true}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return {vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e;}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){const r=new Qt(e,t);return new Promise((e=>{r.initAsync(t.glslangOptions,t.twgslOptions).then((()=>e(r)));}))}constructor(e,t={}){super(t.antialias??true,t),this.uniqueId=-1,this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._glslangAndTintAreFullyLoaded=false,this._adapterInfo={vendor:"",architecture:"",device:"",description:"",subgroupMinSize:0,subgroupMaxSize:0,isFallbackAdapter:false},this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this.scenes=[],this._virtualScenes=new Array,this._commandBuffers=[null,null],this._mainRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._rttRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._pendingDebugCommands=[],this._currentVertexBuffers={},this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=true,this._forceEnableEffect=false,this.isNDCHalfZRange=true,this.hasOriginBottomLeft=false,this._workingGlslangAndTintPromise=null,this._viewportsCurrent={x:0,y:0,w:0,h:0},this._scissorsCurrent={x:0,y:0,w:0,h:0},this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=-1,this._blendColorsCurrent=[null,null,null,null],this._performanceMonitor=new Da,this._name="WebGPU",this._drawCalls=new sa,t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=t.enableGPUDebugMarkers??false,Ie$2.Log(`Babylon.js v${jt.Version} - ${this.description} engine`),navigator.gpu?(t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=true,this._shaderPlatformName="WEBGPU",this._renderingCanvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,navigator&&navigator.userAgent&&this._setupMobileChecks(),this._sharedInit(this._renderingCanvas),this._shaderProcessor=new We,this._shaderProcessorWGSL=new ke):Ie$2.Error("WebGPU is not supported by your browser.");}prepareGlslangAndTintAsync(){return this._workingGlslangAndTintPromise||(this._workingGlslangAndTintPromise=new Promise((e=>{this._initGlslangAsync(this._glslangOptions??this._options?.glslangOptions).then((t=>{this._glslang=t,this._tintWASM=new Gt,this._tintWASM.initTwgsl(this._twgslOptions??this._options?.twgslOptions).then((()=>{this._glslangAndTintAreFullyLoaded=true,e();}));}));}))),this._workingGlslangAndTintPromise}initAsync(e,r){return this.uniqueId=Qt._InstanceId++,this._glslangOptions=e,this._twgslOptions=r,navigator.gpu.requestAdapter(this._options).then((async e=>{if(e){this._adapter=e,this._adapterSupportedExtensions=[],this._adapter.features?.forEach((e=>{this._adapterSupportedExtensions.push(e);})),this._adapterSupportedLimits=this._adapter.limits,this._adapterInfo=this._adapter.info;const t=this._options.deviceDescriptor??{},r=t?.requiredFeatures??(this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0);if(r){const e=r,s=[];for(const t of e) -1!==this._adapterSupportedExtensions.indexOf(t)&&s.push(t);t.requiredFeatures=s;}if(this._options.setMaximumLimits&&!t.requiredLimits){t.requiredLimits={};for(const e in this._adapterSupportedLimits)"minSubgroupSize"!==e&&"maxSubgroupSize"!==e&&(t.requiredLimits[e]=this._adapterSupportedLimits[e]);}return t.label=`BabylonWebGPUDevice${this.uniqueId}`,await this._adapter.requestDevice(t)}throw "Could not retrieve a WebGPU adapter (adapter is null)."})).then((e=>{this._device=e,this._deviceEnabledExtensions=[],this._device.features?.forEach((e=>{this._deviceEnabledExtensions.push(e);})),this._deviceLimits=e.limits;let t=-1;this._device.addEventListener("uncapturederror",(e=>{++t<this.numMaxUncapturedErrors?Ie$2.Warn(`WebGPU uncaptured error (${t+1}): ${e.error} - ${e.error.message}`):t++===this.numMaxUncapturedErrors&&Ie$2.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`);})),this._doNotHandleContextLost||this._device.lost?.then((e=>{this._isDisposed||(this._contextWasLost=true,Ie$2.Warn("WebGPU context lost. "+e),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost((async()=>{const e=this.snapshotRenderingMode,t=this.snapshotRendering,r=this.disableCacheSamplers,s=this.disableCacheRenderPipelines,n=this.disableCacheBindGroups,i=this.enableGPUTimingMeasurements;await this.initAsync(this._glslangOptions??this._options?.glslangOptions,this._twgslOptions??this._options?.twgslOptions),this.snapshotRenderingMode=e,this.snapshotRendering=t,this.disableCacheSamplers=r,this.disableCacheRenderPipelines=s,this.disableCacheBindGroups=n,this.enableGPUTimingMeasurements=i,this._currentRenderPass=null;})));}));})).then((()=>{this._initializeLimits(),this._bufferManager=new Ze(this,this._device),this._textureHelper=new je(this,this._device,this._bufferManager,this._deviceEnabledExtensions),this._cacheSampler=new st(this._device),this._cacheBindGroups=new yt(this._device,this._cacheSampler,this),this._timestampQuery=new Lt(this,this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new Ut(this,this._device,this._bufferManager):void 0,this._bundleList=new Pt(this._device),this._snapshotRendering=new Nt(this,this._snapshotRenderingMode,this._bundleList),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),Y$1.Uniform|Y$1.CopyDst,"UBInvertY"),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),Y$1.Uniform|Y$1.CopyDst,"UBDontInvertY"),this.dbgVerboseLogsForFirstFrames&&void 0===this._count&&(this._count=0,Ie$2.Log(["%c frame #"+this._count+" - begin","background: #ffff00"])),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._emptyVertexBuffer=new Hi(this,[0],"",{stride:1,offset:0,size:1,label:"EmptyVertexBuffer"}),this._dummyIndexBuffer=this._bufferManager.createBuffer(new Uint16Array([0,0,0,0]),Y$1.Storage|Y$1.CopyDst,"DummyIndices"),this._cacheRenderPipeline=new pt(this._device,this._emptyVertexBuffer),this._depthCullingState=new gt(this._cacheRenderPipeline),this._stencilStateComposer=new _t(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=true,this._depthCullingState.depthFunc=Qe$1.LEQUAL,this._depthCullingState.depthMask=true,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new St(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize();})).catch((e=>{throw Ie$2.Error("A fatal error occurred during WebGPU creation/initialization."),e}))}_initGlslangAsync(e){if(e=e||{},(e={...Qt._GlslangDefaultOptions,...e}).glslang)return e.glslang;if(self.glslang)return self.glslang(e.wasmPath);if(e.jsPath&&e.wasmPath)return Ai.LoadBabylonScriptAsync(e.jsPath).then((()=>self.glslang(Ai.GetBabylonScriptURL(e.wasmPath))));throw new Error("glslang is not available")}_initializeLimits(){const e=this._deviceEnabledExtensions.indexOf("texture-formats-tier1")>=0;this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:2*this._deviceLimits.maxSampledTexturesPerShaderStage,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxDrawBuffers:8,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),shaderFloatPrecision:23,standardDerivatives:true,astc:this._deviceEnabledExtensions.indexOf("texture-compression-astc")>=0||void 0,s3tc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0||void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf("texture-compression-etc2")>=0||void 0,bptc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0||void 0,maxAnisotropy:16,uintIndices:true,fragmentDepthSupported:true,highPrecisionShaderSupported:true,colorBufferFloat:true,blendFloat:this._deviceEnabledExtensions.indexOf("float32-blendable")>=0,supportFloatTexturesResolve:false,rg11b10ufColorRenderable:this._deviceEnabledExtensions.indexOf("rg11b10ufloat-renderable")>=0,textureFloat:true,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf("float32-filterable")>=0,textureFloatRender:true,textureHalfFloat:true,textureHalfFloatLinearFiltering:true,textureHalfFloatRender:true,textureLOD:true,texelFetch:true,drawBuffersExtension:true,depthTextureExtension:true,vertexArrayObject:false,instancedArrays:true,timerQuery:"undefined"!=typeof BigUint64Array&&-1!==this._deviceEnabledExtensions.indexOf("timestamp-query")||void 0,supportOcclusionQuery:"undefined"!=typeof BigUint64Array,canUseTimestampForTimerQuery:true,multiview:false,oculusMultiview:false,parallelShaderCompile:void 0,blendMinMax:true,maxMSAASamples:4,canUseGLInstanceID:true,canUseGLVertexID:true,supportComputeShaders:true,supportSRGBBuffers:true,supportTransformFeedbacks:false,textureMaxLevel:true,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:false,textureNorm16:e,blendParametersPerTarget:true,dualSourceBlending:true},this._features={forceBitmapOverHTMLImageElement:true,supportRenderAndCopyToLodForFloatTextures:true,supportDepthStencilTexture:true,supportShadowSamplers:true,uniformBufferHardCheckMatrix:false,allowTexturePrefiltering:true,trackUbosInFrame:true,checkUbosContentBeforeUpload:true,supportCSM:true,basisNeedsPOT:false,support3DTextures:true,needTypeSuffixInShaderConstants:true,supportMSAA:true,supportSSAO2:true,supportIBLShadows:true,supportExtendedTextureFormats:true,supportSwitchCaseInShader:true,supportSyncTextureRead:false,needsInvertingBitmap:false,useUBOBindingCache:false,needShaderCodeInlining:true,needToAlwaysBindUniformBuffers:true,supportRenderPasses:true,supportSpriteInstancing:true,forceVertexBufferStrideAndOffsetMultiple4Bytes:true,_checkNonFloatVertexBuffersDontRecreatePipelineContext:true,_collectUbosUpdatedInFrame:false},this._alphaState=new Gt$1(this._caps.blendParametersPerTarget);}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw "The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new Xe(this)],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this._setColorFormat(this._mainRenderPassWrapper);}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(),this._mainTextureExtends={width:this.getRenderWidth(true),height:this.getRenderHeight(true),depthOrArrayLayers:1};const e=new Float32Array([this.getRenderHeight(true)]);let t;if(this._bufferManager.setSubData(this._ubInvertY,4,e),this._bufferManager.setSubData(this._ubDontInvertY,4,e),this._options.antialias){const e={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._options.swapChainFormat,usage:16};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(e),t=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:"2d",format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new me$3(0,0,0,1),loadOp:"clear",storeOp:"store"}];}else t=[{view:void 0,clearValue:new me$3(0,0,0,1),loadOp:"clear",storeOp:"store"}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?"depth24plus-stencil8":"depth32float",this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper);const r={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._mainRenderPassWrapper.depthTextureFormat,usage:16};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(r);const s={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:"2d",format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?"clear":void 0,stencilStoreOp:this.isStencilEnable?"store":void 0};this._mainRenderPassWrapper.renderPassDescriptor={label:"MainRenderPass",colorAttachments:t,depthStencilAttachment:s},this.beginFrame(),this._startMainRenderPass(true,null,true,false),this._endCurrentRenderPass(),this.endFrame(),this._frameId--;}_sharedInit(e){super._sharedInit(e),Wa(this,e,this._creationOptions);}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:17,alphaMode:this.premultipliedAlpha?"premultiplied":"opaque"});}resizeImageBitmap(e,t,r){return Qa(this,e,t,r)}async _createImageBitmapFromSource(e,t){return await ja(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e);}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&qa(this._renderingCanvas));}exitFullscreen(){this.isFullscreen&&Za();}enterPointerlock(){this._renderingCanvas&&Ja(this._renderingCanvas);}exitPointerlock(){$a();}_rebuildBuffers(){super._rebuildBuffers();for(const e of this._storageBuffers)e.getBuffer().engineId!==this.uniqueId&&e._rebuild();}_restoreEngineAfterContextLost(e){pt.ResetCache(),yt.ResetCache();const t=e=>{for(const t of e){for(const e of t.meshes){const t=e.subMeshes;if(t)for(const e of t)e._drawWrappers=[];}for(const e of t.materials)e._materialContext?.reset();}};t(this.scenes),t(this._virtualScenes);const r=[];for(const e of this._uniformBuffers)e.name.indexOf("leftOver")<0&&r.push(e);this._uniformBuffers=r,super._restoreEngineAfterContextLost(e);}setSize(e,t,r=false){return !!super.setSize(e,t,r)&&(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log(["frame #"+this._count+" - setSize -",e,t])),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),true)}_getShaderProcessor(e){return 1===e?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e,t){return new De(e,t)}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,false,null,false,false):this._currentRenderPass||this._startMainRenderPass(false),this._currentRenderPass}_getCurrentRenderPassWrapper(){return this._currentRenderTarget?this._rttRenderPassWrapper:this._mainRenderPassWrapper}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled);}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=true,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=Qe$1.LEQUAL,this._alphaState.reset(),this._resetAlphaMode(),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this.setColorWrite(true)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null);}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0);}getColorWrite(){return this._colorWriteLocal}_mustUpdateViewport(){const e=this._viewportCached.x,t=this._viewportCached.y,r=this._viewportCached.z,s=this._viewportCached.w,n=this._viewportsCurrent.x!==e||this._viewportsCurrent.y!==t||this._viewportsCurrent.w!==r||this._viewportsCurrent.h!==s;return n&&(this._viewportsCurrent.x=this._viewportCached.x,this._viewportsCurrent.y=this._viewportCached.y,this._viewportsCurrent.w=this._viewportCached.z,this._viewportsCurrent.h=this._viewportCached.w),n}_applyViewport(e){const t=Math.floor(this._viewportCached.x),r=Math.floor(this._viewportCached.z),s=Math.floor(this._viewportCached.w);let i=Math.floor(this._viewportCached.y);this._currentRenderTarget||(i=this.getRenderHeight(true)-i-s),e?e.addItem(new Ct(t,i,r,s)):this._getCurrentRenderPass().setViewport(t,i,r,s,0,1),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log(["frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+this._currentPassIsMainPass()]));}_viewport(e,t,r,s){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=r,this._viewportCached.w=s;}_mustUpdateScissor(){const e=this._scissorCached.x,t=this._scissorCached.y,r=this._scissorCached.z,s=this._scissorCached.w,n=this._scissorsCurrent.x!==e||this._scissorsCurrent.y!==t||this._scissorsCurrent.w!==r||this._scissorsCurrent.h!==s;return n&&(this._scissorsCurrent.x=this._scissorCached.x,this._scissorsCurrent.y=this._scissorCached.y,this._scissorsCurrent.w=this._scissorCached.z,this._scissorsCurrent.h=this._scissorCached.w),n}_applyScissor(e){const t=this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y;e?e.addItem(new At(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w)):this._getCurrentRenderPass().setScissorRect(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log(["frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+this._currentPassIsMainPass()]));}_scissorIsActive(){return 0!==this._scissorCached.x||0!==this._scissorCached.y||0!==this._scissorCached.z||0!==this._scissorCached.w}enableScissor(e,t,r,s){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=r,this._scissorCached.w=s;}disableScissor(){this._scissorCached.x=this._scissorCached.y=this._scissorCached.z=this._scissorCached.w=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0;}_mustUpdateStencilRef(){const e=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent;return e&&(this._stencilRefsCurrent=this._stencilStateComposer.funcRef),e}_applyStencilRef(e){e?e.addItem(new It(this._stencilStateComposer.funcRef??0)):this._getCurrentRenderPass().setStencilReference(this._stencilStateComposer.funcRef??0);}_mustUpdateBlendColor(){const e=this._alphaState._blendConstants,t=e[0]!==this._blendColorsCurrent[0]||e[1]!==this._blendColorsCurrent[1]||e[2]!==this._blendColorsCurrent[2]||e[3]!==this._blendColorsCurrent[3];return t&&(this._blendColorsCurrent[0]=e[0],this._blendColorsCurrent[1]=e[1],this._blendColorsCurrent[2]=e[2],this._blendColorsCurrent[3]=e[3]),t}_applyBlendColor(e){e?e.addItem(new vt(this._alphaState._blendConstants.slice())):this._getCurrentRenderPass().setBlendConstant(this._alphaState._blendConstants);}_resetRenderPassStates(){this._viewportsCurrent.x=this._viewportsCurrent.y=this._viewportsCurrent.w=this._viewportsCurrent.h=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0,this._stencilRefsCurrent=-1,this._blendColorsCurrent[0]=this._blendColorsCurrent[1]=this._blendColorsCurrent[2]=this._blendColorsCurrent[3]=null;}clear(e,t,r,s=false,i=0){e&&void 0===e.a&&(e.a=1),s&&(this._clearStencilValue=i);const a=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log(["frame #"+this._count+" - clear - backBuffer=",t," depth=",r," stencil=",s," scissor is active=",a])),this._currentRenderTarget?a?(this._currentRenderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,false,t?e:null,r,s),this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,r,s)):(this._currentRenderPass&&this._endCurrentRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,true,t?e:null,r,s)):(this._currentRenderPass&&a||this._startMainRenderPass(!a,t?e:null,r,s),a&&(this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,r,s)));}_clearFullQuad(e,t,r){const s=this.compatibilityMode?this._getCurrentRenderPass():null;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(this._cacheRenderPipeline.mrtAttachments??[],this._cacheRenderPipeline.mrtTextureArray??[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?s.setStencilReference(this._clearStencilValue):this._bundleList.addItem(new It(this._clearStencilValue));const n=this._clearQuad.clear(s,e,t,r,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(null):(this._bundleList.addBundle(n),this._applyStencilRef(this._bundleList),this._reportDrawCall());}createVertexBuffer(e,t,r){let s;s=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e;return this._bufferManager.createBuffer(s,Y$1.Vertex|Y$1.CopyDst|Y$1.Storage,r)}createDynamicVertexBuffer(e,t){return this.createVertexBuffer(e,void 0,t)}createIndexBuffer(e,t,r){let s,n=true;if(e instanceof Uint32Array||e instanceof Int32Array)s=e;else if(e instanceof Uint16Array)s=e,n=false;else {for(let t=0;t<e.length;t++)if(e[t]>65535){s=new Uint32Array(e);break}s||(s=new Uint16Array(e),n=false);}const i=this._bufferManager.createBuffer(s,Y$1.Index|Y$1.CopyDst|Y$1.Storage,r);return i.is32Bits=n,i}updateDynamicIndexBuffer(e,t,r=0){const s=e;let n;n=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(s,r,n);}updateDynamicVertexBuffer(e,t,r,s){const n=e;let i;void 0===r&&(r=0),void 0===s?(i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,s=i.byteLength):i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(n,r,i,0,s);}_createBuffer(e,r,s){let n;n=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e;let i=0;return r&Qe$1.BUFFER_CREATIONFLAG_READ&&(i|=Y$1.CopySrc),r&Qe$1.BUFFER_CREATIONFLAG_WRITE&&(i|=Y$1.CopyDst),r&Qe$1.BUFFER_CREATIONFLAG_UNIFORM&&(i|=Y$1.Uniform),r&Qe$1.BUFFER_CREATIONFLAG_VERTEX&&(i|=Y$1.Vertex),r&Qe$1.BUFFER_CREATIONFLAG_INDEX&&(i|=Y$1.Index),r&Qe$1.BUFFER_CREATIONFLAG_STORAGE&&(i|=Y$1.Storage),r&Qe$1.BUFFER_CREATIONFLAG_INDIRECT&&(i|=Y$1.Indirect),this._bufferManager.createBuffer(n,i,s)}bindBuffersDirectly(){throw "Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw "Not implemented on WebGPU"}unbindInstanceAttributes(){}bindBuffers(e,t,r,s){this._currentVertexBuffers=e,this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=s??null,this._cacheRenderPipeline.setBuffers(this._currentVertexBuffers,this._currentIndexBuffer,this._currentOverrideVertexBuffers);}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createUniformBuffer(e,t){let r;r=e instanceof Array?new Float32Array(e):e;return this._bufferManager.createBuffer(r,Y$1.Uniform|Y$1.CopyDst,t)}createDynamicUniformBuffer(e,t){return this.createUniformBuffer(e,t)}updateUniformBuffer(e,t,r,s){ void 0===r&&(r=0);const n=e;let i;void 0===s?(i=t instanceof Float32Array?t:new Float32Array(t),s=i.byteLength):i=t instanceof Float32Array?t:new Float32Array(t),this._bufferManager.setSubData(n,r,i,0,s);}bindUniformBufferBase(e,t,r){this._currentDrawContext.setBuffer(r,e);}bindUniformBlock(){}createEffect(e,t,r,s,n,i,a,o,u,c=0,h){const l="string"==typeof e?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d="string"==typeof e?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,p=this._getGlobalDefines(),_=void 0!==t.attributes;let g=n??t.defines??"";p&&(g+="\n"+p);const f=l+"+"+d+"@"+g;if(this._compiledEffects[f]){const e=this._compiledEffects[f];return a&&e.isReady()&&a(e),e._refCount++,e}const m=new Nt$1(e,t,_?this:r,s,this,n,i,a,o,u,f,t.shaderLanguage??c,t.extraInitializationsAsync??h);return this._compiledEffects[f]=m,m}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,r,s){return this._compileRawShaderToSpirV(s+(r?r+"\n":"")+e,t)}_getWGSLShader(e,t,r){return (r=r?"//"+r.split("\n").join("\n//")+"\n":"")+e}_createPipelineStageDescriptor(e,t,r,s,n){return this._tintWASM&&0===r&&(e=this._tintWASM.convertSpirV2WGSL(e,s),t=this._tintWASM.convertSpirV2WGSL(t,n)),{vertexStage:{module:this._device.createShaderModule({label:"vertex",code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({label:"fragment",code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,r,s){const n=e.indexOf(Qe$1.DISABLEUA)>=0,i=r.indexOf(Qe$1.DISABLEUA)>=0,a=0===s?this._compileRawShaderToSpirV(e,"vertex"):e,o=0===s?this._compileRawShaderToSpirV(r,"fragment"):r;return this._createPipelineStageDescriptor(a,o,s,n,i)}_compilePipelineStageDescriptor(e,r,s,n){this.onBeforeShaderCompilationObservable.notifyObservers(this);const i=e.indexOf(Qe$1.DISABLEUA)>=0,a=r.indexOf(Qe$1.DISABLEUA)>=0,o="#version 450\n",u=0===n?this._compileShaderToSpirV(e,"vertex",s,o):this._getWGSLShader(e,"vertex",s),c=0===n?this._compileShaderToSpirV(r,"fragment",s,o):this._getWGSLShader(r,"fragment",s),h=this._createPipelineStageDescriptor(u,c,n,i,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),h}createRawShaderProgram(){throw "Not available on WebGPU"}createShaderProgram(){throw "Not available on WebGPU"}inlineShaderCode(e){const t=new Ot(e);return t.debug=false,t.processCode(),t.code}createPipelineContext(e){return new Fe(e,this)}createMaterialContext(){return new mt}createDrawContext(){return new bt(this._bufferManager,this._dummyIndexBuffer)}async _preparePipelineContextAsync(e,t,r,s,i,a,o,u,c,h,l){const d=e,p=d.shaderProcessingContext.shaderLanguage;0!==p||this._glslangAndTintAreFullyLoaded||await this.prepareGlslangAndTintAsync(),this.dbgShowShaderCode&&(Ie$2.Log(["defines",u]),Ie$2.Log(t),Ie$2.Log(r),Ie$2.Log("***********************************************")),d.sources={fragment:r,vertex:t,rawVertex:i,rawFragment:a},d.stages=s?this._compileRawPipelineStageDescriptor(t,r,p):this._compilePipelineStageDescriptor(t,r,u,p),l();}getAttributes(e,t){const r=new Array(t.length),s=e;for(let e=0;e<t.length;e++){const n=t[e],i=s.shaderProcessingContext.availableAttributes[n];void 0!==i&&(r[e]=i);}return r}enableEffect(e){if(e){if(or$1(e)){if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw Ie$2.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the effect property is empty!";return}if(this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw Ie$2.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the materialContext property is empty!"}else this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&Ie$2.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${"string"==typeof e.name?"":e.name.vertex}, effect.name.fragment=${"string"==typeof e.name?"":e.name.fragment}`,10);this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=false,this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect);}}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()));}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t);}this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this);}_deletePipelineContext(e){e&&Ft$1(e);}get needPOTTextures(){return  false}_createHardwareTexture(){return new Xe(this)}_releaseTexture(e){const t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e);}_getRGBABufferInternalSizedFormat(){return Qe$1.TEXTUREFORMAT_RGBA}updateTextureComparisonFunction(e,t){e._comparisonFunction=t;}_createInternalTexture(e,r,s=true,i=0){const a={};void 0!==r&&"object"==typeof r?(a.generateMipMaps=r.generateMipMaps,a.createMipMaps=r.createMipMaps,a.type=void 0===r.type?Qe$1.TEXTURETYPE_UNSIGNED_BYTE:r.type,a.samplingMode=void 0===r.samplingMode?Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE:r.samplingMode,a.format=void 0===r.format?Qe$1.TEXTUREFORMAT_RGBA:r.format,a.samples=r.samples??1,a.creationFlags=r.creationFlags??0,a.useSRGBBuffer=r.useSRGBBuffer??false,a.label=r.label):(a.generateMipMaps=r,a.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,a.samplingMode=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,a.format=Qe$1.TEXTUREFORMAT_RGBA,a.samples=1,a.creationFlags=0,a.useSRGBBuffer=false),(a.type!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering)&&(a.type!==Qe$1.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering)||(a.samplingMode=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE),a.type!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloat||(a.type=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,Ie$2.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const o=new zt(this,i),u=e.width??e,c=e.height??e,h=e.depth??0,l=e.layers??0;if(o.baseWidth=u,o.baseHeight=c,o.width=u,o.height=c,o.depth=h||l,o.isReady=true,o.samples=a.samples,o.generateMipMaps=!!a.generateMipMaps,o.samplingMode=a.samplingMode,o.type=a.type,o.format=a.format,o.is2DArray=l>0,o.is3D=h>0,o._cachedWrapU=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,o._cachedWrapV=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,o._useSRGBBuffer=a.useSRGBBuffer,o.label=a.label,this._internalTexturesCache.push(o),!s){const e=!a.generateMipMaps&&a.createMipMaps;e&&(o.generateMipMaps=true),this._textureHelper.createGPUTextureForInternalTexture(o,u,c,l||1,a.creationFlags),e&&(o.generateMipMaps=false);}return o}createTexture(e,r,s,n,i=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,a=null,o=null,u=null,c=null,h=null,l=null,d,p,_,g){return this._createTextureBase(e,r,s,n,i,a,o,((e,r,s,n,i,a,o,u)=>{const c=n;if(e.baseWidth=c.width,e.baseHeight=c.height,e.width=c.width,e.height=c.height,e.format=-1!==e.format?e.format:h??Qe$1.TEXTUREFORMAT_RGBA,e.type=-1!==e.type?e.type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,e._creationFlags=_??0,u(e.width,e.height,c,r,e,(()=>{})),e._hardwareTexture?.underlyingResource)a||o||this._generateMipmaps(e,this._uploadEncoder);else {const t=this._textureHelper.createGPUTextureForInternalTexture(e,c.width,c.height,void 0,_);W$1.IsImageBitmap(c)&&(this._textureHelper.updateTexture(c,e,c.width,c.height,e.depth,t.format,0,0,i,false,0,0),a||o||this._generateMipmaps(e,this._uploadEncoder));}s&&s.removePendingData(e),e.isReady=true,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear();}),(()=>false),u,c,h,l,d,p,g)}wrapWebGPUTexture(e){const t=new Xe(this,e),r=new zt(this,0,true);return r._hardwareTexture=t,r.isReady=true,r}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers}_unpackFlipY(e){}updateTextureSamplingMode(e,t,r=false){r&&(t.generateMipMaps=true,this._generateMipmaps(t)),t.samplingMode=e;}updateTextureWrappingMode(e,t,r=null,s=null){null!==t&&(e._cachedWrapU=t),null!==r&&(e._cachedWrapV=r),(e.is2DArray||e.is3D)&&null!==s&&(e._cachedWrapR=s);}updateTextureDimensions(e,t,r,s=1){if(!e._hardwareTexture)return;if(e.width===t&&e.height===r&&e.depth===s)return;const n=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,r,s,n);}_setInternalTexture(e,r,s){if(s=s??e,this._currentEffect){const n=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[s];if(this._currentMaterialContext.setTexture(e,r),n&&n.autoBindSampler){const e=s+Qe$1.AUTOSAMPLERSUFFIX;this._currentMaterialContext.setSampler(e,r);}}}createPrefilteredCubeTexture(e,t,r,s,n=null,i=null,a,o=null,u=true){return this.createCubeTexture(e,t,null,false,(e=>{if(!e)return void(n&&n(null));const t=e.texture;u?e.info.sphericalPolynomial&&(t._sphericalPolynomial=e.info.sphericalPolynomial):t._sphericalPolynomial=new Xa,t._source=9,n&&n(t);}),i,a,o,u,r,s)}setTexture(e,t,r,s){this._setTexture(e,r,false,false,s,s);}setTextureArray(e,t,r,s){for(let e=0;e<r.length;e++)this._setTexture(-1,r[e],true,false,s+e.toString(),s);}_setTexture(e,r,s=false,i=false,a="",o){if(o=o??a,this._currentEffect){if(!r)return this._currentMaterialContext.setTexture(a,null),false;if(r.video)r.update();else if(r.delayLoadState===Qe$1.DELAYLOADSTATE_NOTLOADED)return r.delayLoad(),false;let e=null;if(e=i?r.depthStencilTexture:r.isReady()?r.getInternalTexture():r.isCube?this.emptyCubeTexture:r.is3D?this.emptyTexture3D:r.is2DArray?this.emptyTexture2DArray:this.emptyTexture,e&&!e.isMultiview){if(e.isCube&&e._cachedCoordinatesMode!==r.coordinatesMode){e._cachedCoordinatesMode=r.coordinatesMode;const s=r.coordinatesMode!==Qe$1.TEXTURE_CUBIC_MODE&&r.coordinatesMode!==Qe$1.TEXTURE_SKYBOX_MODE?Qe$1.TEXTURE_WRAP_ADDRESSMODE:Qe$1.TEXTURE_CLAMP_ADDRESSMODE;r.wrapU=s,r.wrapV=s;}e._cachedWrapU=r.wrapU,e._cachedWrapV=r.wrapV,e.is3D&&(e._cachedWrapR=r.wrapR),this._setAnisotropicLevel(0,e,r.anisotropicFilteringLevel);}this._setInternalTexture(a,e,o);}else this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log(["frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",r]));return  true}_setAnisotropicLevel(e,t,r){t._cachedAnisotropicFilteringLevel!==r&&(t._cachedAnisotropicFilteringLevel=Math.min(r,this._caps.maxAnisotropy));}_bindTexture(e,t,r){ void 0!==e&&this._setInternalTexture(r,t);}generateMipmaps(e){this._generateMipmaps(e);}updateTextureData(e,t,r,s,n,i,a=0,o=0,u=false){let c=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(e));const h=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(h,e,n,i,e.depth,c.format,a,o,e.invertY,false,r,s),u&&this._generateMipmaps(e);}_uploadCompressedDataToTextureDirectly(e,t,r,s,n,i=0,a=0){let o=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(e.format=t,o=this._textureHelper.createGPUTextureForInternalTexture(e,r,s));const u=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);this._textureHelper.updateTexture(u,e,r,s,e.depth,o.format,i,a,false,false,0,0);}_uploadDataToTextureDirectly(e,t,r=0,s=0,n,i=false){const a=Math.round(Math.log(e.width)*Math.LOG2E),o=Math.round(Math.log(e.height)*Math.LOG2E),u=i?e.width:Math.pow(2,Math.max(a-s,0)),c=i?e.height:Math.pow(2,Math.max(o-s,0));let h=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(e,u,c));const l=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(l,e,u,c,e.depth,h.format,r,s,e.invertY,false,0,0);}_uploadArrayBufferViewToTexture(e,t,r=0,s=0){this._uploadDataToTextureDirectly(e,t,r,s);}_uploadImageToTexture(e,t,r=0,s=0){let n=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(n=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw "WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";const i=t,a=Math.ceil(e.width/(1<<s)),o=Math.ceil(e.height/(1<<s));this._textureHelper.updateTexture(i,e,a,o,e.depth,n.format,r,s,e.invertY,false,0,0);}readPixels(e,t,r,s,n=true,i=true,a=null){const o=this._getCurrentRenderPassWrapper().colorAttachmentGPUTextures[0];if(!o)return Promise.resolve(new Uint8Array(0));const u=o.underlyingResource,c=o.format;return u?(i&&this.flushFramebuffer(),this._textureHelper.readPixels(u,e,t,r,s,c,void 0,void 0,a)):Promise.resolve(new Uint8Array(0))}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0;}get performanceMonitor(){return this._performanceMonitor}beginFrame(){this._measureFps(),super.beginFrame();}endFrame(){if(this._endCurrentRenderPass(),this._snapshotRendering.endFrame(),this._timestampQuery.endFrame(this._renderEncoder),this._timestampIndex=0,this.flushFramebuffer(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const e=[];for(const t in cs._UpdatedUbosInFrame)e.push(t+":"+cs._UpdatedUbosInFrame[t]);Ie$2.Log(["frame #"+this._count+" - updated ubos -",e.join(", ")]);}cs._UpdatedUbosInFrame={};}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&Ie$2.Log(["%c frame #"+this._count+" - end","background: #ffff00"]),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&Ie$2.Log(["%c frame #"+this._count+" - begin","background: #ffff00"]))),super.endFrame();}extractDriverInfo(){return ""}flushFramebuffer(){this._endCurrentRenderPass(),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset();}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentPassIsMainPass()}_startRenderTargetRenderPass(e,r,s,i,a){this._endCurrentRenderPass();const o=e,u=o._depthStencilTexture,c=u?._hardwareTexture,h=c?.underlyingResource,l=c?.getMSAATexture(0),d=h?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),p=l?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),_=!!c&&W$1.HasStencilAspect(c.format),g=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const f=qt;s&&(f.r=255*s.r,f.g=255*s.g,f.b=255*s.b,f.a=255*s.a);const m=r&&s,b=r&&i,x=r&&a;if(o._attachments&&o.isMulti){this._mrtAttachments&&0!==this._mrtAttachments.length||(this._mrtAttachments=o._defaultAttachments);for(let e=0;e<this._mrtAttachments.length;++e){const r=this._mrtAttachments[e],n=o.textures[e],i=n?._hardwareTexture,a=i?.underlyingResource;if(i&&a){const u=o.getBaseArrayLayer(e),c=i.getMSAATexture(u),h={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:n.is3D?"3d":"2d",format:i.format,baseArrayLayer:u},l={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:n.is3D?"3d":"2d",format:i.format,baseArrayLayer:0},d=n.type===Qe$1.TEXTURETYPE_UNSIGNED_INTEGER||n.type===Qe$1.TEXTURETYPE_UNSIGNED_SHORT,p=a.createView(h),_=c?.createView(l);g.push({view:_||p,resolveTarget:c?p:void 0,depthSlice:n.is3D?o.layerIndices?.[e]??0:void 0,clearValue:0!==r&&m?d?f:s:void 0,loadOp:0!==r&&m?"clear":"load",storeOp:"store"});}}this._cacheRenderPipeline.setMRT(o.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments);}else {const e=o.texture;if(e){const r=e._hardwareTexture,n=r.underlyingResource;let i;o.is3D&&(i=this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer,this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer=0);const a=r.getMSAATexture(0),u=n.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),c=a?.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),h=e.type===Qe$1.TEXTURETYPE_UNSIGNED_INTEGER||e.type===Qe$1.TEXTURETYPE_UNSIGNED_SHORT;g.push({view:c||u,resolveTarget:a?u:void 0,depthSlice:i,clearValue:m?h?f:s:void 0,loadOp:m?"clear":"load",storeOp:"store"});}else g.push(null);}if(this._debugPushGroup?.("render target pass"+(e.label?" ("+e.label+")":""),0),this._rttRenderPassWrapper.renderPassDescriptor={label:(e.label??"RTT")+" - RenderPass",colorAttachments:g,depthStencilAttachment:u&&h?{view:p||d,depthClearValue:b?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:o.depthReadOnly?void 0:b?"clear":"load",depthStoreOp:o.depthReadOnly?void 0:"store",depthReadOnly:o.depthReadOnly,stencilClearValue:o._depthStencilTextureWithStencil&&x?this._clearStencilValue:void 0,stencilLoadOp:o.stencilReadOnly?void 0:_?o._depthStencilTextureWithStencil&&x?"clear":"load":void 0,stencilStoreOp:o.stencilReadOnly?void 0:_?"store":void 0,stencilReadOnly:o.stencilReadOnly}:void 0,occlusionQuerySet:this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0},this._timestampQuery.startPass(this._rttRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const t=o.texture;Ie$2.Log(["frame #"+this._count+" - render target begin pass - rtt name="+e.label+", internalTexture.uniqueId="+t.uniqueId+", width="+t.width+", height="+t.height+", setClearStates="+r,"renderPassDescriptor=",this._rttRenderPassWrapper.renderPassDescriptor]);}this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),c&&W$1.HasStencilAspect(c.format)||(this._stencilStateComposer.enabled=false);}_startMainRenderPass(e,t,r,s){this._endCurrentRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const i=e&&t,a=e&&r,o=e&&s;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=i?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=i?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=a?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=a?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=o?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?o?"clear":"load":void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0;const u=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(u),this._options.antialias?(Ht.format=u.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=u.createView(Ht)):(Yt.format=u.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=u.createView(Yt)),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log(["frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height+", setClearStates="+e,"renderPassDescriptor=",this._mainRenderPassWrapper.renderPassDescriptor])),this._debugPushGroup?.("main pass",0),this._timestampQuery.startPass(this._mainRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper),this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),this._isStencilEnable||(this._stencilStateComposer.enabled=false);}bindFramebuffer(e,t=0,r,s,i,a=0,o=0){const u=e.texture?._hardwareTexture;this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass(),this._currentRenderTarget=e;const c=this._currentRenderTarget._depthStencilTexture;this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=u,this._rttRenderPassWrapper.depthTextureFormat=c?W$1.GetWebGPUTextureFormat(-1,c.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:e.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:e.isCube?6*o+t:o,baseMipLevel:a,arrayLayerCount:1,aspect:"all"},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:c&&c.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:c?c.isCube?6*o+t:o:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"},this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log(["frame #"+this._count+" - bindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId="+e.texture?.uniqueId+", face="+t+", lodLevel="+a+", layer="+o,"colorAttachmentViewDescriptor=",this._rttRenderPassWrapper.colorAttachmentViewDescriptor,"depthAttachmentViewDescriptor=",this._rttRenderPassWrapper.depthAttachmentViewDescriptor])),(this._snapshotRendering.play||this._snapshotRendering.record)&&this._startRenderTargetRenderPass(this._currentRenderTarget,false,null,false,false),this._cachedViewport&&!i?this.setViewport(this._cachedViewport,r,s):(r||(r=e.width,a&&(r/=Math.pow(2,a))),s||(s=e.height,a&&(s/=Math.pow(2,a))),this._viewport(0,0,r,s)),this.wipeCaches();}unBindFramebuffer(e,t=false,r){const s=this._currentRenderTarget;this._currentRenderTarget=null,r&&r(),this._currentRenderTarget=s,this._endCurrentRenderPass(),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e)),this._currentRenderTarget=null,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&Ie$2.Log("frame #"+this._count+" - unBindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId=",e.texture?.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments);}generateMipMapsFramebuffer(e){e.isMulti||!e.texture?.generateMipMaps||e.isCube||this._generateMipmaps(e.texture);}resolveFramebuffer(e){throw new Error("resolveFramebuffer is not yet implemented in WebGPU!")}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._currentRenderPass||this._startMainRenderPass(false),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches();}_setColorFormat(e){const t=e.colorAttachmentGPUTextures[0]?.format??null;this._cacheRenderPipeline.setColorFormat(t),this._colorFormat!==t&&(this._colorFormat=t);}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat);}setDitheringState(){}setRasterizerState(){}_executeWhenRenderingStateIsCompiled(e,t){t();}bindSamplers(){}_getUnpackAlignement(){return 1}_bindTextureDirectly(){return  false}setStateCullFaceType(e,t=false){const r=this.cullBackFaces??e??1?1:2;(this._depthCullingState.cullFace!==r||t)&&(this._depthCullingState.cullFace=r);}setState(e,t=0,r,s=false,n,i,a=0){(this._depthCullingState.cull!==e||r)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(n,r),this.setZOffset(t),this.setZOffsetUnits(a);const o=s?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==o||r)&&(this._depthCullingState.frontFace=o),this._stencilStateComposer.stencilMaterial=i;}_applyRenderPassChanges(e){const t=!!this._stencilStateComposer.enabled&&this._mustUpdateStencilRef(),r=!!this._alphaState.alphaBlend&&this._mustUpdateBlendColor();this._mustUpdateViewport()&&this._applyViewport(e),this._mustUpdateScissor()&&this._applyScissor(e),t&&this._applyStencilRef(e),r&&this._applyBlendColor(e);}_draw(e,r,s,n,i){const a=this._getCurrentRenderPass(),o=this._bundleList;this.applyStates();const u=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,Be.InternalsUBOName),this._currentDrawContext.setVertexPulling(this._currentMaterialContext.useVertexPulling,u,this._currentVertexBuffers,this._cacheRenderPipeline.indexBuffer,this._currentOverrideVertexBuffers),u.uniformBuffer&&(u.uniformBuffer.update(),this.bindUniformBufferBase(u.uniformBuffer.getBuffer(),0,Be.LeftOvertUBOName)),this._snapshotRendering.play)return void this._reportDrawCall();!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);let c=a;if(!this.compatibilityMode&&this._currentDrawContext.fastBundle||this._snapshotRendering.record){if(this._applyRenderPassChanges(o),!this._snapshotRendering.record)return this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(n,i||1,s),o.addBundle(this._currentDrawContext.fastBundle),void this._reportDrawCall();c=o.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),o.numDrawCalls++;}let h=0;if(this._currentMaterialContext.hasFloatOrDepthTextures){let e=1;for(let r=0;r<u.shaderProcessingContext.textureNames.length;++r){const s=u.shaderProcessingContext.textureNames[r],n=this._currentMaterialContext.textures[s]?.texture,i=n&&n.format>=Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8&&n.format<=Qe$1.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8;(n?.type===Qe$1.TEXTURETYPE_FLOAT&&!this._caps.textureFloatLinearFiltering||i)&&(h|=e),e<<=1;}}this._currentMaterialContext.textureState=h;const l=this._cacheRenderPipeline.getRenderPipeline(r,this._currentEffect,this.currentSampleCount,h),d=this._cacheBindGroups.getBindGroups(u,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(this.compatibilityMode?null:o),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,c=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:W$1.GetSample(this.currentSampleCount)}))),c.setPipeline(l),this._currentIndexBuffer&&c.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?"uint32":"uint16",0);const p=this._cacheRenderPipeline.vertexBuffers;for(let e=0;e<p.length;e++){const t=p[e],r=t.effectiveBuffer;r&&c.setVertexBuffer(e,r.underlyingResource,t._validOffsetRange?0:t.byteOffset);}for(let e=0;e<d.length;e++)c.setBindGroup(e,d[e]);const _=!this.compatibilityMode&&!this._snapshotRendering.record;(_||this._currentDrawContext._enableIndirectDrawInCompatMode)&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(n,i||1,s),0===e?c.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):c.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):0===e?c.drawIndexed(n,i||1,s,0,0):c.draw(n,i||1,s,0),_&&(this._currentDrawContext.fastBundle=c.finish(),o.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall();}drawElementsType(e,t,r,s=1){this._draw(0,e,t,r,s);}drawArraysType(e,t,r,s=1){this._currentIndexBuffer=null,this._draw(1,e,t,r,s);}dispose(){this._isDisposed=true,this.hideLoadingUI(),this._timestampQuery.dispose(),this._mainTexture?.destroy(),this._depthTexture?.destroy(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._device.destroy(),Ya(this,this._renderingCanvas),super.dispose();}getRenderWidth(e=false){return !e&&this._currentRenderTarget?this._currentRenderTarget.width:this._renderingCanvas?.width??0}getRenderHeight(e=false){return !e&&this._currentRenderTarget?this._currentRenderTarget.height:this._renderingCanvas?.height??0}getError(){return 0}createExternalTexture(e){return new Vt(e)}setExternalTexture(e,t){t?this._setInternalTexture(e,t):this._currentMaterialContext.setTexture(e,null);}setTextureSampler(e,t){this._currentMaterialContext?.setSampler(e,t);}createStorageBuffer(e,r,s){return this._createBuffer(e,r|Qe$1.BUFFER_CREATIONFLAG_STORAGE,s)}clearStorageBuffer(e,t,r){this._renderEncoder.clearBuffer(e.underlyingResource,t,r);}updateStorageBuffer(e,t,r,s){const n=e;let i;void 0===r&&(r=0),void 0===s?(i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,s=i.byteLength):i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(n,r,i,0,s);}async _readFromGPUBuffer(e,t,r,s){return await new Promise(((n,i)=>{const a=()=>{e.mapAsync(1,0,t).then((()=>{const s=e.getMappedRange(0,t);let i=r;if(void 0===i)i=new Uint8Array(t),i.set(new Uint8Array(s));else {const e=i.constructor;i=new e(i.buffer),i.set(new e(s));}e.unmap(),this._bufferManager.releaseBuffer(e),n(i);}),(e=>{this.isDisposed?n(new Uint8Array):i(e);}));};s?(this.flushFramebuffer(),a()):this.onEndFrameObservable.addOnce((()=>{a();}));}))}readFromStorageBuffer(e,t,r,s,n){r=r||e.capacity;const i=this._bufferManager.createRawBuffer(r,Y$1.MapRead|Y$1.CopyDst,void 0,"TempReadFromStorageBuffer");return this._renderEncoder.copyBufferToBuffer(e.underlyingResource,t??0,i,0,r),this._readFromGPUBuffer(i,r,s,n)}readFromMultipleStorageBuffers(e,t,r,s,n){r=r||e[0].capacity;const i=this._bufferManager.createRawBuffer(r*e.length,Y$1.MapRead|Y$1.CopyDst,void 0,"TempReadFromMultipleStorageBuffers");for(let s=0;s<e.length;s++)this._renderEncoder.copyBufferToBuffer(e[s].underlyingResource,t??0,i,s*r,r);return this._readFromGPUBuffer(i,r*e.length,s,n)}setStorageBuffer(e,t){this._currentDrawContext?.setBuffer(e,t?.getBuffer()??null);}}Qt._GlslangDefaultOptions={jsPath:`${Ai._DefaultCdnUrl}/glslang/glslang.js`,wasmPath:`${Ai._DefaultCdnUrl}/glslang/glslang.wasm`},Qt._InstanceId=0;
var webgpuEngine5o0Cwobe_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,WebGPUEngine:Qt});Qt.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=false,r){r&&r(),this._endCurrentRenderPass(),t||this.generateMipMapsMultiFramebuffer(e),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments);},Qt.prototype.createMultipleRenderTarget=function(s,n,a){let i=false,p=true,u=false,o=false,T=Qe$1.TEXTUREFORMAT_DEPTH16,l=1,c=1;const h=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,m=Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,E=Qe$1.TEXTUREFORMAT_RGBA,_=Qe$1.TEXTURE_2D;let R=[],d=[],f=[],M=[],A=[],g=[],x=[],S=[],D=[],F=[],U=false;const b=this._createHardwareRenderTargetWrapper(true,false,s);void 0!==n&&(i=n.generateMipMaps??false,p=n.generateDepthBuffer??true,u=n.generateStencilBuffer??false,o=n.generateDepthTexture??false,l=n.textureCount??1,T=n.depthTextureFormat??Qe$1.TEXTUREFORMAT_DEPTH16,R=n.types||R,d=n.samplingModes||d,f=n.useSRGBBuffers||f,M=n.formats||M,A=n.targetTypes||A,g=n.faceIndex||g,x=n.layerIndex||x,S=n.layerCounts||S,D=n.labels||D,F=n.creationFlags||F,c=n.samples??c,U=n.dontCreateTextures??false);const y=s.width??s,P=s.height??s,X=[],L=[],B=[];b.label=n?.label??"MultiRenderTargetWrapper",b._generateDepthBuffer=p,b._generateStencilBuffer=u,b._attachments=L,b._defaultAttachments=B;let C=null;(p||u||o)&&!U&&(o||(T=p&&u?Qe$1.TEXTUREFORMAT_DEPTH24_STENCIL8:p?Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT:Qe$1.TEXTUREFORMAT_STENCIL8),C=b.createDepthStencilTexture(0,false,u,1,T,b.label+"-DepthStencil"));const O=void 0!==n&&"object"==typeof n&&n.createMipMaps&&!i;for(let s=0;s<l;s++){let n=d[s]||m,p=R[s]||h;const u=M[s]||E,o=!!f[s]&&this._caps.supportSRGBBuffers,T=A[s]||_,l=S[s]??1,c=F[s];if((p!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering)&&(p!==Qe$1.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering)||(n=Qe$1.TEXTURE_NEAREST_SAMPLINGMODE),p!==Qe$1.TEXTURETYPE_FLOAT||this._caps.textureFloat||(p=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,Ie$2.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),L.push(s+1),B.push(a?s+1:0===s?1:0),-1===T||U)continue;const g=new zt(this,6);switch(X[s]=g,T){case Qe$1.TEXTURE_CUBE_MAP:g.isCube=true;break;case Qe$1.TEXTURE_3D:g.is3D=true,g.baseDepth=g.depth=l;break;case Qe$1.TEXTURE_2D_ARRAY:g.is2DArray=true,g.baseDepth=g.depth=l;}g.baseWidth=y,g.baseHeight=P,g.width=y,g.height=P,g.isReady=true,g.samples=1,g.generateMipMaps=i,g.samplingMode=n,g.type=p,g._cachedWrapU=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,g._cachedWrapV=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,g._useSRGBBuffer=o,g.format=u,g.label=D[s]??b.label+"-Texture"+s,this._internalTexturesCache.push(g),O&&(g.generateMipMaps=true),this._textureHelper.createGPUTextureForInternalTexture(g,void 0,void 0,void 0,c,true),O&&(g.generateMipMaps=false);}return C&&(C.incrementReferences(),X[l]=C,this._internalTexturesCache.push(C)),b.setTextures(X),b.setLayerAndFaceIndices(x,g),U?b._samples=c:this.updateMultipleRenderTargetTextureSampleCount(b,c),b},Qt.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(!e||!e.textures||0===e.textures.length||e.textures[0].samples===t)return t;const r=e.textures.length;if(0===r)return 1;t=Math.min(t,this.getCaps().maxMSAASamples);for(let t=0;t<r;++t){const r=e.textures[t]._hardwareTexture;r?.releaseMSAATexture(e.getBaseArrayLayer(t));}const s=e._depthStencilTexture===e.textures[r-1];for(let s=0;s<r;++s){const r=e.textures[s];this._textureHelper.createMSAATexture(r,t,false,e.getBaseArrayLayer(s)),r.samples=t;}return e._depthStencilTexture&&!s&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,t},Qt.prototype.generateMipMapsMultiFramebuffer=function(e){const t=e;if(!t.isMulti)return;const r=t._attachments.length;for(let e=0;e<r;e++){const r=t.textures[e];!r.generateMipMaps||r.isCube||r.is3D||this._generateMipmaps(r);}},Qt.prototype.resolveMultiFramebuffer=function(e){throw new Error("resolveMultiFramebuffer is not yet implemented in WebGPU!")},Qt.prototype.bindAttachments=function(e){0!==e.length&&this._currentRenderTarget&&(this._mrtAttachments=e,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(e));},Qt.prototype.buildTextureLayout=function(e,t=false){const r=[];if(t)r.push(1);else for(let t=0;t<e.length;t++)e[t]?r.push(t+1):r.push(0);return r},Qt.prototype.restoreSingleAttachment=function(){},Qt.prototype.restoreSingleAttachmentForRenderTarget=function(){};var engine_multiRenderCrzbKH2j_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});let x$3=class x{constructor(t){this.name=cr$1.NAME_PROCEDURALTEXTURE,this.scene=t;}register(){this.scene._beforeClearStage.registerStep(cr$1.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear);}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){Ai.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render();}Ai.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);}}};let E$6=class E extends Is{get shaderLanguage(){return this._shaderLanguage}constructor(t,o,c,_,d=null,f=true,u=false,l=Qe$1.TEXTURETYPE_UNSIGNED_BYTE){super(null,_,!f),this.isEnabled=true,this.autoClear=true,this.onGeneratedObservable=new R$g,this.onBeforeGenerationObservable=new R$g,this.nodeMaterialSource=null,this.defines="",this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=false,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,null===d||d instanceof Is?(this._options={},this._fallbackTexture=d):(this._options=d,this._fallbackTexture=d.fallbackTexture??null),this._shaderLanguage=this._options.shaderLanguage??0;let p=(_=this.getScene()||L$7.LastCreatedScene)._getComponent(cr$1.NAME_PROCEDURALTEXTURE);p||(p=new x$3(_),_._addComponent(p)),_.proceduralTextures.push(this),this._fullEngine=_.getEngine(),this.name=t,this.isRenderTarget=true,this._size=o,this._textureType=l,this._generateMipMaps=f,this._drawWrapper=new $i(this._fullEngine),this.setFragment(c);const m=this._createRtWrapper(u,o,f,l);this._texture=m.texture;const T=[];T.push(1,1),T.push(-1,1),T.push(-1,-1),T.push(1,-1),this._vertexBuffers[Hi.PositionKind]=new Hi(this._fullEngine,T,Hi.PositionKind,false,false,2),this._createIndexBuffer();}_createRtWrapper(e,t,s,i){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:s,generateDepthBuffer:false,generateStencilBuffer:false,type:i,...this._options}),this.setFloat("face",0)):(this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:s,generateDepthBuffer:false,generateStencilBuffer:false,type:i,...this._options}),this._rtWrapper.is3D&&(this.setFloat("layer",0),this.setInt("layerNum",0))),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e;}getContent(){return this._contentData&&this._frameId===this._contentUpdateId||(this._contentData?this._contentData.then((e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId;})):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId)),this._contentData}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t);}_rebuild(){const e=this._vertexBuffers[Hi.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===ua.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=ua.REFRESHRATE_RENDER_ONCE);}reset(){this._drawWrapper.effect?.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null;}_getDefines(){return this.defines}executeWhenReady(e){if(this.isReady())return void e(this);const t=this.getEffect();t&&t.executeWhenCompiled((()=>{e(this);}));}isReady(){const e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return  false;if(this._fallbackTextureUsed)return  true;if(!this._texture)return  false;const t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return  true;const s={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:"string"==typeof this._fragment?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(s,[Hi.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,(()=>{this._rtWrapper?.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=true;}),void 0,this._shaderLanguage,(async()=>{this._options.extraInitializationsAsync?1===this.shaderLanguage?await Promise.all([Promise.resolve().then(function(){return procedural_vertexBhoqu3O__esm_min}),this._options.extraInitializationsAsync()]):await Promise.all([Promise.resolve().then(function(){return procedural_vertexHcWx5UqO_esm_min}),this._options.extraInitializationsAsync()]):1===this.shaderLanguage?await Promise.resolve().then(function(){return procedural_vertexBhoqu3O__esm_min}):await Promise.resolve().then(function(){return procedural_vertexHcWx5UqO_esm_min});}))),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1;}setFragment(e){this._fragment=e;}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter();}_shouldRender(){return this.isEnabled&&this.isReady()&&this._texture?!this._fallbackTextureUsed&&(-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,true):(this._currentRefreshId++,false)):(this._texture&&(this._texture.isReady=false),false)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const s=this._texture.isCube;this._rtWrapper.dispose();const i=this._createRtWrapper(s,e,t,this._textureType);this._texture=i.texture,this._size=e,this._generateMipMaps=t;}_checkUniform(e){ -1===this._uniforms.indexOf(e)&&this._uniforms.push(e);}setTexture(e,t){return  -1===this._samplers.indexOf(e)&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){const t=this.getScene();if(!t)return;const s=this._fullEngine;if(s.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),s.setState(false),!this.nodeMaterialSource){for(const e in this._textures)this._drawWrapper.effect.setTexture(e,this._textures[e]);for(const e in this._ints)this._drawWrapper.effect.setInt(e,this._ints[e]);for(const e in this._floats)this._drawWrapper.effect.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)this._drawWrapper.effect.setArray(e,this._floatsArrays[e]);for(const e in this._colors3)this._drawWrapper.effect.setColor3(e,this._colors3[e]);for(const e in this._colors4){const t=this._colors4[e];this._drawWrapper.effect.setFloat4(e,t.r,t.g,t.b,t.a);}for(const e in this._vectors2)this._drawWrapper.effect.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)this._drawWrapper.effect.setVector3(e,this._vectors3[e]);for(const e in this._vectors4)this._drawWrapper.effect.setVector4(e,this._vectors4[e]);for(const e in this._matrices)this._drawWrapper.effect.setMatrix(e,this._matrices[e]);}if(!this._texture||!this._rtWrapper)return;s._debugPushGroup?.(`procedural texture generation for ${this.name}`,1);const i=s.currentViewport;if(this.isCube)for(let e=0;e<6;e++)s.bindFramebuffer(this._rtWrapper,e,void 0,void 0,true),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",e),this.autoClear&&s.clear(t.clearColor,true,false,false),s.drawElementsType(hr$1.TriangleFillMode,0,6),s.unBindFramebuffer(this._rtWrapper,true);else {let e=1;this._rtWrapper.is3D?e=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(e=this._rtWrapper.layers);for(let i=0;i<e;i++){if(s.bindFramebuffer(this._rtWrapper,0,void 0,void 0,true,0,i),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._rtWrapper.is3D||this._rtWrapper.is2DArray){this._drawWrapper.effect?.setFloat("layer",1!==e?i/(e-1):0),this._drawWrapper.effect?.setInt("layerNum",i);for(const e in this._textures)this._drawWrapper.effect.setTexture(e,this._textures[e]);}this.autoClear&&s.clear(t.clearColor,true,false,false),s.drawElementsType(hr$1.TriangleFillMode,0,6),s.unBindFramebuffer(this._rtWrapper,!this._generateMipMaps);}}i&&s.setViewport(i),this.isCube&&s.generateMipMapsForCubemap(this._texture,true),s._debugPopGroup?.(1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this);}clone(){const e=this.getSize(),t=new E(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const s=this._vertexBuffers[Hi.PositionKind];s&&(s.dispose(),this._vertexBuffers[Hi.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose();}};e$z([a$$()],E$6.prototype,"isEnabled",void 0),e$z([a$$()],E$6.prototype,"autoClear",void 0),e$z([a$$()],E$6.prototype,"_generateMipMaps",void 0),e$z([a$$()],E$6.prototype,"_size",void 0),e$z([a$$()],E$6.prototype,"refreshRate",null),P$9("BABYLON.ProceduralTexture",E$6);let R$4=class R{get isSupported(){const e=L$7.LastCreatedEngine;return !!e&&e.getCaps().texelFetch}get iblSource(){return this._iblSource}set iblSource(e){this._iblSource!==e&&(this._disposeTextures(),this._iblSource=e,e&&(e.isCube,e.isReadyOrNotBlocking()?this._recreateAssetsFromNewIbl():e.onLoadObservable.addOnce(this._recreateAssetsFromNewIbl.bind(this,e))));}_recreateAssetsFromNewIbl(){this._debugPass&&this._debugPass.dispose(),this._createTextures(),this._debugPass&&this._createDebugPass();}getIcdfTexture(){return this._icdfPT?this._icdfPT:this._dummyTexture}setDebugDisplayParams(e,t,s,i){this._debugSizeParams.set(e,t,s,i);}get debugPassName(){return this._debugPassName}getDebugPassPP(){return this._debugPass||this._createDebugPass(),this._debugPass}constructor(e){if(this._cachedDominantDirection=null,this.debugEnabled=false,this._debugSizeParams=new ie$5(0,0,1,1),this._debugPassName="CDF Debug",this.onGeneratedObservable=new R$g,e?R._IsScene(e)?this._scene=e:this._engine=e:this._scene=L$7.LastCreatedScene,this._scene&&(this._engine=this._scene.getEngine()),!this.isSupported)return void Ie$2.Warn("CDF renderer is not supported by the current engine.");const t=new Uint16Array([0,0,0,255]);this._dummyTexture=new E$f(t,1,1,eo.TEXTUREFORMAT_RGBA,e,false,false,void 0,Qe$1.TEXTURETYPE_HALF_FLOAT),this._scene&&R._SceneComponentInitialization(this._scene);}_createTextures(){const e=this._iblSource?{width:this._iblSource.getSize().width,height:this._iblSource.getSize().height}:{width:1,height:1};this._iblSource||(this._iblSource=E$f.CreateRTexture(new Uint8Array([255]),1,1,this._engine,false,false,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,Qe$1.TEXTURETYPE_UNSIGNED_BYTE),this._iblSource.name="Placeholder IBL Source"),this._iblSource.isCube&&(e.width*=4,e.height*=2,e.width=1<<Math.floor(Math.log2(e.width)),e.height=1<<Math.floor(Math.log2(e.height)));const t=this._engine.isWebGPU,s={generateDepthBuffer:false,generateMipMaps:false,format:Qe$1.TEXTUREFORMAT_R,type:Qe$1.TEXTURETYPE_FLOAT,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,shaderLanguage:t?1:0,gammaSpace:false,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(function(){return iblCdfx_fragmentB5Qp7HtS_esm_min}),Promise.resolve().then(function(){return iblCdfy_fragmentKcR2Fpoi_esm_min}),Promise.resolve().then(function(){return iblScaledLuminance_fragmentBTEndz_6_esm_min})]):await Promise.all([Promise.resolve().then(function(){return iblCdfx_fragmentVVOoHHS3_esm_min}),Promise.resolve().then(function(){return iblCdfy_fragment3csxd3h__esm_min}),Promise.resolve().then(function(){return iblScaledLuminance_fragmentBzwxsT1g_esm_min})]);}},r={generateDepthBuffer:false,generateMipMaps:false,format:Qe$1.TEXTUREFORMAT_RGBA,type:Qe$1.TEXTURETYPE_HALF_FLOAT,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,shaderLanguage:t?1:0,gammaSpace:false,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(function(){return iblIcdf_fragmentC6DaWXw3_esm_min}),Promise.resolve().then(function(){return iblDominantDirection_fragmentGGCwAYT_esm_min})]):await Promise.all([Promise.resolve().then(function(){return iblIcdf_fragmentVY_BFJ58_esm_min}),Promise.resolve().then(function(){return iblDominantDirection_fragmentB8kQcVh1_esm_min})]);}};this._cdfyPT=new E$6("cdfyTexture",{width:e.width,height:e.height+1},"iblCdfy",this._scene,s,false,false),this._cdfyPT.autoClear=false,this._cdfyPT.setTexture("iblSource",this._iblSource),this._cdfyPT.setInt("iblHeight",e.height),this._cdfyPT.wrapV=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,this._cdfyPT.refreshRate=0,this._iblSource.isCube&&(this._cdfyPT.defines="#define IBL_USE_CUBE_MAP\n"),this._cdfxPT=new E$6("cdfxTexture",{width:e.width+1,height:1},"iblCdfx",this._scene,s,false,false),this._cdfxPT.autoClear=false,this._cdfxPT.setTexture("cdfy",this._cdfyPT),this._cdfxPT.refreshRate=0,this._cdfxPT.wrapU=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,this._scaledLuminancePT=new E$6("iblScaledLuminance",{width:e.width,height:e.height},"iblScaledLuminance",this._scene,{...s,samplingMode:Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,generateMipMaps:true},true,false),this._scaledLuminancePT.autoClear=false,this._scaledLuminancePT.setTexture("iblSource",this._iblSource),this._scaledLuminancePT.setInt("iblHeight",e.height),this._scaledLuminancePT.setInt("iblWidth",e.width),this._scaledLuminancePT.refreshRate=0,this._iblSource.isCube&&(this._scaledLuminancePT.defines="#define IBL_USE_CUBE_MAP\n"),this._icdfPT=new E$6("icdfTexture",{width:e.width,height:e.height},"iblIcdf",this._scene,r,false,false),this._icdfPT.autoClear=false,this._icdfPT.setTexture("cdfy",this._cdfyPT),this._icdfPT.setTexture("cdfx",this._cdfxPT),this._icdfPT.setTexture("iblSource",this._iblSource),this._icdfPT.setTexture("scaledLuminanceSampler",this._scaledLuminancePT),this._icdfPT.refreshRate=0,this._icdfPT.wrapV=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,this._icdfPT.wrapU=Qe$1.TEXTURE_CLAMP_ADDRESSMODE,this._iblSource.isCube&&(this._icdfPT.defines="#define IBL_USE_CUBE_MAP\n"),this._icdfPT.onGeneratedObservable.addOnce((()=>{this.onGeneratedObservable.notifyObservers();})),this._dominantDirectionPT=new E$6("iblDominantDirection",{width:1,height:1},"iblDominantDirection",this._scene,r,false,false),this._dominantDirectionPT.autoClear=false,this._dominantDirectionPT.setTexture("icdfSampler",this._icdfPT),this._dominantDirectionPT.refreshRate=0,this._dominantDirectionPT.defines="#define NUM_SAMPLES 32u\n";}_disposeTextures(){this._cdfyPT?.dispose(),this._cdfxPT?.dispose(),this._icdfPT?.dispose(),this._scaledLuminancePT?.dispose(),this._dominantDirectionPT?.dispose();}_createDebugPass(){this._debugPass&&this._debugPass.dispose();const e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),samplingMode:Is.BILINEAR_SAMPLINGMODE,engine:this._engine,textureType:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,uniforms:["sizeParams"],samplers:["cdfy","icdf","cdfx","iblSource"],defines:this._iblSource?.isCube?"#define IBL_USE_CUBE_MAP\n":"",shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(function(){return iblCdfDebug_fragmentDa5GuVQ3_esm_min})):t.push(Promise.resolve().then(function(){return iblCdfDebug_fragmentBPWMqfBo_esm_min}));}};this._debugPass=new Aa(this._debugPassName,"iblCdfDebug",t);const r=this._debugPass.getEffect();r&&(r.defines=this._iblSource?.isCube?"#define IBL_USE_CUBE_MAP\n":""),this._iblSource?.isCube&&this._debugPass.updateEffect("#define IBL_USE_CUBE_MAP\n"),this._debugPass.onApplyObservable.add((e=>{e.setTexture("cdfy",this._cdfyPT),e.setTexture("icdf",this._icdfPT),e.setTexture("cdfx",this._cdfxPT),e.setTexture("iblSource",this._iblSource),e.setFloat4("sizeParams",this._debugSizeParams.x,this._debugSizeParams.y,this._debugSizeParams.z,this._debugSizeParams.w);}));}isReady(){return this._iblSource&&"Placeholder IBL Source"!==this._iblSource.name&&this._iblSource.isReady()&&this._cdfyPT&&this._cdfyPT.isReady()&&this._icdfPT&&this._icdfPT.isReady()&&this._cdfxPT&&this._cdfxPT.isReady()&&this._scaledLuminancePT&&this._scaledLuminancePT.isReady()}renderWhenReady(){this._cachedDominantDirection=null;return new Promise(((e,t)=>{Rt$1((()=>!!this._icdfPT),(()=>e(void 0)),(()=>t(new Error("Waiting for _icdfPT creation failed"))));})).then((()=>{this._icdfPT.onGeneratedObservable.addOnce((()=>{this.onGeneratedObservable.notifyObservers();}));const e=[],t=[this._cdfyPT,this._cdfxPT,this._scaledLuminancePT,this._icdfPT];for(const s of t)e.push(new Promise((e=>{s.isReady()?e():s.getEffect().executeWhenCompiled((()=>{e();}));})));return Promise.all(e).then((()=>{for(const e of t)e.render();}))}))}findDominantDirection(){return this._cachedDominantDirection?Promise.resolve(this._cachedDominantDirection):new Promise((e=>{this._dominantDirectionPT.onGeneratedObservable.addOnce((()=>{const t=new Float32Array(4);this._dominantDirectionPT.readPixels(0,0,t,true).then((()=>{const s=new te$4(t[0],t[1],t[2]);this._cachedDominantDirection=s,e(s);}));})),this.isReady()?this._dominantDirectionPT.isReady()?this._dominantDirectionPT.render():this._dominantDirectionPT.getEffect().executeWhenCompiled((()=>{this._dominantDirectionPT.render();})):this.onGeneratedObservable.addOnce((()=>{this._dominantDirectionPT.isReady()?this._dominantDirectionPT.render():this._dominantDirectionPT.getEffect().executeWhenCompiled((()=>{this._dominantDirectionPT.render();}));}));}))}dispose(){this._disposeTextures(),this._dummyTexture.dispose(),this._debugPass&&this._debugPass.dispose(),this.onGeneratedObservable.clear();}static _IsScene(e){return "Scene"===e.getClassName()}};R$4._SceneComponentInitialization=e=>{throw le$4("IblCdfGeneratorSceneComponentSceneComponent")};var S$4=Object.freeze({__proto__:null,IblCdfGenerator:R$4});var iblCdfGeneratorNqPZwQCt_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,I:R$4,P:E$6,i:S$4});let g$7=class g{constructor(t,i={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=Qe$1.TEXTURE_FILTERING_QUALITY_OFFLINE,this.hdrScale=1,this._engine=t,this.hdrScale=i.hdrScale||this.hdrScale,this.quality=i.quality||this.quality;}_createRenderTarget(t){let i=Qe$1.TEXTURETYPE_UNSIGNED_BYTE;this._engine.getCaps().textureHalfFloatRender?i=Qe$1.TEXTURETYPE_HALF_FLOAT:this._engine.getCaps().textureFloatRender&&(i=Qe$1.TEXTURETYPE_FLOAT);const r=this._engine.createRenderTargetCubeTexture(t,{format:Qe$1.TEXTUREFORMAT_RGBA,type:i,createMipMaps:true,generateMipMaps:false,generateDepthBuffer:false,generateStencilBuffer:false,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,label:"HDR_Radiance_Filtering_Target"});return this._engine.updateTextureWrappingMode(r.texture,Qe$1.TEXTURE_CLAMP_ADDRESSMODE,Qe$1.TEXTURE_CLAMP_ADDRESSMODE,Qe$1.TEXTURE_CLAMP_ADDRESSMODE),this._engine.updateTextureSamplingMode(Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,r.texture,true),r}_prefilterInternal(r){const n=r.getSize().width,s=V$8(n)+1,a=this._effectWrapper.effect,o=this._createRenderTarget(n);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();const h=r.getInternalTexture();h&&this._engine.updateTextureSamplingMode(Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE,h,true),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const l=[[new te$4(0,0,-1),new te$4(0,-1,0),new te$4(1,0,0)],[new te$4(0,0,1),new te$4(0,-1,0),new te$4(-1,0,0)],[new te$4(1,0,0),new te$4(0,0,1),new te$4(0,1,0)],[new te$4(1,0,0),new te$4(0,0,-1),new te$4(0,-1,0)],[new te$4(1,0,0),new te$4(0,-1,0),new te$4(0,0,1)],[new te$4(-1,0,0),new te$4(0,-1,0),new te$4(0,0,-1)]];a.setFloat("hdrScale",this.hdrScale),a.setFloat2("vFilteringInfo",r.getSize().width,s),a.setTexture("inputTexture",r);for(let e=0;e<6;e++){a.setVector3("up",l[e][0]),a.setVector3("right",l[e][1]),a.setVector3("front",l[e][2]);for(let t=0;t<s;t++){this._engine.bindFramebuffer(o,e,void 0,void 0,true,t),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let i=Math.pow(2,(t-this._lodGenerationOffset)/this._lodGenerationScale)/n;0===t&&(i=0),a.setFloat("alphaG",i),this._effectRenderer.draw();}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(r._texture);const d=o.texture.type,_=o.texture.format;return o._swapAndDie(r._texture),r._texture.type=d,r._texture.format=_,r.gammaSpace=false,r.lodGenerationOffset=this._lodGenerationOffset,r.lodGenerationScale=this._lodGenerationScale,r._prefiltered=true,r}_createEffect(e,t){const i=[];e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u");const n=this._engine.isWebGPU;return new Ea({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:true,defines:i,onCompiled:t,shaderLanguage:n?1:0,extraInitializationsAsync:async()=>{n?await Promise.all([Promise.resolve().then(function(){return hdrFiltering_vertexCtICuUSA_esm_min}),Promise.resolve().then(function(){return hdrFiltering_fragmentBPbZx1iP_esm_min})]):await Promise.all([Promise.resolve().then(function(){return hdrFiltering_vertexDfWCibql_esm_min}),Promise.resolve().then(function(){return hdrFiltering_fragmentFIzTivjA_esm_min})]);}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}async prefilter(e){if(!this._engine._features.allowTexturePrefiltering)throw new Error("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead.");this._effectRenderer=new Ta(this._engine),this._effectWrapper=this._createEffect(e),await this._effectWrapper.effect.whenCompiledAsync(),this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose();}};let m$8=class m{constructor(t,i={}){this.quality=Qe$1.TEXTURE_FILTERING_QUALITY_OFFLINE,this.hdrScale=1,this.useCdf=false,this._engine=t,this.hdrScale=i.hdrScale||this.hdrScale,this.quality=i.quality||this.quality,this.useCdf=i.useCdf||this.useCdf;}_createRenderTarget(t){let i=Qe$1.TEXTURETYPE_UNSIGNED_BYTE;this._engine.getCaps().textureHalfFloatRender?i=Qe$1.TEXTURETYPE_HALF_FLOAT:this._engine.getCaps().textureFloatRender&&(i=Qe$1.TEXTURETYPE_FLOAT);const r=this._engine.createRenderTargetCubeTexture(t,{format:Qe$1.TEXTUREFORMAT_RGBA,type:i,createMipMaps:false,generateMipMaps:false,generateDepthBuffer:false,generateStencilBuffer:false,samplingMode:Qe$1.TEXTURE_BILINEAR_SAMPLINGMODE,label:"HDR_Irradiance_Filtering_Target"});return this._engine.updateTextureWrappingMode(r.texture,Qe$1.TEXTURE_CLAMP_ADDRESSMODE,Qe$1.TEXTURE_CLAMP_ADDRESSMODE,Qe$1.TEXTURE_CLAMP_ADDRESSMODE),r}_prefilterInternal(e){const r=e.getSize().width,n=V$8(r),a=this._effectWrapper.effect,o=Math.max(32,1<<V$8(r>>3)),h=this._createRenderTarget(o);this._effectRenderer.saveStates(),this._effectRenderer.setViewport(),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const l=[[new te$4(0,0,-1),new te$4(0,-1,0),new te$4(1,0,0)],[new te$4(0,0,1),new te$4(0,-1,0),new te$4(-1,0,0)],[new te$4(1,0,0),new te$4(0,0,1),new te$4(0,1,0)],[new te$4(1,0,0),new te$4(0,0,-1),new te$4(0,-1,0)],[new te$4(1,0,0),new te$4(0,-1,0),new te$4(0,0,1)],[new te$4(-1,0,0),new te$4(0,-1,0),new te$4(0,0,-1)]];a.setFloat("hdrScale",this.hdrScale),a.setFloat2("vFilteringInfo",e.getSize().width,n),a.setTexture("inputTexture",e),this._cdfGenerator&&a.setTexture("icdfTexture",this._cdfGenerator.getIcdfTexture());for(let e=0;e<6;e++)a.setVector3("up",l[e][0]),a.setVector3("right",l[e][1]),a.setVector3("front",l[e][2]),this._engine.bindFramebuffer(h,e,void 0,void 0,true),this._effectRenderer.applyEffectWrapper(this._effectWrapper),this._effectRenderer.draw();this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),a.setTexture("inputTexture",null),a.setTexture("icdfTexture",null);const d=new Ms(e.getScene(),h.texture);return d.name=e.name+"_irradiance",d.displayName=e.name+"_irradiance",d.gammaSpace=false,d}_createEffect(e,t){const i=[];e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u");const n=this._engine.isWebGPU,s=["inputTexture"];this._cdfGenerator&&(s.push("icdfTexture"),i.push("#define IBL_CDF_FILTERING"));return new Ea({engine:this._engine,name:"HDRIrradianceFiltering",vertexShader:"hdrIrradianceFiltering",fragmentShader:"hdrIrradianceFiltering",samplerNames:s,uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale"],useShaderStore:true,defines:i,onCompiled:t,shaderLanguage:n?1:0,extraInitializationsAsync:async()=>{n?await Promise.all([Promise.resolve().then(function(){return hdrIrradianceFiltering_vertexB2gT8q81_esm_min}),Promise.resolve().then(function(){return hdrIrradianceFiltering_fragmentBBG3XY_f_esm_min})]):await Promise.all([Promise.resolve().then(function(){return hdrIrradianceFiltering_vertexBLfACBHf_esm_min}),Promise.resolve().then(function(){return hdrIrradianceFiltering_fragmentCMCv7Hr_esm_min})]);}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}async prefilter(e){if(!this._engine._features.allowTexturePrefiltering)throw new Error("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead.");this.useCdf&&(this._cdfGenerator=new R$4(this._engine),this._cdfGenerator.iblSource=e,await this._cdfGenerator.renderWhenReady()),this._effectRenderer=new Ta(this._engine),this._effectWrapper=this._createEffect(e),await this._effectWrapper.effect.whenCompiledAsync();const t=this._prefilterInternal(e);return this.useCdf&&await this._cdfGenerator.findDominantDirection().then((e=>{t._dominantDirection=e;})),this._effectRenderer.dispose(),this._effectWrapper.dispose(),this._cdfGenerator?.dispose(),t}};let T$2=class T extends Ms{set isBlocking(e){this._isBlocking=e;}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(re$5.RotationY(this._rotationY));}get rotationY(){return this._rotationY}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;const i=this.getScene();i&&i.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}get boundingBoxSize(){return this._boundingBoxSize}constructor(t,r,n,s=false,d=true,_=false,c=false,u=null,f=null,p=false,g=false,m=false){super(r),this._generateHarmonics=true,this._onError=null,this._isBlocking=true,this._rotationY=0,this.boundingBoxPosition=te$4.Zero(),this.onLoadObservable=new R$g,t&&(this._coordinatesMode=Is.CUBIC_MODE,this.name=t,this.url=t,this.hasAlpha=false,this.isCube=true,this._textureMatrix=re$5.Identity(),this._prefilterOnLoad=c,this._prefilterIrradianceOnLoad=g,this._prefilterUsingCdf=m,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),u&&u();},this._onError=f,this.gammaSpace=_,this._noMipmap=s,this._size=n,this._supersample=p||m,this._generateHarmonics=d,this._texture=this._getFromCache(t,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?Ai.SetImmediate((()=>this._onLoad())):this._texture.onLoadedObservable.add(this._onLoad):this.getScene()?.useDelayedTextureLoading?this.delayLoadState=Qe$1.DELAYLOADSTATE_NOTLOADED:this._loadTexture());}getClassName(){return "EnvCubeTexture"}_loadTexture(){const t=this._getEngine(),i=t.getCaps();let r=Qe$1.TEXTURETYPE_UNSIGNED_BYTE;i.textureFloat&&i.textureFloatLinearFiltering?r=Qe$1.TEXTURETYPE_FLOAT:i.textureHalfFloat&&i.textureHalfFloatLinearFiltering&&(r=Qe$1.TEXTURETYPE_HALF_FLOAT);if(t._features.allowTexturePrefiltering&&(this._prefilterOnLoad||this._prefilterIrradianceOnLoad)){const i=this._onLoad,r=new g$7(t);this._onLoad=()=>{let n=Promise.resolve(null),s=Promise.resolve();if(this._prefilterIrradianceOnLoad){n=new m$8(t,{useCdf:this._prefilterUsingCdf}).prefilter(this);}this._prefilterOnLoad&&(s=r.prefilter(this)),Promise.all([n,s]).then((t=>{const r=t[0];if(this._prefilterIrradianceOnLoad&&r){this.irradianceTexture=r;const t=this.getScene();t&&t.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}i&&i();}));};}this._texture=t.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,Qe$1.TEXTUREFORMAT_RGB,r,this._noMipmap,(async t=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const i=await this._getCubeMapTextureDataAsync(t,this._size,this._supersample);if(this._generateHarmonics){const e=Qh.ConvertCubeMapToSphericalPolynomial(i);this.sphericalPolynomial=e;}const n=[];let s=null,a=null;for(let t=0;t<6;t++){r===Qe$1.TEXTURETYPE_HALF_FLOAT?a=new Uint16Array(this._size*this._size*3):r===Qe$1.TEXTURETYPE_UNSIGNED_BYTE&&(s=new Uint8Array(this._size*this._size*3));const o=i[T._FacesMapping[t]];if(this.gammaSpace||a||s)for(let e=0;e<this._size*this._size;e++)if(this.gammaSpace&&(o[3*e+0]=Math.pow(o[3*e+0],b$f),o[3*e+1]=Math.pow(o[3*e+1],b$f),o[3*e+2]=Math.pow(o[3*e+2],b$f)),a&&(a[3*e+0]=Lh(o[3*e+0]),a[3*e+1]=Lh(o[3*e+1]),a[3*e+2]=Lh(o[3*e+2])),s){let t=Math.max(255*o[3*e+0],0),i=Math.max(255*o[3*e+1],0),r=Math.max(255*o[3*e+2],0);const n=Math.max(Math.max(t,i),r);if(n>255){const e=255/n;t*=e,i*=e,r*=e;}s[3*e+0]=t,s[3*e+1]=i,s[3*e+2]=r;}a?n.push(a):s?n.push(s):n.push(o);}return n}),null,this._onLoad,this._onError);}delayLoad(){this.delayLoadState===Qe$1.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=Qe$1.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture());}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(t){this._textureMatrix=t,t.updateFlag!==this._textureMatrix.updateFlag&&t.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(Qe$1.MATERIAL_TextureDirtyFlag,(e=>-1!==e.getActiveTextures().indexOf(this)));}dispose(){this.onLoadObservable.clear(),super.dispose();}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=true,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}clone(){const e=this._instantiateClone();return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}static _Parse(e,t){t.name=e.name,t.hasAlpha=e.hasAlpha,t.level=e.level,t.coordinatesMode=e.coordinatesMode,t.isBlocking=e.isBlocking,e.boundingBoxPosition&&(t.boundingBoxPosition=te$4.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(t.boundingBoxSize=te$4.FromArray(e.boundingBoxSize)),e.rotationY&&(t.rotationY=e.rotationY);}};T$2._FacesMapping=["right","left","up","down","front","back"];let E$5=class E extends T$2{constructor(e,t,i,r=false,n=true,s=false,a=false,o=null,h=null,l=false,d=false,_=false){super(e,t,i,r,n,s,a,o,h,l,d,_);}getClassName(){return "HDRCubeTexture"}async _getCubeMapTextureDataAsync(e,t,i){return i$1g(e,t,i)}_instantiateClone(){return new E(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace)}serialize(){const e=super.serialize();return e?(e.customType="BABYLON.HDRCubeTexture",e):null}static Parse(e,t,i){if(!e.name||e.isRenderTarget)return null;const r=new E(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace);return this._Parse(e,r),r}};P$9("BABYLON.HDRCubeTexture",E$5);var hdrCubeTextureDrNFOKdT_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,HDRCubeTexture:E$5});var L$1;!function(L){L[L.GLSL=0]="GLSL",L[L.WGSL=1]="WGSL";}(L$1||(L$1={}));var shaderLanguageR84fVnRr_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,get ShaderLanguage(){return L$1}});function i$D(e){const i=[],s=[],n=[],a=[],o=e.radius||.5,r=e.tessellation||64,u=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,l=0===e.sideOrientation?0:e.sideOrientation||is.DEFAULTSIDE;i.push(0,0,0),a.push(.5,.5);const c=2*Math.PI*u,d=1===u?c/r:c/(r-1);let p=0;for(let t=0;t<r;t++){const t=Math.cos(p),e=Math.sin(p),s=(t+1)/2,n=(1-e)/2;i.push(o*t,o*e,0),a.push(s,n),p+=d;}1===u&&(i.push(i[3],i[4],i[5]),a.push(a[2],a[3]));const h=i.length/3;for(let t=1;t<h-1;t++)s.push(t+1,0,t);is.ComputeNormals(i,s,n),is._ComputeSides(l,i,s,n,a,e.frontUVs,e.backUVs);const m=new is;return m.indices=s,m.positions=i,m.normals=n,m.uvs=a,m}function s$d(t,s={},n=null){const a=new Er$1(t,n);s.sideOrientation=Er$1._GetDefaultSideOrientation(s.sideOrientation),a._originalBuilderSideOrientation=s.sideOrientation;return i$D(s).applyToMesh(a,s.updatable),a}const n$L={CreateDisc:s$d};is.CreateDisc=i$D,Er$1.CreateDisc=(t,e,i,n=null,a,o)=>s$d(t,{radius:e,tessellation:i,sideOrientation:o,updatable:a},n);var discBuilderD9KLnRbJ_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,CreateDisc:s$d,CreateDiscVertexData:i$D,DiscBuilder:n$L});const se={effect:null,subMesh:null};class ie{populateVectorFromLinkedProperties(e){const t=e.dimension[0];for(const e in this.linkedProperties){const s=this.linkedProperties[e],i=s.numComponents;if(t<i||s.targetUniformComponentOffset>t-i)return void(1==i?Ie$2.Error(`Float property ${s.name} has an offset that is too large.`):Ie$2.Error(`Vector${i} property ${s.name} won't fit in Vector${t} or has an offset that is too large.`));"number"==typeof s.value?ie._tmpArray[s.targetUniformComponentOffset]=s.value:s.value.toArray(ie._tmpArray,s.targetUniformComponentOffset);}e.fromArray(ie._tmpArray);}constructor(e,t){this.linkedProperties={},this.name=e,this.numComponents=t;}}ie._tmpArray=[0,0,0,0];class re{constructor(e,t,s,i,r=0){this.targetUniformComponentNum=4,this.targetUniformComponentOffset=0,this.name=e,this.targetUniformName=s,this.defaultValue=t,this.value=t,this.targetUniformComponentNum=i,this.targetUniformComponentOffset=r;}get numComponents(){return "number"==typeof this.defaultValue?1:this.defaultValue.dimension[0]}}class ne{get samplerName(){return this.samplerPrefix+"Sampler"}get samplerInfoName(){return "v"+this.samplerPrefix.charAt(0).toUpperCase()+this.samplerPrefix.slice(1)+"Infos"}get samplerMatrixName(){return this.samplerPrefix+"Matrix"}constructor(e,t,s){this.value=null,this.samplerPrefix="",this.textureDefine="",this.name=e,this.samplerPrefix=t,this.textureDefine=s;}}class oe extends(cl(Eh)){}class ae extends(Rh(oe)){constructor(e){super(e),this.NUM_SAMPLES="0",this.REALTIME_FILTERING=false,this.IBL_CDF_FILTERING=false,this.VERTEXCOLOR=false,this.BAKED_VERTEX_ANIMATION_TEXTURE=false,this.VERTEXALPHA=false,this.ALPHATEST=false,this.DEPTHPREPASS=false,this.ALPHABLEND=false,this.ALPHA_FROM_BASE_COLOR_TEXTURE=false,this.ALPHATESTVALUE="0.5",this.PREMULTIPLYALPHA=false,this.REFLECTIVITY_GAMMA=false,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=false,this.LODBASEDMICROSFURACE=true,this.METALLICWORKFLOW=true,this.ROUGHNESSSTOREINMETALMAPALPHA=false,this.ROUGHNESSSTOREINMETALMAPGREEN=false,this.METALLNESSSTOREINMETALMAPBLUE=false,this.AOSTOREINMETALMAPRED=false,this.SPECULAR_WEIGHT_IN_ALPHA=false,this.SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE=false,this.SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE=false,this.COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE=false,this.USE_GLTF_STYLE_ANISOTROPY=false,this.THIN_FILM_THICKNESS_FROM_THIN_FILM_TEXTURE=false,this.ENVIRONMENTBRDF=false,this.ENVIRONMENTBRDF_RGBD=false,this.FUZZENVIRONMENTBRDF=false,this.NORMAL=false,this.TANGENT=false,this.OBJECTSPACE_NORMALMAP=false,this.PARALLAX=false,this.PARALLAX_RHS=false,this.PARALLAXOCCLUSION=false,this.NORMALXYSCALE=true,this.ANISOTROPIC=false,this.ANISOTROPIC_OPENPBR=true,this.ANISOTROPIC_BASE=false,this.ANISOTROPIC_COAT=false,this.FUZZ_IBL_SAMPLES=6,this.FUZZ=false,this.THIN_FILM=false,this.IRIDESCENCE=false,this.REFLECTION=false,this.REFLECTIONMAP_3D=false,this.REFLECTIONMAP_SPHERICAL=false,this.REFLECTIONMAP_PLANAR=false,this.REFLECTIONMAP_CUBIC=false,this.USE_LOCAL_REFLECTIONMAP_CUBIC=false,this.REFLECTIONMAP_PROJECTION=false,this.REFLECTIONMAP_SKYBOX=false,this.REFLECTIONMAP_EXPLICIT=false,this.REFLECTIONMAP_EQUIRECTANGULAR=false,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false,this.INVERTCUBICMAP=false,this.USESPHERICALFROMREFLECTIONMAP=false,this.USEIRRADIANCEMAP=false,this.USE_IRRADIANCE_DOMINANT_DIRECTION=false,this.USESPHERICALINVERTEX=false,this.REFLECTIONMAP_OPPOSITEZ=false,this.LODINREFLECTIONALPHA=false,this.GAMMAREFLECTION=false,this.RGBDREFLECTION=false,this.RADIANCEOCCLUSION=false,this.HORIZONOCCLUSION=false,this.INSTANCES=false,this.THIN_INSTANCES=false,this.INSTANCESCOLOR=false,this.PREPASS=false,this.PREPASS_COLOR=false,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=false,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=false,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=false,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=false,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=false,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=false,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=false,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=false,this.PREPASS_WORLD_NORMAL=false,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=false,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=false,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=false,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=false,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=false,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=false,this.BONES_VELOCITY_ENABLED=false,this.NONUNIFORMSCALING=false,this.MORPHTARGETS=false,this.MORPHTARGETS_POSITION=false,this.MORPHTARGETS_NORMAL=false,this.MORPHTARGETS_TANGENT=false,this.MORPHTARGETS_UV=false,this.MORPHTARGETS_UV2=false,this.MORPHTARGETS_COLOR=false,this.MORPHTARGETTEXTURE_HASPOSITIONS=false,this.MORPHTARGETTEXTURE_HASNORMALS=false,this.MORPHTARGETTEXTURE_HASTANGENTS=false,this.MORPHTARGETTEXTURE_HASUVS=false,this.MORPHTARGETTEXTURE_HASUV2S=false,this.MORPHTARGETTEXTURE_HASCOLORS=false,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=false,this.USEPHYSICALLIGHTFALLOFF=false,this.USEGLTFLIGHTFALLOFF=false,this.TWOSIDEDLIGHTING=false,this.MIRRORED=false,this.SHADOWFLOAT=false,this.CLIPPLANE=false,this.CLIPPLANE2=false,this.CLIPPLANE3=false,this.CLIPPLANE4=false,this.CLIPPLANE5=false,this.CLIPPLANE6=false,this.POINTSIZE=false,this.FOG=false,this.LOGARITHMICDEPTH=false,this.CAMERA_ORTHOGRAPHIC=false,this.CAMERA_PERSPECTIVE=false,this.AREALIGHTSUPPORTED=true,this.FORCENORMALFORWARD=false,this.SPECULARAA=false,this.UNLIT=false,this.DECAL_AFTER_DETAIL=false,this.DEBUGMODE=0,this.CLUSTLIGHT_SLICES=0,this.CLUSTLIGHT_BATCH=0,this.BRDF_V_HEIGHT_CORRELATED=true,this.MS_BRDF_ENERGY_CONSERVATION=true,this.SPHERICAL_HARMONICS=true,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=true,this.MIX_IBL_RADIANCE_WITH_IRRADIANCE=true,this.LEGACY_SPECULAR_ENERGY_CONSERVATION=false,this.BASE_DIFFUSE_MODEL=Qe$1.MATERIAL_DIFFUSE_MODEL_E_OREN_NAYAR,this.DIELECTRIC_SPECULAR_MODEL=Qe$1.MATERIAL_DIELECTRIC_SPECULAR_MODEL_OPENPBR,this.CONDUCTOR_SPECULAR_MODEL=Qe$1.MATERIAL_CONDUCTOR_SPECULAR_MODEL_OPENPBR,this.rebuild();}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.NORMALXYSCALE=true;}}class he extends(bh(Ah)){}class ue extends he{get geometryTangentAngle(){return Math.atan2(this.geometryTangent.y,this.geometryTangent.x)}set geometryTangentAngle(t){this.geometryTangent=new ee$4(Math.cos(t),Math.sin(t));}get geometryCoatTangentAngle(){return Math.atan2(this.geometryCoatTangent.y,this.geometryCoatTangent.x)}set geometryCoatTangentAngle(t){this.geometryCoatTangent=new ee$4(Math.cos(t),Math.sin(t));}get usePhysicalLightFalloff(){return this._lightFalloff===hr$1.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?hr$1.LIGHTFALLOFF_PHYSICAL:hr$1.LIGHTFALLOFF_STANDARD);}get useGLTFLightFalloff(){return this._lightFalloff===hr$1.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?hr$1.LIGHTFALLOFF_GLTF:hr$1.LIGHTFALLOFF_STANDARD);}get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}get fuzzSampleNumber(){return this._fuzzSampleNumber}set fuzzSampleNumber(e){this._fuzzSampleNumber=e,this.markAsDirty(Qe$1.MATERIAL_TextureDirtyFlag);}get canRenderToMRT(){return  true}constructor(T,A,m=false){super(T,A,void 0,m||ue.ForceGLSL),this._baseWeight=new re("base_weight",1,"vBaseWeight",1),this._baseWeightTexture=new ne("base_weight","baseWeight","BASE_WEIGHT"),this._baseColor=new re("base_color",ge$3.White(),"vBaseColor",4),this._baseColorTexture=new ne("base_color","baseColor","BASE_COLOR"),this._baseDiffuseRoughness=new re("base_diffuse_roughness",0,"vBaseDiffuseRoughness",1),this._baseDiffuseRoughnessTexture=new ne("base_diffuse_roughness","baseDiffuseRoughness","BASE_DIFFUSE_ROUGHNESS"),this._baseMetalness=new re("base_metalness",0,"vReflectanceInfo",4,0),this._baseMetalnessTexture=new ne("base_metalness","baseMetalness","BASE_METALNESS"),this._specularWeight=new re("specular_weight",1,"vReflectanceInfo",4,3),this._specularWeightTexture=new ne("specular_weight","specularWeight","SPECULAR_WEIGHT"),this._specularColor=new re("specular_color",ge$3.White(),"vSpecularColor",4),this._specularColorTexture=new ne("specular_color","specularColor","SPECULAR_COLOR"),this._specularRoughness=new re("specular_roughness",.3,"vReflectanceInfo",4,1),this._specularRoughnessTexture=new ne("specular_roughness","specularRoughness","SPECULAR_ROUGHNESS"),this._specularRoughnessAnisotropy=new re("specular_roughness_anisotropy",0,"vSpecularAnisotropy",3,2),this._specularRoughnessAnisotropyTexture=new ne("specular_roughness_anisotropy","specularRoughnessAnisotropy","SPECULAR_ROUGHNESS_ANISOTROPY"),this._specularIor=new re("specular_ior",1.5,"vReflectanceInfo",4,2),this._coatWeight=new re("coat_weight",0,"vCoatWeight",1,0),this._coatWeightTexture=new ne("coat_weight","coatWeight","COAT_WEIGHT"),this._coatColor=new re("coat_color",ge$3.White(),"vCoatColor",3,0),this._coatColorTexture=new ne("coat_color","coatColor","COAT_COLOR"),this._coatRoughness=new re("coat_roughness",0,"vCoatRoughness",1,0),this._coatRoughnessTexture=new ne("coat_roughness","coatRoughness","COAT_ROUGHNESS"),this._coatRoughnessAnisotropy=new re("coat_roughness_anisotropy",0,"vCoatRoughnessAnisotropy",1),this._coatRoughnessAnisotropyTexture=new ne("coat_roughness_anisotropy","coatRoughnessAnisotropy","COAT_ROUGHNESS_ANISOTROPY"),this._coatIor=new re("coat_ior",1.5,"vCoatIor",1,0),this._coatDarkening=new re("coat_darkening",1,"vCoatDarkening",1,0),this._coatDarkeningTexture=new ne("coat_darkening","coatDarkening","COAT_DARKENING"),this.useCoatRoughnessFromWeightTexture=false,this._fuzzWeight=new re("fuzz_weight",0,"vFuzzWeight",1,0),this._fuzzWeightTexture=new ne("fuzz_weight","fuzzWeight","FUZZ_WEIGHT"),this._fuzzColor=new re("fuzz_color",ge$3.White(),"vFuzzColor",3,0),this._fuzzColorTexture=new ne("fuzz_color","fuzzColor","FUZZ_COLOR"),this._fuzzRoughness=new re("fuzz_roughness",.5,"vFuzzRoughness",1,0),this._fuzzRoughnessTexture=new ne("fuzz_roughness","fuzzRoughness","FUZZ_ROUGHNESS"),this._geometryNormalTexture=new ne("geometry_normal","geometryNormal","GEOMETRY_NORMAL"),this._geometryTangent=new re("geometry_tangent",new ee$4(1,0),"vSpecularAnisotropy",3,0),this._geometryTangentTexture=new ne("geometry_tangent","geometryTangent","GEOMETRY_TANGENT"),this._geometryCoatNormalTexture=new ne("geometry_coat_normal","geometryCoatNormal","GEOMETRY_COAT_NORMAL"),this._geometryCoatTangent=new re("geometry_coat_tangent",new ee$4(1,0),"vGeometryCoatTangent",2,0),this._geometryCoatTangentTexture=new ne("geometry_coat_tangent","geometryCoatTangent","GEOMETRY_COAT_TANGENT"),this._geometryOpacity=new re("geometry_opacity",1,"vBaseColor",4,3),this._geometryOpacityTexture=new ne("geometry_opacity","geometryOpacity","GEOMETRY_OPACITY"),this._emissionLuminance=new re("emission_luminance",1,"vLightingIntensity",4,1),this._emissionColor=new re("emission_color",ge$3.Black(),"vEmissionColor",3),this._emissionColorTexture=new ne("emission_color","emissionColor","EMISSION_COLOR"),this._thinFilmWeight=new re("thin_film_weight",0,"vThinFilmWeight",1,0),this._thinFilmWeightTexture=new ne("thin_film_weight","thinFilmWeight","THIN_FILM_WEIGHT"),this._thinFilmThickness=new re("thin_film_thickness",.5,"vThinFilmThickness",2,0),this._thinFilmThicknessMin=new re("thin_film_thickness_min",0,"vThinFilmThickness",2,1),this._thinFilmThicknessTexture=new ne("thin_film_thickness","thinFilmThickness","THIN_FILM_THICKNESS"),this._thinFilmIor=new re("thin_film_ior",1.4,"vThinFilmIor",1,0),this._ambientOcclusionTexture=new ne("ambient_occlusion","ambientOcclusion","AMBIENT_OCCLUSION"),this._uniformsList={},this._samplersList={},this._samplerDefines={},this.directIntensity=1,this.environmentIntensity=1,this.useSpecularWeightFromTextureAlpha=false,this.forceAlphaTest=false,this.alphaCutOff=.4,this.useAmbientOcclusionFromMetallicTextureRed=false,this.useAmbientInGrayScale=false,this.useObjectSpaceNormalMap=false,this.useParallax=false,this.useParallaxOcclusion=false,this.parallaxScaleBias=.05,this.disableLighting=false,this.forceIrradianceInFragment=false,this.maxSimultaneousLights=4,this.invertNormalMapX=false,this.invertNormalMapY=false,this.twoSidedLighting=false,this.useAlphaFresnel=false,this.useLinearAlphaFresnel=false,this.environmentBRDFTexture=null,this.forceNormalForward=false,this.enableSpecularAntiAliasing=false,this.useHorizonOcclusion=true,this.useRadianceOcclusion=true,this.unlit=false,this.applyDecalMapAfterDetailMap=false,this._lightingInfos=new ie$5(this.directIntensity,1,this.environmentIntensity,1),this._radianceTexture=null,this._useSpecularWeightFromAlpha=false,this._useSpecularWeightFromSpecularColorTexture=false,this._useSpecularRoughnessAnisotropyFromTangentTexture=false,this._useCoatRoughnessAnisotropyFromTangentTexture=false,this._useGltfStyleAnisotropy=false,this._useHorizonOcclusion=true,this._useRadianceOcclusion=true,this._useAlphaFromBaseColorTexture=false,this._useAmbientOcclusionFromMetallicTextureRed=false,this._useRoughnessFromMetallicTextureGreen=false,this._useMetallicFromMetallicTextureBlue=false,this._useThinFilmThicknessFromTextureGreen=false,this._lightFalloff=hr$1.LIGHTFALLOFF_PHYSICAL,this._useObjectSpaceNormalMap=false,this._useParallax=false,this._useParallaxOcclusion=false,this._parallaxScaleBias=.05,this._disableLighting=false,this._maxSimultaneousLights=4,this._invertNormalMapX=false,this._invertNormalMapY=false,this._twoSidedLighting=false,this._alphaCutOff=.4,this._useAlphaFresnel=false,this._useLinearAlphaFresnel=false,this._environmentBRDFTexture=null,this._environmentFuzzBRDFTexture=null,this._forceIrradianceInFragment=false,this._realTimeFiltering=false,this._realTimeFilteringQuality=Qe$1.TEXTURE_FILTERING_QUALITY_LOW,this._fuzzSampleNumber=4,this._forceNormalForward=false,this._enableSpecularAntiAliasing=false,this._renderTargets=new Ii(16),this._unlit=false,this._applyDecalMapAfterDetailMap=false,this._debugMode=0,this._shadersLoaded=false,this._breakShaderLoadedCheck=false,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=false,this._transparencyMode=hr$1.MATERIAL_OPAQUE,this.getScene()&&!this.getScene()?.getEngine().isWebGPU&&this.getScene().getEngine().webGLVersion<2&&Ie$2.Error("OpenPBRMaterial: WebGL 2.0 or above is required for this material."),ue._noiseTextures[this.getScene().uniqueId]||(ue._noiseTextures[this.getScene().uniqueId]=new Is("https://assets.babylonjs.com/textures/blue_noise/blue_noise_rgb.png",this.getScene(),false,true,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE),this.getScene().onDisposeObservable.addOnce((()=>{ue._noiseTextures[this.getScene().uniqueId]?.dispose(),delete ue._noiseTextures[this.getScene().uniqueId];}))),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),bs.ReflectionTextureEnabled&&this._radianceTexture&&this._radianceTexture.isRenderTarget&&this._renderTargets.push(this._radianceTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=Uh(this.getScene()),this._environmentFuzzBRDFTexture=kh(this.getScene()),this.prePassConfiguration=new Kh,this._propertyList={};for(const e of Object.getOwnPropertyNames(this)){const t=this[e];t instanceof re&&(this._propertyList[e]=t);}Object.keys(this._propertyList).forEach((e=>{const t=this._propertyList[e];let s=this._uniformsList[t.targetUniformName];s?s.numComponents!==t.targetUniformComponentNum&&Ie$2.Error(`Uniform ${t.targetUniformName} already exists of size ${s.numComponents}, but trying to set it to ${t.targetUniformComponentNum}.`):(s=new ie(t.targetUniformName,t.targetUniformComponentNum),this._uniformsList[t.targetUniformName]=s),s.linkedProperties[t.name]=t;})),this._samplersList={};for(const e of Object.getOwnPropertyNames(this)){const t=this[e];t instanceof ne&&(this._samplersList[e]=t);}for(const e in this._samplersList){const t=this._samplersList[e].textureDefine;this._samplerDefines[t]={type:"boolean",default:false},this._samplerDefines[t+"DIRECTUV"]={type:"number",default:0},this._samplerDefines[t+"_GAMMA"]={type:"boolean",default:false};}this._baseWeight,this._baseWeightTexture,this._baseColor,this._baseColorTexture,this._baseDiffuseRoughness,this._baseDiffuseRoughnessTexture,this._baseMetalness,this._baseMetalnessTexture,this._specularWeight,this._specularWeightTexture,this._specularColor,this._specularColorTexture,this._specularRoughness,this._specularIor,this._specularRoughnessTexture,this._specularRoughnessAnisotropy,this._specularRoughnessAnisotropyTexture,this._coatWeight,this._coatWeightTexture,this._coatColor,this._coatColorTexture,this._coatRoughness,this._coatRoughnessTexture,this._coatRoughnessAnisotropy,this._coatRoughnessAnisotropyTexture,this._coatIor,this._coatDarkening,this._coatDarkeningTexture,this._fuzzWeight,this._fuzzWeightTexture,this._fuzzColor,this._fuzzColorTexture,this._fuzzRoughness,this._fuzzRoughnessTexture,this._geometryNormalTexture,this._geometryTangent,this._geometryTangentTexture,this._geometryCoatNormalTexture,this._geometryCoatTangent,this._geometryCoatTangentTexture,this._geometryOpacity,this._geometryOpacityTexture,this._thinFilmWeight,this._thinFilmWeightTexture,this._thinFilmThickness,this._thinFilmThicknessMin,this._thinFilmThicknessTexture,this._thinFilmIor,this._emissionLuminance,this._emissionColor,this._emissionColorTexture,this._ambientOcclusionTexture;}get hasRenderTargetTextures(){return !!(bs.ReflectionTextureEnabled&&this._radianceTexture&&this._radianceTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return !this.disableDepthWrite}getClassName(){return "OpenPBRMaterial"}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._markAllSubMeshesAsTexturesAndMiscDirty());}_shouldUseAlphaFromBaseColorTexture(){return this._hasAlphaChannel()&&this._transparencyMode!==hr$1.MATERIAL_OPAQUE&&!this.geometryOpacityTexture}_hasAlphaChannel(){return null!=this.baseColorTexture&&this.baseColorTexture.hasAlpha&&this._useAlphaFromBaseColorTexture||null!=this.geometryOpacityTexture}clone(e,t=true,s=""){const i=Ae$3.Clone((()=>new ue(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return i.id=e,i.name=e,this.stencil.copyTo(i.stencil),this._clonePlugins(i,s),i}serialize(){const e=super.serialize();return e.customType="BABYLON.OpenPBRMaterial",e}static Parse(e,s,i){const r=Ae$3.Parse((()=>new ue(e.name,s)),e,s,i);return e.stencil&&r.stencil.parse(e.stencil,s,i),hr$1._ParsePlugins(e,r,s,i),r}forceCompilation(e,t,s){const i={clipPlane:false,useInstances:false,...s};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo);(()=>{if(this._breakShaderLoadedCheck)return;const s=new ae({...this._eventInfo.defineNames||{},...this._samplerDefines||{}}),r=this._prepareEffect(e,e,s,void 0,void 0,i.useInstances,i.clipPlane);this._onEffectCreatedObservable&&(se.effect=r,se.subMesh=null,this._onEffectCreatedObservable.notifyObservers(se)),r.isReady()?t&&t(this):r.onCompileObservable.add((()=>{t&&t(this);}));})();}isReadyForSubMesh(e,t,s){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const i=t._drawWrapper;if(i.effect&&this.isFrozen&&i._wasPreviouslyReady&&i._wasPreviouslyUsingInstances===s)return  true;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new ae({...this._eventInfo.defineNames||{},...this._samplerDefines||{}}));const r=t.materialDefines;if(this._isReadyForSubMesh(t))return  true;const n=this.getScene(),a=n.getEngine();if(r._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=false,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n.texturesEnabled)){for(const e in this._samplersList){const t=this._samplersList[e];if(t.value&&!t.value.isReadyOrNotBlocking())return  false}const e=this._getRadianceTexture();if(e&&bs.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return  false;if(e.irradianceTexture){if(!e.irradianceTexture.isReadyOrNotBlocking())return  false}else if(!e.sphericalPolynomial&&e.getInternalTexture()?._sphericalPolynomialPromise)return  false}if(this._environmentBRDFTexture&&bs.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return  false;if(this._environmentFuzzBRDFTexture&&bs.ReflectionTextureEnabled&&!this._environmentFuzzBRDFTexture.isReady())return  false;if(ue._noiseTextures[n.uniqueId]&&!ue._noiseTextures[n.uniqueId].isReady())return  false}if(this._eventInfo.isReadyForSubMesh=true,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return  false;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return  false;if(r.AREALIGHTUSED)for(let t=0;t<e.lightSources.length;t++)if(!e.lightSources[t]._isReady())return  false;a.getCaps().standardDerivatives||e.isVerticesDataPresent(Hi.NormalKind)||(e.createNormals(true),Ie$2.Warn("OpenPBRMaterial: Normals have been created for the mesh: "+e.name));const u=t.effect,l=r._areLightsDisposed;let _=this._prepareEffect(e,t.getRenderingMesh(),r,this.onCompiled,this.onError,s,null),T=false;if(_)if(this._onEffectCreatedObservable&&(se.effect=_,se.subMesh=t,this._onEffectCreatedObservable.notifyObservers(se)),this.allowShaderHotSwapping&&u&&!_.isReady()){if(_=u,r.markAsUnprocessed(),T=this.isFrozen,l)return r._areLightsDisposed=true,false}else n.resetCachedMaterial(),t.setEffect(_,r,this._materialContext);return !(!t.effect||!t.effect.isReady())&&(r._renderId=n.getRenderId(),i._wasPreviouslyReady=!T,i._wasPreviouslyUsingInstances=!!s,this._checkScenePerformancePriority(),true)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vTangentSpaceParams",2),e.addUniform("vLightingIntensity",4),e.addUniform("pointSize",1),e.addUniform("vDebugMode",2),e.addUniform("cameraInfo",4),ar$1(e,true,true,true,true,true),Object.values(this._uniformsList).forEach((t=>{e.addUniform(t.name,t.numComponents);})),Object.values(this._samplersList).forEach((t=>{e.addUniform(t.samplerInfoName,2),e.addUniform(t.samplerMatrixName,16);})),super.buildUniformLayout();}bindForSubMesh(e,t,s){const r=this.getScene(),n=s.materialDefines;if(!n)return;const o=s.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e);const a=r.getEngine();this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),ll.Bind(a.currentRenderPassId,this._activeEffect,t,e,this);const h=r.activeCamera;h?this._uniformBuffer.updateFloat4("cameraInfo",h.minZ,h.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=s,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const u=this._mustRebind(r,o,s,t.visibility);Hs(t,this._activeEffect,this.prePassConfiguration);let l=null;const _=this._uniformBuffer;if(u){if(this.bindViewProjection(o),l=this._getRadianceTexture(),!_.useUbo||!this.isFrozen||!_.isSync||s._drawWrapper._forceRebindOnNextCall){if(r.texturesEnabled){for(const e in this._samplersList){const t=this._samplersList[e];t.value&&(_.updateFloat2(t.samplerInfoName,t.value.coordinatesIndex,t.value.level),Gs(t.value,_,t.samplerPrefix));}this.geometryNormalTexture&&(r._mirroredCameraPosition?_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),Bs(r,n,_,ge$3.White(),l,this.realTimeFiltering,true,true,true,true,true);}this.pointsCloud&&_.updateFloat("pointSize",this.pointSize),Object.values(this._uniformsList).forEach((e=>{4===e.numComponents?(e.populateVectorFromLinkedProperties(ae$5.Vector4[0]),_.updateVector4(e.name,ae$5.Vector4[0])):3===e.numComponents?(e.populateVectorFromLinkedProperties(ae$5.Vector3[0]),_.updateVector3(e.name,ae$5.Vector3[0])):2===e.numComponents?(e.populateVectorFromLinkedProperties(ae$5.Vector2[0]),_.updateFloat2(e.name,ae$5.Vector2[0].x,ae$5.Vector2[0].y)):1===e.numComponents&&_.updateFloat(e.name,e.linkedProperties[Object.keys(e.linkedProperties)[0]].value);})),this._lightingInfos.x=this.directIntensity,this._lightingInfos.y=this.emissionLuminance,this._lightingInfos.z=this.environmentIntensity*r.environmentIntensity,this._lightingInfos.w=1,_.updateVector4("vLightingIntensity",this._lightingInfos),_.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor);}if(r.texturesEnabled){for(const e in this._samplersList){const t=this._samplersList[e];t.value&&_.setTexture(t.samplerName,t.value);}Us(r,n,_,l,this.realTimeFiltering),n.ENVIRONMENTBRDF&&_.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),n.FUZZENVIRONMENTBRDF&&_.setTexture("environmentFuzzBrdfSampler",this._environmentFuzzBRDFTexture),(n.ANISOTROPIC||n.FUZZ)&&_.setTexture("blueNoiseSampler",ue._noiseTextures[this.getScene().uniqueId]);}this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=s,this._callbackPluginEventBindForSubMesh(this._eventInfo),As(this._activeEffect,this,r),this.bindEyePosition(o);}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=true);!u&&this.isFrozen||(r.lightsEnabled&&!this._disableLighting&&Xs(r,t,this._activeEffect,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==ch.FOGMODE_NONE||l||t.receiveShadows||n.PREPASS)&&this.bindView(o),Os(r,t,this._activeEffect,true),n.NUM_MORPH_INFLUENCERS&&ws(t,this._activeEffect),n.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(o,n.INSTANCES),this._imageProcessingConfiguration.bind(this._activeEffect),Cs(n,this._activeEffect,r)),this._afterBind(t,this._activeEffect,s),_.update();}getAnimatables(){const e=super.getAnimatables();for(const t in this._samplersList){const s=this._samplersList[t];s.value&&s.value.animations&&s.value.animations.length>0&&e.push(s.value);}return this._radianceTexture&&this._radianceTexture.animations&&this._radianceTexture.animations.length>0&&e.push(this._radianceTexture),e}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._samplersList){const s=this._samplersList[t];s.value&&e.push(s.value);}return this._radianceTexture&&e.push(this._radianceTexture),e}hasTexture(e){if(super.hasTexture(e))return  true;for(const t in this._samplersList){if(this._samplersList[t].value===e)return  true}return this._radianceTexture===e}setPrePassRenderer(){return  false}dispose(e,t){if(this._breakShaderLoadedCheck=true,t){this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),this._environmentFuzzBRDFTexture&&this.getScene().environmentFuzzBRDFTexture!==this._environmentFuzzBRDFTexture&&this._environmentFuzzBRDFTexture.dispose();for(const e in this._samplersList){const t=this._samplersList[e];t.value?.dispose();}this._radianceTexture?.dispose();}this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t);}_getRadianceTexture(){return this._radianceTexture?this._radianceTexture:this.getScene().environmentTexture}_prepareEffect(e,t,i,r=null,n=null,o=null,a=null){if(this._prepareDefines(e,t,i,o,a),!i.isDirty)return null;i.markAsProcessed();const h=this.getScene().getEngine(),u=new ro;let l=0;i.USESPHERICALINVERTEX&&u.addFallback(l++,"USESPHERICALINVERTEX"),i.FOG&&u.addFallback(l,"FOG"),i.SPECULARAA&&u.addFallback(l,"SPECULARAA"),i.POINTSIZE&&u.addFallback(l,"POINTSIZE"),i.LOGARITHMICDEPTH&&u.addFallback(l,"LOGARITHMICDEPTH"),i.PARALLAX&&u.addFallback(l,"PARALLAX"),i.PARALLAX_RHS&&u.addFallback(l,"PARALLAX_RHS"),i.PARALLAXOCCLUSION&&u.addFallback(l++,"PARALLAXOCCLUSION"),i.ENVIRONMENTBRDF&&u.addFallback(l++,"ENVIRONMENTBRDF"),i.TANGENT&&u.addFallback(l++,"TANGENT"),l=Ks(i,u,this._maxSimultaneousLights,l++),i.SPECULARTERM&&u.addFallback(l++,"SPECULARTERM"),i.USESPHERICALFROMREFLECTIONMAP&&u.addFallback(l++,"USESPHERICALFROMREFLECTIONMAP"),i.USEIRRADIANCEMAP&&u.addFallback(l++,"USEIRRADIANCEMAP"),i.NORMAL&&u.addFallback(l++,"NORMAL"),i.VERTEXCOLOR&&u.addFallback(l++,"VERTEXCOLOR"),i.MORPHTARGETS&&u.addFallback(l++,"MORPHTARGETS"),i.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");const T=[Hi.PositionKind];i.NORMAL&&T.push(Hi.NormalKind),i.TANGENT&&T.push(Hi.TangentKind);for(let e=1;e<=Qe$1.MAX_SUPPORTED_UV_SETS;++e)i["UV"+e]&&T.push(`uv${1===e?"":e}`);i.VERTEXCOLOR&&T.push(Hi.ColorKind),Ws(T,e,i,u),Ys(T,i),Ls(T,e,i),Vs(T,e,i);let m="openpbr";const E=["world","view","viewProjection","vEyePosition","vLightsType","visibility","vFogInfos","vFogColor","pointSize","mBones","normalMatrix","vLightingIntensity","logarithmicDepthConstant","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"];for(const e in this._uniformsList)E.push(e);const p=["environmentBrdfSampler","blueNoiseSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"];i.FUZZENVIRONMENTBRDF&&p.push("environmentFuzzBrdfSampler");for(const e in this._samplersList){const t=this._samplersList[e];p.push(t.samplerName),E.push(t.samplerInfoName),E.push(t.samplerMatrixName);}rr$1(E,p,true);const R=["Material","Scene","Mesh"],g={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:i.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=l,this._eventInfo.defines=i,this._eventInfo.uniforms=E,this._eventInfo.attributes=T,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=R,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=g,this._callbackPluginEventGeneric(128,this._eventInfo),ll.AddUniformsAndSamplers(E,p),Kh.AddUniforms(E),Ts(E),En&&(En.PrepareUniforms(E,i),En.PrepareSamplers(p,i)),nr$1({uniformsNames:E,uniformBuffersNames:R,samplers:p,defines:i,maxSimultaneousLights:this._maxSimultaneousLights});const S={};this.customShaderNameResolve&&(m=this.customShaderNameResolve(m,E,R,p,i,T,S));const f=i.toString(),d=h.createEffect(m,{attributes:T,uniformsNames:E,uniformBuffersNames:R,samplers:p,defines:f,fallbacks:u,onCompiled:r,onError:n,indexParameters:g,processFinalCode:S.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:i.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(function(){return openpbr_vertex_dEIwCXg_esm_min}),Promise.resolve().then(function(){return openpbr_fragmentCktw1RDZ_esm_min})]):await Promise.all([Promise.resolve().then(function(){return openpbr_vertexCynSCk0h_esm_min}),Promise.resolve().then(function(){return openpbr_fragmentDM6IZaN_esm_min})]),this._shadersLoaded=true;}},h);return this._eventInfo.customCode=void 0,d}_prepareDefines(e,i,r,n=null,o=null){const a=i.hasThinInstances,u=this.getScene(),_=u.getEngine();Qs(u,e,r,true,this._maxSimultaneousLights,this._disableLighting),r._needNormals=true,er$1(u,r);const T=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(ir$1(u,r,this.canRenderToMRT&&!T),tr$1(u,r,T),ll.PrepareDefines(_.currentRenderPassId,e,r),r.METALLICWORKFLOW=true,r._areTexturesDirty){r._needUVs=false;for(let e=1;e<=Qe$1.MAX_SUPPORTED_UV_SETS;++e)r["MAINUV"+e]=false;if(u.texturesEnabled){for(const e in this._samplersList){const t=this._samplersList[e];t.value?(ks(t.value,r,t.textureDefine),r[t.textureDefine+"_GAMMA"]=t.value.gammaSpace):r[t.textureDefine]=false;}const e=this._getRadianceTexture(),t=this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||_.getCaps().maxVaryingVectors<=8||null!=this._baseDiffuseRoughnessTexture;qs(u,e,r,this.realTimeFiltering,this.realTimeFilteringQuality,!t),this._baseMetalnessTexture&&(r.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed),r.SPECULAR_WEIGHT_IN_ALPHA=this._useSpecularWeightFromAlpha,r.SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE=this._useSpecularWeightFromSpecularColorTexture,r.SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE=this._useSpecularRoughnessAnisotropyFromTangentTexture,r.COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE=this._useCoatRoughnessAnisotropyFromTangentTexture,r.ROUGHNESSSTOREINMETALMAPGREEN=this._useRoughnessFromMetallicTextureGreen,r.METALLNESSSTOREINMETALMAPBLUE=this._useMetallicFromMetallicTextureBlue,r.THIN_FILM_THICKNESS_FROM_THIN_FILM_TEXTURE=this._useThinFilmThicknessFromTextureGreen,this.geometryNormalTexture?(this._useParallax&&this.baseColorTexture&&bs.DiffuseTextureEnabled?(r.PARALLAX=true,r.PARALLAX_RHS=u.useRightHandedSystem,r.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):r.PARALLAX=false,r.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(r.PARALLAX=false,r.PARALLAX_RHS=false,r.PARALLAXOCCLUSION=false,r.OBJECTSPACE_NORMALMAP=false),this._environmentBRDFTexture&&bs.ReflectionTextureEnabled?(r.ENVIRONMENTBRDF=true,r.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(r.ENVIRONMENTBRDF=false,r.ENVIRONMENTBRDF_RGBD=false),this._environmentFuzzBRDFTexture?r.FUZZENVIRONMENTBRDF=true:r.FUZZENVIRONMENTBRDF=false,this._shouldUseAlphaFromBaseColorTexture()?r.ALPHA_FROM_BASE_COLOR_TEXTURE=true:r.ALPHA_FROM_BASE_COLOR_TEXTURE=false;}this._lightFalloff===hr$1.LIGHTFALLOFF_STANDARD?(r.USEPHYSICALLIGHTFALLOFF=false,r.USEGLTFLIGHTFALLOFF=false):this._lightFalloff===hr$1.LIGHTFALLOFF_GLTF?(r.USEPHYSICALLIGHTFALLOFF=false,r.USEGLTFLIGHTFALLOFF=true):(r.USEPHYSICALLIGHTFALLOFF=true,r.USEGLTFLIGHTFALLOFF=false),!this.backFaceCulling&&this._twoSidedLighting?r.TWOSIDEDLIGHTING=true:r.TWOSIDEDLIGHTING=false,r.MIRRORED=!!u._mirroredCameraPosition,r.SPECULARAA=_.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing;}(r._areTexturesDirty||r._areMiscDirty)&&(r.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,r.PREMULTIPLYALPHA=this.alphaMode===Qe$1.ALPHA_PREMULTIPLIED||this.alphaMode===Qe$1.ALPHA_PREMULTIPLIED_PORTERDUFF,r.ALPHABLEND=this.needAlphaBlendingForMesh(e)),r._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(r),r.FORCENORMALFORWARD=this._forceNormalForward,r.RADIANCEOCCLUSION=this._useRadianceOcclusion,r.HORIZONOCCLUSION=this._useHorizonOcclusion,(this.specularRoughnessAnisotropy>0||this.coatRoughnessAnisotropy>0)&&ue._noiseTextures[u.uniqueId]&&bs.ReflectionTextureEnabled?(r.ANISOTROPIC=true,e.isVerticesDataPresent(Hi.TangentKind)||(r._needUVs=true,r.MAINUV1=true),this._useGltfStyleAnisotropy&&(r.USE_GLTF_STYLE_ANISOTROPY=true),r.ANISOTROPIC_BASE=this.specularRoughnessAnisotropy>0,r.ANISOTROPIC_COAT=this.coatRoughnessAnisotropy>0):(r.ANISOTROPIC=false,r.USE_GLTF_STYLE_ANISOTROPY=false,r.ANISOTROPIC_BASE=false,r.ANISOTROPIC_COAT=false),r.THIN_FILM=this.thinFilmWeight>0,r.IRIDESCENCE=this.thinFilmWeight>0,r.FUZZ=this.fuzzWeight>0&&bs.ReflectionTextureEnabled,r.FUZZ?(e.isVerticesDataPresent(Hi.TangentKind)||(r._needUVs=true,r.MAINUV1=true),this._environmentFuzzBRDFTexture=kh(this.getScene()),r.FUZZ_IBL_SAMPLES=this.fuzzSampleNumber):(this._environmentFuzzBRDFTexture=null,r.FUZZENVIRONMENTBRDF=false,r.FUZZ_IBL_SAMPLES=0),r._areMiscDirty&&(js(e,u,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),r,this._applyDecalMapAfterDetailMap,this._useVertexPulling,i,this._isVertexOutputInvariant),r.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(Hi.NormalKind),r.DEBUGMODE=this._debugMode),Js(u,_,this,r,!!n,o,a),this._eventInfo.defines=r,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),$s(e,r,true,true,true,this._transparencyMode!==hr$1.MATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo);}}ue._noiseTextures={},ue.ForceGLSL=false,e$z([m$q("_markAllSubMeshesAsTexturesDirty","baseWeight")],ue.prototype,"_baseWeight",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","baseWeightTexture")],ue.prototype,"_baseWeightTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","baseColor")],ue.prototype,"_baseColor",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","baseColorTexture")],ue.prototype,"_baseColorTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","baseDiffuseRoughness")],ue.prototype,"_baseDiffuseRoughness",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","baseDiffuseRoughnessTexture")],ue.prototype,"_baseDiffuseRoughnessTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","baseMetalness")],ue.prototype,"_baseMetalness",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","baseMetalnessTexture")],ue.prototype,"_baseMetalnessTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","specularWeight")],ue.prototype,"_specularWeight",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","specularWeightTexture")],ue.prototype,"_specularWeightTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","specularColor")],ue.prototype,"_specularColor",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","specularColorTexture")],ue.prototype,"_specularColorTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","specularRoughness")],ue.prototype,"_specularRoughness",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","specularRoughnessTexture")],ue.prototype,"_specularRoughnessTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","specularRoughnessAnisotropy")],ue.prototype,"_specularRoughnessAnisotropy",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","specularRoughnessAnisotropyTexture")],ue.prototype,"_specularRoughnessAnisotropyTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","specularIor")],ue.prototype,"_specularIor",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatWeight")],ue.prototype,"_coatWeight",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatWeightTexture")],ue.prototype,"_coatWeightTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatColor")],ue.prototype,"_coatColor",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatColorTexture")],ue.prototype,"_coatColorTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatRoughness")],ue.prototype,"_coatRoughness",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatRoughnessTexture")],ue.prototype,"_coatRoughnessTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatRoughnessAnisotropy")],ue.prototype,"_coatRoughnessAnisotropy",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatRoughnessAnisotropyTexture")],ue.prototype,"_coatRoughnessAnisotropyTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatIor")],ue.prototype,"_coatIor",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatDarkening")],ue.prototype,"_coatDarkening",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","coatDarkeningTexture")],ue.prototype,"_coatDarkeningTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","fuzzWeight")],ue.prototype,"_fuzzWeight",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","fuzzWeightTexture")],ue.prototype,"_fuzzWeightTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","fuzzColor")],ue.prototype,"_fuzzColor",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","fuzzColorTexture")],ue.prototype,"_fuzzColorTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","fuzzRoughness")],ue.prototype,"_fuzzRoughness",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","fuzzRoughnessTexture")],ue.prototype,"_fuzzRoughnessTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","geometryNormalTexture")],ue.prototype,"_geometryNormalTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","geometryTangent")],ue.prototype,"_geometryTangent",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","geometryTangentTexture")],ue.prototype,"_geometryTangentTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","geometryCoatNormalTexture")],ue.prototype,"_geometryCoatNormalTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","geometryCoatTangent")],ue.prototype,"_geometryCoatTangent",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","geometryCoatTangentTexture")],ue.prototype,"_geometryCoatTangentTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","geometryOpacity")],ue.prototype,"_geometryOpacity",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","geometryOpacityTexture")],ue.prototype,"_geometryOpacityTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","emissionLuminance")],ue.prototype,"_emissionLuminance",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","emissionColor")],ue.prototype,"_emissionColor",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","emissionColorTexture")],ue.prototype,"_emissionColorTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","thinFilmWeight")],ue.prototype,"_thinFilmWeight",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","thinFilmWeightTexture")],ue.prototype,"_thinFilmWeightTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","thinFilmThickness")],ue.prototype,"_thinFilmThickness",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","thinFilmThicknessMin")],ue.prototype,"_thinFilmThicknessMin",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","thinFilmThicknessTexture")],ue.prototype,"_thinFilmThicknessTexture",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","thinFilmIor")],ue.prototype,"_thinFilmIor",void 0),e$z([m$q("_markAllSubMeshesAsTexturesDirty","ambientOcclusionTexture")],ue.prototype,"_ambientOcclusionTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"directIntensity",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"environmentIntensity",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useSpecularWeightFromTextureAlpha",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesAndMiscDirty")],ue.prototype,"forceAlphaTest",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesAndMiscDirty")],ue.prototype,"alphaCutOff",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useAmbientInGrayScale",void 0),e$z([a$$()],ue.prototype,"usePhysicalLightFalloff",null),e$z([a$$()],ue.prototype,"useGLTFLightFalloff",null),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useObjectSpaceNormalMap",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useParallax",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useParallaxOcclusion",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"parallaxScaleBias",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsLightsDirty")],ue.prototype,"disableLighting",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"forceIrradianceInFragment",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsLightsDirty")],ue.prototype,"maxSimultaneousLights",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"invertNormalMapX",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"invertNormalMapY",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"twoSidedLighting",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useAlphaFresnel",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useLinearAlphaFresnel",void 0),e$z([n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"environmentBRDFTexture",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"forceNormalForward",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"enableSpecularAntiAliasing",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useHorizonOcclusion",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],ue.prototype,"useRadianceOcclusion",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],ue.prototype,"unlit",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsMiscDirty")],ue.prototype,"applyDecalMapAfterDetailMap",void 0),e$z([n$1W("_markAllSubMeshesAsMiscDirty")],ue.prototype,"debugMode",void 0),e$z([a$$()],ue.prototype,"transparencyMode",null),P$9("BABYLON.OpenPBRMaterial",ue);
var openpbrMaterialXlELrdGM_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,OpenPBRMaterial:ue,OpenPBRMaterialDefines:ae});Object.defineProperty(ch.prototype,"iblCdfGenerator",{get:function(){return this._iblCdfGenerator},set:function(e){e&&(this._iblCdfGenerator=e);},enumerable:true,configurable:true}),ch.prototype.enableIblCdfGenerator=function(){return this._iblCdfGenerator?this._iblCdfGenerator:(this._iblCdfGenerator=new R$4(this),this._iblCdfGenerator.isSupported?(this.environmentTexture&&(this._iblCdfGenerator.iblSource=this.environmentTexture),this._iblCdfGenerator):(this._iblCdfGenerator=null,null))},ch.prototype.disableIblCdfGenerator=function(){this._iblCdfGenerator&&(this._iblCdfGenerator.dispose(),this._iblCdfGenerator=null);};let n$K=class n{constructor(t){this.name=cr$1.NAME_IBLCDFGENERATOR,this._newIblObserver=null,this.scene=t;}register(){this._updateIblSource(),this._newIblObserver=this.scene.onEnvironmentTextureChangedObservable.add(this._updateIblSource.bind(this));}rebuild(){}dispose(){this.scene.onEnvironmentTextureChangedObservable.remove(this._newIblObserver);}_updateIblSource(){this.scene.iblCdfGenerator&&this.scene.environmentTexture&&(this.scene.iblCdfGenerator.iblSource=this.scene.environmentTexture);}};R$4._SceneComponentInitialization=t=>{let r=t._getComponent(cr$1.NAME_IBLCDFGENERATOR);r||(r=new n$K(t),t._addComponent(r));};var iblCdfGeneratorSceneComponentDJa78QH7_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,IblCdfGeneratorSceneComponent:n$K});let O$5=class O{getVoxelGrid(){return this._engine.isWebGPU?this._voxelGrid:this._triPlanarVoxelization?this._combinedVoxelGridPT:this._voxelGridZaxis}getDebugPassPP(){return this._voxelDebugPass||this._createDebugPass(),this._voxelDebugPass}get triPlanarVoxelization(){return this._triPlanarVoxelization}set triPlanarVoxelization(e){this._engine.isWebGPU?this._triPlanarVoxelization=true:this._triPlanarVoxelization!==e&&(this._triPlanarVoxelization=e,this._disposeVoxelTextures(),this._createTextures());}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e;}isVoxelizationInProgress(){return this._voxelizationInProgress}get voxelResolutionExp(){return this._voxelResolutionExp}set voxelResolutionExp(e){this._voxelResolutionExp===e&&this._voxelGridZaxis||(this._voxelResolutionExp=Math.round(Math.min(Math.max(e,3),9)),this._voxelResolution=Math.pow(2,this._voxelResolutionExp),this._disposeVoxelTextures(),this._createTextures());}set voxelDebugAxis(e){this._voxelDebugAxis=e;}get voxelDebugAxis(){return this._voxelDebugAxis}setDebugDisplayParams(e,s,t,i){this._debugSizeParams.set(e,s,t,i);}setDebugMipNumber(e){this._debugMipNumber=e;}get debugPassName(){return this._debugPassName}get voxelDebugEnabled(){return this._voxelDebugEnabled}set voxelDebugEnabled(t){this._voxelDebugEnabled!==t&&(this._voxelDebugEnabled=t,t&&(this._voxelSlabDebugRT=new ua("voxelSlabDebug",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},this._scene,{generateDepthBuffer:true,generateMipMaps:false,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_RGBA,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE}),this._voxelSlabDebugRT.noPrePassRenderer=true),this._voxelSlabDebugRT&&this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelDebugEnabled?(this._addRTsForRender([this._voxelSlabDebugRT],this._includedMeshes,this._voxelDebugAxis,1,true),this._setDebugBindingsBound=this._setDebugBindings.bind(this),this._scene.onBeforeRenderObservable.add(this._setDebugBindingsBound)):this._scene.onBeforeRenderObservable.removeCallback(this._setDebugBindingsBound));}_createDebugPass(){const e=this._engine.isWebGPU;if(!this._voxelDebugPass){const i={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:Qe$1.TEXTUREFORMAT_RGBA,textureType:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,uniforms:["sizeParams","mipNumber"],samplers:["voxelTexture","voxelSlabTexture"],engine:this._engine,reusable:false,shaderLanguage:e?1:0,extraInitializations:(e,s)=>{e?s.push(Promise.resolve().then(function(){return iblVoxelGrid3dDebug_fragmentBzMWIIr9_esm_min})):s.push(Promise.resolve().then(function(){return iblVoxelGrid3dDebug_fragmentC3nN8Qcl_esm_min}));}};this._voxelDebugPass=new Aa(this.debugPassName,"iblVoxelGrid3dDebug",i),this._voxelDebugPass.onApplyObservable.add((e=>{0===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridXaxis):1===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridYaxis):2===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridZaxis):e.setTexture("voxelTexture",this.getVoxelGrid()),e.setTexture("voxelSlabTexture",this._voxelSlabDebugRT),e.setVector4("sizeParams",this._debugSizeParams),e.setFloat("mipNumber",this._debugMipNumber);}));}}constructor(e,s,t=6,d=true){this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[],this._voxelClearColor=new me$3(0,0,0,1),this.onVoxelizationCompleteObservable=new R$g,this._renderTargets=[],this._triPlanarVoxelization=true,this._voxelizationInProgress=false,this._invWorldScaleMatrix=re$5.Identity(),this._voxelResolution=64,this._voxelResolutionExp=6,this._mipArray=[],this._voxelDebugEnabled=false,this._voxelDebugAxis=-1,this._debugSizeParams=new ie$5(0,0,0,0),this._includedMeshes=[],this._debugMipNumber=0,this._debugPassName="Voxelization Debug Pass",this._scene=e,this._engine=e.getEngine(),this._triPlanarVoxelization=this._engine.isWebGPU||d,this._engine.getCaps().drawBuffersExtension||Ie$2.Error("Can't do voxel rendering without the draw buffers extension.");const u=this._engine.isWebGPU;this._maxDrawBuffers=this._engine.getCaps().maxDrawBuffers||0,this._copyMipEffectRenderer=new Ta(this._engine),this._copyMipEffectWrapper=new Ea({engine:this._engine,fragmentShader:"copyTexture3DLayerToTexture",useShaderStore:true,uniformNames:["layerNum"],samplerNames:["textureSampler"],shaderLanguage:u?1:0,extraInitializationsAsync:async()=>{u?await Promise.resolve().then(function(){return copyTexture3DLayerToTexture_fragment5kwSxp1c_esm_min}):await Promise.resolve().then(function(){return copyTexture3DLayerToTexture_fragmentDSGGUbB8_esm_min});}}),this.voxelResolutionExp=t;}_generateMipMaps(){const e=Math.ceil(Math.log2(this._voxelResolution));for(let s=1;s<e+1;s++)this._generateMipMap(s);}_generateMipMap(e){const s=this._mipArray[e-1];s&&(s.setTexture("srcMip",1===e?this.getVoxelGrid():this._mipArray[e-2]),s.render());}_copyMipMaps(){const e=Math.ceil(Math.log2(this._voxelResolution));for(let s=1;s<e+1;s++)this._copyMipMap(s);}_copyMipMap(s){const t=this._mipArray[s-1];if(!t)return;const i=this.getVoxelGrid();let a;if(a=i instanceof ua&&i.renderTarget?i.renderTarget:i._rtWrapper,a){this._copyMipEffectRenderer.saveStates();const e=t.getSize().width;for(let i=0;i<e;i++)this._engine.bindFramebuffer(a,0,e,e,true,s,i),this._copyMipEffectRenderer.applyEffectWrapper(this._copyMipEffectWrapper),this._copyMipEffectWrapper.effect.setTexture("textureSampler",t),this._copyMipEffectWrapper.effect.setInt("layerNum",i),this._copyMipEffectRenderer.draw(),this._engine.unBindFramebuffer(a,true);this._copyMipEffectRenderer.restoreStates();}}_computeNumberOfSlabs(){return Math.ceil(this._voxelResolution/this._maxDrawBuffers)}_createTextures(){const t=this._engine.isWebGPU,i={width:this._voxelResolution,height:this._voxelResolution,depth:this._voxelResolution},a={generateDepthBuffer:false,generateMipMaps:false,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_RGBA,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE},r=this._computeNumberOfSlabs(),n={generateDepthBuffer:false,generateMipMaps:true,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_R,samplingMode:Qe$1.TEXTURE_NEAREST_NEAREST_MIPNEAREST,shaderLanguage:t?1:0,extraInitializationsAsync:async()=>{t?await Promise.resolve().then(function(){return iblCombineVoxelGrids_fragmentD8SoWI7m_esm_min}):await Promise.resolve().then(function(){return iblCombineVoxelGrids_fragmentBt586LSl_esm_min});}};this._engine.isWebGPU?(this._voxelGrid=new ua("voxelGrid",i,this._scene,{...n,format:Qe$1.TEXTUREFORMAT_RGBA,creationFlags:Qe$1.TEXTURE_CREATIONFLAG_STORAGE}),this._voxelGridRT=new ua("voxelGridRT",{width:Math.min(2*i.width,2048),height:Math.min(2*i.height,2048)},this._scene,a)):this._triPlanarVoxelization?(this._voxelGridXaxis=new ua("voxelGridXaxis",i,this._scene,a),this._voxelGridYaxis=new ua("voxelGridYaxis",i,this._scene,a),this._voxelGridZaxis=new ua("voxelGridZaxis",i,this._scene,a),this._voxelMrtsXaxis=this._createVoxelMRTs("x_axis_",this._voxelGridXaxis,r),this._voxelMrtsYaxis=this._createVoxelMRTs("y_axis_",this._voxelGridYaxis,r),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,r),this._combinedVoxelGridPT=new E$6("combinedVoxelGrid",i,"iblCombineVoxelGrids",this._scene,n,false),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._combinedVoxelGridPT),1),this._combinedVoxelGridPT.setFloat("layer",0),this._combinedVoxelGridPT.setTexture("voxelXaxisSampler",this._voxelGridXaxis),this._combinedVoxelGridPT.setTexture("voxelYaxisSampler",this._voxelGridYaxis),this._combinedVoxelGridPT.setTexture("voxelZaxisSampler",this._voxelGridZaxis),this._combinedVoxelGridPT.autoClear=false,this._combinedVoxelGridPT.wrapU=Is.CLAMP_ADDRESSMODE,this._combinedVoxelGridPT.wrapV=Is.CLAMP_ADDRESSMODE):(this._voxelGridZaxis=new ua("voxelGridZaxis",i,this._scene,n),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,r));const o={generateDepthBuffer:false,generateMipMaps:false,type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_R,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,shaderLanguage:t?1:0,extraInitializationsAsync:async()=>{t?await Promise.resolve().then(function(){return iblGenerateVoxelMip_fragmentCnq3ynan_esm_min}):await Promise.resolve().then(function(){return iblGenerateVoxelMip_fragmentDpBKrocX_esm_min});}};this._mipArray=new Array(Math.ceil(Math.log2(this._voxelResolution)));for(let e=1;e<=this._mipArray.length;e++){const s=this._voxelResolution>>e,t={width:s,height:s,depth:s};this._mipArray[e-1]=new E$6("voxelMip"+e,t,"iblGenerateVoxelMip",this._scene,o,false),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._mipArray[e-1]),1);const i=this._mipArray[e-1];i.autoClear=false,i.wrapU=Is.CLAMP_ADDRESSMODE,i.wrapV=Is.CLAMP_ADDRESSMODE,i.setTexture("srcMip",e>1?this._mipArray[e-2]:this.getVoxelGrid()),i.setInt("layerNum",0);}this._createVoxelMaterials();}_createVoxelMRTs(e,t,a){t.wrapU=Is.CLAMP_ADDRESSMODE,t.wrapV=Is.CLAMP_ADDRESSMODE,t.noPrePassRenderer=true;const r=[],n=new Array(this._maxDrawBuffers).fill(Qe$1.TEXTURE_3D);for(let o=0;o<a;o++){let a=new Array(this._maxDrawBuffers).fill(0);a=a.map(((e,s)=>o*this._maxDrawBuffers+s));let h=new Array(this._maxDrawBuffers).fill("");h=h.map(((s,t)=>"voxel_grid_"+e+(o*this._maxDrawBuffers+t)));const l=new E$9("mrt_"+e+o,{width:this._voxelResolution,height:this._voxelResolution,depth:this._voxelResolution},this._maxDrawBuffers,this._scene,{types:new Array(this._maxDrawBuffers).fill(Qe$1.TEXTURETYPE_UNSIGNED_BYTE),samplingModes:new Array(this._maxDrawBuffers).fill(Qe$1.TEXTURE_TRILINEAR_SAMPLINGMODE),generateMipMaps:false,targetTypes:n,formats:new Array(this._maxDrawBuffers).fill(Qe$1.TEXTUREFORMAT_R),faceIndex:new Array(this._maxDrawBuffers).fill(0),layerIndex:a,layerCounts:new Array(this._maxDrawBuffers).fill(this._voxelResolution),generateDepthBuffer:false,generateStencilBuffer:false},h);l.clearColor=new me$3(0,0,0,1),l.noPrePassRenderer=true;for(let e=0;e<this._maxDrawBuffers;e++)l.setInternalTexture(t.getInternalTexture(),e);r.push(l);}return r}_disposeVoxelTextures(){this._stopVoxelization();for(let e=0;e<this._voxelMrtsZaxis.length;e++)this._triPlanarVoxelization&&(this._voxelMrtsXaxis[e].dispose(true),this._voxelMrtsYaxis[e].dispose(true)),this._voxelMrtsZaxis[e].dispose(true);this._triPlanarVoxelization&&(this._voxelGridXaxis?.dispose(),this._voxelGridYaxis?.dispose(),this._combinedVoxelGridPT?.dispose()),this._voxelGridZaxis?.dispose();for(const e of this._mipArray)e.dispose();this._voxelMaterial?.dispose(),this._voxelSlabDebugMaterial?.dispose(),this._mipArray=[],this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[];}_createVoxelMaterials(){const e=this._engine.isWebGPU;this._voxelMaterial=new O$8("voxelization",this._scene,"iblVoxelGrid",{uniforms:["world","viewMatrix","invTransWorld","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(function(){return iblVoxelGrid_fragmentDLV6qCT3_esm_min}),Promise.resolve().then(function(){return iblVoxelGrid_vertexB1sVmNPo_esm_min})]):await Promise.all([Promise.resolve().then(function(){return iblVoxelGrid_fragmentC3isUwpD_esm_min}),Promise.resolve().then(function(){return iblVoxelGrid_vertexCx4vTw4U_esm_min})]);}}),this._voxelMaterial.cullBackFaces=false,this._voxelMaterial.backFaceCulling=false,this._voxelMaterial.depthFunction=eo.ALWAYS,this._voxelSlabDebugMaterial=new O$8("voxelSlabDebug",this._scene,"iblVoxelSlabDebug",{uniforms:["world","viewMatrix","cameraViewMatrix","projection","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(function(){return iblVoxelSlabDebug_fragmentBYgYcS8_esm_min}),Promise.resolve().then(function(){return iblVoxelSlabDebug_vertexCvPqvVgl_esm_min})]):await Promise.all([Promise.resolve().then(function(){return iblVoxelSlabDebug_fragmentT7husl4n_esm_min}),Promise.resolve().then(function(){return iblVoxelSlabDebug_vertexSGiGSfv_esm_min})]);}});}_setDebugBindings(){this._voxelSlabDebugMaterial.setMatrix("projection",this._scene.activeCamera.getProjectionMatrix()),this._voxelSlabDebugMaterial.setMatrix("cameraViewMatrix",this._scene.activeCamera.getViewMatrix());}isReady(){let e=this.getVoxelGrid().isReady();for(let s=0;s<this._mipArray.length;s++){const t=this._mipArray[s].isReady();e&&=t;}return !(!e||this._voxelizationInProgress)}_stopVoxelization(){this._removeVoxelRTs(this._voxelMrtsXaxis),this._removeVoxelRTs(this._voxelMrtsYaxis),this._removeVoxelRTs(this._voxelMrtsZaxis),this._removeVoxelRTs([this._voxelGridRT]);}_removeVoxelRTs(e){const s=this._renderTargets.findIndex((s=>s===e[0]));if(s>=0)this._renderTargets.splice(s,e.length);else {const s=this._scene.customRenderTargets.findIndex((s=>s===e[0]));s>=0&&this._scene.customRenderTargets.splice(s,e.length);}}updateVoxelGrid(e){this._stopVoxelization(),this._includedMeshes=e,this._voxelizationInProgress=true,this._engine.isWebGPU?(this._voxelGridRT.renderList=e,this._addRTsForRender([this._voxelGridRT],e,0)):this._triPlanarVoxelization?(this._addRTsForRender(this._voxelMrtsXaxis,e,0),this._addRTsForRender(this._voxelMrtsYaxis,e,1),this._addRTsForRender(this._voxelMrtsZaxis,e,2)):this._addRTsForRender(this._voxelMrtsZaxis,e,2),this._voxelDebugEnabled&&this._addRTsForRender([this._voxelSlabDebugRT],e,this._voxelDebugAxis,1,true),this._renderVoxelGridBound=this._renderVoxelGrid.bind(this),this._scene.onAfterRenderObservable.add(this._renderVoxelGridBound);}_renderVoxelGrid(){if(this._voxelizationInProgress){let e=this.getVoxelGrid().isReady();for(let s=0;s<this._mipArray.length;s++){const t=this._mipArray[s].isReady();e&&=t;}for(let s=0;s<this._renderTargets.length;s++){const t=this._renderTargets[s].isReadyForRendering();e&&=t;}if(e){if(this._engine.isWebGPU&&this._voxelGrid&&this._voxelGrid.renderTarget)for(let e=0;e<this._voxelResolution;e++)this._engine.bindFramebuffer(this._voxelGrid.renderTarget,0,void 0,void 0,true,0,e),this._engine.clear(this._voxelClearColor,true,false,false),this._engine.unBindFramebuffer(this._voxelGrid.renderTarget,true);for(const e of this._renderTargets)e.render();this._stopVoxelization(),this._triPlanarVoxelization&&!this._engine.isWebGPU&&this._combinedVoxelGridPT.render(),this._generateMipMaps(),this._copyMipEffectWrapper.effect.whenCompiledAsync().then((()=>{this._copyMipMaps(),this._scene.onAfterRenderObservable.removeCallback(this._renderVoxelGridBound),this._voxelizationInProgress=false,this.onVoxelizationCompleteObservable.notifyObservers();}));}}}_addRTsForRender(e,s,t,i=0,a=false){const n=1/this._computeNumberOfSlabs();let o;o=0===i?this._voxelMaterial:this._voxelSlabDebugMaterial;for(let i=0;i<e.length;i++){const a=e[i];a.renderList=[];const h=i*n,l=(i+1)*n,d=n/this._maxDrawBuffers,u=new te$4(0,0,0);let g=new te$4(0,0,1);0===t?g=new te$4(1,0,0):1===t&&(g=new te$4(0,1,0));let c=new te$4(0,1,0);if(1===t&&(c=new te$4(1,0,0)),a.onBeforeRenderObservable.add((()=>{o.setMatrix("viewMatrix",re$5.LookAtLH(u,g,c)),o.setMatrix("invWorldScale",this._invWorldScaleMatrix),o.setFloat("nearPlane",h),o.setFloat("farPlane",l),o.setFloat("stepSize",d),this._engine.isWebGPU&&(this._voxelMaterial.useVertexPulling=true,this._voxelMaterial.setTexture("voxel_storage",this.getVoxelGrid()));})),0===s.length)return;for(const e of s)if(e){e.subMeshes&&e.subMeshes.length>0&&(a.renderList?.push(e),a.setMaterialForRendering(e,o));const s=e.getChildMeshes();for(const e of s)e.subMeshes&&e.subMeshes.length>0&&(a.renderList?.push(e),a.setMaterialForRendering(e,o));}}if(a)for(const s of e) -1===this._scene.customRenderTargets.indexOf(s)&&this._scene.customRenderTargets.push(s);else this._renderTargets=this._renderTargets.concat(e);}resize(){this._voxelSlabDebugRT?.resize({width:this._scene.getEngine().getRenderWidth(),height:this._scene.getEngine().getRenderHeight()});}dispose(){this._disposeVoxelTextures(),this._voxelSlabDebugRT&&(this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelSlabDebugRT.dispose()),this._voxelDebugPass&&this._voxelDebugPass.dispose();}};let B$2=class B{get voxelShadowOpacity(){return this._voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelShadowOpacity=e;}get ssShadowOpacity(){return this._ssShadowOpacity}set ssShadowOpacity(e){this._ssShadowOpacity=e;}get sssSamples(){return this._sssSamples}set sssSamples(e){this._sssSamples=e;}get sssStride(){return this._sssStride}set sssStride(e){this._sssStride=e;}get sssMaxDist(){return this._sssMaxDist}set sssMaxDist(e){this._sssMaxDist=e;}get sssThickness(){return this._sssThickness}set sssThickness(e){this._sssThickness=e;}get voxelNormalBias(){return this._voxelNormalBias}set voxelNormalBias(e){this._voxelNormalBias=e;}get voxelDirectionBias(){return this._voxelDirectionBias}set voxelDirectionBias(e){this._voxelDirectionBias=e;}get sampleDirections(){return this._sampleDirections}set sampleDirections(e){this._sampleDirections=e;}get envRotation(){return this._envRotation}set envRotation(e){this._envRotation=e;}getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e;}set coloredShadows(e){this._coloredShadows=e;}get coloredShadows(){return this._coloredShadows}setDebugDisplayParams(e,s,t,i){this._debugSizeParams.set(e,s,t,i);}_createDebugPass(){const e=this._engine.isWebGPU;if(!this._debugPassPP){const s={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:true,shaderLanguage:e?1:0,extraInitializations:(e,s)=>{e?s.push(Promise.resolve().then(function(){return iblShadowDebug_fragmentDP5B4VsA_esm_min})):s.push(Promise.resolve().then(function(){return iblShadowDebug_fragmentDpcUObyS_esm_min}));}};this._debugPassPP=new Aa(this.debugPassName,"iblShadowDebug",s),this._debugPassPP.autoClear=false,this._debugPassPP.onApplyObservable.add((e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams);}));}}constructor(e,s){this._voxelShadowOpacity=1,this._sssSamples=16,this._sssStride=8,this._sssMaxDist=.05,this._sssThickness=.5,this._ssShadowOpacity=1,this._cameraInvView=re$5.Identity(),this._cameraInvProj=re$5.Identity(),this._invWorldScaleMatrix=re$5.Identity(),this._frameId=0,this._sampleDirections=4,this._shadowParameters=new ie$5(0,0,0,0),this._sssParameters=new ie$5(0,0,0,0),this._opacityParameters=new ie$5(0,0,0,0),this._voxelBiasParameters=new ie$5(0,0,0,0),this._voxelNormalBias=1.4,this._voxelDirectionBias=1.75,this.enabled=true,this.debugEnabled=false,this._debugPassName="Voxel Tracing Debug Pass",this._envRotation=0,this._coloredShadows=false,this._debugVoxelMarchEnabled=false,this._debugSizeParams=new ie$5(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=s,this._createTextures();}_createTextures(){const e=this._createDefines(),t=this._engine.isWebGPU,i={type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_RGBA,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,generateDepthBuffer:false,shaderLanguage:t?1:0,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(function(){return iblShadowVoxelTracing_fragmentDhQtUKFU_esm_min})]):await Promise.all([Promise.resolve().then(function(){return iblShadowVoxelTracing_fragmentDWNiOx1O_esm_min})]);}};this._outputTexture=new E$6("voxelTracingPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowVoxelTracing",this._scene,i),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=false,this._outputTexture.defines=e,this._setBindings(this._scene.activeCamera),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce((()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady);}));}_createDefines(){let e="";return this._scene.useRightHandedSystem&&(e+="#define RIGHT_HANDED\n"),this._debugVoxelMarchEnabled&&(e+="#define VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION 1u\n"),this._coloredShadows&&(e+="#define COLOR_SHADOWS 1u\n"),e}_setBindings(e){this._outputTexture.defines=this._createDefines(),this._outputTexture.setMatrix("viewMtx",e.getViewMatrix()),this._outputTexture.setMatrix("projMtx",e.getProjectionMatrix()),e.getProjectionMatrix().invertToRef(this._cameraInvProj),e.getViewMatrix().invertToRef(this._cameraInvView),this._outputTexture.setMatrix("invProjMtx",this._cameraInvProj),this._outputTexture.setMatrix("invViewMtx",this._cameraInvView),this._outputTexture.setMatrix("wsNormalizationMtx",this._invWorldScaleMatrix),this._frameId++;let s=0;this._scene.environmentTexture&&(s=this._scene.environmentTexture.rotationY??0),s=this._scene.useRightHandedSystem?-(s+.5*Math.PI):s-.5*Math.PI,s%=2*Math.PI,this._shadowParameters.set(this._sampleDirections,this._frameId,1,s),this._outputTexture.setVector4("shadowParameters",this._shadowParameters);const t=this._renderPipeline._getVoxelGridTexture(),i=Math.floor(Math.log2(t.getSize().width));this._voxelBiasParameters.set(this._voxelNormalBias,this._voxelDirectionBias,i,0),this._outputTexture.setVector4("voxelBiasParameters",this._voxelBiasParameters),this._sssParameters.set(this._sssSamples,this._sssStride,this._sssMaxDist,this._sssThickness),this._outputTexture.setVector4("sssParameters",this._sssParameters),this._opacityParameters.set(this._voxelShadowOpacity,this._ssShadowOpacity,0,0),this._outputTexture.setVector4("shadowOpacity",this._opacityParameters),this._outputTexture.setTexture("voxelGridSampler",t),this._outputTexture.setTexture("blueNoiseSampler",this._renderPipeline._getNoiseTexture());const a=this._scene.iblCdfGenerator;if(!a)return Ie$2.Warn("IBLShadowsVoxelTracingPass: Can't bind for render because iblCdfGenerator is not enabled."),false;this._outputTexture.setTexture("icdfSampler",a.getIcdfTexture()),this._coloredShadows&&this._scene.environmentTexture&&this._outputTexture.setTexture("iblSampler",this._scene.environmentTexture);const r=this._scene.geometryBufferRenderer;if(!r)return Ie$2.Warn("IBLShadowsVoxelTracingPass: Can't bind for render because GeometryBufferRenderer is not enabled."),false;const n=r.getTextureIndex(y$3.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",r.getGBuffer().textures[n]);const h=r.getTextureIndex(y$3.NORMAL_TEXTURE_TYPE);return this._outputTexture.setTexture("worldNormalSampler",r.getGBuffer().textures[h]),true}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setBindings(this._scene.activeCamera)&&this._outputTexture.render();}resize(e=1){const s={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.getSize().width===s.width&&this._outputTexture.getSize().height===s.height||this._outputTexture.resize(s,false);}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())&&this._scene.iblCdfGenerator&&this._scene.iblCdfGenerator.getIcdfTexture().isReady()&&this._renderPipeline._getVoxelGridTexture().isReady()}dispose(){if(this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady){this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady);}this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose();}};let G$1=class G{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScale(e){this._worldScale=e;}setDebugDisplayParams(e,s,t,i){this._debugSizeParams.set(e,s,t,i);}_createDebugPass(){if(!this._debugPassPP){const e=this._engine.isWebGPU,i={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:Qe$1.TEXTUREFORMAT_RGBA,textureType:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:false,shaderLanguage:e?1:0,extraInitializations:(e,s)=>{e?s.push(Promise.resolve().then(function(){return iblShadowDebug_fragmentDP5B4VsA_esm_min})):s.push(Promise.resolve().then(function(){return iblShadowDebug_fragmentDpcUObyS_esm_min}));}};this._debugPassPP=new Aa(this.debugPassName,"iblShadowDebug",i),this._debugPassPP.autoClear=false,this._debugPassPP.onApplyObservable.add((e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams);}));}}constructor(e,s){this._worldScale=1,this._blurParameters=new ie$5(0,0,0,0),this.enabled=true,this._debugPassName="Spatial Blur Debug Pass",this.debugEnabled=false,this._debugSizeParams=new ie$5(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=s,this._createTextures();}_createTextures(){const e=this._engine.isWebGPU,t={type:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,format:Qe$1.TEXTUREFORMAT_RGBA,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,generateDepthBuffer:false,generateMipMaps:false,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(function(){return iblShadowSpatialBlur_fragmentHlETMmY4_esm_min})]):await Promise.all([Promise.resolve().then(function(){return iblShadowSpatialBlur_fragmentBLNNNYdL_esm_min})]);}};this._outputTexture=new E$6("spatialBlurPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowSpatialBlur",this._scene,t,false,false,Qe$1.TEXTURETYPE_UNSIGNED_BYTE),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=false,this._setBindings(),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce((()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady);}));}_setBindings(){this._outputTexture.setTexture("voxelTracingSampler",this._renderPipeline._getVoxelTracingTexture());this._blurParameters.set(1,this._worldScale,0,0),this._outputTexture.setVector4("blurParameters",this._blurParameters);const e=this._scene.geometryBufferRenderer;if(!e)return  false;const s=e.getTextureIndex(y$3.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",e.getGBuffer().textures[s]);const t=e.getTextureIndex(y$3.NORMAL_TEXTURE_TYPE);return this._outputTexture.setTexture("worldNormalSampler",e.getGBuffer().textures[t]),true}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setBindings()&&this._outputTexture.render();}resize(e=1){const s={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.getSize().width===s.width&&this._outputTexture.getSize().height===s.height||this._outputTexture.resize(s,false);}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){if(this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady){this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady);}this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose();}};let C$4=class C{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}get remanence(){return this._remanence}set remanence(e){this._remanence=e;}get reset(){return this._reset}set reset(e){this._reset=e;}set isMoving(e){this._isMoving=e;}setDebugDisplayParams(e,s,t,i){this._debugSizeParams.set(e,s,t,i);}_createDebugPass(){if(!this._debugPassPP){const e=this._engine.isWebGPU,i={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:Qe$1.TEXTUREFORMAT_RGBA,textureType:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:false,shaderLanguage:e?1:0,extraInitializations:(e,s)=>{e?s.push(Promise.resolve().then(function(){return iblShadowDebug_fragmentDP5B4VsA_esm_min})):s.push(Promise.resolve().then(function(){return iblShadowDebug_fragmentDpcUObyS_esm_min}));}};this._debugPassPP=new Aa(this.debugPassName,"iblShadowDebug",i),this._debugPassPP.autoClear=false,this._debugPassPP.onApplyObservable.add((e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams);}));}}constructor(e,s){this._accumulationParams=new ie$5(0,0,0,0),this.debugEnabled=false,this.enabled=true,this.onReadyObservable=new R$g,this._debugPassName="Shadow Accumulation Debug Pass",this._remanence=.9,this._reset=true,this._isMoving=false,this._debugSizeParams=new ie$5(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=s,this._createTextures();}_createTextures(){const e=this._engine.isWebGPU,t={type:Qe$1.TEXTURETYPE_HALF_FLOAT,format:Qe$1.TEXTUREFORMAT_RGBA,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,generateDepthBuffer:false,generateMipMaps:false,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(function(){return iblShadowAccumulation_fragmentDTJcBrw_esm_min})]):await Promise.all([Promise.resolve().then(function(){return iblShadowAccumulation_fragment6JCuF3du_esm_min})]);}};this._outputTexture=new E$6("shadowAccumulationPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowAccumulation",this._scene,t),this._outputTexture.refreshRate=1,this._outputTexture.autoClear=false,this._outputTexture.onGeneratedObservable.addOnce((()=>{this.onReadyObservable.notifyObservers();})),this._setOutputTextureBindings(),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce((()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady);}));const i={type:Qe$1.TEXTURETYPE_HALF_FLOAT,format:Qe$1.TEXTUREFORMAT_RGBA,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,generateDepthBuffer:false,generateMipMaps:false,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(function(){return pass_fragmentBTnRKMbi_esm_min})]):await Promise.all([Promise.resolve().then(function(){return pass_fragmentY28YD4oC_esm_min})]);}};this._oldAccumulationCopy=new E$6("oldAccumulationRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,i,false),this._oldAccumulationCopy.autoClear=false,this._oldAccumulationCopy.refreshRate=1,this._oldAccumulationCopy.onBeforeGenerationObservable.add(this._setAccumulationCopyBindings.bind(this)),this._setAccumulationCopyBindings();const a={type:Qe$1.TEXTURETYPE_HALF_FLOAT,format:Qe$1.TEXTUREFORMAT_RGBA,samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,generateDepthBuffer:false,generateMipMaps:false,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(function(){return pass_fragmentBTnRKMbi_esm_min})]):await Promise.all([Promise.resolve().then(function(){return pass_fragmentY28YD4oC_esm_min})]);}};this._oldPositionCopy=new E$6("oldLocalPositionRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,a,false),this._updatePositionCopy(),this._oldPositionCopy.autoClear=false,this._oldPositionCopy.refreshRate=1,this._oldPositionCopy.onBeforeGenerationObservable.add(this._updatePositionCopy.bind(this));}_setOutputTextureBindings(){const e=this._isMoving?this.remanence:.99;this._accumulationParams.set(e,this.reset?1:0,this._renderPipeline.voxelGridSize,0),this._outputTexture.setTexture("spatialBlurSampler",this._renderPipeline._getSpatialBlurTexture()),this._outputTexture.setVector4("accumulationParameters",this._accumulationParams),this._outputTexture.setTexture("oldAccumulationSampler",this._oldAccumulationCopy?this._oldAccumulationCopy:this._renderPipeline._dummyTexture2d),this._outputTexture.setTexture("prevPositionSampler",this._oldPositionCopy?this._oldPositionCopy:this._renderPipeline._dummyTexture2d);const s=this._scene.geometryBufferRenderer;if(!s)return  false;const t=s.getTextureIndex(y$3.VELOCITY_LINEAR_TEXTURE_TYPE);this._outputTexture.setTexture("motionSampler",s.getGBuffer().textures[t]);const i=s.getTextureIndex(y$3.POSITION_TEXTURE_TYPE);return this._outputTexture.setTexture("positionSampler",s.getGBuffer().textures[i]),this.reset=false,this._isMoving=false,true}_updatePositionCopy(){const e=this._scene.geometryBufferRenderer,s=e.getTextureIndex(y$3.POSITION_TEXTURE_TYPE);this._oldPositionCopy.setTexture("textureSampler",e.getGBuffer().textures[s]);}_setAccumulationCopyBindings(){this._oldAccumulationCopy.setTexture("textureSampler",this._outputTexture);}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setOutputTextureBindings()&&this._outputTexture.render();}resize(e=1){const s={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.getSize().width===s.width&&this._outputTexture.getSize().height===s.height||(this._outputTexture.resize(s,false),this._oldAccumulationCopy.resize(s,false),this._oldPositionCopy.resize({width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},false),this.reset=true);}_disposeTextures(){this._oldAccumulationCopy.dispose(),this._oldPositionCopy.dispose(),this._outputTexture.dispose();}isReady(){return this._oldAccumulationCopy&&this._oldAccumulationCopy.isReady()&&this._oldPositionCopy&&this._oldPositionCopy.isReady()&&this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){if(this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady){this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady);}this._disposeTextures(),this._debugPassPP&&this._debugPassPP.dispose(),this.onReadyObservable.clear();}};let I$4=class I extends Is{get width(){return this._texture?this._texture.width:0}get height(){return this._texture?this._texture.height:0}get depth(){return this._texture?this._texture.depth:0}constructor(e,t,i,a,r,n,o=true,h=false,l=Is.TRILINEAR_SAMPLINGMODE,u=Qe$1.TEXTURETYPE_UNSIGNED_BYTE,_){super(null,n,!o,h),this.format=r,this._texture=n.getEngine().createRawTexture3D(e,t,i,a,r,o,h,l,null,u,_),this.is3D=true;}update(e){this._texture&&this._getEngine().updateRawTexture3D(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type);}};let V$4=class V extends Eh{constructor(){super(...arguments),this.RENDER_WITH_IBL_SHADOWS=false,this.COLORED_IBL_SHADOWS=false;}};let N$3=class N extends Xh{get isColored(){return this._isColored}set isColored(e){this._isColored!==e&&(this._isColored=e,this._markAllSubMeshesAsTexturesDirty());}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty();}isCompatible(){return  true}constructor(e){super(e,N.Name,310,new V$4),this.shadowOpacity=1,this._isEnabled=false,this._isColored=false,this.isEnabled=false,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[Qe$1.MATERIAL_TextureDirtyFlag];}prepareDefines(e){e.RENDER_WITH_IBL_SHADOWS=this._isEnabled,e.COLORED_IBL_SHADOWS=this.isColored;}getClassName(){return "IBLShadowsPluginMaterial"}getUniforms(){return {ubo:[{name:"renderTargetSize",size:2,type:"vec2"},{name:"shadowOpacity",size:1,type:"float"}],fragment:"#ifdef RENDER_WITH_IBL_SHADOWS\n                    uniform vec2 renderTargetSize;\n                    uniform float shadowOpacity;\n                #endif"}}getSamplers(e){e.push("iblShadowsTexture");}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("iblShadowsTexture",this.iblShadowsTexture),e.updateFloat2("renderTargetSize",this._material.getScene().getEngine().getRenderWidth(),this._material.getScene().getEngine().getRenderHeight()),e.updateFloat("shadowOpacity",this.shadowOpacity));}getCustomCode(e,s){let t;return 1===s?(t={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    var iblShadowsTextureSampler: sampler;\n                    var iblShadowsTexture: texture_2d<f32>;\n\n                    #ifdef COLORED_IBL_SHADOWS\n                        fn computeIndirectShadow() -> vec3f {\n                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;\n                            var shadowValue: vec3f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rgb;\n                            return mix(shadowValue, vec3f(1.0), 1.0 - uniforms.shadowOpacity);\n                        }\n                    #else\n                        fn computeIndirectShadow() -> vec2f {\n                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;\n                            var shadowValue: vec2f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rg;\n                            return mix(shadowValue, vec2f(1.0), 1.0 - uniforms.shadowOpacity);\n                        }\n                    #endif\n                #endif\n            "},this._material instanceof pl?t.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifndef UNLIT\n                        #ifdef REFLECTION\n                            #ifdef COLORED_IBL_SHADOWS\n                                var shadowValue: vec3f = computeIndirectShadow();\n                                finalIrradiance *= shadowValue;\n                                finalRadianceScaled *= mix(vec3f(1.0), shadowValue, roughness);\n                            #else\n                                var shadowValue: vec2f = computeIndirectShadow();\n                                finalIrradiance *= vec3f(shadowValue.x);\n                                finalRadianceScaled *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness));\n                            #endif\n                        #endif\n                    #else\n                        finalDiffuse *= computeIndirectShadow().x;\n                    #endif\n                #endif\n            ":this._material instanceof ue?t.CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifndef UNLIT\n                        #ifdef REFLECTION\n                            #ifdef COLORED_IBL_SHADOWS\n                                var shadowValue: vec3f = computeIndirectShadow();\n                                slab_diffuse_ibl *= shadowValue;\n                                slab_glossy_ibl *= mix(vec3f(1.0), shadowValue, specularAlphaG);\n                            #else\n                                var shadowValue: vec2f = computeIndirectShadow();\n                                slab_diffuse_ibl *= vec3f(shadowValue.x);\n                                slab_glossy_ibl *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, specularAlphaG));\n                            #endif\n                        #endif\n                    #else\n                        slab_diffuse_ibl *= computeIndirectShadow().x;\n                    #endif\n                #endif\n            ":t.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifdef COLORED_IBL_SHADOWS\n                        var shadowValue: vec3f = computeIndirectShadow();\n                        color *= toGammaSpace(vec4f(shadowValue, 1.0f));\n                    #else\n                        var shadowValue: vec2f = computeIndirectShadow();\n                        color *= toGammaSpace(vec4f(shadowValue.x, shadowValue.x, shadowValue.x, 1.0f));\n                    #endif\n                #endif\n            "):(t={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    uniform sampler2D iblShadowsTexture;\n                #ifdef COLORED_IBL_SHADOWS\n                    vec3 computeIndirectShadow() {\n                        vec2 uv = gl_FragCoord.xy / renderTargetSize;\n                        vec3 shadowValue = texture2D(iblShadowsTexture, uv).rgb;\n                        return mix(shadowValue.rgb, vec3(1.0), 1.0 - shadowOpacity);\n                    }\n                #else\n                    vec2 computeIndirectShadow() {\n                        vec2 uv = gl_FragCoord.xy / renderTargetSize;\n                        vec2 shadowValue = texture2D(iblShadowsTexture, uv).rg;\n                        return mix(shadowValue.rg, vec2(1.0), 1.0 - shadowOpacity);\n                    }\n                #endif\n                #endif\n            "},this._material instanceof pl?t.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifndef UNLIT\n                        #ifdef REFLECTION\n                            #ifdef COLORED_IBL_SHADOWS\n                                vec3 shadowValue = computeIndirectShadow();\n                                finalIrradiance.rgb *= shadowValue.rgb;\n                                finalRadianceScaled *= mix(vec3(1.0), shadowValue.rgb, roughness);\n                            #else\n                                vec2 shadowValue = computeIndirectShadow();\n                                finalIrradiance *= shadowValue.x;\n                                finalRadianceScaled *= mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness);\n                            #endif\n                        #endif\n                    #else\n                        finalDiffuse *= computeIndirectShadow().x;\n                    #endif\n                #endif\n            ":this._material instanceof ue?t.CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifndef UNLIT\n                        #ifdef REFLECTION\n                            #ifdef COLORED_IBL_SHADOWS\n                                vec3 shadowValue = computeIndirectShadow();\n                                slab_diffuse_ibl.rgb *= shadowValue.rgb;\n                                slab_glossy_ibl *= mix(vec3(1.0), shadowValue.rgb, specularAlphaG);\n                            #else\n                                vec2 shadowValue = computeIndirectShadow();\n                                slab_diffuse_ibl *= shadowValue.x;\n                                slab_glossy_ibl *= mix(pow(shadowValue.y, 4.0), shadowValue.x, specularAlphaG);\n                            #endif\n                        #endif\n                    #else\n                        slab_diffuse_ibl *= computeIndirectShadow().x;\n                    #endif\n                #endif\n            ":t.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifdef COLORED_IBL_SHADOWS\n                        vec3 shadowValue = computeIndirectShadow();\n                        color.rgb *= toGammaSpace(shadowValue.rgb);\n                    #else\n                        vec2 shadowValue = computeIndirectShadow();\n                        color.rgb *= toGammaSpace(shadowValue.x);\n                    #endif\n                #endif\n            "),"vertex"===e?null:t}};N$3.Name="IBLShadowsPluginMaterial",e$z([a$$()],N$3.prototype,"shadowOpacity",void 0),e$z([a$$(),n$1W("_markAllSubMeshesAsTexturesDirty")],N$3.prototype,"isEnabled",void 0),P$9("BABYLON.IBLShadowsPluginMaterial",N$3);let z$3=class z extends a$w{resetAccumulation(){this._accumulationPass.reset=true;}get shadowOpacity(){return this._shadowOpacity}set shadowOpacity(e){this._shadowOpacity=e,this._setPluginParameters();}get coloredShadows(){return this._coloredShadows}set coloredShadows(e){this._coloredShadows=e,this._voxelTracingPass.coloredShadows=e,this._setPluginParameters();}get shadowRenderSizeFactor(){return this._renderSizeFactor}set shadowRenderSizeFactor(e){this._renderSizeFactor=Math.max(Math.min(e,1),0),this._voxelTracingPass.resize(e),this._spatialBlurPass.resize(e),this._accumulationPass.resize(e),this._setPluginParameters();}get voxelShadowOpacity(){return this._voxelTracingPass?.voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.voxelShadowOpacity=e);}get ssShadowOpacity(){return this._voxelTracingPass?.ssShadowOpacity}set ssShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.ssShadowOpacity=e);}get ssShadowSampleCount(){return this._voxelTracingPass?.sssSamples}set ssShadowSampleCount(e){this._voxelTracingPass&&(this._voxelTracingPass.sssSamples=e);}get ssShadowStride(){return this._voxelTracingPass?.sssStride}set ssShadowStride(e){this._voxelTracingPass&&(this._voxelTracingPass.sssStride=e);}get ssShadowDistanceScale(){return this._sssMaxDistScale}set ssShadowDistanceScale(e){this._sssMaxDistScale=e,this._updateSsShadowParams();}get ssShadowThicknessScale(){return this._sssThicknessScale}set ssShadowThicknessScale(e){this._sssThicknessScale=e,this._updateSsShadowParams();}_getVoxelGridTexture(){const e=this._voxelRenderer?.getVoxelGrid();return e&&e.isReady()?e:this._dummyTexture3d}_getNoiseTexture(){const e=this._noiseTexture;return e&&e.isReady()?e:this._dummyTexture2d}_getVoxelTracingTexture(){const e=this._voxelTracingPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getSpatialBlurTexture(){const e=this._spatialBlurPass.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getAccumulatedTexture(){const e=this._accumulationPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}get gbufferDebugEnabled(){return this._gbufferDebugEnabled}set gbufferDebugEnabled(e){!e||this.allowDebugPasses?(this._gbufferDebugEnabled=e,e?this._enableEffect(this._getGBufferDebugPass().name,this.cameras):this._disableEffect(this._getGBufferDebugPass().name,this.cameras)):Ie$2.Warn("Can't enable G-Buffer debug view without setting allowDebugPasses to true.");}get cdfDebugEnabled(){return !!this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.debugEnabled}set cdfDebugEnabled(e){this.scene.iblCdfGenerator&&(!e||this.allowDebugPasses?e!==this.scene.iblCdfGenerator.debugEnabled&&(this.scene.iblCdfGenerator.debugEnabled=e,e?this._enableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras):this._disableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras)):Ie$2.Warn("Can't enable importance sampling debug view without setting allowDebugPasses to true."));}get voxelDebugEnabled(){return this._voxelRenderer?.voxelDebugEnabled}set voxelDebugEnabled(e){this._voxelRenderer&&(!e||this.allowDebugPasses?(this._voxelRenderer.voxelDebugEnabled=e,e?this._enableEffect(this._voxelRenderer.debugPassName,this.cameras):this._disableEffect(this._voxelRenderer.debugPassName,this.cameras)):Ie$2.Warn("Can't enable voxel debug view without setting allowDebugPasses to true."));}get voxelDebugAxis(){return this._voxelRenderer?.voxelDebugAxis}set voxelDebugAxis(e){this._voxelRenderer&&(this._voxelRenderer.voxelDebugAxis=e);}set voxelDebugDisplayMip(e){this._voxelRenderer&&this._voxelRenderer.setDebugMipNumber(e);}get voxelTracingDebugEnabled(){return this._voxelTracingPass?.debugEnabled}set voxelTracingDebugEnabled(e){this._voxelTracingPass&&(!e||this.allowDebugPasses?e!==this._voxelTracingPass.debugEnabled&&(this._voxelTracingPass.debugEnabled=e,e?this._enableEffect(this._voxelTracingPass.debugPassName,this.cameras):this._disableEffect(this._voxelTracingPass.debugPassName,this.cameras)):Ie$2.Warn("Can't enable voxel tracing debug view without setting allowDebugPasses to true."));}get spatialBlurPassDebugEnabled(){return this._spatialBlurPass.debugEnabled}set spatialBlurPassDebugEnabled(e){this._spatialBlurPass&&(!e||this.allowDebugPasses?e!==this._spatialBlurPass.debugEnabled&&(this._spatialBlurPass.debugEnabled=e,e?this._enableEffect(this._spatialBlurPass.debugPassName,this.cameras):this._disableEffect(this._spatialBlurPass.debugPassName,this.cameras)):Ie$2.Warn("Can't enable spatial blur debug view without setting allowDebugPasses to true."));}get accumulationPassDebugEnabled(){return this._accumulationPass?.debugEnabled}set accumulationPassDebugEnabled(e){this._accumulationPass&&(!e||this.allowDebugPasses?e!==this._accumulationPass.debugEnabled&&(this._accumulationPass.debugEnabled=e,e?this._enableEffect(this._accumulationPass.debugPassName,this.cameras):this._disableEffect(this._accumulationPass.debugPassName,this.cameras)):Ie$2.Warn("Can't enable accumulation pass debug view without setting allowDebugPasses to true."));}addShadowCastingMesh(e){if(Array.isArray(e))for(const s of e)s&&-1===this._shadowCastingMeshes.indexOf(s)&&this._shadowCastingMeshes.push(s);else e&&-1===this._shadowCastingMeshes.indexOf(e)&&this._shadowCastingMeshes.push(e);}removeShadowCastingMesh(e){if(Array.isArray(e))for(const s of e){const e=this._shadowCastingMeshes.indexOf(s);-1!==e&&this._shadowCastingMeshes.splice(e,1);}else {const s=this._shadowCastingMeshes.indexOf(e);-1!==s&&this._shadowCastingMeshes.splice(s,1);}}clearShadowCastingMeshes(){this._shadowCastingMeshes.length=0;}get resolutionExp(){return this._voxelRenderer.voxelResolutionExp}set resolutionExp(e){e!==this._voxelRenderer.voxelResolutionExp&&(this._voxelRenderer.isVoxelizationInProgress()?Ie$2.Warn("Can't change the resolution of the voxel grid while voxelization is in progress."):(this._voxelRenderer.voxelResolutionExp=Math.max(1,Math.min(e,8)),this._accumulationPass.reset=true));}get sampleDirections(){return this._voxelTracingPass?.sampleDirections}set sampleDirections(e){this._voxelTracingPass&&(this._voxelTracingPass.sampleDirections=e);}get shadowRemanence(){return this._accumulationPass?.remanence}set shadowRemanence(e){this._accumulationPass&&(this._accumulationPass.remanence=e);}get envRotation(){return this._voxelTracingPass?.envRotation}set envRotation(e){this._voxelTracingPass&&(this._voxelTracingPass.envRotation=e,this._accumulationPass.reset=true);}get allowDebugPasses(){return this._allowDebugPasses}set allowDebugPasses(e){this._allowDebugPasses!==e&&(this._allowDebugPasses=e,e&&this.scene.iblCdfGenerator?this.scene.iblCdfGenerator.isReady()?this._createDebugPasses():this.scene.iblCdfGenerator.onGeneratedObservable.addOnce((()=>{this._createDebugPasses();})):this._disposeDebugPasses());}static get IsSupported(){const e=L$7.LastCreatedEngine;return !!e&&e._features.supportIBLShadows}toggleShadow(e){this._enabled=e,this._voxelTracingPass.enabled=e,this._spatialBlurPass.enabled=e,this._accumulationPass.enabled=e;for(const s of this._materialsWithRenderPlugin)if(s.pluginManager){s.pluginManager.getPlugin(N$3.Name).isEnabled=e;}this._setPluginParameters();}updateVoxelization(){0!==this._shadowCastingMeshes.length?(this._voxelRenderer.updateVoxelGrid(this._shadowCastingMeshes),this._voxelRenderer.onVoxelizationCompleteObservable.addOnce((()=>{this.onVoxelizationCompleteObservable.notifyObservers();})),this._updateSsShadowParams()):Ie$2.Warn("IBL Shadows: updateVoxelization called with no shadow-casting meshes to voxelize.");}updateSceneBounds(){const e={min:new te$4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),max:new te$4(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)};for(const s of this._shadowCastingMeshes){const t=s.getHierarchyBoundingVectors(true);e.min=te$4.Minimize(e.min,t.min),e.max=te$4.Maximize(e.max,t.max);}const s=e.max.subtract(e.min);if(this.voxelGridSize=Math.max(s.x,s.y,s.z),0===this._shadowCastingMeshes.length||!isFinite(this.voxelGridSize)||0===this.voxelGridSize)return Ie$2.Warn("IBL Shadows: Scene size is invalid. Can't update bounds."),void(this.voxelGridSize=1);const t=this.voxelGridSize/2,i=e.max.add(e.min).multiplyByFloats(-0.5,-0.5,-0.5),a=re$5.Compose(new te$4(1/t,1/t,1/t),new se$5,new te$4(0,0,0));re$5.Compose(new te$4(1,1,1),new se$5,i).multiplyToRef(a,a),this._voxelTracingPass.setWorldScaleMatrix(a),this._voxelRenderer.setWorldScaleMatrix(a),this._spatialBlurPass.setWorldScale(2*t),this._updateSsShadowParams();}constructor(e,t,i={},r){super(t.getEngine(),e),this._allowDebugPasses=false,this._debugPasses=[],this._shadowCastingMeshes=[],this._shadowOpacity=.8,this._enabled=true,this._coloredShadows=false,this._materialsWithRenderPlugin=[],this.onShadowTextureReadyObservable=new R$g,this.onNewIblReadyObservable=new R$g,this.onVoxelizationCompleteObservable=new R$g,this.voxelGridSize=1,this._renderSizeFactor=1,this._gbufferDebugEnabled=false,this._gBufferDebugSizeParams=new ie$5(0,0,0,0),this.scene=t,this._cameras=r||[t.activeCamera];const h=new Uint8Array([0,0,0,255]);this._dummyTexture2d=new E$f(h,1,1,eo.TEXTUREFORMAT_RGBA,t,false),this._dummyTexture3d=new I$4(h,1,1,1,eo.TEXTUREFORMAT_RGBA,t,false);const l={};l[y$3.SCREENSPACE_DEPTH_TEXTURE_TYPE]={textureFormat:Qe$1.TEXTUREFORMAT_R,textureType:Qe$1.TEXTURETYPE_FLOAT},l[y$3.VELOCITY_LINEAR_TEXTURE_TYPE]={textureFormat:Qe$1.TEXTUREFORMAT_RG,textureType:Qe$1.TEXTURETYPE_HALF_FLOAT},l[y$3.POSITION_TEXTURE_TYPE]={textureFormat:Qe$1.TEXTUREFORMAT_RGBA,textureType:Qe$1.TEXTURETYPE_HALF_FLOAT},l[y$3.NORMAL_TEXTURE_TYPE]={textureFormat:Qe$1.TEXTUREFORMAT_RGBA,textureType:Qe$1.TEXTURETYPE_HALF_FLOAT};const _=t.enableGeometryBufferRenderer(void 0,Qe$1.TEXTUREFORMAT_DEPTH32_FLOAT,l);_?(this._geometryBufferRenderer=_,this._geometryBufferRenderer.enableScreenspaceDepth=true,this._geometryBufferRenderer.enableVelocityLinear=true,this._geometryBufferRenderer.enablePosition=true,this._geometryBufferRenderer.enableNormal=true,this._geometryBufferRenderer.generateNormalsInWorldSpace=true,this.scene.enableIblCdfGenerator(),this.shadowOpacity=i.shadowOpacity||.8,this._voxelRenderer=new O$5(this.scene,this,i?i.resolutionExp:6,void 0===i.triPlanarVoxelization||i.triPlanarVoxelization),this._voxelTracingPass=new B$2(this.scene,this),this._spatialBlurPass=new G$1(this.scene,this),this._accumulationPass=new C$4(this.scene,this),this._accumulationPass.onReadyObservable.addOnce((()=>{this.onShadowTextureReadyObservable.notifyObservers();})),this.sampleDirections=i.sampleDirections||2,this.voxelShadowOpacity=i.voxelShadowOpacity??1,this.envRotation=i.envRotation??0,this.shadowRenderSizeFactor=i.shadowRenderSizeFactor||1,this.ssShadowOpacity=void 0===i.ssShadowsEnabled||i.ssShadowsEnabled?1:0,this.ssShadowDistanceScale=i.ssShadowDistanceScale||1.25,this.ssShadowSampleCount=i.ssShadowSampleCount||16,this.ssShadowStride=i.ssShadowStride||8,this.ssShadowThicknessScale=i.ssShadowThicknessScale||1,this.shadowRemanence=i.shadowRemanence??.75,this._noiseTexture=new Is("https://assets.babylonjs.com/textures/blue_noise/blue_noise_rgb.png",this.scene,false,true,Qe$1.TEXTURE_NEAREST_SAMPLINGMODE),t.postProcessRenderPipelineManager.addPipeline(this),this.scene.onActiveCameraChanged.add(this._listenForCameraChanges.bind(this)),this.scene.onBeforeRenderObservable.add(this._updateBeforeRender.bind(this)),this._listenForCameraChanges(),this.scene.getEngine().onResizeObservable.add(this._handleResize.bind(this)),this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.onGeneratedObservable.add((()=>{this._setPluginParameters(),this.onNewIblReadyObservable.notifyObservers();}))):Ie$2.Error("Geometry buffer renderer is required for IBL shadows to work.");}_handleResize(){this._voxelRenderer.resize(),this._voxelTracingPass.resize(this.shadowRenderSizeFactor),this._spatialBlurPass.resize(this.shadowRenderSizeFactor),this._accumulationPass.resize(this.shadowRenderSizeFactor),this._setPluginParameters();}_getGBufferDebugPass(){if(this._gbufferDebugPass)return this._gbufferDebugPass;const e=this.engine.isWebGPU,i={width:this.scene.getEngine().getRenderWidth(),height:this.scene.getEngine().getRenderHeight(),samplingMode:Qe$1.TEXTURE_NEAREST_SAMPLINGMODE,engine:this.scene.getEngine(),textureType:Qe$1.TEXTURETYPE_UNSIGNED_BYTE,textureFormat:Qe$1.TEXTUREFORMAT_RGBA,uniforms:["sizeParams"],samplers:["depthSampler","normalSampler","positionSampler","velocitySampler"],reusable:false,shaderLanguage:e?1:0,extraInitializations:(e,s)=>{e?s.push(Promise.resolve().then(function(){return iblShadowGBufferDebug_fragmentD296cOf0_esm_min})):s.push(Promise.resolve().then(function(){return iblShadowGBufferDebug_fragmentDmLbzf9O_esm_min}));}};return this._gbufferDebugPass=new Aa("iblShadowGBufferDebug","iblShadowGBufferDebug",i),this.engine.isWebGPU&&(this._gbufferDebugPass.samples=this.engine.currentSampleCount??1),this._gbufferDebugPass.autoClear=false,this._gbufferDebugPass.onApplyObservable.add((e=>{const s=this._geometryBufferRenderer.getTextureIndex(y$3.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[s]);const t=this._geometryBufferRenderer.getTextureIndex(y$3.NORMAL_TEXTURE_TYPE);e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[t]);const i=this._geometryBufferRenderer.getTextureIndex(y$3.POSITION_TEXTURE_TYPE);e.setTexture("positionSampler",this._geometryBufferRenderer.getGBuffer().textures[i]);const a=this._geometryBufferRenderer.getTextureIndex(y$3.VELOCITY_LINEAR_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[a]),e.setVector4("sizeParams",this._gBufferDebugSizeParams),this.scene.activeCamera&&e.setFloat("maxDepth",this.scene.activeCamera.maxZ);})),this._gbufferDebugPass}_createDebugPasses(){this.scene.iblCdfGenerator?this._debugPasses=[{pass:this.scene.iblCdfGenerator.getDebugPassPP(),enabled:this.cdfDebugEnabled}]:this._debugPasses=[],this._debugPasses.push({pass:this._voxelRenderer.getDebugPassPP(),enabled:this.voxelDebugEnabled},{pass:this._voxelTracingPass.getDebugPassPP(),enabled:this.voxelTracingDebugEnabled},{pass:this._spatialBlurPass.getDebugPassPP(),enabled:this.spatialBlurPassDebugEnabled},{pass:this._accumulationPass.getDebugPassPP(),enabled:this.accumulationPassDebugEnabled},{pass:this._getGBufferDebugPass(),enabled:this.gbufferDebugEnabled});for(let e=0;e<this._debugPasses.length;e++)this._debugPasses[e].pass&&this.addEffect(new n$N(this.scene.getEngine(),this._debugPasses[e].pass.name,(()=>this._debugPasses[e].pass),true));const e=this.cameras.slice();this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this.scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this.name,e);for(let e=0;e<this._debugPasses.length;e++)this._debugPasses[e].pass&&(this._debugPasses[e].enabled?this._enableEffect(this._debugPasses[e].pass.name,this.cameras):this._disableEffect(this._debugPasses[e].pass.name,this.cameras));}_disposeEffectPasses(){this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this._disposeDebugPasses(),this._reset();}_disposeDebugPasses(){for(let e=0;e<this._debugPasses.length;e++)this._disableEffect(this._debugPasses[e].pass.name,this.cameras),this._debugPasses[e].pass.dispose();this._debugPasses=[];}_updateDebugPasses(){let e=0;this._gbufferDebugEnabled&&e++,this.cdfDebugEnabled&&e++,this.voxelDebugEnabled&&e++,this.voxelTracingDebugEnabled&&e++,this.spatialBlurPassDebugEnabled&&e++,this.accumulationPassDebugEnabled&&e++;const s=Math.ceil(Math.sqrt(e)),t=Math.ceil(e/s),i=1/t,a=1/s;let r=0,n=0;this.gbufferDebugEnabled&&(this._gBufferDebugSizeParams.set(r,n,t,s),r-=i,r<=-1&&(r=0,n-=a)),this.cdfDebugEnabled&&this.scene.iblCdfGenerator&&(this.scene.iblCdfGenerator.setDebugDisplayParams(r,n,t,s),r-=i,r<=-1&&(r=0,n-=a)),this.voxelDebugEnabled&&(this._voxelRenderer.setDebugDisplayParams(r,n,t,s),r-=i,r<=-1&&(r=0,n-=a)),this.voxelTracingDebugEnabled&&(this._voxelTracingPass.setDebugDisplayParams(r,n,t,s),r-=i,r<=-1&&(r=0,n-=a)),this.spatialBlurPassDebugEnabled&&(this._spatialBlurPass.setDebugDisplayParams(r,n,t,s),r-=i,r<=-1&&(r=0,n-=a)),this.accumulationPassDebugEnabled&&(this._accumulationPass.setDebugDisplayParams(r,n,t,s),r-=i,r<=-1&&(r=0,n-=a));}_updateSsShadowParams(){this._voxelTracingPass.sssMaxDist=this._sssMaxDistScale*this.voxelGridSize/(1<<this.resolutionExp),this._voxelTracingPass.sssThickness=.005*this._sssThicknessScale*this.voxelGridSize;}addShadowReceivingMaterial(e){if(e)if(Array.isArray(e))for(const s of e)this._addShadowSupportToMaterial(s);else this._addShadowSupportToMaterial(e);else for(const e of this.scene.materials)this._addShadowSupportToMaterial(e);}removeShadowReceivingMaterial(e){if(Array.isArray(e))for(const s of e){const e=this._materialsWithRenderPlugin.indexOf(s);if(-1!==e){this._materialsWithRenderPlugin.splice(e,1);const t=s.pluginManager?.getPlugin(N$3.Name);t.isEnabled=false;}}else {const s=this._materialsWithRenderPlugin.indexOf(e);if(-1!==s){this._materialsWithRenderPlugin.splice(s,1);e.pluginManager.getPlugin(N$3.Name).isEnabled=false;}}}clearShadowReceivingMaterials(){for(const e of this._materialsWithRenderPlugin){const s=e.pluginManager?.getPlugin(N$3.Name);s&&(s.isEnabled=false);}this._materialsWithRenderPlugin.length=0;}_addShadowSupportToMaterial(e){if(!(e instanceof pl||e instanceof te$2||e instanceof ue))return;let s=e.pluginManager?.getPlugin(N$3.Name);s||(s=new N$3(e)),-1===this._materialsWithRenderPlugin.indexOf(e)&&(this._enabled&&(s.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),s.shadowOpacity=this.shadowOpacity),s.isEnabled=this._enabled,s.isColored=this._coloredShadows,this._materialsWithRenderPlugin.push(e));}_setPluginParameters(){if(this._enabled)for(const e of this._materialsWithRenderPlugin)if(e.pluginManager){const s=e.pluginManager.getPlugin(N$3.Name);s.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),s.shadowOpacity=this.shadowOpacity,s.isColored=this._coloredShadows;}}_updateBeforeRender(){this._updateDebugPasses();}_listenForCameraChanges(){this.scene.activeCamera?.onViewMatrixChangedObservable.add((()=>{this._accumulationPass.isMoving=true;}));}isReady(){return this._noiseTexture.isReady()&&this._voxelRenderer.isReady()&&this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.isReady()&&(!this._voxelTracingPass||this._voxelTracingPass.isReady())&&(!this._spatialBlurPass||this._spatialBlurPass.isReady())&&(!this._accumulationPass||this._accumulationPass.isReady())}getClassName(){return "IBLShadowsRenderPipeline"}dispose(){const e=this._materialsWithRenderPlugin.splice(0);for(const s of e)this.removeShadowReceivingMaterial(s);this._disposeEffectPasses(),this._noiseTexture.dispose(),this._voxelRenderer.dispose(),this._voxelTracingPass.dispose(),this._spatialBlurPass.dispose(),this._accumulationPass.dispose(),this._dummyTexture2d.dispose(),this._dummyTexture3d.dispose(),this.onNewIblReadyObservable.clear(),this.onShadowTextureReadyObservable.clear(),this.onVoxelizationCompleteObservable.clear(),super.dispose();}};
var iblShadowsRenderPipelineB0_8f9tc_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,IblShadowsRenderPipeline:z$3});const e$d="envShadowGroundVertexShader",r$U="attribute position: vec3f;attribute uv: vec2f;uniform viewProjection: mat4x4f;uniform worldViewProjection: mat4x4f;varying vUV: vec2f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.worldViewProjection*vec4f(input.position,1.0);vertexOutputs.vUV=input.uv;}";bt$1.ShadersStoreWGSL[e$d]||(bt$1.ShadersStoreWGSL[e$d]=r$U);const n$J={name:e$d,shader:r$U};var envShadowGround_vertexC1y0EEHZ_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,envShadowGroundVertexShaderWGSL:n$J});const a$v="envShadowGroundPixelShader",t$t="var shadowTextureSampler: sampler;var shadowTexture : texture_2d<f32>;uniform shadowOpacity : f32;uniform renderTargetSize: vec2<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let uvBasedOpacity=1.0-pow(clamp(length(input.vUV*vec2<f32>(2.0)-vec2<f32>(1.0)),0.0,1.0),2.0);let screenUv=fragmentInputs.position.xy/uniforms.renderTargetSize;let shadowValue=textureSampleLevel(shadowTexture,shadowTextureSampler,screenUv,0.0).rrr;let totalOpacity=uniforms.shadowOpacity*uvBasedOpacity;let finalShadowValue=mix(vec3<f32>(1.0),shadowValue,totalOpacity);let invertedShadowValue=vec3(1.0)-shadowValue;fragmentOutputs.color=vec4f(finalShadowValue,invertedShadowValue.r*totalOpacity);}";bt$1.ShadersStoreWGSL[a$v]||(bt$1.ShadersStoreWGSL[a$v]=t$t);const r$T={name:a$v,shader:t$t};var envShadowGround_fragmentR7HvuC7k_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,envShadowGroundPixelShaderWGSL:r$T});const e$c="envShadowGroundVertexShader",i$C="precision highp float;attribute vec3 position;attribute vec2 uv;uniform mat4 worldViewProjection;varying vec2 vUV;void main(void) {gl_Position=worldViewProjection*vec4(position,1.0);vUV=uv;}";bt$1.ShadersStore[e$c]||(bt$1.ShadersStore[e$c]=i$C);const r$S={name:e$c,shader:i$C};var envShadowGround_vertexD5GmKrpO_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,envShadowGroundVertexShader:r$S});const a$u="envShadowGroundPixelShader",r$R="precision highp float;uniform sampler2D shadowTexture;uniform vec2 renderTargetSize;uniform float shadowOpacity;varying vec2 vUV;void main(void) {float uvBasedOpacity=clamp(length(vUV*vec2(2.0)-vec2(1.0)),0.0,1.0);uvBasedOpacity=uvBasedOpacity*uvBasedOpacity;uvBasedOpacity=1.0-uvBasedOpacity;vec2 screenUv=gl_FragCoord.xy/renderTargetSize;vec3 shadowValue=texture2D(shadowTexture,screenUv).rrr;float totalOpacity=shadowOpacity*uvBasedOpacity;vec3 invertedShadowValue=vec3(1.0)-shadowValue;gl_FragColor.rgb=shadowValue;gl_FragColor.a=invertedShadowValue.r*totalOpacity;}";bt$1.ShadersStore[a$u]||(bt$1.ShadersStore[a$u]=r$R);const o$z={name:a$u,shader:r$R};var envShadowGround_fragmentDcw3WIFt_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,envShadowGroundPixelShader:o$z});let s$c=class s{constructor(t){this.name=cr$1.NAME_SHADOWGENERATOR,this.scene=t;}register(){this.scene._gatherRenderTargetsStage.registerStep(cr$1.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets);}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const s of t){if(s.doNotSerialize)continue;const t=s.getShadowGenerators();if(t){const s=t.values();for(let t=s.next();true!==t.done;t=s.next()){const s=t.value;s.doNotSerialize||e.shadowGenerators.push(s.serialize());}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let s=0;s<t.lights.length;s++){const n=t.lights[s],o=n.getShadowGenerators();if(n.isEnabled()&&n.shadowEnabled&&o){const s=o.values();for(let n=s.next();true!==n.done;n=s.next()){const s=n.value.getShadowMap();-1!==t.textures.indexOf(s)&&e.push(s);}}}}};no._SceneComponentInitialization=t=>{let n=t._getComponent(cr$1.NAME_SHADOWGENERATOR);n||(n=new s$c(t),t._addComponent(n));};var shadowGeneratorSceneComponentBUSilCQf_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,ShadowGeneratorSceneComponent:s$c});const A$4="data:application/octet-stream;base64,hhaHlvbWljZ7InZlcnNpb24iOjIsIndpZHRoIjo2NCwiaW1hZ2VUeXBlIjoiaW1hZ2UvcG5nIiwiaXJyYWRpYW5jZSI6eyJ4IjpbMC4xMTIyOTI0OTg2OTk3MzQyOCwwLjA4OTU2OTQzNDAzNTY5OTE4LDAuMTM0MTU5NjUwODY3OTE5OTVdLCJ5IjpbMC40MjUyMDE3MTIxODY3ODkxLDAuNDAzODI2MzIyMjEzNzkwMDYsMC40MjU2Njk1MzAwNTA0MTg2M10sInoiOlstMC4wNzczNjU5NDM2OTgyOTM5NCwtMC4wNDE1MDU3NTUzOTI0MjIzMSwtMC4xMTc4NDI2ODM2OTc0MTA5NF0sInh4IjpbMS4wMTEzMDEzMTAyMzUyMDc1LDAuOTQ3ODM3MDg2Mjk1MTM5NSwxLjA0NzQyMTE3MTA1MTAzNzVdLCJ5eSI6WzEuMTUwNDYyOTExNjAxODgxNCwxLjA3OTY3OTc5NDI1MDU1MjcsMS4xODUxNTg0MTA4NjM1MTcxXSwienoiOlsxLjAxNzU1NDQzNDk5ODk1NjUsMC45NDc1NjI2NDgzNTQ1NTQ3LDEuMDU5MDg0MTM5OTEyMTA0M10sInl6IjpbMC4wMDY0ODAzNDE3MTk3NDgzMjYsMC4wMTc2MzAzNTkzNjE2NTc3MjYsLTAuMDA4MTkwNjkxMTk0NjE0NjU2XSwiengiOlstMC4wNTA3ODMxNjkzMjkxMDk4MiwtMC4wNDAzMDk2MjY0MDc0MzQ2NCwtMC4wNjA0NTIxNjM3ODQ5NzA0OF0sInh5IjpbMC4wMzg0NDQ5ODQ3MDc0MDUxNiwwLjAzMDY4MTg0OTIzMDI3NjE1NiwwLjA0NTQyMDI1NTczMTQzNTQ1XSwiaXJyYWRpYW5jZVRleHR1cmUiOnsic2l6ZSI6MzIsImZhY2VzIjpbeyJsZW5ndGgiOjE0ODksInBvc2l0aW9uIjo1MjgzOX0seyJsZW5ndGgiOjExNzksInBvc2l0aW9uIjo1NDMyOH0seyJsZW5ndGgiOjEzOTEsInBvc2l0aW9uIjo1NTUwN30seyJsZW5ndGgiOjk5NSwicG9zaXRpb24iOjU2ODk4fSx7Imxlbmd0aCI6MTEzOCwicG9zaXRpb24iOjU3ODkzfSx7Imxlbmd0aCI6MTQ2MCwicG9zaXRpb24iOjU5MDMxfV19fSwic3BlY3VsYXIiOnsibWlwbWFwcyI6W3sibGVuZ3RoIjo2MDU0LCJwb3NpdGlvbiI6MH0seyJsZW5ndGgiOjYwMjEsInBvc2l0aW9uIjo2MDU0fSx7Imxlbmd0aCI6NDYyNywicG9zaXRpb24iOjEyMDc1fSx7Imxlbmd0aCI6NTM3MiwicG9zaXRpb24iOjE2NzAyfSx7Imxlbmd0aCI6NTIyNSwicG9zaXRpb24iOjIyMDc0fSx7Imxlbmd0aCI6NjEzNiwicG9zaXRpb24iOjI3Mjk5fSx7Imxlbmd0aCI6MjE2OCwicG9zaXRpb24iOjMzNDM1fSx7Imxlbmd0aCI6MjEyOCwicG9zaXRpb24iOjM1NjAzfSx7Imxlbmd0aCI6MjM1NiwicG9zaXRpb24iOjM3NzMxfSx7Imxlbmd0aCI6MTI4OSwicG9zaXRpb24iOjQwMDg3fSx7Imxlbmd0aCI6MTQ1MCwicG9zaXRpb24iOjQxMzc2fSx7Imxlbmd0aCI6MjAzNiwicG9zaXRpb24iOjQyODI2fSx7Imxlbmd0aCI6NzgxLCJwb3NpdGlvbiI6NDQ4NjJ9LHsibGVuZ3RoIjo3ODcsInBvc2l0aW9uIjo0NTY0M30seyJsZW5ndGgiOjgzNywicG9zaXRpb24iOjQ2NDMwfSx7Imxlbmd0aCI6NTI1LCJwb3NpdGlvbiI6NDcyNjd9LHsibGVuZ3RoIjo1OTcsInBvc2l0aW9uIjo0Nzc5Mn0seyJsZW5ndGgiOjgwMCwicG9zaXRpb24iOjQ4Mzg5fSx7Imxlbmd0aCI6Mjg5LCJwb3NpdGlvbiI6NDkxODl9LHsibGVuZ3RoIjozMTEsInBvc2l0aW9uIjo0OTQ3OH0seyJsZW5ndGgiOjI4MSwicG9zaXRpb24iOjQ5Nzg5fSx7Imxlbmd0aCI6MjQ2LCJwb3NpdGlvbiI6NTAwNzB9LHsibGVuZ3RoIjoyNjgsInBvc2l0aW9uIjo1MDMxNn0seyJsZW5ndGgiOjMwMCwicG9zaXRpb24iOjUwNTg0fSx7Imxlbmd0aCI6MTQ5LCJwb3NpdGlvbiI6NTA4ODR9LHsibGVuZ3RoIjoxNDksInBvc2l0aW9uIjo1MTAzM30seyJsZW5ndGgiOjE0MywicG9zaXRpb24iOjUxMTgyfSx7Imxlbmd0aCI6MTQzLCJwb3NpdGlvbiI6NTEzMjV9LHsibGVuZ3RoIjoxNDIsInBvc2l0aW9uIjo1MTQ2OH0seyJsZW5ndGgiOjE0OSwicG9zaXRpb24iOjUxNjEwfSx7Imxlbmd0aCI6OTcsInBvc2l0aW9uIjo1MTc1OX0seyJsZW5ndGgiOjk3LCJwb3NpdGlvbiI6NTE4NTZ9LHsibGVuZ3RoIjo5NywicG9zaXRpb24iOjUxOTUzfSx7Imxlbmd0aCI6OTcsInBvc2l0aW9uIjo1MjA1MH0seyJsZW5ndGgiOjk3LCJwb3NpdGlvbiI6NTIxNDd9LHsibGVuZ3RoIjo5NywicG9zaXRpb24iOjUyMjQ0fSx7Imxlbmd0aCI6ODMsInBvc2l0aW9uIjo1MjM0MX0seyJsZW5ndGgiOjgzLCJwb3NpdGlvbiI6NTI0MjR9LHsibGVuZ3RoIjo4MywicG9zaXRpb24iOjUyNTA3fSx7Imxlbmd0aCI6ODMsInBvc2l0aW9uIjo1MjU5MH0seyJsZW5ndGgiOjgzLCJwb3NpdGlvbiI6NTI2NzN9LHsibGVuZ3RoIjo4MywicG9zaXRpb24iOjUyNzU2fV0sImxvZEdlbmVyYXRpb25TY2FsZSI6MC44fX0AiVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAF2BJREFUeF6lW2uwleV1Xt+39z4HzgEVRKXmYloUUQTkokkbTYrViJYCIhdx6iT6o206vaT94STTNp1mOp1IJvmT1j9pkpkm1rZTDYlJVASOpmnTVoVURVOsBXQOOlwETbics/f+vs6znvW833tMYA7pdnDv8+3v8q7bs5611ruL1145UJetlrVbLSvK0sqiMCsKK8vSWmVpZoXhhb+LOI5j/h3OxRlF0fcPteGCysy6VlvfCqvr2vq4I06rzazX7U73a3B9zfvWdWV1jfvgc+3PqavK3/1SvNXG73BT/KnzcGF8l06MC+oKZ/oC/X7+VxzC9RWeMbr3jRoParXa1q/61m61rbbaWmXL5Stbba6+KDIFmJ/v4ocSXHFW9EJj3Xgv69pwTDJU3W53mEJDGAjCNVLJLasq6A2a062pRb2ogEboXCiXLxRTVVQkboRjOA9rdKGL0no9LrHYu+fVGg/GovDqdDp+Ubvdtio03u60XXNSQquF87HYyvAZx/EZD8Dx8AJ4RWm1e4T+dUIhlRXxXW3QeN8FKQxmwkLcyHE9ZO7VzfGiqK2seT2eAY3I89q4BuoJp4Gm3fN8/XHTfj8cFsf2vfyaf4+F4wSEA54IwaoaQpVWlIV7hp8X4dLvU3gpAedB0612y90N96vNqgLCY8F8vhYcvm3jErSuPGSgjB4eb7XBRHwoDEjDQ2j4QwuBgfub+bm4BtfiOVQlPhQQoS7pAbWlkIBFKtyosuLlF/fWZcmYx507YXkIDMFT7Bdl+owbwkNyfJDrSWHuCeG6EcsI9LIoCkSmrIfL4DjyUq6f0eEQ4cIxGiCcvEOxLEXyMggKwRQv7v4QFnrKwwNL4bnFS8+97Oe323TrFAZZ3AMPfKUtgCTBMP8HPDj29pv27M5n7IYP3+T4AU9Q2OTgpHDRPT0Ow8ge9zRgXVVVEWHZr+va3YlGpV7pFAg9RYtZ1UfcU3o/WlXWR8wHGnv8u1v0k2KK53e+5CAIBbibB9LTagCO0oWh4PQuLExABqX95MTb1u12bdfOXXbD8httoDOQFOSLqaA8YgXvQCH0N4/xO+COK64EcieRZVPr9fq+lmTx8DK3KNNDREB4Q12FkniLJv5r/1zs/Pf/qiGggM0BsNMOBDVrdzoT0J9eUlMJQNN+zw6/+YbNmjHbnnxqxG668WYbHBjMFAD/Jpakl3sQ0mCkvEBqxw2ltbCwBFPGkRV5nM4O5blggXLIZvQOur4L6hhVGbBLKdDD9j//dWfdapV+AbQOq8CCcHe+CmaGSCMOlp42WzbeHXfrYx3nTZthj2191FatXGO4n8AUrgrPgqviOF2Wi/Z8nyyop0XERyDjfGCUpzWl8bAyBKSQEUSuPCocl+O7JGzwCigA4I7w8Cz3Lzv+rQagKRVKOBAj+Lz+dmKEEHEsaFm/37Ox8ZPWaQ/Y2PiYTR0Ysgf/6UG7+6P32MAAQ0CCCmBz3FBoQOk5kUnhEUILSB3cIvY9n4enKBRkbdwLFpeH8DyQntoFr9wDiA3uTdseG6lhIcX04OBg4gQQVLF//MRxO378uA1NHXLv6Fc9V8jw1GE79vYxe3X/q3bs6Fv267euNNwDHkKIJ2i6MtziwSd4IDGz9F1mZa6d4SZLSzDPqbB+hvKwLm7pwlbMuBWUodgHLa0CAPt9/1x8Z8tj7mywGg502h1iAMAuUL9s4UaVjR44YGPjp+wXZl9s490x5zKnTp1yL3h4yz/b0sXX2PUfvN6mDg25EiR0A3GkuxAWVkokql8RfIsy4jWD8khfHgpB0/s9Whje40KHgMnq7vpQHq2M43ieQkafHRse+scttS8ETAKhADwoCleE4pcAiRBoWbfbsxd2P2/j42O2ZPEyGxoa8gd97/tP2UBnis2bO88uvPAix40pU6YQO6KmcOIBBWTxj4WSRBGwPE26JZ3zhIWZ3oTycGvlcY/nCAcJmCvChcW9a7Nur+sewWORBb7+1QfrgcEBf3i7TcTHwxAWEBhKcYUAGCP9AZQOHz5so6+P2mVz5tr5M8+3J7+3w65etNROnDyOgsdmzphl06dNt6FhKIhor9xPLkAhlFWUBgWKsCye3ev2EtUWTLJ4ggBUmgT3MImQQHZyPKh6fh6+A27huXiHEtwDvnT/l2tUZngYhIblIDi0ACB06+M9QFBA5ud3OvbG6wfsrbffsoMHD9p1H/yQ84GjR9+0ffv32uzZs21o6rBddulcrj3in0Iyk7BYCRYXisIzPN+DCwTPoaXJKXAjFjtmvV4v2B/zfg8x7whf+XdMe/G56rt3wRMgPAqi4otfuL+GZRH3cEXFPRYHZdDq+ExajuMAP6Q0Mr62nThxwrZ862FbcNVCm3X+BTZr1gU2PDRsAwNIn6LZSIOR510ZUADCjTVEAjknTaUhzgVo0h6YnmKawOaFZhISSnGFeL6HsAA6Co/rYBxcg/SNv10Bm//q86kYgsXl5rCwFkyvaNNLIiRcaXEOPj+782m79poPhDCsFXCdp9OIefeeqO+JBQ1lZfyTJ+A4K1F+D0H4HQXL3R6fuy4Qkd+VAFcP0MNnekLPFYDPOAYM82f9+Z98pp5g+XZTDaryUwgICIEHSm1Syq4f7rRlS69hqYZwgaKscC8QoWXFScLlhMirx3ZYm9iTFy94BkCXwAglIDRodbcgjkUGkJUhnNwbSoSVEQZQEj53oQA/RoUU9/7xp7wEoaXYqUHsERAhTGQAZIiMGMEjcJ4wY/eLL9jVi5ZEziZ7U9PEmaSnOVJg4YiDoyhr3Ns7NyQLHtOpkouOTp7OIADxoIlruToVBCHHaXlXDIV2ZTgI9qz4/Y9/InWEyPIaWgyLwZpQChYNAWAxx4JIix4SZWn/u/cVu+LyK6Mxwh4CUin7CrUNiE4DBwLAFP+eJh2xAXxswym+HeEBZCEow4BKgiWF7inOe3RzKgVW7/k7FDc+DsGVAaCUvhW/dc/Ha9xMpCRVgS40vaGp8bNyOPqHjuRm9troa/ZL75vj5/O6poeoc8Qn9DyvD8DywhOYKJj7XRlBmLBQ3A/Wk+AiNzxWOR3HC7FN6/at2x3z+7jVe7oWIBltB/CSuzZ9tJZbUvtIL3nNz24R0TxrkISAdOfSDrw+au9+13sm5HoJjEBFKDGLNMjP6o/NTzE3/xzdG7n/hBzuQIcUFpas6MqwLl5QBDxDLi9vYqXcAKx6hcX6tXd4/8y7tPGKBmeq1mRBFS7yFmUMPOTwkUN20YUXuXsrTIjs9CBvYAgHvOPcSlZWVegMTq4ONuhgyTQGJcq1iQN9F5LCUgn+z5seqhPYHRKANpYnxngxdNuqdR4CLFyiN+U8m3HJrBUNuShK2DFu2tUQ9CfHf2znTD83kSbcD/hAoXgPhkU0QiLHkaY2bSwt3jMA8jRa6SEkzpXwuC/AzAuewA5VeF79hZs3945OcmrkRat/7ap1ngVykBGBEAHRvdSU8ONRmip/I/amDJL7exmdtdRccGCDevzhDd4U8eqNhYospL+drwPQgvrqeHQ7uYxoeuCzrC+DshvMPpt4R5PSkd0KeoCvOdKRtAwmBgBhbU3OzfvRldXY0DF2fdC6m9jGcrcPbPHCBw+NoYtbP4AP3uf8PVV2GmQ0nZ+GMUbrLARU/08CCzuUvUTpPd1HFlOhV6xbs6F2YWCJd3RLUNSkvAsBA7EduVMnhi7tORX9w6C7LHQIprKIYwiKLq811BMkIkPZuCebHdGsSI0P5no1N3RvYYI4Bmkwan4qVm0771BF2GoC5kaHMW5fs752y6WamQvBy7kzXDNIhciPCAx6iSpGsGgSnwjuwIim9I2aXziQhQOJT9PFhYIlBPt5TR9fTBHCARvU+tLUp/EgZjMIjxfrF/YzdbxVtq24ffV6T4N+wz4qKxAIahIxh1Bg/c1BiDSLd7cYFuvlZt8GBgZTK1oZAgJg1uDxGSmOXCNK5BiueAdHuvOOMENAhnEvwj1CcD4brTk2R5oKEfQZBKnvbFbvLOKaWid5KEIANxUIIQz8ppg7BaHAOwkO3dl7gyGAABKeAEHZ3W7OdfobnRtXnjNNEh624ZquDRupFFrA5x3fCA9PW5G+5BnM8/QSGAKhiLXgPBhERqInsAT3Qg7eirVtWHsHMSBQW2wrPTQ0jAWxMcIOscCP15U2NnbKBgen+OIxYxgf76aGKhfI8pegx//nCuD34AZMiy5syeIHn7FgGUYC4i4qjvDOsCDfF/6oevXULQyKKtbXBSKkTo0LHR5Al6Q7yc3UE5CFRWOxkFOnTtqUKVO58FBQYnoBhszXnDo7zrhHwZWjOZI1OnEO2B0UjvrdQy6aG+oIy0s5nwDVZdtL3SVnn74Ydp5Say8A0Sn4xtvvTEOnvNJiyci4pAI4PssxgJhAF8QiO6gQEdNRszN0oskSTNOPhSeo2wvPYBwzZfqIHA1SNwhTMTEqUnLUCvJEcIWiRL+SjQ4oBAWQshKKMqxLPUkP5wiHYtP633QmKDf1oiGaC15Xq3eG6WRUgHIvJ1DRqsJ1GKggBqEYuKIzQVR+EevcgBHcJKzOZ/NcuL9nAFc8ewBaFwA69Q0xOu7C5QvrjndTSlX4ep0fIaW07A0dKEF7H6KYK+5cf1ctwiNkx4KwMC84si6M6n8Bi0CJ3Zo+C55IWWJgPhJLrs6agMRIu0NIdEStOQBh/68BvVBIDDNYKgMfuo4NXhOgceLFWstOnDjubX5hB9bk0yml6sLcWP7cOzfcVcv1FeuO/oG8AhkIr0Uz9XGGIOsiXvOJEEdh3PEhKxJpGZYaliolNmjO54iBqjWG+3tVqhIEtQCKJHlvlO2wvleGEDpqEQ8BeKF3vttNjwPL2bT+rhqLdItDcEddTlPgcuD4cG+Oz5opDxaGG8vloW0KrL09tGB+zGu9aI5oQqPyGIpW6CjVMe1ObIHjecIDFkqwfJnCBd4GQBZpU0cLSlUP01P2wAD7HBvWbnL8Yc+cxAYaJKWMIYIzQ8ayOkGwEBb87Ucfebko7Atmdsv+fftX/e7v/F5WL/B+DAsKIjamnKxjIjPI5UyPDIWGikfoZKHJ+oF9QQ06PHyjswwB1bECngiQHWxRo4B3IAuw4UAy0TQXIyVG84F8mv82f/4+u+qq+X9ZluX30YMINJ5tZm9EtfneqqouKYry3hUfuWXYt3oEAdIOBg+DbKeZgFhs0/sAANSoP1j1sfQVbwHqo/dA0CMRYrrkNMi91lkuQ8fLfYwBvd3PLUDFhrV31tK0CIaDTHAAYgCzxMhT2/cZrf1i7PdRJsK7FJAfw+dpN9+44hGFQ8KRwAf2GmIkBsLTRhg1WQlemKa7WUixUYKmKPEEHEG1AcKWgEx+oYwApTdEjh2uYsNtm+qm0cCbeNMxOjN4+OPbH9tWFHa/mR19p3TZ36dTAPT3wEduWnGxusGOhT4q4z4CVXFy/bw34OvwcGs7Frnb9zgbEKdUtuIhKo+MlPsSMKN0ntLppA1cGgAX69ZsdB6Al/pq6pziwVu+/Q0bHBxYrjr651FAr9drfeIP/mjbnv/eE+mOtUKeCpVZYBWNuSGo+glYG9YAt2f9rxKegK1xOJSiMPY9DzHXjLkce5a+aYPMsFi7ar1jAF5+YRQnzuYKs8e3PbrRzA6eQXB9dXoP4Bnzb/q1m/9abTdYgNMcPrsZm2keFAgfmUDEKEYGiQipdlDvD2A4NjbmcQ6P4XQKhQ8AEdVj5Xue5I3FujV31KqgoBlnU767qm/bRrY+YGZ/Ownhz4QB+eVb5vzipef6vsPI0QAp9u+aGb4jN4hOv0e3DaHwGcec6gIAsas1shUsi2Pavjc8PGzDw9PSwMdZbDBTESMnQmtW3u4eAOEVi/SGrj2x4/FbzezkWSjgTUTSGc5vXTrnsm1ei8ckSM1Lldr5tdzSFnv6Ikx1niN4tPHEG0SStH9gyuCgnXfuDCdoXmkixbZK5y+sGAsrVt16m0+GsNOD5SgmKGO248ltj1lh901SeJyGGThS4v4zXXP53HkjwhzhgDpMKrl1vUiVOIIKJl2vIUr6W52l2DCh4gebOKZNm8YBb2zzVTnuIHjy5MnU1zty9Iidf8FM++53v3Pjz0h1p5Pt/ddf96uffe8l77EHHvja8jMooH353HlPKN5FvCRADIViSKpd45wVEOCziU6M1RvlMCuoQaPzFTJQNsJi+vRzvHHD8ri0YuWK1V4LoK9/6PBBD4OXX9nz22a2Z7LW33zf5pEf/OA/7BtbHnrYzL54huvmXHnFfGJKbJbIrS6A810eXiDxTqwouaFK5+fdoVw5ORVXUaV2mcJmxnkz7JxzzuWw5sPXLa8PHT6USMQnP3Wv3XPPPWey4k/Jt3Xr1pGjR4/Zxo0b1pjZW6dTQFVVyxdctfDT2rToIaBdoeG2YUe3JCdUbJ8l66ffAFAx/I4bzpRRpBDS6WYzpr5XaMyYMdOKyy+bV0PbetiP9ry0IqO3k3WCJned6YraPrlgwaKb6aocjXs32BepH0tMvEG+w1szB80p6O6hnGz/MO6XeooTNmPG5iqfR8RobN7cK9QQ9KLixR/tPhvkn6yC/LxvbvnmyJ/96af9MzvEFF4V4wTerx87hA94ulRTNNsm23SDm11kPqdwCs3KJPcMtuz0o4vaiisuvzLtRcGFu1964Wkzu/esJJvkyb/8/l8ZOQHApQaaq1JDhO3wCa8gQu4h8V1KgZEKaXFyiRwP8uwgj8vDyZdx5bz5HI1FXr7wogtt+45tN6S7TVK4yZy2eNGSkdz6GlxyeKLlsw/RjEtjvhcLcqFiiiyv0Llqoef4wb5DOHnGK7TeYsH8hZzNZjH0/O7n7jazfZMRarLnVJV9aNmSpX/h7TO3HL1AIOUhEb/n0T2dMMWIXBPHfPOUFEGlNCsRsVPdrxlkU2Q1kOUKeKfLbf7cZ23FihVnlQnOoAg8bfXSxcv+EA9iLUBkd6/TmCTtEWzAMMVuco9m9JoUEakxPT+srX2FCXBjB6pANyl+wVWLPI9waBAjKyvsh8/tugXt/sla+DTnwZf/ZumSZVdM2A/0M04mnWX1p8afFplye7iBNksy3rknWFvMNCHO2aIyiZqiaPu5AfDfQiggNkHkwLRz1zNfLcvy7/4fCuiMjh7Yunrl6rT7xIUE6kdXOKfECkM1SRPtTSkzgDNZeOJvaJRK9XMY/YgLf+Pl3pT2NOjnc2bF4kVLiJ+RGxUdS5Yutq985cs/LxiWo6MHtq/+DfAiTmUYz802HNUBCYxiYKpNDtxk0fz4gSjuwNH8Xkj7FpQWRZxikJoodjxExMgVEhmkuHrh4rQVm9tiIs6KwnbuemaDmR06Sy9oHzp06IlbV6xMACfBG6FDlLRHIMhQdHfp2twxrrRGWiBGyKyRBjPa4BEKYa7PaofwgPyYewSeDw8QKUmcMtDg2V3P/L2ZfStK3B8rE8UPIX9KL71er9y/f//2jes3+Xdqo3taSvuDCHJUiprvvJWGphSUbE2h0Twskl6wwOa6hhqrIoppW6a4XIm8sli8aGmdc5K0X9XMZs6cae9698X2/HMv2LUfuNbr6rvv/pgdOXLE1zNnzhy75JL3jdd19bmyLMde+Z9XPrNxA4X37SkxJndh8xAIzOFQJVw7s6gzuZgoK3Wln9Z4IDdKEJjJUyhWlvf1y5Fo7es8sdBi6eJlKQ2q2ZAaDC6JfqkQMz1VaBN+9haIGjGe9hnGNhRNkx3fYyNlnv/Tc+N52i7b9PqyvUkRuyp9tTxOmTmJSoAYP4+JeGgIUQxeRx569mOugKYb02xYzmnlxNgNt230kjZOkE020yNtSqBcBDV/j+ksM14wgawgaur/+NVX3hWa8JsDBUbkx9jnlI5mnCD/eaoywiP/8Mys8AAKnrel1FgQ+LgSYgOzbqZ2lmJdOfydoJf/jXM4MOUy0x6iIEYqj/VjJ26ViY1PWbdjAsIT3YIT5CVw85O6Zldb82OLR7709PD/AV0YyoiOxdZoAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAFz9JREFUeF6tW3uwVfV5/fY+59wHai5cUEdrUdQA8lDeURQVkKeotRlSmRqbaTOZSdtpm44zNrEPJjP5I+nDWGMzaXV0EoNRJIkTsYljvbaKMcYoUpAWJGmtkdhWBAmX+zjn7LrW963f3gcfFztehrn3nrPP3r/vtb71rd/vZi8882JRq+WWZZmZZYZvWZabWcHvfNnM8tyvyfIMVxk+UxSFv8efzXL/ML/jularZbVazW+Au8fr7Vab98NXUbSt2Wza1u8/ZMuWLrMJff3W1d1teGy73eZn8H663gprt/Fcf7auwVr0H6/hPxbVjjXqNb8G7/v12fand+Eyy/NaOMGsXq/xBvV6nQ9ptVtWr9X5PhaC9/I8szyMc+eVDuNiC6MT9IXX+MAsSwuFlXDW0NCwPTbwT/aRCxfaGadPtgzXhhG8HjcrzNpFOzmShrThjBavh1Mtk3PcMXCcnll1AJ1D5xeW7fjx7gJRchMqkaaxyAj8LzMB18oJnjk5F6gI1bCYwiOH/7VanR5HduG7roNztLjBI4M28PiALbpwgU2cMMly3BORo7Pa/BmvYeGMfdyfwWm1UiYoI/CM0dFRWtRstrgOfBbXMlv5M7KgZRlKgNGGEyItGd2IWA2ZEZHE+zW+F2mNjI8Q04nhDJUUbMDDaGjuzkCyeOkU7hwr7MDrB+zpH/3IFi/+iHV1d1lv9zhrtpD2uCfugVRus5zoBEQwjKLRrZa1IiuxIhiK/3QcS7HNLGYWtf11lAauyX7y1I7CI+ORxQdkFiNY99JgXcd/WI2fWRaVSOp9LwmuMRmhUsDDYYicgGvfeOOg/eCRR2zdurU2NDxo4/v6iTOIlqdyyxqNuo2OjHI9Kgc5A+5EuruDWo4RGRzjzsd7viRkgjunCePx75l/eY5oQnDL3AGe8l57jcABr9c8rkM0aw56AW54AiJ/bO1XAVT38NR3sIXz4YDvbX3Ifu2aq21oZNAm9E1MpUd0DW86frRttNm0Rq1GI5jWuQOl39ed5hngtY7s8Ew0ZpZjR2TmE48+TQxwlPfIwlPwPl8TLgT6V7sBHKJsUNQRKa25LCVggqO+G+POJJBFCWz74TZbsuRivtbb02u9PeMc/Igd7jB1HRnIZ2ZmzdGmGxpGs/SiKwALFMzq51rNJssge+wfnyiE6GpjSA10AuGAnKHUdVzwCKo82P4CKxwPfOHoJEhhZAfvx26RMQpYPBZ4+PBh27btSZs3b6719Y23dtGycT0nWL1RZ0bhM2p3QnDYPhqG8708s9GRkQSs/l7B6OMeyBCWRaVFsgwe3fo4A4aIsLcD0cMwLF4Rd/R0g9QOhf6O9oiw44SwJGFGlBg+nzDDMhttjnJhh9/8pT34ve/Y0eEj9rH11xGQkQGo4Z7eHpabOAXAsJWQHR0gI8Dh3t7fPdX9NYAf0t9BVBmgboELs4e/80jhBAXpDtDL6QClqRtT1j5+RgbwfXYNb4HiEXAUiygAky0TCJ7XUrvEeyPDIzY8PMQ63rN3j/342Wds7pw51je+jwb3fWi8OwEcpF633t7e1MKQUXiuGxR13moGf3BH4BoCHiIOMGQqFXyeHIDukW3Z9GAB45HysArehwUiQVg4jWKUcY0IT0ZkVlS9i4QjlQVRo3igHAAnv37gQHSV3Hbv2WXnTDnXdu7aaf39E+y86dPt4Jtv2P5X91t//0R7+b9ettdee80uuXiJ9ff3M/peFCQErGMYqOiKLBEPosyQZTBW3UIASGzZdPdmJ0JRw+r76NFqfWB8nuLe2ur1Bn8WzVXnUP+Xs0Sb1YLg2L1799jLr7xsJ598sp104kk2adJEGxkZtX0/fYn3mzVzlh0Z/KVtf2G7NeoNmzZ1up086RRP5UB1tEMEDPgBxyOTAiVTfyeTRMRBiIIzOFt0sEyAePff31N2ARQBCYsDIFyG6Ot3ZYBID64Rbe7q6gp27lRa7I2OqlJrIr/ZoUMH7Wf/8bPoGIW9uv9VOhnOO+fsc+3000+zRqPBhTYaXal1IZrIztHRERootB8ZHnYeUBQsL2ENez4AMKgvOgZW4BnStuxrt93pGBAprlQW+Ck79D6dwTp3sCMhYvl43SsrOrKgigdgbBmAC63RURlGIOKIzrw581N0YUQVuMgpgB+IfHwPyxL7w3NR5yUXwMzg2YDyERgyG1DOt3zptgLGwNupzdVq0Qa95lkOAsLgCOD8aoPuJC8JRFeTIsoJOIEFqbRITbkQZ4StAC+UBp513vQZie8rVZEmTnW9E4nNOQ444ivKanPOEgt2GjkcOJBAELiBmeILG79YAPgYOUQwUWJHfqQbgTEYDI3F63E9bu4OioyIAUoGk/rmOQ3AvcTPUfdqs3jtpX17+d60adMTuKGbDI8M+0g8Chpc9xYI5jfaTLQXhjCdYwgSKxRnqDqlIzMAgn9y481FV6MrRVmG4TvAT9Mb21/8nthg9H9kAoz0LHFGmUgU6HWQINUhDFVfh+MAqntfQgaYTTlrSvosIkuEZ+8v2xzoLJxDIlOZ9NTeUubEjCAyRcYYjNJZo1n2yd/+VNHd1W093b0cbrAYGEqDKgCImyhLUvRjMhSNTt0kpkLWrMqAA4ljjRwRacX7vvzKfzKNzz7r7EB8Z4yc2GIiZGSDHpPlYRaIuvZJz1Ee2aL2KNRPvT+EEIki2XW/saHAkrq7eqyrq5vf0X6A6jSAQ4+i74tXNog3SEcolSVnlpqVxSnE6eEUN8zvh4W/uv/nNG7yGZMdIKX5oM+HuCFjjo26xBGOvPEFx3DS4OcFhA644gek0Os/+rGCQBRUuF7vMmREF7739NCQYzuC9ADxew1QAkJF2MsHEFtOm+rleM/B0TvJL17bT6ecftrpyTGSwljDrHMfnlJtBwtMv4d4wqEpFCQZrNbnUYFjHEGza6/5aJCq8A5FhNx6enqtnteZFQSrDD3f54AqzS3JEMZQILvrg/iOhQkLqp/zGY9YlybQ//nf/2bsTjnlVB+AQvWh4hOSG+d8dgTPHr4Xw5IyyiPu84DKRAHxzCm5Ax2wbu3VvBRoLnqpVAK6AxfQIrsa3TRGziiHHo6FHdqAUpvRj67gLcylsuqXq1CFHTjwOhcO1ud02zlANJ/g8+4YkR9lBbtECKckR8EtvORcEXLBr7xnkGnL1qy6spDEhCjLu0pVeBKgB3CEI+AQl7aqk18MUiFZuUbgBotbyLklCHoaaHA69OYhBnp834QOwyNhk6ZY7SRVsdSnQS8Rz6ByXvBcUPK7xMZugOl0xbKVhQsNFYEvQkRpOgRNESInNw0aqG5QZYVe8ZUvOIpA54uj40LkkFiKVjgy6rN8T3cPr5PjpBy5HlAKHQI43E/YkL4L6LCMyE7J4xJVkPGcYFcsX0VESLKR1h6yTtVzDmZSioI0UVF2BUmGiTtE003epwIjR7P+PYvg5GYTKq5Zd3dPRWQJ6Vqtk+CFDuEagAMd8CAUY+KG/+wO8wGOIB5rRwClXXCIW71iTUFSEO2Ic3arTYT2ektlGJoBHuqRTN2B6q07oOz1pTDqYOcKkaQwV948G/AzSU/RZgdyYUVkykWNcv53KUt9PIIcwqeviQpUEDesC8OUOEq5v+FzS7Z65doCHJnEQaADfa3ZdDEhxlASmhiDlUYeTKfLLqiGMELbYnwOz6sdqgzwOxYpMMJ0h/uNgwhS2UCBI5qtUecCrSZnB3yvEh9OrUGDXQ/06GO9yMxGrUEMcwrvSjaezTXJAXA5xQaCg+vumLe9p3q/gqESNsgM63Xy8TzzWaLEgjL1fBbAmOodQHJbyohQkh0D2jZu3AlRhI4ZoK9wABkeJTR3RsrYEEWEBXIEfgdYY13sZHSG/yxpnYFbvWItQZD/wnBEXw9QX8UNmUohh7HGVFfk+9o/cM+6dObcQLM5OUNESy1KEtrQ8BAjf+IJJ6Y2h2g7gcHg0yZQtto+26NMcT/PCmj8LAY6GoIJMgBsFmCHdSODfbDzyVZzTbZ29TruDFUFRKUlHkJxEepu8IEqscHnJI74/OC7S2ptToxizzEIC8tEW1++ZmYGSgDfgQG4B40PIRMjrYAyMULqe83kZGFC6RA33OcbzwR3hJeGY1hm2ZqVaym6c2eFHN29zchLcSGjq9GjYn6l9q/aF2UOUTUSOfEA7uhq38EHK0Tfaxlzuu8Ag3k6eXFZG2XImZ6tEiUZmx7B8xV9zvmBY8MjI7xvT09PRNxbd3XYUxZka1etoyKkNqTdE/WuKjBibCZ4YbyNMZepGPI5DMRD1De8Lv19ko/QFMtOUbZCpDe+sCkiYZNgx5E2QBCtMrLFA+TzAUuCEniLkyA3QyLSJHCp/h3Ima2BD3SAjCTohH4mFdUFjJwAiQwQFUbqihHi8+wQseMjHoASSHpCZYfZ25/nv0Zppnm7beN6x4k+eGYA+FgOMf5yI9SnPmWrsgeGEytGRrhOoD+eBW4BPFIZIwBwDJ+9ZuWVYCcEFbackJ1VFpScYnStNxrW09UdiO5Aoq7A+g9ugNdhPJiiMzZvgmVvL4cgOQPKj4gQW1TohS5utFgGmgFGRoaDG5ROUAYgI4aGjjI4yFgiPUorfkYpi80yBOvWXF2kbSM+LNqPhot4DQtCfbJ3Yz6o+40omVcOV1RH5dIJkeqgwEGHPf4ORL7JCQxAtHpjXO1Mbam7AkbhFLKBKR+0HeiPDMDvKk2yP/yPqdZLIFo3MqBaAklhiVbj9eybIcgA3JjaHhA+xuM0EgcZwvvCBpQSjU1nD8oN12orlFwNsOITA9BIr6M01a4ZbRI1l7XIRUCEgBGF2dDQEO/hM0vJX9I0G4Ku84CVa9M06O1QG5G++Ug6zJ0djMIOIFgUOoRUI3ED0UyeF6Kk7fqAU9uQw0INdjD1Evn6N+/aneX2N2b2CzM7c+Cxf/7KXXfcndQcH43jYEMwU9/0LMgNqm0VThk6OuSZSd4BHlKO8dQnSY/h6MyyVVesTsNgan+xnyZs0OTFNtJoWKNWJw6QXASiykBfrJ/McNT3MwfOBmPKaxf25dv+2k497ZQ/MLOdMa0i9/Ghwfg+tWjbF67fcMNEZYo2OR0LPPLHiiMSRFkqwV8YjAJnHTyAouHUKlatWMMSIKnJa37QQFpabCr6ZBXIGWMko8ddmwadAtHBR8w4TRbnDDTOOgDWbNP9X/+zPM+fjF5Z/VZ1QOfbbVvSbLU+f8NvfoLrw7O0qSLhRGtUFyB5Q6mak7jqusQB+Bk4gBJzszxXQ+oaW8oaipA2IBbeurR9FjtCor6RdmKIWCg1vzh2c/+We3+S5XbjOxhPClDJgLdd0mw2s833PfDYtx94MB2YwJo9O1zwAAdwVunM0blKKNxx5im1a02LK5evLnSmD3fRh+EUH0O9DTqANNKY6fzAS6AT4DD2epcove4z+pYH77sCt/v/OCA+M2P9tdfdrvUIvHXsReDJIa5yzsHnDe2A++YuSoQguGLZKh+G4jCR1y2M9j11UU2Nu35SzDmAi5+loZLPZaBPZH7dA9/91qY8z//hXYwfMwP0uSef2DZwy1/dmkQPrV2lQKY4MuLUntOrrxVf2pliOXMszi27fMnSgm2rcN6tG5H96bhZTImsdzC+dNLLuwNH5dANERUei2k1ST6wwEUXLrTP3nzT0vcw/rgdYGbTf/3q9V/FczT6aq24CV4fHh5m2ak7qFspIMpMfr9i6UoyDu6xR/jZZ6N/wwAwL4iWopjwnk59wFD9ziwBEAZAgjgdPTpoe/ft+aSZ7fuAHGCbN28e+OxNn0sRRbTxLO0jAszH9423E088KU2oDoShAknaRxtcdvkVRTo25nIq29ho09MIB5iODB4p9wOC1GhGqEpd+hnf3ZlmDz+81aZOmzpW9HH1uADBI2M4Cm//ytRzp90jZUoEKYmt1DYKiisT+yda30njfXROh7d834K/X37pslCF41SnmR09epSnNAYHj3SIi1J01JerhjLdwBiD9CBDpk2balsf3nqtmR08DqOmxTXIFB8D3+PrLQz+/PSp05fICZogtVFSdcb4D02w/gn9hl0vbNcTtyCeooMsvWx54UdNXIRAxJHu3D6imlMqql4h3nMSs2OwXb3na5LFs8xmzZphW769ZZm2+d7DnjMuWbzkG08+9cQLb/n/JlTkWA4AOV0wf+Gjb7552DeOgj4nvTIEGGZqCDD9EyYa/nd3d9M2qliXXnJZgX4KJ7xx8ADrXIamc4PxBP2uxXUYzNLwU6bU+6mnZ/Zv//7i2BnQtssuuujijb86+Qy7f/N9v2dmLx6HA3DJVedNn/HHrlv6I0V9maUakGIfQllyyqRTbcL4flef5s9dUBw8dDDpAMeKFXJGh56vU+Qp2qH5hkqsaCCrdu3e+Tkz++EYBk38+PU3PLB48UX26d/99Eoz802CMb727ds3cNW6q1P0hUH+gm/qqBT0nuOF73YhG7IzJ5+V9gZFaDSBpS3uOPsvJ1DkiP2C5KC0eRF/OBF5v+vFf930Fmi9V/+XmZCDYbin4NhftYULFj16dPBoue1V2RpTbFyLKLNDOoPWn005cwq5JDdHY4qjSFHZwtIpr5TyfF9Kf7npke5TScU//4s/tfXr1x9PFxjb5M4rps6eef7XPNiR/7JU+36xGYNrqtmQPoMqnXLW2YV2hiVfSd9/W3TDndL21Qp1HWuxihcBTDt2vvCBO6Ddbn9izvlzf4vETX+QEUNbwE/aJPVrtL/h6aAEzs45+9x0TI4pH1+dKO8veqvzlEotUNeH4JEk8QAhXLd9x/MfuAMGBh4f+MwffiadIK9mAes9lC0GJ0DQE7OsXQLlh8+dWuhPYtQy3m6c9vDKnV9eE6qvqCUe5VzAv9QRtu94fsXx9Pb3UQNdF8ye8wMFSZoA27P+gENGR1l0kKYQejkOT/3wNJ4TFFKQ7MSenTJCDqluisQBDMeCxPy4f51Ohcjj23c8/3Eze+V9GDjWpefPmzP/1mRUXI1STuVQacX0QQx8scfOTzBYcIALmU4YOkogSJBqXAquDBYjLDHAIaACBUzAZ5975uY8z58ay6r38f6GeXPmf0oZWMrskeIJ9r1etXdQXh9lAQecN20Gc/ad6p+1pOMzEdlI7g72JYf49/LpctBFiy+yr9x+2++Y2U/fh5Hveumdd9w58He3f7WsZ7HRjp5XOkMapjIh8QVk78zzZnEWSB0g/nagep5HtSZnlE4o//TNXxNE+sN1wlzCxbPPPfv0Wz7aeJxU990c0L1g3sLv400gu3ewOPXVsa1e4pVK0SlQ4s2OUzNnzCIIkkIGsOGNjj+ICkAT369mgdehDkA6wnrknRJrdmD6vbX9/aW//KItv2L59Wb28/eZDajPyWZ24/y5C2Y6bHmGOuqXB7BkqCJ+7HOqgJjNnnk+V00WGE6QIzp3eYUPnZ71tNe5OwFi+TudFguVc2ZfMMvuvuuunZYZVOEKp3xHl+DIyOo777jzj5D2qveEP/F8DWFVhahKjXW9qHDiTHBANf39AeV0p5TxMqCrOs5ceQfx42eSwqtEQ2XhCxAau6FXXXOlbdy4EWT+8DGmw9tnFIX97YbrNvTt3ftS4h5V4E3ZFsGrjukytBrU6kZv4jMXzJ6TIlA6ovzrkE7QcydUDziqBGSoe708W+QbJOXBxXIoccz48q232JJLl/y+me3GC+12e1Ge5zcunL9oEhecNlJjJQG0+jNcsU+le9qYFfN7p6SKkmE455w/10tAFDZOdfiNYsZXn48NzirSe/27U5IT4qdqOvLwour1mDNA2Eb75rfusXs33WtbH3o4HaiqrqvElrIEsUYBoTRCtboqmdOYfOw9KIjMvWAeqbA/zI+6C8RUv86uYkc3sT2dKyy3vOSC2A5muVQBx4NRntN9O2BCPocErz/O0ufl5LJbVY2R849tw36NMieeXqHCuP7/AMWVEhy/7HuGAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAEc1JREFUeF7FW0vobXUV/p3HFTUjsIRAJe01qCC9T23QpIIgMKKBOIicpzjLgqIiaGCTwKAG0SxISEivpvhIg4QmDQwSC5xZkfT3eu/9P85rnxPf+ta31vrte23WvX+49+yzH2fv9frWt9b67cnpk2d2u92uTSaThs/ZbGaf+N4a/nGbx1uz3Tji36dT38G9PGjH8zu2d9tdm8S59Zo8n7+vYzt/jql98ub80K3wm3g+/MV+2+b+rR3n33a7je0drrGf3LYJFFCf2sSOh9B2KoLCTU3AqpBUChQ2jZ+kAvEdt4Ei7X9/bJ7GB9a9dnZ860bAg0+h7FC6BM7H1vUQzJ7UhKMCU9j+Oghvz3/qxGlTbbWkvAEPzpvLI/iQl/MGWcEELApMj3APkiDhX0VXxXNkRXmVnknC5lUQNBUJhfFcWrxaHkql5k0tbTtsqYCxxSWkQgA3nU5hdQgPl+RN5IvcdiXRVGHxallTtCu0hos/flEswzF9lg/8bt/DA/waWV/eJWXi8BaKMc+gq0QIpJumlVNA33KhqxdQwLR6de903QyX9K6KKVRYYIAe0MOm95G09ljwFFjWh1H6kCA2bOOXwwMu5wWyXn+M8TwGyXxWj3O7s0e+A6Jd42AWiBYh1dnY4bcXvXoFjc04l+A6Wx5g1uZpcQ6OyQsAkukBUwJXgmC68Rgf0q0ZBp2C8B1o76Egoes5ihJ6i4OjgmYyMQvp/BDalNkrqXfxsWdkFqhKQvgyO3iWOX3yLtnJgLAHsARHKLo/TkvjmewaDwO5sSBCmYKKYLwoRRKxmd7wX6RfF1bXwGIKnR4K0vrhER7bAr/IBu4p+C2mT957cuYUFKAYdy+IWGfKkoCytpTBowHdHUcI9Ha3itQojtFFQyb4TPNIhVtPmUyN4QHFG7r8rtTnfAWWpsWpQMY+7W3XwWjgAR3q05jh2tUjpsjnhQjpmKlhRHyY82lVyyCuCIE79pkFZAnP9W4aIiujIzzDYjaSmDIFQS0zFgnO2PL1u7GDrSsmPSDBq/KAyvykqHGYJOtLcMzrKLzLYoJReFnXlV0t7AYwV01iGAgQHCHSOgmPzq8xPgxQTg0Vxr48pwsBWQWfcvf/mR1keTznVGmNub5KLfc3BSYoM7REw4XWfoLcvQJY4EjFDs/ttLA7jgko9+cn/kCEYHk8K0hQ8IDLWTbdvfeMsJdTWoJfWhlASdeeRDaoGDKdzoKIBH5E3q8QJ1TXPpnbs4F/7UjOdohYx1WyPqnxNhQgADRsMAxQjHpKk6ahKVotUT4VkABoadKzQdJmXlvJkHAhQNe9AcpWNuhzfSUSPeVVUNn5rsAa5wZ4gQWqDZgCCYgD+YxAUC4fBYsXPBATIQFEnk1nUZSEm7PE6VJhZIeiUEQhr3HFuRtzv4Or0p/wwNybwMcI8SrOih4WTAJNw4Di+rI6jm82g4fkzryCkefKUDWoCk9W4rP2WDCmvIYZbdd+//yzJ9t2e661hlp63bbblT3vbPaetttt7Pt0eo394DActesn87YwQnDMCcDQrt0u22J6rF2La6fXtMPt2ouPebt2N7S2Xbf93a7dcOy9bWG/uX7o4W//47XX/ibttMGsWoSD8MOQdYWzQANAKTsVQD3TGop7lr22/xJg5Dk4/4WXzt7WLqwuXhrB/989Z196ee/RR3/Wpbwu3Tna5z6mRwFkECExsABDj3m5ZocDArdSQr/47NMfacvlO/9fcS/99S9+9b69Pv1lCRz1gGFBpj5hDDFip35A6zpBCof8TCCUN0hZUNLzv3vy9rZaXbjSCnjq5T/s/fTRnwdDBA9gocOyV9+pADZAJDh5gCkATNCx3TbI/60Z4i0scgHl95IWHfyuVgj84teP7T3++BNuYbTdSHUNAH0bgkroSoBGHaE+xkMJ7u49T6Aigj5PWnvhmaeuSgjc/8BDe2/9+z/e+spUZxY3IkSPqNtShhEj8ICT6AhFuiKhUfNSXaAEwUmbORgapXVFPP/M2Y+25RJZ4Ir+fener+3B0iaM+ICnxiFiX8CXAKimiKV+9gTHKY/ozjTHFGrKiLZYNjfhCc8/c/bjbbncu6LSt9agAKa9rAPM9UWMttsGRSAm7HMUHkaLTx4/FQow5mZx7zhAnhtWN7efslGaFWS7agq4576v70EwVZTW5oDrixSBAwQvcHB0BVloIAucPI6maNpOlo9S16s30eXpbGYnZ8o0BXysLZdvX2kPuOe++/eyFhBV9p6fxb/TZOcDVgyVUnk7DPIA5+2O/hQedfwsBBWNxSdJEYsdnPnci098uF1Ynb/SCnj1jTf2vvudH456/0l08IzGDj0EMjwYMtZwUQjkREjtbwrH2Pe02KF/guBzTz9xW1tdeSbYbrj+r1++594PRmz7IESon1ngUjJEnLAQAAb0oBbuLuHN2lSMPIHZgF7w3Au/vSoe8Mqrf9n78SM/6TrDCgnQ3UyBmQmU/joMwEUiPzgB3mAsyStBdXEIkkyVkSInk/bc009clTT4y8d+s/fU2WdjBNZNgQoBYtpj/As0ERo2rzx+x4kdYp2NjCxZKSCUMbcYAvgFX5hOu8zwyU99ot16y83tzTf/2V5//e/mKTfd9P729tvv2LaV0bttp7Tbb/9Qu+WWm2Ma9Morf4oeooYrMWAi6saQlBMulsLDgBjP76z0NPzw+SAwwMtgnK96YDNsmAUM8Lz0TZQnFwirB/gxA1SAVOkc9UHhC6oi6TnZWBG9zrZYNlytQcIEb5/WVPGBJ1OQd3V9X+32RuFT0V6pD1ZXdwgeAhA8cecpS4MStic7lf9zm57BPoHCpvIHKQznmfAWXjO2oL12EJ+gLK4UNVVKKsF50UxFA0SDT8v35P3m2lEDeMtbPUC3tnqB+C10giIdIgSSBygV0ur6Ax6EUD4cNYUJBItnCB+MLPk/Amf+Ztd+i2lUP5BRczZmC+7+ppAobTn3qwMQCwecY9YlB8A+jsioLFWBCgVTgCF7obsERTE+uiYUEV1jDwGxRilMwEgQdSXtHFS9FSYFMFz6jpOGZEnCYl7WzQg0c7Q6QAMPb3GJ6AjlLd/D9b34ucQDToEJOv2lZZ381ALJ22MCRpbK4gvu2jXuYXFvqHbMshRQ2XpL66sEJxiz3RYdRB+QqPkaAhaPULmraZC8BYgf4OiTomiRox8gaisLh9urielubJ5gCtIqkb4m6NzePIgWlkdEX2FG7woleM0RHuWoH81Vnx9oWhQzA58IQRmgtRJKyqnND0t7lh2oDIWIdYWhcSM2YnpufXoDvQI3VViwWErGGP1C7J8RJHUdCyd5DGEvy2xt+/7oGvde0bXANXPxQQjnh83yuwk4DL7N75vNxoyAlCcFICzkFT4eT0uK7UUcRs5XDZAkqDZKFNOwIhWV5XPWEWOlqerMkFFW4KxARVdigXJ4NDp9JFatri5QWLtYfRjQUFaXyAYjd3E46m5X87UECYAU4vv4qnqBMoVcHqEij1JzdT6dMx26V8jrIgRHvIPxnjMDDkqNINhvGOo7uGX8w+prc3GGBdjfEJ5B4Qe71sphKCDIit9MYy2mr4z3xABmjUp81EMQT1D6y/5iIVU1DEqaJAYxHIOP+FhEKTDys6N/9vtoVQgm95ag+sR+CW7pEaO0M6fujvUBHQ64Vyjfj60tATUbDJKkosmZn0JCOEBvcm5RskmvOOKGFEyhWbBpGGR+4J3eYevxPdDaUgLcXdvAAmUHbLMW2FIBoqOV7ycget1fLNXHvrzEY9/qClWOfcwzu9RjVAbxQiU3t01JsfxGoJi8sDJBojozQVWACSoljJRhoYGGiCmgDkVLylMaszBwoVQGy13NxeXS/uC1ZIbASqsRFiBVPoEyd/f1iEyjqUBYPVJoGcXHKg/n+3RnxjbQHt9l5fV6ZUqRMnScAGlLZHoFQFDFtwGZs/FMXSqG3Lqe+pTe1C80b/JKUABpyvC6AJ+pGO4Pz3FFZEbivWT/Ot2R9c3Vh40pAMICCNfxuXZP2Ng+ZQKTUyEQWaDwdub0HH2HErpwKIUU9o8Ez+KIAkaKhHKMXsMb6PLhAao2R6EQQOioJTeucU7B16YA7F+sFm2zXrfNwP3ylgBxgSDTH+09Tn/B64Mg9QAlgAsm6CGRzJBTphDSwQ/HZ9N5KsYtT28gJgg39MBWInuZHG7vVqXgsPKqLZfLtlqv2nK1dG9YdRMiKNOqy7tOf8YwQHN7A6kyEsuuUJazkTa9ItTyOQFXjWNZ1QTxDFBjHfvl/rhOodErL3sJlrs994P9mdu7AharZRs2m7ZcLdpiuWjL5aKtNqsGHLCsUVrmzCLCAFVq7np1cXSf/nxy5JQ5KHABMbr8jEheLG3bpgS4/rzNUA+4wOYJHg5SgCnFwbJPh6C97AIR0DZmaShhsThqq/WyHS2O2mKJ7VUX78Eey+sBkzNgguL1o2xQaemY9uYQlYLaAMXL4Pls3pEk0WIT0pUSAocHEBQh+HyO6x0YgUOjZomIDqwNIfEPVt4/3G/L5VE7ODpo69UqhiIiT7V3IOaYPMDX9YsFkh6XosTTne3vSE42UCuqB+B5XSBrAlihhLHF4Q3H5sei76AwYvXpz+FjbwhCq69NcMT5xf0L7eLBBdvOeWG/XkC0WQoJKiykViMkCiG5+iVLZcTUcqosK9fqr8a6hLbUOHZ3WN7CwjHAU2TPCRizzPFEdAh7eHRgwu8fXCjdH4ooK2u7KsCEh3xcKMliyDgADkQ/z5fC14ZmbZXHCrLsFyoNCjwjvifOC+bzSHsgQfP5McsCUABCB9vwBMMev6/SHywv4RHn+wcX2/mL5wzwOBzx1ePeJY7vGoV7ASUDkwlisbS3xGpFJzZnKVBFksKihkMwx6zzGefZB6joLpCE8PIExHyi/8wUQTyh67P5SeFXq1U7OITg59vR4sA8QUtIY3GEZwotmqoVo7whPCCXyeV0SHXAOP8HLjjCS5NZ3Gh63NcAzPeJ6pEa3fKXgJ+TKb2dwsbGuh0ujtrBwcW2f3jRUL72Bjqg05xg9IZIns+OkHm9ESFfYyqBYJ26trcC4uUKoX5ZTba7sqOcLFD0OKwvNujKIAnLdpko7dHi0OIcCI/U17FCb2KPUV5kR/MFdYTpEaSTEzRFOfriTYMilvYYSZJ3hEp/P/f78SA73hYzT2FbDTFO4XlMXWaFB3iDEF9uitwOtIerHx4dttVqadxAguDTirLLEJzq6rEeyNkfQtSmQpBFL00x5xcFODuMirAsh2UlWF+kyulxN0csNb3Gb8zvIEUJhlks8f5yeYAbhAejU0PUrOpVYNBjH5HJ4nq+uh5IIAkj534fjKik5QsdqYR3w4BLvCTG5v0oLThFlLX0InpBjxdqgSvHg85ScLzeNjBDjf70Mqa9/uZg2c8K8oVQZQTOHdkdtmcYL5HRTMi0WBUSCyQ9K5RjSZezhYZnDWLkaF7L3brCXBikMhUAZ+0te0h/2WK0VjgE0ksZnqkq3a1hYANTayfpjVRf3i8F0Kp6I0wvTGbfr7obw4JvhJrHjOZ+rBH6LrJCxhRjfQa+3CjLo1y1Ot4BToOMMERYjnEf5KYgvoamGqrU9Me5oq8m89Ru+zAa44uQ6WKa/6s07lzeH1zdWlkoCyNqFsVOjr58tuAW0H5rVvo4G2AHxSC+47dsRbgvZnIgjlfh3AOF/LKwQriyPmx/68EftM/e/flH2qT96Py0Lef/apOvPHDmcHLnp7E+QGknLZ49+RyURtksbu4xGcPPUlUKtOj2+eKkgZDe3rS1O1zDYxb1XoTQPdKY36d6EWIZ3tL/cQBalfDNb3yvfe7UFz5w/lw7vOV9bfjzUbx50269sd04OX7HSXMiXpSdV3vwmEfkGn/S5ciYuX7AXdSs5x2bcNU8PZa0h+XKG6NkZ+ZvXTqWB1ZqiyciRuTrdtgGvX34ge+b0PsH7ejcdW1zVISuCrvuujaZ3HnHCesxkuDwcJ8J6n5/0yuqs3yfPgiSFDGpL1mUl5RioOGz4CIwV5HwlRrkew0+oMjI+fFqXB+2T//qjw+2SXtyWLdzbw1t+W5CjzPJfwE115LvDkogEAAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAABAAAAAQAgGAAAAqmlx3gAAAAFzUkdCAK7OHOkAABS2SURBVHhebVvbjiRHEc2s7pn1A34C8Rv+bl6Q+A8kG7DXrGfv3pvX6ztI4JmqROeWGT2m5fV0V1dXZdxOnIjI6p//9dHYTlvb+tZab/zbe+c/vLZNn/UX5+m7vm2tjdbmb3EyzvO5uFiuwevguhuObQ0/7P6+fm69D960tR1X47vRjtbaqY1223rb+Lm3PkYbvbfTwF1Hu2ud5+A//A6/4Yr874QPx5HDej/G0frDT29GBIaQVAR+tUGYpQwsdCmC4lEYnMe7lvOlC30PhUAqKtAy5X74O8Zop+00uHacgDXq/xQe+pRc7a6NBkHucAYOQDp811vDBai83tt5QCFQ2lLmA14OQvO0TgXAxv3hp1+N00nnasEbFyslYNESJgLwmL1AxyRcDJb3vHjxGN9AyppeIs/gonrH6vAzKUMvHIN1ccrZlsX7bfS2y0XoFVII9NnaicehrN4O6HcuDofH0Y5j3ah/+dnjcZpCxU3lynJhCH/iD0+nsxcfq1sZPGeTNa3MqUR7Ar7jNe1l+IwVS4gOd8ZrH0fb+0Yr7hQ73oCF6LPMrjCBsAoRHfb1qBQoCd6Ba+EXsiq1clDNO7zgq78/pTq4wG2jAAkDqhfKme4Nga32YECUF2+xNyh8ZG3hgcImFwjmtNHh5nlBGOrGsb/CAUcSAtJbUYcDJqGA7+VDFJpYQQ+iisYYR4dr4Eb9y89uGAKwMteBs096j2MMzRIWcfHTSdaPS9NTciwYYKCLm0/FEixtELv6cGwzBBD7VslYgCYjCyngHfgLS0/fkE/ZzPIVa53hk9ChcuAFVMBX/3hKXUFYhIKuJyXQYHlvoeLi0ztwBoAQqwmACjiEFSUb4B4IAy1MyjPiB8y4tj7awRgftCDie8H3woeIjltDIVdY7wRDW9/hkWyAa20QXIDYWr/5/PnYNqGHssBKcxO56RVKexUQk/aI5lYQJDrBm0oalbwLU/QVcQv/sBKg6V07LKhcPJmAAjIs7C0WCvGdvAlXFWYIBoTKzrb+HbIJXvAGWp9p8MnDF/aAhf5OTTP3xxOgKIYIQ2MJlZQ3vWJZd4Ji5QQXuR/eKCXcThF1LIkRguKFsOXfYtUokbcuv6cdyBjyUjo9Ma3yV8aAx1+8oAeE8EgIu2pNVzMlrjTInOO4rx5U0H3xBF4LnuFojJDyAlgPcd+PNtMbzoRSQHaiBEWNLC1Gtf7FzXFc3ykV5tx6XKGALAAF0L2ZyqQIva853jndiB/rR2nxGIG8foe7KhTkKXFhAaKEtEsineFfrHjrjBnWAsvdGTGA5iRH9oiCldMDcNkr55ETbsd7gylKeWfddyAdtP7s0atRgYnQakXEqlHQoq9RVI3tRaOp8skhVuxHcV4IXJlxTua28n2iHV4hC8JbW7sF4wt4UAKFhVOVCJGvuXBg0eF4AKwBr1IYP3/0ij8Lgk/Ob4q7ISXaXMoMQvaLeCceKO8n5UmR4BAAz5CeFZKmtNP9ZZzFAA1wUBAWDmXQ6j5PqxfICfxl5bOVEtYYr4pXzM9jjDOx68XN6xGBmP+D1uT3S6jEdRieOIL9NtTZ1DfKSVZWVgwIk6eL3x/tjhGDtCfhGOsl7SX9qQiKMvB3xVCsPvm4CyJF/2hnJikVUAgNv8QM+8ub11aecv8lhV25nMepHCLEVFQUNo7RtvOJ1q41QPJS36gA/rOVcH/FvoQzNgsMyQdC3QrQmSeoshIYBuTwhnkq3m1OwHN98NpYZMAcnQoQ00upmuJmxbdoq1yasZ00h6A0aNL9WTPg7yJhTH+6fYAO71HZRXAHI+N5NytXfLoyismc21kOW3EpCannwgQpNMHUCsGyyAEMiDAYl/b14zejujO8IHVBrdrC6iYTDNHpqB8AtZbDx5EBeC+xSWcvlbKzqpP1AYCXXqCFw23lFfJpVvPbKnwQNqOD48fZDZLxACsZgKefKntEKQTC/vLxG1WDTnthd8rZCgEpRGA7+YKZY85P6mRqKQ0VF0CwLAgI8row9Wh3xO3A8aWHiNKK4qZWoz0QLqjlnBESAkR9p8vryS4NUfaOACEV4NDc+tdP3jINSgEqaFKpBckJau4YkfwY9BIWcXhS6tL9kZsx3FS7mwRRESgdxPkRDkL6BIPec41Ha8cm90UZD8EJoHZtHvexgGTuVIkPhDu3o+2472jMFsLm18/eDdXyq2tTOzaJbcWkCBbDoHSBqtVX+bu8x7lKeR9CO9YVARdsLoowV6EiKuMTeKktxiXBOQmsivkJgFY3P9MpVdeJIAkLjmOMU3/z7BveLDkb3gBVx9VR6Yn7y2kCmGmAzKZJqfu5MvcLXAMw9Znv40KKXzOEhuaHYc3ZrYZG7e9N/uIwiEKsS14Fi4VXsF84iyL5BfiBkiLDYGz97Yv3PK82RKQy9/yYRNm3c/0/zA+UNmX9SoLiW+pHbX2La2Pxd5PKsgEmhpfqraMjJMAKyovqrDRJpMc5Gzo9dn8ZWdV7SXPhBfgKPcHgBRQDHFD4vH3+niGAxZ6Rx5Nj3OFNGptdYxF+nqfUaUVNH1GnWODW09IKr086xAVQ4kbYuDqzxCRDobZC7yiCgGcmmUKJpGbiqdQmYeRLcHnzRjdHpGSFAPM7rXmUpobzfgiQ3ZoGYVZIOLjbe9H+Sijy5iI5SnfquNjSVI9qgJS6THcrMUzihAwiC6Y1LsBUH0DCpHkST2BDWu49G6q5AnqJV+wMv3v5rWyVNra7O0T6kuv1vbBC1H6Fzez6WAmz06tskxhOkxOiYNGxPtGbTdCYXwqZ8W7h2Cab9cL6NjFNhfj7tM/jBatXABxQf5a9eGKAyM1qXCYLLPor6rWIkSxcewg1S7iwEolRnEIT+AwlwBOqO+OnUAK7vA6NNRiRUsCqarv8wuNtYalEHmKQ443THUb6uwbOWFFY3UYPWAWOrAvr11q/zgdEfNLxVbFdFaF+gOc1EhhWwU1R07MbXdy4ekjqgaScKAa/ibcY6ygqKUe846L5oRYb1CrLi4rifUIGIEVaLA8gbVV+p5XdRaAnWBnMDK4F1vBjxrpCAzGVCdCa7gjt5dK3qu5VTzmfVyJUwQPkicqwFzG9uX2GaCSaBwwLyMUDkkGEFYofpMEAJpGaCqicvw42ZplcsgPVnnlh7fSgNRZ2smZ8RHtHMxCe8c/6OzGuH6EDDCvVbHCfADEEZlNEmDHz/vQExXg8Rd+j2bqRBKWdfj6OIbR7/+q7gR75+XS+mOzMNJfGhvnArAwLCIYUpanCu0sJEYg1ABmg0BsrlNCgwqkv9RkFTjAj9DY5PE2R0OF8ZquszAOVpxUmGY1B6cADtN3ZF+B89f2rD6wGSWjSCjtWOGS1HHpkBmDaTG9wpqjEyTKm15dFuhFPxP+V1FWRDUWcPMaaLu5r5E+tEyIcpAOuXIUFub2eYgsLjlJCirIWkKjOkH374ptxPqtRMtHfff7ZISqzPw1B9CI7zHS4KMIMMD2/JCxYAp4gsWExoUFZv5ogM7YFZjgXCsAi6Um/AUAdQG6Hl6FOEPgpEK4yYnfqY2jtx94J5sAAEiG3v4QHa7BBcXtvV2dcJ2TKvNNTnwl8HKOZxZorlBQXJMcJAEORTud/A5ywW3VDCp5YsdYHsUFG59EKlJCCCkNREi2mQtFfdoRhX2AAQfDPf/rL+OSTT9rHv/u4ndzSwspqYyQtctwVjDHaFU1OQ1S2c+Y4juPYWAfIXhUL0rBUgaTuUEX/THzi9sEBhE44RX4QoHSGZYmt7otoDbxmdmNSMWpvhRbWv/jbw/GH3//R+wJEfzU/X0pgNbg8f26ciJJWr9At8Hl5LpitaxSZYXsGxwBb8v1m2xMrCoGCIMAGu5aNb1o9SZbKYhEhvaicWRGq4jsngsSqRutvXnzjwYiaHoz75HT387RpwrsPXAEGM/JXijva+YwOlaQl7G7sPGUhGGrwvqO1/4B6ZMhhBhghQ5/HSOPEsO2wMdtyYs0mCTc/rTx1hsQXCFkNV+v92PedSqJ4P3/418DGB7m/Dp7OHKUDcJLK4I74jIv+1xrG32xaWNYU05N/ud/Hkre32w0cQN2g0F4RI+/vMW4hxkAxQTfVZVVRglQXAJStFxusdQOOYwJ8dP6eNBrpD2SI4sHBkfDYMocCENdrFIb3ZIDs3phpRQFB4l9Ljz6YoCaHVAIAm1Wg6e8tlrWhF9g6FoRrRBAOPsz58UMIEULDOA6o530hO2t2sJSiEDApYtdI2QAauLZcV8wcVMDMAqs97kkwAEq+rI1H0DQWHu3H8rXljXOVrrq8aMhrjDrtbotiPTGSt4xttL6PNs4wPZUwBsBncviJA0J0eJNCxrXa3FUi8pPcj6trl1hrHzmLK0OgNygFnNTaZm7XdjiyDZHF22Cau7qc5NptJbjYHATHD3/1XwifNjg6PXgPr9rb1vaGNLRBztY27FvCrVvbD83vQ2W1KFEapBmTR4GicXmdS20nGrgwuD3AVeRJRRHCGAfgWdf9l+/+zV/UiRCALG3w1tXRNdXMXj3E+U5xggJubFhoXDI1f+gDS2Hs/FBaBA8EumLbFjOV0dvHhS+p2yM5czrWf/Sxl9TE6NtG3zBen5RYPUC+xmjXxPE1HmNo9e/f/TSurq9mFUhkTIvc/rJt3FMga4a4wL3dkWVYrDSE8zjXt1f86tSE43gx9rFFZ+7wSdNE0SyE3iYGqJTBTxChRxsHIApdXW2VS2cYFt4RR4f7B7xD1DrYC8hAU2E12oP+04dfRgqcEJlsmqJPr30CcDuNtBZ4BRcClrF8xYawuxkOZTKUbk7l+rzDAadEKEjgxHPcPUCLEGFVSJK/2mXwTFq/y+URYiBJ6iH29tGkxz9++/PgYNOZIAKn9k9TlEGkZigiKm2tpEkKPkNF85HF5BQE6vpo5h8cuRRIK+a8CPHBabsHIs7/tHJhjqhpydvoEer4ne0dAU8Yju1weoBCIFlm6z+8/2k2RCS86G12jKYlnkml22RxvXRxUvmFL0pACZQ2WJoXNjC/XSnM53sSlBZQ7Q6F4WWUbgMTidYLitZscc7vrUwoAcLH/ckX+vfvflRDxK1sdYdHO2evwNwQuSY9GXwiLrt2cK3G5+oCw1My4kohpP2+ywPkNBp5CaxkKWSNZINKcgSWKouSWaIYICk3+wBotTFSDZS6m2ztHOVQ9UH/7t0Pg80QzYrmHoFsn03Pj+rOFjp3kOeaQ34ElMGBkAUsVilQIJr2uMbcFsbewlA2b0YFl0Ko/tVSPAw5Rjs4klTlx8zhaTERZLT2wEbCOj6KB3Au2doVFcDY9tZ3FtZsgbnKMx/I1ri6H7icoywRAqzcC/RPiOQbgePaD1R8VzZI27tMcNMqS6rULpIlcFhnWuC5BnaGwLJYF1mge5MAxTjcdf/w5ntyooy3tCF67QBnVeiN0OEKWPXkDQ4RytU7dnjlNUdeJjZih97vb6+Amya9QlB0eGD5ZI45JipxkL02OYctGWeo2ZZ0WpZHKWxEhwXWVAKpMBSQIQdui3AQJmhSlJE5MgUIUn2lmZpBiaiZNj8bF5ImExZpVlCHM4SEIcvNlyexwxNAs3fEeqJhIcMSkFhknk6Qm61w0WE9YKFMc0IvtL9//WE+MJGWuLa4eCuc58rp9OA4QgT9NDZDQajTJPFO7N63OysBF0r3NliQqU1QT7wb50kkYUV2dDpT2DNwXjyLbXIrEZ1f/FaNl9QG8jhey/VADLCNNk7sg6IpmlSXbfHUYnlYQiGiMflShG49R2WoIIt7uHVO4V2NgS1GCUH4gObFrm8LwP3B7uJwCQ4DG9jJr/YAV2yLOI127YKMxZEKIC0CBiSBePtS+wPynEDS4SRAeY6oNETUJ6lb5e1XefojYzYRJ1w/uzup9LJHcLlz4j6FloCOj74osvSc0AybJWymyTVd4jTNAdQIQYW3D2yQpPS60HHsrb9+/pZESOQnbu/t8uZpsT5iJl2jGLumxv+/UyT7JFWJ9A6qPvdU4TI1U8C9tYtD4qDoordAGUb12c6zxKv4kVLWbg4a2o8eeB/DfpigrpbYuzUZ8vgre4DmgxIxQaa/UJiTNUmR54NKixJUGLK24d8HTwrOvM0eaGI5YCkQWkqgk7qc5vZZb7SQRfVKVmBsxxg80U+LsbnIO42274Km/ubFO16Cd8QjM3NDpLyzbqBSzKMU816Ce9S5ClnLazYg+TyRa5ps45gzBg6CsqUvFq0ENx0CpjR1folu4xjY5tjbscM71YtUSkZXLQ9IeTgZbUEpUdLXT1/PjlBADW7OcVlJe3Pfn4lRiJOMqMx9HyQDmKov1JCrW+5oC3NfnAsheJ7vIU/SJFr3EIYdx961YQvH8fhbHoPTtFqWtv4sqEJ/6XR6xcsnr8pjc35azMTnojV+bwNliqZggLwlC7D3ZDudQ4MuV1IFlgOlYTEJl+pFy7nzLAykV4ku4dW+hzsr9KIQjQt2eAXPVUjEE/VZD0/25zcv/cCEN0Z6/hfBkB2iLT1MlWeE6uI1WQLAzL0CZhxcWELMIJtZeXRxYc0Z+m7J0WhasLKP2u/3MQVK0HwTY/qEgUOCOICgUYsJilHq36SAuD4L5rlb5NKK90vlADUbqtZ+Bqi5niybTdaYR8k95QkO+SR7P8+XzRcB0uXeM4ssBZRmZQAYwqWmPOwZGfTAQAlLPjQFhT3557PfYkA2RRS3ZozfC4MIqhrW5bIDW4KL0sXvGds+TwNUKXmGt628vsv3C9hwPinsBe3SdfU88GUG8CBwJop9d1PLXtGfPnpODJDGtSc48/64PFE1O8VLCJBjmjZHWD4gnU5pHq6wr99XRqymMk1glpfCxrPHNA1mKzipVmdfgJtBMJRJzwgv5azP3j568/DJ9AA2Qoz8c9NDeU6oVoMphLLoACDrBKLNeuACHxUmlxupowCN0dJyM5dQ6M/KJooBe8vaUoRd5vqV8mAMhN19zBAVxvG99ZuHj/m8gATJhiehLDZOxtU4+yu5fIKhF0nleP9wOAXBqDyOM8PEiggY6hmEhG7SaviivsvG64sRvcOBw1SnuOCOrs2dqvO7KCopEbf8H4qrafC+RB9gAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAFCNJREFUeF5tW0urJVcV3nUet2NA/RMS8046Mf4FB5qQxO7Y6c5DM5AMJANBByI4EB2I4EAyEHGgDiQTdaAiKhlIQJEoIUgc6O9I97nnUfK99l51Olc75946VXVqrfWtb31r7X2m/37wv7m11k6nuW026zZNU5vn1lbrVVtNU+P/Vqs2TU3HVyv+m+e5rddrvk4Nx9dtbnNbr9btNJ94n/zgHrhf/VlNq8YLGz5v5s1xzTSt2ul0bPhA3QHvn/habtlOeGpcx5eZ95pPc5tWE19xMq7j77Tv1PAb7onz8e+Ez/zgvf/M6w0MaW29lmEycm1DYYyNbjB2kmMmGCUH4Hw9Kv6Tx4bj4kA8Hf4/NxrO04qD6NAT790N8jk0Dsf15HIITSl/83jMawyAPIIzZztEQcYxGB7nTe//89+zDIcDhAA8m6LcGpyDe+McvAIN+KlIwBvr9cbo0cPpPvqn6+QMPZei7cDp/BUslAvw0FNTMBhRRxqOV+AVQTqfiIHBRgKijcj7moqg+XQyEnTd4Xhs03vvvj/zo6fJRiQ6w4AVHh4Rp/GKEhzSDfQxoCYG4Fy8j4ejs6aVDRMyEqE8OO8dVPjhCVE7MffBK9xEeC+Syo6xM3ItTjryGiNjbm1/OBDFjMe7f/vXDAMTVcEdxo6cjjGCLSAfpCg6QgNSoxhBp4o7GHtGL5HXq36MErzrexEZfl+RVOoF/ogkAW8HE2G+P2BO5/Bea/JJzmPeH3Ht3I5HpHZr09/f+cccQlOkZLwQoSjigwP5OD2ISF7nHnlwOi0GwsEm1h42fDgctoC58hbXIoKdHI2YEG7SQLhXynTIh9zaxFRIeuS8/f7Q1ry/nDT99e13Znh3s90I4s57sb8Ij3yAvHdExRWD1VE9UiGIpOR+Xgsn4IF69SiEaVvskJE+cSIj6erDaJ9OgnYh0yCjv8aJrbUj8n2aGHlWFaAHKPjLH9+eN5sNHxqvMQz3xd+K/uCDVIRBliMd4rSQ3kir8AYgKQfgQXDfsPwgP6eGDnRuZ04H9p3g4C8YpDLXUyJlz+fB+PpzOBx6uZ3+9Ps/z4gwHgpeATzwmsij1PWyx9RQzcfTiEjE7uGBkdP6SEY7US/lL1pCuauSRuibxII6FHzVeXvExnX9YBedVwJcE8P5GtQ493E+nfa73/5hhtGAlwyFMwDBFUtgCAzRQqkTCUonCH2VK+ScHB9VwnRXS6NLaSJ3RuhieuZ2ioPQEkMlzPT+ogSejkRXfnA+UiX1v6cO0gIO+PVbv5nXmw0jhZwIF0DRIcob1/doAzgK75FloRatDFPjwROKnlQhXWTUqP6L/KIF9L5STM4At1jw+HzpFqUA3unEZgdRGM2tAdr4bLyGFOO0cABqP5yBv3nPX/3iLQqhzWYryFoOJy2SEkQJSNCCphvu8kcxZSlTpbIEj8peFGNXjhZJKY9w3hEyuKhASWNHlMpOdElVZ/FD5Ud0KF1wDzr0eBLbn4ScXA0H4T1ywc9/9ssZ0U+t34DhWcIAbRxXL4D3RZKjJPZSZ+5Qz+CS599jrESgK0ohsUQ/Oj5GxXGmh64FKGNdx6MRQoIhRCFCDtnv951bYDBgj4rSU+knb/5UVcAcAIzibxrviIcjkA5h9iAED4EyGK0AhChFTuwVutxBalhOnyOipsM5Fwy4651EGb8TLagA7iMCfTzDYb/3uSI7GI7Puby87NcwLX78ozdnPHC6tTgDSGBVMDrC6PgbDmElYA8gTYDrE028L13gKm5EhRsGsS65gKTWVV+6PKVQRFHq92B963tCX0YS7rjmNLfDUXDH3/gdRqcCMAV+8P0fzjBmi5rv2p90iGNCbOCH/B5S7GWS5DikcDijyuhI6XR3tTNk3jL5pSBTHVIiQ5CCrzgFBgntcIJyvzrgCDJsjWhAQPYHoGI4aX+5b9N3v/M9coCkrw0EKa6dFmb65D6dAgRwXiD9kMjnmIRTqQTOg1QFsZw6ykhjwFhKUyengendn4UOWTyVwLKXET0e1d35WpQ7/I0o4yfpAQeBF3gcJfZb3/x2J8FuEAlPGiBVIQTIsshmSQ+7RfWwgeQIljm9n1JaS2Te731Ab5JWFEyZvCQVuiMyxGAEpf9jHJkfzO5zcFxMf1Tv3xpzn2kAVBgtRNXX3/gGy2BITR2ciBDCiLB3FSD8ee66iSPKDMFTn0qUans9O0A5Q5SJoFCjKgNJELxBBzj31e7xGGu/1Vzqd4yORgD8a26T+JzvdIaVX0UDe4Gvvf4GOYAqcDV14aNqgIfVA1ejMy2K0wj5yGE7k6TprjJw10zAkxzLbRd91XTDPOdEzIT5OSpzY4NzjgdEWCRYoR6eiBPiiDivkyQc/9XXXmc3GBavxsXwYajbZed/EBBDpRI16yM3ZJ7InFd/oRQoI7TUPc8A0/RkbIVXPDAnOCS1oeK61j8cmNeqEEfyx/EINaguECSpLlCzAlYLpAE445WbX3EzlFGX5GvITcYrLRaOsDLsfURPk9E+i1RdCo0w8UG6y6heQT0DDBKf1R91PP8eLF8bHZEbqgZ6AP3L+0SCHRg+yECE1QIp8OL1W0Rcz/My7dExMXrnCJybZskVQIQXLSBHDsd4MOrOMXO92sePYajyXVNdOYHEBokL+esoEvaWucntwLpGPOmBVNH1xTkundP1527Mg7XdCqc9tmPyfkVBFUYZlLATdG/AEseWWf1DZoK9FDoletNiAdSh74pAweMIRxtgppfjJD8bpmkwYK8UEAf4d/cE0AKiIafAjWu3OBSN6mNNx4TIwqga3adEHnKmXQYiunQ21HsZzEwgA84ulZfTY9Z2RltGJKIxKPpejJ5xtwwE1KUinfMmRTiEaXE6tv3+ktfhXE6SqwM48vZwsnd5FkZygORvdH7t6rpUBvFZJFX+qF3gmDmUMujxuPoBaYiDIatFDfX8aWAE8RHBdI9BgdAhLmDzczy03f6yHRB5LwewX+MiyqpNQMC5ElTZUiOz3W7p3QxJKID68NSRL50iEcThich0zBPGaB33w300mdXITamAmYCjqVroqIXBTYTmBkL8gNIodScEHCh5cfxyv+uRx/GoSK5eubJMN194mVUgRIgHBphgeCRuWuPksgy0UAoRluFIVYHqMkGQtTPMKFw1UMOQMeVP89OHGGha3P1VTUD9T+a30a4CMnzPXiEoGA7WOgUQwMDHAZG2PQUsbJLnPNn5yzrvakFjS5O04IUV5gcyMlUkBqf8p2usDpDgwQQ3k1yoPB2TxhfB9ahDBxz2/Hd5uRMC2BtA9ooH4GTI4YvtFS/DWYu8dOPLVNbJ9S5+XPfZJHFKpFIXFGhinBWlIpetB5Y8oHIqnvFQtSwQ9AUhktuAvjo7sLzKYchRym8vIrPxl/vLdrnbtcMRkRfpMerT1PaYAWShJouxGcW9evO1OQMFjrv6eNwDUhvNkZlXhHsHaETUjjCOGRFXjocP+CAuizAgK0pqZYWLKnRS+qL6VAWk+0F4gP/tO7cZ6Z2jDwRklVEpILks6GMsv2FqEMUvXn+JHJCujoyP+R5yxNAOrLfbC9BSXwLDdRyhGS1ZR1BzlRH6UJHilNHy6m+6pE9tIZQY4QL/7hQQ3qTWFvDe7e6wxO12OxIeKgGQEA6JSMrIDM9L9ec5JT8ZHJC2tUpdsnjZDxCOwAQZD73ggKoIy+9jiW2sJ3AZ/GyhNdDOg8WATHWo4lzD1QBp9L27vENHAO5wAuHv/r92g5ke0fliJEvvlR1QhhopXzGQIzCPx+piCbnBJXGMyER22y1mBl5m4729yuQWN9xBRywWQbVsfx5BnJdpjyB9bPuDjKYTTIBLo5VP6gRFgrg3qxxH7F6ev/HFW3PWAlL2UAJr9BMxlDJ2e14MGdJXmyXWXh2mo+g4jdLVapedJdlQ4VciAALHY3WVLI+5vfDJ8sf6fyLTk/T2l+32nQ/pgNEApVtU3kdRbtbbzgN8/qwz3rz+8pzyFhLscz9PfsYcMOuHYzQOwzoPZN3AzZPSBp0lvJ5hyFhUDQL6woe7RMLYw5AefXeDKXMwDBwABKTsqXRaKs+oFIj8GMdj00W9L4vESzdeVe1xecpgJLK2R7/Xfas8wlflbVQBj9KcayJPlU5VgbIVpwuB/JLx4Ch3AsLY5oKIU/Ts921nlYdjQMCQyFKNrBpOuSz59VacpOvB660vvULERY6i3GkUplzRdHeMxxerwyyDmv0JPR6nnc0GO+lly42h7qLnlVqVqdoEZW0wS1kgPBiMyCOvUfbwD+jCun/6CUrtacVjkvIi7Uqu0STTi9dfnpOjXPg0fLNS3OcEnvBgTIYhhTS+4J1zovgQb43Lx1JaUMINFSX3+yygL4RLCOF4hpzhh+Q+EAAHoPSBCLVAos1PsCWLoev1ttf9qEGVVPUMJOMb116ao84W+VLm/Iwymxs1LekTzuUtRZSjT8hvNoxoJsk4xkh4E0UWNfm3nZKSlRKIZyIqWmO5w4Nf2gHR+2MIgpwfJS7CapRXVYXoCtyvOwAnpSXWPE87wrJCRELzemEiTYNK3Q/UVSI1NU5l6ejI6rGYT+qMrbAGKHU0nhkfJXGf60EB7i16wv4qjX2U5j1D1fBso4F01vqg5gjTtWdvsB2moR7RYZWIkfOOEa3pqX/O4kVgn+FnjI2OyJSYju0DUSm+tNNaA1D0kd9ysnoF1v0y+MiwIwujZHs4JQMSUrrwLdE0tsrhXjiPDj1hTiBdwKUxOACG02hrfdxke3HBfAqMBhfICREzWQ4DzNNTcG9h9hR5g1Rvrb3PKKMwcAVXaLxAQgdx/0D2/nk/gNcLKJM9Ae5tc8ZiHqamiQoXwHBG3hNjGS/0TM8/fX1GTuPkMD5zF6u+ZwpQ1WIsladRWbTQ2XQZsWMRJMO0HSajNTotTYrX9bkLBQNLLf9kGZFRE0LHJkktfU9ke+oFj8BhGBGVvsLrB1xkcTpxQwX6DSBAI2kZRhTUXt85PnJYJREPjgYKUdfWGUlYtdNSiyynSa2y96/ygqCk4WlSsC6OkhQ9wqLx7gmy9ohI4ndtfAJR4m85YyjBMVFCB6kxm4eizz/zQh+Lx8hIWcFY5FhLXVhdBo9tMPAqmyXlh9LAOmKz2rTjjMXLMQ+Ec0SAZTts2UOAazPUTDqSxV0ZcP8siiYlBe0YrHKXtQF8ToajCBRL43NPX++7xOAxNj/eJZoPvbi48MxuGJQPlJx1i2s1yY2IQJUNJNt7kcQzirEjLQOK+MVISTmMv9DGagl9bJYekKeve14z8tw2k7I3tshwo+R61bg0juA8+4VrXhfwii/1sm4YsUMl5ZHYNGtCNByQaY+WvOS0sfWd1cHTGHg9YiWaIvVfZXhseGZlAKw9pMlCiJ7MGx89J8y21wH7I5GZzrFDnoNQ7StApeCiz+c/90wfiuIG91y5RxKYpfDYrlxc8UNrdRd5Tygd9g3I0JRIHAD4cREV4zJvjcU9MUih8poxZb7gypLk7OjWPvHxT2rJe4/Z3qHd+7F72+3d7a7ZL7bbdmd3h4FAnoO4MeOjA5H7l9oLdGd3u0tyMD863Q8//LDvO8A14SAG6r5PfXrGA2U5KjmqjVLK5USQwwz2+Zq1ZavLSHlNeLqw4awx3Z8p/a5Z4OCE8+0xQoWnhN4TkMujIrNuIMXoNjpb6oxErS+qqqR0agg1t+n++x7o8+jAMK9dpdWNz37eEFf2CqW5SGoIzmOT4zg+VoRSRqNCqQ2cMoF6tsMkrQJn6ZPlRkk5cBgZrcGU8Zb5pFla4OnB+x9aOCDGJ/J5kDB2NXDIZx7NUi8vSXeZcxLJqL/ct3+eGMA8IGFU/z7/Pc7tZNl3lo5vg9RvhqSE5lOyGWN64P6HRIKZTXtcnDK20PILghvQrU4Zv+v93DbsTcMM52r8OVoyOwySarlMqmS90GBYwJtzhIzS3Xf06JcdKdPDDz6iRblFY5JN0JGo0QOKdNbwFMUy2XUUo/hGRVCZPDeqT4T7nuD63SDdu0pioUpqUGDJ3uG70bLs/bP6JIWZZ6FTH37okTnlKx4K0aVEpX1dwnZ8i2tEskZdDxVdX8lwlLzccbzGSB0RcYorxCn9uMk5JTDRluEjnXp7HSj5DkmP6dGHH+PpfKj+VbWzv/3pvXw443NdhfLSGcuvyIz+fCBH0I8SzJb5gDKVoxhetEKF9HBAXKQUKPrKnaK/LGGnTo8/erX7lY9lxtc4TaXO7ZrLYRqa0esPhq4pUaOb8ljJrX4PUJ+RyC25YTihRnkgRL+pWpQyV6pQbY3VEutLVHzuxx692r81hhuNAYWVWbq3s+HGeKzCAZ7ACvqeu/u6UZKW5LhMglpJxj0S6XFuOsJyxLk90mV0jQlQym7XArDt6mNP9BQIFIdSKvt9TecDron2WN/vuZ2Rlx+qAziTmmR3LyRyYmp+re93s0TkcvREttMPBFWN0Jdbs+X+TCdMVx9/kkPRRPRcDIXR86y1LOrhBtmlVlcHiifORZE+Le1zdVDnI5PWyM9xzTkiUg713QIto48KMfqLrAl07sCZTzz+JHVAmH4hTOpGpnNJXBARA87JMLU9u0GtrfPSnTCu87gku0WLuDpvm4cTUu9HM1UVYMqoqkEtq0bQZ5546i4p/FFVYUS6a+He248tLpUE/WVJ7/0ZUDZncJ+/xtjDI3mUSooDQUuyFeRjLJy4IDsjrxpetUFPdzigwn60smlrLWK4ZnCu/vT9nkp4SYtx6iC25eXjW6cyot5nDEgS6aEdSlIMYWBH1DRJ9mtDFD4j2+iyJZfheurJz34kCVZYf1Sdzw7wGpVzDRAkpdYPxrCbCgmWzqmv8IQnhvGB8XKKdHd5BDL83WI6yV+6UDtocaUZ4/8BBOJxy9ElMcMAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAQAAAAEAIBgAAAKppcd4AAAABc1JHQgCuzhzpAAAXsklEQVR4Xq1ba4yc5XU+38zsfdeXXdtrbAKOY7fYoQIFKkEi4rsNgpCE8KdNI0KhhEJUCpQmqdIipUklpFb9UalRwJeUS4GGpJGqUiVplFspqcKPSgai1sW2fLfxbXftmb3MzFc95znP+73rqD9QPcSZ2W++y3vuz3nOO8W5I9NlURSG//C/Wq1m+BsvHvcP+P9uWZrVCuuWZiWO4pj5IT+m03GsjuNm1on3Gm8UF5Wl/9np4lQe63RxKl9lWZr/h/du1x9cnY/jfpZ1Oh1/KK7Fe7fT4SL9Wt6z2+1a2cXfXV90p912cfR9cfZwy28noaEA/1fUuDI8vAZZ0gurLqGuUARXh7NL6/olvF2N+vLn+vcQyBdadv0ohORi+Q8vCSUl4PlSFM+j0iCYCxfX8p6lK0DHcK7Owfc43u1AEWU6Xpw/OlPqoRAaJ0EBuTdg0TouIVyFRSELUxJ6BHTQcMFDMRJOKvRFJb3QWm6hsGyuDBnBBQ7huN7MW1xJnUoBcW43vArXSmnuFaEEvw8UgBPa7bbVG3UXo1ar+wPcjPCE8NN5oZFWYF0rXHC4vUJDsvolFMgdxD8jsOi2sHjX37tdeEe4PywVi06hkFkzWV2CxXfuQe1O8ixZH4K69bN7YGH1et2Ks4eaUrxBY3B3D+b4597gyy+sgEMjqHHMrUaX1vHwighjRAm+h1dRcFozFCJhEZ8RBgoHWUte4S4LITwi6dbQFtaL+IaAuFaeBWW6wPg+lEkPYj7AOiA8Phcn35ksIQAO4JtOp50ElDJwc0+OUgLuEcrIFZOyhCcx5k6GT7g4VZMSV2jqV9wfAiDDwFVdGcnCEoy5wC3r+aBy/ySklTY3Nxf5g0rCv0a9EWvCsbYVR//7rFcBCIgvoTFlVQnt7zV6hWe4+JyqRyTRKq7pJW4pKAOX5S7ODOjf415VMmMecCv7hyovUAlVEpRbz7Xn/Fn8G0rBNfSSPAQgE5M7knClkGL/3uNlo9HwuK/VGPNYlBJRvVZ3U+I7WVslM/9biTK/Vg+TS0elDRdmOKRYx+I9pqMaeIbv0gtcgVkSTBanF/j9owTmbt+O0FCewRqR6/DCu4f8vv88UrrgUECd5Y+lsO6L43c8LuGkLFeA+3lVRnEMC3eFREzAMxw0wLXjqHsLFOBxSSFltaSwiHkoRkkMnoSFS3HtTjvlB8W5K6UszRUgTIFcEVVBSnAF7P2P/yl7Gg1mRE98VAA+IyQ86UExcUw4YV5SzITNKwW9iDHPWHb/TklP5ShyYxLMsUIXHkHrIlYZ6/QQKapyc7q7K8oFbbtyZ+dmA0wxd+B+UA4VGKH+xk/fLJUYoIRGo4flzxMjcoJZo1Gz3t5eV47yxaVVwitFIEdHbnEPLAqhoNIl4WRxZekEiDLPUOanW1MRuG6ehY2Whhcly5ZdT4AzMzOp5Ep57SiTuDfOL177wRslBJXAcn8oo+5Wp/UHBwe8RCIneD5QVYCgdZRFOjzOTWApMriHRZQ6fdaCcJlQnJ+TgRglRCU8IUEIrFinRVniFNsQ7MLFCx62wgVMjCW9wktnm+v83nd/XMLqEBaKcMEjHFzYUERvX58NDQ4aEqYSHs5zhUVNhWLyl6ytTC8vgfY9sSl5ZcgwQdc4JgzhQnrZYwanS3cd21cgB1bt2PmJs9Zstqyvt38+Duh2DVVDIdBuz1nxj3//alQBJj5BypGRBS5oT6PHNYkFLB4dtaGhQVeQJ8WIfSgPlQLvBCulu72/AvDg+ka97u6aIz4/PyyI43Jjd/MAOx7fbrGqRGLxuPnc3Kw/RrgA9//Rz75va1etixBm/OP8i82L1tvbx3PbHZb75555uYTgjH+EQs3OnD1tgwNDNtA/YI0GrExLDw+N2KpV73fhYFXBZOEE/Y3wSJUgkk0dYRKJMMcEOTyt8gDKWptlMSytzM9+gO6OOGcD1LWZ2Vk3yH/te9v2H9xnK8avsoH+IWu1mtZsNm3qwqQtWzruIawu0XPA3/zVNzwJSgH+Xu9JiBCfoZiZ2Rk/Z+2atX4jxbtifl4HSZOkLjLwU5Q9lCbGPRasOq74TnXdQQ1rtsonkR+syRqOa6AEeRHc+zv/9HIA95qNDC2wvr5+Fxrv6gYF+WehtK8++VQJ14SVe3p6U/xDKVgAksbw4LC39Shbo6OjdsMNNwakZNLDtXgxBIj/Pf7LqADiAYD8PGyI7RkeAXU7RGpz7dnI3F1DjXf8ELyAJ7ySFcE9wl277SEEq7719l57/RevucH6+vp8jQBB+Lu3p9crHGTA+pQwiyce/aJDYY91VwISIkMCSdE7No/fhk1OTVhPo9fuvP0TNjI8EsJHs+RlD6iROcCVgVxQr7uVkSD5zvOhXOECPERxKTiNv6EAmBfCubsGknPvCe7AQyja25deecFa003r7enz69pd5Ak2criHOlEmWpAVNSvuv/eBEouCsJ4DUPbqNettoO6z3EEhuBhKwrEPXX+jrV/3wQo4RcLz6pHKIB9AFFixNqoSLgyU4LDWY8Y9RtxEBWPV0RG84Dy3elQDVYdDRw7ZD3/8fV+T4lxtrlptb/sDHapnKD51192hgLovtOoLau4yXgq9dw60GPD3M799rw0PDQdCRBjQn93NPL6RxGFtEh74nrUfodHxZykBJjdX2xuorer76QGpHfYusfSSJmrrxZefT/kA4SXYzoYsIHe0xhX4MivuuP0OcoIet8L08/kA5Ag8HK4FBa1aucbWr19v1/3G9QkZOoMUYQDBoDiBE3xGGfIePCMm6A1Mlu05fu8JLro5d9uwurwD7q7v3aLttrWmW/bt7/6DhwIbH3IFiWQJLtA5Qc8rNfc+D4mtW7eVquNe3nJCNKPCBGJgwZHhBfbRD2+0Wz68gZggEakqj2yEBI3V+OSACILLDXNwg9hP7W30+i5YxDCVwhiGMMhPBw8esNde/zdrtVqpSYKHeRJ1edA/VDygh5GHglmxccNG56JcCVp0AByBGSlFJW/J2DLr6+2zRz//BKsG20GGgYeIUo8HQFqEvguGLJU5Z21N/XsFahz3twl7cVPB19QoleZhsPfNvbZ//347fuJYauM9fBJzRNwgVOmKFzTftHETWeEgMODu+YtuK2acVNLSJeN28uRxe+rP/9pvpOSoBkmlLlWDKIPiGGAZ8gxsbObBXXWQVthsezZVAWZK5hkyPbQgFPAv33vVPx84eCCSabDPImRCIDJMYpWohGLzpi2leHKnxYK7YxPELo50mZKa2fiy5Xbq3ZP2pcf/1IaHRxIrTnQo3hB8Ai3nxyIuaYmKBtc5juhEggTaY3sbDHKUQ11LMMTQeO75Z23pkmV26PDBsLTaXyZAJWAxSiw6rDqhALothCbOr8gMwlsRiaTMFi1cbBMT5+3hzz1io4tHoxwGrxjaVNssToCsSbBA4vCDEnNcIJbHSRjAVQqo+FdeqJolAaE5271nty1bNm4nThxPISAgRgWKhyHK8KbKFV5asWXzVi+Dcl9ZXJyeeDRakgoaHBi0qQtT9nu/+/u2ZHRJ8hDdh1WAQEh5hZ+ICVyIyA1ifoUaNTSBmwOPqGRVcS96O4jRdsd27t7phpiYnAicQJZYJIpa8MrLuBrnLbZt2eYKUNauOjsyRI7mghQVsBnoH7Rm66Ldd8/nbOnYEoKlCJM87p0TjEQkNlgTGpVA3NsJDX8Ozxfd5S1v9AM5ZJYydN7u3bts0eJRm5w4H9VCswgqXUnXUWX0E1JssW3r9lJ8H05AnVeGdJY4LCV4jBsMDAza9HTL7vn0fXbF8uUOkmhBkicV2ot4D+vPy65xTL09LaJsXVUCkiQx24v85KxOYoBL+7tnv+mgbHJqMnJGRbYqv1HgQJPBP3pkb9+2gwqIISPKmxKVJzVMiaJKqN9Hmwy66Z5P3+sJEXhfVEgeOlUJZPgzHoIO12AjmxngHGR1PV8ZW2WLg03WdxwjlujYnm/usQUjC7zlVcVy3iGeqlBMSogZoYf9jm23BhKMUVFyWyMpGjxfqgS1mvX39VuzedHu/+yDrgAHL9FDVDhAswE2QJza8lXRYZHwwi016VFDlLO3EDiFT0gJMgQKeO7552wIHjA5ES022uiK2hczpQTqgCzmB8WO7VQAXl6bmbW8TIgaY7PEyRFe8ADAz/vuecC5AdJk0QV6KeXwhCVLcajJcMUHyNIpHsEIoWMMb0wJMKoGEiPxCiEyc0fXPWBocMh5QLzUfbJtJrUvL3BEmHWQxfatO5wSS2XLB/4xHb6kPwCrg5ui9k9NTtoD9z1ky8eXh844P3BlZsBJ7bHj7uABHaFhOBF4XKVSNX4uZvg5P6j+X26svAAlQAFLlyy1U++eSmM2Cs4qQiheJUNeGxVKIYAFQRF4IaZzlpfKYSODm46Njdnp06ftwfse9hCQAuk8zOR6OMtR5v6a0yeOn4rh7I4MkBKfyI+KBNUMkJyeQuKZnc/Y+LJxV0Blca6F7TUdG2EEIyqcvDLduv02VomYD7L3J4uiNpbC8Cb4jIcdO37MHnnoMYfFupbnBeujzRAhqMhS1n1Od9EBJoYopj2cAlVzQHoFur4YknTBAHExnjBLs2d2Pe2hCAVImVqrSBgSqhyGeE6K0lvs2HZb6YuO4agaGgnDvQJUoWr88uVX2ImTJ+wPHnzMPcBJiAabIp/1a0YQtBiskiMz8vixfSXt9qhG2SI9wdkBDFFQsbu0qISHQDt37bQrll9hR48djUlUoFci3vDG4CKEM7SVBQqAW4ieEr8HakwvLIjDE05XV1292vYf3G9/+NDjtmL5ypgWq5ushiM+ag9KzPtwUV/B8cuFpQy5q+q8cwABkUWIpH1AMfvD2nYBCY4usdOnT5FwiRyTY5J8bA7Ir50ixdYt28kIhQfgC47EGJvImur5cWN0fgsXLnTY+ejDf2xXrnyf1Qrwh4KtvJ49N4XWbC+1s5EHUMZ8FhCjrWq6M0e2OPhI9v9slpQnkChFp3396a/buIfAyZSnqqob7TiUHxVAW5pc4Tu23xY5CgmO8S/w4wAn4LCaJVSIRYsW2eTkpP3RI1+yK1dclQYigtHam+OgBdOXKGtkcOaC+8uYn1AUOULmgKSUGJpgsX4vMMeeOxiS7bm2Pb3zG9GhIgeQlBEVRi9mKy2lVp4NRmjzNm/10pgrLlYoKMHhhqoSY4uX2LmJs/blJ75iK694nw9PmB84dJCrK1H5VLYN9oZ12/v8GGww4WFKo9keeD6So84KR+6R9UmNc9zOMRdDALno5KkTaUaAtfq+pzra8phIo/uLfWvuUch9Wzdv9xyAF05k9uc7Hpb/rdo5NrrEzp0/a09+4Wu2csWVzhViMdxhwl0fnsCc55dAVIAPMjy22wnIiObyUujKIO1VTXCY+EiTEwBpMAIhd+3Z5es4dvyoZ3f3ZHWbQYU5sQPo3GYVUHgWmzZsKZXw1BL75KQAKxy4IPYOEgfUvQU+e+6MPfnFv7CrrrzaZwmOToMZxhSJI62OZ3E0Trg3hizt9mwCQFTIrMe6h0ZkaAEk94zY2yPcr8Tpx2PUjTIIBRw/fixBd6fnY8+Ae0HsJ+L0HbPLUAIUgEPK8sQAEIhekGdUIb2lY8vs1OmT9pU/ecpWr1pDBIhRXXu2B4rTuLvdmXOLY9oDT9AGLChC7ltZkjSXXHMWSgz3F1MscgPeMD09nUAX+IAd27fZD/71h/NaeA1T8vG8gzXNKfBpy6at7tkVs1sBnooKq3gBfAsFwAP+7Atf9RzgFSCSDSw9PdNKCRWWmpmdtpmZaU54ssoA4d2dS+YIEhg4f4azfXhiZCwoLeEJjLk9lDgkeeHF5+3mm26y13/+8zR9opBd9068ALpI/tb9WlWcYvNGKEAbE0sfImLRuFAoihYOyrtWs0ULFtuZc2fskYceR1T537hhs4WxVK+7NfrzC80LHrsQCOUzsbuO+gIIxR5e7SIR/udckCMzekW1RlLcur60F196yVauXGlHjx4JElWbrdifUHG0vc8GY0znIb/xo2CFq0GIGh6v+T2YFwrgEOYiByxasMia003bvGGLDQ8PuaJQl9El+gxQm6DTlpmuJ8X+/v4UUsIE8DKNwxC32K+EVhve4MmqzX2LUCo2PPiUWtvifJLUtZ/87Cees6ampqjkjJqPOHIFipzFPRHeXk43bthcUvtVGKgrY3Kjc7OcsMlZu/oau/7aD9ndd/7WL8yKqdJsqiy7Z2pFrV2W3ZGisItmtSsxLLKa3Wxm+y9cnLwO/owHg05rzTQNcc7cgFzBSTSGm1NTkzYyMuIehcVKWfiMvUpoxT3b1+ueCw4cfMcOHz5sZ8+dS9ZOvT862/AgykAFKZyKDbdsTHtYOQ3OtsOGFeQN+X47IjwkzAosCTXiIZgiQ6C8Oal6cu7w9FFYNEQYzcNL/Fjm/uwuaQR4CjkKXMuSizXMd3Oy22nCFLPBnN+svKSw4paPbPB9gjA0XKKvv8+1K2XoQi1+YGCAg4nACN4IhRuTqupYf98AZ3BF4Rb2OWGGz9Wmwq1lKYSHmGeEAOb7UIhHbswVkChVmvN5IvcoseGSEnFfjfiRlDXhdq7BgV9s/bvqqqudE3QBnbrXMASx/6ubnqTd1CnFh1xRnlyynWEKqQpWVw0LPU7MUQDXyDUsg9qBXz1RDA+ZMXagZH+IX2RQlVF9X53LmYAr9/2rVnM0Fq6vdz1uHsmZ8Xr5eZxmsekQ+aHxt+5zqRK0OAgv2K02WPdWD8+Vcvqcx6/PGWS8zBChRp8CexXJtu8p9pNyPrB6jZfBfBqUW0rokN3hfI+g4qrt8P59+iUIS5hejGUmoNzielbuUeol+C6Kkl4iK1IANkSqVJd+TmuOm6T1iX7HatasXuN9by4crAcIy7jld1QQSQltfPj3V99+6OK0vTwybOX0eZttLUh4xj52x/ppxXeix7QpUhaJvfsQRpbRpKgyiASsdpUrbLTXpxq6xO8XMgInTYUyDcs7XZlrPrDWc0BO3KPOahcXrvvbp561G9fduHS6bdPtlnVnxqzbbFq31crIvuwBCxdaDQqQldJkNxoUJURdok5T0FXuKYsqAcszsFi3evwuQSHsxlG8JNejl+SerLG5H7/m19b5DyZu3XSnffmxrz1mRe2VWt2mWmdstjNu5cmTxp70PbyggI9/7NppPZQ7Orhxyr0iPAm31Lgt5YSYgl/6OAkxXxkRlspNMb8UXhHcrXSRe3Go6ppfX1f+9J/fXvvujB36vyz6HmT3U10Bd147jVJa7QyL35hlIzApQLvCJVyisyM3qf8XeesJFWUuWvZq57oqQkV7J+/wH2xEkk5bDUor1l2zvvzRy28NH5kzFt3L8IIC7vrkde4BxN6xmTr9DhEj6kiQ2Q+l8uRLd86qilNasb0tQtSFix6FygumM2OwpdxLk63uX6xf98HyW6+82Xe5rI9FjY1Z/eN3Xt+q1zg09YeLGc4YYi6fGSLKR1gpUrxmBKpAWRJNZTvDKjhG2ptzjRzb6DRPthqbAfd8/v7Hy88++Je9l8Hw6RZQwF2fuLGlpIVQSAxMlvFxgeKVrS9BmKzln4PCSsdYZzOuklUqhUmGR0CC5uGUEFPwDA78zh0oV71zxkCoX7YXFHD3Xb/ZqjZFVZlNcwPfGxi7N6rkSLAjip7YofqRpZe9mFmmXaax6hhBxlyg+oGGhrtSrFeggIa+qlNvlcOHWkb65TK9xset8alP3tQU+tOkthqXwYjav8Opk7uu6jdLQupEuSxhFW2AIm1PL4rPwrwJbBGziKVWWUW7LkhX7NtX9k1M+C8//98vWB5z1oGmXX3779z8S8Sij7gdxrIEQgkS9lKraGg6v5/PklsIRrZIGyL5LnQputzzQfwqNfSZZxveCaH0xhtlNQJ6jyq4YcCKg4NWG23Y4FzTlt3xmY/8EkKx/InSJolSNTUUyNvksEQcYSrM4LPGcgkdBtGpZbqHRTznWV7llPcTeg2BU9UJv3qvCkCJGxqyeqNpK771nT37Xvj27sSvVX05LULIOR+FaVF8vPB9henpzoH0MoPkzZULGL9HSNOeyBeeW7JEmj/HKwBa/2jN8d3/AiYe4y8CE9W+AAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAACDJJREFUWEdtV1tvXFcV/vaec85c7bE9M77Ud5umaZyQGEj6EPHOA/yBqqWhKKLiVoQoggekCvEAD0CBF/KAMChVlapSQknUFoKI6rZKHMXEl9okTkR8IYnvdm3PjGfm7I3W2nvPjEVPsrXnnDmZb61vfetbO2Lx/kMdiUQgIxFEZASRiISUEUhJu4QUEsLtQigAGhpCa0itNfiq39xn2rWmv+D37E6fFT1X9J2CuP/veQ6A16cEIITgIFyAdM+YDGDwXRB8WxeAAbZBKAusFYMrpaCUhpiduKsjHgXg2SBqDDCYEKA/vufB83xmhe7B62AA9YERuMues7YZ087gIQUQQvxrbFITuGdZoEwd/QTkaA6CKKJBlIMUVBbLhHmnjgVLg6G4RncVmDMPEYYKYRhCfHjtuvY8yp4yJHACEGYBXC+64rE4YrF4lQXigdgx9Lvd1LuavaXZ0G2WAw7DCiqVCsR7l69yAG6ZAGwpuYSKM0wmUkgmEvCDgLVSz4ILoF5sTLkDtZRTxrQImFa5UoZ4642LBwKIeB5kVWi1bIiBRCKJWCzGwXJ38HsuWpu9MqxVwS3VDE7AYQXlMgVQRqlcgvjD70cOBMDlIAAWGxAqxUoOghjisRiXwfdJjLZUNoCa6Iy6Dd0m47ASMnClbLIul2mVUCqVIH75i9e4DbkErAOz2BukrLY5CZAWiZEZoACJBdd5Gkbp1Vpbupnych14CSUKoER7CeInP3615gPOD3j3EGEQEqREEAScOS36zphUrR1dq5kWOwjuKKesTfZlwwRp4OVvf1+z0Uhh26/OBS3NBOT5fpUlNiV2yIPqp9ozONFv6+3EZoRXZvG50rAPnP3aN7RrJ7Yc14LStaLZTUnqLdo8d+ZH3VJrNVt7ZsICqrD6PevF/kPxwnMv6lrv1vtrzemYaKt644507wKwhlN1OsUMOC1QUMaQSMymaZy98288/+wL1rKNernv/99o6y2/9kN2MnECVPtP260xuR8w5abZIo2fPP/sGR5VB1kA19d4oTOlg+8YGt0zkyUPGS6FScTsdiBxUkZnrpxs62eee7FuiJEc6CVbc/Z9Mw/ox0PycO7pkMXGNWenrAEy5ZYN+uymIWdCWrIBuOEnvn7mrHb1JFpoKPmBj2iUej7gaOki9e7v76NYLKJY3GcTcYqu1rnO8x0b7hxg8E325DfcSREJ8dLZb2oG9jxEowHiiQQaGlJIp9NoampCMpnkDPP5PLa2trCxsYGNjU3sfLKDYrGAUqnMbeXazwXjpqGZZUZVRD+Bm/OH2cV3v/U9TZnGE3Gkm9Jobc2hu7sb/f196OntLQB6UkAQDQMrq6stszOzmJmZweLiIjY3t1DIUxAlLg2ViOpuaDfnAaMiY2YUAJ0ryOrN4ceD+OEPfqRTqSQymQx6+3px7LPHKIBJrdU1AA+klLu2KQKlkBUCX7o5NvbM9es3sLCwgK2tbRQLBZRLpt+rwnOta73FUU+gvmdMjRn46as/05lMC/oH+nHq1Ek0t2QuSInrAFYAFOlIUNeVgVKqSwj5ypXLV9rGx8fx6NEj7HyyW9UEtbu5BDw2LnvU8zwEnrPzoDpzxGu/+o3u7unG8PAJ9PX3/00IvAPgIYACDUMLTlOJfpr2FIBn7t27//KVy5cxN3ePNVEsFHngMO1Et6BjHAH5CPyAhxgNs1g0buYKs+BDjPzxz/rpp5/CyVOn1oTGOUjMAtgBULapUP19e09BRAH0VsqVX4+MjGBycgqrK6vY28ujUglZb2Q2DpgA47EEn6gSiZTZ4wlEozEWpHj7L3/VJ09+Ae3t7W9B4J8Ali31LvsYgABA3jJCwfRorX87MvInTNyewMryCgdAQqTTEdEe+JRtDIl4EqlkAxpSjWhMpdHY0Mj38XiCWRGjox/o06dP72utfiel/BjAFoBSXe0JnMRMz+iKQuHQzu7Ozy+8+Samp6axtrqGfL6ASjlkt/MiPtOdiKcYLN3YhJamDDItOWRbcsg0Z/kZBSHGb43rE8MnFoQWr0PiLoBtAPs2AKOm2kXlSAL4/IMH86+QBu7emcP6+gYbVFhR1O1cXzo5pRINSDc0MXBbrgOd7V3o7uyjIIjlKWgsi1u3xvXw8PCmEDgPYBrARl0J3IGbgiABUv2zWuPLYzdufOX990cx/2Ae29vb2C+WuAW5/pEASaI+1ciZt+Xa0dPZh8G+Q8hl2j6GUNeg5R0NrIqPPvxID39umJR5QUp5E8BjW+8KQigYJyZwKkWTUup4oVD4zrvvvIupqWk8fryMvR1qwzJ3QESaPif6OfvmLDo7ejDY9xkcfvLoHrR6Q2h5AxL/0SHWxdW/X9VHjhxBR0fHTWj8AxLzdV3gutoDkFYKQ1LgpdHRUX9iYhILC4vY2txEgVswZPejAEiAJL6mxmZkW1o5+8NPDqGzo/umVuoihLyNMpYQYFtcunRJDw4O4ujQ0VBDX9Ra3yEhSilJdKYTFBKQOASNr46NjfkzM7NsxWtr69jb3UNpv8T/4SD/J6eL0gk6muAActk29Hb1Y+jwcWSbc1cE8HYITFcUHmuJXXH+/Ou6q6sTAwMD6O7qpv6fhMAalDUiCcr+iWKx+EXq+bm5OTz870Osr6+zA5L4KHszhKgEpgUTsSQaG9JozZr6Hz18nMR4CRoXKxrTEljxSsiLc+fO6Ww2h7bWVuRaczwFySzIq+miozM53dLSEpYWl7CyvMxDaHd3l6k3g8icB8kDaN77fhTxaBwNqTQyzTl0P9GLoaeOoa218z0hcAEKtyshlr0o8v8DvCdEAfmL8b0AAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAIAAAACAIBgAAAHN6evQAAAABc1JHQgCuzhzpAAAICklEQVRYR21XW2xcVxVd5z7m5bflR/xIUoJCUid1jNQSR44DDXJDa7sJbVqE1AqqfpRKCIGEEB8IEH/8IIGExAd88MEXAgofQJJ+GBelsVoU3KiRH23sGCexYzt2PWN7HnfOQWufc8fjNDO+utczc89ee+211z5XffDeTeN5Hj59KCh+rjwoT8FT/F+Bb/7xpY1GFEUwRiORSCAIAihlvzTGyKG1htEaZa3lmke5XIbWZZTLGuo/Vz8QAL5fBaL6WsApKBWfXXQC0BrFUhHlciQAwjAUwAKAbwfgUYEJgod6d+x9Y4P7FoTvwfd8OT+SFZchQzCDQiGPUlQSADx4D1mqBmAztpnLwewjB2Ds0r+N5zO4D1+YsNcWCAH5VUDIhC0BsytHEXbyOygUC0gmkp8qQ5z5nuACIkLEcxRB/f2tKyYOynNQDUCuq9hhdsKAkZqWSiVsb2+jUMwjKQwkRQdch78TkLoM7TK3QXcBUD/qj3/4i/H9wAYObPbxIgxu2bDsCL0e04fQXiwWkc/viA5iDYRBgCAIBYBlwFIdB4/KkYCw5wjqd7/5vWHAgCAc+kCA2ExiULYctiuIgAuWSkUUCoUKAIIQwJ7HGlnlx8Ed5TH1lRL84ue/NERM5H4FiAMQ7C1JLEpLrxVVsVRCqVhEIunaMBaga72K8AgkinaFGFkdqB/98CeG7RMGoVDH7MmGzdyxEJfCaWC3160PUAthIpTspf+1EY8Q9ZfpAU79cRe4M0ukvv2t74gGpHYhAdhyPCq4aICGFJuNtCIzKwl4lontV63+XR1Um5C9Jlj1jVdeM6yrNSMrQMuAy56eEAvQBY8BUAtciFTyPhoWBcrsHzahGJR8boxoRAB87eLXjVy4xQWImJLzg4cBVKzYtqO1XC1GJgCcDQsIijC2YxeQAOOXxHzh/EXDBSwq+9VeB7QtaK3YuhwELE8uIIz9zvW+9X7rfrK2tkBlbZktzuR4z4XRF4zQI4jFQCXILggCiK3Zl6H0cEmIiQvb+lu1S587CyagmGVr+c53aFjnR75qATi0BMpMxILVrjVTF7EhVTun9Lxjg9myI+gPNCoBEkUVUTIxGzz2nGAvALLAMtDtdnVgf1xtVtK2iRCJMBSx2mmpJBjnQj6flyFFpySguP+JlOtWr6WeH75gGNjObdaJgvScKfHH1qRCen2YQDKVRCadRk1tjRyZTAaJRCiTcWdnB7lsFtlcFrnclp0TDojsG7SR+gsDrtPU6PB5KUFsHmRAOoFBeTDbMIFUKol0OoP6+jq0tLago7MD3V1d6OruQlNTkwRbXFyU497de1hZWcH6+jpyuRzyO5YNgqR6Zep6bmiNPPf8XgCuC4iQwenvqVRKMm1obEBXVxd6e5/AwOkBlupPymAKwCaAlAaOKGD4xo0bDZOTk7g9fxurq2sVECyHFaPzHc+HGn52tEqErlVIUxBYypNJZGoyaGhoQGdnB/o+34ezXz47Ywx+63m4CyC/29lIAmg1Bl+anpq+cPXqu7g9P4+1tQfY2tpCsUAWyqAW7BbPg3ru3Ihh67BXRYQxA0EgMz6VTqO+vh5tba04+vhRjIwMo7au9qee590EsC2isbvE+EwQncaYN8b/9c7x69ev487iXWxsbEgp7B7SdRo94StDz5rqDaMVoRLxJZMJ1NTUoKm5GY89dhCDZwbR39//V6XwZwAPoigqBUHA4JzRRE8QPoA6AE+urKx+/8rly5iemsHy/fvYym1JVzBP3iQMDJ09Zyq7Fl2WGlGEQRhI7evq6tDW1oaeYz24+OKLFOCPAXwIYMcFDQCEAIoAIgcmQRZg8M3x8fGT1yYm8L+FBWysf4JCoSgdp+Cc9ekzZ41sDhicX4gJeSK+tKOfiu/rO4FXX3mV0L8HYA5AwWWcAlADIBtFUcExQlCNAAY+/vjWm29fuYKZ2Vmsrqxie2tbygBjHVUNnBq0GqA6K/X3pe8zmbSIr6OzE30nTuCll1+mk/3A8/CRY4CUM3vWnWIsOT0QQAM0nlq6v/TdS5cuY2pqCsvLy8huZp0YbbKq/wunZBryJQ7oRjIZIID6+gZ0dOzDsePHMDo6yp7/GYAbALZcCaScVRqgHgiqGRpfXFhceG1sbAwzM7MWwCeb2MnnEZVo0Qbq5FP9El2oj/cEYVBVgjq0tbfj6JEjGHpmCAcOHPgVgAnX+6y53B9FEfeWqlwue77vsyz7AJy/+eHNc9cmruHWrTms3F9BNrspjlksluyDCQEIFXz8ok87Buj11EBtbS1aW1tw6NAhnB48jd7e3r8ppf4JYMXRzsaOpzyzJ/0ZrfVnlPJen5i49tnJ/05iYWFB/CCXy1YAyLacJYgfu6wF22HBQZNMpaQNm5ub0N3djRN9fXhmaKisjf6153l0wAdOjNZdbHDqoVFr/USxUHxz/J1xqT/teX1jQ1qRw0qsmQBOnRwwnGbxjK9sy8LAumCG/l+PtvY2YYHd0Nvbu6a1fsuBWHUtyOzTWmuqf7+nvKdnP5o9zuzn5+dlNmxubsrMyOcLMrKpA+mCysOnexyLxy+32vSC2toaNDY1YV97Ow4ePIjDnzuMnp4eMvUPClJrveF5XhIarfBwCAZP3rl7p2V6ehpzc3NYWlrCxvqGzASpf2F3TKvBgTN7S+D2ggTBYUQW0hmrhaamRrS0tKCjowP79+8XRlrbWu/B4DYUamBweG1tLUW1Ly0vSWAKj1Mxm7W1J/2lIjctdp/wfzsfBqUF0WzbAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAACO5JREFUWEd1V2mPHFcVPe9VVVd1d/U2i2fJrHaIgxOTyA5yHMcYExMRgVgUzG4hIpZ8IgSUCEtAPsR8RCT5AwQFCQSK/IVFRIkRIBEhL5lxHOOZsSfYHs+MZ+uZ6emluqreQ/e+6m7bQMvlru7pqnvuuefee0ocffKoFkJASAFLWrAsCcuidxu2Te8WpJTtg3+bHLjjpemz1tBaQykNpRWUUtBKQWkNaPB9nJSDdDqDUqkI8aUvflkLYf5AwWzbhkOH4/C57diwLbsN5FYAdB3A/0HT3ekfBWcACiqOEcUx4jjmc/qbkBKpVAq+76Onpwfi2FePMQMEgDKmwPQD13X5oHMDxrAhhGwzYAB0XpxkknUcK0RRhDAM0QxDRGGIWCm+lu5ZKBQwMDAA8dQ3nmLmiH7HsTloOp1GJkNHhqnyPBcpx4Fl26YUFJnKwAR0UBjqDe1RGCFoBmg0GqjX62g0AgZDr5TrolgsYnhkGOLp7zzN7EnLUJNJe/D9HIrFAkrFIgrFInI5H57nMROWJAboSOgnLAkJlAkFj6OYg1erVWxsbGJ9fQOVyibq9QazQHFKXSWMjY5BfO+7z2i6SFoW3KQ2XV0l9PX1YXh4CMPDw+jb1kuZ3wSwBQ1KIzZhKSSHV5CJCJSwILQLiN5KpVKYm7uB63PXsbi4hI3NDWbBcVIolUoYGxuDOP7D45q+JFqJ6ny+gP7+PuzYsR179+yhsvwGQryHOC7DkiE0FBQ0JKfdSr71nYDi7y1YIgctxgH1mUtT08MzM5extLTELFApqQSjBODEiyc01Ynax/Vcpp2yfvCBD2FkZOR1QP0WSlwDUGeFmbSN8G9nv6VGAkW96sZS9VpaHqk1Gt8/c/oMrl2fw9bWFncCiXBkZATilZdf1pXNCrcLlYDoHx8fw8P79iGTzbwoIf8EO74JqCZqWiGTxKm1gXTaIAOBGguTAFDvlgDshxQ/PnP23MCVK1dYEyRWP5fD0NAQxKu/eFWvrq6iGQQsMgKwfft2HHz0EdLF84j1m4iiZSgVIqs1q4Be/h1TaCv57PsCqArUBA2VAizxYWjx/OS75++bnp7BWnmd5wJ1GulMnDx5Ui8uLKC6VeVOoBIwgIMHoIX4gYz1W3CiFSAm8WlUtEbujuCtjxWgAiCXy0nUagkA7IWQz01OvvvA1NQ0VlfX0AybcGwHhWIB4tSpU/rqv69iY2MdWmnkC3lsHx/DowcOQDr2c5IYcKJlBlDR6r+DExoKm7zolErgSxtNYgAPQcvj5yYmdk1dmsbK6irPBurjdNqDOHvmrJ6ensbKyjLCMIKfzWB0dASP7N+PTM7/kYz1HxFFS4jjED7R7wOVSkuIt1ORywnqVBZhTRIDRVjiYUCcePvtfw5Oz8xgZWWVBxO1PnWDmLo0pS9cuICFhQU0GnV4rofBwQE8tHcPhoeGXoHGr+HEC6ipJjJaowqN7P8pQRVAllqTR6WNplWCLY8EQfNnf/vr3zE7+z7WymXUanUe06zVy5cv6/OT5zE3N4datcoLqLu7Czt33oP9+/b9C0L/FEpcgtbUhnG7Dd07QATtz9QBEinhIpZDGvrrM9OXP//OxCTmb8xzF9QbdWabulpMvDOhL168iPn5eR6d1MS+n+VFcd+uXdi9e/es0ur3kGJBQjfMFLxtFtyKhC6XgEgphS4pxP4bN+Y/OjF5HteuXsPaWpnnQCMIeFfEKoZ4489v6NnZWSwvL6NWq/Huplmdz+fR29uDuwYH0d/fz7vB89LMEC2k/+ULaBsqFaMZNLFZ2cLS0jKX9ubNJZTL6yZ4vcF7gkpA7Shee+1XemF+HuVymf9IqGgz0ljOZLLMhp/Nct8SMNt22LQQyy0gnYEIqGQNB0HAtSZWt6o11Gs1Vn8QNBGGTYQtAC/9/CW9srKCrcoW6CLa41IKzjTlpJByjTdgX2AbXyDlLS6JN6NhhOczs0BeIDZeIGii2Wxy4GYzMN4gCg0AEuILP3lBszBqNb6ALqaMaO0ah+SwTyBAxqbZzBBtT/oNg2mzYYCwMVGaVy9RTWaEAnLmdE4g4gTAs888q6u1msk+itjLkdXoeESL+9UmMGzNjD1jMPxOQOwEkGGHrqdBwSDiyDgjAkKZMxjDArfit775bR0kboUNJPk2XmainWUrKAFoM5Gc21biHak8CUBihEdBIkoSmwERcjnCKGEiCiG+9pVj7AfoRxTcLFnB/sC44STLJGM2qhaVhQI7rBPHJt+YHCTSRCNUSrpnB0CrBLcAOPrkFzS7Vs7e6Nm0WMeKsxaS7FgTrAsTPJVy4aY8uCkSqgc3AUKsMROJTeOax8ak0hGEAYtSfPbTn2NL1s6+Rb8kFkhs0jwvcOZk2Sl4qh3cS3k8Hzw3zQY27abhuh6zYmaGESlRa0QZ8hxgoxrUIT75xKc4dsvgGAYki5AA8IMKl8HUn25MLZlyyLZ7SHtpZNJZZDM+smmf3zMEhMFk+DfUxgSc+CUtUODK1iYf4hOPP5EAuJ1+sk2E3AAwwZmBJHu6MWXdCp7388jniyjmS3wU8kU+/EyOtsR1CCxrTbYOEgJdAD5QXl9Ni48/9niyWln77RFr/L80nZBooCU6k72LtJehAMjnCigWutDbvQ3bevrQ1zuAfK5ILvoCtHofwCKkXKddSpoUgCu06tUCO8Vjh490APDDhpkBreHSop9K0BIfCc5108ims8j5eQ5OgYcGRzE+soOAndbAOakxq4FFrVEWQEUBDUsiol2tFDLCQp84fOhjrP2O+k0HtLrATMSkBNwBZjRTfbOZLNPc292H4cFR7Lx7F0rF7n8Irf6iIaeVxk2tsS4lqhbQiAWaKkJMz680PlSMrDh08LBuPWJx+7W7oFMCM/EIhGk9Iz5Df1exC4P9Q7h7/F7ce8/9iwB+qWOchsA8gA0ZoRZpBJ6DSHmIVcQPzZpybERwxEcOHNLmOa9T/9aqbQ8hdlcdAOSa0l4WJLye7m0YuWsM93/wQQxsG/wDIH4XCbznxFgLU6gHdTSzHuKI9lxgHltUCC0dCMuF/A/LHk+Q0NwfkAAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAgAAAAIAgGAAAAc3p69AAAAAFzUkdCAK7OHOkAAATDSURBVFhHjVdtbxNNDLT3Ln3+/x9DCFRVlNI2NG1DKQ98p7dGM7Z39y4RItH18qLU4/F47NXLd9dWSpGpTFKmuJdJplKk4DPeh0uLKN7jrira7ipiUgV//cqHmomKSDEz8atKrX7Xq/efDYFawGkd3D93MAhWikZwAMnXKubBHQCeAwARIQhVmTJwBZBqop8+fCEDDiIybiCCBQb2K0HwHgxEYPzPyuAaAJwLxdNEVEUmAxO1kgn8QK8/3hmznDx4A3GuBAEkqQcAEc3MHcCZEhCESGEZeLeC7Ang5nIfGhhBbOo/1N1ZcOpFkZgsZABPVkIqouFFPIiSl0kRlUnABAFU0durr0MJgupgA0GaADfiw3fmwZcQX8veQoTqtcfDGegAIEiKUu8/HQJAF1sXXtY8vqPiXXya1JszgMwb/SHCICEZ6AAABCyAgf3nx96Gm3ZbCy9aD8FBv2fuwU0WBf2uATwcAnA6CtSeLFCICUBM9eHmecNAZ8JLoF39kX0Iz2sfIMbsowQImPT3ErgYXQdmqofb4xrAWPcwnGw/iq9AxLKw/giurfdXHYDaUwMOAkGzEyZqIVpSH+++nTJwVnzN9VL5C6hv5uNspPZZAL7xFmxtOHYCS/J0/3K+BFvzoekgJ03aXf1KDaz7PxUQJcj6M/jQCWBBn/cJYOP7g+k0B4TSeuuts0frry045ehzYGQhNEAGjl+//7UEzXJhQN7Wi3rbnfT/OIQGI+r199rTDdOWNwByEPWJhy4YJp7bbm8/lmAYQOMQYgfEJByNyLvAAghKMOUcSAdMP2juF/V382ntF7bLkROtty0CBZjjOOqfbUg31MPds+3mnczzLAlkbb+D73vmWfsE4wBMjDMgJ0C34NYFYUDNB6iBx/ujXewAYEcAI4g2dIR9/4bg6r2PFnzb0J+Up/l0ExqmYfQ/jUhEZn15fB0Y6CyoKjJl0LBdBITwfovwegsfYK7wKKlSKu5QPPiBFfsegNpReFH/WUR2BgA/jr8M9M+RPRhQLfg5gncA/T0++52MNPOhwk3V8GNUg8tCAxGiIwAVIQARudD/j79sCgBYSnI1WwFwupORN8n3sOSQHXwqMtfqr8dHegHUnwAuAMIBQP0RPDWginZdBWXtGytrG2aw6mbjeW/2QlAy1H8nFgy8Pv8kAGS+7YIYu1kGZJ4gshXpAbmADNMvXTCbAhpATaCDGbWPEvyn359+mK/k3YTGNbzN/hTjdgrGFrwBkQCyDG0pTfVThGazvhxerZ0Hpr75bLfg1Q7QvSBX8Bh8J+t4AzAspmw/sFCXRfT44MMoDyajCbUFNBbRYGM0oO0O4C3Z94BxIaEGvBus1FplWaro094Xkn8D4JbMsezj/mQM+ybWFpG+EQ8nIwTPSw+3T1GC06NYO/kMJ6ABQADJjh86j4Jw/VGh/oeLQx7PGoD9zUMbRs5ETMI8//HeM++TEYEzwU3Xx1sGzkGxCu5nAoDQu+s4mIyTMJeRzPwcA+E8tLqWvL9g9tGA/UCK7EFEdSaiDHpzdbti4PQk3A+gSf+6DF3oIw+r7AEpStHOhQSAs+Gln44z8GkJAgAXk7iYtdt9r3x4XWYeLLBPSX/MbKs8FXORrFX+AKjG5aOnFa7PAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAABWRJREFUWEd9Vz1vHVUQnbv7Ph3b2I6j4CD710DsYGTFUhQFE2McgYQoEA0FEhUFoqRAVDSIhgYaCoREA6IBGtLAX/H72L3onJm5O/tscHy171kv75yZOXNmbvr7+T+5qmqpqkrquhJ/XaUkqcL7Svg6VZIqPJPwX0oifG0/eI+f7I/M1znna6fNrbRtlrZtJf3153MSqGsnoc9yDBjvCR4P4PlbaDg+kPHbAwdwBjAJtNI2raTff/sjE7yupe4R8egRechEJGIEyCL+ABzJCNEj4uzABt60jaRffv6VBOp6wCzo6UqhrxH9DSQKAaA7CY1cM4Bo7QnQcJqmEZz04w8/5QFAB0qAr3sZCbqgBrQUVao0/V57zwBL7+nXWue2leYGcBL47tvvM8AH9UAGA8sEn3ZYlo4EhAhw1wIV0AV/HTwbeINnw7ovm6U0y0aWy6Wkr7/6JhMYJP6LCLrESqFd0RdkCZ4d4ClXletBulumPIKTwBeff5l7wIFIPeiXZLUzvCVD9lV4rvTGwQHcaNTNkpHzLJaSPv3kMyUQDwQJcNNFLIeTiO1Y2t9FZ5EzakQPMETvwOGZPvrwYy2BaUBBVQ/QBYj0CKAU9AYrg4Vf2s7BITxTOgncQIIifP+9D6wNjQQ7IoJDoF1ndGUwN7T2o/JD6hn5Stobpr/TAX3gnct3jQCsuO8HsT09Cz0d0I7VfrXnO4fT1CuJUneqX8uBv7fIwOX52xltRgBzQpqSpV4F2hFDN+BznAs2E9zxXPXoeQARnICIfCGLhT7x3j+bLp4+yx1wv+7qDSZIJ2UkowgjAYIz9Vr3BYFx5jJfLEiA0eugkHTxxrOggY6AC9BJxI7QiemuyO8pPh/7HcDz+UzPYk4iHr1Prf8nAGu29lS39KnpExMCSGSAiHTCac8jUoDOZlcyI4m5gjcN9eKzI715dskMMGLrALahzQc8Y2sWMdqY9i+C34MASgAgRAvwq9kVM4BSAFxTrzOExwkUEbonBALuC2Vi2niGF/gS4l3gqkfETgD1RwtiMAG9DDR4yfnrb6kGSgcE41npgM6QohHpJIptiPQj7bPZTGbzK4oR2dF1KZVlB99HAtrbOvWuEwl7Aj5nm1PZkFaMSEuwkMUcqteDrGAZYdtimnL90wGYnj65yLBWkjAC3XakH4wr26oR+T7gVkwdUIhoOW1FTENkiL5luyd0NRqNJJ09PtcMBBIEDFkpi2pZzXxBxTzotiH1AxMjvMDmPxzSt1UEiTkzGo9kbTqV9OTRWe7WrbCM+g7gxG4E9y3Zv35l/eIS2uqIlkzvgMMi8unaVDY3NyQ9On2ck2hEvmisbsWsd1jP1YTUA7yddBfpVnBuwJYRqjQJszoYDWU6ncjGxobcvr0j6eT4If9v3Pf52sZtuROsruS2hzmReClway5/ww4J8GEt4/FY1tdvyfbOtuzt7Uk6uv+q3SDIwsh6ZPq3PjkNp7eMxguKLmXecbrAmupHo6FMphPZRPS7u3JwsC/p/suHNEbdpe2SUbZdXTj7t6HwGV/FV64F8YrgBKD6IdOP2m/KnTsgcCDp8JWjrN4c/JlRA9iXT1+/Q2YMPHZBtxuGDJjxoJ1BYDKZUHzIwP7+vqSjwwd2k+hSG8FdcP0d0Ffxm0LXTFpCy92BAhwOZTIey631ddnZ2ZF7L92TdPzguJtNvHBolO50q0+vfdFAvJgYqtXUpp7qCN/rLbi2tiYvbG3Ji3fvSjp57aTrggDuzugGFdu0XEivXUxvuBGbIIsWkIXJmG24u7sr6fThafbVqvR/sWTMhs6coia6q3ksg/uAX0ztahZJ1DCioSALW9vb8i9gvLcUKCDqKwAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAgAAAAIAgGAAAAc3p69AAAAAFzUkdCAK7OHOkAAAeuSURBVFhHbVdLbFxJFT31vv1xtx13bE8+/mXDhg1sRyDECrEC8Us0I7IYAcpICPERIFiMZgUbJJDYsUBiBQt2iN0sQOIb4Qx2xhmc8SQhbbvtbvfrbr/+vG+he6uqX7ex41K9tKW+p84959x64vzlSFrCgmUJiOlOzwL0DwJSAhKgR/qFkJCQ0qwcucwhc8l7npuVTZ+znJ4zZFmGjP7Ou/q7OHs2kMKyoECoRcUVIK4H3vQPFedfBkDF9U5fPAWgvpyLZGrn4lk6fVYgcoijg3NpWfa0uAHBO7FA1WcR0OkvM2BOzQCokN6nhVXx1IDgXS1xuHcsHduGZduwLRs27TYxoUBxK3gpCrgXmn6mfo52feqZwimdmoqnevH/NaA0g9j7xwfScRzwsmm3+dm2aZmWEJD5NnAL5mifL64KZ7pwgiRNkCQJUlozgMRf39mRruNyUdd14boefM/jZwWkYGJWB1MNaPrnhEaFdRFVOEYURYjiCEmcIKXPmJEE4o+/f0eqYi4814Xn+yiXyqiUK/B8T4GwbAgSJZuA2jDjACO2qcrVqYl2OnGcxJhMJhiOhhiPRwyAQHFLshTiN7/6LTMwPb3vo1pZwGJ9EdVqFZ6nQBg9GCUQA7Oqn1W66TedfBJNcBFeoNcLMBwOESeJcgO3J4P42U9+Ien0RD2B8D0fC9UFNBrX0VhuMBP0OYmUXDHbBvY8iVD72iidqKUVxzGf/LzbQbvTxjAMNQCyp3bBD777YxahYUEBqGFlZRU3b9zC0uISfN+famFOB5cAFMJTgqPT9wd9tFonaHfOFANxrO2oQIivv/FAktCUA4gBD9XqAtZW1rC5uY3VlVWUy5VLbSiSkH3PQjTWUnaj3o/HY3S752geN9EhBkZDJUJqQarSULx+76scRAzCceC5BKCKleur2N66g1s3b3NLrtLBbPQqDdAXK3EZ+tvtMzSbTXS6HYxGI/7chBAH0Ve+eI8ZIBCUAQSgUqmyBrY3t3H71gZqtZrSgQ4mZYUihgsGChaoUDgMcXraQvOoiW63ixG5gHKAXaJnwZe/cJcBqEUMuChXKmhca2BzYwvrt68GUMyCYvgwC6nKgDiOEIYhWqctHB0doRt0uSUEwLiAInvKABWnSHY9j5V/7doyNtcJwDpqtToDIwZ0FHAEGyuqoaN6SgCSTDtAA6AWBL1gBoCZjBnEvS+9Jjl2KYKJAc9j0S0TAM1AfaYFRRAVo5cLXxYhMTAM0Wq1WANXAeBx/Prd+7oFZEVHM1DGMrVgcxsb3II6a0CNZzUNSfXFjFe0F0MnQUQaIAZaJ6yBIJhnwIxrcf+1N3gakgU5jj0XlXIVy8sNbG1sYWN9UwNwGIC6A+Rz4zXNjLWUBSlqKffnAHS7GE8mWgPmspJBfO3+AxVEZh54Pmug0WhgixhY30J9oQbbcfguNOt36rUaLGo3zzwDNIATckHz5ZQB44Dpjeib3/jO3Cwo+WVUyAXEAAPYRG2hxlFMxem0PN2SCHES8YmSNObPzMilZwagNWBcQENJuaC4rokffvstSenneyWOXAWAWmBcsEHzYaRvg5UonmA8GWESjUHPVIiAUPIVIGLWAGX/6dkpjk+Or9QAtVL89K2fS6Kc+k7qp0lIybe0dA03XrlJIXQmBPpSwLMEluMkql0MBxiNwykQBSLmxW1gBtQg6px32AlGhPR3dWVTWhK//uXv5GJ9CYu1JdBery2iXqujVCr3hMAhBE4hkEKgagnczmX2kXb3DL1BF+FwwCCICb5s6DYoEAn7nuzXbrcxGPRZhKQBuqgSABK0+PMfduTa9VewtnIjl8AugOcS+akFKwAwkMAEyGFZqMGy7gD4ZPu8tX3U+i86QXsKYjyhlFM6UIJMGRRNQJqIZhLSrKDoNlc6ERzKAAJ/Enn+OBdWU0oEQiC0JMZ5hlhayCh8LIESgA0h8Jl+2Lv7+P138fL4Obq9cwxHFyAAVDBNqQ1qIJmpSNcxHsMkQH2FM+8VIniavZ0La9/KcQKJvu1ikseIMwdpniKTGXJUADuFYwErEPiEsPD23//1l6X/fPAeWmfHGIR9jMZDnv/EAjmFbzzmBqyHz+XiFGoieCo/lWY4oVMnFuLyGGleVS87WYzcXECcEmwAi0Li4xD43t7+o1d39x8xC71+gHAUYjIZKTdQCzLqdfEGZHpevFGpUBfBE7k1BC7KDpJkhCxPILM1yDRVrwD04zgQ/gC2EKi5JXxUSrx5cPjkczu7/8SL5jNuQzi84EunyQbDglF7UZi+li40GsDgiWxMckRRH1l6QxWdLW4AlAewbRd1DeDB0w/f//zO7kO8aH6IbqABsCMiDiZOPD0v6L3RTE8ur6orBs6fynpURRpFyC8XNsWJgdIQjuVgyZL4GCx868nB40/v7u/gRfM5AhZiiNFkiDgiAHo2UBu0369mABBn78mFqM43qf+jnQGcQPiLsH3ASxysCguvWgI/erT38M7+wR6OW00E/S4DoEygUCIA5oaspqa2Hb1N6XcKRYCEaP1bVpPl4vR0WrwEbA/CKcOyPVjjFG7VxwIybEmRfzaO4+8/fPdvOHx2gNNOC/1Bj11AViQNcA5oB7AQ+fVdgzAAGAzwPxy4tYF6RUHTAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAsdJREFUOE9FU0trE1EU/s6588iria2JD5Rq6oNKFQOu/AWu3bnyX4igooK4E9GF4M6NFqTia1GxKhU3vpBCpYpW26atWmzURpvaZGbOkXsTdeDM4d653+N8w6XJN9Ma+D48W8aH53nwjAcmhn1U7avdVRQi4ipJBEmcgMZejGvgB47A9zwY48PvkDEToLYAUXUEf4FxHMMWjY480SAIHMiYtnoQhAiDEMYYEMipi1XvqEZxjCiKEEUt0NDgzf8EHfuWIBWm3DgEbhNYcJIgjmK0ohaiVst1unTxsjrLFuxG8GBHsiTWDRH9s+5sRxFaTj1qj3Dm1FllY2CYwWzAzJ1RDIjZZaD6N7TYubA5iIoLmY4dPaEWREyd5C3ABiZIbOL2cCd1u28DdSJs4Hk+6OTx0+oHPsKwbdt+tPYajYar1d9Nt7YkNg8L9D17NnBB0/lzF3RNdwGlUgnFYhGZTBqNxgrm5+dRnZlFbbHm1pIomAxCP0QqlUY6lXGdhq7f0HJfGXv27IYf+I9V9QsR9TQaKwdGH41iYuINvtW+I4kEYZBGNp1DPldALtuFbDYHGns1pnsrlV8KGQQwycy/RSRkcGVqevrwwweP8GnuMyQGujIFFHvWYX1pI4o9JeS7CqClH3UtFPI3ReUZM9cAJAB8EdnaXG2euH3rLqrTc2D1UOregHLvduzc1o9MOjcOYIpEtK4qg8z8FkAdgP0/IQQ7lxvLR+4N38fnuQWEJoPeTX2oDOyz4CGIPFXmBVLRRVG5w+D3YEegIlIgov3VmdmDz5++xI9aHdlUHjvKu9C/Y/cEErlCzOOaoGYJ7H0bhso7MP8UEQNgCxMfevH8pf9xcgory03ksz3o7xtA76byiAquETCBGN+pvrSk+XxhBtAPCiwTqAuqlWp1du3HD1P4urCIVjNBPtPtHGzesGVEgauI8VoItT9jkISSQyYojQAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAQAAAAEAgGAAAAH/P/YQAAAAFzUkdCAK7OHOkAAALNSURBVDhPTZJNb1NHFIafmfsVx9c4QQRbsMNSArhYsEhhhRQpbBs2lCTQiKqtkFigLir1B8ACiV/AhgVIrFix6IYFBCEokULFxyqY5Log4SYmxopDkvsxU80Y087VkWYW88x5n3PF4pMX2nVdTDmug+OYkgghAI3WGiElUghzIssy0jS1lSQJYv7+E+0ZgOfiuR6u14MYgNaKTGV2L6VEA1mWkia9y3ESI+7d/UN7nsd/1evEvJgpRZomFmCgtoM0+3o5iWPEzRu3LMD/H8TEkVKgtAGkXzvon83r/RLXrly3DvoduCaGddFrWSmF1WH2Jn+WkaSJjWF8iN9+/V2b16R0rEjjwzHlOLaL/uoLzIzALLNgrTTi4s+XtJHVz2lEer7fi+T7thOzjLw4jonjxO61BmG+H+d+0oaGwE4hGBggzOcpFosUh4rkcjk7jW63S6fTYWNjg+3tHRvHIubOXbAA6UgGggF2FXdRKpWoVA4wdnCMcrlMHO/QiBq8qdd5/+497Xab7a1tlIlwfmZOm3wmfxiGlMslqt9UOXVqksF8eFtCQ6ECIcTx5bfLJ589WyBaifj0qUO8EyNmp89rY9n3A4Z3D1GpVJiYmGDs4OgdKeVjYBOQKEoIphcWFo4+f/4XHz402exuIqa/n9XmL8sN5ti7d4Rqtcrp01PkBvNXpeQNEH+ZRIji2+bqP788mp9nZXmFdruDOHtmRpu5h2GeUrlMrXaE76am8Dz3KlAHdr4A8kBta2vr8sMHD1laWqLV+tgD+IFHoVCw8g4fPsTk5KSReUNK+RLoWt1QRKljm58/X3j69E/q9Tpray3EzNlzOgh8CoWQPSMj1v74+Dijo6OLaB4gWbVjhj1SiBOra2snX796RaPxNx9bLcQPs3PaDwIbYXj3MPv37zOXqdVqDA0VF5XWSxLMn1YGTkRRlI+iiGazyfr6Ov8CTw1UAW+/2pQAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAEAAAABAIBgAAAB/z/2EAAAABc1JHQgCuzhzpAAAC/0lEQVQ4T02TzWtcZRTGf+e933PnK5mvpKmTIra0pYWii7pw4UJX4kJwIQiKiCiif4D6F7iQLlxJddGV2OJG3EoFC2ILIYqhGtxYapPYDLmTmcy9M3fue+ROSvGFszzPeZ7feY98efWqBr5PtVqlXq9Tq1WpRBGe7+M4DgKoKvN5wXQ2JU0zZnmO67q0223k2xs3NIoiWq0WJ1ZX6PV6eJ6zg5oEo1MQxeIiGoOsJckwOEgSrCqdTgf58eZNjSsV+v0n6Hbbv6HcsiL3DToB5hw/AxJaa7si5pIgLxyORtQbjUzubm1pFIWs9/v/WrVfGeE2avZRnQH2kYAg4iGyZEUvivKyiDyLmIcy2N9XxwiNev0WVq8Bm3g2IdO8jP9YIBSX3NQw5jzoK4h5CaQQtXY+zTIn8L0fQK9R6Ca+HTKxpX2lspAQUnFwnBoO58B5LZ/PXy2BlgK76WTSi4Lgd4x+QcHPePaA1OZE/3NA6cCpY3gazLs7O3uXk+FwITDe292Na9UqlUr4Neh3qLmPlhugeAxRJECkB7yYTrL37v7xJ0kyRPYf7uu9e3+j1nJybY1up7OF6AYqAwtTc8zBsSI1o5xNJ9Pnt7f/Yndvj/H4CLlz+47uPHhAlmVEYUiz2VxUHFcJ/ADX9TCYxUeaHKUMh4ckySGj0Yg0TZHr31zXwWDANJtixBAEAVEYEYYRUVh5VDGhH+EYD7XKbJYvmo8mY+TKZ1d0NBqT5zmC4LkeQRASRzG1aoOlRovOco92q8dSYxnX8Y8UzDyfRcnwAPn4o0+0nG4Li4jB9/zF1LK5s9xlbXWdp06doVFb2lRlA7U7KiZXtbHBnJIP3v9Qi/kxbMe4BH5IXKmx3GyxttLn3OkLnFxd/0Ut34thG2VghZmxlHCW5e233tEylzEGz/EX2evVJt12jyf7p7n8zHMlxE8t/CQF/+SGsecwlylSOETyxutvqmAWp+t7IZUopllfYqV7gvNnLnLh7KVfgc+1YEMNg5mSVYrjG8nmuP8BY4tRwf7Dt4AAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAEAAAABAIBgAAAB/z/2EAAAABc1JHQgCuzhzpAAABx0lEQVQ4T3WT224TQRBEq+e2/v//QkIokkExMXEINvADiXdmClXPeOMXVhrtU5+q6os9fPrKnAtyysg5+z+ljBgjYkgIIcBMzwASXa93tNZQa4XtPx/ohXfFKSWkqOLogGDBa6GPDG0CBLHHh6MDpDrUR3H0F6VOEFWlAIyEaLH1hirA0/50B0jT/iiOIUpzZUeDQSB9kUBi78EBz4+v3JQ3B7KelLtO9cZRLkyEIZFMHuHl+3kAcvIIsp6iABLCymG/TXUjEABkENkBr8fLBNzn9+xNgOmgC0A5ACKIBKBsgFKKT0GNlLpcALiyY4W5+pgAELyJcjAAZr9+XLgsC267oCnAbEXHOwyr7G/5ZV89IDINpfee7HL644BSFuTks1fmNwJvcgHA7Uu9E8Hg9uVg13tf7PLyl0sRYNtAZVfxOzgAXk/PH6geAAXErvVW7Hz6TVf3TdQeaHxBLq6g90DbexvhaCKQCezW6xX283im1D92YSyR1tinMCKMLZxTYGesrWJdV9jz4WXcwlwi38AJGIck0fHRD0lPhzSP6bB/+g8g+CHBzMNTe6AsJFq7v8Yv3+YtjPwfDsYV3hwogwM6sV1jrfgHQR8XLdOjX2oAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAEAAAABAIBgAAAB/z/2EAAAABc1JHQgCuzhzpAAACD0lEQVQ4T32TzW4TQRCEq+dnd21iGyQrJs4l+ICfDRQSHCJBDijKFRHEC3BAPAAXxJUD4sQF8Tbs/DSqGa9jLlgaWdrd+bqqult+/fyt3js45+Gcg7MOxhpYYyHGQERQfgqoZuSsSDkhpYQYI+T7tx/a+Abe+3IIsdaWY+QOoAByJiAjxYQQI2IMkC+fv2rTNGgaAipogJg9BaqKnDLitnIIATzy8cMnbQuggee/b+BoiVb2AEU6L6dYLoY+oA895N2b98qqRQUVFCV+l4XAlADSTnqtHEJfIPL66lopecjgHxvGACKo8mto9E4A/dOOXJxdqrUEDJBtoM6XIEsDVO+ks3oMSCmW5/Ls6XNly3xRUS0MXSGAbWTyrE7Pff+nwHjZWgM5fXKu1hhUFdX/fwGhZ0NhnUPXtVUBqxDC5B0hZaiqBb5jNUqm9KwJzlmMxmNMpxPI+elGixdQRR2g3USWNtYuZNUyicYIulGH+w9mOFwsIJuzC00pl7D4cbVjYQyPgeEob8eZLFo8mBxgsTjEyaMTyIvNpTKgqkLKpQrg5e0oF4aUHWnbFrPZFMvjY6zXjyGvXl5pirEoGC7vAHuTyJXiclHBZDrBcrnEer2G3FzfKL0N3jmRNYOqYpBPhTx81nYd5vM5VqsV5PbtrbKfbdNiNOrQdR24G9wH5sDKwybSKveBdsbje3h4dIS/0BwF5rvPEXsAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAEAAAABAIBgAAAB/z/2EAAAABc1JHQgCuzhzpAAAC2klEQVQ4TzWTPY8bVRiFnzt3bI/H9mySJd5ElKlAVKnpyA/gH4BIqvwFJCSEQEJEdNCloqCjQnTQ0CC0iqIk2oSsNyK7689dz5fH8z1z0b1mq5nmPe9zznmvmE18ZdsdbFsipcQSFkKAApRqadqGpmmo64q6rqnqkrIsKauSqioRk2fnqtvt0ul06dg20pYIrXAloIeb2gjoobIsyIucoigoygJx+OcL5fQc+o5Dz3HodrpYckfRtjuCq+GiyMnyjCxLSbOMPM8Qv/3yu3L7LoPBkNFohP7vdDqGQlvQ23fYBWmWkiQJ8SYyXy0mHv/4k3JdF2/ksX9jn2vXruM4DtKyaFE0dW3Q8yJju03wA5/1+pJ4E5PnOeLbr75XfaeP5+1xMD5gPD5gOBiYLJRShsD4zjOiOGK1WrK8WBLH/wt8+fk3qtdz8DzPCNy+dZvRyDOt7CxUJiztO4xC5vM5y+WC6Irg6y++MwTav96uBYbDIZYUJkBdlcbX/oPAZzafslgsdgRFjvjh0WM1GAzY8/YY3xwbkb7bp20b8jIjy1OyfEuSbIz/6WzKYqkFIlOl+PXnP5QO7sb1fW6+M8bp9xZC0AiLd4N4TRj7xJuQOInx/bUR0BZ0iEZgfpRqC68QHCnFTAhSYbWeJa0Pqrb4cDo/5dJfEcYBfrA22y8uVmySjblIEUzUo1bxypKshGKLQinYs2zuCsmD12+Obp3N/sUPLwmiwFAEoU+aplRVhQhP1EctrKyGbWNRCYFoa1wpeU9Y6uE/b47uvTx+zvJyThgFJNuNuQfdjK5YhMfqTiFJnIyqdWnFBlF16csud6Tis8np60+fPPub6eKMMPLZZolJX5+3bkksJmrck5RtbYJXdg9ZF7haQCg+eXt+cv/w6V+czU8JozXb9Gp7Ze5EnL9U+26XWr8+/ZKzEtsVeK3kfYG6f/L2+OOnLw6ZLc4INEGaUFa5wW9Vy39iq/2dscTx/AAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAIAAAACAgGAAAAxA++iwAAAAFzUkdCAK7OHOkAAADbSURBVChTJY89SwNBFADn3d5mNzk0GMQIhwj2Fnb+ZcHPlGkEI9iogYCFEg5OtLTSO3K6u0+i1RQzzcji/kmd9zjrMCYHBI1KjIkQInI9vVHnHD3ryHOLkKHpP1hTzk4u1VqLyQwiGSRBFYwYrO0hF6dX2u/7P9k0Lc1ni8GyUQzZGo6Q+cNcy7JkUBS8vb5TLWssnnK8T7m7p7JqV+q8uwU+UuS4eq7Hm24bnw8mSWUhmtILqo+QdSly2H3Fo9iYWQica2IpGsIMkXr9pzE7+GnZ+W64Cx1TVapfIzBnroQuH4IAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAACAAAAAgIBgAAAMQPvosAAAABc1JHQgCuzhzpAAAA8UlEQVQoUzXKMUvDUBSA0e/6+hJp1QxNIpa6BCqI1rGp4M/wLzkUleIgFEEUxNVBBwcXNwVHTQUHcchWtBDMkJT2ioLzOfJw/6TWsVhbwRgDAqozJpMJRVkiN1e3aq3FcexfEIHZfygK5HRwrr/gug6O62LMHNPplLIsKIoSOez11VQMnucRhgHVWpU8zxl/jfnOc6S3t68LizVaay06cQfPW/ocjUb1l+eENE2R/sGRhssB3e2YKIruUN4RNtI03RkOX5HB8Yk2VxvE3Rjfr1+j+oFIA2U3SRLk4uxSG80V2lubBIH/iOobMA+0syxb/wEPTl9qbsqDDQAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAIAAAACAgGAAAAxA++iwAAAAFzUkdCAK7OHOkAAADTSURBVChTLcpPK0RhGMbh3/OYIcOYOZTY6ExIFFufVCk7FsraSvEBlD9TpsmkxOw0pMzqnPd9biXX+jLl9CHpSWiE9Om4Ai26sYY3uqZIl2T1sRiCvgBBoxOm0vHSlNMJRJ+wAdL3XzBbwrQDMweWczp19IzskYjJfygC33f80JTzEGkS0h34u4sqRFuVlyFt2/htrMhB0SlozbZfcuY2VbxGHbXhy3Z9dSPCWOmustXb+4mKowjuTUwFLTs/u9D83AIb6z02y90H1RxHMDBnmkTzF491eKo7RQUOAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAALBJREFUKFM9z9tOwzAQhOHZ2I7tdd7/qZAQAgUErVQO7xAfOyhp1ftP/87K69M7NSpCUPjZwxoLQNB7R6kF8vFyoqoiBsV8ByRuoBTIeb1QNT2AMYYkpbeOXDLk8vnLpAtijHuBICqJaYzhcs6Q79Mfl7Rg32Gta8AB7BjDb9u2F36Y0q2wj4TIAGlqbTjA13q+fxHg3IxpmnC9Eq01HCfenlcGHzB7D2ftA/Q+UGvFPzQGZbxxblmcAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAAMZJREFUKFM9jzFKBEEQRV9VV09rO7guKwPqoQUVDQxkQTTcZDFVMRFvsWDgCYQZZ7qkRzD4FHwer/jy/vbhKSVqzCIqQnFnGieGnwHZbp7+gRgjqkopzjiOf8Dd7dotGLGJxGpQxauhlPnKxfmVe3GCBswM1QACZoG9/YRcX9740A/UNoQwx6LRtgesjlfIw/2j930PDlYBM1JqOFouOT07QV6fX7z+amKcl1SDhkDOma7rkM/dztu2ZbE4nIAv8BE0AxmR718PGEf6tU599wAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAIAAAACAgGAAAAxA++iwAAAAFzUkdCAK7OHOkAAADmSURBVChTJcqxTsJQGIDR779tQ6HF18DE6ODo5svoC7j6Zq6NcSAGEyOQ0lANCCJtb0uLUOg10eFsR6LXuXFbLRzHAYHDoeZnt6Wsyj8yeByajufhui5KCft6T1kW6FyTFxoJHvrG93x838eyFNtdRaZTvtcrsixFBkFoTrpd2p02x6YmzROWX5/MF7P/kE3NAIiUcBSbs1W6OA2jER+zmFQnSBKaW4ElgkI1F7aj7p+eAzV9D8k3GlmH5kqEQjU4jaJn2dy9vPUvJ/GITZUjycScN4raOtBWNj0RczOOh9dRPKaoNL9asXv2BwYdwgAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAEAAAABAgGAAAAqfGefgAAAAFzUkdCAK7OHOkAAABPSURBVBhXAUQAu/8B0MvU/wUFBQAFAgYACQcMAAHLyM3/BAIGAA4JEQAWExv9Ae/s7/8NChD8+fQA1P33ANQB//z+vP77AeX79gDr+vYA60MkHz9bkZBIAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAAXNSR0IArs4c6QAAAE9JREFUGFcBRAC7/wHIw8z/BgYFAAECAQD5+fkAAbu2vv8KDAkABwcGAPf3+AABx8PK/xkbFgAUFBQA8PDwAAHt6PD/EhQO5gAA/tkAAQERhQMaEwQwPTwAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAABAAAAAQIBgAAAKnxnn4AAAABc1JHQgCuzhzpAAAASUlEQVQYVwXBoRGAQAwEwEtweBRV0wAtfAlfAzPMIJAoNO5zybFrSe6QHgB088UUscH9QmqUptUU1Yp2JPEWMRs/3THQFThTiB8LdCic8D9v3gAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAEAAAABAgGAAAAqfGefgAAAAFzUkdCAK7OHOkAAABJSURBVBhXBcFRCoAgEAXAt6wbFWV6/zv5IwYh1CXWr8xthkq6bN88RCaMb4BqeSweEewEqgqq523BBzA7tNZAORVb5hXMjLd3/J4gGoiF/LhiAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAAXNSR0IArs4c6QAAAEhJREFUGFcFwbkNgDAQRcG3YvE6Mf1XgoRISBAdcDRAC1ji+MzYPC3yxnFvwcCGflS9KhFBKQU71l36RIpE5IzpvTfECfYA3Q8YDxcfbYRVSAAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAEAAAABAgGAAAAqfGefgAAAAFzUkdCAK7OHOkAAABPSURBVBhXAUQAu/8B6d7y//8A/QDz9PEA8PLvAAHz5P/iAQIADOns5hHk6eEAAfHf/ZAAAgIHAQQAXdvg1QsB8eP/bAH//ggBBQI9/wH5Ti4hItmGpWftAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAABtJREFUGFdjvHjmyn8VOe3XjH++/t/x+xvDYwBjRQtHH6KlsgAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAACAAAAAggGAAAAcrYNJAAAAAFzUkdCAK7OHOkAAAAbSURBVBhXY7x45vL//wz/GRj/fP//iZn13w8AaWkLUokwHaMAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAAgAAAAIIBgAAAHK2DSQAAAABc1JHQgCuzhzpAAAAG0lEQVQYV2P8/+fPun+/GJ8w/v78v//fH4YPAHnTDOvI5WBVAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAABtJREFUGFdjvHn53n82FjYGxmsXbv5nYWFlAABOEQcnSF6KnwAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAACAAAAAggGAAAAcrYNJAAAAAFzUkdCAK7OHOkAAAAbSURBVBhXYzx64Ph/NnZ2Bsb/v/9eY2BkYAUATMUHNZsudrQAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAAgAAAAIIBgAAAHK2DSQAAAABc1JHQgCuzhzpAAAAG0lEQVQYV2P88uz/g9cfnsszfnn+dzkzK5MEAHOdCj6wMvHQAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdj+P7m/1EACWgDqKg+vB0AAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAAQAAAAEIBgAAAB8VxIkAAAABc1JHQgCuzhzpAAAADUlEQVQYV2O4c/PufwAIuQOSmzFxBgAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAABAAAAAQgGAAAAHxXEiQAAAAFzUkdCAK7OHOkAAAANSURBVBhXY/j95W8HAAlPA3XvQ+ThAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjuHXl/n8ACKYDja9TRVYAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAAQAAAAEIBgAAAB8VxIkAAAABc1JHQgCuzhzpAAAADUlEQVQYV2P48eX7fwAJrgPjRM1GkAAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAABAAAAAQgGAAAAHxXEiQAAAAFzUkdCAK7OHOkAAAANSURBVBhXY/j85P91AAlSA66YTxG1AAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAABYtJREFUWEdlV01vG1cMJLnS//8tPfTSU0891LVTfzQumqIBGhRBgaBFUCCxtLtkMUPy7UqWI2u9kj3D4Qz5oo93z6EqovgmKrwW3sB33qt/eX31GJ9VFVMTVZPJTMwmPie+mpj2K97Lz/HzD3dvg9AEbLAdARJr6EsC/Tt8xR8soGnagyfwVAQGsJlIyKoPt78EAfhHCqzVyDd2dReBUmkQIDAq34Cn6VAKlBokOFXlGhGyiMiq9z89DQINdk3kQoE9eMteFaLyyQ5i9TrkB7FSSERXKfCAAj/fPEYqfyl7C5+ilAqtxq7flLd6japBoIlcEwiRGVWTQMgqKq5vbh7ogdem27ejSFSboFBWlCbjE+DTQQ4ksSnBz6k5wavyIrGGgMCPD1Rg1Lm/LsdvCSmnU3IbUhO0wS9UmKAdgOYImRXVpwJ4BalV39zcxz5ee8/viQ2nVy8vqz6y8iaSrSD4EiFnERoO14sWsIQ4SGwteJXwvpHp2EetJSboAeBHORxKBXrgQHAROaNySQXoeoCWAsEW3N8+IhJXj74xrDiGR4NT8sNBjgRPBdoHJraEyEkKHL0PqBDCvieJcBUNfbjLGOLBiws2OZy6+s55gx27+lKCEdQBDunbeCCwMnapAEikAk/3byORQSCKxbX826DJ3qfkXX0a8AhwgLxAegk5t/MLuOWH+UACqKHPj79m4VX9Jn7vhqvIFRj73h6wAyYcJH6JkFNVjt4v4bKIwvmxRqgrKtdwCUW1ob89v9sKH/LnUhJB5XqxWAbwdEwl0nBnR+U7cEfsGLdYRJSyU/KUHr7jl/7x7n3g1iZDD6VaMCN2W9ZBoqYefvErq87nPDKfWYfpkPvRdxcJI2JC6p/vP+SP43EVO26xnHZdfcbMELEXcTkNx4NAxMx57wWerqfhqu9lthp+Hz983KHXeYB7Hb2vVYpsV75NJ1T24i4vGnKKiJOEwu3MenhUz9VdxC3CQzQFBxPQ2Jf76e9P48Y+cj3rt3l/QN++ttHCabZzeJwDQweDxpH3NFtHDXmvSXsZd+iCFnz+5/N2HmDm+2Axlk24J7CHnLLqihmq9sp6DhlI72H87hRddAt3TSE0JLUO0S//fYmLUbvtbVQEMBoM4GW0HK/d71Bkf/GIVUIpuQhyljmnA/bzDVnI1YseqS6nOfgTzmmiXtUhw2fIDALhXCg5XEJmRMwIWuMV1ddyyXCl7IGmFQFgpeY4BXDNZcdjdvxxGAt5xcZCdQACIKrmNaXGUvFA1PDZzekQG1vO3UMMQoeEEY/4sKNYHj1z+fMJd4LAv0lAMa8p7SCQKpzFM98g6R6zFbhXzx09X4BS4GKXycZbBDbKznnEQ5YZCPzF9Wgyi5MEpXaPs4hCakrOfHOl6hrui4jBZjnf2WtPGOFp93X1Xbkjk+y2ioPA4r/XUWkJ5BmVZs9nCZJg1YhaAW8nGvdcr47KAZvSj7y19E64lH7rvwWMEbM/df/p7AZPIik7eg6RU/LVTFZffKX0BKf8OevqMXrvlqf3Ak93YiWYhTgJ3KLKnuOlwCwesxiqh+y+SFhWHrJ6+CphGHTZ9wTO6A3X1x0azqpyV4wATBjnXkoP/FDntTRgkekzHI9SgZ5n9ei9u8MzBU6di8Te+ZUBN2XVQ4UEhinJLGb/nglwnlo7CTxAsjVcKk2AVa8BA6J67DVGr8zHy50HoMmFAtjLcIOBvoajBWf/jiY0kAjkPIHNUHESsK6eWed6Tcdt8udhNxWANjsz8BS2DSDIv/lA4+TfErxPLwA1X8St9jn7z5PsmHaO8jv3PXKTAJZAH2XYHJoP1s9BBAOCAH2QKYhvcsCU5JSb1Y//ROBMl+DOZUMDkwOSdElgv2o5GQhcrUAi0ALMBEsC/wMt6mbTUGIgcQAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAgAAAAIAgGAAAAc3p69AAAAAFzUkdCAK7OHOkAAARVSURBVFhHjVddbxQxDIxz////8MQTD/0Q116vhYoKVQgQIFHRFgnUqpcgjz2Os+1JVFol3d2LxzNjJyub44suUkopUkT00qkUu7UY7bX9f72Xjqe9dExs7LiPic11ime9yOnROQBocAu4D4SDZPgMJAK/EHxPYA2uSOTkaNsZdIAgIPDiWTuwvfkza8sO2QKPZ42pzQcTCuDwrJPqAICYzohnimfpj/860/4kBX0heA4cEqwPz3rWO4MwX9AfHoOEJDCmu2ebPeDaww/BxPABJFgfKAP6hgXLmTPryH4KrsgidJgP7E8mzIakBMmE64PNWIVmRAFYVXgxmP2X2ScMdD8BvARk3PO3yYApZzenrIORbMbw5BABWVsFmBL/ORaXILuW5jIvjMD0yVSF7kvWfDYpQWRAoz+McpWTw21vvXnZDDWsCEYjGlKYKY2uZV9iI4qimCbDrIMtALD6bNGdpsXZHR1BFCPBzXhGqWQ6klknljSH06OLrsGVBYBg2+RSuQw96GROGjWb1H+TsAVjEy4FsDl+ZwBaAuGdLJhmm3ZPxH6R94pn+8dsXAMzpAsvbd9edgu+A4jBQguwYUgvTZboGEfZsnUve8jSxGRHLtYfYMLWdpAhS+HtInqCLlord00ba63T87GbLrto3ku8vygrl5uPYGDXdsgeTExe6CBOPDADjlEXTiD0PXbVqZmNvSTvK3J1/qkj+wUDKE2rCysKKZZtlVKlYm5s+Oj3l/LMvSSDcF9ev//aqf/I3r2wAEDKNbABsIugbMyMsLMOOeZ+Uop8vvphHui70lMltJKaEzYrZUCKeOarCYCDoUmzL1J7jxNWqkX5dn2DMtT6DyDYzbQxUQaTAFfKPoOYmFhUi2X98llOfn65T52QVaDKW2csAKEr6LmFzncJVkMGyKFmDBl8N42Omfp27vh33//y2FAK27EGx91kRDKgC4IFKau6Mh8okDDjoiwNfgo52gvy+nPzxCNEuJ7b82Chx8Yj1ZuOSzF5QWCWnV+kb+z1Q3tUNpR5uO2PPJEXKdUeaMDMgCVhTYYl6Ya0oE9+MbhSZ/Q9z55mCAC/HEB8GiDWqlQFpM1OrwCJgxw2Cw2mQXRUAIvg3kief0hYgvwCebjrX7n96rvstIkVlH8C4HTYUbMI3LozQNLsfw0OZqyNhgtG4CRBu+JmU/myCWHnEY4mfQV6fe7fPolq1m0rpTn9+mKLk7vVAaKI+gtWfrjtW9HFkDoCG2rNWYdxWAaAruUYByGujSBKSQO/tVL7pfuH/k1fVRPe9WMR/S020q7Z0WwuDYxvIigL+IwwHR2kGoLHwzAeukvcN9XJq3cWAHi8728UvHcq16zbgpBCsBHi91riuib/Vw/GKSNqLDt/PwMsw8f7/trN4l/JhaNJ7X7wbP3bhSxoeFCJnkIIi8wBgrIFE9EHfrdX2nPBZo3gkMLiqzpuR98ODMwzEP59NdXdXgYI5B8W0ukvit6GagAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAgAAAAIAgGAAAAc3p69AAAAAFzUkdCAK7OHOkAAAUpSURBVFhHdVcJkhtHDCPp//9lfaRyOv5TErvinR4yBYB9SN5slVbSjCSCIAiyPcf44mZpZllm93yN930t3azKCu/LzQ3P+Hf+4WZY3ywz9+AH8Ul82PueXu5rXmN8MbP7/wBMIPhOWmZ44NsEkGYVz0hwHWgIyAVCf/O1ngXQAeDPZwBldbs5GdDvZYYFgj48TgCZE8yOebKyAYSnpYVtAJ8tDNfuWYJnAJ1UIvdnMAKBoAXif+ADbKg0CEhIzBz1FgM5PiM4WVhADgbcMitZomYBv9lg+ItkBSAmI7sEonECSNxo6gVGJfjjEJ+A6O4C1Azc0SXZpQEQP8siBoDwOfBiYLJBugQAwQiiGWgQdxIMs7/DgqBwTUCkEcZC/Sf7qz/WFWfmTX1rgcGtDgAz6PNzmo0QKwg+BKYFWiiPynB2g7KX2FZgQVXg+fCIxcAMXGbDO1gHRtAhIK4SVZcJwZFH0iR27gzerUf7OGhP2ArfA/NDCRgYwQACj2DGTgALRNmdAKDMDxGKA4ZblD+IDioFMI8OnplLhCt4B7rCfGTWFbEBWNlA9gAAHbTWugvCEgWRBXXLNd0ILAtlcIAwMrFLMMxilOXlFsOyrjS7Ipj5RQbKRjaAo1PQ5SyBnHwGF/0QX0RA2up9BAYUMpBuKQC/I7hZXnquy5JBrwy7UIbU+xGsfaxWFQPku9jtXXjVGJZ1ik41Z+bvAGoxkL9V2eXOLC+rYnALE5BoAAVNxJ2Wo40LfnowcJignGi6nxPIYqIZaCa8rvy1aVbgCQAMoAwWI8EO6Ef2mWzFc0gtBhAWzfoukCnNYtWdbBz0QwsOEV75CwKX2au/GXxrwFI+8CYASPNJgEnbRa0nAxMAgUWWAPxsZq/K3sUCHikGpA2J8Kj/IwNoSkt2/DYg1LsBsAMkPOkC9YC1pnt+z58c9TYHzVdWvlILDD7FeQDA4ArYc6TdnHXdAYcPSGxzB3DzFiABdAc0IAD45OFXZr6aRetgZg4AEGFeURLgnAnUQNvwnoIow+kBzQAB2VI/mnPqwfN7fZwa2PRDdDt72nADQOZt0RjT3QUMfLbB7oIlPniAmIADqitYgvpAAIuB9oPSswZQDqvuf+4OKSsOmFCvHMuI2oyOEqxu8EcXBAue/9Z7Alh1R0eIgaLqc1jEbfdqvy3AYv2188xh1PN5rlx78rUTHjZ8AKhX+L47gy7l11I+ggenYGbeNFf6HryRfgscXYYewmsctxvWj66oLvhWL7vdQm7Y048AaDyB7Qgs3PAPgWj6xQKD5ywD+1FmRAbWGjZngrwBc8LHt3pR3+dlgUE0Xc9IfTX12o7mGMZAe9yUsw4haib3/ve0DfVI7nnhPr4CQMGEaLmwXpmOMseqVpXDLZCP6g8BaremBgLZ4yqk8DCSeynhYNI2/LgRmfv1NV8cs39SnzbC2fub+rK7ss1He+PyAESUDzD644kp52b0tBWxLL2UXn/Xe0w+KX46nvbArKl8LaRF4yEQBNIY1ikJjnDuBO0Ji/65K2lCdnCuZATQK9gGgJEbt3nXHdmjhTMbRJQqomWE++DSwFum1BsyAj9tyH79Ux961RqFnaAn3swe1jtXsD64JJiAA+k4NLugl5LuiL0gzk3xPBmJGRxYAeBjBx3qe5wR5HzVZwIOnuJpCAXvRQRXSHwfTKjI1sAbLBytiW2c65qb+/e/6pO2X+x8bblYvQLCQ9s1/TqAtPjmFDwPq9l6aFOiOfZ86LZU3vtwip/7DzD202ASUpssAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA51JREFUWEd9VwF26jAMS7r7X+xvgxUGHeMuzX+2ZUdOw3hjhdLGsiTbaV3fb63gVUu1T1X+5HMtVT5XOS56XOpSlsXfb/j+1s/JdfI73SNr2Rq+pp6xOJePewCw2A4Cn+RGWoBBCKgjGAluYB20B58CuX4KAARF+vptwoKcTJkhUwERYACqB18OCTgQobdeT1uz8B1E0DPIYJKMb6fbMtbsRwnk3Hivf/8+/agElrVDwTE0cx+4dgDhOiaZuldey+AS1VJvZwFAHHhQxaMOJPQdiLORDAzZktmUFWdtwsTt/GiWOGXPC01M2B3dhWMnh5EPknUAAqqINPevhzKQJEBQy16yJsrYAyRbaaU0+xdHsxYxmABhzfv6m0yo2f2h7WhCl0COrUn0Jn/6WQFRZfnaKaFt/TUGIIMz0S9m1x+ZGAFoYHoHI8RyWntbn+GBCO6A0Ey6icbmkst3DN72XTkwZoIMdFgktl2eIUGw4DoPmi0LuRn+8NJV6hFMgex72Uc2iK6olJ/L0/oA1fyx4QzNRoCoT7iDQvcUdC9tbwZEtYArRHSXXAGMbReLW98n2qPD8WCxtIRl9b9mj6AKZk+esMvInAbAK5em36xkBgDG2gRAa2XfsxnDH8yEMD9lgMcmRrA6d7FxnEcrAQDVEuwAAOxYmfYSHQCwF/LQ4cAybGy4cBV4xhMvTIJ7ZQQA7obW/frA0caBCsgMOGBvPKbvoRwVAH5zn8AHdbtIJ8TuxOfBIAF3vwQgzIta5zKE2bL21qb9nPInAIzIIwgvtQygV4VXDzvb9OVsc+beslWC0krd1odWQYCIAQIZqCQPm5G0k0KzA7WWaQ8eswLn3Yj1LgCIAQaS5zqZklo1zwJrCKgKnozejuOIgSUM3L9+goHMwmRnzGyEZHkeoB11XC7JCxD1JgDwSntDMhi36eQLyHVgIZ2AFN6w0p6hlfp93vqekJ4LEhs8rh3YMIx6S8jzwTVBp7Z2HSYtAsCfC8YbDXLeXuGMD5JhD5GYnCw3A1Gvp/xgMqezw0iblxEId0ar6lcejclYL5/90SyuTs9KtEYMLd/rzcY48fAnCNuk1PXj+xguarkvNmbjk7Bv3XtbjinJgAcuLGgr9evj2veOOBnjeiRQ7hr3jun5gZ8l+EEnlRn1ilLq+f1CAICLOXkph7dv7CGwf4i9BVVJGppDUvX8b/XNDHY0dAU1EZATzuLZETKkBxoCaMUzff0HoSooXRgUZWAAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAIAAAACAIBgAAAHN6evQAAAABc1JHQgCuzhzpAAAELElEQVRYR41XaWsUQRCtav//j/KDxmg28SCgoIKIIh4ooohmp1te3d2zHpBJz7E779Wrqle9fHn+cAwiIvunF3ojzuOePyMixh8Ts5zIKode4M/Ocy3fjlM+3Luq+AU4CYxklV9UBgEaBATZCOAcXG09SeACBAzApahrgI+hIknwBl5JuALL+m8CZ5eGZwAAkiPTMCmA+xrYHH2zFPwPAfu+vOPB2cHeb6CFgFAyMifTsIA1XLdm9WBaeY04a71tSoLA3YOIKxEHeKqgasjDLEp/RyXQmBo7eFXDiRiyZi9Y8P27Fyp2jVzOO43uRBRcFYlCiC5AkTVJQSMWIklAClK6RXKm4F6cmYIKZOd9UN+R8DqZ21BBHfwPJAq44isZvriHGrAIR6fuURcCMxEtTqtCyTcibsh9axp9WWt7pjeYIiBxOL8yAip7BxmA9y5pwaqkMiVpBip1gIYSLVKiz0pKLB3uDXz14GEhANlBIEEBLmRckWJK7oQKoKBQItIRHbFv0XDSx5dPFgIGZlGLAkaqFmr4QCk4AQ8y2hFRnJM7lqK8fnRtHZjFJ9IXyddirJaaOa7gFrHXgtvziW7gp9fPpALVBqznd34wt+NpAkXmxRNc7rp6H/DzZy+iucVwSr9PBqVmIdjFjaO3dSrOBhSTsfR+JS+3X718lcO2DJz44IlJGEZaXW0av+l63u+leTUE7+S3r9+MMOe0abtVTNPMI0w0Bko11t0LShyGuCjMH969FwLhTmXSeaX789VGK/GMcNm9GOB+uqr58ZdPn0fkz0fsZJu+0zEv/8vmwqV1Cj5BY7zr2JvmDn//+k0I7I+yzbLnRNStBvVNNltEeK1MrGLxUcA2RdNDFgK/fvxMAjbJDGizFaD1XGfz3AwCakdbznEdxxjE2e5getzwMgA4SF0XEqNLcDmU/dTA2cGb6ePAtyqJfMYNBL4v4BvR2Ii4RI5rwnTqRG0Q9aFBgUknGK4mYKAZGxFWfEAInTiM6CAGgY8zAQcf2xhjY8l7A5lOTZC7NYoUtlmBKtB7KuDAmFIzEf2s1QoIvMkUjI0GIu/Ii4I3Ad8QvYEvKYjc60jUWtColVAjVwjntg+xbZEo8FIkH4gcYH2j1lzyWgOqQhagm0wUINqaq+TMyJffY8lWFqv+qhg329OIuETraXEllujL7yffG0nUEv1CxBXRXkcI9pNGOnnc3Dx2mT3nIb9Wm6jAGrkrEKOp1sAKXKMX1/PosYNBPWMv1bftwFLduzaMex49VqQAIcFhYxbZiye5J6nNnIyEFm+TfuZxPJ4vxhN5/0P0MrSNxNwFO1CASJuyK+Cd4ysI3Fmdr6YAz7BLRJPXAvSfKb65yn1yiVYqHnKHbWrUOcWY+/F4W3tdjz245h8kVH5xgakI8cI1MolYcp3g1jY+yGX9DWJsXoAJtq1HAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAABW5JREFUWEd1VzGLJWUQ7O5v3rs/L4ggCAaCgYGBgYGBgWAgCIKBYCBcYrC7t08xuX27iU63VHX3zDe7e3M3fPPmbl/XV1Vd/a0+XjxCRCRC+Aefpmd8xu3hEuHi7nzm6qusteI53+W/h/v2ffxOlJBccwkJFdHHS/yrKhYhKhK6gTmAQPEEsRfJguuKFUBW8bUAFYAEjW/MTTSMRJEXADyJiAkAqBje8TPAPAPhji9KECx4KLwSTL4HC6uEN3MFAhD4t5hAsesl3oMJFm4QIVZgAMhQNKWY6Z9AoDCL//dBEDsLe3G808f7+Id7pwQCCQyS1GcAGcmIjCOAonsu/CqI9E5vYJchedDru7gv2gmAflBRDTGCQXGASFaWiLD0Qkmw7R4s7AyAjTZqe4clS9b0fYhe7+Omdz8Dwa7JRO6eDPBWWURiaQNCc9KP4nzutf2wbl1BU3an1QoG/mxDbgB2Q7YpNxmUAOSEmwW7aBlwZwEMTKYEYy0Fizu7Qx9u/S2JB/1txn09mLFYAIAEoXL2eceH3e9MoCO6M7AmC+kLvd7FHzQDDcgnlaALoH+15DMZsjhYOIvEqdvvhQxzq9Yz/cCcQDUXfbiL37NuMlChlW2Z2qNDTE0GTAlDamwynEXlTUQscwsCSNN/yIsXIADgNn6bgymTQlWUQTkFEzsCIOAHyqAKBiRBuI/0xNwJU1jh/RzbFWgA8GuGM6hPJo5dESqh7YWpE3YfqMgbAPFYrbtiZ+BDbGRa6vub+CVDWVQ8vQBArtj+xEDOC7LQDIjJSSK9oCpvwMQ8GzIL9nbsrpm7Awz8XBENwTUxZIcghDxEzdKEACDBLGAe6MGMBAFTnl8WqnZ9Zkr8PwD4aZ4Nr5mQQDoVdwYAArtvIOcQORv8wKB6befZmvMY14eb+BENoYr0DRGHASnHbETsHBE9SoIhEimF6olM5H2GLJAjIsYGIo5gZnBg4IeZAQ6kGkzdgjUHciBlG1bx7IYQWQxs4A45qbEzTs0ECzKM5q4oEz7cxvcwHzuhEhG6byGEUDLNYZSFR2gMDUXxmg2yhMpiaUq0J8GUJ07rPLwYyX16yi74bj8nJf0K+mFITkCGQgLogVR5oDmqF4YTmEhjLgog+R7GZGRHuG0MTIAgwbcNgLXThRlC3Ql5PugWHBJholpsyLCdCQJSY3EwQG80CM6OTkOcqpADD3fxTUpQWdBPNGG1YkawqaMtw8x04FygAKE4qMgw63ENc2rLkEBqcB1kqVTU62183VGM4WCKOgWHUlQSmhgOKWhHgpEwSEOHCCUwpxQxVHQRsJBxfWJggYmMbRoUzzCpXu/Wr3LmHK4MIzQiQbiamrnnlORhpYDwGbsndhkJIj3BwwtOUSKnrUsyNTFD6A29vlu/fAWACA8MqFMHVq4MaBN3VbM8KR1OTfCGDDG0qiaAyO7wkmLzQ3rjjEPpFxEeubHp4vE5QcwHFT6rgwBzABJYos4LadZBJiSGKVuVMiAr2pRlzJTi8X79PBlwjvtXLuz8JRsF4nBowczQMHMdbjFUlW1ZLcnIBhPWyUkAl/hM8BsHGX0OwgXeY3kOKtozZYEULQtYaDmaBWWrQgJIkiAiFjHd2pNMPF3iU0pA9nJ9cUHZRFGecHixDyvpDexg84NnaNGQxqDi9MQdsoAFJibmxtNf8QlSOScuGMD1HERLUAxA9UpLTi8QUJLkD7uZ2nCAoCGREdWedaxX05MDxNPf8bHgoFr0Y18OSaYLNjvKgAh41h0lQygBDYQWigsi2JCWdpgdNcYXfbqsH2EDzQLWZiF5SOXpdUcM1Vpe4AGGjqi2dIcQsARor/h2HK4SALpDFDKwTf8HJrT5DNu0ZrwAAAAASUVORK5CYII=";
var defaultEnvironmentDPUnnTO0_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,default:A$4});let f$b=class f{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(i,n,a,s){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=false,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=false,this._coreRuntimeAnimation=null,this._animation=n,this._target=i,this._scene=a,this._host=s,this._activeTargets=[],n._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===zr$1.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=re$5.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame){const t={frame:0,value:this._minValue};this._keys.splice(0,0,t);}if(this._target instanceof Array){let t=0;for(const e of this._target)this._preparePath(e,t),this._getOriginalValues(t),t++;this._targetIsArray=true;}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=false,this._directTarget=this._activeTargets[0];const o=n.getEvents();if(o&&o.length>0)for(const t of o)this._events.push(t._clone());this._enableBlending=i&&i.animationPropertiesOverride?i.animationPropertiesOverride.enableBlending:this._animation.enableBlending;}_preparePath(t,e=0){const i=this._animation.targetPropertyPath;if(i.length>1){let n=t;for(let t=0;t<i.length-1;t++){const e=i[t];if(n=n[e],void 0===n)throw new Error(`Invalid property (${e}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[e]=n;}else this._targetPath=i[0],this._activeTargets[e]=t;if(void 0===this._activeTargets[e][this._targetPath])throw new Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(t=false){if(t)if(this._target instanceof Array){let t=0;for(const e of this._target) void 0!==this._originalValue[t]&&this._setValue(e,this._activeTargets[t],this._originalValue[t],-1,t),t++;}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=false;}isStopped(){return this._stopped}dispose(){const t=this._animation.runtimeAnimations.indexOf(this);t>-1&&this._animation.runtimeAnimations.splice(t,1);}setValue(t,e){if(this._targetIsArray)for(let i=0;i<this._target.length;i++){const n=this._target[i];this._setValue(n,this._activeTargets[i],t,e,i);}else this._setValue(this._target,this._directTarget,t,e,0);}_getOriginalValues(t=0){let e;const i=this._activeTargets[t];e=i.getLocalMatrix&&"_matrix"===this._targetPath?i.getLocalMatrix():i[this._targetPath],e&&e.clone?this._originalValue[t]=e.clone():this._originalValue[t]=e;}_registerTargetForLateAnimationBinding(t,e){const i=t.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[t.targetPath]||(i._lateAnimationHolders[t.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),t.isAdditive?(i._lateAnimationHolders[t.targetPath].additiveAnimations.push(t),i._lateAnimationHolders[t.targetPath].totalAdditiveWeight+=t.weight):(i._lateAnimationHolders[t.targetPath].animations.push(t),i._lateAnimationHolders[t.targetPath].totalWeight+=t.weight);}_setValue(i,n,a,s,o){if(this._currentActiveTarget=n,this._weight=s,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const t=n[this._targetPath];t.clone?this._originalBlendValue=t.clone():this._originalBlendValue=t;}this._originalBlendValue.m?zr$1.AllowMatrixDecomposeForInterpolation?this._currentValue?re$5.DecomposeLerpToRef(this._originalBlendValue,a,this._blendingFactor,this._currentValue):this._currentValue=re$5.DecomposeLerp(this._originalBlendValue,a,this._blendingFactor):this._currentValue?re$5.LerpToRef(this._originalBlendValue,a,this._blendingFactor,this._currentValue):this._currentValue=re$5.Lerp(this._originalBlendValue,a,this._blendingFactor):this._currentValue=zr$1._UniversalLerp(this._originalBlendValue,a,this._blendingFactor);const s=i&&i.animationPropertiesOverride?i.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=s;}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(a):this._currentValue=a:this._currentValue=a?.clone?a.clone():a;-1!==s?this._registerTargetForLateAnimationBinding(this,this._originalValue[o]):this._animationState.loopMode===zr$1.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[o],n[this._targetPath]):n[this._targetPath]=this._originalValue[o]+this._currentValue:n[this._targetPath]=this._currentValue,i.markAsDirty&&i.markAsDirty(this._animation.targetProperty);}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(t,e=-1){const i=this._animation.getKeys();t<i[0].frame?t=i[0].frame:t>i[i.length-1].frame&&(t=i[i.length-1].frame);const n=this._events;if(n.length)for(let e=0;e<n.length;e++)n[e].onlyOnce||(n[e].isDone=n[e].frame<t);this._currentFrame=t;const a=this._animation._interpolate(t,this._animationState);this.setValue(a,e);}_prepareForSpeedRatioChange(t){const e=this._previousElapsedTime*(this._animation.framePerSecond*t)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-e;}animate(e,h,l,m,_,g=-1){const d=this._animation,u=d.targetPropertyPath;if(!u||u.length<1)return this._stopped=true,false;let c,p=true;const A=this._events;let f=0;if(this._coreRuntimeAnimation)f=l-h,c=this._coreRuntimeAnimation.currentFrame,this._currentFrame=c,this._animationState.repeatCount=this._coreRuntimeAnimation._animationState.repeatCount,this._animationState.highLimitValue=this._coreRuntimeAnimation._animationState.highLimitValue,this._animationState.offsetValue=this._coreRuntimeAnimation._animationState.offsetValue;else {let g;(h<this._minFrame||h>this._maxFrame)&&(h=this._minFrame),(l<this._minFrame||l>this._maxFrame)&&(l=this._maxFrame),f=l-h;let u=e*(d.framePerSecond*_)/1e3+this._absoluteFrameOffset,b=0,v=false;const y=m&&this._animationState.loopMode===zr$1.ANIMATIONLOOPMODE_YOYO;if(y){const t=(u-h)/f,e=Math.sin(t*Math.PI);u=Math.abs(e)*f+h;const i=e>=0?1:-1;this._yoyoDirection!==i&&(v=true),this._yoyoDirection=i;}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=u,!m&&l>=h&&(u>=f&&_>0||u<=0&&_<0))p=false,b=d._getKeyValue(this._maxValue);else if(!m&&h>=l&&(u<=f&&_<0||u>=0&&_>0))p=false,b=d._getKeyValue(this._minValue);else if(this._animationState.loopMode!==zr$1.ANIMATIONLOOPMODE_CYCLE){const e=l.toString()+h.toString();if(!this._offsetsCache[e]){this._animationState.repeatCount=0,this._animationState.loopMode=zr$1.ANIMATIONLOOPMODE_CYCLE;const i=d._interpolate(h,this._animationState),n=d._interpolate(l,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),d.dataType){case zr$1.ANIMATIONTYPE_FLOAT:this._offsetsCache[e]=n-i;break;case zr$1.ANIMATIONTYPE_QUATERNION:case zr$1.ANIMATIONTYPE_VECTOR3:case zr$1.ANIMATIONTYPE_VECTOR2:case zr$1.ANIMATIONTYPE_SIZE:case zr$1.ANIMATIONTYPE_COLOR3:this._offsetsCache[e]=n.subtract(i);}this._highLimitsCache[e]=n;}b=this._highLimitsCache[e],g=this._offsetsCache[e];}if(void 0===g)switch(d.dataType){case zr$1.ANIMATIONTYPE_FLOAT:g=0;break;case zr$1.ANIMATIONTYPE_QUATERNION:g=Nr$1;break;case zr$1.ANIMATIONTYPE_VECTOR3:g=Br$1;break;case zr$1.ANIMATIONTYPE_VECTOR2:g=Ur;break;case zr$1.ANIMATIONTYPE_SIZE:g=kr$1;break;case zr$1.ANIMATIONTYPE_COLOR3:g=Gr$1;break;case zr$1.ANIMATIONTYPE_COLOR4:g=Vr$1;}if(this._host&&this._host.syncRoot){const t=this._host.syncRoot;c=h+f*((t.masterFrame-t.fromFrame)/(t.toFrame-t.fromFrame));}else c=u>0&&h>l||u<0&&h<l?p&&0!==f?l+u%f:h:p&&0!==f?h+u%f:l;if(!y&&(_>0&&this.currentFrame>c||_<0&&this.currentFrame<c)||y&&v){this._onLoop();for(let t=0;t<A.length;t++)A[t].onlyOnce||(A[t].isDone=false);this._animationState.key=_>0?0:d.getKeys().length-1;}this._currentFrame=c,this._animationState.repeatCount=0===f?0:u/f|0,this._animationState.highLimitValue=b,this._animationState.offsetValue=g;}const b=d._interpolate(c,this._animationState);if(this.setValue(b,g),A.length)for(let t=0;t<A.length;t++)if(f>=0&&c>=A[t].frame&&A[t].frame>=h||f<0&&c<=A[t].frame&&A[t].frame<=h){const e=A[t];e.isDone||(e.onlyOnce&&(A.splice(t,1),t--),e.isDone=true,e.action(c));}return p||(this._stopped=true),p}};let b$5=class b{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(t){this._weight=-1!==t?Math.min(Math.max(t,0),1):-1;}get speedRatio(){return this._speedRatio}set speedRatio(t){for(let e=0;e<this._runtimeAnimations.length;e++){this._runtimeAnimations[e]._prepareForSpeedRatioChange(t);}this._speedRatio=t,null!==this._goToFrame&&this.goToFrame(this._goToFrame);}get elapsedTime(){return null===this._localDelayOffset?0:this._scene._animationTime-this._localDelayOffset}constructor(t,e,i=0,n=100,a=false,s=1,o,r,h,m=false,_=0){this.target=e,this.fromFrame=i,this.toFrame=n,this.loopAnimation=a,this.onAnimationEnd=o,this.onAnimationLoop=h,this.isAdditive=m,this.playOrder=_,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=false,this._speedRatio=1,this._weight=-1,this._previousWeight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=true,this.animationStarted=false,this.onAnimationEndObservable=new R$g,this.onAnimationLoopObservable=new R$g,this._scene=t,r&&this.appendAnimations(e,r),this._speedRatio=s,t._activeAnimatables.push(this);}syncWith(t){if(this._syncRoot=t,t){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this));}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(t,e){for(let i=0;i<e.length;i++){const n=e[i],a=new f$b(t,n,this._scene,this);a._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop();},this._runtimeAnimations.push(a);}}getAnimationByTargetProperty(t){const e=this._runtimeAnimations;for(let i=0;i<e.length;i++)if(e[i].animation.targetProperty===t)return e[i].animation;return null}getRuntimeAnimationByTargetProperty(t){const e=this._runtimeAnimations;for(let i=0;i<e.length;i++)if(e[i].animation.targetProperty===t)return e[i];return null}reset(){const t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].reset(true);this._localDelayOffset=null,this._pausedDelay=null;}enableBlending(t){const e=this._runtimeAnimations;for(let i=0;i<e.length;i++)e[i].animation.enableBlending=true,e[i].animation.blendingSpeed=t;}disableBlending(){const t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].animation.enableBlending=false;}goToFrame(t,e=false){const i=this._runtimeAnimations;if(i[0]){const e=i[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??i[0].currentFrame;const n=0===this.speedRatio?0:(t-this._frameToSyncFromJump)/e*1e3/this.speedRatio;this._manualJumpDelay=-n;}for(let n=0;n<i.length;n++)i[n].goToFrame(t,e?this._weight:-1);this._goToFrame=t;}get paused(){return this._paused}pause(){this._paused||(this._paused=true);}restart(){this._paused=false;}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this);}stop(t,e,i=false,n=false){if(t||e){const a=this._scene._activeAnimatables.indexOf(this);if(a>-1){const s=this._runtimeAnimations;for(let i=s.length-1;i>=0;i--){const n=s[i];t&&n.animation.name!=t||(e&&!e(n.target)||(n.dispose(),s.splice(i,1)));}0==s.length&&(i||this._scene._activeAnimatables.splice(a,1),n||this._raiseOnAnimationEnd());}}else {const t=this._scene._activeAnimatables.indexOf(this);if(t>-1){i||this._scene._activeAnimatables.splice(t,1);const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].dispose();this._runtimeAnimations.length=0,n||this._raiseOnAnimationEnd();}}}async waitAsync(){return await new Promise((t=>{this.onAnimationEndObservable.add((()=>{t(this);}),void 0,void 0,this,true);}))}_animate(t){if(this._paused)return this.animationStarted=false,null===this._pausedDelay&&(this._pausedDelay=t),true;if(null===this._localDelayOffset?(this._localDelayOffset=t,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=t-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this.speedRatio<0?-this._manualJumpDelay:this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,!b.ProcessPausedAnimatables&&0===this._weight&&0===this._previousWeight)return  true;this._previousWeight=this._weight;let e=false;const i=this._runtimeAnimations;let n;for(n=0;n<i.length;n++){const a=i[n].animate(t-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);e=e||a;}if(this.animationStarted=e,!e){if(this.disposeOnEnd)for(n=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(n,1),n=0;n<i.length;n++)i[n].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear());}return e}};function v$3(t){if(0===t.totalWeight&&0===t.totalAdditiveWeight)return t.originalValue;let i=1;const n=ae$5.Vector3[0],a=ae$5.Vector3[1],s=ae$5.Quaternion[0];let o=0;const r=t.animations[0],h=t.originalValue;let l=1,d=false;if(t.totalWeight<1)l=1-t.totalWeight,h.decompose(a,s,n);else {if(o=1,i=t.totalWeight,l=r.weight/i,1==l){if(!t.totalAdditiveWeight)return r.currentValue;d=true;}r.currentValue.decompose(a,s,n);}if(!d){a.scaleInPlace(l),n.scaleInPlace(l),s.scaleInPlace(l);for(let e=o;e<t.animations.length;e++){const o=t.animations[e];if(0===o.weight)continue;l=o.weight/i;const r=ae$5.Vector3[2],h=ae$5.Vector3[3],g=ae$5.Quaternion[1];o.currentValue.decompose(h,g,r),h.scaleAndAddToRef(l,a),g.scaleAndAddToRef(se$5.Dot(s,g)>0?l:-l,s),r.scaleAndAddToRef(l,n);}s.normalize();}for(let e=0;e<t.additiveAnimations.length;e++){const i=t.additiveAnimations[e];if(0===i.weight)continue;const o=ae$5.Vector3[2],r=ae$5.Vector3[3],h=ae$5.Quaternion[1];i.currentValue.decompose(r,h,o),r.multiplyToRef(a,r),te$4.LerpToRef(a,r,i.weight,a),s.multiplyToRef(h,h),se$5.SlerpToRef(s,h,i.weight,s),o.scaleAndAddToRef(i.weight,n);}const u=r?r._animationState.workValue:ae$5.Matrix[0].clone();return re$5.ComposeToRef(a,s,n,u),u}function y$2(t,e){if(0===t.totalWeight&&0===t.totalAdditiveWeight)return e;const i=t.animations[0],n=t.originalValue;let a=e;if(0===t.totalWeight&&t.totalAdditiveWeight>0)a.copyFrom(n);else if(1===t.animations.length){if(se$5.SlerpToRef(n,i.currentValue,Math.min(1,t.totalWeight),a),0===t.totalAdditiveWeight)return a}else if(t.animations.length>1){let i,s,o=1;if(t.totalWeight<1){const e=1-t.totalWeight;i=[],s=[],i.push(n),s.push(e);}else {if(2===t.animations.length&&(se$5.SlerpToRef(t.animations[0].currentValue,t.animations[1].currentValue,t.animations[1].weight/t.totalWeight,e),0===t.totalAdditiveWeight))return e;i=[],s=[],o=t.totalWeight;}for(let e=0;e<t.animations.length;e++){const n=t.animations[e];i.push(n.currentValue),s.push(n.weight/o);}let r=0;for(let t=0;t<i.length;)t?(r+=s[t],se$5.SlerpToRef(a,i[t],s[t]/r,a),t++):(se$5.SlerpToRef(i[t],i[t+1],s[t+1]/(s[t]+s[t+1]),e),a=e,r=s[t]+s[t+1],t+=2);}for(let e=0;e<t.additiveAnimations.length;e++){const i=t.additiveAnimations[e];0!==i.weight&&(a.multiplyToRef(i.currentValue,ae$5.Quaternion[0]),se$5.SlerpToRef(a,ae$5.Quaternion[0],i.weight,a));}return a}var T$1,O$4;b$5.ProcessPausedAnimatables=false,T$1=ch,(O$4=r$16)&&(O$4.prototype.copyAnimationRange=function(e,i,n,a=false,s=null){0===this.animations.length&&(this.animations.push(new zr$1(this.name,"_matrix",e.animations[0].framePerSecond,zr$1.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const o=e.animations[0].getRange(i);if(!o)return  false;const r=o.from,h=o.to,l=e.animations[0].getKeys(),m=e.length,_=e.getParent(),g=this.getParent(),d=a&&_&&m&&this.length&&m!==this.length,u=d&&g&&_?g.length/_.length:1,c=a&&!g&&s&&(1!==s.x||1!==s.y||1!==s.z),p=this.animations[0].getKeys();let A,f,b;for(let t=0,e=l.length;t<e;t++)A=l[t],A.frame>=r&&A.frame<=h&&(a?(b=A.value.clone(),d?(f=b.getTranslation(),b.setTranslation(f.scaleInPlace(u))):c&&s?(f=b.getTranslation(),b.setTranslation(f.multiplyInPlace(s))):b=A.value):b=A.value,p.push({frame:A.frame+n,value:b}));return this.animations[0].createRange(i,r+n,h+n),true}),T$1&&(T$1.prototype._animate=function(e){if(!this.animationsEnabled)return;const i=Pe$2.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=i;}this.deltaTime=void 0!==e?e:this.useConstantAnimationDeltaTime?16:(i-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=i;const n=this._activeAnimatables;if(0===n.length)return;this._animationTime+=this.deltaTime;const a=this._animationTime;for(let t=0;t<n.length;t++){const e=n[t];!e._animate(a)&&e.disposeOnEnd&&t--;}!function(e){if(e._registeredForLateAnimationBindings.length){for(let i=0;i<e._registeredForLateAnimationBindings.length;i++){const n=e._registeredForLateAnimationBindings.data[i];for(const e in n._lateAnimationHolders){const i=n._lateAnimationHolders[e],a=i.animations[0],s=i.originalValue;if(null==s)continue;const o=zr$1.AllowMatrixDecomposeForInterpolation&&s.m;let r=n[e];if(o)r=v$3(i);else if(void 0!==s.w)r=y$2(i,r||se$5.Identity());else {let e=0,n=1;const o=a&&a._animationState.loopMode===zr$1.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(i.totalWeight<1)r=o?s.clone?s.clone():s:a&&s.scale?s.scale(1-i.totalWeight):a?s*(1-i.totalWeight):s.clone?s.clone():s;else if(a){n=i.totalWeight;const t=a.weight/n;r=1!==t?a.currentValue.scale?a.currentValue.scale(t):a.currentValue*t:a.currentValue,o&&(r.addToRef?r.addToRef(s,r):r+=s),e=1;}for(let t=e;t<i.animations.length;t++){const e=i.animations[t],a=e.weight/n;a&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(a,r):r+=e.currentValue*a);}for(let t=0;t<i.additiveAnimations.length;t++){const e=i.additiveAnimations[t],n=e.weight;n&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(n,r):r+=e.currentValue*n);}}n[e]=r;}n._lateAnimationHolders={};}e._registeredForLateAnimationBindings.reset();}}(this);},T$1.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort(((t,e)=>t.playOrder-e.playOrder));},T$1.prototype.beginWeightedAnimation=function(t,e,i,n=1,a,s=1,o,r,h,l,m=false){const _=this.beginAnimation(t,e,i,a,s,o,r,false,h,l,m);return _.weight=n,_},T$1.prototype.beginAnimation=function(t,e,i,n,a=1,s,o,r=true,h,l,m=false){if(a<0){const t=e;e=i,i=t,a=-a;}e>i&&(a=-a),r&&this.stopAnimation(t,void 0,h),o||(o=new b$5(this,t,e,i,n,a,s,void 0,l,m));const _=!h||h(t);if(t.animations&&_&&o.appendAnimations(t,t.animations),t.getAnimatables){const m=t.getAnimatables();for(let t=0;t<m.length;t++)this.beginAnimation(m[t],e,i,n,a,s,o,r,h,l);}return o.reset(),o},T$1.prototype.beginHierarchyAnimation=function(t,e,i,n,a,s=1,o,r,h=true,l,m,_=false){const g=t.getDescendants(e),d=[];d.push(this.beginAnimation(t,i,n,a,s,o,r,h,l,void 0,_));for(const t of g)d.push(this.beginAnimation(t,i,n,a,s,o,r,h,l,void 0,_));return d},T$1.prototype.beginDirectAnimation=function(t,e,i,n,a,s=1,o,r,h=false){if(s<0){const t=i;i=n,n=t,s=-s;}return i>n&&(s=-s),new b$5(this,t,i,n,a,s,o,e,r,h)},T$1.prototype.beginDirectHierarchyAnimation=function(t,e,i,n,a,s,o,r,h,l=false){const m=t.getDescendants(e),_=[];_.push(this.beginDirectAnimation(t,i,n,a,s,o,r,h,l));for(const t of m)_.push(this.beginDirectAnimation(t,i,n,a,s,o,r,h,l));return _},T$1.prototype.getAnimatableByTarget=function(t){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===t)return this._activeAnimatables[e];return null},T$1.prototype.getAllAnimatablesByTarget=function(t){const e=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===t&&e.push(this._activeAnimatables[i]);return e},T$1.prototype.stopAnimation=function(t,e,i){const n=this.getAllAnimatablesByTarget(t);for(const t of n)t.stop(e,i);},T$1.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].stop(void 0,void 0,true);this._activeAnimatables.length=0;}for(const t of this.animationGroups)t.stop();});let V$3=class V{getClassName(){return "TargetedAnimation"}constructor(t){this.parent=t,this.uniqueId=ra.UniqueId;}serialize(){const t={};return t.animation=this.animation.serialize(),t.targetId=this.target.id,t}};let F$2=class F{get mask(){return this._mask}set mask(t){this._mask!==t&&(this._mask=t,this.syncWithMask(true));}syncWithMask(t=false){if(this.mask||t){this._numActiveAnimatables=0;for(let t=0;t<this._animatables.length;++t){const e=this._animatables[t];!this.mask||this.mask.disabled||this.mask.retainsTarget(e.target.name)?(this._numActiveAnimatables++,e.paused&&e.restart()):e.paused||e.pause();}}else this._numActiveAnimatables=this._targetedAnimations.length;}removeUnmaskedAnimations(){if(this.mask&&!this.mask.disabled){for(let t=0;t<this._animatables.length;++t){const e=this._animatables[t];this.mask.retainsTarget(e.target.name)||(e.stop(),this._animatables.splice(t,1),--t);}for(let t=0;t<this._targetedAnimations.length;t++){const e=this._targetedAnimations[t];this.mask.retainsTarget(e.target.name)||(this._targetedAnimations.splice(t,1),--t);}}}get from(){return this._from}set from(t){if(this._from!==t){this._from=t;for(let t=0;t<this._animatables.length;t++){this._animatables[t].fromFrame=this._from;}}}get to(){return this._to}set to(t){if(this._to!==t){this._to=t;for(let t=0;t<this._animatables.length;t++){this._animatables[t].toFrame=this._to;}}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(t){if(this._speedRatio!==t){this._speedRatio=t;for(let t=0;t<this._animatables.length;t++){this._animatables[t].speedRatio=this._speedRatio;}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(t){if(this._loopAnimation!==t){this._loopAnimation=t;for(let t=0;t<this._animatables.length;t++){this._animatables[t].loopAnimation=this._loopAnimation;}}}get isAdditive(){return this._isAdditive}set isAdditive(t){if(this._isAdditive!==t){this._isAdditive=t;for(let t=0;t<this._animatables.length;t++){this._animatables[t].isAdditive=this._isAdditive;}}}get weight(){return this._weight}set weight(t){this._weight!==t&&(this._weight=t,this.setWeightForAllAnimatables(this._weight));}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(t){if(this._playOrder!==t&&(this._playOrder=t,this._animatables.length>0)){for(let t=0;t<this._animatables.length;t++)this._animatables[t].playOrder=this._playOrder;this._scene.sortActiveAnimatables();}}get enableBlending(){return this._enableBlending}set enableBlending(t){if(this._enableBlending!==t&&(this._enableBlending=t,null!==t))for(let e=0;e<this._targetedAnimations.length;++e)this._targetedAnimations[e].animation.enableBlending=t;}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(t){if(this._blendingSpeed!==t&&(this._blendingSpeed=t,null!==t))for(let e=0;e<this._targetedAnimations.length;++e)this._targetedAnimations[e].animation.blendingSpeed=t;}getLength(t,e){t=t??this._from;return ((e=e??this._to)-t)/(this.targetedAnimations[0].animation.framePerSecond*this._speedRatio)}static MergeAnimationGroups(t,e=true,i=false,n){if(0===t.length)return null;n=n??t[0].weight;let a=Number.MAX_VALUE,s=-Number.MAX_VALUE;if(i)for(const e of t)e.from<a&&(a=e.from),e.to>s&&(s=e.to);const o=new F(t[0].name+"_merged",t[0]._scene,n);for(const n of t){i&&n.normalize(a,s);for(const t of n.targetedAnimations)o.addTargetedAnimation(t.animation,t.target);e&&n.dispose();}return o}getScene(){return this._scene}constructor(t,e=null,i=-1,n=0){this.name=t,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=false,this._isAdditive=false,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=true,this._parentContainer=null,this.onAnimationEndObservable=new R$g,this.onAnimationLoopObservable=new R$g,this.onAnimationGroupLoopObservable=new R$g,this.onAnimationGroupEndObservable=new R$g,this.onAnimationGroupPauseObservable=new R$g,this.onAnimationGroupPlayObservable=new R$g,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=e||L$7.LastCreatedScene,this._weight=i,this._playOrder=n,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this);}addTargetedAnimation(t,e){const i=new V$3(this);i.animation=t,i.target=e;const n=t.getKeys();return this._from>n[0].frame&&(this._from=n[0].frame),this._to<n[n.length-1].frame&&(this._to=n[n.length-1].frame),null!==this._enableBlending&&(t.enableBlending=this._enableBlending),null!==this._blendingSpeed&&(t.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),this._shouldStart=true,i}removeTargetedAnimation(t){for(let e=this._targetedAnimations.length-1;e>-1;e--){this._targetedAnimations[e].animation===t&&this._targetedAnimations.splice(e,1);}}normalize(t=null,e=null){null==t&&(t=this._from),null==e&&(e=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const n=this._targetedAnimations[i].animation.getKeys(),a=n[0],s=n[n.length-1];if(a.frame>t){const e={frame:t,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};n.splice(0,0,e);}if(s.frame<e){const t={frame:e,value:s.value,inTangent:s.inTangent,outTangent:s.outTangent,interpolation:s.interpolation};n.push(t);}}return this._from=t,this._to=e,this}_processLoop(t,e,i){t.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(e),this._animationLoopFlags[i]||(this._animationLoopFlags[i]=true,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0));};}start(t=false,e=1,i,n,a){if(this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=t,this._shouldStart=false,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let s=0;s<this._targetedAnimations.length;s++){const o=this._targetedAnimations[s],r=this._scene.beginDirectAnimation(o.target,[o.animation],void 0!==i?i:this._from,void 0!==n?n:this._to,t,e,void 0,void 0,void 0!==a?a:this._isAdditive);r.weight=this._weight,r.playOrder=this._playOrder,r.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(r);},this._processLoop(r,o,s),this._animatables.push(r);}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=e,this._isStarted=true,this._isPaused=false,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=true;for(let t=0;t<this._animatables.length;t++){this._animatables[t].pause();}return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(t){return this.isStarted&&this._animatables.length&&!this._shouldStart?(void 0!==t&&(this.loopAnimation=t),this.restart()):(this.stop(),this.start(t,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(true),this;for(let t=0;t<this._animatables.length;t++){this._animatables[t].reset();}return this}restart(){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++){this._animatables[t].restart();}return this.syncWithMask(),this._isPaused=false,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(t=false){if(!this._isStarted)return this;const e=this._animatables.slice();for(let i=0;i<e.length;i++)e[i].stop(void 0,void 0,true,t);let i=0;for(let e=0;e<this._scene._activeAnimatables.length;e++){const n=this._scene._activeAnimatables[e];n._runtimeAnimations.length>0?this._scene._activeAnimatables[i++]=n:t&&this._checkAnimationGroupEnded(n,t);}return this._scene._activeAnimatables.length=i,this._isStarted=false,this}setWeightForAllAnimatables(t){for(let e=0;e<this._animatables.length;e++){this._animatables[e].weight=t;}return this}syncAllAnimationsWith(t){for(let e=0;e<this._animatables.length;e++){this._animatables[e].syncWith(t);}return this}goToFrame(t,e=false){if(!this._isStarted)return this;for(let i=0;i<this._animatables.length;i++){this._animatables[i].goToFrame(t,e);}return this}getCurrentFrame(){return this.animatables[0]?.masterFrame||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;const t=this._scene.animationGroups.indexOf(this);if(t>-1&&this._scene.animationGroups.splice(t,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null;}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear();}_checkAnimationGroupEnded(t,e=false){const i=this._animatables.indexOf(t);i>-1&&this._animatables.splice(i,1),this._animatables.length===this._targetedAnimations.length-this._numActiveAnimatables&&(this._isStarted=false,e||this.onAnimationGroupEndObservable.notifyObservers(this),this._animatables.length=0);}clone(t,e,i=false){const n=new F(t||this.name,this._scene,this._weight,this._playOrder);n._from=this.from,n._to=this.to,n._speedRatio=this.speedRatio,n._loopAnimation=this.loopAnimation,n._isAdditive=this.isAdditive,n._enableBlending=this.enableBlending,n._blendingSpeed=this.blendingSpeed,n.metadata=this.metadata,n.mask=this.mask;for(const t of this._targetedAnimations)n.addTargetedAnimation(i?t.animation.clone():t.animation,e?e(t.target):t.target);return n}serialize(){const t={};t.name=this.name,t.from=this.from,t.to=this.to,t.speedRatio=this.speedRatio,t.loopAnimation=this.loopAnimation,t.isAdditive=this.isAdditive,t.weight=this.weight,t.playOrder=this.playOrder,t.enableBlending=this.enableBlending,t.blendingSpeed=this.blendingSpeed,t.targetedAnimations=[];for(let e=0;e<this.targetedAnimations.length;e++){const i=this.targetedAnimations[e];t.targetedAnimations[e]=i.serialize();}return ue$4&&ue$4.HasTags(this)&&(t.tags=ue$4.GetTags(this)),this.metadata&&(t.metadata=this.metadata),t}static Parse(e,i,n){const a=new F(e.name,i,e.weight,e.playOrder);for(let s=0;s<e.targetedAnimations.length;s++){const o=e.targetedAnimations[s],r=zr$1.Parse(o.animation),h=o.targetId;if("influence"===o.animation.property){const t=i.getMorphTargetById(h);t&&a.addTargetedAnimation(r,t);}else {const t=n?n.get(h):i.getNodeById(h);null!=t&&a.addTargetedAnimation(r,t);}}return ue$4&&ue$4.AddTagsTo(a,e.tags),null!==e.from&&null!==e.to&&a.normalize(e.from,e.to),void 0!==e.speedRatio&&(a._speedRatio=e.speedRatio),void 0!==e.loopAnimation&&(a._loopAnimation=e.loopAnimation),void 0!==e.isAdditive&&(a._isAdditive=e.isAdditive),void 0!==e.weight&&(a._weight=e.weight),void 0!==e.playOrder&&(a._playOrder=e.playOrder),void 0!==e.enableBlending&&(a._enableBlending=e.enableBlending),void 0!==e.blendingSpeed&&(a._blendingSpeed=e.blendingSpeed),void 0!==e.metadata&&(a.metadata=e.metadata),a}static MakeAnimationAdditive(e,i,n,a=false,s){let o;o="object"==typeof i?i:{referenceFrame:i,range:n,cloneOriginalAnimationGroup:a,clonedAnimationName:s};let r=e;o.cloneOriginalAnimationGroup&&(r=e.clone(o.clonedAnimationGroupName||r.name));const h=r.targetedAnimations;for(let e=0;e<h.length;e++){const i=h[e];i.animation=zr$1.MakeAnimationAdditive(i.animation,o);}if(r.isAdditive=true,o.clipKeys){let t=Number.MAX_VALUE,e=-Number.MAX_VALUE;const i=r.targetedAnimations;for(let n=0;n<i.length;n++){const a=i[n].animation.getKeys();t>a[0].frame&&(t=a[0].frame),e<a[a.length-1].frame&&(e=a[a.length-1].frame);}r._from=t,r._to=e;}return r}static ClipKeys(t,e,i,n,a){const s=t.clone(n||t.name);return F.ClipKeysInPlace(s,e,i,a)}static ClipKeysInPlace(t,e,i,n){return F.ClipInPlace(t,e,i,n,false)}static ClipFrames(t,e,i,n,a){const s=t.clone(n||t.name);return F.ClipFramesInPlace(s,e,i,a)}static ClipFramesInPlace(t,e,i,n){return F.ClipInPlace(t,e,i,n,true)}static ClipInPlace(t,e,i,n,a=false){let s=Number.MAX_VALUE,o=-Number.MAX_VALUE;const r=t.targetedAnimations;for(let t=0;t<r.length;t++){const h=r[t],l=n?h.animation:h.animation.clone();a&&(l.createKeyForFrame(e),l.createKeyForFrame(i));const m=l.getKeys(),_=[];let g=Number.MAX_VALUE;for(let t=0;t<m.length;t++){const n=m[t];if(!a&&t>=e&&t<=i||a&&n.frame>=e&&n.frame<=i){const t={frame:n.frame,value:n.value.clone?n.value.clone():n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation,lockedTangent:n.lockedTangent};g===Number.MAX_VALUE&&(g=t.frame),t.frame-=g,_.push(t);}}0!==_.length?(s>_[0].frame&&(s=_[0].frame),o<_[_.length-1].frame&&(o=_[_.length-1].frame),l.setKeys(_,true),h.animation=l):(r.splice(t,1),t--);}return t._from=s,t._to=o,t}getClassName(){return "AnimationGroup"}toString(t){let e="Name: "+this.name;return e+=", type: "+this.getClassName(),t&&(e+=", from: "+this._from,e+=", to: "+this._to,e+=", isStarted: "+this._isStarted,e+=", speedRatio: "+this._speedRatio,e+=", targetedAnimations length: "+this._targetedAnimations.length,e+=", animatables length: "+this._animatables),e}};var animationGroupCfDOHop1_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,AnimationGroup:F$2,TargetedAnimation:V$3});let e$b=class e{constructor(e){this._material=e;}get material(){return this._material}get isUnlit(){return this._material.unlit}set isUnlit(e){this._material.unlit=e;}set backFaceCulling(e){this._material.backFaceCulling=e;}get backFaceCulling(){return this._material.backFaceCulling}set twoSidedLighting(e){this._material.twoSidedLighting=e;}get twoSidedLighting(){return this._material.twoSidedLighting}set alphaCutOff(e){}get alphaCutOff(){return .5}set useAlphaFromBaseColorTexture(e){this._material._useAlphaFromBaseColorTexture=e;}get useAlphaFromBaseColorTexture(){return  false}get transparencyAsAlphaCoverage(){return  false}set transparencyAsAlphaCoverage(e){}set baseColor(e){this._material.baseColor=e;}get baseColor(){return this._material.baseColor}set baseColorTexture(e){this._material.baseColorTexture=e;}get baseColorTexture(){return this._material.baseColorTexture}set baseDiffuseRoughness(e){this._material.baseDiffuseRoughness=e;}get baseDiffuseRoughness(){return this._material.baseDiffuseRoughness}set baseDiffuseRoughnessTexture(e){this._material.baseDiffuseRoughnessTexture=e;}get baseDiffuseRoughnessTexture(){return this._material.baseDiffuseRoughnessTexture}set baseMetalness(e){this._material.baseMetalness=e;}get baseMetalness(){return this._material.baseMetalness}set baseMetalnessTexture(e){this._material.baseMetalnessTexture=e;}get baseMetalnessTexture(){return this._material.baseMetalnessTexture}set useRoughnessFromMetallicTextureGreen(e){this._material._useRoughnessFromMetallicTextureGreen=e;}set useMetallicFromMetallicTextureBlue(e){this._material._useMetallicFromMetallicTextureBlue=e;}enableSpecularEdgeColor(e=false){}set specularWeight(e){this._material.specularWeight=e;}get specularWeight(){return this._material.specularWeight}set specularWeightTexture(e){this._material.specularColorTexture===e?(this._material.specularWeightTexture=null,this._material._useSpecularWeightFromSpecularColorTexture=true,this._material._useSpecularWeightFromAlpha=true):this._material.specularWeightTexture=e;}get specularWeightTexture(){return this._material.specularWeightTexture}set specularColor(e){this._material.specularColor=e;}get specularColor(){return this._material.specularColor}set specularColorTexture(e){this._material.specularColorTexture=e,this._material.specularWeightTexture===this._material.specularColorTexture&&(this._material.specularWeightTexture=null,this._material._useSpecularWeightFromSpecularColorTexture=true,this._material._useSpecularWeightFromAlpha=true);}get specularColorTexture(){return this._material.specularColorTexture}set specularRoughness(e){this._material.specularRoughness=e;}get specularRoughness(){return this._material.specularRoughness}set specularRoughnessTexture(e){this._material.specularRoughnessTexture=e;}get specularRoughnessTexture(){return this._material.specularRoughnessTexture}set specularIor(e){this._material.specularIor=e;}get specularIor(){return this._material.specularIor}set emissionColor(e){this._material.emissionColor=e;}get emissionColor(){return this._material.emissionColor}set emissionLuminance(e){this._material.emissionLuminance=e;}get emissionLuminance(){return this._material.emissionLuminance}set emissionColorTexture(e){this._material.emissionColorTexture=e;}get emissionColorTexture(){return this._material.emissionColorTexture}set ambientOcclusionTexture(e){this._material.ambientOcclusionTexture=e;}get ambientOcclusionTexture(){return this._material.ambientOcclusionTexture}set ambientOcclusionTextureStrength(e){const t=this._material.ambientOcclusionTexture;t&&(t.level=e);}get ambientOcclusionTextureStrength(){const e=this._material.ambientOcclusionTexture;return e?.level??1}configureCoat(){}set coatWeight(e){this._material.coatWeight=e;}get coatWeight(){return this._material.coatWeight}set coatWeightTexture(e){this._material.coatWeightTexture=e;}get coatWeightTexture(){return this._material.coatWeightTexture}set coatColor(e){this._material.coatColor=e;}set coatColorTexture(e){this._material.coatColorTexture=e;}set coatRoughness(e){this._material.coatRoughness=e;}get coatRoughness(){return this._material.coatRoughness}set coatRoughnessTexture(e){this._material.coatRoughnessTexture=e;}get coatRoughnessTexture(){return this._material.coatRoughnessTexture}set coatIor(e){this._material.coatIor=e;}set coatDarkening(e){this._material.coatDarkening=e;}set coatDarkeningTexture(e){this._material.coatDarkeningTexture=e;}set coatRoughnessAnisotropy(e){this._material.coatRoughnessAnisotropy=e;}get coatRoughnessAnisotropy(){return this._material.coatRoughnessAnisotropy}set geometryCoatTangentAngle(e){this._material.geometryCoatTangentAngle=e;}set geometryCoatTangentTexture(e){this._material.geometryCoatTangentTexture=e,e&&(this._material._useCoatRoughnessAnisotropyFromTangentTexture=true);}get geometryCoatTangentTexture(){return this._material.geometryCoatTangentTexture}set transmissionWeight(e){}set transmissionWeightTexture(e){}get transmissionWeight(){return 0}set transmissionDispersionAbbeNumber(e){}configureTransmission(){}set transmissionDepth(e){}set transmissionColor(e){}set volumeThicknessTexture(e){}set volumeThickness(e){}configureSubsurface(){}set subsurfaceWeight(e){}get subsurfaceWeight(){return 0}set subsurfaceWeightTexture(e){}set subsurfaceColor(e){}set subsurfaceColorTexture(e){}configureFuzz(){}set fuzzWeight(e){this._material.fuzzWeight=e;}set fuzzColor(e){this._material.fuzzColor=e;}set fuzzColorTexture(e){this._material.fuzzColorTexture=e;}set fuzzRoughness(e){this._material.fuzzRoughness=e;}set fuzzRoughnessTexture(e){this._material.fuzzRoughnessTexture=e;}set specularRoughnessAnisotropy(e){this._material.specularRoughnessAnisotropy=e;}get specularRoughnessAnisotropy(){return this._material.specularRoughnessAnisotropy}set geometryTangentAngle(e){this._material.geometryTangentAngle=e;}set geometryTangentTexture(e){this._material.geometryTangentTexture=e,this._material._useSpecularRoughnessAnisotropyFromTangentTexture=true;}get geometryTangentTexture(){return this._material.geometryTangentTexture}configureGltfStyleAnisotropy(e=true){this._material._useGltfStyleAnisotropy=e;}set thinFilmWeight(e){this._material.thinFilmWeight=e;}set thinFilmIor(e){this._material.thinFilmIor=e;}set thinFilmThicknessMinimum(e){this._material.thinFilmThicknessMin=e/1e3;}set thinFilmThicknessMaximum(e){this._material.thinFilmThickness=e/1e3;}set thinFilmWeightTexture(e){this._material.thinFilmWeightTexture=e;}set thinFilmThicknessTexture(e){this._material.thinFilmThicknessTexture=e,this._material._useThinFilmThicknessFromTextureGreen=true;}set unlit(e){this._material.unlit=e;}set geometryOpacity(e){this._material.geometryOpacity=e;}get geometryOpacity(){return this._material.geometryOpacity}set geometryNormalTexture(e){this._material.geometryNormalTexture=e;}get geometryNormalTexture(){return this._material.geometryNormalTexture}setNormalMapInversions(e,t){}set geometryCoatNormalTexture(e){this._material.geometryCoatNormalTexture=e;}get geometryCoatNormalTexture(){return this._material.geometryCoatNormalTexture}set geometryCoatNormalTextureScale(e){this._material.geometryCoatNormalTexture&&(this._material.geometryCoatNormalTexture.level=e);}};var openpbrMaterialLoadingAdapter1t_YYXqm_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,OpenPBRMaterialLoadingAdapter:e$b});let a$t=class a{constructor(e){this._material=e,this._material.enableSpecularAntiAliasing=true;}get material(){return this._material}get isUnlit(){return this._material.unlit}set isUnlit(e){this._material.unlit=e;}set backFaceCulling(e){this._material.backFaceCulling=e;}get backFaceCulling(){return this._material.backFaceCulling}set twoSidedLighting(e){this._material.twoSidedLighting=e;}get twoSidedLighting(){return this._material.twoSidedLighting}set alphaCutOff(e){this._material.alphaCutOff=e;}get alphaCutOff(){return this._material.alphaCutOff}set useAlphaFromBaseColorTexture(e){this._material.useAlphaFromAlbedoTexture=e;}get useAlphaFromBaseColorTexture(){return this._material.useAlphaFromAlbedoTexture}get transparencyAsAlphaCoverage(){return this._material.useRadianceOverAlpha||this._material.useSpecularOverAlpha}set transparencyAsAlphaCoverage(e){this._material.useRadianceOverAlpha=!e,this._material.useSpecularOverAlpha=!e;}set baseColor(e){this._material.albedoColor=e;}get baseColor(){return this._material.albedoColor}set baseColorTexture(e){this._material.albedoTexture=e;}get baseColorTexture(){return this._material.albedoTexture}set baseDiffuseRoughness(t){this._material.baseDiffuseRoughness=t,t>0&&(this._material.brdf.baseDiffuseModel=Qe$1.MATERIAL_DIFFUSE_MODEL_E_OREN_NAYAR);}get baseDiffuseRoughness(){return this._material.baseDiffuseRoughness??0}set baseDiffuseRoughnessTexture(e){this._material.baseDiffuseRoughnessTexture=e;}get baseDiffuseRoughnessTexture(){return this._material.baseDiffuseRoughnessTexture}set baseMetalness(e){this._material.metallic=e;}get baseMetalness(){return this._material.metallic??1}set baseMetalnessTexture(e){this._material.metallicTexture=e;}get baseMetalnessTexture(){return this._material.metallicTexture}set useRoughnessFromMetallicTextureGreen(e){this._material.useRoughnessFromMetallicTextureGreen=e,this._material.useRoughnessFromMetallicTextureAlpha=!e;}set useMetallicFromMetallicTextureBlue(e){this._material.useMetallnessFromMetallicTextureBlue=e;}enableSpecularEdgeColor(t=false){t&&(this._material.brdf.dielectricSpecularModel=Qe$1.MATERIAL_DIELECTRIC_SPECULAR_MODEL_OPENPBR,this._material.brdf.conductorSpecularModel=Qe$1.MATERIAL_CONDUCTOR_SPECULAR_MODEL_OPENPBR);}set specularWeight(e){this._material.metallicF0Factor=e;}get specularWeight(){return this._material.metallicF0Factor??1}set specularWeightTexture(e){e?(this._material.metallicReflectanceTexture=e,this._material.useOnlyMetallicFromMetallicReflectanceTexture=true):(this._material.metallicReflectanceTexture=null,this._material.useOnlyMetallicFromMetallicReflectanceTexture=false);}get specularWeightTexture(){return this._material.metallicReflectanceTexture}set specularColor(e){this._material.metallicReflectanceColor=e;}get specularColor(){return this._material.metallicReflectanceColor}set specularColorTexture(e){this._material.reflectanceTexture=e;}get specularColorTexture(){return this._material.reflectanceTexture}set specularRoughness(e){this._material.roughness=e;}get specularRoughness(){return this._material.roughness??1}set specularRoughnessTexture(e){this.baseMetalnessTexture||(this._material.metallicTexture=e);}get specularRoughnessTexture(){return this._material.metallicTexture}set specularIor(e){this._material.indexOfRefraction=e;}get specularIor(){return this._material.indexOfRefraction}set emissionColor(e){this._material.emissiveColor=e;}get emissionColor(){return this._material.emissiveColor}set emissionLuminance(e){this._material.emissiveIntensity=e;}get emissionLuminance(){return this._material.emissiveIntensity}set emissionColorTexture(e){this._material.emissiveTexture=e;}get emissionColorTexture(){return this._material.emissiveTexture}set ambientOcclusionTexture(e){this._material.ambientTexture=e,e&&(this._material.useAmbientInGrayScale=true);}get ambientOcclusionTexture(){return this._material.ambientTexture}set ambientOcclusionTextureStrength(e){this._material.ambientTextureStrength=e;}get ambientOcclusionTextureStrength(){return this._material.ambientTextureStrength??1}configureCoat(){this._material.clearCoat.isEnabled=true,this._material.clearCoat.useRoughnessFromMainTexture=false,this._material.clearCoat.remapF0OnInterfaceChange=false;}set coatWeight(e){this._material.clearCoat.isEnabled=true,this._material.clearCoat.intensity=e;}get coatWeight(){return this._material.clearCoat.intensity}set coatWeightTexture(e){this._material.clearCoat.isEnabled=true,this._material.clearCoat.texture=e;}get coatWeightTexture(){return this._material.clearCoat.texture}set coatColor(e){this._material.clearCoat.isTintEnabled=e!=ge$3.White(),this._material.clearCoat.tintColor=e;}set coatColorTexture(e){this._material.clearCoat.tintTexture=e;}set coatRoughness(e){this._material.clearCoat.isEnabled=true,this._material.clearCoat.roughness=e;}get coatRoughness(){return this._material.clearCoat.roughness??0}set coatRoughnessTexture(e){this._material.clearCoat.isEnabled=true,this._material.clearCoat.useRoughnessFromMainTexture=false,this._material.clearCoat.textureRoughness=e;}get coatRoughnessTexture(){return this._material.clearCoat.textureRoughness}set coatIor(e){this._material.clearCoat.indexOfRefraction=e;}set coatDarkening(e){}set coatDarkeningTexture(e){}set coatRoughnessAnisotropy(e){}get coatRoughnessAnisotropy(){return 0}set geometryCoatTangentAngle(e){}set geometryCoatTangentTexture(e){}get geometryCoatTangentTexture(){return null}set transmissionWeight(e){this._material.subSurface.isRefractionEnabled=e>0,this._material.subSurface.refractionIntensity=e;}get transmissionWeight(){return this._material.subSurface.refractionIntensity}set transmissionWeightTexture(e){this._material.subSurface.isRefractionEnabled=true,this._material.subSurface.refractionIntensityTexture=e,this._material.subSurface.useGltfStyleTextures=true;}set transmissionDepth(e){this._material.subSurface.tintColorAtDistance=e;}set transmissionColor(e){this._material.subSurface.tintColor=e;}set transmissionDispersionAbbeNumber(e){e>0?(this._material.subSurface.isDispersionEnabled=true,this._material.subSurface.dispersion=20/e):(this._material.subSurface.isDispersionEnabled=false,this._material.subSurface.dispersion=0);}configureTransmission(){this._material.subSurface.volumeIndexOfRefraction=1,this._material.subSurface.useAlbedoToTintRefraction=true,this._material.subSurface.minimumThickness=0,this._material.subSurface.maximumThickness=0;}set volumeThicknessTexture(e){this._material.subSurface.thicknessTexture=e,this._material.subSurface.useGltfStyleTextures=true;}set volumeThickness(e){this._material.subSurface.minimumThickness=0,this._material.subSurface.maximumThickness=e,this._material.subSurface.useThicknessAsDepth=true,e>0&&(this._material.subSurface.volumeIndexOfRefraction=this._material.indexOfRefraction);}configureSubsurface(){this._material.subSurface.useGltfStyleTextures=true,this._material.subSurface.volumeIndexOfRefraction=1,this._material.subSurface.minimumThickness=0,this._material.subSurface.maximumThickness=0,this._material.subSurface.useAlbedoToTintTranslucency=false;}set subsurfaceWeight(e){this._material.subSurface.isTranslucencyEnabled=e>0,this._material.subSurface.translucencyIntensity=e;}get subsurfaceWeight(){return this._material.subSurface.isTranslucencyEnabled?this._material.subSurface.translucencyIntensity:0}set subsurfaceWeightTexture(e){this._material.subSurface.translucencyIntensityTexture=e;}set subsurfaceColor(e){this._material.subSurface.tintColor=e;}set subsurfaceColorTexture(e){this._material.subSurface.translucencyColorTexture=e;}configureFuzz(){this._material.sheen.isEnabled=true,this._material.sheen.useRoughnessFromMainTexture=false,this._material.sheen.albedoScaling=true;}set fuzzWeight(e){this._material.sheen.isEnabled=true,this._material.sheen.intensity=e;}set fuzzColor(e){this._material.sheen.isEnabled=true,this._material.sheen.color=e;}set fuzzColorTexture(e){this._material.sheen.isEnabled=true,this._material.sheen.texture=e;}set fuzzRoughness(e){this._material.sheen.isEnabled=true,this._material.sheen.roughness=e;}set fuzzRoughnessTexture(e){this._material.sheen.isEnabled=true,this._material.sheen.textureRoughness=e;}set specularRoughnessAnisotropy(e){this._material.anisotropy.isEnabled=true,this._material.anisotropy.intensity=e;}get specularRoughnessAnisotropy(){return this._material.anisotropy.intensity}set geometryTangentAngle(e){this._material.anisotropy.isEnabled=true,this._material.anisotropy.angle=e;}set geometryTangentTexture(e){this._material.anisotropy.isEnabled=true,this._material.anisotropy.texture=e;}get geometryTangentTexture(){return this._material.anisotropy.texture}configureGltfStyleAnisotropy(e=true){}set thinFilmWeight(e){this._material.iridescence.isEnabled=e>0,this._material.iridescence.intensity=e;}set thinFilmIor(e){this._material.iridescence.indexOfRefraction=e;}set thinFilmThicknessMinimum(e){this._material.iridescence.minimumThickness=e;}set thinFilmThicknessMaximum(e){this._material.iridescence.maximumThickness=e;}set thinFilmWeightTexture(e){this._material.iridescence.texture=e;}set thinFilmThicknessTexture(e){this._material.iridescence.thicknessTexture=e;}set transmissionDispersion(e){this._material._dispersion=e;}set unlit(e){this._material.unlit=e;}set geometryOpacity(e){this._material.alpha=e;}get geometryOpacity(){return this._material.alpha}set geometryNormalTexture(e){this._material.bumpTexture=e,this._material.forceIrradianceInFragment=true;}get geometryNormalTexture(){return this._material.bumpTexture}setNormalMapInversions(e,t){this._material.invertNormalMapX=e,this._material.invertNormalMapY=t;}set geometryCoatNormalTexture(e){this._material.clearCoat.isEnabled=true,this._material.clearCoat.bumpTexture=e;}get geometryCoatNormalTexture(){return this._material.clearCoat.bumpTexture}set geometryCoatNormalTextureScale(e){this._material.clearCoat.bumpTexture&&(this._material.clearCoat.bumpTexture.level=e);}};var pbrMaterialLoadingAdapterMkMWQfCC_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,PBRMaterialLoadingAdapter:a$t});let a$s=class a extends Z$2{constructor(t){super(t,["animationLoop","animationEnd","animationGroupLoop"]),this.config=t,this.speed=this.registerDataInput("speed",w$3),this.loop=this.registerDataInput("loop",v$8),this.from=this.registerDataInput("from",w$3,0),this.to=this.registerDataInput("to",w$3),this.currentFrame=this.registerDataOutput("currentFrame",w$3),this.currentTime=this.registerDataOutput("currentTime",w$3),this.currentAnimationGroup=this.registerDataOutput("currentAnimationGroup",b$b),this.animationGroup=this.registerDataInput("animationGroup",b$b,t?.animationGroup),this.animation=this.registerDataInput("animation",b$b),this.object=this.registerDataInput("object",b$b);}_preparePendingTasks(t){const n=this.animationGroup.getValue(t),i=this.animation.getValue(t);if(!n&&!i)return this._reportError(t,"No animation or animation group provided");{const e=this.currentAnimationGroup.getValue(t);e&&e!==n&&e.dispose();let o=n;if(i&&!o){const n=this.object.getValue(t);if(!n)return this._reportError(t,"No target object provided");const e=Array.isArray(i)?i:[i],a=e[0].name;o=new F$2("flowGraphAnimationGroup-"+a+"-"+n.name,t.configuration.scene);let s=false;const u=t._getGlobalContextVariable("interpolationAnimations",[]);for(const t of e)o.addTargetedAnimation(t,n),-1!==u.indexOf(t.uniqueId)&&(s=true);s&&this._checkInterpolationDuplications(t,e,n);}const a=this.speed.getValue(t)||1,s=this.from.getValue(t)??0,u=this.to.getValue(t)||o.to,p=!isFinite(u)||this.loop.getValue(t);this.currentAnimationGroup.setValue(o,t);const m=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);-1!==m.indexOf(o.uniqueId)&&o.stop();try{o.start(p,a,s,u),o.onAnimationGroupEndObservable.add((()=>this._onAnimationGroupEnd(t))),o.onAnimationEndObservable.add((()=>this._eventsSignalOutputs.animationEnd._activateSignal(t))),o.onAnimationLoopObservable.add((()=>this._eventsSignalOutputs.animationLoop._activateSignal(t))),o.onAnimationGroupLoopObservable.add((()=>this._eventsSignalOutputs.animationGroupLoop._activateSignal(t))),m.push(o.uniqueId),t._setGlobalContextVariable("currentlyRunningAnimationGroups",m);}catch(n){this._reportError(t,n);}}}_reportError(t,n){super._reportError(t,n),this.currentFrame.setValue(-1,t),this.currentTime.setValue(-1,t);}_executeOnTick(t){const n=this.currentAnimationGroup.getValue(t);n&&(this.currentFrame.setValue(n.getCurrentFrame(),t),this.currentTime.setValue(n.animatables[0]?.elapsedTime??0,t));}_execute(t){this._startPendingTasks(t);}_onAnimationGroupEnd(t){this._removeFromCurrentlyRunning(t,this.currentAnimationGroup.getValue(t)),this._resetAfterCanceled(t),this.done._activateSignal(t);}_checkInterpolationDuplications(t,n,i){const e=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const o of e){const e=t.assetsContext.animationGroups.find((t=>t.uniqueId===o));if(e)for(const o of e.targetedAnimations)for(const r of n)o.animation.targetProperty===r.targetProperty&&o.target===i&&this._stopAnimationGroup(t,e);}}_stopAnimationGroup(t,n){n.stop(true),n.dispose(),this._removeFromCurrentlyRunning(t,n);}_removeFromCurrentlyRunning(t,n){const i=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),e=i.indexOf(n.uniqueId);-1!==e&&(i.splice(e,1),t._setGlobalContextVariable("currentlyRunningAnimationGroups",i));}_cancelPendingTasks(t){const n=this.currentAnimationGroup.getValue(t);n&&this._stopAnimationGroup(t,n);}getClassName(){return "FlowGraphPlayAnimationBlock"}};P$9("FlowGraphPlayAnimationBlock",a$s);var flowGraphPlayAnimationBlockBNtj_2yo_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphPlayAnimationBlock:a$s});let a$r=class a extends Z$2{constructor(e){super(e),this.animationGroup=this.registerDataInput("animationGroup",b$b),this.stopAtFrame=this.registerDataInput("stopAtFrame",w$3,-1);}_preparePendingTasks(t){const i=this.animationGroup.getValue(t),e=this.stopAtFrame.getValue(t)??-1,n=t._getGlobalContextVariable("pendingStopAnimations",[]);n.push({uniqueId:i.uniqueId,stopAtFrame:e}),t._setGlobalContextVariable("pendingStopAnimations",n);}_cancelPendingTasks(t){const i=this.animationGroup.getValue(t),e=t._getGlobalContextVariable("pendingStopAnimations",[]);for(let n=0;n<e.length;n++)if(e[n].uniqueId===i.uniqueId){e.splice(n,1),t._setGlobalContextVariable("pendingStopAnimations",e);break}}_execute(t){const i=this.animationGroup.getValue(t),n=this.stopAtFrame.getValue(t)??-1;return i?isNaN(n)?this._reportError(t,"Invalid stop time."):(n>0?this._startPendingTasks(t):this._stopAnimation(i,t),void this.out._activateSignal(t)):(Ie$2.Warn("No animation group provided to stop."),this._reportError(t,"No animation group provided to stop."))}_executeOnTick(t){const i=this.animationGroup.getValue(t),e=t._getGlobalContextVariable("pendingStopAnimations",[]);for(let n=0;n<e.length;n++)if(e[n].uniqueId===i.uniqueId&&i.getCurrentFrame()>=e[n].stopAtFrame){this._stopAnimation(i,t),e.splice(n,1),t._setGlobalContextVariable("pendingStopAnimations",e),this.done._activateSignal(t),t._removePendingBlock(this);break}}getClassName(){return "FlowGraphStopAnimationBlock"}_stopAnimation(t,i){const e=i._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),n=e.indexOf(t.uniqueId);-1!==n&&(t.stop(),e.splice(n,1),i._setGlobalContextVariable("currentlyRunningAnimationGroups",e));}};P$9("FlowGraphStopAnimationBlock",a$r);var flowGraphStopAnimationBlockCuu0nFIN_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphStopAnimationBlock:a$r});let i$B=class i extends J$4{constructor(a){super(a),this.animationToPause=this.registerDataInput("animationToPause",b$b);}_execute(a){this.animationToPause.getValue(a).pause(),this.out._activateSignal(a);}getClassName(){return "FlowGraphPauseAnimationBlock"}};P$9("FlowGraphPauseAnimationBlock",i$B);var flowGraphPauseAnimationBlockBq7PJo9Y_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphPauseAnimationBlock:i$B});let u$9=class u extends S$7{constructor(e={}){super(e),this.keyFrames=[];const i="string"==typeof e?.animationType?V$7(e.animationType):P$5(e?.animationType??Qe$1.ANIMATIONTYPE_FLOAT),a=e?.keyFramesCount??1,u=this.registerDataInput("duration_0",w$3,0),l=this.registerDataInput("value_0",i);this.keyFrames.push({duration:u,value:l});for(let t=1;t<a+1;t++){const n=this.registerDataInput(`duration_${t}`,w$3,t===a?e.duration:void 0),s=this.registerDataInput(`value_${t}`,i);this.keyFrames.push({duration:n,value:s});}this.initialValue=this.keyFrames[0].value,this.endValue=this.keyFrames[a].value,this.easingFunction=this.registerDataInput("easingFunction",b$b),this.animation=this.registerDataOutput("animation",b$b),this.propertyName=this.registerDataInput("propertyName",b$b,e?.propertyName),this.customBuildAnimation=this.registerDataInput("customBuildAnimation",b$b);}_updateOutputs(t){const e=t._getGlobalContextVariable("interpolationAnimations",[]),i=this.propertyName.getValue(t),a=this.easingFunction.getValue(t),n=this._createAnimation(t,i,a);if(this.animation.setValue(n,t),Array.isArray(n))for(const t of n)e.push(t.uniqueId);else e.push(n.uniqueId);t._setGlobalContextVariable("interpolationAnimations",e);}_createAnimation(t,i,a){const n=this.initialValue.richType,s=[],r=this.initialValue.getValue(t)||n.defaultValue;s.push({frame:0,value:r});const o=this.config?.numberOfKeyFrames??1;for(let e=1;e<o+1;e++){const i=this.keyFrames[e].duration?.getValue(t);let a=this.keyFrames[e].value?.getValue(t);e===o-1&&(a=a||n.defaultValue),void 0!==i&&a&&s.push({frame:60*i,value:a});}const u=this.customBuildAnimation.getValue(t);if(u)return u(null,null,t)(s,60,n.animationType,a);if("string"==typeof i){const t=zr$1.CreateAnimation(i,n.animationType,60,a);return t.setKeys(s),[t]}return i.map((t=>{const i=zr$1.CreateAnimation(t,n.animationType,60,a);return i.setKeys(s),i}))}getClassName(){return "FlowGraphInterpolationBlock"}};P$9("FlowGraphInterpolationBlock",u$9);var flowGraphInterpolationBlockCJy8o149_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphInterpolationBlock:u$9});let n$I=class n extends X$2{constructor(){super(...arguments),this.initPriority=-1,this.type="SceneReady";}_executeEvent(e,t){return this._execute(e),true}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return "FlowGraphSceneReadyEventBlock"}};P$9("FlowGraphSceneReadyEventBlock",n$I);var flowGraphSceneReadyEventBlockDyzWTyIc_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphSceneReadyEventBlock:n$I});let s$b=class s extends X$2{constructor(){super(),this.type="SceneBeforeRender",this.timeSinceStart=this.registerDataOutput("timeSinceStart",w$3),this.deltaTime=this.registerDataOutput("deltaTime",w$3);}_preparePendingTasks(e){}_executeEvent(e,t){return this.timeSinceStart.setValue(t.timeSinceStart,e),this.deltaTime.setValue(t.deltaTime,e),this._execute(e),true}_cancelPendingTasks(e){}getClassName(){return "FlowGraphSceneTickEventBlock"}};P$9("FlowGraphSceneTickEventBlock",s$b);var flowGraphSceneTickEventBlockD3ks8tOz_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphSceneTickEventBlock:s$b});let i$A=class i extends J$4{constructor(t){super(t),this.config=t;for(const t in this.config.eventData)this.registerDataInput(t,this.config.eventData[t].type,this.config.eventData[t].value);}_execute(t){const e=this.config.eventId,i={};for(const e of this.dataInputs)i[e.name]=e.getValue(t);t.configuration.coordinator.notifyCustomEvent(e,i),this.out._activateSignal(t);}getClassName(){return "FlowGraphReceiveCustomEventBlock"}};P$9("FlowGraphReceiveCustomEventBlock",i$A);var flowGraphSendCustomEventBlockDK1M7FDg_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphSendCustomEventBlock:i$A});let n$H=class n extends X$2{constructor(e){super(e),this.config=e,this.initPriority=1;for(const e in this.config.eventData)this.registerDataOutput(e,this.config.eventData[e].type);}_preparePendingTasks(e){const s=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(s&&s.hasObservers()&&s.observers.length>K$3.MaxEventsPerType)return void this._reportError(e,`FlowGraphReceiveCustomEventBlock: Too many observers for event ${this.config.eventId}. Max is ${K$3.MaxEventsPerType}.`);const o=s.add((t=>{const s=Object.keys(t);for(const o of s)this.getDataOutput(o)?.setValue(t[o],e);this._execute(e);}));e._setExecutionVariable(this,"_eventObserver",o);}_cancelPendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t){const s=e._getExecutionVariable(this,"_eventObserver",null);t.remove(s);}else Ai.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`);}_executeEvent(e,t){return  true}getClassName(){return "FlowGraphReceiveCustomEventBlock"}};P$9("FlowGraphReceiveCustomEventBlock",n$H);var flowGraphReceiveCustomEventBlockDQvFf2RW_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphReceiveCustomEventBlock:n$H});let a$q=class a extends X$2{constructor(e){super(e),this.config=e,this.type="MeshPick",this.asset=this.registerDataInput("asset",b$b,e?.targetMesh),this.pickedPoint=this.registerDataOutput("pickedPoint",d$b),this.pickOrigin=this.registerDataOutput("pickOrigin",d$b),this.pointerId=this.registerDataOutput("pointerId",w$3),this.pickedMesh=this.registerDataOutput("pickedMesh",b$b),this.pointerType=this.registerDataInput("pointerType",b$b,Ar$1.POINTERPICK);}_getReferencedMesh(e){return this.asset.getValue(e)}_executeEvent(e,i){if(this.pointerType.getValue(e)!==i.type)return  true;const s=this._getReferencedMesh(e);return s&&i.pickInfo?.pickedMesh&&(i.pickInfo?.pickedMesh===s||D$6(i.pickInfo?.pickedMesh,s))?(this.pointerId.setValue(i.event.pointerId,e),this.pickOrigin.setValue(i.pickInfo.ray?.origin,e),this.pickedPoint.setValue(i.pickInfo.pickedPoint,e),this.pickedMesh.setValue(i.pickInfo.pickedMesh,e),this._execute(e),!this.config?.stopPropagation):(this.pointerId.resetToDefaultValue(e),this.pickOrigin.resetToDefaultValue(e),this.pickedPoint.resetToDefaultValue(e),this.pickedMesh.resetToDefaultValue(e),true)}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return "FlowGraphMeshPickEventBlock"}};P$9("FlowGraphMeshPickEventBlock",a$q);var flowGraphMeshPickEventBlockEAfJyeJR_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphMeshPickEventBlock:a$q});const i$z="cachedOperationValue",s$a="cachedExecutionId";let a$p=class a extends S$7{constructor(t,i){super(i),this.value=this.registerDataOutput("value",t),this.isValid=this.registerDataOutput("isValid",v$8);}_updateOutputs(t){const e=t._getExecutionVariable(this,s$a,-1),a=t._getExecutionVariable(this,i$z,null);if(null!=a&&e===t.executionId)this.isValid.setValue(true,t),this.value.setValue(a,t);else try{const e=this._doOperation(t);if(null==e)return void this.isValid.setValue(!1,t);t._setExecutionVariable(this,i$z,e),t._setExecutionVariable(this,s$a,t.executionId),this.value.setValue(e,t),this.isValid.setValue(!0,t);}catch(e){this.isValid.setValue(false,t);}}};let s$9=class s extends a$p{constructor(t,s,a,e,r,i){super(a,i),this._operation=e,this._className=r,this.a=this.registerDataInput("a",t),this.b=this.registerDataInput("b",s);}_doOperation(t){const s=this.a.getValue(t),a=this.b.getValue(t);return this._operation(s,a)}getClassName(){return this._className}};let t$s=class t extends a$p{constructor(s,t,a,e,r){super(t,r),this._operation=a,this._className=e,this.a=this.registerDataInput("a",s);}_doOperation(s){return this._operation(this.a.getValue(s))}getClassName(){return this._className}};let _$7=class _ extends a$p{constructor(r,o,e,t){super(r,t),this._operation=o,this._className=e;}_doOperation(r){return this._operation(r)}getClassName(){return this._className}};let g$6=class g extends a$p{constructor(r,o,e,t,a,s,n){super(t,n),this._operation=a,this._className=s,this.a=this.registerDataInput("a",r),this.b=this.registerDataInput("b",o),this.c=this.registerDataInput("c",e);}_doOperation(r){return this._operation(this.a.getValue(r),this.b.getValue(r),this.c.getValue(r))}getClassName(){return this._className}};let M$3=class M extends s$9{constructor(r){super(V$7(r?.type),V$7(r?.type),V$7(r?.type),((r,o)=>this._polymorphicAdd(r,o)),"FlowGraphAddBlock",r);}_polymorphicAdd(o,e){const t=R$8(o),a=R$8(e);if(L$3(t,a)||z$5(t,a)||$$4(t,a))return o.add(e);if("Quaternion"===t||"Vector4"===a)return new ie$5(o.x,o.y,o.z,o.w).addInPlace(e);if("Vector4"===t||"Quaternion"===a)return o.add(e);if(this.config?.preventIntegerFloatArithmetic&&typeof o!=typeof e)throw new Error("Cannot add different types of numbers.");return H$2(o)+H$2(e)}};P$9("FlowGraphAddBlock",M$3);class T extends s$9{constructor(r){super(V$7(r?.type),V$7(r?.type),V$7(r?.type),((r,o)=>this._polymorphicSubtract(r,o)),"FlowGraphSubtractBlock",r);}_polymorphicSubtract(o,e){const t=R$8(o),a=R$8(e);if(L$3(t,a)||$$4(t,a)||z$5(t,a))return o.subtract(e);if("Quaternion"===t||"Vector4"===a)return new ie$5(o.x,o.y,o.z,o.w).subtractInPlace(e);if("Vector4"===t||"Quaternion"===a)return o.subtract(e);if(this.config?.preventIntegerFloatArithmetic&&typeof o!=typeof e)throw new Error("Cannot add different types of numbers.");return H$2(o)-H$2(e)}}P$9("FlowGraphSubtractBlock",T);let I$3=class I extends s$9{constructor(r){super(V$7(r?.type),V$7(r?.type),V$7(r?.type),((r,o)=>this._polymorphicMultiply(r,o)),"FlowGraphMultiplyBlock",r);}_polymorphicMultiply(e,t){const a=R$8(e),s=R$8(t);if(L$3(a,s)||$$4(a,s))return e.multiply(t);if("Quaternion"===a||"Vector4"===s)return new ie$5(e.x,e.y,e.z,e.w).multiplyInPlace(t);if("Vector4"===a||"Quaternion"===s)return e.multiply(t);if(z$5(a,s)){if(this.config?.useMatrixPerComponent){const r=e.m;for(let o=0;o<r.length;o++)r[o]*=t.m[o];return "Matrix2D"===a?new p$d(r):"Matrix3D"===a?new m$d(r):re$5.FromArray(r)}return t.multiply(e)}if(this.config?.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return H$2(e)*H$2(t)}};P$9("FlowGraphMultiplyBlock",I$3);let b$4=class b extends s$9{constructor(r){super(V$7(r?.type),V$7(r?.type),V$7(r?.type),((r,o)=>this._polymorphicDivide(r,o)),"FlowGraphDivideBlock",r);}_polymorphicDivide(e,t){const a=R$8(e),s=R$8(t);if(L$3(a,s)||$$4(a,s))return e.divide(t);if("Quaternion"===a||"Quaternion"===s){const r=e.clone();return r.x/=t.x,r.y/=t.y,r.z/=t.z,r.w/=t.w,r}if("Quaternion"===a||"Vector4"===s)return new ie$5(e.x,e.y,e.z,e.w).divideInPlace(t);if("Vector4"===a||"Quaternion"===s)return e.divide(t);if(z$5(a,s)){if(this.config?.useMatrixPerComponent){const r=e.m;for(let o=0;o<r.length;o++)r[o]/=t.m[o];return "Matrix2D"===a?new p$d(r):"Matrix3D"===a?new m$d(r):re$5.FromArray(r)}return e.divide(t)}if(this.config?.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return H$2(e)/H$2(t)}};P$9("FlowGraphDivideBlock",b$4);let A$3=class A extends _$7{constructor(r){super(w$3,(r=>this._random(r)),"FlowGraphRandomBlock",r),this.min=this.registerDataInput("min",w$3,r?.min??0),this.max=this.registerDataInput("max",w$3,r?.max??1),r?.seed&&(this._seed=r.seed);}_isSeed(r=this._seed){return void 0!==r}_getRandomValue(){if(this._isSeed(this._seed)){const r=1e4*Math.sin(this._seed++);return r-Math.floor(r)}return Math.random()}_random(r){const o=this.min.getValue(r),e=this.max.getValue(r);return this._getRandomValue()*(e-o)+o}};P$9("FlowGraphRandomBlock",A$3);let v$2=class v extends _$7{constructor(r){super(w$3,(()=>Math.E),"FlowGraphEBlock",r);}};P$9("FlowGraphEBlock",v$2);let C$3=class C extends _$7{constructor(r){super(w$3,(()=>Math.PI),"FlowGraphPIBlock",r);}};P$9("FlowGraphPIBlock",C$3);let S$3=class S extends _$7{constructor(r){super(w$3,(()=>Number.POSITIVE_INFINITY),"FlowGraphInfBlock",r);}};P$9("FlowGraphInfBlock",S$3);let N$2=class N extends _$7{constructor(r){super(w$3,(()=>Number.NaN),"FlowGraphNaNBlock",r);}};function R$3(s,n){switch(R$8(s)){case "FlowGraphInteger":return new c$b(n(s.value));case "Vector2":return new ee$4(n(s.x),n(s.y));case "Vector3":return new te$4(n(s.x),n(s.y),n(s.z));case "Vector4":return new ie$5(n(s.x),n(s.y),n(s.z),n(s.w));case "Quaternion":return new se$5(n(s.x),n(s.y),n(s.z),n(s.w));case "Matrix":return re$5.FromArray(s.m.map(n));case "Matrix2D":return new p$d(s.m.map(n));case "Matrix3D":return new m$d(s.m.map(n));default:return n(s)}}P$9("FlowGraphNaNBlock",N$2);let D$4=class D extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicAbs(r)),"FlowGraphAbsBlock",r);}_polymorphicAbs(r){return R$3(r,Math.abs)}};P$9("FlowGraphAbsBlock",D$4);let E$4=class E extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicSign(r)),"FlowGraphSignBlock",r);}_polymorphicSign(r){return R$3(r,Math.sign)}};P$9("FlowGraphSignBlock",E$4);let z$2=class z extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicTrunc(r)),"FlowGraphTruncBlock",r);}_polymorphicTrunc(r){return R$3(r,Math.trunc)}};P$9("FlowGraphTruncBlock",z$2);let V$2=class V extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicFloor(r)),"FlowGraphFloorBlock",r);}_polymorphicFloor(r){return R$3(r,Math.floor)}};P$9("FlowGraphFloorBlock",V$2);class L extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicCeiling(r)),"FlowGraphCeilBlock",r);}_polymorphicCeiling(r){return R$3(r,Math.ceil)}}P$9("FlowGraphCeilBlock",L);let O$3=class O extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicRound(r)),"FlowGraphRoundBlock",r);}_polymorphicRound(r){return R$3(r,(r=>r<0&&this.config?.roundHalfAwayFromZero?-Math.round(-r):Math.round(r)))}};P$9("FlowGraphRoundBlock",O$3);class q extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicFraction(r)),"FlowGraphFractBlock",r);}_polymorphicFraction(r){return R$3(r,(r=>r-Math.floor(r)))}}P$9("FlowGraphFractBlock",q);class P extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicNeg(r)),"FlowGraphNegationBlock",r);}_polymorphicNeg(r){return R$3(r,(r=>-r))}}function j$1(s,n,c){switch(R$8(s)){case "FlowGraphInteger":return new c$b(c(s.value,n.value));case "Vector2":return new ee$4(c(s.x,n.x),c(s.y,n.y));case "Vector3":return new te$4(c(s.x,n.x),c(s.y,n.y),c(s.z,n.z));case "Vector4":return new ie$5(c(s.x,n.x),c(s.y,n.y),c(s.z,n.z),c(s.w,n.w));case "Quaternion":return new se$5(c(s.x,n.x),c(s.y,n.y),c(s.z,n.z),c(s.w,n.w));case "Matrix":return re$5.FromArray(s.m.map(((r,o)=>c(r,n.m[o]))));case "Matrix2D":return new p$d(s.m.map(((r,o)=>c(r,n.m[o]))));case "Matrix3D":return new m$d(s.m.map(((r,o)=>c(r,n.m[o]))));default:return c(H$2(s),H$2(n))}}P$9("FlowGraphNegationBlock",P);let Q$2=class Q extends s$9{constructor(r){super(b$b,b$b,b$b,((r,o)=>this._polymorphicRemainder(r,o)),"FlowGraphModuloBlock",r);}_polymorphicRemainder(r,o){return j$1(r,o,((r,o)=>r%o))}};P$9("FlowGraphModuloBlock",Q$2);class $ extends s$9{constructor(r){super(b$b,b$b,b$b,((r,o)=>this._polymorphicMin(r,o)),"FlowGraphMinBlock",r);}_polymorphicMin(r,o){return j$1(r,o,Math.min)}}P$9("FlowGraphMinBlock",$);class Z extends s$9{constructor(r){super(b$b,b$b,b$b,((r,o)=>this._polymorphicMax(r,o)),"FlowGraphMaxBlock",r);}_polymorphicMax(r,o){return j$1(r,o,Math.max)}}function X(r,o,e){return Math.min(Math.max(r,Math.min(o,e)),Math.max(o,e))}function H(s,n,c,p){switch(R$8(s)){case "FlowGraphInteger":return new c$b(p(s.value,n.value,c.value));case "Vector2":return new ee$4(p(s.x,n.x,c.x),p(s.y,n.y,c.y));case "Vector3":return new te$4(p(s.x,n.x,c.x),p(s.y,n.y,c.y),p(s.z,n.z,c.z));case "Vector4":return new ie$5(p(s.x,n.x,c.x),p(s.y,n.y,c.y),p(s.z,n.z,c.z),p(s.w,n.w,c.w));case "Quaternion":return new se$5(p(s.x,n.x,c.x),p(s.y,n.y,c.y),p(s.z,n.z,c.z),p(s.w,n.w,c.w));case "Matrix":return re$5.FromArray(s.m.map(((r,o)=>p(r,n.m[o],c.m[o]))));case "Matrix2D":return new p$d(s.m.map(((r,o)=>p(r,n.m[o],c.m[o]))));case "Matrix3D":return new m$d(s.m.map(((r,o)=>p(r,n.m[o],c.m[o]))));default:return p(H$2(s),H$2(n),H$2(c))}}P$9("FlowGraphMaxBlock",Z);class K extends g$6{constructor(r){super(b$b,b$b,b$b,b$b,((r,o,e)=>this._polymorphicClamp(r,o,e)),"FlowGraphClampBlock",r);}_polymorphicClamp(r,o,e){return H(r,o,e,X)}}function U(r){return Math.min(Math.max(r,0),1)}P$9("FlowGraphClampBlock",K);class Y extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicSaturate(r)),"FlowGraphSaturateBlock",r);}_polymorphicSaturate(r){return R$3(r,U)}}function J(r,o,e){return (1-e)*r+e*o}P$9("FlowGraphSaturateBlock",Y);class W extends g$6{constructor(r){super(b$b,b$b,b$b,b$b,((r,o,e)=>this._polymorphicInterpolate(r,o,e)),"FlowGraphMathInterpolationBlock",r);}_polymorphicInterpolate(r,o,e){return H(r,o,e,J)}}P$9("FlowGraphMathInterpolationBlock",W);class rr extends s$9{constructor(r){super(b$b,b$b,v$8,((r,o)=>this._polymorphicEq(r,o)),"FlowGraphEqualityBlock",r);}_polymorphicEq(r,o){const e=R$8(r),t=R$8(o);return typeof r==typeof o&&(L$3(e,t)||z$5(e,t)||$$4(e,t)?r.equals(o):r===o)}}function or(r,o,e){if(U$3(r)&&U$3(o))return e(H$2(r),H$2(o));throw new Error(`Cannot compare ${r} and ${o}`)}P$9("FlowGraphEqualityBlock",rr);class er extends s$9{constructor(r){super(b$b,b$b,v$8,((r,o)=>this._polymorphicLessThan(r,o)),"FlowGraphLessThanBlock",r);}_polymorphicLessThan(r,o){return or(r,o,((r,o)=>r<o))}}P$9("FlowGraphLessThanBlock",er);class tr extends s$9{constructor(r){super(b$b,b$b,v$8,((r,o)=>this._polymorphicLessThanOrEqual(r,o)),"FlowGraphLessThanOrEqualBlock",r);}_polymorphicLessThanOrEqual(r,o){return or(r,o,((r,o)=>r<=o))}}P$9("FlowGraphLessThanOrEqualBlock",tr);class ar extends s$9{constructor(r){super(b$b,b$b,v$8,((r,o)=>this._polymorphicGreaterThan(r,o)),"FlowGraphGreaterThanBlock",r);}_polymorphicGreaterThan(r,o){return or(r,o,((r,o)=>r>o))}}P$9("FlowGraphGreaterThanBlock",ar);class sr extends s$9{constructor(r){super(b$b,b$b,v$8,((r,o)=>this._polymorphicGreaterThanOrEqual(r,o)),"FlowGraphGreaterThanOrEqualBlock",r);}_polymorphicGreaterThanOrEqual(r,o){return or(r,o,((r,o)=>r>=o))}}P$9("FlowGraphGreaterThanOrEqualBlock",sr);class nr extends t$s{constructor(r){super(b$b,v$8,(r=>this._polymorphicIsNan(r)),"FlowGraphIsNaNBlock",r);}_polymorphicIsNan(r){if(U$3(r,true))return isNaN(H$2(r));throw new Error(`Cannot get NaN of ${r}`)}}P$9("FlowGraphIsNaNBlock",nr);class lr extends t$s{constructor(r){super(b$b,v$8,(r=>this._polymorphicIsInf(r)),"FlowGraphIsInfBlock",r);}_polymorphicIsInf(r){if(U$3(r))return !isFinite(H$2(r));throw new Error(`Cannot get isInf of ${r}`)}}P$9("FlowGraphIsInfBlock",lr);class cr extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicDegToRad(r)),"FlowGraphDegToRadBlock",r);}_degToRad(r){return r*Math.PI/180}_polymorphicDegToRad(r){return R$3(r,this._degToRad)}}P$9("FlowGraphDegToRadBlock",cr);class pr extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicRadToDeg(r)),"FlowGraphRadToDegBlock",r);}_radToDeg(r){return 180*r/Math.PI}_polymorphicRadToDeg(r){return R$3(r,this._radToDeg)}}P$9("FlowGraphRadToDegBlock",pr);class ir extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicSin(r)),"FlowGraphSinBlock",r);}_polymorphicSin(r){return R$3(r,Math.sin)}}class hr extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicCos(r)),"FlowGraphCosBlock",r);}_polymorphicCos(r){return R$3(r,Math.cos)}}class ur extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicTan(r)),"FlowGraphTanBlock",r);}_polymorphicTan(r){return R$3(r,Math.tan)}}class wr extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicAsin(r)),"FlowGraphASinBlock",r);}_polymorphicAsin(r){return R$3(r,Math.asin)}}P$9("FlowGraphASinBlock",wr);class mr extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicAcos(r)),"FlowGraphACosBlock",r);}_polymorphicAcos(r){return R$3(r,Math.acos)}}P$9("FlowGraphACosBlock",mr);class yr extends t$s{constructor(r){super(w$3,w$3,(r=>this._polymorphicAtan(r)),"FlowGraphATanBlock",r);}_polymorphicAtan(r){return R$3(r,Math.atan)}}P$9("FlowGraphATanBlock",yr);class dr extends s$9{constructor(r){super(b$b,b$b,b$b,((r,o)=>this._polymorphicAtan2(r,o)),"FlowGraphATan2Block",r);}_polymorphicAtan2(r,o){return j$1(r,o,Math.atan2)}}P$9("FlowGraphATan2Block",dr);class Fr extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicSinh(r)),"FlowGraphSinhBlock",r);}_polymorphicSinh(r){return R$3(r,Math.sinh)}}P$9("FlowGraphSinhBlock",Fr);class Gr extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicCosh(r)),"FlowGraphCoshBlock",r);}_polymorphicCosh(r){return R$3(r,Math.cosh)}}P$9("FlowGraphCoshBlock",Gr);class Br extends t$s{constructor(r){super(b$b,b$b,(r=>this._polymorphicTanh(r)),"FlowGraphTanhBlock",r);}_polymorphicTanh(r){return R$3(r,Math.tanh)}}P$9("FlowGraphTanhBlock",Br);class fr extends t$s{constructor(r){super(b$b,w$3,(r=>this._polymorphicAsinh(r)),"FlowGraphASinhBlock",r);}_polymorphicAsinh(r){return R$3(r,Math.asinh)}}P$9("FlowGraphASinhBlock",fr);class xr extends t$s{constructor(r){super(b$b,w$3,(r=>this._polymorphicAcosh(r)),"FlowGraphACoshBlock",r);}_polymorphicAcosh(r){return R$3(r,Math.acosh)}}P$9("FlowGraphACoshBlock",xr);class kr extends t$s{constructor(r){super(b$b,w$3,(r=>this._polymorphicAtanh(r)),"FlowGraphATanhBlock",r);}_polymorphicAtanh(r){return R$3(r,Math.atanh)}}P$9("FlowGraphATanhBlock",kr);class _r extends t$s{constructor(r){super(b$b,w$3,(r=>this._polymorphicExp(r)),"FlowGraphExponentialBlock",r);}_polymorphicExp(r){return R$3(r,Math.exp)}}P$9("FlowGraphExponentialBlock",_r);class gr extends t$s{constructor(r){super(b$b,w$3,(r=>this._polymorphicLog(r)),"FlowGraphLogBlock",r);}_polymorphicLog(r){return R$3(r,Math.log)}}P$9("FlowGraphLogBlock",gr);class Mr extends t$s{constructor(r){super(b$b,w$3,(r=>this._polymorphicLog2(r)),"FlowGraphLog2Block",r);}_polymorphicLog2(r){return R$3(r,Math.log2)}}P$9("FlowGraphLog2Block",Mr);class Tr extends t$s{constructor(r){super(b$b,w$3,(r=>this._polymorphicLog10(r)),"FlowGraphLog10Block",r);}_polymorphicLog10(r){return R$3(r,Math.log10)}}P$9("FlowGraphLog10Block",Tr);class Ir extends t$s{constructor(r){super(b$b,w$3,(r=>this._polymorphicSqrt(r)),"FlowGraphSquareRootBlock",r);}_polymorphicSqrt(r){return R$3(r,Math.sqrt)}}P$9("FlowGraphSquareRootBlock",Ir);class br extends t$s{constructor(r){super(b$b,w$3,(r=>this._polymorphicCubeRoot(r)),"FlowGraphCubeRootBlock",r);}_polymorphicCubeRoot(r){return R$3(r,Math.cbrt)}}P$9("FlowGraphCubeRootBlock",br);class Ar extends s$9{constructor(r){super(b$b,w$3,w$3,((r,o)=>this._polymorphicPow(r,o)),"FlowGraphPowerBlock",r);}_polymorphicPow(r,o){return j$1(r,o,Math.pow)}}P$9("FlowGraphPowerBlock",Ar);class vr extends t$s{constructor(r){super(V$7(r?.valueType||"FlowGraphInteger"),V$7(r?.valueType||"FlowGraphInteger"),(r=>"boolean"==typeof r?!r:"number"==typeof r?~r:new c$b(~r.value)),"FlowGraphBitwiseNotBlock",r);}}P$9("FlowGraphBitwiseNotBlock",vr);class Cr extends s$9{constructor(r){super(V$7(r?.valueType||"FlowGraphInteger"),V$7(r?.valueType||"FlowGraphInteger"),V$7(r?.valueType||"FlowGraphInteger"),((r,o)=>{if("boolean"==typeof r&&"boolean"==typeof o)return r&&o;if("number"==typeof r&&"number"==typeof o)return r&o;if("object"==typeof r&&"object"==typeof o)return new c$b(r.value&o.value);throw new Error(`Cannot perform bitwise AND on ${r} and ${o}`)}),"FlowGraphBitwiseAndBlock",r);}}P$9("FlowGraphBitwiseAndBlock",Cr);class Sr extends s$9{constructor(r){super(V$7(r?.valueType||"FlowGraphInteger"),V$7(r?.valueType||"FlowGraphInteger"),V$7(r?.valueType||"FlowGraphInteger"),((r,o)=>{if("boolean"==typeof r&&"boolean"==typeof o)return r||o;if("number"==typeof r&&"number"==typeof o)return r|o;if("object"==typeof r&&"object"==typeof o)return new c$b(r.value|o.value);throw new Error(`Cannot perform bitwise OR on ${r} and ${o}`)}),"FlowGraphBitwiseOrBlock",r);}}P$9("FlowGraphBitwiseOrBlock",Sr);class Nr extends s$9{constructor(r){super(V$7(r?.valueType||"FlowGraphInteger"),V$7(r?.valueType||"FlowGraphInteger"),V$7(r?.valueType||"FlowGraphInteger"),((r,o)=>{if("boolean"==typeof r&&"boolean"==typeof o)return r!==o;if("number"==typeof r&&"number"==typeof o)return r^o;if("object"==typeof r&&"object"==typeof o)return new c$b(r.value^o.value);throw new Error(`Cannot perform bitwise XOR on ${r} and ${o}`)}),"FlowGraphBitwiseXorBlock",r);}}P$9("FlowGraphBitwiseXorBlock",Nr);class Rr extends s$9{constructor(r){super(_$b,_$b,_$b,((r,o)=>new c$b(r.value<<o.value)),"FlowGraphBitwiseLeftShiftBlock",r);}}P$9("FlowGraphBitwiseLeftShiftBlock",Rr);class Dr extends s$9{constructor(r){super(_$b,_$b,_$b,((r,o)=>new c$b(r.value>>o.value)),"FlowGraphBitwiseRightShiftBlock",r);}}P$9("FlowGraphBitwiseRightShiftBlock",Dr);class Er extends t$s{constructor(r){super(_$b,_$b,(r=>new c$b(Math.clz32(r.value))),"FlowGraphLeadingZerosBlock",r);}}P$9("FlowGraphLeadingZerosBlock",Er);class zr extends t$s{constructor(r){super(_$b,_$b,(r=>new c$b(r.value?31-Math.clz32(r.value&-r.value):32)),"FlowGraphTrailingZerosBlock",r);}}P$9("FlowGraphTrailingZerosBlock",zr);class Vr extends t$s{constructor(r){super(_$b,_$b,(r=>new c$b(function(r){let o=0;for(;r;)o+=1&r,r>>=1;return o}(r.value))),"FlowGraphOneBitsCounterBlock",r);}}P$9("FlowGraphOneBitsCounterBlock",Vr);var flowGraphMathBlocksCYTHni62_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphAbsBlock:D$4,FlowGraphAcosBlock:mr,FlowGraphAcoshBlock:xr,FlowGraphAddBlock:M$3,FlowGraphAsinBlock:wr,FlowGraphAsinhBlock:fr,FlowGraphAtan2Block:dr,FlowGraphAtanBlock:yr,FlowGraphAtanhBlock:kr,FlowGraphBitwiseAndBlock:Cr,FlowGraphBitwiseLeftShiftBlock:Rr,FlowGraphBitwiseNotBlock:vr,FlowGraphBitwiseOrBlock:Sr,FlowGraphBitwiseRightShiftBlock:Dr,FlowGraphBitwiseXorBlock:Nr,FlowGraphCeilBlock:L,FlowGraphClampBlock:K,FlowGraphCosBlock:hr,FlowGraphCoshBlock:Gr,FlowGraphCubeRootBlock:br,FlowGraphDegToRadBlock:cr,FlowGraphDivideBlock:b$4,FlowGraphEBlock:v$2,FlowGraphEqualityBlock:rr,FlowGraphExpBlock:_r,FlowGraphFloorBlock:V$2,FlowGraphFractionBlock:q,FlowGraphGreaterThanBlock:ar,FlowGraphGreaterThanOrEqualBlock:sr,FlowGraphInfBlock:S$3,FlowGraphIsInfinityBlock:lr,FlowGraphIsNanBlock:nr,FlowGraphLeadingZerosBlock:Er,FlowGraphLessThanBlock:er,FlowGraphLessThanOrEqualBlock:tr,FlowGraphLog10Block:Tr,FlowGraphLog2Block:Mr,FlowGraphLogBlock:gr,FlowGraphMathInterpolationBlock:W,FlowGraphMaxBlock:Z,FlowGraphMinBlock:$,FlowGraphModuloBlock:Q$2,FlowGraphMultiplyBlock:I$3,FlowGraphNaNBlock:N$2,FlowGraphNegationBlock:P,FlowGraphOneBitsCounterBlock:Vr,FlowGraphPiBlock:C$3,FlowGraphPowerBlock:Ar,FlowGraphRadToDegBlock:pr,FlowGraphRandomBlock:A$3,FlowGraphRoundBlock:O$3,FlowGraphSaturateBlock:Y,FlowGraphSignBlock:E$4,FlowGraphSinBlock:ir,FlowGraphSinhBlock:Fr,FlowGraphSquareRootBlock:Ir,FlowGraphSubtractBlock:T,FlowGraphTanBlock:ur,FlowGraphTanhBlock:Br,FlowGraphTrailingZerosBlock:zr,FlowGraphTruncBlock:z$2});function g$5(t,o){const e=new se$5;return function(t,o,e){const r=te$4.Cross(t,o),s=Math.acos(U$5(function(t,o){return t.x*o.x+t.y*o.y+t.z*o.z}(t,o),-1,1));se$5.RotationAxisToRef(r,s,e);}(t,o,e),e}const V$1="cachedOperationAxis",F$1="cachedOperationAngle",B$1="cachedExecutionId";let f$a=class f extends t$s{constructor(t){super(b$b,w$3,(t=>this._polymorphicLength(t)),"FlowGraphLengthBlock",t);}_polymorphicLength(t){switch(R$8(t)){case "Vector2":case "Vector3":case "Vector4":case "Quaternion":return t.length();default:throw new Error(`Cannot compute length of value ${t}`)}}};P$9("FlowGraphLengthBlock",f$a);let k$1=class k extends t$s{constructor(t){super(b$b,b$b,(t=>this._polymorphicNormalize(t)),"FlowGraphNormalizeBlock",t);}_polymorphicNormalize(t){let e;switch(R$8(t)){case "Vector2":case "Vector3":case "Vector4":case "Quaternion":if(e=t.normalizeToNew(),this.config?.nanOnZeroLength){0===t.length()&&e.setAll(NaN);}return e;default:throw new Error(`Cannot normalize value ${t}`)}}};P$9("FlowGraphNormalizeBlock",k$1);class G extends s$9{constructor(t){super(b$b,b$b,w$3,((t,o)=>this._polymorphicDot(t,o)),"FlowGraphDotBlock",t);}_polymorphicDot(t,e){switch(R$8(t)){case "Vector2":case "Vector3":case "Vector4":case "Quaternion":return t.dot(e);default:throw new Error(`Cannot get dot product of ${t} and ${e}`)}}}P$9("FlowGraphDotBlock",G);let y$1=class y extends s$9{constructor(t){super(d$b,d$b,d$b,((t,o)=>te$4.Cross(t,o)),"FlowGraphCrossBlock",t);}};P$9("FlowGraphCrossBlock",y$1);let A$2=class A extends s$9{constructor(t){super(k$5,w$3,k$5,((t,o)=>t.rotate(o)),"FlowGraphRotate2DBlock",t);}};P$9("FlowGraphRotate2DBlock",A$2);let D$3=class D extends s$9{constructor(t){super(d$b,I$9,d$b,((t,o)=>t.applyRotationQuaternion(o)),"FlowGraphRotate3DBlock",t);}};function C$2(t,e){switch(R$8(t)){case "Vector2":case "Vector3":return e.transformVector(t);case "Vector4":return new ie$5(t.x*e.m[0]+t.y*e.m[1]+t.z*e.m[2]+t.w*e.m[3],t.x*e.m[4]+t.y*e.m[5]+t.z*e.m[6]+t.w*e.m[7],t.x*e.m[8]+t.y*e.m[9]+t.z*e.m[10]+t.w*e.m[11],t.x*e.m[12]+t.y*e.m[13]+t.z*e.m[14]+t.w*e.m[15]);default:throw new Error(`Cannot transform value ${t}`)}}P$9("FlowGraphRotate3DBlock",D$3);let _$6=class _ extends s$9{constructor(t){const o=t?.vectorType||"Vector3",e="Vector2"===o?"Matrix2D":"Vector3"===o?"Matrix3D":"Matrix";super(V$7(o),V$7(e),V$7(o),C$2,"FlowGraphTransformVectorBlock",t);}};P$9("FlowGraphTransformVectorBlock",_$6);class j extends s$9{constructor(t){super(d$b,F$5,d$b,((t,o)=>te$4.TransformCoordinates(t,o)),"FlowGraphTransformCoordinatesBlock",t);}}P$9("FlowGraphTransformCoordinatesBlock",j);let z$1=class z extends t$s{constructor(t){super(I$9,I$9,(t=>t.conjugate()),"FlowGraphConjugateBlock",t);}};P$9("FlowGraphConjugateBlock",z$1);let E$3=class E extends s$9{constructor(t){super(I$9,I$9,w$3,((t,o)=>{return e=t,r=o,2*Math.acos(U$5(se$5.Dot(e,r)));var e,r;}),"FlowGraphAngleBetweenBlock",t);}};P$9("FlowGraphAngleBetweenBlock",E$3);let O$2=class O extends s$9{constructor(t){super(d$b,w$3,I$9,((t,o)=>se$5.RotationAxis(t,o)),"FlowGraphQuaternionFromAxisAngleBlock",t);}};P$9("FlowGraphQuaternionFromAxisAngleBlock",O$2);let Q$1=class Q extends S$7{constructor(t){super(t),this.a=this.registerDataInput("a",I$9),this.axis=this.registerDataOutput("axis",d$b),this.angle=this.registerDataOutput("angle",w$3),this.isValid=this.registerDataOutput("isValid",v$8);}_updateOutputs(t){const o=t._getExecutionVariable(this,B$1,-1),e=t._getExecutionVariable(this,V$1,null),r=t._getExecutionVariable(this,F$1,null);if(null!=e&&null!=r&&o===t.executionId)this.axis.setValue(e,t),this.angle.setValue(r,t);else try{const{axis:o,angle:e}=this.a.getValue(t).toAxisAngle();t._setExecutionVariable(this,V$1,o),t._setExecutionVariable(this,F$1,e),t._setExecutionVariable(this,B$1,t.executionId),this.axis.setValue(o,t),this.angle.setValue(e,t),this.isValid.setValue(!0,t);}catch(o){this.isValid.setValue(false,t);}}getClassName(){return "FlowGraphAxisAngleFromQuaternionBlock"}};P$9("FlowGraphAxisAngleFromQuaternionBlock",Q$1);let R$2=class R extends s$9{constructor(t){super(d$b,d$b,I$9,((t,o)=>g$5(t,o)),"FlowGraphQuaternionFromDirectionsBlock",t);}};var flowGraphVectorMathBlocksBy2WAaEH_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphAngleBetweenBlock:E$3,FlowGraphAxisAngleFromQuaternionBlock:Q$1,FlowGraphConjugateBlock:z$1,FlowGraphCrossBlock:y$1,FlowGraphDotBlock:G,FlowGraphLengthBlock:f$a,FlowGraphNormalizeBlock:k$1,FlowGraphQuaternionFromAxisAngleBlock:O$2,FlowGraphQuaternionFromDirectionsBlock:R$2,FlowGraphRotate2DBlock:A$2,FlowGraphRotate3DBlock:D$3,FlowGraphTransformBlock:_$6,FlowGraphTransformCoordinatesBlock:j});let x$2=class x extends t$s{constructor(t){super(V$7(t?.matrixType||"Matrix"),V$7(t?.matrixType||"Matrix"),(t=>t.transpose?t.transpose():re$5.Transpose(t)),"FlowGraphTransposeBlock",t);}};P$9("FlowGraphTransposeBlock",x$2);let m$7=class m extends t$s{constructor(t){super(V$7(t?.matrixType||"Matrix"),w$3,(t=>t.determinant()),"FlowGraphDeterminantBlock",t);}};P$9("FlowGraphDeterminantBlock",m$7);let d$6=class d extends t$s{constructor(t){super(V$7(t?.matrixType||"Matrix"),V$7(t?.matrixType||"Matrix"),(t=>t.inverse?t.inverse():re$5.Invert(t)),"FlowGraphInvertMatrixBlock",t);}};P$9("FlowGraphInvertMatrixBlock",d$6);let g$4=class g extends s$9{constructor(t){super(V$7(t?.matrixType||"Matrix"),V$7(t?.matrixType||"Matrix"),V$7(t?.matrixType||"Matrix"),((t,e)=>e.multiply(t)),"FlowGraphMatrixMultiplicationBlock",t);}};P$9("FlowGraphMatrixMultiplicationBlock",g$4);class V extends S$7{constructor(t){super(t),this.input=this.registerDataInput("input",F$5),this.position=this.registerDataOutput("position",d$b),this.rotationQuaternion=this.registerDataOutput("rotationQuaternion",I$9),this.scaling=this.registerDataOutput("scaling",d$b),this.isValid=this.registerDataOutput("isValid",v$8,false);}_updateOutputs(t){const e=t._getExecutionVariable(this,"executionId",-1),i=t._getExecutionVariable(this,"cachedPosition",null),a=t._getExecutionVariable(this,"cachedRotation",null),s=t._getExecutionVariable(this,"cachedScaling",null);if(e===t.executionId&&i&&a&&s)this.position.setValue(i,t),this.rotationQuaternion.setValue(a,t),this.scaling.setValue(s,t);else {const e=this.input.getValue(t),o=i||new te$4,r=a||new se$5,n=s||new te$4,c=Math.round(1e4*e.m[3])/1e4,p=Math.round(1e4*e.m[7])/1e4,h=Math.round(1e4*e.m[11])/1e4,x=Math.round(1e4*e.m[15])/1e4;if(0!==c||0!==p||0!==h||1!==x)return this.isValid.setValue(false,t),this.position.setValue(te$4.Zero(),t),this.rotationQuaternion.setValue(se$5.Identity(),t),void this.scaling.setValue(te$4.One(),t);const m=e.decompose(n,r,o);this.isValid.setValue(m,t),this.position.setValue(o,t),this.rotationQuaternion.setValue(r,t),this.scaling.setValue(n,t),t._setExecutionVariable(this,"cachedPosition",o),t._setExecutionVariable(this,"cachedRotation",r),t._setExecutionVariable(this,"cachedScaling",n),t._setExecutionVariable(this,"executionId",t.executionId);}}getClassName(){return "FlowGraphMatrixDecompose"}}P$9("FlowGraphMatrixDecompose",V);let M$2=class M extends S$7{constructor(t){super(t),this.position=this.registerDataInput("position",d$b),this.rotationQuaternion=this.registerDataInput("rotationQuaternion",I$9),this.scaling=this.registerDataInput("scaling",d$b),this.value=this.registerDataOutput("value",F$5);}_updateOutputs(t){const e=t._getExecutionVariable(this,"executionId",-1),i=t._getExecutionVariable(this,"cachedMatrix",null);if(e===t.executionId&&i)this.value.setValue(i,t);else {const e=re$5.Compose(this.scaling.getValue(t),this.rotationQuaternion.getValue(t),this.position.getValue(t));this.value.setValue(e,t),t._setExecutionVariable(this,"cachedMatrix",e),t._setExecutionVariable(this,"executionId",t.executionId);}}getClassName(){return "FlowGraphMatrixCompose"}};P$9("FlowGraphMatrixCompose",M$2);var flowGraphMatrixMathBlocksBPTxkuPQ_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphDeterminantBlock:m$7,FlowGraphInvertMatrixBlock:d$6,FlowGraphMatrixComposeBlock:M$2,FlowGraphMatrixDecomposeBlock:V,FlowGraphMatrixMultiplicationBlock:g$4,FlowGraphTransposeBlock:x$2});let s$8=class s extends A$8{constructor(i){super(i),this.condition=this.registerDataInput("condition",v$8),this.onTrue=this._registerSignalOutput("onTrue"),this.onFalse=this._registerSignalOutput("onFalse");}_execute(t){this.condition.getValue(t)?this.onTrue._activateSignal(t):this.onFalse._activateSignal(t);}getClassName(){return "FlowGraphBranchBlock"}};P$9("FlowGraphBranchBlock",s$8);var flowGraphBranchBlockB2jn6oMT_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphBranchBlock:s$8});var o$y;!function(e){e[e.INIT=0]="INIT",e[e.STARTED=1]="STARTED",e[e.ENDED=2]="ENDED";}(o$y||(o$y={}));let l$8=class l{constructor(e){this.onEachCountObservable=new R$g,this.onTimerAbortedObservable=new R$g,this.onTimerEndedObservable=new R$g,this.onStateChangedObservable=new R$g,this._observer=null,this._breakOnNextTick=false,this._tick=e=>{const t=Date.now();this._timer=t-this._startTime;const s={startTime:this._startTime,currentTime:t,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:e},i=this._breakOnNextTick||this._breakCondition(s);i||this._timer>=this._timeToEnd?this._stop(s,i):this.onEachCountObservable.notifyObservers(s);},this._setState(0),this._contextObservable=e.contextObservable,this._observableParameters=e.observableParameters??{},this._breakCondition=e.breakCondition??(()=>false),this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted);}set breakCondition(e){this._breakCondition=e;}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear();}start(e=this._timeToEnd){if(1===this._state)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(1);}stop(){1===this._state&&(this._breakOnNextTick=true);}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables();}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state);}_stop(e,t=false){this._contextObservable.remove(this._observer),this._setState(2),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e);}};let b$3=class b extends Z$2{constructor(e){super(e),this.cancel=this._registerSignalInput("cancel"),this.duration=this.registerDataInput("duration",w$3),this.lastDelayIndex=this.registerDataOutput("lastDelayIndex",_$b,new c$b(-1));}_preparePendingTasks(e){const t=this.duration.getValue(e);if(t<0||isNaN(t)||!isFinite(t))return this._reportError(e,"Invalid duration in SetDelay block");if(e._getGlobalContextVariable("activeDelays",0)>=b.MaxParallelDelayCount)return this._reportError(e,"Max parallel delays reached");const s=e._getGlobalContextVariable("lastDelayIndex",-1),a=e._getExecutionVariable(this,"pendingDelays",[]),n=e.configuration.scene,r=new l$8({timeout:1e3*t,contextObservable:n.onBeforeRenderObservable,onEnded:()=>this._onEnded(r,e)});r.start();const o=s+1;this.lastDelayIndex.setValue(new c$b(o),e),e._setGlobalContextVariable("lastDelayIndex",o),a[o]=r,e._setExecutionVariable(this,"pendingDelays",a),this._updateGlobalTimers(e);}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"pendingDelays",[]);for(const e of t)e?.dispose();e._deleteExecutionVariable(this,"pendingDelays"),this.lastDelayIndex.setValue(new c$b(-1),e),this._updateGlobalTimers(e);}_execute(e,t){t!==this.cancel?(this._preparePendingTasks(e),this.out._activateSignal(e)):this._cancelPendingTasks(e);}getClassName(){return "FlowGraphSetDelayBlock"}_onEnded(e,t){const s=t._getExecutionVariable(this,"pendingDelays",[]),i=s.indexOf(e);-1!==i?s.splice(i,1):Ie$2.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.done._activateSignal(t),this._updateGlobalTimers(t);}_updateGlobalTimers(e){const t=e._getExecutionVariable(this,"pendingDelays",[]),s=e._getGlobalContextVariable("pendingDelays",[]);for(let e=0;e<t.length;e++){if(!t[e])continue;const i=t[e];s[e]&&s[e]!==i?Ie$2.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"):s[e]=i;}e._setGlobalContextVariable("pendingDelays",s);}};b$3.MaxParallelDelayCount=100,P$9("FlowGraphSetDelayBlock",b$3);var flowGraphSetDelayBlockBk29OEvG_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphSetDelayBlock:b$3});let s$7=class s extends J$4{constructor(e){super(e),this.delayIndex=this.registerDataInput("delayIndex",_$b);}_execute(e,t){const i=H$2(this.delayIndex.getValue(e));if(i<=0||isNaN(i)||!isFinite(i))return this._reportError(e,"Invalid delay index");const s=e._getGlobalContextVariable("pendingDelays",[])[i];s&&s.dispose(),this.out._activateSignal(e);}getClassName(){return "FlowGraphCancelDelayBlock"}};P$9("FlowGraphCancelDelayBlock",s$7);var flowGraphCancelDelayBlockBymck2nB_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphCancelDelayBlock:s$7});let i$y=class i extends J$4{constructor(e){super(e),this.count=this.registerDataOutput("count",w$3),this.reset=this._registerSignalInput("reset");}_execute(t,e){if(e===this.reset)return t._setExecutionVariable(this,"count",0),void this.count.setValue(0,t);const s=t._getExecutionVariable(this,"count",0)+1;t._setExecutionVariable(this,"count",s),this.count.setValue(s,t),this.out._activateSignal(t);}getClassName(){return "FlowGraphCallCounterBlock"}};P$9("FlowGraphCallCounterBlock",i$y);var flowGraphCounterBlockCJGxxHrp_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphCallCounterBlock:i$y});let s$6=class s extends J$4{constructor(e){super(e),this.count=this.registerDataInput("count",w$3),this.reset=this._registerSignalInput("reset"),this.currentCount=this.registerDataOutput("currentCount",w$3);}_execute(t,e){if(e===this.reset)return void t._setExecutionVariable(this,"debounceCount",0);const i=this.count.getValue(t),s=t._getExecutionVariable(this,"debounceCount",0)+1;this.currentCount.setValue(s,t),t._setExecutionVariable(this,"debounceCount",s),s>=i&&(this.out._activateSignal(t),t._setExecutionVariable(this,"debounceCount",0));}getClassName(){return "FlowGraphDebounceBlock"}};P$9("FlowGraphDebounceBlock",s$6);var flowGraphDebounceBlockDB3Kxk8t_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphDebounceBlock:s$6});let a$o=class a extends J$4{constructor(i){super(i),this.reset=this._registerSignalInput("reset"),this.duration=this.registerDataInput("duration",w$3),this.lastRemainingTime=this.registerDataOutput("lastRemainingTime",w$3,NaN);}_execute(t,i){if(i===this.reset)return this.lastRemainingTime.setValue(NaN,t),t._setExecutionVariable(this,"lastRemainingTime",NaN),void t._setExecutionVariable(this,"timestamp",0);const e=this.duration.getValue(t);if(e<=0||isNaN(e)||!isFinite(e))return this._reportError(t,"Invalid duration in Throttle block");const a=t._getExecutionVariable(this,"lastRemainingTime",NaN),s=Date.now();if(isNaN(a))return this.lastRemainingTime.setValue(0,t),t._setExecutionVariable(this,"lastRemainingTime",0),t._setExecutionVariable(this,"timestamp",s),this.out._activateSignal(t);{const i=s-t._getExecutionVariable(this,"timestamp",0),a=1e3*e;if(a<=i)return this.lastRemainingTime.setValue(0,t),t._setExecutionVariable(this,"lastRemainingTime",0),t._setExecutionVariable(this,"timestamp",s),this.out._activateSignal(t);{const e=a-i;this.lastRemainingTime.setValue(e/1e3,t),t._setExecutionVariable(this,"lastRemainingTime",e);}}}getClassName(){return "FlowGraphThrottleBlock"}};P$9("FlowGraphThrottleBlock",a$o);var flowGraphThrottleBlockIzkMKHp3_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphThrottleBlock:a$o});let n$G=class n extends J$4{constructor(s={}){super(s),this.config=s,this.config.startIndex=s.startIndex??new c$b(0),this.reset=this._registerSignalInput("reset"),this.maxExecutions=this.registerDataInput("maxExecutions",_$b),this.executionCount=this.registerDataOutput("executionCount",_$b,new c$b(0));}_execute(e,s){if(s===this.reset)this.executionCount.setValue(this.config.startIndex,e);else {const s=this.executionCount.getValue(e);s.value<this.maxExecutions.getValue(e).value&&(this.executionCount.setValue(new c$b(s.value+1),e),this.out._activateSignal(e));}}getClassName(){return "FlowGraphDoNBlock"}};P$9("FlowGraphDoNBlock",n$G);var flowGraphDoNBlockBDeG1rCu_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphDoNBlock:n$G});let a$n=class a extends A$8{constructor(t){super(t),this.onOn=this._registerSignalOutput("onOn"),this.onOff=this._registerSignalOutput("onOff"),this.value=this.registerDataOutput("value",v$8);}_execute(t,e){let i=t._getExecutionVariable(this,"value","boolean"==typeof this.config?.startValue&&!this.config.startValue);i=!i,t._setExecutionVariable(this,"value",i),this.value.setValue(i,t),i?this.onOn._activateSignal(t):this.onOff._activateSignal(t);}getClassName(){return "FlowGraphFlipFlopBlock"}};P$9("FlowGraphFlipFlopBlock",a$n);var flowGraphFlipFlopBlockBSPp6ryu_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphFlipFlopBlock:a$n});let r$Q=class r extends J$4{constructor(t){super(t),this.startIndex=this.registerDataInput("startIndex",b$b,0),this.endIndex=this.registerDataInput("endIndex",b$b),this.step=this.registerDataInput("step",w$3,1),this.index=this.registerDataOutput("index",_$b,new c$b(H$2(t?.initialIndex??0))),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out");}_execute(t){const i=H$2(this.startIndex.getValue(t)),s=this.step.getValue(t);let n=H$2(this.endIndex.getValue(t));for(let o=i;o<n&&(this.index.setValue(new c$b(o),t),this.executionFlow._activateSignal(t),n=H$2(this.endIndex.getValue(t)),!(o>r.MaxLoopIterations*s));o+=s);this.config?.incrementIndexWhenLoopDone&&this.index.setValue(new c$b(H$2(this.index.getValue(t))+s),t),this.completed._activateSignal(t);}getClassName(){return "FlowGraphForLoopBlock"}};r$Q.MaxLoopIterations=1e3,P$9("FlowGraphForLoopBlock",r$Q);var flowGraphForLoopBlockCWDLu2Bj_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphForLoopBlock:r$Q});let n$F=class n extends A$8{constructor(t){super(t),this.config=t,this.outputSignals=[],this.reset=this._registerSignalInput("reset"),this.lastIndex=this.registerDataOutput("lastIndex",_$b,new c$b(-1)),this.setNumberOfOutputSignals(t?.outputSignalCount);}_getNextIndex(t){if(t.includes(false)||this.config.isLoop&&t.fill(false),this.config.isRandom){const i=t.map(((t,i)=>t?-1:i)).filter((t=>-1!==t));return i.length?i[Math.floor(Math.random()*i.length)]:-1}return t.indexOf(false)}setNumberOfOutputSignals(t=1){for(;this.outputSignals.length>t;){const t=this.outputSignals.pop();t&&(t.disconnectFromAll(),this._unregisterSignalOutput(t.name));}for(;this.outputSignals.length<t;)this.outputSignals.push(this._registerSignalOutput(`out_${this.outputSignals.length}`));}_execute(t,i){if(t._hasExecutionVariable(this,"indexesUsed")||t._setExecutionVariable(this,"indexesUsed",this.outputSignals.map((()=>false))),i===this.reset)return t._deleteExecutionVariable(this,"indexesUsed"),void this.lastIndex.setValue(new c$b(-1),t);const e=t._getExecutionVariable(this,"indexesUsed",[]),n=this._getNextIndex(e);n>-1&&(this.lastIndex.setValue(new c$b(n),t),e[n]=true,t._setExecutionVariable(this,"indexesUsed",e),this.outputSignals[n]._activateSignal(t));}getClassName(){return "FlowGraphMultiGateBlock"}serialize(t){super.serialize(t),t.config.outputSignalCount=this.config.outputSignalCount,t.config.isRandom=this.config.isRandom,t.config.loop=this.config.isLoop,t.config.startIndex=this.config.startIndex;}};P$9("FlowGraphMultiGateBlock",n$F);var flowGraphMultiGateBlockLawZTnoo_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphMultiGateBlock:n$F});let i$x=class i extends A$8{constructor(t){super(t),this.config=t,this.executionSignals=[],this.setNumberOfOutputSignals(this.config.outputSignalCount);}_execute(t){for(let e=0;e<this.executionSignals.length;e++)this.executionSignals[e]._activateSignal(t);}setNumberOfOutputSignals(t=1){for(;this.executionSignals.length>t;){const t=this.executionSignals.pop();t&&(t.disconnectFromAll(),this._unregisterSignalOutput(t.name));}for(;this.executionSignals.length<t;)this.executionSignals.push(this._registerSignalOutput(`out_${this.executionSignals.length}`));}getClassName(){return "FlowGraphSequenceBlock"}};P$9("FlowGraphSequenceBlock",i$x);var flowGraphSequenceBlockCLKhwn2_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphSequenceBlock:i$x});let o$x=class o extends A$8{constructor(t){super(t),this.config=t,this.default=this._registerSignalOutput("default"),this._caseToOutputFlow=new Map,this.case=this.registerDataInput("case",b$b);const s=this.config.cases||[];for(const t of s)this._caseToOutputFlow.set(t,this._registerSignalOutput(`out_${t}`));}_execute(t,i){const a=this.case.getValue(t);let o;o=U$3(a)?this._getOutputFlowForCase(H$2(a)):this._getOutputFlowForCase(a),o?o._activateSignal(t):this.default._activateSignal(t);}addCase(t){this.config.cases.includes(t)||(this.config.cases.push(t),this._caseToOutputFlow.set(t,this._registerSignalOutput(`out_${t}`)));}removeCase(t){if(!this.config.cases.includes(t))return;const s=this.config.cases.indexOf(t);this.config.cases.splice(s,1),this._caseToOutputFlow.delete(t);}_getOutputFlowForCase(t){return this._caseToOutputFlow.get(t)}getClassName(){return "FlowGraphSwitchBlock"}serialize(t){super.serialize(t),t.cases=this.config.cases;}};P$9("FlowGraphSwitchBlock",o$x);var flowGraphSwitchBlockZecWrsuu_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphSwitchBlock:o$x});let s$5=class s extends J$4{constructor(t){super(t),this.config=t,this.inFlows=[],this._cachedActivationState=[],this.reset=this._registerSignalInput("reset"),this.completed=this._registerSignalOutput("completed"),this.remainingInputs=this.registerDataOutput("remainingInputs",_$b,new c$b(this.config.inputSignalCount||0));for(let t=0;t<this.config.inputSignalCount;t++)this.inFlows.push(this._registerSignalInput(`in_${t}`));this._unregisterSignalInput("in");}_getCurrentActivationState(t){const i=this._cachedActivationState;if(i.length=0,t._hasExecutionVariable(this,"activationState")){const e=t._getExecutionVariable(this,"activationState",[]);for(let t=0;t<e.length;t++)i.push(e[t]);}else for(let t=0;t<this.config.inputSignalCount;t++)i.push(false);return i}_execute(t,i){const e=this._getCurrentActivationState(t);if(i===this.reset)for(let t=0;t<this.config.inputSignalCount;t++)e[t]=false;else {const t=this.inFlows.indexOf(i);t>=0&&(e[t]=true);}if(this.remainingInputs.setValue(new c$b(e.filter((t=>!t)).length),t),t._setExecutionVariable(this,"activationState",e.slice()),e.includes(false))i!==this.reset&&this.out._activateSignal(t);else {this.completed._activateSignal(t);for(let t=0;t<this.config.inputSignalCount;t++)e[t]=false;}}getClassName(){return "FlowGraphWaitAllBlock"}serialize(t){super.serialize(t),t.config.inputFlows=this.config.inputSignalCount;}};P$9("FlowGraphWaitAllBlock",s$5);var flowGraphWaitAllBlockNaI49ef8_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphWaitAllBlock:s$5});let a$m=class a extends J$4{constructor(i){super(i),this.config=i,this.condition=this.registerDataInput("condition",v$8),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out");}_execute(t,e){let o=this.condition.getValue(t);this.config?.doWhile&&!o&&this.executionFlow._activateSignal(t);let n=0;for(;o;){if(this.executionFlow._activateSignal(t),++n,n>=a.MaxLoopCount){Ie$2.Warn("FlowGraphWhileLoopBlock: Max loop count reached. Breaking.");break}o=this.condition.getValue(t);}this.completed._activateSignal(t);}getClassName(){return "FlowGraphWhileLoopBlock"}};a$m.MaxLoopCount=1e3,P$9("FlowGraphWhileLoopBlock",a$m);var flowGraphWhileLoopBlockNwXUIADD_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphWhileLoopBlock:a$m});let o$w=class o extends J$4{constructor(e){if(super(e),this.message=this.registerDataInput("message",b$b),this.logType=this.registerDataInput("logType",b$b,"log"),e?.messageTemplate){const s=this._getTemplateMatches(e.messageTemplate);for(const e of s)this.registerDataInput(e,b$b);}}_execute(e){const t=this.logType.getValue(e),a=this._getMessageValue(e);"warn"===t?Ie$2.Warn(a):"error"===t?Ie$2.Error(a):Ie$2.Log(a),this.out._activateSignal(e);}getClassName(){return "FlowGraphConsoleLogBlock"}_getMessageValue(e){if(this.config?.messageTemplate){let t=this.config.messageTemplate;const s=this._getTemplateMatches(t);for(const a of s){const s=this.getDataInput(a)?.getValue(e);void 0!==s&&(t=t.replace(new RegExp(`\\{${a}\\}`,"g"),s.toString()));}return t}return this.message.getValue(e)}_getTemplateMatches(e){const t=/\{([^}]+)\}/g,s=[];let a;for(;null!==(a=t.exec(e));)s.push(a[1]);return s}};P$9("FlowGraphConsoleLogBlock",o$w);var flowGraphConsoleLogBlockDWsmqu2O_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphConsoleLogBlock:o$w});let o$v=class o extends S$7{constructor(t){super(t),this.condition=this.registerDataInput("condition",v$8),this.onTrue=this.registerDataInput("onTrue",b$b),this.onFalse=this.registerDataInput("onFalse",b$b),this.output=this.registerDataOutput("output",b$b);}_updateOutputs(t){const s=this.condition.getValue(t);this.output.setValue(s?this.onTrue.getValue(t):this.onFalse.getValue(t),t);}getClassName(){return "FlowGraphConditionalBlock"}};P$9("FlowGraphConditionalBlock",o$v);var flowGraphConditionalDataBlockC5_x0TCJ_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphConditionalDataBlock:o$v});let o$u=class o extends S$7{constructor(t){super(t),this.config=t,this.output=this.registerDataOutput("output",A$9(t.value));}_updateOutputs(t){this.output.setValue(this.config.value,t);}getClassName(){return "FlowGraphConstantBlock"}serialize(t={},e=v$7){super.serialize(t),e("value",this.config.value,t.config);}};P$9("FlowGraphConstantBlock",o$u);var flowGraphConstantBlockB3nzkc9c_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphConstantBlock:o$u});let a$l=class a extends S$7{constructor(t){super(t),this.sourceSystem=this.registerDataInput("sourceSystem",b$b),this.destinationSystem=this.registerDataInput("destinationSystem",b$b),this.inputCoordinates=this.registerDataInput("inputCoordinates",d$b),this.outputCoordinates=this.registerDataOutput("outputCoordinates",d$b);}_updateOutputs(t){const s=this.sourceSystem.getValue(t),e=this.destinationSystem.getValue(t),r=this.inputCoordinates.getValue(t),a=s.getWorldMatrix(),n=e.getWorldMatrix(),m=ae$5.Matrix[0].copyFrom(n);m.invert();const u=ae$5.Matrix[1];m.multiplyToRef(a,u);const p=this.outputCoordinates.getValue(t);te$4.TransformCoordinatesToRef(r,u,p);}getClassName(){return "FlowGraphTransformCoordinatesSystemBlock"}};P$9("FlowGraphTransformCoordinatesSystemBlock",a$l);var flowGraphTransformCoordinatesSystemBlockBUvepez9_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphTransformCoordinatesSystemBlock:a$l});let r$P=class r extends S$7{constructor(t){super(t),this.config=t,this.type=this.registerDataInput("type",b$b,t.type),this.value=this.registerDataOutput("value",b$b),this.index=this.registerDataInput("index",b$b,new c$b(H$2(t.index??-1)));}_updateOutputs(t){const i=this.type.getValue(t),a=this.index.getValue(t),n=M$8(t.assetsContext,i,H$2(a),this.config.useIndexAsUniqueId);this.value.setValue(n,t);}getClassName(){return "FlowGraphGetAssetBlock"}};P$9("FlowGraphGetAssetBlock",r$P);var flowGraphGetAssetBlockDz4HiN6__esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphGetAssetBlock:r$P});let o$t=class o extends a$p{constructor(e){super(b$b,e),this.config=e,this.object=this.registerDataInput("object",b$b,e.object),this.propertyName=this.registerDataInput("propertyName",b$b,e.propertyName),this.customGetFunction=this.registerDataInput("customGetFunction",b$b);}_doOperation(t){const e=this.customGetFunction.getValue(t);let r;if(e)r=e(this.object.getValue(t),this.propertyName.getValue(t),t);else {const e=this.object.getValue(t),o=this.propertyName.getValue(t);r=e&&o?this._getPropertyValue(e,o):void 0;}return r}_getPropertyValue(t,e){const r=e.split(".");let o=t;for(const t of r)if(o=o[t],void 0===o)return;return o}getClassName(){return "FlowGraphGetPropertyBlock"}};P$9("FlowGraphGetPropertyBlock",o$t);var flowGraphGetPropertyBlockBNf9w9e3_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphGetPropertyBlock:o$t});let i$w=class i extends J$4{constructor(t){super(t),this.config=t,this.object=this.registerDataInput("object",b$b,t.target),this.value=this.registerDataInput("value",b$b),this.propertyName=this.registerDataInput("propertyName",b$b,t.propertyName),this.customSetFunction=this.registerDataInput("customSetFunction",b$b);}_execute(t,e){try{const e=this.object.getValue(t),o=this.value.getValue(t),i=this.propertyName.getValue(t);this._stopRunningAnimations(t,e,i);const s=this.customSetFunction.getValue(t);s?s(e,i,o,t):this._setPropertyValue(e,i,o);}catch(e){this._reportError(t,e);}this.out._activateSignal(t);}_stopRunningAnimations(t,e,o){const i=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const s of i){const n=t.assetsContext.animationGroups.find((t=>t.uniqueId===s));if(n)for(const r of n.targetedAnimations)if(r.target===e&&r.animation.targetProperty===o){n.stop(true),n.dispose();const e=i.indexOf(s);-1!==e&&(i.splice(e,1),t._setGlobalContextVariable("currentlyRunningAnimationGroups",i));}}}_setPropertyValue(t,e,o){const i=e.split(".");let s=t;for(let t=0;t<i.length-1;t++){const e=i[t];void 0===s[e]&&(s[e]={}),s=s[e];}s[i[i.length-1]]=o;}getClassName(){return "FlowGraphSetPropertyBlock"}};P$9("FlowGraphSetPropertyBlock",i$w);var flowGraphSetPropertyBlock17XIYH8y_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphSetPropertyBlock:i$w});let t$r=class t extends S$7{constructor(e){super(e),this.config=e,this.value=this.registerDataOutput("value",b$b,e.initialValue);}_updateOutputs(e){const a=this.config.variable;e.hasVariable(a)&&this.value.setValue(e.getVariable(a),e);}serialize(e){super.serialize(e),e.config.variable=this.config.variable;}getClassName(){return "FlowGraphGetVariableBlock"}};P$9("FlowGraphGetVariableBlock",t$r);var flowGraphGetVariableBlockBtCYEhV1_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphGetVariableBlock:t$r});let t$q=class t extends J$4{constructor(a){if(super(a),!a.variable&&!a.variables)throw new Error("FlowGraphSetVariableBlock: variable/variables is not defined");if(a.variables&&a.variable)throw new Error("FlowGraphSetVariableBlock: variable and variables are both defined");if(a.variables)for(const e of a.variables)this.registerDataInput(e,b$b);else this.registerDataInput("value",b$b);}_execute(a,e){if(this.config?.variables)for(const e of this.config.variables)this._saveVariable(a,e);else this._saveVariable(a,this.config?.variable,"value");this.out._activateSignal(a);}_saveVariable(a,e,i){const t=a._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const i of t){const r=a.assetsContext.animationGroups.find((a=>a.uniqueId==i));if(r)for(const s of r.targetedAnimations)if(s.target===a&&s.animation.targetProperty===e){r.stop();const e=t.indexOf(i);e>-1&&t.splice(e,1),a._setGlobalContextVariable("currentlyRunningAnimationGroups",t);break}}const r=this.getDataInput(i||e)?.getValue(a);a.setVariable(e,r);}getClassName(){return "FlowGraphSetVariableBlock"}serialize(a){super.serialize(a),a.config.variable=this.config?.variable;}};P$9("FlowGraphSetVariableBlock",t$q);var flowGraphSetVariableBlockDKnN4a0W_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphSetVariableBlock:t$q});const c$9=new RegExp(/\/\{(\w+)\}(?=\/|$)/g);let l$7=class l{constructor(o,n){this.path=o,this.ownerBlock=n,this.templatedInputs=[];let r=c$9.exec(o);const i=new Set;for(;r;){const[,s]=r;if(i.has(s))throw new Error("Duplicate template variable detected.");i.add(s),this.templatedInputs.push(n.registerDataInput(s,_$b,new c$b(0))),r=c$9.exec(o);}}getAccessor(t,e){let o=this.path;for(const t of this.templatedInputs){const n=t.getValue(e).value;if("number"!=typeof n||n<0)throw new Error("Invalid value for templated input.");o=o.replace(`{${t.name}}`,n.toString());}return t.convert(o)}};let h$3=class h extends a$p{constructor(t){super(b$b,t),this.config=t,this.object=this.registerDataOutput("object",b$b),this.propertyName=this.registerDataOutput("propertyName",b$b),this.setterFunction=this.registerDataOutput("setFunction",b$b,this._setPropertyValue.bind(this)),this.getterFunction=this.registerDataOutput("getFunction",b$b,this._getPropertyValue.bind(this)),this.generateAnimationsFunction=this.registerDataOutput("generateAnimationsFunction",b$b,this._getInterpolationAnimationPropertyInfo.bind(this)),this.templateComponent=new l$7(t.jsonPointer,this);}_doOperation(t){const e=this.templateComponent.getAccessor(this.config.pathConverter,t),o=e.info.get(e.object),n=e.info.getTarget?.(e.object),r=e.info.getPropertyName?.[0](e.object);if(!n)throw new Error("Object is undefined");return this.object.setValue(n,t),r&&this.propertyName.setValue(r,t),o}_setPropertyValue(t,e,o,n){const r=this.templateComponent.getAccessor(this.config.pathConverter,n),i=r.info.type;i.startsWith("Color")&&(o=u$8(o,i)),r.info.set?.(o,r.object);}_getPropertyValue(t,e,o){const a=this.templateComponent.getAccessor(this.config.pathConverter,o),p=a.info.type,c=a.info.get(a.object);return p.startsWith("Color")?function(t){if(t instanceof ge$3)return new te$4(t.r,t.g,t.b);if(t instanceof me$3)return new ie$5(t.r,t.g,t.b,t.a);throw new Error("Invalid color type")}(c):c}_getInterpolationAnimationPropertyInfo(t,e,o){const n=this.templateComponent.getAccessor(this.config.pathConverter,o);return (t,e,o,r)=>{const i=[],s=n.info.type;return s.startsWith("Color")&&(t=t.map((t=>({frame:t.frame,value:u$8(t.value,s)})))),n.info.interpolation?.forEach(((e,s)=>{const a=n.info.getPropertyName?.[s](n.object)||"Animation-interpolation-"+s;let p=t;o!==e.type&&(p=t.map((t=>({frame:t.frame,value:e.getValue(void 0,t.value.asArray?t.value.asArray():[t.value],0,1)}))));const c=e.buildAnimations(n.object,a,60,p);for(const t of c)r&&t.babylonAnimation.setEasingFunction(r),i.push(t.babylonAnimation);})),i}}getClassName(){return "FlowGraphJsonPointerParserBlock"}};function u$8(t,e){return t.getClassName().startsWith("Color")?t:"Color3"===e?new ge$3(t.x,t.y,t.z):"Color4"===e?new me$3(t.x,t.y,t.z,t.w):t}P$9("FlowGraphJsonPointerParserBlock",h$3);var flowGraphJsonPointerParserBlockClF7CkDG_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphJsonPointerParserBlock:h$3});let D$2=class D extends a$p{constructor(t,e,a){super(e,a);for(let e=0;e<t;e++)this.registerDataInput(`input_${e}`,w$3,0);}};let I$2=class I extends S$7{constructor(t,e,a){super(a),this.registerDataInput("input",e);for(let e=0;e<t;e++)this.registerDataOutput(`output_${e}`,w$3,0);}};let x$1=class x extends D$2{constructor(t){super(2,k$5,t);}_doOperation(t){t._hasExecutionVariable(this,"cachedVector")||t._setExecutionVariable(this,"cachedVector",new ee$4);const e=t._getExecutionVariable(this,"cachedVector",null);return e.set(this.getDataInput("input_0").getValue(t),this.getDataInput("input_1").getValue(t)),e}getClassName(){return "FlowGraphCombineVector2Block"}};P$9("FlowGraphCombineVector2Block",x$1);let m$6=class m extends D$2{constructor(t){super(3,d$b,t);}_doOperation(t){t._hasExecutionVariable(this,"cachedVector")||t._setExecutionVariable(this,"cachedVector",new te$4);const e=t._getExecutionVariable(this,"cachedVector",null);return e.set(this.getDataInput("input_0").getValue(t),this.getDataInput("input_1").getValue(t),this.getDataInput("input_2").getValue(t)),e}getClassName(){return "FlowGraphCombineVector3Block"}};P$9("FlowGraphCombineVector3Block",m$6);let d$5=class d extends D$2{constructor(t){super(4,B$5,t);}_doOperation(t){t._hasExecutionVariable(this,"cachedVector")||t._setExecutionVariable(this,"cachedVector",new ie$5);const e=t._getExecutionVariable(this,"cachedVector",null);return e.set(this.getDataInput("input_0").getValue(t),this.getDataInput("input_1").getValue(t),this.getDataInput("input_2").getValue(t),this.getDataInput("input_3").getValue(t)),e}getClassName(){return "FlowGraphCombineVector4Block"}};P$9("FlowGraphCombineVector4Block",d$5);let w$1=class w extends D$2{constructor(t){super(16,F$5,t);}_doOperation(t){t._hasExecutionVariable(this,"cachedMatrix")||t._setExecutionVariable(this,"cachedMatrix",new re$5);const e=t._getExecutionVariable(this,"cachedMatrix",null);return this.config?.inputIsColumnMajor?e.set(this.getDataInput("input_0").getValue(t),this.getDataInput("input_4").getValue(t),this.getDataInput("input_8").getValue(t),this.getDataInput("input_12").getValue(t),this.getDataInput("input_1").getValue(t),this.getDataInput("input_5").getValue(t),this.getDataInput("input_9").getValue(t),this.getDataInput("input_13").getValue(t),this.getDataInput("input_2").getValue(t),this.getDataInput("input_6").getValue(t),this.getDataInput("input_10").getValue(t),this.getDataInput("input_14").getValue(t),this.getDataInput("input_3").getValue(t),this.getDataInput("input_7").getValue(t),this.getDataInput("input_11").getValue(t),this.getDataInput("input_15").getValue(t)):e.set(this.getDataInput("input_0").getValue(t),this.getDataInput("input_1").getValue(t),this.getDataInput("input_2").getValue(t),this.getDataInput("input_3").getValue(t),this.getDataInput("input_4").getValue(t),this.getDataInput("input_5").getValue(t),this.getDataInput("input_6").getValue(t),this.getDataInput("input_7").getValue(t),this.getDataInput("input_8").getValue(t),this.getDataInput("input_9").getValue(t),this.getDataInput("input_10").getValue(t),this.getDataInput("input_11").getValue(t),this.getDataInput("input_12").getValue(t),this.getDataInput("input_13").getValue(t),this.getDataInput("input_14").getValue(t),this.getDataInput("input_15").getValue(t)),e}getClassName(){return "FlowGraphCombineMatrixBlock"}};P$9("FlowGraphCombineMatrixBlock",w$1);let b$2=class b extends D$2{constructor(t){super(4,y$7,t);}_doOperation(t){t._hasExecutionVariable(this,"cachedMatrix")||t._setExecutionVariable(this,"cachedMatrix",new p$d);const e=t._getExecutionVariable(this,"cachedMatrix",null),a=this.config?.inputIsColumnMajor?[this.getDataInput("input_0").getValue(t),this.getDataInput("input_2").getValue(t),this.getDataInput("input_1").getValue(t),this.getDataInput("input_3").getValue(t)]:[this.getDataInput("input_0").getValue(t),this.getDataInput("input_1").getValue(t),this.getDataInput("input_2").getValue(t),this.getDataInput("input_3").getValue(t)];return e.fromArray(a),e}getClassName(){return "FlowGraphCombineMatrix2DBlock"}};P$9("FlowGraphCombineMatrix2DBlock",b$2);let E$2=class E extends D$2{constructor(t){super(9,T$7,t);}_doOperation(t){t._hasExecutionVariable(this,"cachedMatrix")||t._setExecutionVariable(this,"cachedMatrix",new m$d);const e=t._getExecutionVariable(this,"cachedMatrix",null),a=this.config?.inputIsColumnMajor?[this.getDataInput("input_0").getValue(t),this.getDataInput("input_3").getValue(t),this.getDataInput("input_6").getValue(t),this.getDataInput("input_1").getValue(t),this.getDataInput("input_4").getValue(t),this.getDataInput("input_7").getValue(t),this.getDataInput("input_2").getValue(t),this.getDataInput("input_5").getValue(t),this.getDataInput("input_8").getValue(t)]:[this.getDataInput("input_0").getValue(t),this.getDataInput("input_1").getValue(t),this.getDataInput("input_2").getValue(t),this.getDataInput("input_3").getValue(t),this.getDataInput("input_4").getValue(t),this.getDataInput("input_5").getValue(t),this.getDataInput("input_6").getValue(t),this.getDataInput("input_7").getValue(t),this.getDataInput("input_8").getValue(t)];return e.fromArray(a),e}getClassName(){return "FlowGraphCombineMatrix3DBlock"}};P$9("FlowGraphCombineMatrix3DBlock",E$2);let C$1=class C extends I$2{constructor(t){super(2,k$5,t);}_updateOutputs(t){let e=this.getDataInput("input")?.getValue(t);e||(e=ee$4.Zero(),this.getDataInput("input").setValue(e,t)),this.getDataOutput("output_0").setValue(e.x,t),this.getDataOutput("output_1").setValue(e.y,t);}getClassName(){return "FlowGraphExtractVector2Block"}};P$9("FlowGraphExtractVector2Block",C$1);let M$1=class M extends I$2{constructor(t){super(3,d$b,t);}_updateOutputs(t){let e=this.getDataInput("input")?.getValue(t);e||(e=te$4.Zero(),this.getDataInput("input").setValue(e,t)),this.getDataOutput("output_0").setValue(e.x,t),this.getDataOutput("output_1").setValue(e.y,t),this.getDataOutput("output_2").setValue(e.z,t);}getClassName(){return "FlowGraphExtractVector3Block"}};P$9("FlowGraphExtractVector3Block",M$1);class F extends I$2{constructor(t){super(4,B$5,t);}_updateOutputs(t){let e=this.getDataInput("input")?.getValue(t);e||(e=ie$5.Zero(),this.getDataInput("input").setValue(e,t)),this.getDataOutput("output_0").setValue(e.x,t),this.getDataOutput("output_1").setValue(e.y,t),this.getDataOutput("output_2").setValue(e.z,t),this.getDataOutput("output_3").setValue(e.w,t);}getClassName(){return "FlowGraphExtractVector4Block"}}P$9("FlowGraphExtractVector4Block",F);let O$1=class O extends I$2{constructor(t){super(16,F$5,t);}_updateOutputs(t){let e=this.getDataInput("input")?.getValue(t);e||(e=re$5.Identity(),this.getDataInput("input").setValue(e,t));for(let a=0;a<16;a++)this.getDataOutput(`output_${a}`).setValue(e.m[a],t);}getClassName(){return "FlowGraphExtractMatrixBlock"}};P$9("FlowGraphExtractMatrixBlock",O$1);class k extends I$2{constructor(t){super(4,y$7,t);}_updateOutputs(t){let e=this.getDataInput("input")?.getValue(t);e||(e=new p$d,this.getDataInput("input").setValue(e,t));for(let a=0;a<4;a++)this.getDataOutput(`output_${a}`).setValue(e.m[a],t);}getClassName(){return "FlowGraphExtractMatrix2DBlock"}}P$9("FlowGraphExtractMatrix2DBlock",k);class B extends I$2{constructor(t){super(9,T$7,t);}_updateOutputs(t){let e=this.getDataInput("input")?.getValue(t);e||(e=new m$d,this.getDataInput("input").setValue(e,t));for(let a=0;a<9;a++)this.getDataOutput(`output_${a}`).setValue(e.m[a],t);}getClassName(){return "FlowGraphExtractMatrix3DBlock"}}P$9("FlowGraphExtractMatrix3DBlock",B);var flowGraphMathCombineExtractBlocksJio90hAi_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphCombineMatrix2DBlock:b$2,FlowGraphCombineMatrix3DBlock:E$2,FlowGraphCombineMatrixBlock:w$1,FlowGraphCombineVector2Block:x$1,FlowGraphCombineVector3Block:m$6,FlowGraphCombineVector4Block:d$5,FlowGraphExtractMatrix2DBlock:k,FlowGraphExtractMatrix3DBlock:B,FlowGraphExtractMatrixBlock:O$1,FlowGraphExtractVector2Block:C$1,FlowGraphExtractVector3Block:M$1,FlowGraphExtractVector4Block:F});let l$6=class l extends t$s{constructor(o){super(v$8,w$3,(o=>+o),"FlowGraphBooleanToFloat",o);}};P$9("FlowGraphBooleanToFloat",l$6);let n$E=class n extends t$s{constructor(o){super(v$8,_$b,(o=>c$b.FromValue(+o)),"FlowGraphBooleanToInt",o);}};P$9("FlowGraphBooleanToInt",n$E);let p$7=class p extends t$s{constructor(o){super(w$3,v$8,(o=>!!o),"FlowGraphFloatToBoolean",o);}};P$9("FlowGraphFloatToBoolean",p$7);let c$8=class c extends t$s{constructor(o){super(_$b,v$8,(o=>!!o.value),"FlowGraphIntToBoolean",o);}};P$9("FlowGraphIntToBoolean",c$8);let u$7=class u extends t$s{constructor(o){super(_$b,w$3,(o=>o.value),"FlowGraphIntToFloat",o);}};P$9("FlowGraphIntToFloat",u$7);let m$5=class m extends t$s{constructor(o){super(w$3,_$b,(r=>{const a=o?.roundingMode;switch(a){case "floor":return c$b.FromValue(Math.floor(r));case "ceil":return c$b.FromValue(Math.ceil(r));case "round":return c$b.FromValue(Math.round(r));default:return c$b.FromValue(r)}}),"FlowGraphFloatToInt",o);}};P$9("FlowGraphFloatToInt",m$5);var flowGraphTypeToTypeBlocksDTO8hY8f_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphBooleanToFloat:l$6,FlowGraphBooleanToInt:n$E,FlowGraphFloatToBoolean:p$7,FlowGraphFloatToInt:m$5,FlowGraphIntToBoolean:c$8,FlowGraphIntToFloat:u$7});var p$6;!function(e){e[e.CircleEase=0]="CircleEase",e[e.BackEase=1]="BackEase",e[e.BounceEase=2]="BounceEase",e[e.CubicEase=3]="CubicEase",e[e.ElasticEase=4]="ElasticEase",e[e.ExponentialEase=5]="ExponentialEase",e[e.PowerEase=6]="PowerEase",e[e.QuadraticEase=7]="QuadraticEase",e[e.QuarticEase=8]="QuarticEase",e[e.QuinticEase=9]="QuinticEase",e[e.SineEase=10]="SineEase",e[e.BezierCurveEase=11]="BezierCurveEase";}(p$6||(p$6={}));let m$4=class m extends S$7{constructor(e){super(e),this.config=e,this._easingFunctions={},this.type=this.registerDataInput("type",b$b,11),this.mode=this.registerDataInput("mode",w$3,0),this.parameters=this.registerDataInput("parameters",b$b,[1,0,0,1]),this.easingFunction=this.registerDataOutput("easingFunction",b$b);}_updateOutputs(c){const o=this.type.getValue(c),u=this.mode.getValue(c),E=this.parameters.getValue(c);if(void 0===o||void 0===u)return;const p=`${o}-${u}-${E.join("-")}`;if(!this._easingFunctions[p]){const c=function(c,...o){switch(c){case 11:return new Fr$1(...o);case 0:return new Cr$1;case 1:return new vr$1(...o);case 2:return new Pr(...o);case 3:return new Or;case 4:return new Dr$1(...o);case 5:return new Lr(...o);default:throw new Error("Easing type not yet implemented")}}(o,...E);c.setEasingMode(u),this._easingFunctions[p]=c;}this.easingFunction.setValue(this._easingFunctions[p],c);}getClassName(){return "FlowGraphEasingBlock"}};P$9("FlowGraphEasingBlock",m$4);var flowGraphEasingBlock24qarDNy_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,get EasingFunctionType(){return p$6},FlowGraphEasingBlock:m$4});let a$k=class a extends S$7{constructor(t){super(t),this.config=t,this._easingFunctions={},this.mode=this.registerDataInput("mode",w$3,0),this.controlPoint1=this.registerDataInput("controlPoint1",k$5),this.controlPoint2=this.registerDataInput("controlPoint2",k$5),this.easingFunction=this.registerDataOutput("easingFunction",b$b);}_updateOutputs(i){const s=this.mode.getValue(i),n=this.controlPoint1.getValue(i),e=this.controlPoint2.getValue(i);if(void 0===s)return;const o=`${s}-${n.x}-${n.y}-${e.x}-${e.y}`;if(!this._easingFunctions[o]){const i=new Fr$1(n.x,n.y,e.x,e.y);i.setEasingMode(s),this._easingFunctions[o]=i;}this.easingFunction.setValue(this._easingFunctions[o],i);}getClassName(){return "FlowGraphBezierCurveEasing"}};P$9("FlowGraphBezierCurveEasing",a$k);var flowGraphBezierCurveEasingBlockDmiEWNWm_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphBezierCurveEasingBlock:a$k});let n$D=class n extends X$2{constructor(e){super(e),this.type="PointerOver",this.pointerId=this.registerDataOutput("pointerId",w$3),this.targetMesh=this.registerDataInput("targetMesh",b$b,e?.targetMesh),this.meshUnderPointer=this.registerDataOutput("meshUnderPointer",b$b);}_executeEvent(e,s){const r=this.targetMesh.getValue(e);this.meshUnderPointer.setValue(s.mesh,e);const i=s.out&&D$6(s.out,r);return this.pointerId.setValue(s.pointerId,e),!(!i&&(s.mesh===r||D$6(s.mesh,r)))||(this._execute(e),!this.config?.stopPropagation)}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return "FlowGraphPointerOverEventBlock"}};P$9("FlowGraphPointerOverEventBlock",n$D);var flowGraphPointerOverEventBlockB6KbkTUI_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphPointerOverEventBlock:n$D});let a$j=class a extends X$2{constructor(t){super(t),this.type="PointerOut",this.pointerId=this.registerDataOutput("pointerId",w$3),this.targetMesh=this.registerDataInput("targetMesh",b$b,t?.targetMesh),this.meshOutOfPointer=this.registerDataOutput("meshOutOfPointer",b$b);}_executeEvent(t,s){const r=this.targetMesh.getValue(t);this.meshOutOfPointer.setValue(s.mesh,t),this.pointerId.setValue(s.pointerId,t);return !((!s.over||!D$6(s.mesh,r))&&(s.mesh===r||D$6(s.mesh,r)))||(this._execute(t),!this.config?.stopPropagation)}_preparePendingTasks(t){}_cancelPendingTasks(t){}getClassName(){return "FlowGraphPointerOutEventBlock"}};P$9("FlowGraphPointerOutEventBlock",a$j);var flowGraphPointerOutEventBlock4SC9TIrI_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphPointerOutEventBlock:a$j});let r$O=class r extends S$7{constructor(e){super(e),this.userVariables=this.registerDataOutput("userVariables",b$b),this.executionId=this.registerDataOutput("executionId",w$3);}_updateOutputs(e){this.userVariables.setValue(e.userVariables,e),this.executionId.setValue(e.executionId,e);}serialize(e){super.serialize(e);}getClassName(){return "FlowGraphContextBlock"}};P$9("FlowGraphContextBlock",r$O);var flowGraphContextBlockC3zRewlc_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphContextBlock:r$O});let i$v=class i extends S$7{constructor(e){super(e),this.config=e,this.array=this.registerDataInput("array",b$b),this.index=this.registerDataInput("index",b$b,new c$b(-1)),this.value=this.registerDataOutput("value",b$b);}_updateOutputs(e){const s=this.array.getValue(e),a=H$2(this.index.getValue(e));s&&a>=0&&a<s.length?this.value.setValue(s[a],e):this.value.setValue(null,e);}serialize(e){super.serialize(e);}getClassName(){return "FlowGraphArrayIndexBlock"}};P$9("FlowGraphArrayIndexBlock",i$v);var flowGraphArrayIndexBlockVCj_pQ3g_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphArrayIndexBlock:i$v});let s$4=class s extends S$7{constructor(t){super(t),this.config=t,this.executionFunction=this.registerDataInput("function",b$b),this.value=this.registerDataInput("value",b$b),this.result=this.registerDataOutput("result",b$b);}_updateOutputs(t){const e=this.executionFunction.getValue(t),s=this.value.getValue(t);e&&this.result.setValue(e(s,t),t);}getClassName(){return "FlowGraphCodeExecutionBlock"}};var flowGraphCodeExecutionBlockDvYos2Gi_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphCodeExecutionBlock:s$4});let r$N=class r extends S$7{constructor(e){super(e),this.config=e,this.object=this.registerDataInput("object",b$b),this.array=this.registerDataInput("array",b$b),this.index=this.registerDataOutput("index",_$b,new c$b(-1));}_updateOutputs(e){const t=this.object.getValue(e),s=this.array.getValue(e);s&&this.index.setValue(new c$b(s.indexOf(t)),e);}serialize(e){super.serialize(e);}getClassName(){return "FlowGraphIndexOfBlock"}};P$9("FlowGraphIndexOfBlock",r$N);var flowGraphIndexOfBlockWf9Ra9iC_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphIndexOfBlock:r$N});let n$C=class n extends S$7{constructor(t){super(t),this.functionName=this.registerDataInput("functionName",g$c),this.object=this.registerDataInput("object",b$b),this.context=this.registerDataInput("context",b$b,null),this.output=this.registerDataOutput("output",b$b);}_updateOutputs(t){const e=this.functionName.getValue(t),s=this.object.getValue(t),i=this.context.getValue(t);if(s&&e){const n=s[e];n&&"function"==typeof n&&this.output.setValue(n.bind(i),t);}}getClassName(){return "FlowGraphFunctionReference"}};P$9("FlowGraphFunctionReference",n$C);var flowGraphFunctionReferenceBlockCOA_kkZr_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphFunctionReferenceBlock:n$C});let r$M=class r extends S$7{constructor(t){super(t),this.config=t,this._inputCases=new Map,this.case=this.registerDataInput("case",b$b,NaN),this.default=this.registerDataInput("default",b$b),this.value=this.registerDataOutput("value",b$b);const e=this.config.cases||[];for(let t of e){if(t=H$2(t),this.config.treatCasesAsIntegers&&(t|=0,this._inputCases.has(t)))return;this._inputCases.set(t,this.registerDataInput(`in_${t}`,b$b));}}_updateOutputs(t){const a=this.case.getValue(t);let i;U$3(a)&&(i=this._getOutputValueForCase(H$2(a),t)),i||(i=this.default.getValue(t)),this.value.setValue(i,t);}_getOutputValueForCase(t,s){return this._inputCases.get(t)?.getValue(s)}getClassName(){return "FlowGraphDataSwitchBlock"}};P$9("FlowGraphDataSwitchBlock",r$M);var flowGraphDataSwitchBlockJZTza8mo_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphDataSwitchBlock:r$M});let o$s=class o extends S$7{constructor(t){super();const o=t.glTF,a=o.animations?.map((t=>t._babylonAnimationGroup))||[];this.animationGroups=this.registerDataOutput("animationGroups",b$b,a);const i=o.nodes?.map((t=>t._babylonTransformNode))||[];this.nodes=this.registerDataOutput("nodes",b$b,i);}getClassName(){return "FlowGraphGLTFDataProvider"}};var flowGraphGLTFDataProviderD8lCle4__esm_min=/*#__PURE__*/Object.freeze({__proto__:null,FlowGraphGLTFDataProvider:o$s});let n$B=class n extends P$3{constructor(e,t){super(e,t,3);}connect(e){if(!this._connect(e))throw new Error("Connect failed")}disconnect(e){if(!this._disconnect(e))throw new Error("Disconnect failed")}disconnectAll(){if(!this._downstreamNodes)throw new Error("Disconnect failed");const e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next())if(!this._disconnect(t.value))throw new Error("Disconnect failed")}};const o$r={volume:1};let i$u=class i extends n$B{constructor(e){super("Volume",e);}setOptions(e){this.volume=e.volume??o$r.volume;}};function r$L(e){return e.getSubNode("Volume")}const a$i=2048,u$6=-100,c$7=-30,l$5=.8;let d$4=class d{get frequencyBinCount(){return this.fftSize/2}};let h$2=class h extends n$B{constructor(e){super("Analyzer",e);}setOptions(e){this.fftSize=e.analyzerFFTSize??a$i,this.minDecibels=e.analyzerMinDecibels??u$6,this.maxDecibels=e.analyzerMaxDecibels??c$7,this.smoothing=e.analyzerSmoothing??l$5;}};function _$5(e){return e.getSubNode("Analyzer")}function b$1(e,t,s){e.callOnSubNode("Analyzer",(e=>{e[t]=s;}));}let y=null,m$3=null;function N$1(){return y||(y=new Uint8Array),y}function f$9(){return m$3||(m$3=new Float32Array),m$3}let p$5=class p extends d$4{constructor(e){super(),this._fftSize=a$i,this._maxDecibels=c$7,this._minDecibels=u$6,this._smoothing=l$5,this._subGraph=e;}get fftSize(){return this._fftSize}set fftSize(e){this._fftSize=e,b$1(this._subGraph,"fftSize",e);}get isEnabled(){return null!==_$5(this._subGraph)}get minDecibels(){return this._minDecibels}set minDecibels(e){this._minDecibels=e,b$1(this._subGraph,"minDecibels",e);}get maxDecibels(){return this._maxDecibels}set maxDecibels(e){this._maxDecibels=e,b$1(this._subGraph,"maxDecibels",e);}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,b$1(this._subGraph,"smoothing",e);}dispose(){const e=_$5(this._subGraph);e&&(this._subGraph.removeSubNodeAsync(e),e.dispose());}async enableAsync(){_$5(this._subGraph)||await this._subGraph.createAndAddSubNodeAsync("Analyzer");}getByteFrequencyData(){const e=_$5(this._subGraph);return e?e.getByteFrequencyData():(Ie$2.Warn("AudioAnalyzer not enabled"),this.enableAsync(),N$1())}getFloatFrequencyData(){const e=_$5(this._subGraph);return e?e.getFloatFrequencyData():(Ie$2.Warn("AudioAnalyzer not enabled"),this.enableAsync(),f$9())}};let D$1=class D extends P$3{constructor(e,t,s){super(e,t,s),this._analyzer=null;}get analyzer(){return this._analyzer??(this._analyzer=new p$5(this._subGraph))}get volume(){return e=this._subGraph,t="volume",r$L(e)?.[t]??o$r[t];var e,t;}set volume(e){const t=r$L(this._subGraph);if(!t)throw new Error("No volume subnode");t.volume=e;}dispose(){super.dispose(),this._analyzer?.dispose(),this._analyzer=null,this._subGraph.dispose();}setVolume(e,t=null){const s=r$L(this._subGraph);if(!s)throw new Error("No volume subnode");s.setVolume(e,t);}};let g$3=class g{constructor(){this._createSubNodePromises={},this._isDisposed=false,this._subNodes={},this._onSubNodeDisposed=e=>{const t=e;delete this._subNodes[t.name],this._onSubNodesChanged();};}callOnSubNode(e,t){const s=this.getSubNode(e);s?t(s):this._createSubNodePromisesResolvedAsync().then((()=>{const s=this.getSubNode(e);s?t(s):this.createAndAddSubNodeAsync(e).then((e=>{t(e);}));}));}createAndAddSubNodeAsync(e){return this._createSubNodePromises[e]||=this._createSubNode(e).then((e=>(this._addSubNode(e),e))),this._createSubNodePromises[e]}dispose(){this._isDisposed=true;const e=Object.values(this._subNodes);for(const t of e)t.dispose();this._subNodes={},this._createSubNodePromises={};}getSubNode(e){return this._subNodes[e]??null}async removeSubNodeAsync(e){await this._createSubNodePromisesResolvedAsync();const t=e.name;this._subNodes[t]&&delete this._subNodes[t],delete this._createSubNodePromises[t],this._onSubNodesChanged();}async _createSubNodePromisesResolvedAsync(){return await Promise.all(Object.values(this._createSubNodePromises))}_addSubNode(e){this._isDisposed?e.dispose():(this._subNodes[e.name]=e,e.onDisposeObservable.addOnce(this._onSubNodeDisposed),this._onSubNodesChanged());}};class z extends i$u{constructor(e){super(e);const s=this.node=new GainNode(e._audioContext);this._volume=new w$2(e,s.gain);}dispose(){super.dispose(),this._volume.dispose();}get volume(){return this._volume.value}set volume(e){this.setVolume(e);}get _inNode(){return this.node}get _outNode(){return this.node}setVolume(e,t=null){this._volume.setTargetValue(e,t);}_connect(e){return !!super._connect(e)&&(e._inNode&&this.node.connect(e._inNode),true)}_disconnect(e){return !!super._disconnect(e)&&(e._inNode&&this.node.disconnect(e._inNode),true)}getClassName(){return "_VolumeWebAudioSubNode"}}let S$2=class S extends h$2{constructor(e){super(e),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode=new AnalyserNode(e._audioContext);}get fftSize(){return this._analyzerNode.fftSize}set fftSize(e){e!==this._analyzerNode.fftSize&&(this._analyzerNode.fftSize=e,this._clearArrays());}get _inNode(){return this._analyzerNode}get minDecibels(){return this._analyzerNode.minDecibels}set minDecibels(e){this._analyzerNode.minDecibels=e;}get maxDecibels(){return this._analyzerNode.maxDecibels}set maxDecibels(e){this._analyzerNode.maxDecibels=e;}get smoothing(){return this._analyzerNode.smoothingTimeConstant}set smoothing(e){this._analyzerNode.smoothingTimeConstant=e;}dispose(){super.dispose(),this._clearArrays(),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode.disconnect();}getClassName(){return "_WebAudioAnalyzerSubNode"}getByteFrequencyData(){return this._byteFrequencyData&&0!==this._byteFrequencyData.length||(this._byteFrequencyData=new Uint8Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getByteFrequencyData(this._byteFrequencyData),this._byteFrequencyData}getFloatFrequencyData(){return this._floatFrequencyData&&0!==this._floatFrequencyData.length||(this._floatFrequencyData=new Float32Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getFloatFrequencyData(this._floatFrequencyData),this._floatFrequencyData}_clearArrays(){this._byteFrequencyData?.set(N$1()),this._floatFrequencyData?.set(f$9());}};let A$1=class A extends g$3{constructor(e){super(),this._outputNode=null,this._owner=e;}async initAsync(e){const t=function(e){return e.analyzerEnabled||void 0!==e.analyzerFFTSize||void 0!==e.analyzerMinDecibels||void 0!==e.analyzerMaxDecibels||void 0!==e.analyzerSmoothing}(e);if(t&&await this.createAndAddSubNodeAsync("Analyzer"),await this.createAndAddSubNodeAsync("Volume"),await this._createSubNodePromisesResolvedAsync(),t){const t=_$5(this);if(!t)throw new Error("No analyzer subnode.");t.setOptions(e);}const s=r$L(this);if(!s)throw new Error("No volume subnode.");if(s.setOptions(e),"_VolumeWebAudioSubNode"!==s.getClassName())throw new Error("Not a WebAudio subnode.");if(this._outputNode=s.node,this._outputNode&&this._downstreamNodes){const e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next()){const e=t.value._inNode;e&&this._outputNode.connect(e);}}}get _inNode(){return this._outputNode}get _outNode(){return this._outputNode}_createSubNode(e){switch(e){case "Analyzer":return async function(e){return new S$2(e)}(this._owner.engine);case "Volume":return async function(e){return new z(e)}(this._owner.engine);default:throw new Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){const e=_$5(this),t=r$L(this);e&&t&&t.connect(e);}};let e$a=class e extends D$1{constructor(s,e){super(s,e,3);}};const h$1={coneInnerAngle:6.28318530718,coneOuterAngle:6.28318530718,coneOuterVolume:0,distanceModel:"linear",maxDistance:1e4,minDistance:1,panningModel:"equalpower",position:te$4.Zero(),rolloffFactor:1,rotation:te$4.Zero(),rotationQuaternion:new se$5};function c$6(t){return t.spatialEnabled||void 0!==t.spatialAutoUpdate||void 0!==t.spatialConeInnerAngle||void 0!==t.spatialConeOuterAngle||void 0!==t.spatialConeOuterVolume||void 0!==t.spatialDistanceModel||void 0!==t.spatialMaxDistance||void 0!==t.spatialMinDistance||void 0!==t.spatialMinUpdateTime||void 0!==t.spatialPanningModel||void 0!==t.spatialPosition||void 0!==t.spatialRolloffFactor||void 0!==t.spatialRotation||void 0!==t.spatialRotationQuaternion}let d$3=class d{};const l$4=0;let p$4=class p{};let _$4=class _ extends n$B{constructor(t){super("Stereo",t);}setOptions(t){this.pan=t.stereoPan??l$4;}};function m$2(t){return t.getSubNode("Stereo")}let g$2=class g extends p$4{constructor(t){super(),this._pan=l$4,this._subGraph=t;}get pan(){return this._pan}set pan(t){this._pan=t,function(t,e,n){t.callOnSubNode("Stereo",(t=>{t[e]=n;}));}(this._subGraph,"pan",t);}};class A extends n$B{constructor(t){super("Spatial",t),this._attacherComponent=null;}get isAttached(){return null!==this._attacherComponent&&this._attacherComponent.isAttached}attach(t,e,n){this.detach(),this._attacherComponent||(this._attacherComponent=new h$4(this)),this._attacherComponent.attach(t,e,n);}detach(){this._attacherComponent?.detach();}dispose(){super.dispose(),this._attacherComponent?.dispose(),this._attacherComponent=null;}setOptions(t){this.coneInnerAngle=t.spatialConeInnerAngle??h$1.coneInnerAngle,this.coneOuterAngle=t.spatialConeOuterAngle??h$1.coneOuterAngle,this.coneOuterVolume=t.spatialConeOuterVolume??h$1.coneOuterVolume,this.distanceModel=t.spatialDistanceModel??h$1.distanceModel,this.maxDistance=t.spatialMaxDistance??h$1.maxDistance,this.minDistance=t.spatialMinDistance??h$1.minDistance,this.panningModel=t.spatialPanningModel??h$1.panningModel,this.rolloffFactor=t.spatialRolloffFactor??h$1.rolloffFactor,t.spatialPosition&&(this.position=t.spatialPosition.clone()),t.spatialRotationQuaternion?this.rotationQuaternion=t.spatialRotationQuaternion.clone():t.spatialRotation?this.rotation=t.spatialRotation.clone():this.rotationQuaternion=h$1.rotationQuaternion.clone(),this.update();}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation());}}function N(t){return t.getSubNode("Spatial")}function f$8(t,e,n){t.callOnSubNode("Spatial",(t=>{t[e]=n;}));}const b=re$5.Zero(),x=new se$5,M=te$4.Zero();function O(t){return t*Math.PI/180}function D(t){return 180*t/Math.PI}let S$1=class S extends A{constructor(t){super(t),this._lastPosition=te$4.Zero(),this._lastRotation=te$4.Zero(),this._lastRotationQuaternion=new se$5,this.position=h$1.position.clone(),this.rotation=h$1.rotation.clone(),this.rotationQuaternion=h$1.rotationQuaternion.clone(),this.node=new PannerNode(t._audioContext),this._orientationX=new w$2(t,this.node.orientationX),this._orientationY=new w$2(t,this.node.orientationY),this._orientationZ=new w$2(t,this.node.orientationZ),this._positionX=new w$2(t,this.node.positionX),this._positionY=new w$2(t,this.node.positionY),this._positionZ=new w$2(t,this.node.positionZ);}dispose(){super.dispose(),this._orientationX.dispose(),this._orientationY.dispose(),this._orientationZ.dispose(),this._positionX.dispose(),this._positionY.dispose(),this._positionZ.dispose(),this.node.disconnect();}get coneInnerAngle(){return O(this.node.coneInnerAngle)}set coneInnerAngle(t){this.node.coneInnerAngle=D(t);}get coneOuterAngle(){return O(this.node.coneOuterAngle)}set coneOuterAngle(t){this.node.coneOuterAngle=D(t);}get coneOuterVolume(){return this.node.coneOuterGain}set coneOuterVolume(t){this.node.coneOuterGain=t;}get distanceModel(){return this.node.distanceModel}set distanceModel(t){this.node.distanceModel=t;const e=this.node.maxDistance;this.node.maxDistance=e+.001,this.node.maxDistance=e;}get minDistance(){return this.node.refDistance}set minDistance(t){this.node.refDistance=t;}get maxDistance(){return this.node.maxDistance}set maxDistance(t){this.node.maxDistance=t;}get panningModel(){return this.node.panningModel}set panningModel(t){this.node.panningModel=t;}get rolloffFactor(){return this.node.rolloffFactor}set rolloffFactor(t){this.node.rolloffFactor=t;}get _inNode(){return this.node}get _outNode(){return this.node}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=this.position.x,this._positionY.targetValue=this.position.y,this._positionZ.targetValue=this.position.z,this._lastPosition.copyFrom(this.position));}_updateRotation(){if(!this.isAttached||!(this._orientationX.isRamping||this._orientationY.isRamping||this._orientationZ.isRamping)){if(this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion)){if(this._lastRotation.equalsWithEpsilon(this.rotation))return;se$5.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,x),this._lastRotation.copyFrom(this.rotation);}else x.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);re$5.FromQuaternionToRef(x,b),te$4.TransformNormalToRef(te$4.RightReadOnly,b,M),this._orientationX.targetValue=M.x,this._orientationY.targetValue=M.y,this._orientationZ.targetValue=M.z;}}_connect(t){return !!super._connect(t)&&(t._inNode&&this.node.connect(t._inNode),true)}_disconnect(t){return !!super._disconnect(t)&&(t._inNode&&this.node.disconnect(t._inNode),true)}getClassName(){return "_SpatialWebAudioSubNode"}};class w extends _$4{constructor(t){super(t),this.node=new StereoPannerNode(t._audioContext),this._pan=new w$2(t,this.node.pan);}dispose(){super.dispose(),this._pan.dispose();}get pan(){return this._pan.targetValue}set pan(t){this._pan.targetValue=t;}get _inNode(){return this.node}get _outNode(){return this.node}getClassName(){return "_StereoWebAudioSubNode"}_connect(t){return !!super._connect(t)&&(t._inNode&&this.node.connect(t._inNode),true)}_disconnect(t){return !!super._disconnect(t)&&(t._inNode&&this.node.disconnect(t._inNode),true)}}let R$1=class R extends A$1{constructor(){super(...arguments),this._rootNode=null,this._inputNode=null;}async initAsync(t){await super.initAsync(t);let e=false,n=false;(e=c$6(t))&&await this.createAndAddSubNodeAsync("Spatial"),(n=function(t){return t.stereoEnabled||void 0!==t.stereoPan}(t))&&await this.createAndAddSubNodeAsync("Stereo"),await this._createSubNodePromisesResolvedAsync(),e&&N(this)?.setOptions(t),n&&m$2(this)?.setOptions(t);}get _inNode(){return this._inputNode}_createSubNode(t){try{return super._createSubNode(t)}catch(t){}switch(t){case "Spatial":return async function(t){return new S$1(t)}(this._owner.engine);case "Stereo":return async function(t){return new w(t)}(this._owner.engine);default:throw new Error(`Unknown subnode name: ${t}`)}}_onSubNodesChanged(){super._onSubNodesChanged();const t=N(this),e=m$2(this),o=r$L(this);if(t&&"_SpatialWebAudioSubNode"!==t.getClassName())throw new Error("Not a WebAudio subnode.");if(e&&"_StereoWebAudioSubNode"!==e.getClassName())throw new Error("Not a WebAudio subnode.");if(o&&"_VolumeWebAudioSubNode"!==o.getClassName())throw new Error("Not a WebAudio subnode.");t&&(t.disconnectAll(),o&&t.connect(o)),e&&(e.disconnectAll(),o&&e.connect(o)),t&&e?(this._rootNode=new GainNode(this._owner.engine._audioContext),this._rootNode.connect(t._outNode),this._rootNode.connect(e._outNode)):(this._rootNode?.disconnect(),this._rootNode=null);let i=null,s=null;if(this._rootNode?s=this._rootNode:(t?i=t:e?i=e:o&&(i=o),s=i?.node??null),this._inputNode!==s){if(this._inputNode&&this._upstreamNodes){const t=this._upstreamNodes.values();for(let e=t.next();!e.done;e=t.next())e.value._outNode?.disconnect(this._inputNode);}if(this._inputNode=s,s&&this._upstreamNodes){const t=this._upstreamNodes.values();for(let e=t.next();!e.done;e=t.next())e.value._outNode?.connect(s);}}}};class C extends d$3{constructor(t){super(),this._coneInnerAngle=h$1.coneInnerAngle,this._coneOuterAngle=h$1.coneOuterAngle,this._coneOuterVolume=h$1.coneOuterVolume,this._distanceModel=h$1.distanceModel,this._maxDistance=h$1.maxDistance,this._minDistance=h$1.minDistance,this._panningModel=h$1.panningModel,this._rolloffFactor=h$1.rolloffFactor;const e=N(t);e?(this._position=e.position.clone(),this._rotation=e.rotation.clone(),this._rotationQuaternion=e.rotationQuaternion.clone()):(this._position=h$1.position.clone(),this._rotation=h$1.rotation.clone(),this._rotationQuaternion=h$1.rotationQuaternion.clone(),t.createAndAddSubNodeAsync("Spatial")),this._subGraph=t;}get coneInnerAngle(){return this._coneInnerAngle}set coneInnerAngle(t){this._coneInnerAngle=t,f$8(this._subGraph,"coneInnerAngle",t);}get coneOuterAngle(){return this._coneOuterAngle}set coneOuterAngle(t){this._coneOuterAngle=t,f$8(this._subGraph,"coneOuterAngle",t);}get coneOuterVolume(){return this._coneOuterVolume}set coneOuterVolume(t){this._coneOuterVolume=t,f$8(this._subGraph,"coneOuterVolume",t);}get distanceModel(){return this._distanceModel}set distanceModel(t){this._distanceModel=t,f$8(this._subGraph,"distanceModel",t);}get isAttached(){return this._subGraph.getSubNode("Spatial")?.isAttached??false}get maxDistance(){return this._maxDistance}set maxDistance(t){t<=0&&(t=1e-6),this._maxDistance=t,f$8(this._subGraph,"maxDistance",t);}get minDistance(){return this._minDistance}set minDistance(t){this._minDistance=t,f$8(this._subGraph,"minDistance",t);}get panningModel(){return this._panningModel}set panningModel(t){this._panningModel=t,f$8(this._subGraph,"panningModel",t);}get position(){return this._position}set position(t){this._position=t,this._updatePosition();}get rolloffFactor(){return this._rolloffFactor}set rolloffFactor(t){this._rolloffFactor=t,f$8(this._subGraph,"rolloffFactor",t);}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._updateRotation();}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(t){this._rotationQuaternion=t,this._updateRotation();}attach(t,e=false,n=3){N(this._subGraph)?.attach(t,e,n);}detach(){N(this._subGraph)?.detach();}update(){const t=N(this._subGraph);t&&(t.isAttached?t.update():(this._updatePosition(t),this._updateRotation(t)));}_updatePosition(t=null){if(!t&&!(t=N(this._subGraph)))return;t.position.equalsWithEpsilon(this._position)||(t.position.copyFrom(this._position),t._updatePosition());}_updateRotation(t=null){(t||(t=N(this._subGraph)))&&(t.rotationQuaternion.equalsWithEpsilon(this._rotationQuaternion)?t.rotation.equalsWithEpsilon(this._rotation)||(t.rotation.copyFrom(this._rotation),t._updateRotation()):(t.rotationQuaternion.copyFrom(this._rotationQuaternion),t._updateRotation()));}}class Q extends C{constructor(t,e,n){super(t),this._updaterComponent=new _$9(this,e,n);}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(t){this._updaterComponent.minUpdateTime=t;}dispose(){this._updaterComponent.dispose(),this._updaterComponent=null;}}let a$h=class a extends e$a{constructor(t,s){super(t,s),this._outBus=null,this._onOutBusDisposed=()=>{this.outBus=this.engine.defaultMainBus;};}get outBus(){return this._outBus}set outBus(t){if(this._outBus!==t){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw new Error("Disconnect failed");if(this._outBus=t,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw new Error("Connect failed")}}dispose(){super.dispose(),this._outBus=null;}};let u$5=class u extends a$h{constructor(t,s,i){super(t,s),this._spatial=null,this._spatialAutoUpdate=true,this._spatialMinUpdateTime=0,this._stereo=null,"boolean"==typeof i.spatialAutoUpdate&&(this._spatialAutoUpdate=i.spatialAutoUpdate),"number"==typeof i.spatialMinUpdateTime&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._subGraph=new u._SubGraph(this);}async _initAsync(t){t.outBus?this.outBus=t.outBus:(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),c$6(t)&&this._initSpatialProperty(),this.engine._addNode(this);}dispose(){super.dispose(),this._spatial=null,this._stereo=null,this.engine._removeNode(this);}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new g$2(this._subGraph))}getClassName(){return "_WebAudioBus"}_connect(t){return !!super._connect(t)&&(t._inNode&&this._outNode?.connect(t._inNode),true)}_disconnect(t){return !!super._disconnect(t)&&(t._inNode&&this._outNode?.disconnect(t._inNode),true)}_initSpatialProperty(){return this._spatial||(this._spatial=new Q(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}};u$5._SubGraph=class extends R$1{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};var webAudioBusBy47r9t9_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_WebAudioBus:u$5});let n$A=class n extends e$a{constructor(e,s){super(e,s);}};let t$p=class t extends n$A{constructor(e,s){super(e,s),this._subGraph=new t._SubGraph(this);}async _initAsync(e){if(await this._subGraph.initAsync(e),this.engine.mainOut&&!this._connect(this.engine.mainOut))throw new Error("Connect failed");this.engine._addMainBus(this);}dispose(){super.dispose(),this.engine._removeMainBus(this);}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}_connect(e){return !!super._connect(e)&&(e._inNode&&this._outNode?.connect(e._inNode),true)}_disconnect(e){return !!super._disconnect(e)&&(e._inNode&&this._outNode?.disconnect(e._inNode),true)}getClassName(){return "_WebAudioMainBus"}};t$p._SubGraph=class extends A$1{get _downstreamNodes(){return this._owner._downstreamNodes??null}};var webAudioMainBusBBnaqOx9_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_WebAudioMainBus:t$p});let t$o=class t extends D$1{constructor(s,t,u=2){super(s,t,u),this._outBus=null,this._onOutBusDisposed=()=>{this._outBus=null;};}get outBus(){return this._outBus}set outBus(s){if(this._outBus!==s){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw new Error("Disconnect failed");if(this._outBus=s,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw new Error("Connect failed")}}dispose(){super.dispose(),this._outBus=null;}};let n$z=class n extends t$o{constructor(s,e){super(s,e,3),this._newestInstance=null,this._privateInstances=new Set,this._state=1,this._instances=this._privateInstances,this.onEndedObservable=new R$g,this._onInstanceEnded=t=>{this._newestInstance===t&&(this._newestInstance=null),this._privateInstances.delete(t),0===this._instances.size&&(this._state=1,this.onEndedObservable.notifyObservers(this));};}get autoplay(){return this._options.autoplay}get currentTime(){const t=this._getNewestInstance();return t?t.currentTime:0}set currentTime(t){this.startOffset=t;const s=this._getNewestInstance();s&&(s.currentTime=t);}get loop(){return this._options.loop}set loop(t){this._options.loop=t;}get maxInstances(){return this._options.maxInstances}set maxInstances(t){this._options.maxInstances=t;}get startOffset(){return this._options.startOffset}set startOffset(t){this._options.startOffset=t;}get state(){return this._state}dispose(){super.dispose(),this.stop(),this._newestInstance=null,this._privateInstances.clear(),this.onEndedObservable.clear();}pause(){const t=this._instances.values();for(let s=t.next();!s.done;s=t.next())s.value.pause();this._state=5;}resume(){if(5!==this._state)return;const t=this._instances.values();for(let s=t.next();!s.done;s=t.next())s.value.resume();this._state=3;}_beforePlay(t){5===this.state&&this._instances.size>0?this.resume():(t.onEndedObservable.addOnce(this._onInstanceEnded),this._privateInstances.add(t),this._newestInstance=t);}_afterPlay(t){this._state=t.state;}_getNewestInstance(){if(0===this._instances.size)return null;if(!this._newestInstance){const t=this._instances.values();for(let s=t.next();!s.done;s=t.next())this._newestInstance=s.value;}return this._newestInstance}_setState(t){this._state=t;}_stopExcessInstances(){if(this.maxInstances<1/0){const t=Array.from(this._instances).filter((t=>3===t.state)).length-this.maxInstances,s=this._instances.values();for(let e=0;e<t;e++){s.next().value.stop();}}}};let a$g=class a extends B$4{constructor(s){super(s.engine,2),this._state=1,this.onEndedObservable=new R$g,this.onErrorObservable=new R$g,this.onStateChangedObservable=new R$g,this._sound=s;}get state(){return this._state}dispose(){super.dispose(),this.stop(),this.onEndedObservable.clear(),this.onStateChangedObservable.clear();}_setState(t){this._state!==t&&(this._state=t,this.onStateChangedObservable.notifyObservers(this));}};let u$4=class u extends n$z{constructor(t,e){super(t,e);}get duration(){return this._options.duration}set duration(t){this._options.duration=t;}get loopStart(){return this._options.loopStart}set loopStart(t){this._options.loopStart=t;}get loopEnd(){return this._options.loopEnd}set loopEnd(t){this._options.loopEnd=t;}get pitch(){return this._options.pitch}set pitch(t){this._options.pitch=t;const e=this._instances.values();for(let s=e.next();!s.done;s=e.next())s.value.pitch=t;}get playbackRate(){return this._options.playbackRate}set playbackRate(t){this._options.playbackRate=t;const e=this._instances.values();for(let s=e.next();!s.done;s=e.next())s.value.playbackRate=t;}play(t={}){if(5===this.state)return void this.resume();t.duration??=this.duration,t.loop??=this.loop,t.loopStart??=this.loopStart,t.loopEnd??=this.loopEnd,t.startOffset??=this.startOffset,t.volume??=1,t.waitTime??=0;const e=this._createInstance();this._beforePlay(e),e.play(t),this._afterPlay(e),this._stopExcessInstances();}stop(t={}){if(t.waitTime&&0<t.waitTime?this._setState(0):this._setState(1),this._instances)for(const e of Array.from(this._instances))e.stop(t);}};let _$3=1;let d$2=class d{constructor(t){this.name="StaticSoundBuffer #"+_$3++,this.engine=t;}};let c$5=class c extends a$g{};let l$3=class l extends u$4{constructor(t,e,s){super(t,e),this._spatial=null,this._spatialAutoUpdate=true,this._spatialMinUpdateTime=0,this._stereo=null,"boolean"==typeof s.spatialAutoUpdate&&(this._spatialAutoUpdate=s.spatialAutoUpdate),"number"==typeof s.spatialMinUpdateTime&&(this._spatialMinUpdateTime=s.spatialMinUpdateTime),this._options={autoplay:s.autoplay??false,duration:s.duration??0,loop:s.loop??false,loopEnd:s.loopEnd??0,loopStart:s.loopStart??0,maxInstances:s.maxInstances??1/0,pitch:s.pitch??0,playbackRate:s.playbackRate??1,startOffset:s.startOffset??0},this._subGraph=new l._SubGraph(this);}async _initAsync(t,e){this._audioContext=this.engine._audioContext,t instanceof p$3?this._buffer=t:("string"==typeof t||Array.isArray(t)||t instanceof ArrayBuffer||t instanceof AudioBuffer)&&(this._buffer=await this.engine.createSoundBufferAsync(t,e)),e.outBus?this.outBus=e.outBus:false!==e.outBusAutoDefault&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(e),c$6(e)&&this._initSpatialProperty(),e.autoplay&&this.play(),this.engine._addNode(this);}get buffer(){return this._buffer}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new g$2(this._subGraph))}async cloneAsync(t=null){const e=await this.engine.createSoundAsync(this.name,t?.cloneBuffer?this.buffer.clone():this.buffer,this._options);return e.outBus=t?.outBus?t.outBus:this.outBus,e}dispose(){super.dispose(),this._spatial?.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this);}getClassName(){return "_WebAudioStaticSound"}_createInstance(){return new f$7(this,this._options)}_connect(t){return !!super._connect(t)&&(t._inNode&&this._outNode?.connect(t._inNode),true)}_disconnect(t){return !!super._disconnect(t)&&(t._inNode&&this._outNode?.disconnect(t._inNode),true)}_initSpatialProperty(){return this._spatial||(this._spatial=new Q(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}};l$3._SubGraph=class extends R$1{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};let p$3=class p extends d$2{constructor(t){super(t);}async _initAsync(t,e){t instanceof AudioBuffer?this._audioBuffer=t:"string"==typeof t?await this._initFromUrlAsync(t):Array.isArray(t)?await this._initFromUrlsAsync(t,e.skipCodecCheck??false):t instanceof ArrayBuffer&&await this._initFromArrayBufferAsync(t);}get channelCount(){return this._audioBuffer.numberOfChannels}get duration(){return this._audioBuffer.duration}get length(){return this._audioBuffer.length}get sampleRate(){return this._audioBuffer.sampleRate}clone(t=null){const e=new AudioBuffer({length:this._audioBuffer.length,numberOfChannels:this._audioBuffer.numberOfChannels,sampleRate:this._audioBuffer.sampleRate});for(let t=0;t<this._audioBuffer.numberOfChannels;t++)e.copyToChannel(this._audioBuffer.getChannelData(t),t);const s=new p(this.engine);return s._audioBuffer=e,s.name=t?.name?t.name:this.name,s}async _initFromArrayBufferAsync(t){this._audioBuffer=await this.engine._audioContext.decodeAudioData(t);}async _initFromUrlAsync(t){t=f$e(t),await this._initFromArrayBufferAsync(await(await fetch(t)).arrayBuffer());}async _initFromUrlsAsync(t,e){for(const s of t){if(e)await this._initFromUrlAsync(s);else {const t=s.match(m$c),e=t?.at(1);if(e&&this.engine.isFormatValid(e))try{await this._initFromUrlAsync(s);}catch{e&&0<e.length&&this.engine.flagInvalidFormat(e);}}if(this._audioBuffer)break}}};let f$7=class f extends c$5{constructor(t,e){super(t),this._enginePlayTime=0,this._enginePauseTime=0,this._isConnected=false,this._pitch=null,this._playbackRate=null,this._sourceNode=null,this._onEnded=()=>{this._enginePlayTime=0,this.onEndedObservable.notifyObservers(this),this._deinitSourceNode();},this._onEngineStateChanged=()=>{"running"===this.engine.state&&(this._options.loop&&2===this.state&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged));},this._options=e,this._volumeNode=new GainNode(t._audioContext),this._initSourceNode();}dispose(){super.dispose(),this._pitch?.dispose(),this._playbackRate?.dispose(),this._sourceNode=null,this.stop(),this._deinitSourceNode(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged);}get currentTime(){if(1===this._state)return 0;const t=5===this._state?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+t+this._options.startOffset}set currentTime(t){const e=2===this._state||3===this._state;e&&(this.stop(),this._deinitSourceNode()),this._options.startOffset=t,e&&this.play();}get _outNode(){return this._volumeNode}set pitch(t){this._pitch?.setTargetValue(t);}set playbackRate(t){this._playbackRate?.setTargetValue(t);}get startTime(){return 1===this._state?0:this._enginePlayTime}getClassName(){return "_WebAudioStaticSoundInstance"}play(t={}){if(3===this._state)return;void 0!==t.duration&&(this._options.duration=t.duration),void 0!==t.loop&&(this._options.loop=t.loop),void 0!==t.loopStart&&(this._options.loopStart=t.loopStart),void 0!==t.loopEnd&&(this._options.loopEnd=t.loopEnd),void 0!==t.startOffset&&(this._options.startOffset=t.startOffset);let e=this._options.startOffset;5===this._state&&(e+=this.currentTime,e%=this._sound.buffer.duration),this._enginePlayTime=this.engine.currentTime+(t.waitTime??0),this._volumeNode.gain.value=t.volume??1,this._initSourceNode(),"running"===this.engine.state?(this._setState(3),this._sourceNode?.start(this._enginePlayTime,e,this._options.duration>0?this._options.duration:void 0)):this._options.loop&&(this._setState(2),this.engine.stateChangedObservable.add(this._onEngineStateChanged));}pause(){5!==this._state&&(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._sourceNode?.stop(),this._deinitSourceNode());}resume(){5===this._state&&this.play();}stop(t={}){if(1===this._state)return;this._setState(1);const e=this.engine.currentTime+(t.waitTime??0);this._sourceNode?.stop(e),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged);}_connect(t){return !!super._connect(t)&&(t instanceof l$3&&t._inNode&&(this._outNode?.connect(t._inNode),this._isConnected=true),true)}_disconnect(t){return !!super._disconnect(t)&&(t instanceof l$3&&t._inNode&&(this._outNode?.disconnect(t._inNode),this._isConnected=false),true)}_deinitSourceNode(){if(this._sourceNode){if(this._isConnected&&!this._disconnect(this._sound))throw new Error("Disconnect failed");this._sourceNode.disconnect(this._volumeNode),this._sourceNode.removeEventListener("ended",this._onEnded),this._sourceNode=null;}}_initSourceNode(){if(!this._sourceNode){if(this._sourceNode=new AudioBufferSourceNode(this._sound._audioContext,{buffer:this._sound.buffer._audioBuffer}),this._sourceNode.addEventListener("ended",this._onEnded,{once:true}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw new Error("Connect failed");this._pitch=new w$2(this.engine,this._sourceNode.detune),this._playbackRate=new w$2(this.engine,this._sourceNode.playbackRate);}const t=this._sourceNode;t.detune.value=this._sound.pitch,t.loop=this._options.loop,t.loopEnd=this._options.loopEnd,t.loopStart=this._options.loopStart,t.playbackRate.value=this._sound.playbackRate;}};var webAudioStaticSoundCsNtelmb_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_WebAudioStaticSound:l$3,_WebAudioStaticSoundBuffer:p$3});let o$q=class o extends t$o{constructor(t,s,e,i){super(t,e),this._spatial=null,this._spatialAutoUpdate=true,this._spatialMinUpdateTime=0,this._stereo=null,"boolean"==typeof i.spatialAutoUpdate&&(this._spatialAutoUpdate=i.spatialAutoUpdate),"number"==typeof i.spatialMinUpdateTime&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._audioContext=this.engine._audioContext,this._webAudioNode=s,this._subGraph=new o._SubGraph(this);}async _initAsync(t){t.outBus?this.outBus=t.outBus:false!==t.outBusAutoDefault&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),c$6(t)&&this._initSpatialProperty(),this.engine._addNode(this);}get _inNode(){return this._webAudioNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new g$2(this._subGraph))}dispose(){super.dispose(),this._spatial?.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this);}getClassName(){return "_WebAudioSoundSource"}_connect(t){return !!super._connect(t)&&(t._inNode&&this._outNode?.connect(t._inNode),true)}_disconnect(t){return !!super._disconnect(t)&&(t._inNode&&this._outNode?.disconnect(t._inNode),true)}_initSpatialProperty(){return this._spatial||(this._spatial=new Q(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}};o$q._SubGraph=class extends R$1{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}_onSubNodesChanged(){super._onSubNodesChanged(),this._owner._inNode.disconnect(),this._owner._subGraph._inNode&&this._owner._inNode.connect(this._owner._subGraph._inNode);}};var webAudioSoundSourceD6xdBBte_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_WebAudioSoundSource:o$q});let _$2=class _ extends n$z{constructor(e,t){super(e,t),this._preloadedInstances=new Array;}get preloadCount(){return this._options.preloadCount??1}get preloadCompletedCount(){return this._preloadedInstances.length}preloadInstanceAsync(){const e=this._createInstance();return this._addPreloadedInstance(e),e.preloadedPromise}async preloadInstancesAsync(e){for(let t=0;t<e;t++)this.preloadInstanceAsync();await Promise.all(this._preloadedInstances.map((async e=>await e.preloadedPromise)));}play(e={}){if(5===this.state)return void this.resume();let t;this.preloadCompletedCount>0?(t=this._preloadedInstances[0],t.startOffset=this.startOffset,this._removePreloadedInstance(t)):t=this._createInstance();const s=()=>{3===t.state&&(this._stopExcessInstances(),t.onStateChangedObservable.removeCallback(s));};t.onStateChangedObservable.add(s),e.startOffset??=this.startOffset,e.loop??=this.loop,e.volume??=1,this._beforePlay(t),t.play(e),this._afterPlay(t);}stop(){if(this._setState(1),this._instances)for(const e of Array.from(this._instances))e.stop();}_addPreloadedInstance(e){this._preloadedInstances.includes(e)||this._preloadedInstances.push(e);}_removePreloadedInstance(e){const t=this._preloadedInstances.indexOf(e);-1!==t&&this._preloadedInstances.splice(t,1);}};let l$2=class l extends a$g{constructor(t){super(t),this.onReadyObservable=new R$g,this.preloadedPromise=new Promise(((e,t)=>{this._rejectPreloadedProimse=t,this._resolvePreloadedPromise=e;})),this.onErrorObservable.add(this._rejectPreloadedProimse),this.onReadyObservable.add(this._resolvePreloadedPromise);}set startOffset(e){this._options.startOffset=e;}dispose(){super.dispose(),this.onErrorObservable.clear(),this.onReadyObservable.clear(),this._resolvePreloadedPromise();}};let u$3=class u extends _$2{constructor(e,t,s){super(e,t),this._spatial=null,this._spatialAutoUpdate=true,this._spatialMinUpdateTime=0,this._stereo=null,"boolean"==typeof s.spatialAutoUpdate&&(this._spatialAutoUpdate=s.spatialAutoUpdate),"number"==typeof s.spatialMinUpdateTime&&(this._spatialMinUpdateTime=s.spatialMinUpdateTime),this._options={autoplay:s.autoplay??false,loop:s.loop??false,maxInstances:s.maxInstances??1/0,preloadCount:s.preloadCount??1,startOffset:s.startOffset??0},this._subGraph=new u._SubGraph(this);}async _initAsync(e,t){const s=this.engine._audioContext;if(!(s instanceof AudioContext))throw new Error("Unsupported audio context type.");this._audioContext=s,this._source=e,t.outBus?this.outBus=t.outBus:false!==t.outBusAutoDefault&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),c$6(t)&&this._initSpatialProperty(),this.preloadCount&&await this.preloadInstancesAsync(this.preloadCount),t.autoplay&&this.play(t),this.engine._addNode(this);}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new g$2(this._subGraph))}dispose(){super.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this);}getClassName(){return "_WebAudioStreamingSound"}_createInstance(){return new p$2(this,this._options)}_connect(e){return !!super._connect(e)&&(e._inNode&&this._outNode?.connect(e._inNode),true)}_disconnect(e){return !!super._disconnect(e)&&(e._inNode&&this._outNode?.disconnect(e._inNode),true)}_initSpatialProperty(){return this._spatial||(this._spatial=new Q(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}};u$3._SubGraph=class extends R$1{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};let p$2=class p extends l$2{constructor(e,t){super(e),this._currentTimeChangedWhilePaused=false,this._enginePlayTime=1/0,this._enginePauseTime=0,this._isReady=false,this._isReadyPromise=new Promise(((e,t)=>{this._resolveIsReadyPromise=e,this._rejectIsReadyPromise=t;})),this._onCanPlayThrough=()=>{this._isReady=true,this._resolveIsReadyPromise(this._mediaElement),this.onReadyObservable.notifyObservers(this);},this._onEnded=()=>{this.onEndedObservable.notifyObservers(this),this.dispose();},this._onError=e=>{this._setState(4),this.onErrorObservable.notifyObservers(e),this._rejectIsReadyPromise(e),this.dispose();},this._onEngineStateChanged=()=>{"running"===this.engine.state&&(this._options.loop&&2===this.state&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged));},this._onUserGesture=()=>{this.play();},this._options=t,this._volumeNode=new GainNode(e._audioContext),"string"==typeof e._source?this._initFromUrl(e._source):Array.isArray(e._source)?this._initFromUrls(e._source):e._source instanceof HTMLMediaElement&&this._initFromMediaElement(e._source);}get currentTime(){if(1===this._state)return 0;const e=5===this._state?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){const t=2===this._state||3===this._state;t&&(this._mediaElement.pause(),this._setState(1)),this._options.startOffset=e,t?this.play({startOffset:e}):5===this._state&&(this._currentTimeChangedWhilePaused=true);}get _outNode(){return this._volumeNode}get startTime(){return 1===this._state?0:this._enginePlayTime}dispose(){super.dispose(),this.stop(),this._sourceNode?.disconnect(this._volumeNode),this._sourceNode=null,this._mediaElement.removeEventListener("error",this._onError),this._mediaElement.removeEventListener("ended",this._onEnded),this._mediaElement.removeEventListener("canplaythrough",this._onCanPlayThrough);for(const e of Array.from(this._mediaElement.children))this._mediaElement.removeChild(e);this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged),this.engine.userGestureObservable.removeCallback(this._onUserGesture);}play(e={}){if(3===this._state)return;void 0!==e.loop&&(this._options.loop=e.loop),this._mediaElement.loop=this._options.loop;let t=e.startOffset;this._currentTimeChangedWhilePaused?(t=this._options.startOffset,this._currentTimeChangedWhilePaused=false):5===this._state&&(t=this.currentTime+this._options.startOffset),t&&t>0&&(this._mediaElement.currentTime=t),this._volumeNode.gain.value=e.volume??1,this._play();}pause(){2!==this._state&&3!==this._state||(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._mediaElement.pause());}resume(){(5===this._state||this._currentTimeChangedWhilePaused)&&this.play();}stop(){1!==this._state&&this._stop();}getClassName(){return "_WebAudioStreamingSoundInstance"}_connect(e){return !!super._connect(e)&&(e instanceof u$3&&e._inNode&&this._outNode?.connect(e._inNode),true)}_disconnect(e){return !!super._disconnect(e)&&(e instanceof u$3&&e._inNode&&this._outNode?.disconnect(e._inNode),true)}_initFromMediaElement(e){if(Ai.SetCorsBehavior(e.currentSrc,e),e.controls=false,e.loop=this._options.loop,e.preload="auto",e.addEventListener("canplaythrough",this._onCanPlayThrough,{once:true}),e.addEventListener("ended",this._onEnded,{once:true}),e.addEventListener("error",this._onError,{once:true}),e.load(),this._sourceNode=new MediaElementAudioSourceNode(this._sound._audioContext,{mediaElement:e}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw new Error("Connect failed");this._mediaElement=e;}_initFromUrl(e){const t=new Audio(f$e(e));this._initFromMediaElement(t);}_initFromUrls(e){const t=new Audio;for(const s of e){const e=document.createElement("source");e.src=f$e(s),t.appendChild(e);}this._initFromMediaElement(t);}_play(){if(this._setState(2),this._isReady){if(2===this._state)if("running"===this.engine.state){const e=this._mediaElement.play();this._enginePlayTime=this.engine.currentTime,this._setState(3),e.catch((()=>{this._setState(4),this._options.loop&&this.engine.userGestureObservable.addOnce(this._onUserGesture);}));}else this._options.loop?this.engine.stateChangedObservable.add(this._onEngineStateChanged):(this.stop(),this._setState(4));}else this._playWhenReady();}_playWhenReady(){this._isReadyPromise.then((()=>{this._play();})).catch((()=>{Ie$2.Error("Streaming sound instance failed to play"),this._setState(4);}));}_stop(){this._mediaElement.pause(),this._setState(1),this._onEnded(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged);}};var webAudioStreamingSoundZ4JvlUkS_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,_WebAudioStreamingSound:u$3});const i$t="defaultUboDeclaration";bt$1.IncludesShadersStoreWGSL[i$t]||(bt$1.IncludesShadersStoreWGSL[i$t]="uniform diffuseLeftColor: vec4f;uniform diffuseRightColor: vec4f;uniform opacityParts: vec4f;uniform reflectionLeftColor: vec4f;uniform reflectionRightColor: vec4f;uniform refractionLeftColor: vec4f;uniform refractionRightColor: vec4f;uniform emissiveLeftColor: vec4f;uniform emissiveRightColor: vec4f;uniform vDiffuseInfos: vec2f;uniform vAmbientInfos: vec2f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vSpecularInfos: vec2f;uniform vBumpInfos: vec3f;uniform diffuseMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform specularMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform pointSize: f32;uniform alphaCutOff: f32;uniform refractionMatrix: mat4x4f;uniform vRefractionInfos: vec4f;uniform vRefractionPosition: vec3f;uniform vRefractionSize: vec3f;uniform vSpecularColor: vec4f;uniform vEmissiveColor: vec3f;uniform vDiffuseColor: vec4f;uniform vAmbientColor: vec3f;uniform cameraInfo: vec4f;uniform vReflectionInfos: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;\n#define ADDITIONAL_UBO_DECLARATION\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n");const n$y="lightVxFragmentDeclaration";bt$1.IncludesShadersStoreWGSL[n$y]||(bt$1.IncludesShadersStoreWGSL[n$y]="#ifdef LIGHT{X}\nuniform vLightData{X}: vec4f;uniform vLightDiffuse{X}: vec4f;\n#ifdef SPECULARTERM\nuniform vLightSpecular{X}: vec4f;\n#else\nvar vLightSpecular{X}: vec4f= vec4f(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform lightMatrix{X}: mat4x4f[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromLight{X}: vec4f[SHADOWCSMNUM_CASCADES{X}];varying var vDepthMetric{X}: f32[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromCamera{X}: vec4f;\n#elif defined(SHADOWCUBE{X})\n#else\nvarying var vPositionFromLight{X}: vec4f;varying var vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;\n#endif\nuniform shadowsInfo{X}: vec4f;uniform depthValues{X}: vec2f;\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vLightDirection{X}: vec4f;uniform vLightFalloff{X}: vec4f;\n#elif defined(POINTLIGHT{X})\nuniform vLightFalloff{X}: vec4f;\n#elif defined(HEMILIGHT{X})\nuniform vLightGround{X}: vec3f;\n#endif\n#if defined(AREALIGHT{X})\nuniform vLightWidth{X}: vec4f;uniform vLightHeight{X}: vec4f;\n#endif\n#endif\n");const i$s="defaultVertexShader",t$n="#include<defaultUboDeclaration>\n#define CUSTOM_VERTEX_BEGIN\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#ifdef TANGENT\nattribute tangent: vec4f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vPositionW: vec3f;\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvarying vViewDepth: f32;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar positionUpdated: vec3f=vertexInputs.position;\n#ifdef NORMAL\nvar normalUpdated: vec3f=vertexInputs.normal;\n#endif\n#ifdef TANGENT\nvar tangentUpdated: vec4f=vertexInputs.tangent;\n#endif\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=vertexInputs.uv2;\n#endif\n#ifdef VERTEXCOLOR\nvar colorUpdated: vec4f=vertexInputs.color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld*vec4f(positionUpdated,1.0);\n#ifdef NORMAL\nvar normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}\n#else\nvertexOutputs.position=scene.viewProjection*worldPos;\n#endif\nvertexOutputs.vPositionW= worldPos.xyz;\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld* vec4f(positionUpdated,0.0)).xyz);\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvertexOutputs.vViewDepth=(scene.view*worldPos).z;\n#endif\n#ifndef UV1\nvar uvUpdated: vec2f=vec2f(0.,0.);\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uvUpdated;\n#endif\n#ifndef UV2\nvar uv2Updated: vec2f=vec2f(0.,0.);\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";bt$1.ShadersStoreWGSL[i$s]||(bt$1.ShadersStoreWGSL[i$s]=t$n);const r$K={name:i$s,shader:t$n};var default_vertexFqVi9KMV_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,defaultVertexShaderWGSL:r$K});const n$x="defaultPixelShader",r$J="#include<defaultUboDeclaration>\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\nvarying vPositionW: vec3f;\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvarying vViewDepth: f32;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nvar refractionCubeSamplerSampler: sampler;var refractionCubeSampler: texture_cube<f32>;\n#else\nvar refraction2DSamplerSampler: sampler;var refraction2DSampler: texture_2d<f32>;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionCubeSamplerSampler: sampler;var reflectionCubeSampler: texture_cube<f32>;\n#else\nvar reflection2DSamplerSampler: sampler;var reflection2DSampler: texture_2d<f32>;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvar viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-fragmentInputs.vPositionW);var baseColor: vec4f= vec4f(1.,1.,1.,1.);var diffuseColor: vec3f=uniforms.vDiffuseColor.rgb;var alpha: f32=uniforms.vDiffuseColor.a;\n#ifdef NORMAL\nvar normalW: vec3f=normalize(fragmentInputs.vNormalW);\n#else\nvar normalW: vec3f=normalize(-cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=select(-normalW,normalW,fragmentInputs.frontFacing);\n#endif\n#ifdef DIFFUSE\nbaseColor=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<uniforms.alphaCutOff) {discard;}\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor=vec4f(baseColor.rgb*uniforms.vDiffuseInfos.y,baseColor.a);\n#endif\n#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)\nvar decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor=vec4f(baseColor.rgb*fragmentInputs.vColor.rgb,baseColor.a);\n#endif\n#ifdef DETAIL\nbaseColor=vec4f(baseColor.rgb*2.0*mix(0.5,detailColor.r,uniforms.vDetailInfos.y),baseColor.a);\n#endif\n#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)\nvar decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvar baseAmbientColor: vec3f= vec3f(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb*uniforms.vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nvar glossiness: f32=uniforms.vSpecularColor.a;var specularColor: vec3f=uniforms.vSpecularColor.rgb;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\nvar specularMapColor: vec4f=textureSample(specularSampler,specularSamplerSampler,fragmentInputs.vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#endif\nvar diffuseBase: vec3f= vec3f(0.,0.,0.);var info: lightingInfo;\n#ifdef SPECULARTERM\nvar specularBase: vec3f= vec3f(0.,0.,0.);\n#endif\nvar shadow: f32=1.;var aggShadow: f32=0.;var numLights: f32=0.;\n#ifdef LIGHTMAP\nvar lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);\n#endif\nlightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\naggShadow=aggShadow/numLights;var refractionColor: vec4f= vec4f(0.,0.,0.,1.);\n#ifdef REFRACTION\nvar refractionVector: vec3f=normalize(refract(-viewDirectionW,normalW,uniforms.vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(fragmentInputs.vPositionW,refractionVector,uniforms.vRefractionSize,uniforms.vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*uniforms.vRefractionInfos.w;var refractionLookup: vec4f=textureSample(refractionCubeSampler,refractionCubeSamplerSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}\n#else\nvar vRefractionUVW: vec3f= (uniforms.refractionMatrix*(scene.view* vec4f(fragmentInputs.vPositionW+refractionVector*uniforms.vRefractionInfos.z,1.0))).xyz;var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=textureSample(refraction2DSampler,refraction2DSamplerSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor=vec4f(fromRGBD(refractionColor),refractionColor.a);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor=vec4f(toGammaSpaceVec3(refractionColor.rgb),refractionColor.a);\n#endif\nrefractionColor=vec4f(refractionColor.rgb*uniforms.vRefractionInfos.x,refractionColor.a);\n#endif\nvar reflectionColor: vec4f= vec4f(0.,0.,0.,1.);\n#ifdef REFLECTION\nvar vReflectionUVW: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW=vec3f(vReflectionUVW.x,vReflectionUVW.y,vReflectionUVW.z*-1.0);\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nvar bias: f32=uniforms.vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureSampleLevel(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureSample(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW);\n#endif\n#else\nvar coords: vec2f=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;reflectionColor=textureSample(reflection2DSampler,reflection2DSamplerSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor=vec4f(fromRGBD(reflectionColor),reflectionColor.a);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor=vec4f(toGammaSpaceVec3(reflectionColor.rgb),reflectionColor.a);\n#endif\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);\n#ifdef REFLECTIONFRESNEL\nvar reflectionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.reflectionRightColor.a,uniforms.reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor=vec4f(reflectionColor.rgb*specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);\n#else\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);\n#endif\n#else\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nvar refractionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.refractionRightColor.a,uniforms.refractionLeftColor.a);refractionColor=vec4f(refractionColor.rgb*uniforms.refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*uniforms.refractionRightColor.rgb,refractionColor.a);\n#endif\n#ifdef OPACITY\nvar opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* uniforms.vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*uniforms.vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=fragmentInputs.vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nvar opacityFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.opacityParts.z,uniforms.opacityParts.w);alpha+=uniforms.opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*uniforms.opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<uniforms.alphaCutOff) {discard;}\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvar emissiveColor: vec3f=uniforms.vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb*uniforms.vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nvar emissiveFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.emissiveRightColor.a,uniforms.emissiveLeftColor.a);emissiveColor*=uniforms.emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*uniforms.emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nvar diffuseFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.diffuseRightColor.a,uniforms.diffuseLeftColor.a);diffuseBase*=uniforms.diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*uniforms.diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvar finalDiffuse: vec3f=clamp((diffuseBase+emissiveColor)*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+emissiveColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvar finalSpecular: vec3f=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular, vec3f(0.3,0.59,0.11)),0.0,1.0);\n#endif\n#else\nvar finalSpecular: vec3f= vec3f(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb, vec3f(0.3,0.59,0.11)),0.0,1.0);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvar color: vec4f= vec4f(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvar color: vec4f= vec4f(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor=vec4f(color.rgb*lightmapColor.rgb,color.a);\n#else\ncolor=vec4f(color.rgb+lightmapColor.rgb,color.a);\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor=vec4f(max(color.rgb,vec3f(0.)),color.a);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor=vec4f(toLinearSpaceVec3(color.rgb),color.a);\n#else\n#ifdef IMAGEPROCESSING\ncolor=vec4f(toLinearSpaceVec3(color.rgb),color.a);color=applyImageProcessing(color);\n#endif\n#endif\ncolor=vec4f(color.rgb,color.a*mesh.visibility);\n#ifdef PREMULTIPLYALPHA\ncolor=vec4f(color.rgb*color.a, color.a);\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#if SCENE_MRT_COUNT>0\nvar writeGeometryInfo: f32=select(0.0,1.0,color.a>0.4);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;\n#ifdef PREPASS_COLOR\nfragData[PREPASS_COLOR_INDEX]=color; \n#endif\n#ifdef PREPASS_POSITION\nfragData[PREPASS_POSITION_INDEX]=vec4f(fragmentInputs.vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nfragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvar a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvar velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -\n(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\nfragData[PREPASS_IRRADIANCE_INDEX]=vec4f(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\nfragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\nfragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\nfragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4f(fragmentInputs.vNormViewDepth,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);\n#else\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\nfragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\nfragData[PREPASS_ALBEDO_INDEX]=vec4f(baseColor.rgb,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nfragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqrt(baseColor.rgb),writeGeometryInfo);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULAR)\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec4(specularMapColor))*writeGeometryInfo; \n#else\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec3(specularColor),1.0)*writeGeometryInfo;\n#endif\n#endif\n#if SCENE_MRT_COUNT>0\nfragmentOutputs.fragData0=fragData[0];\n#endif\n#if SCENE_MRT_COUNT>1\nfragmentOutputs.fragData1=fragData[1];\n#endif\n#if SCENE_MRT_COUNT>2\nfragmentOutputs.fragData2=fragData[2];\n#endif\n#if SCENE_MRT_COUNT>3\nfragmentOutputs.fragData3=fragData[3];\n#endif\n#if SCENE_MRT_COUNT>4\nfragmentOutputs.fragData4=fragData[4];\n#endif\n#if SCENE_MRT_COUNT>5\nfragmentOutputs.fragData5=fragData[5];\n#endif\n#if SCENE_MRT_COUNT>6\nfragmentOutputs.fragData6=fragData[6];\n#endif\n#if SCENE_MRT_COUNT>7\nfragmentOutputs.fragData7=fragData[7];\n#endif\n#endif\n#endif\n#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)\nfragmentOutputs.color=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+color.rgb*color.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-color.a));} else {fragmentOutputs.backColor+=color;}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStoreWGSL[n$x]||(bt$1.ShadersStoreWGSL[n$x]=r$J);const f$6={name:n$x,shader:r$J};var default_fragmentC3Z3IUVr_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,defaultPixelShaderWGSL:f$6});const o$p="defaultUboDeclaration";bt$1.IncludesShadersStore[o$p]||(bt$1.IncludesShadersStore[o$p]="layout(std140,column_major) uniform;uniform Material\n{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;vec4 cameraInfo;vec2 vReflectionInfos;mat4 reflectionMatrix;vec3 vReflectionPosition;vec3 vReflectionSize;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n");const n$w="defaultVertexDeclaration";bt$1.IncludesShadersStore[n$w]||(bt$1.IncludesShadersStore[n$w]="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;uniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef REFLECTION\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\nuniform vec4 cameraInfo;\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n");const i$r="defaultVertexShader",t$m="#define CUSTOM_VERTEX_EXTENSION\n#include<__decl__defaultVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvarying float vViewDepth;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef VERTEXCOLOR\nvec4 colorUpdated=color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\nvPositionW=vec3(worldPos);\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvViewDepth=(view*worldPos).z;\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2Updated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";bt$1.ShadersStore[i$r]||(bt$1.ShadersStore[i$r]=t$m);const o$o={name:i$r,shader:t$m};var default_vertexDPjt2Ech_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,defaultVertexShader:o$o});const n$v="defaultFragmentDeclaration";bt$1.IncludesShadersStore[n$v]||(bt$1.IncludesShadersStore[n$v]="uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;uniform vec4 vSpecularColor;uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;\n#endif\n#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; \n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;\n#endif\n#if defined(REFLECTION) || (defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED))\nuniform vec2 vReflectionInfos;\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)\nuniform mat4 reflectionMatrix;\n#endif\n#ifndef REFLECTIONMAP_SKYBOX\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#define ADDITIONAL_FRAGMENT_DECLARATION\n");const i$q="fresnelFunction";bt$1.IncludesShadersStore[i$q]||(bt$1.IncludesShadersStore[i$q]="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}\n#endif\n");const o$n="defaultPixelShader",r$I="#define CUSTOM_FRAGMENT_EXTENSION\n#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0\nvarying float vViewDepth;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor.rgb*=vColor.rgb;\n#endif\n#ifdef DETAIL\nbaseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);\n#endif\n#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nfloat glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;float aggShadow=0.;float numLights=0.;\n#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\naggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor.rgb=fromRGBD(refractionColor);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor.rgb=toGammaSpace(refractionColor.rgb);\n#endif\nrefractionColor.rgb*=vRefractionInfos.x;\n#endif\nvec4 reflectionColor=vec4(0.,0.,0.,1.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor.rgb=toGammaSpace(reflectionColor.rgb);\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<alphaCutOff)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor.rgb;\n#else\ncolor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);\n#endif\n#endif\ncolor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#if SCENE_MRT_COUNT>0\nfloat writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;\n#ifdef PREPASS_COLOR\ngl_FragData[PREPASS_COLOR_INDEX]=color; \n#endif\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\ngl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);\n#endif\n#if defined(PREPASS_VELOCITY)\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\ngl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMALIZED_VIEW_DEPTH\ngl_FragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4(vNormViewDepth,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);\n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\ngl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\ngl_FragData[PREPASS_ALBEDO_INDEX]=vec4(baseColor.rgb,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqrt(baseColor.rgb),writeGeometryInfo);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULAR)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; \n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;\n#endif\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStore[o$n]||(bt$1.ShadersStore[o$n]=r$I);const f$5={name:o$n,shader:r$I};var default_fragmentBR2WfKiF_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,defaultPixelShader:f$5});const n$u="geometryVertexShader",i$p="#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<sceneUboDeclaration>\n#include<clipPlaneVertexDeclaration>\nattribute position: vec3f;\n#ifdef HAS_NORMAL_ATTRIBUTE\nattribute normal: vec3f;\n#endif\n#ifdef NEED_UV\nvarying vUV: vec2f;\n#ifdef ALPHATEST\nuniform diffuseMatrix: mat4x4f;\n#endif\n#ifdef BUMP\nuniform bumpMatrix: mat4x4f;varying vBumpUV: vec2f;\n#endif\n#ifdef REFLECTIVITY\nuniform reflectivityMatrix: mat4x4f;uniform albedoMatrix: mat4x4f;varying vReflectivityUV: vec2f;varying vAlbedoUV: vec2f;\n#endif\n#ifdef METALLIC_TEXTURE\nvarying vMetallicUV: vec2f;uniform metallicMatrix: mat4x4f;\n#endif\n#ifdef ROUGHNESS_TEXTURE\nvarying vRoughnessUV: vec2f;uniform roughnessMatrix: mat4x4f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#ifdef BUMP\nvarying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;\n#endif\n#ifdef BUMP\nvarying vNormalW: vec3f;\n#else\nvarying vNormalV: vec3f;\n#endif\nvarying vViewPos: vec4f;\n#if defined(POSITION) || defined(BUMP)\nvarying vPositionW: vec3f;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nuniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef HAS_NORMAL_ATTRIBUTE\nvar normalUpdated: vec3f=input.normal;\n#else\nvar normalUpdated: vec3f=vec3f(0.0,0.0,0.0);\n#endif\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=input.uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f= vec4f(finalWorld* vec4f(positionUpdated,1.0));\n#ifdef BUMP\nlet vWorldView=scene.view*finalWorld;vertexOutputs.vWorldView0=vWorldView[0];vertexOutputs.vWorldView1=vWorldView[1];vertexOutputs.vWorldView2=vWorldView[2];vertexOutputs.vWorldView3=vWorldView[3];let normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#else\n#ifdef NORMAL_WORLDSPACE\nvertexOutputs.vNormalV=normalize((finalWorld* vec4f(normalUpdated,0.0)).xyz);\n#else\nvertexOutputs.vNormalV=normalize(((scene.view*finalWorld)* vec4f(normalUpdated,0.0)).xyz);\n#endif\n#endif\nvertexOutputs.vViewPos=scene.view*worldPos;\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nvar previousInfluence: mat4x4f;previousInfluence=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];\n#endif\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);\n#else\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvertexOutputs.vPositionW=worldPos.xyz/worldPos.w;\n#endif\nvertexOutputs.position=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#else\nvertexOutputs.vUV=uvUpdated;\n#endif\n#ifdef BUMP_UV1\nvertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef REFLECTIVITY_UV1\nvertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#else\n#ifdef METALLIC_UV1\nvertexOutputs.vMetallicUV=(uniforms.metallicMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef ROUGHNESS_UV1\nvertexOutputs.vRoughnessUV=(uniforms.roughnessMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef ALBEDO_UV1\nvertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#else\nvertexOutputs.vUV=uv2Updated;\n#endif\n#ifdef BUMP_UV2\nvertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#ifdef REFLECTIVITY_UV2\nvertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#else\n#ifdef METALLIC_UV2\nvertexOutputs.vMetallicUV=(uniforms.metallicMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#ifdef ROUGHNESS_UV2\nvertexOutputs.vRoughnessUV=(uniforms.roughnessMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef ALBEDO_UV2\nvertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";bt$1.ShadersStoreWGSL[n$u]||(bt$1.ShadersStoreWGSL[n$u]=i$p);const t$l={name:n$u,shader:i$p};var geometry_vertexD0_PY1nf_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,geometryVertexShaderWGSL:t$l});const n$t="geometryPixelShader",i$o="#ifdef BUMP\nvarying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;varying vNormalW: vec3f;\n#else\nvarying vNormalV: vec3f;\n#endif\nvarying vViewPos: vec4f;\n#if defined(POSITION) || defined(BUMP)\nvarying vPositionW: vec3f;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nvarying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#ifdef NEED_UV\nvarying vUV: vec2f;\n#endif\n#ifdef BUMP\nuniform vBumpInfos: vec3f;uniform vTangentSpaceParams: vec2f;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nvar reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;varying vReflectivityUV: vec2f;\n#else\n#ifdef METALLIC_TEXTURE\nvar metallicSamplerSampler: sampler;var metallicSampler: texture_2d<f32>;varying vMetallicUV: vec2f;\n#endif\n#ifdef ROUGHNESS_TEXTURE\nvar roughnessSamplerSampler: sampler;var roughnessSampler: texture_2d<f32>;varying vRoughnessUV: vec2f;\n#endif\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vAlbedoUV: vec2f;var albedoSamplerSampler: sampler;var albedoSampler: texture_2d<f32>;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform reflectivityColor: vec3f;\n#endif\n#ifdef ALBEDOCOLOR\nuniform albedoColor: vec3f;\n#endif\n#ifdef METALLIC\nuniform metallic: f32;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform glossiness: f32;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nvar diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}\n#endif\nvar normalOutput: vec3f;\n#ifdef BUMP\nvar normalW: vec3f=normalize(input.vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize( (mat4x4f(input.vWorldView0,input.vWorldView1,input.vWorldView2,input.vWorldView3)* vec4f(normalW,0.0)).xyz);\n#endif\n#elif defined(HAS_NORMAL_ATTRIBUTE)\nnormalOutput=normalize(input.vNormalV);\n#elif defined(POSITION)\nnormalOutput=normalize(-cross(dpdx(input.vPositionW),dpdy(input.vPositionW)));\n#endif\n#ifdef ENCODE_NORMAL\nnormalOutput=normalOutput*0.5+0.5;\n#endif\nvar fragData: array<vec4<f32>,SCENE_MRT_COUNT>;\n#ifdef DEPTH\nfragData[DEPTH_INDEX]=vec4f(input.vViewPos.z/input.vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef NORMAL\nfragData[NORMAL_INDEX]=vec4f(normalOutput,1.0);\n#endif\n#ifdef SCREENSPACE_DEPTH\nfragData[SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,1.0);\n#endif\n#ifdef POSITION\nfragData[POSITION_INDEX]= vec4f(input.vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvar a: vec2f=(input.vCurrentPosition.xy/input.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(input.vPreviousPosition.xy/input.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[VELOCITY_INDEX]= vec4f(velocity,0.0,1.0);\n#endif\n#ifdef VELOCITY_LINEAR\nvar velocity : vec2f=vec2f(0.5)*((input.vPreviousPosition.xy /\ninput.vPreviousPosition.w) -\n(input.vCurrentPosition.xy /\ninput.vCurrentPosition.w));fragData[VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvar reflectivity: vec4f= vec4f(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nvar metal: f32=1.0;var roughness: f32=1.0;\n#ifdef ORMTEXTURE\nmetal*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).b;roughness*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).g;\n#else\n#ifdef METALLIC_TEXTURE\nmetal*=textureSample(metallicSampler,metallicSamplerSampler,input.vMetallicUV).r;\n#endif\n#ifdef ROUGHNESS_TEXTURE\nroughness*=textureSample(roughnessSampler,roughnessSamplerSampler,input.vRoughnessUV).r;\n#endif\n#endif\n#ifdef METALLIC\nmetal*=uniforms.metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-uniforms.glossiness); \n#endif\nreflectivity=vec4f(reflectivity.rgb,reflectivity.a-roughness);var color: vec3f= vec3f(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=textureSample(albedoSampler,albedoSamplerSampler,input.vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpaceVec4(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=uniforms.albedoColor.xyz;\n#endif\nreflectivity=vec4f(mix( vec3f(0.04),color,metal),reflectivity.a);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity=vec4f(toLinearSpaceVec3(reflectivity.rgb),reflectivity.a);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity=vec4f(toLinearSpaceVec3(uniforms.reflectivityColor.xyz),1.0);\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity=vec4f(reflectivity.rgb,reflectivity.a*glossiness); \n#endif\n#endif\nfragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n#if SCENE_MRT_COUNT>0\nfragmentOutputs.fragData0=fragData[0];\n#endif\n#if SCENE_MRT_COUNT>1\nfragmentOutputs.fragData1=fragData[1];\n#endif\n#if SCENE_MRT_COUNT>2\nfragmentOutputs.fragData2=fragData[2];\n#endif\n#if SCENE_MRT_COUNT>3\nfragmentOutputs.fragData3=fragData[3];\n#endif\n#if SCENE_MRT_COUNT>4\nfragmentOutputs.fragData4=fragData[4];\n#endif\n#if SCENE_MRT_COUNT>5\nfragmentOutputs.fragData5=fragData[5];\n#endif\n#if SCENE_MRT_COUNT>6\nfragmentOutputs.fragData6=fragData[6];\n#endif\n#if SCENE_MRT_COUNT>7\nfragmentOutputs.fragData7=fragData[7];\n#endif\n}\n";bt$1.ShadersStoreWGSL[n$t]||(bt$1.ShadersStoreWGSL[n$t]=i$o);const f$4={name:n$t,shader:i$o};var geometry_fragmentDg2VktW8_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,geometryPixelShaderWGSL:f$4});const r$H="ssao2PixelShader",t$k="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#ifdef SSAO\nconst scales: array<f32,16>=array<f32,16>(\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform near: f32;uniform radius: f32;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;var randomSamplerSampler: sampler;var randomSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;uniform randTextureTiles: f32;uniform samplesFactor: f32;uniform sampleSphere: array<vec3f,SAMPLES>;uniform totalStrength: f32;uniform base: f32;\n#ifdef ORTHOGRAPHIC_CAMERA\nuniform viewport: vec4f;\n#else\nuniform xViewport: f32;uniform yViewport: f32;\n#endif\nuniform depthProjection: mat3x3f;uniform maxZ: f32;uniform minZAspect: f32;uniform texelSize: vec2f;uniform projection: mat4x4f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var random: vec3f=textureSampleLevel(randomSampler,randomSamplerSampler,input.vUV*uniforms.randTextureTiles,0.0).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r;var depthSign: f32=sign(depth);depth=depth*depthSign;var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.0).rgb;var occlusion: f32=0.0;var correctedRadius: f32=min(uniforms.radius,uniforms.minZAspect*depth/uniforms.near);\n#ifdef ORTHOGRAPHIC_CAMERA\nvar vViewRay: vec3f= vec3f(mix(uniforms.viewport.x,uniforms.viewport.y,input.vUV.x),mix(uniforms.viewport.z,uniforms.viewport.w,input.vUV.y),depthSign);\n#else\nvar vViewRay: vec3f= vec3f((input.vUV.x*2.0-1.0)*uniforms.xViewport,(input.vUV.y*2.0-1.0)*uniforms.yViewport,depthSign);\n#endif\nvar vDepthFactor: vec3f=uniforms.depthProjection* vec3f(1.0,1.0,depth);var origin: vec3f=vViewRay*vDepthFactor;var rvec: vec3f=random*2.0-1.0;rvec.z=0.0;var dotProduct: f32=dot(rvec,normal);rvec=select( vec3f(-rvec.y,0.0,rvec.x),rvec,1.0-abs(dotProduct)>1e-2);var tangent: vec3f=normalize(rvec-normal*dot(rvec,normal));var bitangent: vec3f=cross(normal,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,normal);var difference: f32;for (var i: i32=0; i<SAMPLES; i++) {var samplePosition: vec3f=scales[(i+ i32(random.x*16.0)) % 16]*tbn*uniforms.sampleSphere[(i+ i32(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;var offset: vec4f= vec4f(samplePosition,1.0);offset=uniforms.projection*offset;offset=vec4f(offset.xyz/offset.w,offset.w);offset=vec4f(offset.xy*0.5+0.5,offset.z,offset.w);if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nvar sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;var rangeCheck: f32=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(uniforms.maxZ*0.75,uniforms.maxZ,depth));var ao: f32=1.0-uniforms.totalStrength*occlusion*uniforms.samplesFactor;var result: f32=clamp(ao+uniforms.base,0.0,1.0);fragmentOutputs.color= vec4f( vec3f(result),1.0);}\n#else\n#ifdef BLUR\nuniform outSize: f32;uniform soften: f32;uniform tolerance: f32;uniform samples: i32;\n#ifndef BLUR_BYPASS\nvar depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;\n#ifdef BLUR_LEGACY\nfn blur13Bilateral(image: texture_2d<f32>,imageSampler: sampler,uv: vec2f,step: vec2f)->f32 {var result: f32=0.0;var off1: vec2f= vec2f(1.411764705882353)*step;var off2: vec2f= vec2f(3.2941176470588234)*step;var off3: vec2f= vec2f(5.176470588235294)*step;var compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv,0.0).r);var sampleDepth: f32;var weight: f32;var weightSum: f32=30.0;result+=textureSampleLevel(image,imageSampler,uv,0.0).r*30.0;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv+off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv-off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off3,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var result: f32=0.0;\n#ifdef BLUR_BYPASS\nresult=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvar step: vec2f= vec2f(1.0/uniforms.outSize,0.0);\n#else\nvar step: vec2f= vec2f(0.0,1.0/uniforms.outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,textureSamplerSampler,input.vUV,step);\n#else\nvar compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r);var weightSum: f32=0.0;for (var i: i32=-uniforms.samples; i<uniforms.samples; i+=2)\n{var samplePos: vec2f=input.vUV+step*( f32(i)+0.5);var sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,samplePos,0.0).r);var falloff: f32=smoothstep(0.0,\nf32(uniforms.samples),\nf32(uniforms.samples)-abs( f32(i))*uniforms.soften);var minDivider: f32=uniforms.tolerance*0.5+0.003;var weight: f32=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureSampleLevel(textureSampler,textureSamplerSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\nfragmentOutputs.color=vec4f(result,result,result,1.0);}\n#endif\n#endif\n";bt$1.ShadersStoreWGSL[r$H]||(bt$1.ShadersStoreWGSL[r$H]=t$k);const a$f={name:r$H,shader:t$k};var ssao2_fragmentBIBkoGKC_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,ssao2PixelShaderWGSL:a$f});const t$j="ssao2PixelShader",o$m="precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nfloat scales[16]=float[16](\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;\n#ifdef ORTHOGRAPHIC_CAMERA\nuniform vec4 viewport;\n#else\nuniform float xViewport;uniform float yViewport;\n#endif\nuniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()\n{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=sign(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);\n#ifdef ORTHOGRAPHIC_CAMERA\nvec3 vViewRay=vec3(mix(viewport.x,viewport.y,vUV.x),mix(viewport.z,viewport.w,vUV.y),depthSign);\n#else\nvec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);\n#endif\nvec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nfloat sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}\n#endif\n#ifdef BLUR\nuniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;\n#ifndef BLUR_BYPASS\nuniform sampler2D depthSampler;\n#ifdef BLUR_LEGACY\n#define inline\nfloat blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\nvoid main()\n{float result=0.0;\n#ifdef BLUR_BYPASS\nresult=textureLod(textureSampler,vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvec2 step=vec2(1.0/outSize,0.0);\n#else\nvec2 step=vec2(0.0,1.0/outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,vUV,step);\n#else\nfloat compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)\n{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,\nfloat(samples),\nfloat(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\ngl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}\n#endif\n";bt$1.ShadersStore[t$j]||(bt$1.ShadersStore[t$j]=o$m);const r$G={name:t$j,shader:o$m};var ssao2_fragmentDZXQh7gf_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,ssao2PixelShader:r$G});const r$F="ssaoCombinePixelShader",o$l="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var originalColorSampler: sampler;var originalColor: texture_2d<f32>;uniform viewport: vec4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar uv: vec2f=uniforms.viewport.xy+input.vUV*uniforms.viewport.zw;var ssaoColor: vec4f=textureSample(textureSampler,textureSamplerSampler,uv);var sceneColor: vec4f=textureSample(originalColor,originalColorSampler,uv);fragmentOutputs.color=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStoreWGSL[r$F]||(bt$1.ShadersStoreWGSL[r$F]=o$l);const a$e={name:r$F,shader:o$l};var ssaoCombine_fragmentCE5xXQBp_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,ssaoCombinePixelShaderWGSL:a$e});const o$k="ssaoCombinePixelShader",r$E="uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec2 uv=viewport.xy+vUV*viewport.zw;vec4 ssaoColor=texture2D(textureSampler,uv);vec4 sceneColor=texture2D(originalColor,uv);gl_FragColor=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStore[o$k]||(bt$1.ShadersStore[o$k]=r$E);const n$s={name:o$k,shader:r$E};var ssaoCombine_fragmentDA81_Hvc_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,ssaoCombinePixelShader:n$s});const n$r="imageProcessingPixelShader",r$D="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var result: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);result=vec4f(max(result.rgb,vec3f(0.)),result.a);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult=vec4f(toLinearSpaceVec3(result.rgb),result.a);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\nfragmentOutputs.color=result;}";bt$1.ShadersStoreWGSL[n$r]||(bt$1.ShadersStoreWGSL[n$r]=r$D);const t$i={name:n$r,shader:r$D};var imageProcessing_fragmentCIV7_WN1_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,imageProcessingPixelShaderWGSL:t$i});const n$q="imageProcessingPixelShader",r$C="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 result=texture2D(textureSampler,vUV);result.rgb=max(result.rgb,vec3(0.));\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;}";bt$1.ShadersStore[n$q]||(bt$1.ShadersStore[n$q]=r$C);const s$3={name:n$q,shader:r$C};var imageProcessing_fragmentDZlWa1Ar_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,imageProcessingPixelShader:s$3});const t$h="proceduralVertexShader",n$p="attribute position: vec2f;varying vPosition: vec2f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vPosition=input.position;vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStoreWGSL[t$h]||(bt$1.ShadersStoreWGSL[t$h]=n$p);const i$n={name:t$h,shader:n$p};var procedural_vertexBhoqu3O__esm_min=/*#__PURE__*/Object.freeze({__proto__:null,proceduralVertexShaderWGSL:i$n});const i$m="proceduralVertexShader",n$o="attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStore[i$m]||(bt$1.ShadersStore[i$m]=n$o);const o$j={name:i$m,shader:n$o};var procedural_vertexHcWx5UqO_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,proceduralVertexShader:o$j});const r$B="iblCdfxPixelShader",t$g="#define PI 3.1415927\nvarying vUV: vec2f;var cdfy: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var cdfyRes=textureDimensions(cdfy,0);var currentPixel=vec2u(fragmentInputs.position.xy);var cdfx: f32=0.0;for (var x: u32=1; x<=currentPixel.x; x++) {cdfx+=textureLoad(cdfy, vec2u(x-1,cdfyRes.y-1),0).x;}\nfragmentOutputs.color= vec4f( vec3f(cdfx),1.0);}";bt$1.ShadersStoreWGSL[r$B]||(bt$1.ShadersStoreWGSL[r$B]=t$g);const n$n={name:r$B,shader:t$g};var iblCdfx_fragmentB5Qp7HtS_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblCdfxPixelShaderWGSL:n$n});const n$m="iblCdfyPixelShader",r$A="varying vUV : vec2f;\n#include <helperFunctions>\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nuniform iblHeight: i32;\n#ifdef IBL_USE_CUBE_MAP\nfn fetchCube(uv: vec2f)->f32 {var direction: vec3f=equirectangularToCubemapDirection(uv);return sin(PI*uv.y) *\ndot(textureSampleLevel(iblSource,iblSourceSampler,direction,0.0)\n.rgb,\nLuminanceEncodeApprox);}\n#else\nfn fetchPanoramic(Coords: vec2i,envmapHeight: f32)->f32 {return sin(PI*(f32(Coords.y)+0.5)/envmapHeight) *\ndot(textureLoad(iblSource,Coords,0).rgb,LuminanceEncodeApprox);}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var coords: vec2i= vec2i(fragmentInputs.position.xy);var cdfy: f32=0.0;for (var y: i32=1; y<=coords.y; y++) {\n#ifdef IBL_USE_CUBE_MAP\nvar uv: vec2f= vec2f(input.vUV.x,( f32(y-1)+0.5)/ f32(uniforms.iblHeight));cdfy+=fetchCube(uv);\n#else\ncdfy+=fetchPanoramic( vec2i(coords.x,y-1), f32(uniforms.iblHeight));\n#endif\n}\nfragmentOutputs.color= vec4f(cdfy,0.0,0.0,1.0);}";bt$1.ShadersStoreWGSL[n$m]||(bt$1.ShadersStoreWGSL[n$m]=r$A);const i$l={name:n$m,shader:r$A};var iblCdfy_fragmentKcR2Fpoi_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblCdfyPixelShaderWGSL:i$l});const r$z="iblScaledLuminancePixelShader",n$l="#include<helperFunctions>\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nuniform iblHeight: i32;uniform iblWidth: i32;fn fetchLuminance(coords: vec2f)->f32 {\n#ifdef IBL_USE_CUBE_MAP\nvar direction: vec3f=equirectangularToCubemapDirection(coords);var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;\n#else\nvar color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,coords,0.0).rgb;\n#endif\nreturn dot(color,LuminanceEncodeApprox);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var deform: f32=sin(input.vUV.y*PI);var luminance: f32=fetchLuminance(input.vUV);fragmentOutputs.color=vec4f(vec3f(deform*luminance),1.0);}";bt$1.ShadersStoreWGSL[r$z]||(bt$1.ShadersStoreWGSL[r$z]=n$l);const i$k={name:r$z,shader:n$l};var iblScaledLuminance_fragmentBTEndz_6_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblScaledLuminancePixelShaderWGSL:i$k});const r$y="iblCdfxPixelShader",i$j="precision highp sampler2D;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D cdfy;void main(void) {ivec2 cdfyRes=textureSize(cdfy,0);ivec2 currentPixel=ivec2(gl_FragCoord.xy);float cdfx=0.0;for (int x=1; x<=currentPixel.x; x++) {cdfx+=texelFetch(cdfy,ivec2(x-1,cdfyRes.y-1),0).x;}\ngl_FragColor=vec4(vec3(cdfx),1.0);}";bt$1.ShadersStore[r$y]||(bt$1.ShadersStore[r$y]=i$j);const c$4={name:r$y,shader:i$j};var iblCdfx_fragmentVVOoHHS3_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblCdfxPixelShader:c$4});const n$k="iblCdfyPixelShader",i$i="precision highp sampler2D;precision highp samplerCube;\n#include<helperFunctions>\n#define PI 3.1415927\nvarying vec2 vUV;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform int iblHeight;\n#ifdef IBL_USE_CUBE_MAP\nfloat fetchCube(vec2 uv) {vec3 direction=equirectangularToCubemapDirection(uv);return sin(PI*uv.y)*dot(textureCubeLodEXT(iblSource,direction,0.0).rgb,LuminanceEncodeApprox);}\n#else\nfloat fetchPanoramic(ivec2 Coords,float envmapHeight) {return sin(PI*(float(Coords.y)+0.5)/envmapHeight) *\ndot(texelFetch(iblSource,Coords,0).rgb,LuminanceEncodeApprox);}\n#endif\nvoid main(void) {ivec2 coords=ivec2(gl_FragCoord.x,gl_FragCoord.y);float cdfy=0.0;for (int y=1; y<=coords.y; y++) {\n#ifdef IBL_USE_CUBE_MAP\nvec2 uv=vec2(vUV.x,(float(y-1)+0.5)/float(iblHeight));cdfy+=fetchCube(uv);\n#else\ncdfy+=fetchPanoramic(ivec2(coords.x,y-1),float(iblHeight));\n#endif\n}\ngl_FragColor=vec4(cdfy,0.0,0.0,1.0);}";bt$1.ShadersStore[n$k]||(bt$1.ShadersStore[n$k]=i$i);const o$i={name:n$k,shader:i$i};var iblCdfy_fragment3csxd3h__esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblCdfyPixelShader:o$i});const n$j="iblScaledLuminancePixelShader",i$h="precision highp sampler2D;precision highp samplerCube;\n#include<helperFunctions>\nvarying vec2 vUV;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform int iblWidth;uniform int iblHeight;float fetchLuminance(vec2 coords) {\n#ifdef IBL_USE_CUBE_MAP\nvec3 direction=equirectangularToCubemapDirection(coords);vec3 color=textureCubeLodEXT(iblSource,direction,0.0).rgb;\n#else\nvec3 color=textureLod(iblSource,coords,0.0).rgb;\n#endif\nreturn dot(color,LuminanceEncodeApprox);}\nvoid main(void) {float deform=sin(vUV.y*PI);float luminance=fetchLuminance(vUV);gl_FragColor=vec4(vec3(deform*luminance),1.0);}";bt$1.ShadersStore[n$j]||(bt$1.ShadersStore[n$j]=i$h);const o$h={name:n$j,shader:i$h};var iblScaledLuminance_fragmentBzwxsT1g_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblScaledLuminancePixelShader:o$h});const t$f="iblIcdfPixelShader",r$x="#include<helperFunctions>\nvarying vUV: vec2f;\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nvar scaledLuminanceSamplerSampler : sampler;var scaledLuminanceSampler : texture_2d<f32>;var cdfx: texture_2d<f32>;var cdfy: texture_2d<f32>;fn fetchLuminance(coords: vec2f)->f32 {\n#ifdef IBL_USE_CUBE_MAP\nvar direction: vec3f=equirectangularToCubemapDirection(coords);var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;\n#else\nvar color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,coords,0.0).rgb;\n#endif\nreturn dot(color,LuminanceEncodeApprox);}\nfn fetchCDFx(x: u32)->f32 {return textureLoad(cdfx, vec2u(x,0),0).x;}\nfn bisectx(size: u32,targetValue: f32)->f32\n{var a: u32=0;var b=size-1;while (b-a>1) {var c: u32=(a+b)>>1;if (fetchCDFx(c)<targetValue) {a=c;}\nelse {b=c;}}\nreturn mix( f32(a), f32(b),(targetValue-fetchCDFx(a))/(fetchCDFx(b)-fetchCDFx(a)))/ f32(size-1);}\nfn fetchCDFy(y: u32,invocationId: u32)->f32 {return textureLoad(cdfy, vec2u(invocationId,y),0).x;}\nfn bisecty(size: u32,targetValue: f32,invocationId: u32)->f32\n{var a: u32=0;var b=size-1;while (b-a>1) {var c=(a+b)>>1;if (fetchCDFy(c,invocationId)<targetValue) {a=c;}\nelse {b=c;}}\nreturn mix( f32(a), f32(b),(targetValue-fetchCDFy(a,invocationId))/(fetchCDFy(b,invocationId)-fetchCDFy(a,invocationId)))/ f32(size-1);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var cdfxSize: vec2u=textureDimensions(cdfx,0);var cdfWidth: u32=cdfxSize.x;var icdfWidth: u32=cdfWidth-1;var currentPixel: vec2u= vec2u(fragmentInputs.position.xy);var outputColor: vec3f=vec3f(1.0);if (currentPixel.x==0)\n{outputColor.x= 0.0;}\nelse if (currentPixel.x==icdfWidth-1) {outputColor.x= 1.0;} else {var targetValue: f32=fetchCDFx(cdfWidth-1)*input.vUV.x;outputColor.x= bisectx(cdfWidth,targetValue);}\nvar cdfySize: vec2u=textureDimensions(cdfy,0);var cdfHeight: u32=cdfySize.y;if (currentPixel.y==0) {outputColor.y= 0.0;}\nelse if (currentPixel.y==cdfHeight-2) {outputColor.y= 1.0;} else {var targetValue: f32=fetchCDFy(cdfHeight-1,currentPixel.x)*input.vUV.y;outputColor.y= max(bisecty(cdfHeight,targetValue,currentPixel.x),0.0);}\nvar size : vec2f=vec2f(textureDimensions(scaledLuminanceSampler,0));var highestMip: f32=floor(log2(size.x));var normalization : f32=textureSampleLevel(scaledLuminanceSampler,\nscaledLuminanceSamplerSampler,\ninput.vUV,highestMip)\n.r;var pixelLuminance: f32=fetchLuminance(input.vUV);outputColor.z=pixelLuminance/(2.0*PI*normalization);fragmentOutputs.color=vec4( outputColor,1.0);}";bt$1.ShadersStoreWGSL[t$f]||(bt$1.ShadersStoreWGSL[t$f]=r$x);const n$i={name:t$f,shader:r$x};var iblIcdf_fragmentC6DaWXw3_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblIcdfPixelShaderWGSL:n$i});const r$w="iblDominantDirectionPixelShader",i$g="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nvar icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var lightDir: vec3f=vec3f(0.0,0.0,0.0);for(var i: u32=0u; i<NUM_SAMPLES; i++)\n{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var T: vec2f;T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(T.x,Xi.y),0.0).y;var Ls: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));lightDir+=Ls;}\nlightDir/=vec3f(f32(NUM_SAMPLES));fragmentOutputs.color=vec4f(lightDir,1.0);}";bt$1.ShadersStoreWGSL[r$w]||(bt$1.ShadersStoreWGSL[r$w]=i$g);const n$h={name:r$w,shader:i$g};var iblDominantDirection_fragmentGGCwAYT_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblDominantDirectionPixelShaderWGSL:n$h});const t$e="iblIcdfPixelShader",i$f="precision highp sampler2D;\n#include<helperFunctions>\nvarying vec2 vUV;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform sampler2D scaledLuminanceSampler;uniform int iblWidth;uniform int iblHeight;uniform sampler2D cdfx;uniform sampler2D cdfy;float fetchLuminance(vec2 coords) {\n#ifdef IBL_USE_CUBE_MAP\nvec3 direction=equirectangularToCubemapDirection(coords);vec3 color=textureCubeLodEXT(iblSource,direction,0.0).rgb;\n#else\nvec3 color=textureLod(iblSource,coords,0.0).rgb;\n#endif\nreturn dot(color,LuminanceEncodeApprox);}\nfloat fetchCDFx(int x) { return texelFetch(cdfx,ivec2(x,0),0).x; }\nfloat bisectx(int size,float targetValue) {int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDFx(c)<targetValue)\na=c;else\nb=c;}\nreturn mix(float(a),float(b),\n(targetValue-fetchCDFx(a))/(fetchCDFx(b)-fetchCDFx(a))) /\nfloat(size-1);}\nfloat fetchCDFy(int y,int invocationId) {return texelFetch(cdfy,ivec2(invocationId,y),0).x;}\nfloat bisecty(int size,float targetValue,int invocationId) {int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDFy(c,invocationId)<targetValue)\na=c;else\nb=c;}\nreturn mix(float(a),float(b),\n(targetValue-fetchCDFy(a,invocationId)) /\n(fetchCDFy(b,invocationId)-fetchCDFy(a,invocationId))) /\nfloat(size-1);}\nvoid main(void) {ivec2 cdfxSize=textureSize(cdfx,0);int cdfWidth=cdfxSize.x;int icdfWidth=cdfWidth-1;ivec2 currentPixel=ivec2(gl_FragCoord.xy);vec3 outputColor=vec3(1.0);if (currentPixel.x==0) {outputColor.x=0.0;} else if (currentPixel.x==icdfWidth-1) {outputColor.x=1.0;} else {float targetValue=fetchCDFx(cdfWidth-1)*vUV.x;outputColor.x=bisectx(cdfWidth,targetValue);}\nivec2 cdfySize=textureSize(cdfy,0);int cdfHeight=cdfySize.y;if (currentPixel.y==0) {outputColor.y=0.0;} else if (currentPixel.y==cdfHeight-2) {outputColor.y=1.0;} else {float targetValue=fetchCDFy(cdfHeight-1,currentPixel.x)*vUV.y;outputColor.y=max(bisecty(cdfHeight,targetValue,currentPixel.x),0.0);}\nvec2 size=vec2(textureSize(scaledLuminanceSampler,0));float highestMip=floor(log2(size.x));float normalization=texture(scaledLuminanceSampler,vUV,highestMip).r;float pixelLuminance=fetchLuminance(vUV);outputColor.z=pixelLuminance/(2.0*PI*normalization);gl_FragColor=vec4(outputColor,1.0);}\n";bt$1.ShadersStore[t$e]||(bt$1.ShadersStore[t$e]=i$f);const n$g={name:t$e,shader:i$f};var iblIcdf_fragmentVY_BFJ58_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblIcdfPixelShader:n$g});const e$9="iblDominantDirectionPixelShader",n$f="precision highp sampler2D;precision highp samplerCube;\n#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nvarying vec2 vUV;uniform sampler2D icdfSampler;void main(void) {vec3 lightDir=vec3(0.0,0.0,0.0);for(uint i=0u; i<NUM_SAMPLES; ++i)\n{vec2 Xi=hammersley(i,NUM_SAMPLES);vec2 T;T.x=texture2D(icdfSampler,vec2(Xi.x,0.0)).x;T.y=texture2D(icdfSampler,vec2(T.x,Xi.y)).y;vec3 Ls=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));lightDir+=Ls;}\nlightDir/=float(NUM_SAMPLES);gl_FragColor=vec4(lightDir,1.0);}";bt$1.ShadersStore[e$9]||(bt$1.ShadersStore[e$9]=n$f);const r$v={name:e$9,shader:n$f};var iblDominantDirection_fragmentB8kQcVh1_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblDominantDirectionPixelShader:r$v});const r$u="iblCdfDebugPixelShader",f$3="#define PI 3.1415927\nvarying vUV: vec2f;var cdfySampler: sampler;var cdfy: texture_2d<f32>;var cdfxSampler: sampler;var cdfx: texture_2d<f32>;var icdfSampler: sampler;var icdf: texture_2d<f32>;\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nvar textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#define cdfyVSize (0.8/3.0)\n#define cdfxVSize 0.1\n#define cdfyHSize 0.5\nuniform sizeParams: vec4f;\n#ifdef IBL_USE_CUBE_MAP\nfn equirectangularToCubemapDirection(uv: vec2f)->vec3f {var longitude: f32=uv.x*2.0*PI-PI;var latitude: f32=PI*0.5-uv.y*PI;var direction: vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs { \nvar colour: vec3f= vec3f(0.0);var uv: vec2f =\nvec2f((uniforms.sizeParams.x+input.vUV.x)*uniforms.sizeParams.z,(uniforms.sizeParams.y+input.vUV.y)*uniforms.sizeParams.w);var backgroundColour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var cdfxWidth: u32=textureDimensions(cdfx,0).x;var cdfyHeight: u32=textureDimensions(cdfy,0).y;const iblStart: f32=1.0-cdfyVSize;const pdfStart: f32=1.0-2.0*cdfyVSize;const cdfyStart: f32=1.0-3.0*cdfyVSize;const cdfxStart: f32=1.0-3.0*cdfyVSize-cdfxVSize;const icdfxStart: f32=1.0-3.0*cdfyVSize-2.0*cdfxVSize;\n#ifdef IBL_USE_CUBE_MAP\nvar direction: vec3f=equirectangularToCubemapDirection(\n(uv- vec2f(0.0,iblStart))* vec2f(1.0,1.0/cdfyVSize));var iblColour: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;\n#else\nvar iblColour: vec3f=textureSample(iblSource,iblSourceSampler,(uv- vec2f(0.0,iblStart)) *\nvec2f(1.0,1.0/cdfyVSize))\n.rgb;\n#endif\nvar pdfColour: vec3f =\ntextureSample(icdf,icdfSampler,(uv- vec2f(0.0,pdfStart))* vec2f(1.0,1.0/cdfyVSize)).zzz;var cdfyColour: f32 =\ntextureSample(cdfy,cdfySampler,(uv- vec2f(0.0,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).r;var icdfyColour: f32 =\ntextureSample(icdf,icdfSampler,(uv- vec2f(0.5,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).g;var cdfxColour: f32 =\ntextureSample(cdfx,cdfxSampler,(uv- vec2f(0.0,cdfxStart))* vec2f(1.0,1.0/cdfxVSize)).r;var icdfxColour: f32=textureSample(icdf,icdfSampler,(uv- vec2f(0.0,icdfxStart)) *\nvec2f(1.0,1.0/cdfxVSize)).r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>pdfStart) {colour+=pdfColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=cdfyColour/f32(cdfyHeight);} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=cdfxColour/f32(cdfxWidth);} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}\nfragmentOutputs.color =vec4(mix(colour,backgroundColour,0.5),1.0);}";bt$1.ShadersStoreWGSL[r$u]||(bt$1.ShadersStoreWGSL[r$u]=f$3);const c$3={name:r$u,shader:f$3};var iblCdfDebug_fragmentDa5GuVQ3_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblCdfDebugPixelShaderWGSL:c$3});const r$t="iblCdfDebugPixelShader",i$e="precision highp samplerCube;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D cdfy;uniform sampler2D cdfx;uniform sampler2D icdf;uniform sampler2D pdf;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform sampler2D textureSampler;\n#define cdfyVSize (0.8/3.0)\n#define cdfxVSize 0.1\n#define cdfyHSize 0.5\nuniform vec4 sizeParams;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\n#ifdef IBL_USE_CUBE_MAP\nvec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*2.0*PI-PI;float latitude=PI*0.5-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\n#endif\nvoid main(void) {vec3 colour=vec3(0.0);vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec3 backgroundColour=texture2D(textureSampler,vUV).rgb;int cdfxWidth=textureSize(cdfx,0).x;int cdfyHeight=textureSize(cdfy,0).y;const float iblStart=1.0-cdfyVSize;const float pdfStart=1.0-2.0*cdfyVSize;const float cdfyStart=1.0-3.0*cdfyVSize;const float cdfxStart=1.0-3.0*cdfyVSize-cdfxVSize;const float icdfxStart=1.0-3.0*cdfyVSize-2.0*cdfxVSize;\n#ifdef IBL_USE_CUBE_MAP\nvec3 direction=equirectangularToCubemapDirection(\n(uv-vec2(0.0,iblStart))*vec2(1.0,1.0/cdfyVSize));vec3 iblColour=textureCubeLodEXT(iblSource,direction,0.0).rgb;\n#else\nvec3 iblColour=texture2D(iblSource,(uv-vec2(0.0,iblStart)) *\nvec2(1.0,1.0/cdfyVSize))\n.rgb;\n#endif\nvec3 pdfColour=texture(icdf,(uv-vec2(0.0,pdfStart)) *\nvec2(1.0,1.0/cdfyVSize)).zzz;float cdfyColour =\ntexture2D(cdfy,(uv-vec2(0.0,cdfyStart))*vec2(2.0,1.0/cdfyVSize))\n.r;float icdfyColour =\ntexture2D(icdf,(uv-vec2(0.5,cdfyStart))*vec2(2.0,1.0/cdfyVSize))\n.g;float cdfxColour =\ntexture2D(cdfx,(uv-vec2(0.0,cdfxStart))*vec2(1.0,1.0/cdfxVSize))\n.r;float icdfxColour=texture2D(icdf,(uv-vec2(0.0,icdfxStart)) *\nvec2(1.0,1.0/cdfxVSize))\n.r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>pdfStart) {colour+=pdfColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=cdfyColour/float(cdfyHeight);} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=cdfxColour/float(cdfxWidth);} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}\ngl_FragColor=vec4(colour,1.0);glFragColor.rgb=mix(gl_FragColor.rgb,backgroundColour,0.5);}\n";bt$1.ShadersStore[r$t]||(bt$1.ShadersStore[r$t]=i$e);const c$2={name:r$t,shader:i$e};var iblCdfDebug_fragmentBPWMqfBo_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblCdfDebugPixelShader:c$2});const n$e="hdrFilteringVertexShader",t$d="attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStoreWGSL[n$e]||(bt$1.ShadersStoreWGSL[n$e]=t$d);const i$d={name:n$e,shader:t$d};var hdrFiltering_vertexCtICuUSA_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,hdrFilteringVertexShaderWGSL:i$d});const e$8="hdrFilteringPixelShader",r$s="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform alphaG: f32;var inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;uniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=radiance(uniforms.alphaG,inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}";bt$1.ShadersStoreWGSL[e$8]||(bt$1.ShadersStoreWGSL[e$8]=r$s);const i$c={name:e$8,shader:r$s};var hdrFiltering_fragmentBPbZx1iP_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,hdrFilteringPixelShaderWGSL:i$c});const e$7="hdrFilteringVertexShader",n$d="attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nmat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStore[e$7]||(bt$1.ShadersStore[e$7]=n$d);const o$g={name:e$7,shader:n$d};var hdrFiltering_vertexDfWCibql_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,hdrFilteringVertexShader:o$g});const i$b="hdrFilteringPixelShader",e$6="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}";bt$1.ShadersStore[i$b]||(bt$1.ShadersStore[i$b]=e$6);const r$r={name:i$b,shader:e$6};var hdrFiltering_fragmentFIzTivjA_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,hdrFilteringPixelShader:r$r});const n$c="hdrIrradianceFilteringVertexShader",i$a="attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStoreWGSL[n$c]||(bt$1.ShadersStoreWGSL[n$c]=i$a);const t$c={name:n$c,shader:i$a};var hdrIrradianceFiltering_vertexB2gT8q81_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,hdrIrradianceFilteringVertexShaderWGSL:t$c});const n$b="hdrIrradianceFilteringPixelShader",r$q="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nvar inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;\n#ifdef IBL_CDF_FILTERING\nvar icdfTextureSampler: sampler;var icdfTexture: texture_2d<f32>;\n#endif\nuniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=irradiance(inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo,0.0,vec3f(1.0),input.direction\n#ifdef IBL_CDF_FILTERING\n,icdfTexture,icdfTextureSampler\n#endif\n);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}";bt$1.ShadersStoreWGSL[n$b]||(bt$1.ShadersStoreWGSL[n$b]=r$q);const i$9={name:n$b,shader:r$q};var hdrIrradianceFiltering_fragmentBBG3XY_f_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,hdrIrradianceFilteringPixelShaderWGSL:i$9});const e$5="hdrIrradianceFilteringVertexShader",n$a="attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nmat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStore[e$5]||(bt$1.ShadersStore[e$5]=n$a);const r$p={name:e$5,shader:n$a};var hdrIrradianceFiltering_vertexBLfACBHf_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,hdrIrradianceFilteringVertexShader:r$p});const i$8="hdrIrradianceFilteringPixelShader",e$4="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform samplerCube inputTexture;\n#ifdef IBL_CDF_FILTERING\nuniform sampler2D icdfTexture;\n#endif\nuniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=irradiance(inputTexture,direction,vFilteringInfo,0.0,vec3(1.0),direction\n#ifdef IBL_CDF_FILTERING\n,icdfTexture\n#endif\n);gl_FragColor=vec4(color*hdrScale,1.0);}";bt$1.ShadersStore[i$8]||(bt$1.ShadersStore[i$8]=e$4);const r$o={name:i$8,shader:e$4};var hdrIrradianceFiltering_fragmentCMCv7Hr_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,hdrIrradianceFilteringPixelShader:r$o});const f$2="openpbrUboDeclaration";bt$1.IncludesShadersStoreWGSL[f$2]||(bt$1.IncludesShadersStoreWGSL[f$2]="uniform vTangentSpaceParams: vec2f;uniform vLightingIntensity: vec4f;uniform pointSize: f32;uniform vDebugMode: vec2f;uniform cameraInfo: vec4f;uniform vReflectionInfos: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionDominantDirection: vec3f;uniform vReflectionColor: vec3f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;uniform vBaseWeight: f32;uniform vBaseColor: vec4f;uniform vBaseDiffuseRoughness: f32;uniform vReflectanceInfo: vec4f;uniform vSpecularColor: vec4f;uniform vSpecularAnisotropy: vec3f;uniform vCoatWeight: f32;uniform vCoatColor: vec3f;uniform vCoatRoughness: f32;uniform vCoatRoughnessAnisotropy: f32;uniform vCoatIor: f32;uniform vCoatDarkening : f32;uniform vFuzzWeight: f32;uniform vFuzzColor: vec3f;uniform vFuzzRoughness: f32;uniform vGeometryCoatTangent: vec2f;uniform vEmissionColor: vec3f;uniform vThinFilmWeight: f32;uniform vThinFilmThickness: vec2f;uniform vThinFilmIor: f32;uniform vBaseWeightInfos: vec2f;uniform baseWeightMatrix: mat4x4f;uniform vBaseColorInfos: vec2f;uniform baseColorMatrix: mat4x4f;uniform vBaseDiffuseRoughnessInfos: vec2f;uniform baseDiffuseRoughnessMatrix: mat4x4f;uniform vBaseMetalnessInfos: vec2f;uniform baseMetalnessMatrix: mat4x4f;uniform vSpecularWeightInfos: vec2f;uniform specularWeightMatrix: mat4x4f;uniform vSpecularColorInfos: vec2f;uniform specularColorMatrix: mat4x4f;uniform vSpecularRoughnessInfos: vec2f;uniform specularRoughnessMatrix: mat4x4f;uniform vSpecularRoughnessAnisotropyInfos: vec2f;uniform specularRoughnessAnisotropyMatrix: mat4x4f;uniform vCoatWeightInfos: vec2f;uniform coatWeightMatrix: mat4x4f;uniform vCoatColorInfos: vec2f;uniform coatColorMatrix: mat4x4f;uniform vCoatRoughnessInfos: vec2f;uniform coatRoughnessMatrix: mat4x4f;uniform vCoatRoughnessAnisotropyInfos: vec2f;uniform coatRoughnessAnisotropyMatrix: mat4x4f;uniform vCoatDarkeningInfos : vec2f;uniform coatDarkeningMatrix : mat4x4f;uniform vFuzzWeightInfos: vec2f;uniform fuzzWeightMatrix: mat4x4f;uniform vFuzzColorInfos: vec2f;uniform fuzzColorMatrix: mat4x4f;uniform vFuzzRoughnessInfos: vec2f;uniform fuzzRoughnessMatrix: mat4x4f;uniform vGeometryNormalInfos: vec2f;uniform geometryNormalMatrix: mat4x4f;uniform vGeometryTangentInfos: vec2f;uniform geometryTangentMatrix: mat4x4f;uniform vGeometryCoatNormalInfos: vec2f;uniform geometryCoatNormalMatrix: mat4x4f;uniform vGeometryCoatTangentInfos: vec2f;uniform geometryCoatTangentMatrix: mat4x4f;uniform vGeometryOpacityInfos: vec2f;uniform geometryOpacityMatrix: mat4x4f;uniform vEmissionInfos: vec2f;uniform emissionMatrix: mat4x4f;uniform vThinFilmWeightInfos: vec2f;uniform thinFilmWeightMatrix: mat4x4f;uniform vThinFilmThicknessInfos: vec2f;uniform thinFilmThicknessMatrix: mat4x4f;uniform vAmbientOcclusionInfos: vec2f;uniform ambientOcclusionMatrix: mat4x4f;\n#define ADDITIONAL_UBO_DECLARATION\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n");const n$9="openpbrNormalMapVertexDeclaration";bt$1.IncludesShadersStoreWGSL[n$9]||(bt$1.IncludesShadersStoreWGSL[n$9]="#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(FUZZ)\n#if defined(TANGENT) && defined(NORMAL) \nvarying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;\n#endif\n#endif\n");const i$7="openpbrNormalMapVertex";bt$1.IncludesShadersStoreWGSL[i$7]||(bt$1.IncludesShadersStoreWGSL[i$7]="#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(FUZZ)\n#if defined(TANGENT) && defined(NORMAL)\nvar tbnNormal: vec3f=normalize(normalUpdated);var tbnTangent: vec3f=normalize(tangentUpdated.xyz);var tbnBitangent: vec3f=cross(tbnNormal,tbnTangent)*tangentUpdated.w;var matTemp= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)* mat3x3f(tbnTangent,tbnBitangent,tbnNormal);vertexOutputs.vTBN0=matTemp[0];vertexOutputs.vTBN1=matTemp[1];vertexOutputs.vTBN2=matTemp[2];\n#endif\n#endif\n");const t$b="openpbrVertexShader",r$n="#define OPENPBR_VERTEX_SHADER\n#include<openpbrUboDeclaration>\n#define CUSTOM_VERTEX_BEGIN\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#ifdef TANGENT\nattribute tangent: vec4f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening)\n#include<samplerVertexDeclaration>(_DEFINENAME_,FUZZ_WEIGHT,_VARYINGNAME_,FuzzWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,FUZZ_COLOR,_VARYINGNAME_,FuzzColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,FUZZ_ROUGHNESS,_VARYINGNAME_,FuzzRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal)\n#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent)\n#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal)\n#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\nvarying vPositionW: vec3f;\n#if DEBUGMODE>0\nvarying vClipSpacePosition: vec4f;\n#endif\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vEnvironmentIrradiance: vec3f;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<openpbrNormalMapVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<lightVxUboDeclaration>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar positionUpdated: vec3f=vertexInputs.position;\n#ifdef NORMAL\nvar normalUpdated: vec3f=vertexInputs.normal;\n#endif\n#ifdef TANGENT\nvar tangentUpdated: vec4f=vertexInputs.tangent;\n#endif\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=vertexInputs.uv2;\n#endif\n#ifdef VERTEXCOLOR\nvar colorUpdated: vec4f=vertexInputs.color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nvar normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY\nvar viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-vertexOutputs.vPositionW);var NdotV: f32=max(dot(vertexOutputs.vNormalW,viewDirectionW),0.0);var roughNormal: vec3f=mix(vertexOutputs.vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*uniforms.vBaseDiffuseRoughness);var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(roughNormal,0)).xyz;\n#else\nvar reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}\n#else\nvertexOutputs.position=scene.viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvertexOutputs.vClipSpacePosition=vertexOutputs.position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);\n#endif\n#ifndef UV1\nvar uvUpdated: vec2f= vec2f(0.,0.);\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uvUpdated;\n#endif\n#ifndef UV2\nvar uv2Updated: vec2f= vec2f(0.,0.);\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_MATRIXNAME_,baseColor,_INFONAME_,BaseColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_MATRIXNAME_,baseMetalness,_INFONAME_,BaseMetalnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_MATRIXNAME_,specularWeight,_INFONAME_,SpecularWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_MATRIXNAME_,specularColor,_INFONAME_,SpecularColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_MATRIXNAME_,specularRoughness,_INFONAME_,SpecularRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_MATRIXNAME_,specularRoughnessAnisotropy,_INFONAME_,SpecularRoughnessAnisotropyInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_MATRIXNAME_,coatWeight,_INFONAME_,CoatWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_COLOR,_VARYNAME_,CoatColor,_MATRIXNAME_,coatColor,_INFONAME_,CoatColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_MATRIXNAME_,coatRoughness,_INFONAME_,CoatRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_MATRIXNAME_,coatRoughnessAnisotropy,_INFONAME_,CoatRoughnessAnisotropyInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_MATRIXNAME_,coatDarkening,_INFONAME_,CoatDarkeningInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,FUZZ_WEIGHT,_VARYINGNAME_,FuzzWeight,_MATRIXNAME_,fuzzWeight,_INFONAME_,FuzzWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,FUZZ_COLOR,_VARYINGNAME_,FuzzColor,_MATRIXNAME_,fuzzColor,_INFONAME_,FuzzColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,FUZZ_ROUGHNESS,_VARYINGNAME_,FuzzRoughness,_MATRIXNAME_,fuzzRoughness,_INFONAME_,FuzzRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_MATRIXNAME_,geometryNormal,_INFONAME_,GeometryNormalInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_MATRIXNAME_,geometryTangent,_INFONAME_,GeometryTangentInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_MATRIXNAME_,geometryCoatNormal,_INFONAME_,GeometryCoatNormalInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_MATRIXNAME_,geometryOpacity,_INFONAME_,GeometryOpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_MATRIXNAME_,emissionColor,_INFONAME_,EmissionColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_MATRIXNAME_,thinFilmWeight,_INFONAME_,ThinFilmWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_MATRIXNAME_,thinFilmThickness,_INFONAME_,ThinFilmThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_MATRIXNAME_,ambientOcclusion,_INFONAME_,AmbientOcclusionInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<openpbrNormalMapVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";bt$1.ShadersStoreWGSL[t$b]||(bt$1.ShadersStoreWGSL[t$b]=r$n);const o$f={name:t$b,shader:r$n};var openpbr_vertex_dEIwCXg_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,openpbrVertexShaderWGSL:o$f});const n$8="openpbrFragmentSamplersDeclaration";bt$1.IncludesShadersStoreWGSL[n$8]||(bt$1.IncludesShadersStoreWGSL[n$8]="#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_SAMPLERNAME_,baseColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_SAMPLERNAME_,baseMetalness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_SAMPLERNAME_,specularWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_SAMPLERNAME_,specularColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_SAMPLERNAME_,specularRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_SAMPLERNAME_,specularRoughnessAnisotropy)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_SAMPLERNAME_,coatWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor,_SAMPLERNAME_,coatColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_SAMPLERNAME_,coatRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_SAMPLERNAME_,coatRoughnessAnisotropy)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_SAMPLERNAME_,coatDarkening)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_WEIGHT,_VARYINGNAME_,FuzzWeight,_SAMPLERNAME_,fuzzWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_COLOR,_VARYINGNAME_,FuzzColor,_SAMPLERNAME_,fuzzColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_ROUGHNESS,_VARYINGNAME_,FuzzRoughness,_SAMPLERNAME_,fuzzRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_SAMPLERNAME_,geometryOpacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_SAMPLERNAME_,geometryTangent)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_TANGENT,_VARYINGNAME_,GeometryCoatTangent,_SAMPLERNAME_,geometryCoatTangent)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_SAMPLERNAME_,emissionColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_SAMPLERNAME_,thinFilmWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_SAMPLERNAME_,thinFilmThickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_SAMPLERNAME_,ambientOcclusion)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;\n#endif\n#ifdef USEIRRADIANCEMAP\nvar irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;\n#endif\n#else\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;\n#endif\n#ifdef USEIRRADIANCEMAP\nvar irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nvar environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;\n#endif\n#ifdef FUZZENVIRONMENTBRDF\nvar environmentFuzzBrdfSamplerSampler: sampler;var environmentFuzzBrdfSampler: texture_2d<f32>;\n#endif\n#if defined(ANISOTROPIC) || defined(FUZZ)\nvar blueNoiseSamplerSampler: sampler;var blueNoiseSampler: texture_2d<f32>;\n#endif\n#ifdef IBL_CDF_FILTERING\nvar icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;\n#endif\n");const r$m="openpbrNormalMapFragmentMainFunctions";bt$1.IncludesShadersStoreWGSL[r$m]||(bt$1.IncludesShadersStoreWGSL[r$m]="#if defined(GEOMETRY_NORMAL) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(FUZZ) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f\n{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; \nvar a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; \nvar a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(\n(a11*b11-a12*b10+a13*b09)/det,\n(a02*b10-a01*b11-a03*b09)/det,\n(a31*b05-a32*b04+a33*b03)/det,\n(a22*b04-a21*b05-a23*b03)/det,\n(a12*b08-a10*b11-a13*b07)/det,\n(a00*b11-a02*b08+a03*b07)/det,\n(a32*b02-a30*b05-a33*b01)/det,\n(a20*b05-a22*b02+a23*b01)/det,\n(a10*b10-a11*b08+a13*b06)/det,\n(a01*b08-a00*b10-a03*b06)/det,\n(a30*b04-a31*b02+a33*b00)/det,\n(a21*b02-a20*b04-a23*b00)/det,\n(a11*b07-a10*b09-a12*b06)/det,\n(a00*b09-a01*b07+a02*b06)/det,\n(a31*b01-a30*b03-a32*b00)/det,\n(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\nfn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f\n{var output=normal;\n#ifdef NORMALXYSCALE\noutput=normalize(output* vec3f(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*output);}\nfn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nfn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f\n{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}\n#endif\n");const a$d="openpbrNormalMapFragmentFunctions";bt$1.IncludesShadersStoreWGSL[a$d]||(bt$1.IncludesShadersStoreWGSL[a$d]="#if defined(GEOMETRY_NORMAL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_SAMPLERNAME_,geometryNormal)\n#endif\n#if defined(GEOMETRY_COAT_NORMAL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_SAMPLERNAME_,geometryCoatNormal)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(GEOMETRY_NORMAL) && defined(PARALLAX)\nconst minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)\n{currSampledHeight=textureSample(geometryNormalSampler,geometryNormalSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nfn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f\n{var height: f32=textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n");const i$6="openpbrDielectricReflectance";bt$1.IncludesShadersStoreWGSL[i$6]||(bt$1.IncludesShadersStoreWGSL[i$6]="struct ReflectanceParams\n{F0: f32,\nF90: f32,\ncoloredF0: vec3f,\ncoloredF90: vec3f,};\n#define pbr_inline\nfn dielectricReflectance(\ninsideIOR: f32,outsideIOR: f32,specularColor: vec3f,specularWeight: f32\n)->ReflectanceParams\n{var outParams: ReflectanceParams;let dielectricF0=pow((insideIOR-outsideIOR)/(insideIOR+outsideIOR),2.0);\n#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF\nlet maxF0=max(specularColor.r,max(specularColor.g,specularColor.b));outParams.F0=dielectricF0*maxF0*specularWeight;\n#else\noutParams.F0=dielectricF0*specularWeight;\n#endif\nlet f90Scale=clamp(2.0f*abs(insideIOR-outsideIOR),0.0f,1.0f);outParams.F90=f90Scale*specularWeight;outParams.coloredF0=vec3f(dielectricF0*specularWeight)*specularColor.rgb;\n#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)\nlet dielectricColorF90: vec3f=specularColor.rgb*vec3f(f90Scale)*specularWeight;\n#else\nlet dielectricColorF90: vec3f=vec3f(f90Scale)*specularWeight;\n#endif\noutParams.coloredF90=dielectricColorF90;return outParams;}\n");const o$e="openpbrConductorReflectance";bt$1.IncludesShadersStoreWGSL[o$e]||(bt$1.IncludesShadersStoreWGSL[o$e]="#define pbr_inline\nfn conductorReflectance(baseColor: vec3f,specularColor: vec3f,specularWeight: f32)->ReflectanceParams\n{var outParams: ReflectanceParams;\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\noutParams.coloredF0=baseColor*specularWeight;outParams.coloredF90=specularColor*specularWeight;\n#else\noutParams.coloredF0=baseColor;outParams.coloredF90=vec3f(1.0f);\n#endif\noutParams.F0=1.0f;outParams.F90=1.0f;return outParams;}");const t$a="openpbrBlockAmbientOcclusion";bt$1.IncludesShadersStoreWGSL[t$a]||(bt$1.IncludesShadersStoreWGSL[t$a]="struct ambientOcclusionOutParams\n{ambientOcclusionColor: vec3f,\n#if DEBUGMODE>0 && defined(AMBIENT_OCCLUSION)\nambientOcclusionColorMap: vec3f\n#endif\n};\n#define pbr_inline\nfn ambientOcclusionBlock(\n#ifdef AMBIENT_OCCLUSION\nambientOcclusionColorMap_: vec3f,\nambientInfos: vec2f\n#endif\n)->ambientOcclusionOutParams\n{ \nvar outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);\n#ifdef AMBIENT_OCCLUSION\nvar ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*ambientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}\n");const f$1="openpbrGeometryInfo";bt$1.IncludesShadersStoreWGSL[f$1]||(bt$1.IncludesShadersStoreWGSL[f$1]="struct geometryInfoOutParams\n{NdotV: f32,\nNdotVUnclamped: f32,\nenvironmentBrdf: vec3f,\nhorizonOcclusion: f32};struct geometryInfoAnisoOutParams\n{NdotV: f32,\nNdotVUnclamped: f32,\nenvironmentBrdf: vec3f,\nhorizonOcclusion: f32,\nanisotropy: f32,\nanisotropicTangent: vec3f,\nanisotropicBitangent: vec3f,\nTBN: mat3x3<f32>};fn geometryInfo(\nnormalW: vec3f,viewDirectionW: vec3f,roughness: f32,geometricNormalW: vec3f\n)->geometryInfoOutParams\n{var outParams: geometryInfoOutParams;outParams.NdotVUnclamped=dot(normalW,viewDirectionW);outParams.NdotV=absEps(outParams.NdotVUnclamped);\n#if defined(ENVIRONMENTBRDF)\noutParams.environmentBrdf=getBRDFLookup(outParams.NdotV,roughness);\n#else\noutParams.environmentBrdf=vec3f(0.0);\n#endif\noutParams.horizonOcclusion=1.0f;\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef HORIZONOCCLUSION\n#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL)\n#ifdef REFLECTIONMAP_3D\noutParams.horizonOcclusion=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\nreturn outParams;}\nfn geometryInfoAniso(\nnormalW: vec3f,viewDirectionW: vec3f,roughness: f32,geometricNormalW: vec3f\n,vAnisotropy: vec3f,TBN: mat3x3<f32>\n)->geometryInfoAnisoOutParams\n{let geoInfo: geometryInfoOutParams=geometryInfo(normalW,viewDirectionW,roughness,geometricNormalW);var outParams: geometryInfoAnisoOutParams;outParams.NdotV=geoInfo.NdotV;outParams.NdotVUnclamped=geoInfo.NdotVUnclamped;outParams.environmentBrdf=geoInfo.environmentBrdf;outParams.horizonOcclusion=geoInfo.horizonOcclusion;outParams.anisotropy=vAnisotropy.b;let anisotropyDirection: vec3f=vec3f(vAnisotropy.xy,0.);let anisoTBN: mat3x3<f32>=mat3x3<f32>(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));outParams.anisotropicTangent=normalize(anisoTBN*anisotropyDirection);outParams.anisotropicBitangent=normalize(cross(anisoTBN[2],outParams.anisotropicTangent));outParams.TBN=TBN;return outParams;}\n");const l$1="openpbrIblFunctions";bt$1.IncludesShadersStoreWGSL[l$1]||(bt$1.IncludesShadersStoreWGSL[l$1]="#ifdef REFLECTION\nfn sampleIrradiance(\nsurfaceNormal: vec3f\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,vEnvironmentIrradianceSH: vec3f\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,iblMatrix: mat4x4f\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,irradianceSampler: texture_cube<f32>\n,irradianceSamplerSampler: sampler\n#else\n,irradianceSampler: texture_2d<f32>\n,irradianceSamplerSampler: sampler\n#endif\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\n,reflectionDominantDirection: vec3f\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,reflectionFilteringInfo: vec2f\n#ifdef IBL_CDF_FILTERING\n,icdfSampler: texture_2d<f32>\n,icdfSamplerSampler: sampler\n#endif\n#endif\n,reflectionInfos: vec2f\n,viewDirectionW: vec3f\n,diffuseRoughness: f32\n,surfaceAlbedo: vec3f\n)->vec3f {var environmentIrradiance=vec3f(0.,0.,0.);\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\nvar irradianceVector=(iblMatrix*vec4f(surfaceNormal,0.0f)).xyz;let irradianceView=(iblMatrix*vec4f(viewDirectionW,0.0f)).xyz;\n#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)\n#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY\n{let NdotV=max(dot(surfaceNormal,viewDirectionW),0.0f);irradianceVector=mix(irradianceVector,irradianceView,(0.5f*(1.0f-NdotV))*diffuseRoughness);}\n#endif\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0f;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0f;\n#endif\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradianceSH;\n#else\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,reflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nlet environmentIrradianceFromTexture: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,irradianceVector);\n#else\nlet environmentIrradianceFromTexture: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);\n#endif\nenvironmentIrradiance=environmentIrradianceFromTexture.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradianceFromTexture);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\nlet Ls: vec3f=normalize(reflectionDominantDirection);let NoL: f32=dot(irradianceVector,Ls);let NoV: f32=dot(irradianceVector,irradianceView);var diffuseRoughnessTerm=vec3f(1.0f);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nlet LoV: f32=dot (Ls,irradianceView);let mag: f32=length(reflectionDominantDirection)*2.0f;let clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1f),vec3f(1.0f));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3f(1.0f),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0f,1.0f)));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\nlet H: vec3f=(irradianceView+Ls)*0.5f;let VoH: f32=dot(irradianceView,H);diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);\n#endif\nenvironmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;\n#endif\n#endif\nenvironmentIrradiance*=reflectionInfos.x;return environmentIrradiance;}\n#ifdef REFLECTIONMAP_3D\nfn createReflectionCoords(vPositionW: vec3f,normalW: vec3f)->vec3f\n#else\nfn createReflectionCoords(vPositionW: vec3f,normalW: vec3f)->vec2f\n#endif\n{var reflectionVector: vec3f=computeReflectionCoords(vec4f(vPositionW,1.0f),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvar reflectionCoords: vec3f=reflectionVector;\n#else\nvar reflectionCoords: vec2f=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0f-reflectionCoords.y;\n#endif\nreturn reflectionCoords;}\nfn sampleRadiance(\nalphaG: f32\n,reflectionMicrosurfaceInfos: vec3f\n,reflectionInfos: vec2f\n,geoInfo: geometryInfoOutParams\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec3f\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec2f\n#endif\n#ifdef REALTIME_FILTERING\n,reflectionFilteringInfo: vec2f\n#endif\n)->vec3f {var environmentRadiance: vec4f=vec4f(0.f,0.f,0.f,0.f);\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nvar reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,alphaG,geoInfo.NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nvar reflectionLOD: f32=getLinearLodFromRoughness(reflectionMicrosurfaceInfos.x,roughness);\n#else\nvar reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,alphaG);\n#endif\nreflectionLOD=reflectionLOD*reflectionMicrosurfaceInfos.y+reflectionMicrosurfaceInfos.z;\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionFilteringInfo),1.0f);\n#else\nenvironmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nreturn environmentRadiance.rgb;}\n#if defined(ANISOTROPIC)\nfn sampleRadianceAnisotropic(\nalphaG: f32\n,reflectionMicrosurfaceInfos: vec3f\n,reflectionInfos: vec2f\n,geoInfo: geometryInfoAnisoOutParams\n,normalW: vec3f\n,viewDirectionW: vec3f\n,positionW: vec3f\n,noise: vec3f\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n#endif\n#ifdef REALTIME_FILTERING\n,reflectionFilteringInfo: vec2f\n#endif\n)->vec3f {var environmentRadiance: vec4f=vec4f(0.f,0.f,0.f,0.f);let alphaT=alphaG*sqrt(2.0f/(1.0f+(1.0f-geoInfo.anisotropy)*(1.0f-geoInfo.anisotropy)));let alphaB=(1.0f-geoInfo.anisotropy)*alphaT;let modifiedAlphaG=alphaB;\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nvar reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,modifiedAlphaG,geoInfo.NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nvar reflectionLOD: f32=getLinearLodFromRoughness(reflectionMicrosurfaceInfos.x,roughness);\n#else\nvar reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,modifiedAlphaG);\n#endif\nreflectionLOD=reflectionLOD*reflectionMicrosurfaceInfos.y+reflectionMicrosurfaceInfos.z;\n#ifdef REALTIME_FILTERING\nvar view=(uniforms.reflectionMatrix*vec4f(viewDirectionW,0.0f)).xyz;var tangent=(uniforms.reflectionMatrix*vec4f(geoInfo.anisotropicTangent,0.0f)).xyz;var bitangent=(uniforms.reflectionMatrix*vec4f(geoInfo.anisotropicBitangent,0.0f)).xyz;var normal=(uniforms.reflectionMatrix*vec4f(normalW,0.0f)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nview.z*=-1.0f;tangent.z*=-1.0f;bitangent.z*=-1.0f;normal.z*=-1.0f;\n#endif\nenvironmentRadiance =\nvec4f(radianceAnisotropic(alphaT,alphaB,reflectionSampler,reflectionSamplerSampler,\nview,tangent,\nbitangent,normal,\nreflectionFilteringInfo,noise.xy),\n1.0f);\n#else\nconst samples: i32=16;var radianceSample=vec4f(0.0);var accumulatedRadiance=vec3f(0.0);var reflectionCoords=vec3f(0.0);var sample_weight=0.0f;var total_weight=0.0f;let step=1.0f/f32(max(samples-1,1));for (var i: i32=0; i<samples; i++) {var t: f32=mix(-1.0,1.0,f32(i)*step);t+=step*2.0*noise.x;sample_weight=max(1.0-abs(t),0.001);sample_weight*=sample_weight;t*=min(4.0*alphaT*geoInfo.anisotropy,1.0);var bentNormal: vec3f;if (t<0.0) {let blend: f32=t+1.0;bentNormal=normalize(mix(-geoInfo.anisotropicTangent,normalW,blend));} else if (t>0.0) {let blend: f32=t;bentNormal=normalize(mix(normalW,geoInfo.anisotropicTangent,blend));} else {bentNormal=normalW;}\nreflectionCoords=createReflectionCoords(positionW,bentNormal);radianceSample=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);\n#ifdef RGBDREFLECTION\naccumulatedRadiance+=vec3f(sample_weight)*fromRGBD(radianceSample);\n#elif defined(GAMMAREFLECTION)\naccumulatedRadiance+=vec3f(sample_weight)*toLinearSpace(radianceSample.rgb);\n#else\naccumulatedRadiance+=vec3f(sample_weight)*radianceSample.rgb;\n#endif\ntotal_weight+=sample_weight;}\nenvironmentRadiance=vec4f(accumulatedRadiance/vec3f(total_weight),1.0f);\n#endif\nenvironmentRadiance=vec4f(environmentRadiance.rgb*reflectionInfos.xxx,environmentRadiance.a);return environmentRadiance.rgb;}\n#endif\nfn conductorIblFresnel(reflectance: ReflectanceParams,NdotV: f32,roughness: f32,environmentBrdf: vec3f)->vec3f\n{\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\nlet albedoF0: vec3f=mix(reflectance.coloredF0,pow(reflectance.coloredF0,vec3f(1.4f)),roughness);return getF82Specular(NdotV,albedoF0,reflectance.coloredF90,roughness);\n#else\nreturn getReflectanceFromBRDFLookup(reflectance.coloredF0,reflectance.coloredF90,environmentBrdf);\n#endif\n}\n#endif\n");const s$2="openpbrNormalMapFragment";bt$1.IncludesShadersStoreWGSL[s$2]||(bt$1.IncludesShadersStoreWGSL[s$2]="var uvOffset: vec2f= vec2f(0.0,0.0);\n#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nvar normalScale: f32=1.0;\n#elif defined(GEOMETRY_NORMAL)\nvar normalScale: f32=uniforms.vGeometryNormalInfos.y;\n#else\nvar normalScale: f32=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nvar TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); \n#elif defined(GEOMETRY_NORMAL)\nvar TBNUV: vec2f=select(-fragmentInputs.vGeometryNormalUV,fragmentInputs.vGeometryNormalUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);\n#else\nvar TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));\n#endif\n#elif defined(ANISOTROPIC) || defined(FUZZ)\n#if defined(TANGENT) && defined(NORMAL)\nvar TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2);\n#else\nvar TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nvar invTBN: mat3x3f=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\n#else\n#endif\n#endif\n#ifdef DETAIL\nvar detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);\n#endif\n#ifdef GEOMETRY_COAT_NORMAL\ncoatNormalW=perturbNormal(TBN,textureSample(geometryCoatNormalSampler,geometryCoatNormalSamplerSampler,fragmentInputs.vGeometryCoatNormalUV+uvOffset).xyz,uniforms.vGeometryCoatNormalInfos.y);\n#endif\n#ifdef GEOMETRY_NORMAL\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV+uvOffset).xyz,uniforms.vGeometryNormalInfos.y);\n#else\nvar sampledNormal: vec3f=textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(sampledNormal.xy+detailNormal.xy,sampledNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);sampledNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=sampledNormal*dot(sampledNormal,detailNormal)/sampledNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,uniforms.vGeometryNormalInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);\n#endif\n");const c$1="openpbrBlockNormalFinal";bt$1.IncludesShadersStoreWGSL[c$1]||(bt$1.IncludesShadersStoreWGSL[c$1]="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvar faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);\n#endif\nnormalW*=sign(dot(normalW,faceNormal));coatNormalW*=sign(dot(coatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\n#if defined(MIRRORED)\nnormalW=select(normalW,-normalW,fragmentInputs.frontFacing);coatNormalW=select(coatNormalW,-coatNormalW,fragmentInputs.frontFacing);\n#else\nnormalW=select(-normalW,normalW,fragmentInputs.frontFacing);coatNormalW=select(-coatNormalW,coatNormalW,fragmentInputs.frontFacing);\n#endif\n#endif\n");const m$1="openpbrBaseLayerData";bt$1.IncludesShadersStoreWGSL[m$1]||(bt$1.IncludesShadersStoreWGSL[m$1]="var base_color=vec3f(0.8);var base_metalness: f32=0.0;var base_diffuse_roughness: f32=0.0;var specular_weight: f32=1.0;var specular_roughness: f32=0.3;var specular_color: vec3f=vec3f(1.0);var specular_roughness_anisotropy: f32=0.0;var specular_ior: f32=1.5;var alpha: f32=1.0;var geometry_tangent: vec2f=vec2f(1.0,0.0);\n#ifdef BASE_WEIGHT\nlet baseWeightFromTexture: vec4f=textureSample(baseWeightSampler,baseWeightSamplerSampler,fragmentInputs.vBaseWeightUV+uvOffset);\n#endif\n#ifdef BASE_COLOR\nlet baseColorFromTexture: vec4f=textureSample(baseColorSampler,baseColorSamplerSampler,fragmentInputs.vBaseColorUV+uvOffset);\n#endif\n#ifdef BASE_METALNESS\nlet metallicFromTexture: vec4f=textureSample(baseMetalnessSampler,baseMetalnessSamplerSampler,fragmentInputs.vBaseMetalnessUV+uvOffset);\n#endif\n#ifdef BASE_DIFFUSE_ROUGHNESS\nlet baseDiffuseRoughnessFromTexture: f32=textureSample(baseDiffuseRoughnessSampler,baseDiffuseRoughnessSamplerSampler,fragmentInputs.vBaseDiffuseRoughnessUV+uvOffset).r;\n#endif\n#ifdef GEOMETRY_TANGENT\nlet geometryTangentFromTexture: vec3f=textureSample(geometryTangentSampler,geometryTangentSamplerSampler,fragmentInputs.vGeometryTangentUV+uvOffset).rgb;\n#endif\n#ifdef SPECULAR_ROUGHNESS_ANISOTROPY\nlet anisotropyFromTexture: f32=textureSample(specularRoughnessAnisotropySampler,specularRoughnessAnisotropySamplerSampler,fragmentInputs.vSpecularRoughnessAnisotropyUV+uvOffset).r*uniforms.vSpecularRoughnessAnisotropyInfos.y;\n#endif\n#ifdef GEOMETRY_OPACITY\nlet opacityFromTexture: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nlet decalFromTexture: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#endif\n#ifdef SPECULAR_COLOR\nlet specularColorFromTexture: vec4f=textureSample(specularColorSampler,specularColorSamplerSampler,fragmentInputs.vSpecularColorUV+uvOffset);\n#endif\n#if defined(SPECULAR_WEIGHT)\n#ifdef SPECULAR_WEIGHT_IN_ALPHA\nlet specularWeightFromTexture: f32=textureSample(specularWeightSampler,specularWeightSamplerSampler,fragmentInputs.vSpecularWeightUV+uvOffset).a;\n#else\nlet specularWeightFromTexture: f32=textureSample(specularWeightSampler,specularWeightSamplerSampler,fragmentInputs.vSpecularWeightUV+uvOffset).r;\n#endif\n#endif\n#if defined(ANISOTROPIC) || defined(FUZZ)\nlet noise=textureSample(blueNoiseSampler,blueNoiseSamplerSampler,fragmentInputs.position.xy/256.0).xyz;\n#endif\n#if defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS)\nlet roughnessFromTexture: f32=metallicFromTexture.g;\n#elif defined(SPECULAR_ROUGHNESS)\nlet roughnessFromTexture: f32=textureSample(specularRoughnessSampler,specularRoughnessSamplerSampler,fragmentInputs.vSpecularRoughnessUV+uvOffset).r;\n#endif\nbase_color=uniforms.vBaseColor.rgb;\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbase_color*=fragmentInputs.vColor.rgb;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=fragmentInputs.vColor.a;\n#endif\nbase_color*=vec3(uniforms.vBaseWeight);alpha=uniforms.vBaseColor.a;base_metalness=uniforms.vReflectanceInfo.x;base_diffuse_roughness=uniforms.vBaseDiffuseRoughness;specular_roughness=uniforms.vReflectanceInfo.y;specular_color=uniforms.vSpecularColor.rgb;specular_weight=uniforms.vReflectanceInfo.a;specular_ior=uniforms.vReflectanceInfo.z;specular_roughness_anisotropy=uniforms.vSpecularAnisotropy.b;geometry_tangent=uniforms.vSpecularAnisotropy.rg;\n#ifdef BASE_COLOR\n#ifdef BASE_COLOR_GAMMA\nbase_color*=toLinearSpace(baseColorFromTexture.rgb);\n#else\nbase_color*=baseColorFromTexture.rgb;\n#endif\nbase_color*=uniforms.vBaseColorInfos.y;\n#endif\n#ifdef BASE_WEIGHT\nbase_color*=baseWeightFromTexture.r;\n#endif\n#if defined(BASE_COLOR) && defined(ALPHA_FROM_BASE_COLOR_TEXTURE)\nalpha*=baseColorFromTexture.a;\n#elif defined(GEOMETRY_OPACITY)\nalpha*=opacityFromTexture.a;alpha*=uniforms.vGeometryOpacityInfos.y;\n#endif\n#ifdef ALPHATEST\n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#ifdef BASE_METALNESS\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nbase_metalness*=metallicFromTexture.b;\n#else\nbase_metalness*=metallicFromTexture.r;\n#endif\n#endif\n#ifdef BASE_DIFFUSE_ROUGHNESS\nbase_diffuse_roughness*=baseDiffuseRoughnessFromTexture*uniforms.vBaseDiffuseRoughnessInfos.y;\n#endif\n#ifdef SPECULAR_COLOR\n#ifdef SPECULAR_COLOR_GAMMA\nspecular_color*=toLinearSpace(specularColorFromTexture.rgb);\n#else\nspecular_color*=specularColorFromTexture.rgb;\n#endif\n#endif\n#ifdef SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE\nspecular_weight*=specularColorFromTexture.a;\n#elif defined(SPECULAR_WEIGHT)\nspecular_weight*=specularWeightFromTexture;\n#endif\n#if defined(SPECULAR_ROUGHNESS) || (defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS))\nspecular_roughness*=roughnessFromTexture;\n#endif\n#ifdef GEOMETRY_TANGENT\n{let tangentFromTexture: vec2f=normalize(geometryTangentFromTexture.xy*vec2f(2.0f)-vec2f(1.0f));let tangent_angle_texture: f32=atan2(tangentFromTexture.y,tangentFromTexture.x);let tangent_angle_uniform: f32=atan2(geometry_tangent.y,geometry_tangent.x);let tangent_angle: f32=tangent_angle_texture+tangent_angle_uniform;geometry_tangent=vec2f(cos(tangent_angle),sin(tangent_angle));}\n#endif\n#if defined(GEOMETRY_TANGENT) && defined(SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)\nspecular_roughness_anisotropy*=geometryTangentFromTexture.b;\n#elif defined(SPECULAR_ROUGHNESS_ANISOTROPY)\nspecular_roughness_anisotropy*=anisotropyFromTexture;\n#endif\n#ifdef DETAIL\nlet detailRoughness: f32=mix(0.5f,detailColor.b,vDetailInfos.w);let loLerp: f32=mix(0.f,specular_roughness,detailRoughness*2.f);let hiLerp: f32=mix(specular_roughness,1.f,(detailRoughness-0.5f)*2.f);specular_roughness=mix(loLerp,hiLerp,step(detailRoughness,0.5f));\n#endif\n#ifdef USE_GLTF_STYLE_ANISOTROPY\nlet baseAlpha: f32=specular_roughness*specular_roughness;let roughnessT: f32=mix(baseAlpha,1.0f,specular_roughness_anisotropy*specular_roughness_anisotropy);let roughnessB: f32=baseAlpha;specular_roughness_anisotropy=1.0f-roughnessB/max(roughnessT,0.00001f);specular_roughness=sqrt(roughnessT/sqrt(2.0f/(1.0f+(1.0f-specular_roughness_anisotropy)*(1.0f-specular_roughness_anisotropy))));\n#endif\n");const d$1="openpbrCoatLayerData";bt$1.IncludesShadersStoreWGSL[d$1]||(bt$1.IncludesShadersStoreWGSL[d$1]="var coat_weight: f32=0.0f;var coat_color: vec3f=vec3f(1.0f);var coat_roughness: f32=0.0f;var coat_roughness_anisotropy: f32=0.0f;var coat_ior: f32=1.6f;var coat_darkening: f32=1.0f;var geometry_coat_tangent: vec2f=vec2f(1.0f,0.0f);\n#ifdef COAT_WEIGHT\nvar coatWeightFromTexture: vec4f=textureSample(coatWeightSampler,coatWeightSamplerSampler,fragmentInputs.vCoatWeightUV+uvOffset);\n#endif\n#ifdef COAT_COLOR\nvar coatColorFromTexture: vec4f=textureSample(coatColorSampler,coatColorSamplerSampler,fragmentInputs.vCoatColorUV+uvOffset);\n#endif\n#ifdef COAT_ROUGHNESS\nvar coatRoughnessFromTexture: vec4f=textureSample(coatRoughnessSampler,coatRoughnessSamplerSampler,fragmentInputs.vCoatRoughnessUV+uvOffset);\n#endif\n#ifdef COAT_ROUGHNESS_ANISOTROPY\nvar coatRoughnessAnisotropyFromTexture: f32=textureSample(coatRoughnessAnisotropySampler,coatRoughnessAnisotropySamplerSampler,fragmentInputs.vCoatRoughnessAnisotropyUV+uvOffset).r;\n#endif\n#ifdef COAT_DARKENING\nvar coatDarkeningFromTexture: vec4f=textureSample(coatDarkeningSampler,coatDarkeningSamplerSampler,fragmentInputs.vCoatDarkeningUV+uvOffset);\n#endif\n#ifdef GEOMETRY_COAT_TANGENT\nvar geometryCoatTangentFromTexture: vec3f=textureSample(geometryCoatTangentSampler,geometryCoatTangentSamplerSampler,fragmentInputs.vGeometryCoatTangentUV+uvOffset).rgb;\n#endif\ncoat_color=uniforms.vCoatColor.rgb;coat_weight=uniforms.vCoatWeight;coat_roughness=uniforms.vCoatRoughness;coat_roughness_anisotropy=uniforms.vCoatRoughnessAnisotropy;coat_ior=uniforms.vCoatIor;coat_darkening=uniforms.vCoatDarkening;geometry_coat_tangent=uniforms.vGeometryCoatTangent.rg;\n#ifdef COAT_WEIGHT\ncoat_weight*=coatWeightFromTexture.r;\n#endif\n#ifdef COAT_COLOR\n#ifdef COAT_COLOR_GAMMA\ncoat_color*=toLinearSpace(coatColorFromTexture.rgb);\n#else\ncoat_color*=coatColorFromTexture.rgb;\n#endif\ncoat_color*=uniforms.vCoatColorInfos.y;\n#endif\n#ifdef COAT_ROUGHNESS\ncoat_roughness*=coatRoughnessFromTexture.r;\n#endif\n#if defined(GEOMETRY_COAT_TANGENT) && defined(COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)\ncoat_roughness_anisotropy*=geometryCoatTangentFromTexture.b;\n#elif defined(COAT_ROUGHNESS_ANISOTROPY)\ncoat_roughness_anisotropy*=coatRoughnessAnisotropyFromTexture;\n#endif\n#ifdef COAT_DARKENING\ncoat_darkening*=coatDarkeningFromTexture.r;\n#endif\n#ifdef GEOMETRY_COAT_TANGENT\n{let tangentFromTexture: vec2f=normalize(geometryCoatTangentFromTexture.xy*vec2f(2.0f)-vec2f(1.0f));let tangent_angle_texture: f32=atan2(tangentFromTexture.y,tangentFromTexture.x);let tangent_angle_uniform: f32=atan2(geometry_coat_tangent.y,geometry_coat_tangent.x);let tangent_angle: f32=tangent_angle_texture+tangent_angle_uniform;geometry_coat_tangent=vec2f(cos(tangent_angle),sin(tangent_angle));}\n#endif\n#ifdef USE_GLTF_STYLE_ANISOTROPY\nlet coatAlpha: f32=coat_roughness*coat_roughness;let coatRoughnessT: f32=mix(coatAlpha,1.0f,coat_roughness_anisotropy*coat_roughness_anisotropy);let coatRoughnessB: f32=coatAlpha;coat_roughness_anisotropy=1.0f-coatRoughnessB/max(coatRoughnessT,0.00001f);coat_roughness=sqrt(coatRoughnessT/sqrt(2.0f/(1.0f+(1.0f-coat_roughness_anisotropy)*(1.0f-coat_roughness_anisotropy))));\n#endif\n");const u$2="openpbrThinFilmLayerData";bt$1.IncludesShadersStoreWGSL[u$2]||(bt$1.IncludesShadersStoreWGSL[u$2]="#ifdef THIN_FILM\nvar thin_film_weight: f32=uniforms.vThinFilmWeight;var thin_film_thickness: f32=uniforms.vThinFilmThickness.r*1000.0f; \nvar thin_film_ior: f32=uniforms.vThinFilmIor;\n#ifdef THIN_FILM_WEIGHT\nvar thinFilmWeightFromTexture: f32=textureSample(thinFilmWeightSampler,thinFilmWeightSamplerSampler,fragmentInputs.vThinFilmWeightUV+uvOffset).r*uniforms.vThinFilmWeightInfos.y;\n#endif\n#ifdef THIN_FILM_THICKNESS\nvar thinFilmThicknessFromTexture: f32=textureSample(thinFilmThicknessSampler,thinFilmThicknessSamplerSampler,fragmentInputs.vThinFilmThicknessUV+uvOffset).g*uniforms.vThinFilmThicknessInfos.y;\n#endif\n#ifdef THIN_FILM_WEIGHT\nthin_film_weight*=thinFilmWeightFromTexture;\n#endif\n#ifdef THIN_FILM_THICKNESS\nthin_film_thickness*=thinFilmThicknessFromTexture;\n#endif\n#endif\n");const p$1="openpbrFuzzLayerData";bt$1.IncludesShadersStoreWGSL[p$1]||(bt$1.IncludesShadersStoreWGSL[p$1]="var fuzz_weight: f32=0.0f;var fuzz_color: vec3f=vec3f(1.0);var fuzz_roughness: f32=0.0f;\n#ifdef FUZZ\n#ifdef FUZZ_WEIGHT\nlet fuzzWeightFromTexture: vec4=textureSample(fuzzWeightSampler,fuzzWeightSamplerSampler,fragmentInputs.vFuzzWeightUV+uvOffset);\n#endif\n#ifdef FUZZ_COLOR\nvar fuzzColorFromTexture: vec4=textureSample(fuzzColorSampler,fuzzColorSamplerSampler,fragmentInputs.vFuzzColorUV+uvOffset);\n#endif\n#ifdef FUZZ_ROUGHNESS\nlet fuzzRoughnessFromTexture: vec4=textureSample(fuzzRoughnessSampler,fuzzRoughnessSamplerSampler,fragmentInputs.vFuzzRoughnessUV+uvOffset);\n#endif\nfuzz_color=uniforms.vFuzzColor.rgb;fuzz_weight=uniforms.vFuzzWeight;fuzz_roughness=uniforms.vFuzzRoughness;\n#ifdef FUZZ_WEIGHT\nfuzz_weight*=fuzzWeightFromTexture.r;\n#endif\n#ifdef FUZZ_COLOR\n#ifdef FUZZ_COLOR_GAMMA\nfuzz_color*=toLinearSpace(fuzzColorFromTexture.rgb);\n#else\nfuzz_color*=fuzzColorFromTexture.rgb;\n#endif\nfuzz_color*=uniforms.vFuzzColorInfos.y;\n#endif\n#if defined(FUZZ_ROUGHNESS) && defined(FUZZ_ROUGHNESS_FROM_COLOR_TEXTURE_ALPHA)\nfuzz_roughness*=fuzzRoughnessFromTexture.a;\n#elif defined(FUZZ_ROUGHNESS)\nfuzz_roughness*=fuzzRoughnessFromTexture.r;\n#endif\n#endif\n");const g$1="openpbrEnvironmentLighting";bt$1.IncludesShadersStoreWGSL[g$1]||(bt$1.IncludesShadersStoreWGSL[g$1]="#ifdef REFLECTION\n#ifdef FUZZ\nlet environmentFuzzBrdf: vec3f=getFuzzBRDFLookup(fuzzGeoInfo.NdotV,sqrt(fuzz_roughness));\n#endif\nvar baseDiffuseEnvironmentLight: vec3f=sampleIrradiance(\nnormalW\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,vEnvironmentIrradiance \n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,uniforms.reflectionMatrix\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n,irradianceSamplerSampler\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\n,uniforms.vReflectionDominantDirection\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n#endif\n,uniforms.vReflectionInfos\n,viewDirectionW\n,base_diffuse_roughness\n,base_color\n);\n#ifdef REFLECTIONMAP_3D\nvar reflectionCoords: vec3f=vec3f(0.f,0.f,0.f);\n#else\nvar reflectionCoords: vec2f=vec2f(0.f,0.f);\n#endif\nlet specularAlphaG: f32=specular_roughness*specular_roughness;\n#ifdef ANISOTROPIC_BASE\nvar baseSpecularEnvironmentLight: vec3f=sampleRadianceAnisotropic(specularAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos\n,baseGeoInfo\n,normalW\n,viewDirectionW\n,fragmentInputs.vPositionW\n,noise\n,reflectionSampler\n,reflectionSamplerSampler\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#endif\n);\n#else\nreflectionCoords=createReflectionCoords(fragmentInputs.vPositionW,normalW);var baseSpecularEnvironmentLight: vec3f=sampleRadiance(specularAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos\n,baseGeoInfo\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#endif\n);\n#endif\n#ifdef ANISOTROPIC_BASE\nbaseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG*specularAlphaG *max(1.0f-baseGeoInfo.anisotropy,0.3f));\n#else\nbaseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG);\n#endif\nvar coatEnvironmentLight: vec3f=vec3f(0.f,0.f,0.f);if (coat_weight>0.0) {\n#ifdef REFLECTIONMAP_3D\nvar reflectionCoords: vec3f=vec3f(0.f,0.f,0.f);\n#else\nvar reflectionCoords: vec2f=vec2f(0.f,0.f);\n#endif\nreflectionCoords=createReflectionCoords(fragmentInputs.vPositionW,coatNormalW);var coatAlphaG: f32=coat_roughness*coat_roughness;\n#ifdef ANISOTROPIC_COAT\ncoatEnvironmentLight=sampleRadianceAnisotropic(coatAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos\n,coatGeoInfo\n,coatNormalW\n,viewDirectionW\n,fragmentInputs.vPositionW\n,noise\n,reflectionSampler\n,reflectionSamplerSampler\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#endif\n);\n#else\ncoatEnvironmentLight=sampleRadiance(coatAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos\n,coatGeoInfo\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#endif\n);\n#endif\n}\n#ifdef FUZZ\nlet modifiedFuzzRoughness: f32=clamp(fuzz_roughness*(1.0f-0.5f*environmentFuzzBrdf.y),0.0f,1.0f);var fuzzEnvironmentLight=vec3f(0.0f,0.0f,0.0f);var totalWeight=0.0f;let fuzzIblFresnel: f32=sqrt(environmentFuzzBrdf.z);for (var i: i32=0; i<i32(FUZZ_IBL_SAMPLES); i++) {var angle: f32=(f32(i)+noise.x)*(3.141592f*2.0f/f32(FUZZ_IBL_SAMPLES));var fiberCylinderNormal: vec3f=normalize(cos(angle)*fuzzTangent+sin(angle)*fuzzBitangent);let fiberBend=min(environmentFuzzBrdf.x*environmentFuzzBrdf.x*modifiedFuzzRoughness,1.0f);fiberCylinderNormal=normalize(mix(fiberCylinderNormal,fuzzNormalW,fiberBend));let sampleWeight=max(dot(viewDirectionW,fiberCylinderNormal),0.0f);var fuzzReflectionCoords=createReflectionCoords(fragmentInputs.vPositionW,fiberCylinderNormal);let radianceSample: vec3f=sampleRadiance(modifiedFuzzRoughness,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos\n,fuzzGeoInfo\n,reflectionSampler\n,reflectionSamplerSampler\n,fuzzReflectionCoords\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#endif\n);fuzzEnvironmentLight+=sampleWeight*mix(radianceSample,baseDiffuseEnvironmentLight,fiberBend);totalWeight+=sampleWeight;}\nfuzzEnvironmentLight/=totalWeight;\n#endif\nlet dielectricIblFresnel: f32=getReflectanceFromBRDFWithEnvLookup(vec3f(baseDielectricReflectance.F0),vec3f(baseDielectricReflectance.F90),baseGeoInfo.environmentBrdf).r;var dielectricIblColoredFresnel: vec3f=dielectricIblFresnel*specular_color;\n#ifdef THIN_FILM\nlet thinFilmIorScale: f32=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);let thin_film_dielectric: vec3f=evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseDielectricReflectance.coloredF0);dielectricIblColoredFresnel=mix(dielectricIblColoredFresnel,thin_film_dielectric*specular_color,thin_film_weight*thinFilmIorScale);\n#endif\nvar conductorIblFresnel: vec3f=conductorIblFresnel(baseConductorReflectance,baseGeoInfo.NdotV,specular_roughness,baseGeoInfo.environmentBrdf);\n#ifdef THIN_FILM\nlet thinFilmConductorFresnel: vec3f=specular_weight*evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseConductorReflectance.coloredF0);conductorIblFresnel=mix(conductorIblFresnel,thinFilmConductorFresnel,thin_film_weight*thinFilmIorScale);\n#endif\nvar coatIblFresnel: f32=0.0;if (coat_weight>0.0) {coatIblFresnel=getReflectanceFromBRDFWithEnvLookup(vec3f(coatReflectance.F0),vec3f(coatReflectance.F90),coatGeoInfo.environmentBrdf).r;}\nvar slab_diffuse_ibl: vec3f=vec3f(0.,0.,0.);var slab_glossy_ibl: vec3f=vec3f(0.,0.,0.);var slab_metal_ibl: vec3f=vec3f(0.,0.,0.);var slab_coat_ibl: vec3f=vec3f(0.,0.,0.);slab_diffuse_ibl=baseDiffuseEnvironmentLight*uniforms.vLightingIntensity.z;slab_diffuse_ibl*=aoOut.ambientOcclusionColor;slab_glossy_ibl=baseSpecularEnvironmentLight*uniforms.vLightingIntensity.z;slab_metal_ibl=baseSpecularEnvironmentLight*conductorIblFresnel*uniforms.vLightingIntensity.z;var coatAbsorption=vec3f(1.0);if (coat_weight>0.0) {slab_coat_ibl=coatEnvironmentLight*uniforms.vLightingIntensity.z;let hemisphere_avg_fresnel: f32=coatReflectance.F0+0.5f*(1.0f-coatReflectance.F0);var averageReflectance: f32=(coatIblFresnel+hemisphere_avg_fresnel)*0.5f;let roughnessFactor=1.0f-coat_roughness*0.5f;averageReflectance*=roughnessFactor;var darkened_transmission: f32=(1.0f-averageReflectance)*(1.0f-averageReflectance);darkened_transmission=mix(1.0,darkened_transmission,coat_darkening);var sin2: f32=1.0f-coatGeoInfo.NdotV*coatGeoInfo.NdotV;sin2=sin2/(coat_ior*coat_ior);let cos_t: f32=sqrt(1.0f-sin2);let coatPathLength=1.0f/cos_t;let colored_transmission: vec3f=pow(coat_color,vec3f(coatPathLength));coatAbsorption=mix(vec3f(1.0f),colored_transmission*vec3f(darkened_transmission),coat_weight);}\n#ifdef FUZZ\nlet slab_fuzz_ibl=fuzzEnvironmentLight*uniforms.vLightingIntensity.z;\n#endif\nvar slab_subsurface_ibl: vec3f=vec3f(0.,0.,0.);var slab_translucent_base_ibl: vec3f=vec3f(0.,0.,0.);slab_diffuse_ibl*=base_color.rgb;\n#define CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION\nlet material_opaque_base_ibl: vec3f=mix(slab_diffuse_ibl,slab_subsurface_ibl,subsurface_weight);let material_dielectric_base_ibl: vec3f=mix(material_opaque_base_ibl,slab_translucent_base_ibl,transmission_weight);let material_dielectric_gloss_ibl: vec3f=material_dielectric_base_ibl*(1.0-dielectricIblFresnel)+slab_glossy_ibl*dielectricIblColoredFresnel;let material_base_substrate_ibl: vec3f=mix(material_dielectric_gloss_ibl,slab_metal_ibl,base_metalness);let material_coated_base_ibl: vec3f=layer(material_base_substrate_ibl,slab_coat_ibl,coatIblFresnel,coatAbsorption,vec3f(1.0f));\n#ifdef FUZZ\nmaterial_surface_ibl=layer(material_coated_base_ibl,slab_fuzz_ibl,fuzzIblFresnel*fuzz_weight,vec3(1.0),fuzz_color);\n#else\nmaterial_surface_ibl=material_coated_base_ibl;\n#endif\n#endif\n");const _$1="openpbrDirectLightingInit";bt$1.IncludesShadersStoreWGSL[_$1]||(bt$1.IncludesShadersStoreWGSL[_$1]="#ifdef LIGHT{X}\nvar preInfo{X}: preLightingInfo;var preInfoCoat{X}: preLightingInfo;let lightColor{X}: vec4f=light{X}.vLightDiffuse;var shadow{X}: f32=1.0f;\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\n#define CUSTOM_LIGHT{X}_COLOR \n#ifdef SPOTLIGHT{X}\npreInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);\n#elif defined(POINTLIGHT{X})\npreInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);\n#elif defined(HEMILIGHT{X})\npreInfo{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);\n#elif defined(DIRLIGHT{X})\npreInfo{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);\n#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\npreInfo{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,specular_roughness);preInfoCoat{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,coatNormalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,coat_roughness);\n#endif\npreInfo{X}.NdotV=baseGeoInfo.NdotV;preInfoCoat{X}.NdotV=coatGeoInfo.NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});\n#else\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});\n#else\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w);\n#endif\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});\n#else\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#endif\n#else\npreInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});\n#else\npreInfo{X}.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo{X}.attenuation=1.0f;\n#endif\npreInfoCoat{X}.attenuation=preInfo{X}.attenuation;\n#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})\npreInfo{X}.roughness=specular_roughness;preInfoCoat{X}.roughness=coat_roughness;\n#else\npreInfo{X}.roughness=adjustRoughnessFromLightProperties(specular_roughness,light{X}.vLightSpecular.a,preInfo{X}.lightDistance);preInfoCoat{X}.roughness=adjustRoughnessFromLightProperties(coat_roughness,light{X}.vLightSpecular.a,preInfoCoat{X}.lightDistance);\n#endif\npreInfo{X}.diffuseRoughness=base_diffuse_roughness;preInfo{X}.surfaceAlbedo=base_color.rgb;\n#endif\n#endif\n");const v$1="openpbrDirectLighting";bt$1.IncludesShadersStoreWGSL[v$1]||(bt$1.IncludesShadersStoreWGSL[v$1]="#ifdef LIGHT{X}\n{var slab_diffuse: vec3f=vec3f(0.f,0.f,0.f);var slab_subsurface: vec3f=vec3f(0.f,0.f,0.f);var slab_translucent: vec3f=vec3f(0.f,0.f,0.f);var slab_glossy: vec3f=vec3f(0.f,0.f,0.f);var specularFresnel: f32=0.0f;var specularColoredFresnel: vec3f=vec3f(0.f,0.f,0.f);var slab_metal: vec3f=vec3f(0.f,0.f,0.f);var slab_coat: vec3f=vec3f(0.f,0.f,0.f);var coatFresnel: f32=0.0f;var slab_fuzz: vec3f=vec3f(0.f,0.f,0.f);var fuzzFresnel: f32=0.0f;\n#ifdef HEMILIGHT{X}\nslab_diffuse=computeHemisphericDiffuseLighting(preInfo{X},lightColor{X}.rgb,light{X}.vLightGround);\n#elif defined(AREALIGHT{X})\nslab_diffuse=computeAreaDiffuseLighting(preInfo{X},lightColor{X}.rgb);\n#else\nslab_diffuse=computeDiffuseLighting(preInfo{X},lightColor{X}.rgb);\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nslab_diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);\n#endif\nnumLights+=1.0f;\n#ifdef FUZZ\nlet fuzzNdotH: f32=max(dot(fuzzNormalW,preInfo{X}.H),0.0f);let fuzzBrdf: vec3f=getFuzzBRDFLookup(fuzzNdotH,sqrt(fuzz_roughness));\n#endif\n#if AREALIGHT{X}\nslab_glossy=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);\n#else\n{\n#ifdef ANISOTROPIC_BASE\nslab_glossy=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,\nbaseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,\n0.0f,lightColor{X}.rgb);\n#else\nslab_glossy=computeSpecularLighting(preInfo{X},normalW,vec3(1.0),vec3(1.0),specular_roughness,lightColor{X}.rgb);\n#endif\nlet NdotH: f32=dot(normalW,preInfo{X}.H);specularFresnel=fresnelSchlickGGX(NdotH,baseDielectricReflectance.F0,baseDielectricReflectance.F90);specularColoredFresnel=specularFresnel*specular_color;\n#ifdef THIN_FILM\nlet thinFilmIorScale: f32=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);let thinFilmDielectricFresnel: vec3f=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseDielectricReflectance.coloredF0);specularColoredFresnel=mix(specularColoredFresnel,thinFilmDielectricFresnel*specular_color,thin_film_weight*thinFilmIorScale);\n#endif\n}\n#endif\n#if AREALIGHT{X}\nslab_metal=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);\n#else\n{\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\nvar coloredFresnel: vec3f=getF82Specular(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90,specular_roughness);\n#else\nvar coloredFresnel: vec3f=fresnelSchlickGGX(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90);\n#endif\n#ifdef THIN_FILM\nlet thinFilmIorScale: f32=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);let thinFilmConductorFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseConductorReflectance.coloredF0);coloredFresnel=mix(coloredFresnel,specular_weight*thinFilmIorScale*thinFilmConductorFresnel,thin_film_weight);\n#endif\n#ifdef ANISOTROPIC_BASE\nslab_metal=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,0.0,lightColor{X}.rgb);\n#else\nslab_metal=computeSpecularLighting(preInfo{X},normalW,vec3f(baseConductorReflectance.coloredF0),coloredFresnel,specular_roughness,lightColor{X}.rgb);\n#endif\n}\n#endif\n#if AREALIGHT{X}\nslab_coat=computeAreaSpecularLighting(preInfoCoat{X},light{X}.vLightSpecular.rgb,coatReflectance.F0,coatReflectance.F90);\n#else\n{\n#ifdef ANISOTROPIC_COAT\nslab_coat=computeAnisotropicSpecularLighting(preInfoCoat{X},viewDirectionW,coatNormalW,\ncoatGeoInfo.anisotropicTangent,coatGeoInfo.anisotropicBitangent,coatGeoInfo.anisotropy,0.0,\nlightColor{X}.rgb);\n#else\nslab_coat=computeSpecularLighting(preInfoCoat{X},coatNormalW,vec3f(coatReflectance.F0),vec3f(1.0f),coat_roughness,lightColor{X}.rgb);\n#endif\nlet NdotH: f32=dot(coatNormalW,preInfoCoat{X}.H);coatFresnel=fresnelSchlickGGX(NdotH,coatReflectance.F0,coatReflectance.F90);}\n#endif\nvar coatAbsorption=vec3f(1.0f);if (coat_weight>0.0) {let cosTheta_view: f32=max(preInfoCoat{X}.NdotV,0.001f);let cosTheta_light: f32=max(preInfoCoat{X}.NdotL,0.001f);let fresnel_view: f32=coatReflectance.F0+(1.0f-coatReflectance.F0)*pow(1.0f-cosTheta_view,5.0);let fresnel_light: f32=coatReflectance.F0+(1.0f-coatReflectance.F0)*pow(1.0f-cosTheta_light,5.0);let averageReflectance: f32=(fresnel_view+fresnel_light)*0.5;var darkened_transmission: f32=(1.0f-averageReflectance)/(1.0f+averageReflectance);darkened_transmission=mix(1.0f,darkened_transmission,coat_darkening);var sin2: f32=1.0f-coatGeoInfo.NdotV*coatGeoInfo.NdotV;sin2=sin2/(coat_ior*coat_ior);let cos_t: f32=sqrt(1.0f-sin2);let coatPathLength=1.0f/cos_t;let colored_transmission: vec3f=pow(coat_color,vec3f(coatPathLength));coatAbsorption=mix(vec3f(1.0f),colored_transmission*vec3f(darkened_transmission),coat_weight);}\n#ifdef FUZZ\nfuzzFresnel=fuzzBrdf.z;let fuzzNormalW=mix(normalW,coatNormalW,coat_weight);let fuzzNdotV: f32=max(dot(fuzzNormalW,viewDirectionW.xyz),0.0f);let fuzzNdotL: f32=max(dot(fuzzNormalW,preInfo{X}.L),0.0);slab_fuzz=lightColor{X}.rgb*preInfo{X}.attenuation*evalFuzz(preInfo{X}.L,fuzzNdotL,fuzzNdotV,fuzzTangent,fuzzBitangent,fuzzBrdf);\n#else\nlet fuzz_color=vec3f(0.0);\n#endif\nslab_diffuse*=base_color.rgb;let material_opaque_base: vec3f=mix(slab_diffuse,slab_subsurface,subsurface_weight);let material_dielectric_base: vec3f=mix(material_opaque_base,slab_translucent,transmission_weight);let material_dielectric_gloss: vec3f=material_dielectric_base*(1.0f-specularFresnel)+slab_glossy*specularColoredFresnel;let material_base_substrate: vec3f=mix(material_dielectric_gloss,slab_metal,base_metalness);let material_coated_base: vec3f=layer(material_base_substrate,slab_coat,coatFresnel,coatAbsorption,vec3f(1.0f));material_surface_direct+=layer(material_coated_base,slab_fuzz,fuzzFresnel*fuzz_weight,vec3f(1.0f),fuzz_color);}\n#endif\n");const I$1="openpbrPixelShader",E$1="#define OPENPBR_FRAGMENT_SHADER\n#define CUSTOM_FRAGMENT_BEGIN\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<openpbrUboDeclaration>\n#include<pbrFragmentExtraDeclaration>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<openpbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<openpbrNormalMapFragmentMainFunctions>\n#include<openpbrNormalMapFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<openpbrDielectricReflectance>\n#include<openpbrConductorReflectance>\n#include<openpbrBlockAmbientOcclusion>\n#include<openpbrGeometryInfo>\n#include<openpbrIblFunctions>\nfn layer(slab_bottom: vec3f,slab_top: vec3f,lerp_factor: f32,bottom_multiplier: vec3f,top_multiplier: vec3f)->vec3f {return mix(slab_bottom*bottom_multiplier,slab_top*top_multiplier,lerp_factor);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\nvar coatNormalW: vec3f=normalW;\n#include<openpbrNormalMapFragment>\n#include<openpbrBlockNormalFinal>\n#include<openpbrBaseLayerData>\n#include<openpbrCoatLayerData>\n#include<openpbrThinFilmLayerData>\n#include<openpbrFuzzLayerData>\nvar subsurface_weight: f32=0.0f;var transmission_weight: f32=0.0f;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nvar aoOut: ambientOcclusionOutParams;\n#ifdef AMBIENT_OCCLUSION\nvar ambientOcclusionFromTexture: vec3f=textureSample(ambientOcclusionSampler,ambientOcclusionSamplerSampler,fragmentInputs.vAmbientOcclusionUV+uvOffset).rgb;\n#endif\naoOut=ambientOcclusionBlock(\n#ifdef AMBIENT_OCCLUSION\nambientOcclusionFromTexture,\nuniforms.vAmbientOcclusionInfos\n#endif\n);\n#ifdef ANISOTROPIC_COAT\nlet coatGeoInfo: geometryInfoAnisoOutParams=geometryInfoAniso(\ncoatNormalW,viewDirectionW.xyz,coat_roughness,geometricNormalW\n,vec3f(geometry_coat_tangent.x,geometry_coat_tangent.y,coat_roughness_anisotropy),TBN\n);\n#else\nlet coatGeoInfo: geometryInfoOutParams=geometryInfo(\ncoatNormalW,viewDirectionW.xyz,coat_roughness,geometricNormalW\n);\n#endif\nspecular_roughness=mix(specular_roughness,pow(min(1.0f,pow(specular_roughness,4.0f)+2.0f*pow(coat_roughness,4.0f)),0.25f),coat_weight);\n#ifdef ANISOTROPIC_BASE\nlet baseGeoInfo: geometryInfoAnisoOutParams=geometryInfoAniso(\nnormalW,viewDirectionW.xyz,specular_roughness,geometricNormalW\n,vec3f(geometry_tangent.x,geometry_tangent.y,specular_roughness_anisotropy),TBN\n);\n#else\nlet baseGeoInfo: geometryInfoOutParams=geometryInfo(\nnormalW,viewDirectionW.xyz,specular_roughness,geometricNormalW\n);\n#endif\n#ifdef FUZZ\nlet fuzzNormalW=normalize(mix(normalW,coatNormalW,coat_weight));var fuzzTangent=normalize(TBN[0]);fuzzTangent=normalize(fuzzTangent-dot(fuzzTangent,fuzzNormalW)*fuzzNormalW);let fuzzBitangent=cross(fuzzNormalW,fuzzTangent);let fuzzGeoInfo: geometryInfoOutParams=geometryInfo(\nfuzzNormalW,viewDirectionW.xyz,fuzz_roughness,geometricNormalW\n);\n#endif\nlet coatReflectance: ReflectanceParams=dielectricReflectance(\ncoat_ior \n,1.0f \n,vec3f(1.0f)\n,coat_weight\n);\n#ifdef THIN_FILM\nlet thin_film_outside_ior: f32=mix(1.0f,coat_ior,coat_weight);\n#endif\nlet baseDielectricReflectance: ReflectanceParams=dielectricReflectance(\nspecular_ior \n,mix(1.0f,coat_ior,coat_weight) \n,specular_color\n,specular_weight\n);let baseConductorReflectance: ReflectanceParams=conductorReflectance(base_color,specular_color,specular_weight);var material_surface_ibl: vec3f=vec3f(0.f,0.f,0.f);\n#include<openpbrEnvironmentLighting>\nvar material_surface_direct: vec3f=vec3f(0.f,0.f,0.f);\n#if defined(LIGHT0)\nvar aggShadow: f32=0.f;var numLights: f32=0.f;\n#include<openpbrDirectLightingInit>[0..maxSimultaneousLights]\n#include<openpbrDirectLighting>[0..maxSimultaneousLights]\n#endif\nvar material_surface_emission: vec3f=uniforms.vEmissionColor;\n#ifdef EMISSION_COLOR\nlet emissionColorTex: vec3f=textureSample(emissionColorSampler,emissionColorSamplerSampler,uniforms.vEmissionColorUV+uvOffset).rgb;\n#ifdef EMISSION_COLOR_GAMMA\nmaterial_surface_emission*=toLinearSpace(emissionColorTex.rgb);\n#else\nmaterial_surface_emission*=emissionColorTex.rgb;\n#endif\nmaterial_surface_emission*= uniforms.vEmissionColorInfos.y;\n#endif\nmaterial_surface_emission*=uniforms.vLightingIntensity.y;\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\nvar finalColor: vec4f=vec4f(material_surface_ibl+material_surface_direct+material_surface_emission,alpha);\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,vec4f(0.0));\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#include<pbrBlockPrePass>\n#endif\n#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)\nfragmentOutputs.color=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStoreWGSL[I$1]||(bt$1.ShadersStoreWGSL[I$1]=E$1);const S={name:I$1,shader:E$1};var openpbr_fragmentCktw1RDZ_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,openpbrPixelShaderWGSL:S});const o$d="openpbrUboDeclaration";bt$1.IncludesShadersStore[o$d]||(bt$1.IncludesShadersStore[o$d]="layout(std140,column_major) uniform;uniform Material {vec2 vTangentSpaceParams;vec4 vLightingIntensity;float pointSize;vec2 vDebugMode;vec4 cameraInfo;vec2 vReflectionInfos;mat4 reflectionMatrix;vec3 vReflectionMicrosurfaceInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vReflectionFilteringInfo;vec3 vReflectionDominantDirection;vec3 vReflectionColor;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;float vBaseWeight;vec4 vBaseColor;float vBaseDiffuseRoughness;vec4 vReflectanceInfo;vec4 vSpecularColor;vec3 vSpecularAnisotropy;float vCoatWeight;vec3 vCoatColor;float vCoatRoughness;float vCoatRoughnessAnisotropy;float vCoatIor;float vCoatDarkening;float vFuzzWeight;vec3 vFuzzColor;float vFuzzRoughness;vec2 vGeometryCoatTangent;vec3 vEmissionColor;float vThinFilmWeight;vec2 vThinFilmThickness;float vThinFilmIor;vec2 vBaseWeightInfos;mat4 baseWeightMatrix;vec2 vBaseColorInfos;mat4 baseColorMatrix;vec2 vBaseDiffuseRoughnessInfos;mat4 baseDiffuseRoughnessMatrix;vec2 vBaseMetalnessInfos;mat4 baseMetalnessMatrix;vec2 vSpecularWeightInfos;mat4 specularWeightMatrix;vec2 vSpecularColorInfos;mat4 specularColorMatrix;vec2 vSpecularRoughnessInfos;mat4 specularRoughnessMatrix;vec2 vSpecularRoughnessAnisotropyInfos;mat4 specularRoughnessAnisotropyMatrix;vec2 vCoatWeightInfos;mat4 coatWeightMatrix;vec2 vCoatColorInfos;mat4 coatColorMatrix;vec2 vCoatRoughnessInfos;mat4 coatRoughnessMatrix;vec2 vCoatRoughnessAnisotropyInfos;mat4 coatRoughnessAnisotropyMatrix;vec2 vCoatDarkeningInfos;mat4 coatDarkeningMatrix;vec2 vFuzzWeightInfos;mat4 fuzzWeightMatrix;vec2 vFuzzColorInfos;mat4 fuzzColorMatrix;vec2 vFuzzRoughnessInfos;mat4 fuzzRoughnessMatrix;vec2 vGeometryNormalInfos;mat4 geometryNormalMatrix;vec2 vGeometryTangentInfos;mat4 geometryTangentMatrix;vec2 vGeometryCoatNormalInfos;mat4 geometryCoatNormalMatrix;vec2 vGeometryCoatTangentInfos;mat4 geometryCoatTangentMatrix;vec2 vGeometryOpacityInfos;mat4 geometryOpacityMatrix;vec2 vEmissionColorInfos;mat4 emissionColorMatrix;vec2 vThinFilmWeightInfos;mat4 thinFilmWeightMatrix;vec2 vThinFilmThicknessInfos;mat4 thinFilmThicknessMatrix;vec2 vAmbientOcclusionInfos;mat4 ambientOcclusionMatrix;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n");const n$7="openpbrVertexDeclaration";bt$1.IncludesShadersStore[n$7]||(bt$1.IncludesShadersStore[n$7]="uniform mat4 view;uniform mat4 viewProjection;uniform vec4 vEyePosition;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif\n#ifdef BASE_COLOR\nuniform vec2 vBaseColorInfos;uniform mat4 baseColorMatrix;\n#endif\n#ifdef BASE_WEIGHT\nuniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;\n#endif\nuniform float vBaseDiffuseRoughness;\n#ifdef BASE_DIFFUSE_ROUGHNESS\nuniform mat4 baseDiffuseRoughnessMatrix;uniform vec2 vBaseDiffuseRoughnessInfos;\n#endif\n#ifdef AMBIENT_OCCLUSION\nuniform vec2 vAmbientOcclusionInfos;uniform mat4 ambientOcclusionMatrix;\n#endif\n#ifdef EMISSION_COLOR\nuniform vec2 vEmissionColorInfos;uniform mat4 emissionColorMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#ifdef BASE_METALNESS\nuniform vec2 vBaseMetalnessInfos;uniform mat4 baseMetalnessMatrix;\n#endif\n#ifdef SPECULAR_WEIGHT\nuniform vec2 vSpecularWeightInfos;uniform mat4 specularWeightMatrix;\n#endif\n#ifdef SPECULAR_COLOR\nuniform vec2 vSpecularColorInfos;uniform mat4 specularColorMatrix;\n#endif\n#ifdef SPECULAR_ROUGHNESS\nuniform vec2 vSpecularRoughnessInfos;uniform mat4 specularRoughnessMatrix;\n#endif\n#ifdef SPECULAR_ROUGHNESS_ANISOTROPY\nuniform vec2 vSpecularRoughnessAnisotropyInfos;uniform mat4 specularRoughnessAnisotropyMatrix;\n#endif\n#ifdef COAT_WEIGHT\nuniform vec2 vCoatWeightInfos;uniform mat4 coatWeightMatrix;\n#endif\n#ifdef COAT_COLOR\nuniform vec2 vCoatColorInfos;uniform mat4 coatColorMatrix;\n#endif\n#ifdef COAT_ROUGHNESS\nuniform vec2 vCoatRoughnessInfos;uniform mat4 coatRoughnessMatrix;\n#endif\n#ifdef COAT_ROUGHNESS_ANISOTROPY\nuniform vec2 vCoatRoughnessAnisotropyInfos;uniform mat4 coatRoughnessAnisotropyMatrix;\n#endif\n#ifdef COAT_IOR\nuniform vec2 vCoatIorInfos;uniform mat4 coatIorMatrix;\n#endif\n#ifdef COAT_DARKENING\nuniform vec2 vCoatDarkeningInfos;uniform mat4 coatDarkeningMatrix;\n#endif\n#ifdef FUZZ_WEIGHT\nuniform vec2 vFuzzWeightInfos;uniform mat4 fuzzWeightMatrix;\n#endif\n#ifdef FUZZ_COLOR\nuniform vec2 vFuzzColorInfos;uniform mat4 fuzzColorMatrix;\n#endif\n#ifdef FUZZ_ROUGHNESS\nuniform vec2 vFuzzRoughnessInfos;uniform mat4 fuzzRoughnessMatrix;\n#endif\n#ifdef GEOMETRY_NORMAL\nuniform vec2 vGeometryNormalInfos;uniform mat4 geometryNormalMatrix;\n#endif\n#ifdef GEOMETRY_TANGENT\nuniform vec2 vGeometryTangentInfos;uniform mat4 geometryTangentMatrix;\n#endif\n#ifdef GEOMETRY_COAT_NORMAL\nuniform vec2 vGeometryCoatNormalInfos;uniform mat4 geometryCoatNormalMatrix;\n#endif\n#ifdef THIN_FILM_WEIGHT\nuniform vec2 vThinFilmWeightInfos;uniform mat4 thinFilmWeightMatrix;\n#endif\n#ifdef THIN_FILM_THICKNESS\nuniform vec2 vThinFilmThicknessInfos;uniform mat4 thinFilmThicknessMatrix;\n#endif\n#ifdef GEOMETRY_OPACITY\nuniform mat4 geometryOpacityMatrix;uniform vec2 vGeometryOpacityInfos;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\nuniform vec4 cameraInfo;\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n");const i$5="openpbrNormalMapVertexDeclaration";bt$1.IncludesShadersStore[i$5]||(bt$1.IncludesShadersStore[i$5]="#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(GEOMETRY_COAT_NORMAL) || defined(ANISOTROPIC) || defined(FUZZ)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n");const o$c="openpbrNormalMapVertex";bt$1.IncludesShadersStore[o$c]||(bt$1.IncludesShadersStore[o$c]="#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(GEOMETRY_COAT_NORMAL) || defined(ANISOTROPIC) || defined(FUZZ)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n");const r$l="openpbrVertexShader",t$9="#define OPENPBR_VERTEX_SHADER\n#define CUSTOM_VERTEX_EXTENSION\nprecision highp float;\n#include<__decl__openpbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy)\n#include<samplerVertexDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening)\n#include<samplerVertexDeclaration>(_DEFINENAME_,FUZZ_WEIGHT,_VARYINGNAME_,FuzzWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,FUZZ_COLOR,_VARYINGNAME_,FuzzColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,FUZZ_ROUGHNESS,_VARYINGNAME_,FuzzRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal)\n#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent)\n#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal)\n#include<samplerVertexDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor)\n#include<samplerVertexDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<openpbrNormalMapVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef VERTEXCOLOR\nvec4 colorUpdated=color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#if !defined(NATIVE) && !defined(WEBGPU)\nbool bbb=any(isnan(position));if (bbb) { }\n#endif\nfloat NdotV=max(dot(vNormalW,viewDirectionW),0.0);vec3 roughNormal=mix(vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*vBaseDiffuseRoughness);vec3 reflectionVector=vec3(reflectionMatrix*vec4(roughNormal,0)).xyz;\n#else\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2Updated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_MATRIXNAME_,baseColor,_INFONAME_,BaseColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_MATRIXNAME_,baseMetalness,_INFONAME_,BaseMetalnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_MATRIXNAME_,specularWeight,_INFONAME_,SpecularWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_MATRIXNAME_,specularColor,_INFONAME_,SpecularColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_MATRIXNAME_,specularRoughness,_INFONAME_,SpecularRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_MATRIXNAME_,specularRoughnessAnisotropy,_INFONAME_,SpecularRoughnessAnisotropyInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_MATRIXNAME_,coatWeight,_INFONAME_,CoatWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor,_MATRIXNAME_,coatColor,_INFONAME_,CoatColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_MATRIXNAME_,coatRoughness,_INFONAME_,CoatRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_MATRIXNAME_,coatRoughnessAnisotropy,_INFONAME_,CoatRoughnessAnisotropyInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_MATRIXNAME_,coatDarkening,_INFONAME_,CoatDarkeningInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,FUZZ_WEIGHT,_VARYINGNAME_,FuzzWeight,_MATRIXNAME_,fuzzWeight,_INFONAME_,FuzzWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,FUZZ_COLOR,_VARYINGNAME_,FuzzColor,_MATRIXNAME_,fuzzColor,_INFONAME_,FuzzColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,FUZZ_ROUGHNESS,_VARYINGNAME_,FuzzRoughness,_MATRIXNAME_,fuzzRoughness,_INFONAME_,FuzzRoughnessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_MATRIXNAME_,geometryNormal,_INFONAME_,GeometryNormalInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_MATRIXNAME_,geometryCoatNormal,_INFONAME_,GeometryCoatNormalInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_MATRIXNAME_,geometryOpacity,_INFONAME_,GeometryOpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_MATRIXNAME_,geometryTangent,_INFONAME_,GeometryTangentInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_MATRIXNAME_,emissionColor,_INFONAME_,EmissionColorInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_MATRIXNAME_,thinFilmWeight,_INFONAME_,ThinFilmWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_MATRIXNAME_,thinFilmThickness,_INFONAME_,ThinFilmThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_MATRIXNAME_,ambientOcclusion,_INFONAME_,AmbientOcclusionInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<openpbrNormalMapVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";bt$1.ShadersStore[r$l]||(bt$1.ShadersStore[r$l]=t$9);const a$c={name:r$l,shader:t$9};var openpbr_vertexCynSCk0h_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,openpbrVertexShader:a$c});const n$6="openpbrFragmentDeclaration";bt$1.IncludesShadersStore[n$6]||(bt$1.IncludesShadersStore[n$6]="uniform vec4 vEyePosition;uniform float vBaseWeight;uniform vec4 vBaseColor;uniform float vBaseDiffuseRoughness;uniform vec4 vReflectanceInfo;uniform vec4 vSpecularColor;uniform vec3 vSpecularAnisotropy;uniform float vCoatWeight;uniform vec3 vCoatColor;uniform float vCoatRoughness;uniform float vCoatRoughnessAnisotropy;uniform float vCoatIor;uniform float vCoatDarkening;uniform float vFuzzWeight;uniform vec3 vFuzzColor;uniform float vFuzzRoughness;uniform vec2 vGeometryCoatTangent;uniform vec3 vEmissionColor;uniform float vThinFilmWeight;uniform vec2 vThinFilmThickness;uniform float vThinFilmIor;uniform vec4 vLightingIntensity;uniform float visibility;\n#ifdef BASE_COLOR\nuniform vec2 vBaseColorInfos;\n#endif\n#ifdef BASE_WEIGHT\nuniform vec2 vBaseWeightInfos;\n#endif\n#ifdef BASE_METALNESS\nuniform vec2 vBaseMetalnessInfos;\n#endif\n#ifdef BASE_DIFFUSE_ROUGHNESS\nuniform vec2 vBaseDiffuseRoughnessInfos;\n#endif\n#ifdef SPECULAR_WEIGHT\nuniform vec2 vSpecularWeightInfos;\n#endif\n#ifdef SPECULAR_COLOR\nuniform vec2 vSpecularColorInfos;\n#endif\n#ifdef SPECULAR_ROUGHNESS\nuniform vec2 vSpecularRoughnessInfos;\n#endif\n#ifdef SPECULAR_ROUGHNESS_ANISOTROPY\nuniform vec2 vSpecularRoughnessAnisotropyInfos;\n#endif\n#ifdef SPECULAR_IOR\nuniform vec2 vSpecularIorInfos;\n#endif\n#ifdef AMBIENT_OCCLUSION\nuniform vec2 vAmbientOcclusionInfos;\n#endif\n#ifdef GEOMETRY_NORMAL\nuniform vec2 vGeometryNormalInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef GEOMETRY_TANGENT\nuniform vec2 vGeometryTangentInfos;\n#endif\n#ifdef GEOMETRY_COAT_NORMAL\nuniform vec2 vGeometryCoatNormalInfos;\n#endif\n#ifdef GEOMETRY_OPACITY\nuniform vec2 vGeometryOpacityInfos;\n#endif\n#ifdef EMISSION_COLOR\nuniform vec2 vEmissionColorInfos;\n#endif\n#ifdef COAT_WEIGHT\nuniform vec2 vCoatWeightInfos;\n#endif\n#ifdef COAT_COLOR\nuniform vec2 vCoatColorInfos;\n#endif\n#ifdef COAT_ROUGHNESS\nuniform vec2 vCoatRoughnessInfos;\n#endif\n#ifdef COAT_ROUGHNESS_ANISOTROPY\nuniform vec2 vCoatRoughnessAnisotropyInfos;\n#endif\n#ifdef COAT_IOR\nuniform vec2 vCoatIorInfos;\n#endif\n#ifdef COAT_DARKENING\nuniform vec2 vCoatDarkeningInfos;\n#endif\n#ifdef FUZZ_WEIGHT\nuniform vec2 vFuzzWeightInfos;\n#endif\n#ifdef FUZZ_COLOR\nuniform vec2 vFuzzColorInfos;\n#endif\n#ifdef FUZZ_ROUGHNESS\nuniform vec2 vFuzzRoughnessInfos;\n#endif\n#ifdef GEOMETRY_COAT_TANGENT\nuniform vec2 vGeometryCoatTangentInfos;\n#endif\n#ifdef THIN_FILM_WEIGHT\nuniform vec2 vThinFilmWeightInfos;\n#endif\n#ifdef THIN_FILM_THICKNESS\nuniform vec2 vThinFilmThicknessInfos;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USEIRRADIANCEMAP) && defined(USE_IRRADIANCE_DOMINANT_DIRECTION)\nuniform vec3 vReflectionDominantDirection;\n#endif\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;\n#endif\n#endif\n#ifdef PREPASS\n#ifdef SS_SCATTERING\nuniform float scatteringDiffusionProfile;\n#endif\n#endif\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n");const o$b="openpbrFragmentSamplersDeclaration";bt$1.IncludesShadersStore[o$b]||(bt$1.IncludesShadersStore[o$b]="#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_SAMPLERNAME_,baseColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_SAMPLERNAME_,baseMetalness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_SAMPLERNAME_,specularWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_SAMPLERNAME_,specularColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_SAMPLERNAME_,specularRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_SAMPLERNAME_,specularRoughnessAnisotropy)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_SAMPLERNAME_,coatWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor,_SAMPLERNAME_,coatColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_SAMPLERNAME_,coatRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_SAMPLERNAME_,coatRoughnessAnisotropy)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_SAMPLERNAME_,coatDarkening)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_WEIGHT,_VARYINGNAME_,FuzzWeight,_SAMPLERNAME_,fuzzWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_COLOR,_VARYINGNAME_,FuzzColor,_SAMPLERNAME_,fuzzColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_ROUGHNESS,_VARYINGNAME_,FuzzRoughness,_SAMPLERNAME_,fuzzRoughness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_SAMPLERNAME_,geometryOpacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_SAMPLERNAME_,geometryTangent)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_TANGENT,_VARYINGNAME_,GeometryCoatTangent,_SAMPLERNAME_,geometryCoatTangent)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_SAMPLERNAME_,emissionColor)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_SAMPLERNAME_,thinFilmWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_SAMPLERNAME_,thinFilmThickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_SAMPLERNAME_,ambientOcclusion)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n#ifdef FUZZENVIRONMENTBRDF\nuniform sampler2D environmentFuzzBrdfSampler;\n#endif\n#if defined(ANISOTROPIC) || defined(FUZZ)\nuniform sampler2D blueNoiseSampler;\n#endif\n#ifdef IBL_CDF_FILTERING\nuniform sampler2D icdfSampler;\n#endif\n");const i$4="openpbrNormalMapFragmentMainFunctions";bt$1.IncludesShadersStore[i$4]||(bt$1.IncludesShadersStore[i$4]="#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || defined(ANISOTROPIC) || defined(FUZZ) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#if defined(WEBGL2) || defined(WEBGPU)\nmat4 toNormalMatrix(mat4 wMatrix)\n{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}\n#else\nmat4 toNormalMatrix(mat4 m)\n{float\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}\n#endif\n");const a$b="openpbrNormalMapFragmentFunctions";bt$1.IncludesShadersStore[a$b]||(bt$1.IncludesShadersStore[a$b]="#if defined(GEOMETRY_NORMAL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_SAMPLERNAME_,geometryNormal)\n#endif\n#if defined(GEOMETRY_COAT_NORMAL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_SAMPLERNAME_,geometryCoatNormal)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(GEOMETRY_NORMAL) && defined(PARALLAX)\nconst float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)\n{currSampledHeight=texture2D(geometryNormalSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{float height=texture2D(geometryNormalSampler,vGeometryNormalUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n");const t$8="openpbrDielectricReflectance";bt$1.IncludesShadersStore[t$8]||(bt$1.IncludesShadersStore[t$8]="struct ReflectanceParams\n{float F0;float F90;vec3 coloredF0;vec3 coloredF90;};\n#define pbr_inline\nReflectanceParams dielectricReflectance(\nin float insideIOR,in float outsideIOR,in vec3 specularColor,in float specularWeight\n)\n{ReflectanceParams outParams;float dielectricF0=pow((insideIOR-outsideIOR)/(insideIOR+outsideIOR),2.0);float dielectricF0_NoSpec=pow((1.0-outsideIOR)/(1.0+outsideIOR),2.0);float f90Scale=clamp(2.0*abs(insideIOR-outsideIOR),0.0,1.0);float f90Scale_NoSpec=clamp(2.0*abs(1.0-outsideIOR),0.0,1.0);\n#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)\nvec3 dielectricColorF90=specularColor.rgb*vec3(f90Scale);vec3 dielectricColorF90_NoSpec=specularColor.rgb*vec3(f90Scale_NoSpec);\n#else\nvec3 dielectricColorF90=vec3(f90Scale);vec3 dielectricColorF90_NoSpec=vec3(f90Scale_NoSpec);\n#endif\n#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF\nfloat maxF0=max(specularColor.r,max(specularColor.g,specularColor.b));outParams.F0=mix(dielectricF0_NoSpec,dielectricF0,specularWeight)*maxF0;\n#else\noutParams.F0=mix(dielectricF0_NoSpec,dielectricF0,specularWeight);\n#endif\noutParams.F90=mix(f90Scale_NoSpec,f90Scale,specularWeight);outParams.coloredF0=mix(vec3(dielectricF0_NoSpec),vec3(dielectricF0),specularWeight)*specularColor.rgb;outParams.coloredF90=mix(dielectricColorF90_NoSpec,dielectricColorF90,specularWeight);return outParams;}\n");const r$k="openpbrConductorReflectance";bt$1.IncludesShadersStore[r$k]||(bt$1.IncludesShadersStore[r$k]="#define pbr_inline\nReflectanceParams conductorReflectance(in vec3 baseColor,in vec3 specularColor,in float specularWeight)\n{ReflectanceParams outParams;\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\noutParams.coloredF0=baseColor*specularWeight;outParams.coloredF90=specularColor*specularWeight;\n#else\noutParams.coloredF0=baseColor;outParams.coloredF90=vec3(1.0);\n#endif\noutParams.F0=1.0;outParams.F90=1.0;return outParams;}");const l="openpbrBlockAmbientOcclusion";bt$1.IncludesShadersStore[l]||(bt$1.IncludesShadersStore[l]="struct ambientOcclusionOutParams\n{vec3 ambientOcclusionColor;\n#if DEBUGMODE>0 && defined(AMBIENT_OCCLUSION)\nvec3 ambientOcclusionColorMap;\n#endif\n};\n#define pbr_inline\nambientOcclusionOutParams ambientOcclusionBlock(\n#ifdef AMBIENT_OCCLUSION\nin vec3 ambientOcclusionColorMap_,\nin vec2 ambientInfos\n#endif\n)\n{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT_OCCLUSION\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*ambientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}\n");const f="openpbrGeometryInfo";bt$1.IncludesShadersStore[f]||(bt$1.IncludesShadersStore[f]="struct geometryInfoOutParams\n{float NdotV;float NdotVUnclamped;vec3 environmentBrdf;float horizonOcclusion;};struct geometryInfoAnisoOutParams\n{float NdotV;float NdotVUnclamped;vec3 environmentBrdf;float horizonOcclusion;float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;mat3 TBN;};\n#define pbr_inline\ngeometryInfoOutParams geometryInfo(\nin vec3 normalW,in vec3 viewDirectionW,in float roughness,in vec3 geometricNormalW\n)\n{geometryInfoOutParams outParams;outParams.NdotVUnclamped=dot(normalW,viewDirectionW);outParams.NdotV=absEps(outParams.NdotVUnclamped);\n#if defined(ENVIRONMENTBRDF)\noutParams.environmentBrdf=getBRDFLookup(outParams.NdotV,roughness);\n#else\noutParams.environmentBrdf=vec3(0.0);\n#endif\noutParams.horizonOcclusion=1.0;\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef HORIZONOCCLUSION\n#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL)\n#ifdef REFLECTIONMAP_3D\noutParams.horizonOcclusion=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\nreturn outParams;}\n#define pbr_inline\ngeometryInfoAnisoOutParams geometryInfoAniso(\nin vec3 normalW,in vec3 viewDirectionW,in float roughness,in vec3 geometricNormalW\n,in vec3 vAnisotropy,in mat3 TBN\n)\n{geometryInfoOutParams geoInfo=geometryInfo(normalW,viewDirectionW,roughness,geometricNormalW);geometryInfoAnisoOutParams outParams;outParams.NdotV=geoInfo.NdotV;outParams.NdotVUnclamped=geoInfo.NdotVUnclamped;outParams.environmentBrdf=geoInfo.environmentBrdf;outParams.horizonOcclusion=geoInfo.horizonOcclusion;outParams.anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));outParams.anisotropicTangent=normalize(anisoTBN*anisotropyDirection);outParams.anisotropicBitangent=normalize(cross(anisoTBN[2],outParams.anisotropicTangent));outParams.TBN=TBN;return outParams;}");const c="openpbrIblFunctions";bt$1.IncludesShadersStore[c]||(bt$1.IncludesShadersStore[c]="#ifdef REFLECTION\nvec3 sampleIrradiance(\nin vec3 surfaceNormal\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,in vec3 vEnvironmentIrradianceSH\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,in mat4 iblMatrix\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,in samplerCube irradianceSampler\n#else\n,in sampler2D irradianceSampler\n#endif\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\n,in vec3 reflectionDominantDirection\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,in sampler2D icdfSampler\n#endif\n#endif\n,in vec2 vReflectionInfos\n,in vec3 viewDirectionW\n,in float diffuseRoughness\n,in vec3 surfaceAlbedo\n) {vec3 environmentIrradiance=vec3(0.,0.,0.);\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\nvec3 irradianceVector=(iblMatrix*vec4(surfaceNormal,0)).xyz;vec3 irradianceView=(iblMatrix*vec4(viewDirectionW,0)).xyz;\n#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)\n#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY\n{float NdotV=max(dot(surfaceNormal,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);}\n#endif\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradianceSH;\n#else\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec4 environmentIrradianceFromTexture=sampleReflection(irradianceSampler,irradianceVector);\n#else\nvec4 environmentIrradianceFromTexture=sampleReflection(irradianceSampler,reflectionCoords);\n#endif\nenvironmentIrradiance=environmentIrradianceFromTexture.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradianceFromTexture);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\nvec3 Ls=normalize(reflectionDominantDirection);float NoL=dot(irradianceVector,Ls);float NoV=dot(irradianceVector,irradianceView);vec3 diffuseRoughnessTerm=vec3(1.0);\n#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON\nfloat LoV=dot (Ls,irradianceView);float mag=length(reflectionDominantDirection)*2.0;vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0)));\n#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY\nvec3 H=(irradianceView+Ls)*0.5;float VoH=dot(irradianceView,H);diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);\n#endif\nenvironmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;\n#endif\n#endif\nenvironmentIrradiance*=vReflectionInfos.x;return environmentIrradiance;}\n#define pbr_inline\n#ifdef REFLECTIONMAP_3D\nvec3 createReflectionCoords(\n#else\nvec2 createReflectionCoords(\n#endif\nin vec3 vPositionW\n,in vec3 normalW\n)\n{vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\nreturn reflectionCoords;}\n#define pbr_inline\n#define inline\nvec3 sampleRadiance(\nin float alphaG\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in geometryInfoOutParams geoInfo\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n,const vec3 reflectionCoords\n#else\n,in sampler2D reflectionSampler\n,const vec2 reflectionCoords\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#endif\n)\n{vec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,geoInfo.NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nenvironmentRadiance.rgb*=vec3(vReflectionInfos.x);return environmentRadiance.rgb;}\n#if defined(ANISOTROPIC)\n#define pbr_inline\n#define inline\nvec3 sampleRadianceAnisotropic(\nin float alphaG\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in geometryInfoAnisoOutParams geoInfo\n,const vec3 normalW\n,const vec3 viewDirectionW\n,const vec3 positionW\n,const vec3 noise\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n#else\n,in sampler2D reflectionSampler\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#endif\n)\n{vec4 environmentRadiance=vec4(0.,0.,0.,0.);float alphaT=alphaG*sqrt(2.0/(1.0+(1.0-geoInfo.anisotropy)*(1.0-geoInfo.anisotropy)));float alphaB=(1.0-geoInfo.anisotropy)*alphaT;alphaG=alphaB;\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,geoInfo.NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef REALTIME_FILTERING\nvec3 view=(reflectionMatrix*vec4(viewDirectionW,0.0)).xyz;vec3 tangent=(reflectionMatrix*vec4(geoInfo.anisotropicTangent,0.0)).xyz;vec3 bitangent=(reflectionMatrix*vec4(geoInfo.anisotropicBitangent,0.0)).xyz;vec3 normal=(reflectionMatrix*vec4(normalW,0.0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nview.z*=-1.0;tangent.z*=-1.0;bitangent.z*=-1.0;normal.z*=-1.0;\n#endif\nenvironmentRadiance =\nvec4(radianceAnisotropic(alphaT,alphaB,reflectionSampler,\nview,tangent,\nbitangent,normal,\nvReflectionFilteringInfo,noise.xy),\n1.0);\n#else\nconst int samples=16;vec4 radianceSample=vec4(0.0);vec3 reflectionCoords=vec3(0.0);float sample_weight=0.0;float total_weight=0.0;float step=1.0/float(max(samples-1,1));for (int i=0; i<samples; ++i) {float t=mix(-1.0,1.0,float(i)*step);t+=step*2.0*noise.x;sample_weight=max(1.0-abs(t),0.001);sample_weight*=sample_weight;t*=min(4.0*alphaT*geoInfo.anisotropy,1.0);vec3 bentNormal;if (t<0.0) {float blend=t+1.0;bentNormal=normalize(mix(-geoInfo.anisotropicTangent,normalW,blend));} else if (t>0.0) {float blend=t;bentNormal=normalize(mix(normalW,geoInfo.anisotropicTangent,blend));} else {bentNormal=normalW;}\nreflectionCoords=createReflectionCoords(positionW,bentNormal);radianceSample=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb+=sample_weight*fromRGBD(radianceSample);\n#elif defined(GAMMAREFLECTION)\nenvironmentRadiance.rgb+=sample_weight*toLinearSpace(radianceSample.rgb);\n#else\nenvironmentRadiance.rgb+=sample_weight*radianceSample.rgb;\n#endif\ntotal_weight+=sample_weight;}\nenvironmentRadiance=vec4(environmentRadiance.xyz/float(total_weight),1.0);\n#endif\nenvironmentRadiance.rgb*=vec3(vReflectionInfos.x);return environmentRadiance.rgb;}\n#endif\n#define pbr_inline\nvec3 conductorIblFresnel(in ReflectanceParams reflectance,in float NdotV,in float roughness,in vec3 environmentBrdf)\n{\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\nvec3 albedoF0=mix(reflectance.coloredF0,pow(reflectance.coloredF0,vec3(1.4)),roughness);return getF82Specular(NdotV,albedoF0,reflectance.coloredF90,roughness);\n#else\nreturn getReflectanceFromBRDFLookup(reflectance.coloredF0,reflectance.coloredF90,environmentBrdf);\n#endif\n}\n#endif\n");const s$1="openpbrNormalMapFragment";bt$1.IncludesShadersStore[s$1]||(bt$1.IncludesShadersStore[s$1]="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(GEOMETRY_NORMAL)\nfloat normalScale=vGeometryNormalInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(GEOMETRY_NORMAL)\nvec2 TBNUV=gl_FrontFacing ? vGeometryNormalUV : -vGeometryNormalUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC) || defined(FUZZ)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\n#else\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef GEOMETRY_COAT_NORMAL\ncoatNormalW=perturbNormal(TBN,texture2D(geometryCoatNormalSampler,vGeometryCoatNormalUV+uvOffset).xyz,vGeometryCoatNormalInfos.y);\n#endif\n#ifdef GEOMETRY_NORMAL\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(texture2D(geometryNormalSampler,vGeometryNormalUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(geometryNormalSampler,vGeometryNormalUV+uvOffset).xyz,vGeometryNormalInfos.y);\n#else\nvec3 sampledNormal=texture2D(geometryNormalSampler,vGeometryNormalUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(sampledNormal.xy+detailNormal.xy,sampledNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;sampledNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=sampledNormal*dot(sampledNormal,detailNormal)/sampledNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vGeometryNormalInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n");const d="openpbrBlockNormalFinal";bt$1.IncludesShadersStore[d]||(bt$1.IncludesShadersStore[d]="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));coatNormalW*=sign(dot(coatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\n#if defined(MIRRORED)\nnormalW=gl_FrontFacing ? -normalW : normalW;coatNormalW=gl_FrontFacing ? -coatNormalW : coatNormalW;\n#else\nnormalW=gl_FrontFacing ? normalW : -normalW;coatNormalW=gl_FrontFacing ? coatNormalW : -coatNormalW;\n#endif\n#endif\n");const m="openpbrBaseLayerData";bt$1.IncludesShadersStore[m]||(bt$1.IncludesShadersStore[m]="vec3 base_color=vec3(0.8);float base_metalness=0.0;float base_diffuse_roughness=0.0;float specular_weight=1.0;float specular_roughness=0.3;vec3 specular_color=vec3(1.0);float specular_roughness_anisotropy=0.0;float specular_ior=1.5;float alpha=1.0;vec2 geometry_tangent=vec2(1.0,0.0);\n#ifdef BASE_WEIGHT\nvec4 baseWeightFromTexture=texture2D(baseWeightSampler,vBaseWeightUV+uvOffset);\n#endif\n#ifdef BASE_COLOR\nvec4 baseColorFromTexture=texture2D(baseColorSampler,vBaseColorUV+uvOffset);\n#endif\n#ifdef BASE_METALNESS\nvec4 metallicFromTexture=texture2D(baseMetalnessSampler,vBaseMetalnessUV+uvOffset);\n#endif\n#if defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS)\nfloat roughnessFromTexture=metallicFromTexture.g;\n#elif defined(SPECULAR_ROUGHNESS)\nfloat roughnessFromTexture=texture2D(specularRoughnessSampler,vSpecularRoughnessUV+uvOffset).r;\n#endif\n#ifdef GEOMETRY_TANGENT\nvec3 geometryTangentFromTexture=texture2D(geometryTangentSampler,vGeometryTangentUV+uvOffset).rgb;\n#endif\n#ifdef SPECULAR_ROUGHNESS_ANISOTROPY\nfloat anisotropyFromTexture=texture2D(specularRoughnessAnisotropySampler,vSpecularRoughnessAnisotropyUV+uvOffset).r*vSpecularRoughnessAnisotropyInfos.y;\n#endif\n#ifdef BASE_DIFFUSE_ROUGHNESS\nfloat baseDiffuseRoughnessFromTexture=texture2D(baseDiffuseRoughnessSampler,vBaseDiffuseRoughnessUV+uvOffset).r;\n#endif\n#ifdef GEOMETRY_OPACITY\nvec4 opacityFromTexture=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvec4 decalFromTexture=texture2D(decalSampler,vDecalUV+uvOffset);\n#endif\n#ifdef SPECULAR_COLOR\nvec4 specularColorFromTexture=texture2D(specularColorSampler,vSpecularColorUV+uvOffset);\n#endif\n#ifdef SPECULAR_WEIGHT\n#ifdef SPECULAR_WEIGHT_IN_ALPHA\nfloat specularWeightFromTexture=texture2D(specularWeightSampler,vSpecularWeightUV+uvOffset).a;\n#else\nfloat specularWeightFromTexture=texture2D(specularWeightSampler,vSpecularWeightUV+uvOffset).r;\n#endif\n#endif\n#if defined(ANISOTROPIC) || defined(FUZZ)\nvec3 noise=texture2D(blueNoiseSampler,gl_FragCoord.xy/256.0).xyz;\n#endif\nbase_color=vBaseColor.rgb;\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbase_color*=vColor.rgb;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\nbase_color*=vec3(vBaseWeight);alpha=vBaseColor.a;base_metalness=vReflectanceInfo.x;base_diffuse_roughness=vBaseDiffuseRoughness;specular_roughness=vReflectanceInfo.y;specular_color=vSpecularColor.rgb;specular_weight=vReflectanceInfo.a;specular_ior=vReflectanceInfo.z;specular_roughness_anisotropy=vSpecularAnisotropy.b;geometry_tangent=vSpecularAnisotropy.rg;\n#ifdef BASE_COLOR\n#ifdef BASE_COLOR_GAMMA\nbase_color*=toLinearSpace(baseColorFromTexture.rgb);\n#else\nbase_color*=baseColorFromTexture.rgb;\n#endif\nbase_color*=vBaseColorInfos.y;\n#endif\n#ifdef BASE_WEIGHT\nbase_color*=baseWeightFromTexture.r;\n#endif\n#if defined(BASE_COLOR) && defined(ALPHA_FROM_BASE_COLOR_TEXTURE)\nalpha*=baseColorFromTexture.a;\n#elif defined(GEOMETRY_OPACITY)\nalpha*=opacityFromTexture.r;alpha*=vGeometryOpacityInfos.y;\n#endif\n#ifdef ALPHATEST\n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#ifdef BASE_METALNESS\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nbase_metalness*=metallicFromTexture.b;\n#else\nbase_metalness*=metallicFromTexture.r;\n#endif\n#endif\n#ifdef BASE_DIFFUSE_ROUGHNESS\nbase_diffuse_roughness*=baseDiffuseRoughnessFromTexture*vBaseDiffuseRoughnessInfos.y;\n#endif\n#ifdef SPECULAR_COLOR\n#ifdef SPECULAR_COLOR_GAMMA\nspecular_color*=toLinearSpace(specularColorFromTexture.rgb);\n#else\nspecular_color*=specularColorFromTexture.rgb;\n#endif\n#endif\n#ifdef SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE\nspecular_weight*=specularColorFromTexture.a;\n#elif defined(SPECULAR_WEIGHT)\nspecular_weight*=specularWeightFromTexture;\n#endif\n#if defined(SPECULAR_ROUGHNESS) || (defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS))\nspecular_roughness*=roughnessFromTexture;\n#endif\n#ifdef GEOMETRY_TANGENT\n{vec2 tangentFromTexture=normalize(geometryTangentFromTexture.xy*2.0-1.0);float tangent_angle_texture=atan(tangentFromTexture.y,tangentFromTexture.x);float tangent_angle_uniform=atan(geometry_tangent.y,geometry_tangent.x);float tangent_angle=tangent_angle_texture+tangent_angle_uniform;geometry_tangent=vec2(cos(tangent_angle),sin(tangent_angle));}\n#endif\n#if defined(GEOMETRY_TANGENT) && defined(SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)\nspecular_roughness_anisotropy*=geometryTangentFromTexture.b;\n#elif defined(SPECULAR_ROUGHNESS_ANISOTROPY)\nspecular_roughness_anisotropy*=anisotropyFromTexture;\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,specular_roughness,detailRoughness*2.);float hiLerp=mix(specular_roughness,1.,(detailRoughness-0.5)*2.);specular_roughness=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef USE_GLTF_STYLE_ANISOTROPY\nfloat baseAlpha=specular_roughness*specular_roughness;float roughnessT=mix(baseAlpha,1.0,specular_roughness_anisotropy*specular_roughness_anisotropy);float roughnessB=baseAlpha;specular_roughness_anisotropy=1.0-roughnessB/max(roughnessT,0.00001);specular_roughness=sqrt(roughnessT/sqrt(2.0/(1.0+(1.0-specular_roughness_anisotropy)*(1.0-specular_roughness_anisotropy))));\n#endif\n");const u$1="openpbrCoatLayerData";bt$1.IncludesShadersStore[u$1]||(bt$1.IncludesShadersStore[u$1]="float coat_weight=0.0;vec3 coat_color=vec3(1.0);float coat_roughness=0.0;float coat_roughness_anisotropy=0.0;float coat_ior=1.6;float coat_darkening=1.0;vec2 geometry_coat_tangent=vec2(1.0,0.0);\n#ifdef COAT_WEIGHT\nvec4 coatWeightFromTexture=texture2D(coatWeightSampler,vCoatWeightUV+uvOffset);\n#endif\n#ifdef COAT_COLOR\nvec4 coatColorFromTexture=texture2D(coatColorSampler,vCoatColorUV+uvOffset);\n#endif\n#ifdef COAT_ROUGHNESS\nvec4 coatRoughnessFromTexture=texture2D(coatRoughnessSampler,vCoatRoughnessUV+uvOffset);\n#endif\n#ifdef COAT_ROUGHNESS_ANISOTROPY\nfloat coatRoughnessAnisotropyFromTexture=texture2D(coatRoughnessAnisotropySampler,vCoatRoughnessAnisotropyUV+uvOffset).r;\n#endif\n#ifdef COAT_DARKENING\nvec4 coatDarkeningFromTexture=texture2D(coatDarkeningSampler,vCoatDarkeningUV+uvOffset);\n#endif\n#ifdef GEOMETRY_COAT_TANGENT\nvec3 geometryCoatTangentFromTexture=texture2D(geometryCoatTangentSampler,vGeometryCoatTangentUV+uvOffset).rgb;\n#endif\ncoat_color=vCoatColor.rgb;coat_weight=vCoatWeight;coat_roughness=vCoatRoughness;coat_roughness_anisotropy=vCoatRoughnessAnisotropy;coat_ior=vCoatIor;coat_darkening=vCoatDarkening;geometry_coat_tangent=vGeometryCoatTangent.rg;\n#ifdef COAT_WEIGHT\ncoat_weight*=coatWeightFromTexture.r;\n#endif\n#ifdef COAT_COLOR\n#ifdef COAT_COLOR_GAMMA\ncoat_color*=toLinearSpace(coatColorFromTexture.rgb);\n#else\ncoat_color*=coatColorFromTexture.rgb;\n#endif\ncoat_color*=vCoatColorInfos.y;\n#endif\n#ifdef COAT_ROUGHNESS\ncoat_roughness*=coatRoughnessFromTexture.r;\n#endif\n#if defined(GEOMETRY_COAT_TANGENT) && defined(COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)\ncoat_roughness_anisotropy*=geometryCoatTangentFromTexture.b;\n#elif defined(COAT_ROUGHNESS_ANISOTROPY)\ncoat_roughness_anisotropy*=coatRoughnessAnisotropyFromTexture;\n#endif\n#ifdef COAT_DARKENING\ncoat_darkening*=coatDarkeningFromTexture.r;\n#endif\n#ifdef GEOMETRY_COAT_TANGENT\n{vec2 tangentFromTexture=normalize(geometryCoatTangentFromTexture.xy*2.0-1.0);float tangent_angle_texture=atan(tangentFromTexture.y,tangentFromTexture.x);float tangent_angle_uniform=atan(geometry_coat_tangent.y,geometry_coat_tangent.x);float tangent_angle=tangent_angle_texture+tangent_angle_uniform;geometry_coat_tangent=vec2(cos(tangent_angle),sin(tangent_angle));}\n#endif\n#ifdef USE_GLTF_STYLE_ANISOTROPY\nfloat coatAlpha=coat_roughness*coat_roughness;float coatRoughnessT=mix(coatAlpha,1.0,coat_roughness_anisotropy*coat_roughness_anisotropy);float coatRoughnessB=coatAlpha;coat_roughness_anisotropy=1.0-coatRoughnessB/max(coatRoughnessT,0.00001);coat_roughness=sqrt(coatRoughnessT/sqrt(2.0/(1.0+(1.0-coat_roughness_anisotropy)*(1.0-coat_roughness_anisotropy))));\n#endif\n");const _="openpbrThinFilmLayerData";bt$1.IncludesShadersStore[_]||(bt$1.IncludesShadersStore[_]="#ifdef THIN_FILM\nfloat thin_film_weight=vThinFilmWeight;float thin_film_thickness=vThinFilmThickness.r*1000.0; \nfloat thin_film_ior=vThinFilmIor;\n#ifdef THIN_FILM_WEIGHT\nfloat thinFilmWeightFromTexture=texture2D(thinFilmWeightSampler,vThinFilmWeightUV+uvOffset).r*vThinFilmWeightInfos.y;\n#endif\n#ifdef THIN_FILM_THICKNESS\nfloat thinFilmThicknessFromTexture=texture2D(thinFilmThicknessSampler,vThinFilmThicknessUV+uvOffset).g*vThinFilmThicknessInfos.y;\n#endif\n#ifdef THIN_FILM_WEIGHT\nthin_film_weight*=thinFilmWeightFromTexture;\n#endif\n#ifdef THIN_FILM_THICKNESS\nthin_film_thickness*=thinFilmThicknessFromTexture;\n#endif\n#endif\n");const g="openpbrFuzzLayerData";bt$1.IncludesShadersStore[g]||(bt$1.IncludesShadersStore[g]="float fuzz_weight=0.0;vec3 fuzz_color=vec3(1.0);float fuzz_roughness=0.0;\n#ifdef FUZZ\n#ifdef FUZZ_WEIGHT\nvec4 fuzzWeightFromTexture=texture2D(fuzzWeightSampler,vFuzzWeightUV+uvOffset);\n#endif\n#ifdef FUZZ_COLOR\nvec4 fuzzColorFromTexture=texture2D(fuzzColorSampler,vFuzzColorUV+uvOffset);\n#endif\n#ifdef FUZZ_ROUGHNESS\nvec4 fuzzRoughnessFromTexture=texture2D(fuzzRoughnessSampler,vFuzzRoughnessUV+uvOffset);\n#endif\nfuzz_color=vFuzzColor.rgb;fuzz_weight=vFuzzWeight;fuzz_roughness=vFuzzRoughness;\n#ifdef FUZZ_WEIGHT\nfuzz_weight*=fuzzWeightFromTexture.r;\n#endif\n#ifdef FUZZ_COLOR\n#ifdef FUZZ_COLOR_GAMMA\nfuzz_color*=toLinearSpace(fuzzColorFromTexture.rgb);\n#else\nfuzz_color*=fuzzColorFromTexture.rgb;\n#endif\nfuzz_color*=vFuzzColorInfos.y;\n#endif\n#if defined(FUZZ_ROUGHNESS) && defined(FUZZ_ROUGHNESS_FROM_COLOR_TEXTURE_ALPHA)\nfuzz_roughness*=fuzzRoughnessFromTexture.a;\n#elif defined(FUZZ_ROUGHNESS)\nfuzz_roughness*=fuzzRoughnessFromTexture.r;\n#endif\n#endif\n");const p="openpbrEnvironmentLighting";bt$1.IncludesShadersStore[p]||(bt$1.IncludesShadersStore[p]="#ifdef REFLECTION\n#ifdef FUZZ\nvec3 environmentFuzzBrdf=getFuzzBRDFLookup(fuzzGeoInfo.NdotV,sqrt(fuzz_roughness));\n#endif\nvec3 baseDiffuseEnvironmentLight=sampleIrradiance(\nnormalW\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,vEnvironmentIrradiance\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,reflectionMatrix\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION\n,vReflectionDominantDirection\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n#endif\n,vReflectionInfos\n,viewDirectionW\n,base_diffuse_roughness\n,base_color\n);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.,0.,0.);\n#else\nvec2 reflectionCoords=vec2(0.,0.);\n#endif\nfloat specularAlphaG=specular_roughness*specular_roughness;\n#ifdef ANISOTROPIC_BASE\nvec3 baseSpecularEnvironmentLight=sampleRadianceAnisotropic(specularAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos\n,baseGeoInfo\n,normalW\n,viewDirectionW\n,vPositionW\n,noise\n,reflectionSampler\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n);\n#else\nreflectionCoords=createReflectionCoords(vPositionW,normalW);vec3 baseSpecularEnvironmentLight=sampleRadiance(specularAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos\n,baseGeoInfo\n,reflectionSampler\n,reflectionCoords\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n);\n#endif\n#ifdef ANISOTROPIC_BASE\nbaseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG*specularAlphaG*max(1.0-baseGeoInfo.anisotropy,0.3));\n#else\nbaseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG);\n#endif\nvec3 coatEnvironmentLight=vec3(0.,0.,0.);if (coat_weight>0.0) {\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.,0.,0.);\n#else\nvec2 reflectionCoords=vec2(0.,0.);\n#endif\nreflectionCoords=createReflectionCoords(vPositionW,coatNormalW);float coatAlphaG=coat_roughness*coat_roughness;\n#ifdef ANISOTROPIC_COAT\ncoatEnvironmentLight=sampleRadianceAnisotropic(coatAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos\n,coatGeoInfo\n,coatNormalW\n,viewDirectionW\n,vPositionW\n,noise\n,reflectionSampler\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n);\n#else\ncoatEnvironmentLight=sampleRadiance(coatAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos\n,coatGeoInfo\n,reflectionSampler\n,reflectionCoords\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n);\n#endif\n}\n#ifdef FUZZ\nfloat modifiedFuzzRoughness=clamp(fuzz_roughness*(1.0-0.5*environmentFuzzBrdf.y),0.0,1.0);vec3 fuzzEnvironmentLight=vec3(0.0);float totalWeight=0.0;float fuzzIblFresnel=sqrt(environmentFuzzBrdf.z);for (int i=0; i<FUZZ_IBL_SAMPLES; ++i) {float angle=(float(i)+noise.x)*(3.141592*2.0/float(FUZZ_IBL_SAMPLES));vec3 fiberCylinderNormal=normalize(cos(angle)*fuzzTangent+sin(angle)*fuzzBitangent);float fiberBend=min(environmentFuzzBrdf.x*environmentFuzzBrdf.x*modifiedFuzzRoughness,1.0);fiberCylinderNormal=normalize(mix(fiberCylinderNormal,fuzzNormalW,fiberBend));float sampleWeight=max(dot(viewDirectionW,fiberCylinderNormal),0.0);vec3 fuzzReflectionCoords=createReflectionCoords(vPositionW,fiberCylinderNormal);vec3 radianceSample=sampleRadiance(modifiedFuzzRoughness,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos\n,fuzzGeoInfo\n,reflectionSampler\n,fuzzReflectionCoords\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n);fuzzEnvironmentLight+=sampleWeight*mix(radianceSample,baseDiffuseEnvironmentLight,fiberBend);totalWeight+=sampleWeight;}\nfuzzEnvironmentLight/=totalWeight;\n#endif\nfloat dielectricIblFresnel=getReflectanceFromBRDFLookup(vec3(baseDielectricReflectance.F0),vec3(baseDielectricReflectance.F90),baseGeoInfo.environmentBrdf).r;vec3 dielectricIblColoredFresnel=dielectricIblFresnel*specular_color;\n#ifdef THIN_FILM\nfloat thinFilmIorScale=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);vec3 thinFilmDielectricFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseDielectricReflectance.coloredF0);dielectricIblColoredFresnel=mix(dielectricIblColoredFresnel,thinFilmDielectricFresnel*specular_color,thin_film_weight*thinFilmIorScale);\n#endif\nvec3 conductorIblFresnel=conductorIblFresnel(baseConductorReflectance,baseGeoInfo.NdotV,specular_roughness,baseGeoInfo.environmentBrdf);\n#ifdef THIN_FILM\nvec3 thinFilmConductorFresnel=specular_weight*evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseConductorReflectance.coloredF0);conductorIblFresnel=mix(conductorIblFresnel,thinFilmConductorFresnel,thin_film_weight*thinFilmIorScale);\n#endif\nfloat coatIblFresnel=0.0;if (coat_weight>0.0) {coatIblFresnel=getReflectanceFromBRDFLookup(vec3(coatReflectance.F0),vec3(coatReflectance.F90),coatGeoInfo.environmentBrdf).r;}\nvec3 slab_diffuse_ibl=vec3(0.,0.,0.);vec3 slab_glossy_ibl=vec3(0.,0.,0.);vec3 slab_metal_ibl=vec3(0.,0.,0.);vec3 slab_coat_ibl=vec3(0.,0.,0.);slab_diffuse_ibl=baseDiffuseEnvironmentLight*vLightingIntensity.z;slab_diffuse_ibl*=aoOut.ambientOcclusionColor;slab_glossy_ibl=baseSpecularEnvironmentLight*vLightingIntensity.z;slab_metal_ibl=baseSpecularEnvironmentLight*conductorIblFresnel*vLightingIntensity.z;vec3 coatAbsorption=vec3(1.0);if (coat_weight>0.0) {slab_coat_ibl=coatEnvironmentLight*vLightingIntensity.z;float hemisphere_avg_fresnel=coatReflectance.F0+0.5*(1.0-coatReflectance.F0);float averageReflectance=(coatIblFresnel+hemisphere_avg_fresnel)*0.5;float roughnessFactor=1.0-coat_roughness*0.5;averageReflectance*=roughnessFactor;float darkened_transmission=(1.0-averageReflectance)*(1.0-averageReflectance);darkened_transmission=mix(1.0,darkened_transmission,coat_darkening);float sin2=1.0-coatGeoInfo.NdotV*coatGeoInfo.NdotV;sin2=sin2/(coat_ior*coat_ior);float cos_t=sqrt(1.0-sin2);float coatPathLength=1.0/cos_t;vec3 colored_transmission=pow(coat_color,vec3(coatPathLength));coatAbsorption=mix(vec3(1.0),colored_transmission*darkened_transmission,coat_weight);}\n#ifdef FUZZ\nvec3 slab_fuzz_ibl=fuzzEnvironmentLight*vLightingIntensity.z;\n#endif\nvec3 slab_subsurface_ibl=vec3(0.,0.,0.);vec3 slab_translucent_base_ibl=vec3(0.,0.,0.);slab_diffuse_ibl*=base_color.rgb;\n#define CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION\nvec3 material_opaque_base_ibl=mix(slab_diffuse_ibl,slab_subsurface_ibl,subsurface_weight);vec3 material_dielectric_base_ibl=mix(material_opaque_base_ibl,slab_translucent_base_ibl,transmission_weight);vec3 material_dielectric_gloss_ibl=material_dielectric_base_ibl*(1.0-dielectricIblFresnel)+slab_glossy_ibl*dielectricIblColoredFresnel;vec3 material_base_substrate_ibl=mix(material_dielectric_gloss_ibl,slab_metal_ibl,base_metalness);vec3 material_coated_base_ibl=layer(material_base_substrate_ibl,slab_coat_ibl,coatIblFresnel,coatAbsorption,vec3(1.0));\n#ifdef FUZZ\nmaterial_surface_ibl=layer(material_coated_base_ibl,slab_fuzz_ibl,fuzzIblFresnel*fuzz_weight,vec3(1.0),fuzz_color);\n#else\nmaterial_surface_ibl=material_coated_base_ibl;\n#endif\n#endif\n");const E="openpbrDirectLightingInit";bt$1.IncludesShadersStore[E]||(bt$1.IncludesShadersStore[E]="#ifdef LIGHT{X}\npreLightingInfo preInfo{X};preLightingInfo preInfoCoat{X};vec4 lightColor{X}=light{X}.vLightDiffuse;float shadow{X}=1.;\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\n#define CUSTOM_LIGHT{X}_COLOR \n#ifdef SPOTLIGHT{X}\npreInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);\n#elif defined(POINTLIGHT{X})\npreInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);\n#elif defined(HEMILIGHT{X})\npreInfo{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);\n#elif defined(DIRLIGHT{X})\npreInfo{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);\n#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\npreInfo{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,specular_roughness);preInfoCoat{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,coatNormalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,coat_roughness);\n#endif\npreInfo{X}.NdotV=baseGeoInfo.NdotV;preInfoCoat{X}.NdotV=coatGeoInfo.NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});\n#else\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});\n#else\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w);\n#endif\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});\n#else\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#endif\n#else\npreInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});\n#else\npreInfo{X}.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo{X}.attenuation=1.0;\n#endif\npreInfoCoat{X}.attenuation=preInfo{X}.attenuation;\n#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})\npreInfo{X}.roughness=specular_roughness;preInfoCoat{X}.roughness=coat_roughness;\n#else\npreInfo{X}.roughness=adjustRoughnessFromLightProperties(specular_roughness,light{X}.vLightSpecular.a,preInfo{X}.lightDistance);preInfoCoat{X}.roughness=adjustRoughnessFromLightProperties(coat_roughness,light{X}.vLightSpecular.a,preInfoCoat{X}.lightDistance);\n#endif\npreInfo{X}.diffuseRoughness=base_diffuse_roughness;preInfo{X}.surfaceAlbedo=base_color.rgb;\n#endif\n#endif\n");const I="openpbrDirectLighting";bt$1.IncludesShadersStore[I]||(bt$1.IncludesShadersStore[I]="#ifdef LIGHT{X}\n{vec3 slab_diffuse=vec3(0.,0.,0.);vec3 slab_subsurface=vec3(0.,0.,0.);vec3 slab_translucent=vec3(0.,0.,0.);vec3 slab_glossy=vec3(0.,0.,0.);float specularFresnel=0.0;vec3 specularColoredFresnel=vec3(0.,0.,0.);vec3 slab_metal=vec3(0.,0.,0.);vec3 slab_coat=vec3(0.,0.,0.);float coatFresnel=0.0;vec3 slab_fuzz=vec3(0.,0.,0.);float fuzzFresnel=0.0;\n#ifdef HEMILIGHT{X}\nslab_diffuse=computeHemisphericDiffuseLighting(preInfo{X},lightColor{X}.rgb,light{X}.vLightGround);\n#elif defined(AREALIGHT{X})\nslab_diffuse=computeAreaDiffuseLighting(preInfo{X},lightColor{X}.rgb);\n#else\nslab_diffuse=computeDiffuseLighting(preInfo{X},lightColor{X}.rgb);\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nslab_diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);\n#endif\nnumLights+=1.0;\n#ifdef FUZZ\nfloat fuzzNdotH=max(dot(fuzzNormalW,preInfo{X}.H),0.0);vec3 fuzzBrdf=getFuzzBRDFLookup(fuzzNdotH,sqrt(fuzz_roughness));\n#endif\n#if AREALIGHT{X}\nslab_glossy=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);\n#else\n{\n#ifdef ANISOTROPIC_BASE\nslab_glossy=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,\nbaseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,\n0.0,lightColor{X}.rgb);\n#else\nslab_glossy=computeSpecularLighting(preInfo{X},normalW,vec3(1.0),vec3(1.0),specular_roughness,lightColor{X}.rgb);\n#endif\nfloat NdotH=dot(normalW,preInfo{X}.H);specularFresnel=fresnelSchlickGGX(NdotH,baseDielectricReflectance.F0,baseDielectricReflectance.F90);specularColoredFresnel=specularFresnel*specular_color;\n#ifdef THIN_FILM\nfloat thinFilmIorScale=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);vec3 thinFilmDielectricFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseDielectricReflectance.coloredF0);specularColoredFresnel=mix(specularColoredFresnel,thinFilmDielectricFresnel*specular_color,thin_film_weight*thinFilmIorScale);\n#endif\n}\n#endif\n#if AREALIGHT{X}\nslab_metal=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);\n#else\n{\n#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)\nvec3 coloredFresnel=getF82Specular(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90,specular_roughness);\n#else\nvec3 coloredFresnel=fresnelSchlickGGX(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90);\n#endif\n#ifdef THIN_FILM\nfloat thinFilmIorScale=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);vec3 thinFilmConductorFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseConductorReflectance.coloredF0);coloredFresnel=mix(coloredFresnel,specular_weight*thinFilmIorScale*thinFilmConductorFresnel,thin_film_weight);\n#endif\n#ifdef ANISOTROPIC_BASE\nslab_metal=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,0.0,lightColor{X}.rgb);\n#else\nslab_metal=computeSpecularLighting(preInfo{X},normalW,vec3(1.0),coloredFresnel,specular_roughness,lightColor{X}.rgb);\n#endif\n}\n#endif\n#if AREALIGHT{X}\nslab_coat=computeAreaSpecularLighting(preInfoCoat{X},light{X}.vLightSpecular.rgb,coatReflectance.F0,coatReflectance.F90);\n#else\n{\n#ifdef ANISOTROPIC_COAT\nslab_coat=computeAnisotropicSpecularLighting(preInfoCoat{X},viewDirectionW,coatNormalW,\ncoatGeoInfo.anisotropicTangent,coatGeoInfo.anisotropicBitangent,coatGeoInfo.anisotropy,\n0.0,lightColor{X}.rgb);\n#else\nslab_coat=computeSpecularLighting(preInfoCoat{X},coatNormalW,vec3(coatReflectance.F0),vec3(1.0),coat_roughness,lightColor{X}.rgb);\n#endif\nfloat NdotH=dot(coatNormalW,preInfoCoat{X}.H);coatFresnel=fresnelSchlickGGX(NdotH,coatReflectance.F0,coatReflectance.F90);}\n#endif\nvec3 coatAbsorption=vec3(1.0);if (coat_weight>0.0) {float cosTheta_view=max(preInfoCoat{X}.NdotV,0.001);float cosTheta_light=max(preInfoCoat{X}.NdotL,0.001);float fresnel_view=coatReflectance.F0+(1.0-coatReflectance.F0)*pow(1.0-cosTheta_view,5.0);float fresnel_light=coatReflectance.F0+(1.0-coatReflectance.F0)*pow(1.0-cosTheta_light,5.0);float averageReflectance=(fresnel_view+fresnel_light)*0.5;float darkened_transmission=(1.0-averageReflectance)/(1.0+averageReflectance);darkened_transmission=mix(1.0,darkened_transmission,coat_darkening);float sin2=1.0-cosTheta_view*cosTheta_view;sin2=sin2/(coat_ior*coat_ior);float cos_t=sqrt(1.0-sin2);float coatPathLength=1.0/cos_t;vec3 colored_transmission=pow(coat_color,vec3(coatPathLength));coatAbsorption=mix(vec3(1.0),colored_transmission*darkened_transmission,coat_weight);}\n#ifdef FUZZ\nfuzzFresnel=fuzzBrdf.z;vec3 fuzzNormalW=mix(normalW,coatNormalW,coat_weight);float fuzzNdotV=max(dot(fuzzNormalW,viewDirectionW.xyz),0.0);float fuzzNdotL=max(dot(fuzzNormalW,preInfo{X}.L),0.0);slab_fuzz=lightColor{X}.rgb*preInfo{X}.attenuation*evalFuzz(preInfo{X}.L,fuzzNdotL,fuzzNdotV,fuzzTangent,fuzzBitangent,fuzzBrdf);\n#else\nvec3 fuzz_color=vec3(0.0);\n#endif\nslab_diffuse*=base_color.rgb;vec3 material_opaque_base=mix(slab_diffuse,slab_subsurface,subsurface_weight);vec3 material_dielectric_base=mix(material_opaque_base,slab_translucent,transmission_weight);vec3 material_dielectric_gloss=material_dielectric_base*(1.0-specularFresnel)+slab_glossy*specularColoredFresnel;vec3 material_base_substrate=mix(material_dielectric_gloss,slab_metal,base_metalness);vec3 material_coated_base=layer(material_base_substrate,slab_coat,coatFresnel,coatAbsorption,vec3(1.0));material_surface_direct+=layer(material_coated_base,slab_fuzz,fuzzFresnel*fuzz_weight,vec3(1.0),fuzz_color);}\n#endif\n");const v="openpbrPixelShader",R="#define OPENPBR_FRAGMENT_SHADER\n#define CUSTOM_FRAGMENT_EXTENSION\n#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\nprecision highp float;\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<__decl__openpbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<openpbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<openpbrNormalMapFragmentMainFunctions>\n#include<openpbrNormalMapFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<openpbrDielectricReflectance>\n#include<openpbrConductorReflectance>\n#include<openpbrBlockAmbientOcclusion>\n#include<openpbrGeometryInfo>\n#include<openpbrIblFunctions>\nvec3 layer(vec3 slab_bottom,vec3 slab_top,float lerp_factor,vec3 bottom_multiplier,vec3 top_multiplier) {return mix(slab_bottom*bottom_multiplier,slab_top*top_multiplier,lerp_factor);}\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\nvec3 coatNormalW=normalW;\n#include<openpbrNormalMapFragment>\n#include<openpbrBlockNormalFinal>\n#include<openpbrBaseLayerData>\n#include<openpbrCoatLayerData>\n#include<openpbrThinFilmLayerData>\n#include<openpbrFuzzLayerData>\nfloat subsurface_weight=0.0;float transmission_weight=0.0;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT_OCCLUSION\nvec3 ambientOcclusionFromTexture=texture2D(ambientOcclusionSampler,vAmbientOcclusionUV+uvOffset).rgb;\n#endif\naoOut=ambientOcclusionBlock(\n#ifdef AMBIENT_OCCLUSION\nambientOcclusionFromTexture,\nvAmbientOcclusionInfos\n#endif\n);\n#ifdef ANISOTROPIC_COAT\ngeometryInfoAnisoOutParams coatGeoInfo=geometryInfoAniso(\ncoatNormalW,viewDirectionW.xyz,coat_roughness,geometricNormalW\n,vec3(geometry_coat_tangent.x,geometry_coat_tangent.y,coat_roughness_anisotropy),TBN\n);\n#else\ngeometryInfoOutParams coatGeoInfo=geometryInfo(\ncoatNormalW,viewDirectionW.xyz,coat_roughness,geometricNormalW\n);\n#endif\nspecular_roughness=mix(specular_roughness,pow(min(1.0,pow(specular_roughness,4.0)+2.0*pow(coat_roughness,4.0)),0.25),coat_weight);\n#ifdef ANISOTROPIC_BASE\ngeometryInfoAnisoOutParams baseGeoInfo=geometryInfoAniso(\nnormalW,viewDirectionW.xyz,specular_roughness,geometricNormalW\n,vec3(geometry_tangent.x,geometry_tangent.y,specular_roughness_anisotropy),TBN\n);\n#else\ngeometryInfoOutParams baseGeoInfo=geometryInfo(\nnormalW,viewDirectionW.xyz,specular_roughness,geometricNormalW\n);\n#endif\n#ifdef FUZZ\nvec3 fuzzNormalW=normalize(mix(normalW,coatNormalW,coat_weight));vec3 fuzzTangent=normalize(TBN[0]);fuzzTangent=normalize(fuzzTangent-dot(fuzzTangent,fuzzNormalW)*fuzzNormalW);vec3 fuzzBitangent=cross(fuzzNormalW,fuzzTangent);geometryInfoOutParams fuzzGeoInfo=geometryInfo(\nfuzzNormalW,viewDirectionW.xyz,fuzz_roughness,geometricNormalW\n);\n#endif\nReflectanceParams coatReflectance;coatReflectance=dielectricReflectance(\ncoat_ior \n,1.0 \n,vec3(1.0)\n,coat_weight\n);\n#ifdef THIN_FILM\nfloat thin_film_outside_ior=mix(1.0,coat_ior,coat_weight);\n#endif\nReflectanceParams baseDielectricReflectance;{float effectiveCoatIor=mix(1.0,coat_ior,coat_weight);baseDielectricReflectance=dielectricReflectance(\nspecular_ior \n,effectiveCoatIor \n,specular_color\n,specular_weight\n);}\nReflectanceParams baseConductorReflectance;baseConductorReflectance=conductorReflectance(base_color,specular_color,specular_weight);vec3 material_surface_ibl=vec3(0.,0.,0.);\n#include<openpbrEnvironmentLighting>\nvec3 material_surface_direct=vec3(0.,0.,0.);\n#if defined(LIGHT0)\nfloat aggShadow=0.;float numLights=0.;\n#include<openpbrDirectLightingInit>[0..maxSimultaneousLights]\n#include<openpbrDirectLighting>[0..maxSimultaneousLights]\n#endif\nvec3 material_surface_emission=vEmissionColor;\n#ifdef EMISSION_COLOR\nvec3 emissionColorTex=texture2D(emissionColorSampler,vEmissionColorUV+uvOffset).rgb;\n#ifdef EMISSION_COLOR_GAMMA\nmaterial_surface_emission*=toLinearSpace(emissionColorTex.rgb);\n#else\nmaterial_surface_emission*=emissionColorTex.rgb;\n#endif\nmaterial_surface_emission*= vEmissionColorInfos.y;\n#endif\nmaterial_surface_emission*=vLightingIntensity.y;\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\nvec4 finalColor=vec4(material_surface_ibl+material_surface_direct+material_surface_emission,alpha);\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,0.0);\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#include<pbrBlockPrePass>\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";bt$1.ShadersStore[v]||(bt$1.ShadersStore[v]=R);const h={name:v,shader:R};var openpbr_fragmentDM6IZaN_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,openpbrPixelShader:h});const r$j="iblVoxelGrid3dDebugPixelShader",a$a="varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var voxelSlabTextureSampler: sampler;var voxelSlabTexture: texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform sizeParams: vec4f;\n#define offsetX uniforms.sizeParams.x\n#define offsetY uniforms.sizeParams.y\n#define widthScale uniforms.sizeParams.z\n#define heightScale uniforms.sizeParams.w\nuniform mipNumber: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =\nvec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var voxelSlab: vec4f=textureSample(voxelSlabTexture,voxelSlabTextureSampler,input.vUV);var size: vec3u=textureDimensions(voxelTexture, i32(uniforms.mipNumber));var dimension: f32=ceil(sqrt( f32(size.z)));var samplePos: vec2f=fract(uv.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(uv.x* f32(dimension)) +\nfloor(uv.y* f32(dimension))*dimension);var mip_separator: f32=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}\nvar outBounds: bool=select(false,true,sampleIndex>size.z-1);sampleIndex=clamp(sampleIndex,0,size.z-1);var samplePosInt: vec2i= vec2i(samplePos.xy* vec2f(size.xy));var voxel: vec3f=textureLoad(voxelTexture,\nvec3i(i32(samplePosInt.x),i32(samplePosInt.y),i32(sampleIndex)),\ni32(uniforms.mipNumber)).rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {if (outBounds) {voxel= vec3f(0.15,0.0,0.0);} else {voxel.r+=mip_separator;}\nfragmentOutputs.color=vec4f(mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel,1.0);}}";bt$1.ShadersStoreWGSL[r$j]||(bt$1.ShadersStoreWGSL[r$j]=a$a);const s={name:r$j,shader:a$a};var iblVoxelGrid3dDebug_fragmentBzMWIIr9_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelGrid3dDebugPixelShaderWGSL:s});const o$a="iblVoxelGrid3dDebugPixelShader",a$9="precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelTexture;uniform sampler2D voxelSlabTexture;uniform sampler2D textureSampler;uniform vec4 sizeParams;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\nuniform float mipNumber;void main(void) {vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 voxelSlab=texture2D(voxelSlabTexture,vUV);ivec3 size=textureSize(voxelTexture,int(mipNumber));float dimension=ceil(sqrt(float(size.z)));vec2 samplePos=fract(uv.xy*vec2(dimension));int sampleIndex=int(floor(uv.x*float(dimension)) +\nfloor(uv.y*float(dimension))*dimension);float mip_separator=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}\nbool outBounds=sampleIndex>size.z-1 ? true : false;sampleIndex=clamp(sampleIndex,0,size.z-1);ivec2 samplePosInt=ivec2(samplePos.xy*vec2(size.xy));vec3 voxel=texelFetch(voxelTexture,\nivec3(samplePosInt.x,samplePosInt.y,sampleIndex),\nint(mipNumber))\n.rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {if (outBounds) {voxel=vec3(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}\nvoxel.r+=mip_separator;}\nglFragColor.rgb=mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel;glFragColor.a=1.0;}}";bt$1.ShadersStore[o$a]||(bt$1.ShadersStore[o$a]=a$9);const r$i={name:o$a,shader:a$9};var iblVoxelGrid3dDebug_fragmentC3nN8Qcl_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelGrid3dDebugPixelShader:r$i});const r$h="copyTexture3DLayerToTexturePixelShader";bt$1.ShadersStoreWGSL[r$h]||(bt$1.ShadersStoreWGSL[r$h]="var textureSampler: texture_3d<f32>;uniform layerNum: i32;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let coord=vec3f(vec2f(input.vUV.x,input.vUV.y)*vec2f(textureDimensions(textureSampler,0).xy),f32(uniforms.layerNum));let color=textureLoad(textureSampler,vec3i(coord),0).rgb;fragmentOutputs.color= vec4f(color,1);}");var copyTexture3DLayerToTexture_fragment5kwSxp1c_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const r$g="copyTexture3DLayerToTexturePixelShader";bt$1.ShadersStore[r$g]||(bt$1.ShadersStore[r$g]="precision highp sampler3D;uniform sampler3D textureSampler;uniform int layerNum;varying vec2 vUV;void main(void) {vec3 coord=vec3(0.0,0.0,float(layerNum));coord.xy=vec2(vUV.x,vUV.y)*vec2(textureSize(textureSampler,0).xy);vec3 color=texelFetch(textureSampler,ivec3(coord),0).rgb;gl_FragColor=vec4(color,1);}\n");var copyTexture3DLayerToTexture_fragmentDSGGUbB8_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const r$f="iblCombineVoxelGridsPixelShader";bt$1.ShadersStoreWGSL[r$f]||(bt$1.ShadersStoreWGSL[r$f]="varying vUV: vec2f;var voxelXaxisSamplerSampler: sampler;var voxelXaxisSampler: texture_3d<f32>;var voxelYaxisSamplerSampler: sampler;var voxelYaxisSampler: texture_3d<f32>;var voxelZaxisSamplerSampler: sampler;var voxelZaxisSampler: texture_3d<f32>;uniform layer: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var coordZ: vec3f= vec3f(fragmentInputs.vUV.x,fragmentInputs.vUV.y,uniforms.layer);var voxelZ: f32=textureSample(voxelZaxisSampler,voxelZaxisSamplerSampler,coordZ).r;var coordX: vec3f= vec3f(1.0-uniforms.layer,fragmentInputs.vUV.y,fragmentInputs.vUV.x);var voxelX: f32=textureSample(voxelXaxisSampler,voxelXaxisSamplerSampler,coordX).r;var coordY: vec3f= vec3f(uniforms.layer,fragmentInputs.vUV.x,fragmentInputs.vUV.y);var voxelY: f32=textureSample(voxelYaxisSampler,voxelYaxisSamplerSampler,coordY).r;var voxel=select(0.0,1.0,(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0));fragmentOutputs.color= vec4f( vec3f(voxel),1.0);}");var iblCombineVoxelGrids_fragmentD8SoWI7m_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const o$9="iblCombineVoxelGridsPixelShader";bt$1.ShadersStore[o$9]||(bt$1.ShadersStore[o$9]="precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelXaxisSampler;uniform sampler3D voxelYaxisSampler;uniform sampler3D voxelZaxisSampler;uniform float layer;void main(void) {vec3 coordZ=vec3(vUV.x,vUV.y,layer);float voxelZ=texture(voxelZaxisSampler,coordZ).r;vec3 coordX=vec3(1.0-layer,vUV.y,vUV.x);float voxelX=texture(voxelXaxisSampler,coordX).r;vec3 coordY=vec3(layer,vUV.x,vUV.y);float voxelY=texture(voxelYaxisSampler,coordY).r;float voxel=(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0) ? 1.0 : 0.0;glFragColor=vec4(vec3(voxel),1.0);}");var iblCombineVoxelGrids_fragmentBt586LSl_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const u="iblGenerateVoxelMipPixelShader";bt$1.ShadersStoreWGSL[u]||(bt$1.ShadersStoreWGSL[u]="varying vUV: vec2f;var srcMip: texture_3d<f32>;uniform layerNum: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var Coords=vec3i(2)*vec3i(vec2i(fragmentInputs.position.xy),uniforms.layerNum);var tex =\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,0),0).x>0.0f))\n<< 0u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,0),0).x>0.0f))\n<< 1u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,0),0).x>0.0f))\n<< 2u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,0),0).x>0.0f))\n<< 3u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,1),0).x>0.0f))\n<< 4u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,1),0).x>0.0f))\n<< 5u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,1),0).x>0.0f))\n<< 6u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,1),0).x>0.0f))\n<< 7u);fragmentOutputs.color=vec4f( f32(tex)/255.0f,0.0f,0.0f,1.0);}");var iblGenerateVoxelMip_fragmentCnq3ynan_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const i$3="iblGenerateVoxelMipPixelShader";bt$1.ShadersStore[i$3]||(bt$1.ShadersStore[i$3]="precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D srcMip;uniform int layerNum;void main(void) {ivec3 Coords=ivec3(2)*ivec3(gl_FragCoord.x,gl_FragCoord.y,layerNum);uint tex =\nuint(texelFetch(srcMip,Coords+ivec3(0,0,0),0).x>0.0f ? 1u : 0u)\n<< 0u |\nuint(texelFetch(srcMip,Coords+ivec3(1,0,0),0).x>0.0f ? 1u : 0u)\n<< 1u |\nuint(texelFetch(srcMip,Coords+ivec3(0,1,0),0).x>0.0f ? 1u : 0u)\n<< 2u |\nuint(texelFetch(srcMip,Coords+ivec3(1,1,0),0).x>0.0f ? 1u : 0u)\n<< 3u |\nuint(texelFetch(srcMip,Coords+ivec3(0,0,1),0).x>0.0f ? 1u : 0u)\n<< 4u |\nuint(texelFetch(srcMip,Coords+ivec3(1,0,1),0).x>0.0f ? 1u : 0u)\n<< 5u |\nuint(texelFetch(srcMip,Coords+ivec3(0,1,1),0).x>0.0f ? 1u : 0u)\n<< 6u |\nuint(texelFetch(srcMip,Coords+ivec3(1,1,1),0).x>0.0f ? 1u : 0u)\n<< 7u;glFragColor.rgb=vec3(float(tex)/255.0f,0.0f,0.0f);glFragColor.a=1.0;}");var iblGenerateVoxelMip_fragmentDpBKrocX_esm_min=/*#__PURE__*/Object.freeze({__proto__:null});const e$3="iblVoxelGridPixelShader",r$e="var voxel_storage: texture_storage_3d<rgba8unorm,write>;varying vNormalizedPosition: vec3f;flat varying f_swizzle: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var size: vec3f=vec3f(textureDimensions(voxel_storage));var normPos: vec3f=input.vNormalizedPosition.xyz;var outputColor: vec4f=vec4f(0.0,0.0,0.0,1.0);switch (input.f_swizzle) {case 0: {normPos=normPos.zxy; \noutputColor=vec4f(1.0,1.0,0.0,1.0);break;}\ncase 1: {normPos=normPos.yzx;outputColor=vec4f(1.0,1.0,1.0,1.0);break;}\ndefault: {normPos=normPos.xyz;outputColor=vec4f(1.0,1.0,0.0,1.0);break;}}\ntextureStore(voxel_storage,vec3<i32>(i32(normPos.x*size.x),i32(normPos.y*size.y),i32(normPos.z*size.z)),outputColor);fragmentOutputs.color=vec4<f32>(vec3<f32>(normPos),1.);}";bt$1.ShadersStoreWGSL[e$3]||(bt$1.ShadersStoreWGSL[e$3]=r$e);const t$7={name:e$3,shader:r$e};var iblVoxelGrid_fragmentDLV6qCT3_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelGridPixelShaderWGSL:t$7});const n$5="iblVoxelGridVertexShader",t$6="#include <bakedVertexAnimationDeclaration>\n#include <bonesDeclaration>\n#include <helperFunctions>\n#include <instancesDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef VERTEX_PULLING_USE_INDEX_BUFFER\nvar<storage,read> indices : array<u32>;\n#endif\nvar<storage,read> position : array<f32>;uniform world : mat4x4f;uniform invWorldScale: mat4x4f;varying vNormalizedPosition : vec3f;flat varying f_swizzle: i32;fn readVertexPosition(index : u32)->vec3f {var pos : vec3f;pos.x=position[index*3];pos.y=position[index*3+1];pos.z=position[index*3+2];return pos;}\nfn readVertexIndex(index : u32)->u32 {\n#ifndef VERTEX_PULLING_USE_INDEX_BUFFER\nreturn index;\n#else\n#ifdef VERTEX_PULLING_INDEX_BUFFER_32BITS\nreturn indices[index];\n#else\nlet u32_index=index/2u;let bit_offset=(index & 1u)*16u;return (indices[u32_index]>>bit_offset) & 0xFFFFu;\n#endif\n#endif\n}\nfn calculateTriangleNormal(v0\n: vec3<f32>,v1\n: vec3<f32>,v2\n: vec3<f32>)\n->vec3<f32> {let edge1=v1-v0;let edge2=v2-v0;let triangleNormal=cross(edge1,edge2);let normalizedTriangleNormal=normalize(triangleNormal);return normalizedTriangleNormal;}\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var vertIdx=readVertexIndex(input.vertexIndex);var positionUpdated=readVertexPosition(vertIdx);\n#include <morphTargetsVertexGlobal>\nlet inputPosition: vec3f=positionUpdated;\n#include <morphTargetsVertex>(vertexInputs.position\\),inputPosition))[0..maxSimultaneousMorphTargets]\n#include <instancesVertex>\n#include <bakedVertexAnimation>\n#include <bonesVertex>\nlet worldPos=finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.position=uniforms.invWorldScale*worldPos;var provokingVertNum : u32=input.vertexIndex/3*3;var pos0=readVertexPosition(readVertexIndex(provokingVertNum));var pos1=readVertexPosition(readVertexIndex(provokingVertNum+1));var pos2=readVertexPosition(readVertexIndex(provokingVertNum+2));var N : vec3<f32>=calculateTriangleNormal(pos0,pos1,pos2);N=abs(N);if (N.x>N.y && N.x>N.z) {vertexOutputs.f_swizzle=0;vertexOutputs.position=vec4f(vertexOutputs.position.yzx,1.0);} else if (N.y>N.z) {vertexOutputs.f_swizzle=1;vertexOutputs.position=vec4f(vertexOutputs.position.zxy,1.0);} else {vertexOutputs.f_swizzle=2;vertexOutputs.position=vec4f(vertexOutputs.position.xyz,1.0);}\nvertexOutputs.vNormalizedPosition=vertexOutputs.position.xyz*0.5+0.5;vertexOutputs.position.z =\nvertexOutputs.vNormalizedPosition.z; }\n";bt$1.ShadersStoreWGSL[n$5]||(bt$1.ShadersStoreWGSL[n$5]=t$6);const r$d={name:n$5,shader:t$6};var iblVoxelGrid_vertexB1sVmNPo_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelGridVertexShaderWGSL:r$d});const a$8="iblVoxelGridPixelShader",n$4="precision highp float;layout(location=0) out highp float glFragData[MAX_DRAW_BUFFERS];varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;if (normPos.z<nearPlane || normPos.z>farPlane) {discard;}\nglFragData[0]=normPos.z<nearPlane+stepSize ? 1.0 : 0.0;glFragData[1]=normPos.z>=nearPlane+stepSize && normPos.z<nearPlane+2.0*stepSize ? 1.0 : 0.0;glFragData[2]=normPos.z>=nearPlane+2.0*stepSize && normPos.z<nearPlane+3.0*stepSize ? 1.0 : 0.0;glFragData[3]=normPos.z>=nearPlane+3.0*stepSize && normPos.z<nearPlane+4.0*stepSize ? 1.0 : 0.0;\n#if MAX_DRAW_BUFFERS>4\nglFragData[4]=normPos.z>=nearPlane+4.0*stepSize && normPos.z<nearPlane+5.0*stepSize ? 1.0 : 0.0;glFragData[5]=normPos.z>=nearPlane+5.0*stepSize && normPos.z<nearPlane+6.0*stepSize ? 1.0 : 0.0;glFragData[6]=normPos.z>=nearPlane+6.0*stepSize && normPos.z<nearPlane+7.0*stepSize ? 1.0 : 0.0;glFragData[7]=normPos.z>=nearPlane+7.0*stepSize && normPos.z<nearPlane+8.0*stepSize ? 1.0 : 0.0;\n#endif\n}";bt$1.ShadersStore[a$8]||(bt$1.ShadersStore[a$8]=n$4);const o$8={name:a$8,shader:n$4};var iblVoxelGrid_fragmentC3isUwpD_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelGridPixelShader:o$8});const i$2="iblVoxelGridVertexShader",n$3="attribute vec3 position;varying vec3 vNormalizedPosition;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\nuniform mat4 invWorldScale;uniform mat4 viewMatrix;void main(void) {vec3 positionUpdated=position;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);gl_Position=viewMatrix*invWorldScale*worldPos;vNormalizedPosition.xyz=gl_Position.xyz*0.5+0.5;\n#ifdef IS_NDC_HALF_ZRANGE\ngl_Position.z=gl_Position.z*0.5+0.5;\n#endif\n}";bt$1.ShadersStore[i$2]||(bt$1.ShadersStore[i$2]=n$3);const o$7={name:i$2,shader:n$3};var iblVoxelGrid_vertexCx4vTw4U_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelGridVertexShader:o$7});const o$6="iblVoxelSlabDebugPixelShader",r$c="varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;var chunkSize: f32=uniforms.stepSize* f32(MAX_DRAW_BUFFERS);var numChunks: f32=1.0/chunkSize;var positionInChunk: f32=fract(normPos.z/chunkSize);var slab: f32=floor(positionInChunk* f32(MAX_DRAW_BUFFERS)) /\nf32(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||\nnormPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {fragmentOutputs.color= vec4f(0.0,0.0,0.0,0.0);} else {fragmentOutputs.color= vec4f(slab,0.0,0.0,0.75);}}";bt$1.ShadersStoreWGSL[o$6]||(bt$1.ShadersStoreWGSL[o$6]=r$c);const e$2={name:o$6,shader:r$c};var iblVoxelSlabDebug_fragmentBYgYcS8_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelSlabDebugPixelShaderWGSL:e$2});const o$5="iblVoxelSlabDebugVertexShader",r$b="attribute position: vec3f;varying vNormalizedPosition: vec3f;uniform world: mat4x4f;uniform invWorldScale: mat4x4f;uniform cameraViewMatrix: mat4x4f;uniform projection: mat4x4f;uniform viewMatrix: mat4x4f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {var worldPosition: vec4f=(uniforms.world* vec4f(input.position,1.));vertexOutputs.position=uniforms.projection*uniforms.cameraViewMatrix*worldPosition;vertexOutputs.vNormalizedPosition=(uniforms.viewMatrix*uniforms.invWorldScale*worldPosition).rgb;vertexOutputs.vNormalizedPosition=vertexOutputs.vNormalizedPosition* vec3f(0.5)+ vec3f(0.5);}";bt$1.ShadersStoreWGSL[o$5]||(bt$1.ShadersStoreWGSL[o$5]=r$b);const t$5={name:o$5,shader:r$b};var iblVoxelSlabDebug_vertexCvPqvVgl_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelSlabDebugVertexShaderWGSL:t$5});const n$2="iblVoxelSlabDebugPixelShader",e$1="precision highp float;varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;float chunkSize=stepSize*float(MAX_DRAW_BUFFERS);float numChunks=1.0/chunkSize;float positionInChunk=fract(normPos.z/chunkSize);float slab=floor(positionInChunk*float(MAX_DRAW_BUFFERS)) /\nfloat(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||\nnormPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {gl_FragColor=vec4(0.0,0.0,0.0,0.0);} else {gl_FragColor=vec4(slab,0.0,0.0,0.75);}}";bt$1.ShadersStore[n$2]||(bt$1.ShadersStore[n$2]=e$1);const r$a={name:n$2,shader:e$1};var iblVoxelSlabDebug_fragmentT7husl4n_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelSlabDebugPixelShader:r$a});const o$4="iblVoxelSlabDebugVertexShader",r$9="attribute vec3 position;varying vec3 vNormalizedPosition;uniform mat4 world;uniform mat4 invWorldScale;uniform mat4 cameraViewMatrix;uniform mat4 projection;uniform mat4 viewMatrix;void main(void) {vec4 worldPosition=(world*vec4(position,1.));gl_Position=projection*cameraViewMatrix*worldPosition;vNormalizedPosition=(viewMatrix*invWorldScale*worldPosition).rgb;vNormalizedPosition.xyz=vNormalizedPosition.xyz*vec3(0.5)+vec3(0.5);}";bt$1.ShadersStore[o$4]||(bt$1.ShadersStore[o$4]=r$9);const e={name:o$4,shader:r$9};var iblVoxelSlabDebug_vertexSGiGSfv_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblVoxelSlabDebugVertexShader:e});const r$8="iblShadowDebugPixelShader",a$7="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;uniform sizeParams: vec4f;\n#define offsetX uniforms.sizeParams.x\n#define offsetY uniforms.sizeParams.y\n#define widthScale uniforms.sizeParams.z\n#define heightScale uniforms.sizeParams.w\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =\nvec2f((offsetX+fragmentInputs.vUV.x)*widthScale,(offsetY+fragmentInputs.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV);var debugColour: vec4f=textureSample(debugSampler,debugSamplerSampler,fragmentInputs.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {fragmentOutputs.color=vec4f(mix(debugColour.rgb,background.rgb,0.0),1.0);}}";bt$1.ShadersStoreWGSL[r$8]||(bt$1.ShadersStoreWGSL[r$8]=a$7);const t$4={name:r$8,shader:a$7};var iblShadowDebug_fragmentDP5B4VsA_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowDebugPixelShaderWGSL:t$4});const r$7="iblShadowDebugPixelShader",a$6="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D debugSampler;uniform vec4 sizeParams;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\nvoid main(void) {vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 debugColour=texture2D(debugSampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {gl_FragColor.rgb=mix(debugColour.rgb,background.rgb,0.0);gl_FragColor.a=1.0;}}";bt$1.ShadersStore[r$7]||(bt$1.ShadersStore[r$7]=a$6);const i$1={name:r$7,shader:a$6};var iblShadowDebug_fragmentDpcUObyS_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowDebugPixelShader:i$1});const a$5="iblShadowVoxelTracingPixelShader",n$1="#define PI 3.1415927\nvarying vUV: vec2f;\n#define DISABLE_UNIFORMITY_ANALYSIS\nvar depthSampler: texture_2d<f32>;var worldNormalSampler : texture_2d<f32>;var blueNoiseSampler: texture_2d<f32>;var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;var voxelGridSamplerSampler: sampler;var voxelGridSampler: texture_3d<f32>;\n#ifdef COLOR_SHADOWS\nvar iblSamplerSampler: sampler;var iblSampler: texture_cube<f32>;\n#endif\nuniform shadowParameters: vec4f;\n#define SHADOWdirs uniforms.shadowParameters.x\n#define SHADOWframe uniforms.shadowParameters.y\n#define SHADOWenvRot uniforms.shadowParameters.w\nuniform voxelBiasParameters : vec4f;\n#define highestMipLevel uniforms.voxelBiasParameters.z\nuniform sssParameters: vec4f;\n#define SSSsamples uniforms.sssParameters.x\n#define SSSstride uniforms.sssParameters.y\n#define SSSmaxDistance uniforms.sssParameters.z\n#define SSSthickness uniforms.sssParameters.w\nuniform shadowOpacity: vec4f;uniform projMtx: mat4x4f;uniform viewMtx: mat4x4f;uniform invProjMtx: mat4x4f;uniform invViewMtx: mat4x4f;uniform wsNormalizationMtx: mat4x4f;uniform invVPMtx: mat4x4f;\n#define PI 3.1415927\n#define GOLD 0.618034\nstruct AABB3f {m_min: vec3f,\nm_max: vec3f,};struct Ray {orig: vec3f,\ndir: vec3f,\ndir_rcp: vec3f,\nt_min: f32,\nt_max: f32,};fn make_ray(origin: vec3f,direction: vec3f,tmin: f32,\ntmax: f32)->Ray {var ray: Ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}\nfn ray_box_intersection(aabb: AABB3f,ray: Ray ,\ndistance_near: ptr<function,f32>,distance_far: ptr<function,f32>)->bool{var tbot: vec3f=ray.dir_rcp*(aabb.m_min-ray.orig);var ttop: vec3f=ray.dir_rcp*(aabb.m_max-ray.orig);var tmin: vec3f=min(ttop,tbot);var tmax: vec3f=max(ttop,tbot);*distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));*distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return *distance_near<=*distance_far;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nstruct VoxelMarchDiagnosticInfo {heat: f32,\nvoxel_intersect_coords: vec3i,};\n#endif\nfn hash(i: u32)->u32 {var temp=i ^ (i>>16u);temp*=0x7FEB352Du;temp ^= temp>>15u;temp*=0x846CA68Bu;temp ^= temp>>16u;return temp;}\nfn uintBitsToFloat(x: u32)->f32 {return bitcast<f32>(x);}\nfn uint2float(i: u32)->f32 {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}\nfn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nfn plasticSequence(rstate: u32)->vec2f {return vec2f(uint2float(rstate*3242174889u),\nuint2float(rstate*2447445414u));}\nfn goldenSequence(rstate: u32)->f32 {return uint2float(rstate*2654435769u);}\nfn distanceSquared(a: vec2f,b: vec2f)->f32 {var diff: vec2f=a-b;return dot(diff,diff);}\nfn genTB(N: vec3f,T: ptr<function,vec3f>,B: ptr<function,vec3f>) {var s: f32=select(1.0,-1.0,N.z<0.0);var a: f32=-1.0/(s+N.z);var b: f32=N.x*N.y*a;*T= vec3f(1.0+s*N.x*N.x*a,s*b,-s*N.x);*B= vec3f(b,s+N.y*N.y*a,-N.y);}\nfn lessThan(x: vec3f,y: vec3f)->vec3<bool> {return x<y;}\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfn anyHitVoxels(ray_vs: Ray,\nvoxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->bool {\n#else\nfn anyHitVoxels(ray_vs: Ray)->bool {\n#endif\nvar stack=array<i32,24>(); \nvar invD: vec3f=ray_vs.dir_rcp;var D: vec3f=ray_vs.dir;var O: vec3f=ray_vs.orig;var negD=vec3i(lessThan(D, vec3f(0,0,0)));var voxel0: i32=negD.x | (negD.y<<1) | (negD.z<<2);var t0: vec3f=-O*invD;var t1=(vec3f(1.0)-O)*invD;var maxLod: i32= i32(highestMipLevel);var stackLevel: i32=0;\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvar steps: u32=0u;\n#endif\nstack[stackLevel]=maxLod<<24;stackLevel++;while (stackLevel>0) {stackLevel=stackLevel-1;var elem: i32=stack[stackLevel];var Coords: vec4i =\nvec4i(elem & 0xFF,(elem>>8) & 0xFF,(elem>>16) & 0xFF,elem>>24);if (Coords.w==0) {\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n*voxel_march_diagnostic_info.heat= f32(steps)/24.0;\n#endif\nreturn true;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n++steps;\n#endif\nvar invRes: f32=exp2(f32(Coords.w-maxLod));var bbmin: vec3f=invRes*vec3f(Coords.xyz+negD);var bbmax: vec3f=invRes*vec3f(Coords.xyz-negD+vec3i(1));var mint: vec3f=mix(t0,t1,bbmin);var maxt: vec3f=mix(t0,t1,bbmax);var midt: vec3f=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);var nodeMask: u32= u32(\nround(textureLoad(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;var voxelBit: u32=u32(voxel0);Coords=vec4i((Coords.xyz<<vec3u(1))+negD,Coords.w);var packedCoords: i32 =\nCoords.x | (Coords.y<<8) | (Coords.z<<16) | (Coords.w<<24);if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n*voxel_march_diagnostic_info.heat= f32(steps)/24.0;\n#endif\nreturn false;}\nfn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {return (near*far)/(far-depth*(far-near));}\nfn screenSpaceShadow(csOrigin: vec3f,csDirection: vec3f,csZBufferSize: vec2f,\nnearPlaneZ: f32,farPlaneZ: f32,noise: f32)->f32 {\n#ifdef RIGHT_HANDED\nvar csZDir : f32=-1.0;\n#else \nvar csZDir : f32=1.0;\n#endif\nvar ssSamples: f32=SSSsamples;var ssMaxDist: f32=SSSmaxDistance;var ssStride: f32=SSSstride;var ssThickness: f32=SSSthickness;var rayLength: f32 =\nselect(ssMaxDist,(nearPlaneZ-csOrigin.z)/csDirection.z,\ncsZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ);var csEndPoint: vec3f=csOrigin+rayLength*csDirection;var H0: vec4f=uniforms.projMtx*vec4f(csOrigin,1.0);var H1: vec4f=uniforms.projMtx*vec4f(csEndPoint,1.0);var Z0=vec2f(csOrigin.z ,1.0)/H0.w;var Z1=vec2f(csEndPoint.z,1.0)/H1.w;var P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);var P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}\nvar stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f=ssStride* vec2f(stepDirection,invdx*delta.y);var dZ: vec2f=ssStride*invdx*(Z1-Z0);var opacity: f32=0.0;var P: vec2f=P0+noise*dP;var Z: vec2f=Z0+noise*dZ;var end: f32=P1.x*stepDirection;var rayZMax=csZDir*Z.x/Z.y;var sceneDepth=rayZMax;Z+=dZ;for (var stepCount: f32=0.0; \nopacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount+=1) { \nvar coords=vec2i(select(P,P.yx,permute));sceneDepth=textureLoad(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}\nvar rayZMin: f32=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));P+=dP;Z+=dZ;}\nreturn opacity;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,\nDitherNoise: vec2f,\nvoxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->f32 {\n#else\nfn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,\nDitherNoise: vec2f)->f32 {\n#endif\nvar vxResolution: f32=f32(textureDimensions(voxelGridSampler,0).x);var T: vec3f;var B: vec3f;genTB(wsDirection,&T,&B);var DitherXY: vec2f=sqrt(DitherNoise.x)* vec2f(cos(2.0*PI*DitherNoise.y),\nsin(2.0*PI*DitherNoise.y));var Dithering : vec3f=(uniforms.voxelBiasParameters.x*wsNormal +\nuniforms.voxelBiasParameters.y*wsDirection +\nDitherXY.x*T+DitherXY.y*B) /\nvxResolution;var O: vec3f=0.5*wsOrigin+0.5+Dithering;var ray_vs=make_ray(O,wsDirection,0.0,10.0);var voxel_aabb: AABB3f;voxel_aabb.m_min=vec3f(0);voxel_aabb.m_max=vec3f(1);var near: f32=0;var far: f32=0;if (!ray_box_intersection(voxel_aabb,ray_vs,&near,&far)) {return 0.0;}\nray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nreturn select(0.0f,1.0f,anyHitVoxels(ray_vs,voxel_march_diagnostic_info));\n#else\nreturn select(0.0f,1.0f,anyHitVoxels(ray_vs));\n#endif\n}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var nbDirs=u32(SHADOWdirs);var frameId=u32(SHADOWframe);var envRot: f32=SHADOWenvRot;var Resolution: vec2f= vec2f(textureDimensions(depthSampler,0));var currentPixel=vec2i(fragmentInputs.vUV*Resolution);var GlobalIndex =\n(frameId*u32(Resolution.y)+u32(currentPixel.y))*u32(Resolution.x) +\nu32(currentPixel.x);var N : vec3f=textureLoad(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}\nvar normalizedRotation: f32=envRot/(2.0*PI);var depth : f32=textureLoad(depthSampler,currentPixel,0).x;\n#ifndef IS_NDC_HALF_ZRANGE\ndepth=depth*2.0-1.0;\n#endif\nvar temp : vec2f=(vec2f(currentPixel)+vec2f(0.5))*2.0/Resolution -\nvec2f(1.0);var VP : vec4f=uniforms.invProjMtx*vec4f(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);var noise : vec3f=textureLoad(blueNoiseSampler,currentPixel & vec2i(0xFF),0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvar heat: f32=0.0f;\n#endif\nvar shadowAccum: f32=0.001;var specShadowAccum: f32=0.001;var sampleWeight : f32=0.001;\n#ifdef COLOR_SHADOWS\nvar totalLight: vec3f=vec3f(0.001);var shadowedLight: vec3f=vec3f(0.0);\n#endif\nfor (var i: u32=0; i<nbDirs; i++) {var dirId: u32=nbDirs*GlobalIndex+i;var L: vec4f;var T: vec2f;{var r: vec2f=plasticSequence(frameId*nbDirs+i);r=fract(r+ vec2f(2.0)*abs(noise.xy- vec2f(0.5)));T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2f(r.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2f(T.x,r.y),0.0).y;L= vec4f(uv_to_normal(vec2f(T.x-normalizedRotation,T.y)),0);\n#ifndef RIGHT_HANDED\nL.z*=-1.0;\n#endif\n}\n#ifdef COLOR_SHADOWS\nvar lightDir: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var ibl: vec3f=textureSampleLevel(iblSampler,iblSamplerSampler,lightDir,0.0).xyz;var pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;\n#endif\nvar cosNL: f32=dot(N,L.xyz);var opacity: f32=0.0;if (cosNL>0.0) {var VP2: vec4f=VP;VP2.y*=-1.0;var unormWP : vec4f=uniforms.invViewMtx*VP2;var WP: vec3f=(uniforms.wsNormalizationMtx*unormWP).xyz;var vxNoise: vec2f=vec2f(uint2float(hash(dirId*2)),uint2float(hash(dirId*2+1)));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nVoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,\nuniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,\nvoxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;\n#else\nopacity =\nmax(opacity,uniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));\n#endif\nvar VL : vec3f=(uniforms.viewMtx*L).xyz;\n#ifdef RIGHT_HANDED\nvar nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0); \nvar farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0);\n#else\nvar nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0); \nvar farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0);\n#endif\nvar ssShadow: f32=uniforms.shadowOpacity.y *\nscreenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,\nabs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);\n#ifdef COLOR_SHADOWS\nvar light: vec3f=select(vec3f(0.0),vec3f(cosNL)/vec3f(pdf)*ibl,pdf>1e-6);shadowedLight+=light*opacity;totalLight+=light;\n#else\nvar rcos: f32=1.0-cosNL;shadowAccum+=(1.0-opacity*(1.0-pow(rcos,8.0)));sampleWeight+=1.0;var VR : vec3f=abs((uniforms.viewMtx*vec4f(reflect(-L.xyz,N),0.0)).xyz);specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);\n#endif\n}\nnoise.z=fract(noise.z+GOLD);}\n#ifdef COLOR_SHADOWS\nvar shadow: vec3f=(totalLight-shadowedLight)/totalLight;var maxShadow: f32=max(max(shadow.x,max(shadow.y,shadow.z)),1.0);fragmentOutputs.color=vec4f(shadow/maxShadow,1.0);\n#else\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfragmentOutputs.color =\nvec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,heat/sampleWeight,1.0);\n#else\nfragmentOutputs.color=vec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,0.0,1.0);\n#endif\n#endif\n}";bt$1.ShadersStoreWGSL[a$5]||(bt$1.ShadersStoreWGSL[a$5]=n$1);const r$6={name:a$5,shader:n$1};var iblShadowVoxelTracing_fragmentDhQtUKFU_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowVoxelTracingPixelShaderWGSL:r$6});const n="iblShadowVoxelTracingPixelShader",t$3="precision highp sampler2D;precision highp sampler3D;\n#define PI 3.1415927\nvarying vec2 vUV;\n#define DISABLE_UNIFORMITY_ANALYSIS\nuniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D blueNoiseSampler;uniform sampler2D icdfSampler;uniform sampler3D voxelGridSampler;\n#ifdef COLOR_SHADOWS\nuniform samplerCube iblSampler;\n#endif\nuniform vec4 shadowParameters;\n#define SHADOWdirs shadowParameters.x\n#define SHADOWframe shadowParameters.y\n#define SHADOWenvRot shadowParameters.w\nuniform vec4 voxelBiasParameters;\n#define highestMipLevel voxelBiasParameters.z\nuniform vec4 sssParameters;\n#define SSSsamples sssParameters.x\n#define SSSstride sssParameters.y\n#define SSSmaxDistance sssParameters.z\n#define SSSthickness sssParameters.w\nuniform vec4 shadowOpacity;uniform mat4 projMtx;uniform mat4 viewMtx;uniform mat4 invProjMtx;uniform mat4 invViewMtx;uniform mat4 wsNormalizationMtx;uniform mat4 invVPMtx;\n#define PI 3.1415927\n#define GOLD 0.618034\nstruct AABB3f {vec3 m_min;vec3 m_max;};struct Ray {vec3 orig;vec3 dir;vec3 dir_rcp;float t_min;float t_max;};Ray make_ray(const vec3 origin,const vec3 direction,const float tmin,\nconst float tmax) {Ray ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}\nbool ray_box_intersection(const in AABB3f aabb,const in Ray ray,\nout float distance_near,out float distance_far) {vec3 tbot=ray.dir_rcp*(aabb.m_min-ray.orig);vec3 ttop=ray.dir_rcp*(aabb.m_max-ray.orig);vec3 tmin=min(ttop,tbot);vec3 tmax=max(ttop,tbot);distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return distance_near<=distance_far;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nstruct VoxelMarchDiagnosticInfo {float heat;ivec3 voxel_intersect_coords;};\n#endif\nuint hash(uint i) {i ^= i>>16u;i*=0x7FEB352Du;i ^= i>>15u;i*=0x846CA68Bu;i ^= i>>16u;return i;}\nfloat uint2float(uint i) {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}\nvec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.0*PI;float phi=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nvec2 plasticSequence(const uint rstate) {return vec2(uint2float(rstate*3242174889u),\nuint2float(rstate*2447445414u));}\nfloat goldenSequence(const uint rstate) {return uint2float(rstate*2654435769u);}\nfloat distanceSquared(vec2 a,vec2 b) {vec2 diff=a-b;return dot(diff,diff);}\nvoid genTB(const vec3 N,out vec3 T,out vec3 B) {float s=N.z<0.0 ? -1.0 : 1.0;float a=-1.0/(s+N.z);float b=N.x*N.y*a;T=vec3(1.0+s*N.x*N.x*a,s*b,-s*N.x);B=vec3(b,s+N.y*N.y*a,-N.y);}\nint stack[24]; \n#define PUSH(i) stack[stackLevel++]=i; \n#define POP() stack[--stackLevel] \n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nbool anyHitVoxels(const Ray ray_vs,\nout VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {\n#else\nbool anyHitVoxels(const Ray ray_vs) {\n#endif\nvec3 invD=ray_vs.dir_rcp;vec3 D=ray_vs.dir;vec3 O=ray_vs.orig;ivec3 negD=ivec3(lessThan(D,vec3(0,0,0)));int voxel0=negD.x | negD.y<<1 | negD.z<<2;vec3 t0=-O*invD,t1=(vec3(1.0)-O)*invD;int maxLod=int(highestMipLevel);int stackLevel=0;\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nuint steps=0u;\n#endif\nPUSH(maxLod<<24);while (stackLevel>0) {int elem=POP();ivec4 Coords =\nivec4(elem & 0xFF,elem>>8 & 0xFF,elem>>16 & 0xFF,elem>>24);if (Coords.w==0) {\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvoxel_march_diagnostic_info.heat=float(steps)/24.0;\n#endif\nreturn true;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n++steps;\n#endif\nfloat invRes=exp2(float(Coords.w-maxLod));vec3 bbmin=invRes*vec3(Coords.xyz+negD);vec3 bbmax=invRes*vec3(Coords.xyz-negD+ivec3(1));vec3 mint=mix(t0,t1,bbmin);vec3 maxt=mix(t0,t1,bbmax);vec3 midt=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);int nodeMask=int(\nround(texelFetch(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;int voxelBit=voxel0;Coords.xyz=(Coords.xyz<<1)+negD;int packedCoords =\nCoords.x | Coords.y<<8 | Coords.z<<16 | Coords.w<<24;if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvoxel_march_diagnostic_info.heat=float(steps)/24.0;\n#endif\nreturn false;}\nfloat linearizeDepth(float depth,float near,float far) {return (near*far)/(far-depth*(far-near));}\nfloat screenSpaceShadow(vec3 csOrigin,vec3 csDirection,vec2 csZBufferSize,\nfloat nearPlaneZ,float farPlaneZ,float noise) {\n#ifdef RIGHT_HANDED\nfloat csZDir=-1.0;\n#else \nfloat csZDir=1.0;\n#endif\nfloat ssSamples=SSSsamples;float ssMaxDist=SSSmaxDistance;float ssStride=SSSstride;float ssThickness=SSSthickness;float rayLength =\ncsZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ\n? \n(nearPlaneZ-csOrigin.z)/csDirection.z\n: ssMaxDist;vec3 csEndPoint=csOrigin+rayLength*csDirection;vec4 H0=projMtx*vec4(csOrigin,1.0);vec4 H1=projMtx*vec4(csEndPoint,1.0);vec2 Z0=vec2(csOrigin.z ,1.0)/H0.w;vec2 Z1=vec2(csEndPoint.z,1.0)/H1.w;vec2 P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);vec2 P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+=vec2(distanceSquared(P0,P1)<0.0001 ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}\nfloat stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=ssStride*vec2(stepDirection,invdx*delta.y);vec2 dZ=ssStride*invdx*(Z1-Z0);float opacity=0.0;vec2 P=P0+noise*dP;vec2 Z=Z0+noise*dZ;float end=P1.x*stepDirection;float rayZMax=csZDir*Z.x/Z.y;float sceneDepth=rayZMax;Z+=dZ;for (float stepCount=0.0;opacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount++,P+=dP,\nZ+=dZ) { \nivec2 coords=ivec2(permute ? P.yx : P);sceneDepth=texelFetch(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}\nfloat rayZMin=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));}\nreturn opacity;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfloat voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,\nvec2 DitherNoise,\nout VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {\n#else\nfloat voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,\nvec2 DitherNoise) {\n#endif\nfloat vxResolution=float(textureSize(voxelGridSampler,0).x);vec3 T,B;genTB(wsDirection,T,B);vec2 DitherXY=sqrt(DitherNoise.x)*vec2(cos(2.0*PI*DitherNoise.y),\nsin(2.0*PI*DitherNoise.y));float sceneScale=wsNormalizationMtx[0][0];vec3 Dithering =\n(voxelBiasParameters.x*wsNormal+voxelBiasParameters.y*wsDirection +\nDitherXY.x*T+DitherXY.y*B) /\nvxResolution;vec3 O=0.5*wsOrigin+0.5+Dithering;Ray ray_vs=make_ray(O,wsDirection,0.0,10.0);AABB3f voxel_aabb;voxel_aabb.m_min=vec3(0);voxel_aabb.m_max=vec3(1);float near,far;if (!ray_box_intersection(voxel_aabb,ray_vs,near,far))\nreturn 0.0;ray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nreturn anyHitVoxels(ray_vs,voxel_march_diagnostic_info) ? 1.0f : 0.0f;\n#else\nreturn anyHitVoxels(ray_vs) ? 1.0f : 0.0f;\n#endif\n}\nvoid main(void) {uint nbDirs=uint(SHADOWdirs);uint frameId=uint(SHADOWframe);float envRot=SHADOWenvRot;vec2 Resolution=vec2(textureSize(depthSampler,0));ivec2 currentPixel=ivec2(vUV*Resolution);uint GlobalIndex=(frameId*uint(Resolution.y)+uint(currentPixel.y)) *\nuint(Resolution.x) +\nuint(currentPixel.x);vec3 N=texelFetch(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}\nfloat normalizedRotation=envRot/(2.0*PI);float depth=texelFetch(depthSampler,currentPixel,0).x;\n#ifndef IS_NDC_HALF_ZRANGE\ndepth=depth*2.0-1.0;\n#endif\nvec2 temp=(vec2(currentPixel)+vec2(0.5))*2.0/Resolution-vec2(1.0);vec4 VP=invProjMtx*vec4(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);vec3 noise=texelFetch(blueNoiseSampler,currentPixel & 0xFF,0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfloat heat=0.0f;\n#endif\nfloat shadowAccum=0.001;float specShadowAccum=0.001;float sampleWeight=0.001;\n#ifdef COLOR_SHADOWS\nvec3 totalLight=vec3(0.001);vec3 shadowedLight=vec3(0.0);\n#endif\nfor (uint i=0u; i<nbDirs; i++) {uint dirId=nbDirs*GlobalIndex+i;vec4 L;vec2 T;{vec2 r=plasticSequence(frameId*nbDirs+i);r=fract(r+vec2(2.0)*abs(noise.xy-vec2(0.5)));T.x=textureLod(icdfSampler,vec2(r.x,0.0),0.0).x;T.y=textureLod(icdfSampler,vec2(T.x,r.y),0.0).y;L=vec4(uv_to_normal(vec2(T.x-normalizedRotation,T.y)),0);\n#ifndef RIGHT_HANDED\nL.z*=-1.0;\n#endif\n}\n#ifdef COLOR_SHADOWS\nvec3 lightDir=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));vec3 ibl=textureLod(iblSampler,lightDir,0.0).xyz;float pdf=textureLod(icdfSampler,T,0.0).z;\n#endif\nfloat cosNL=dot(N,L.xyz);float opacity=0.0;if (cosNL>0.0) {vec4 VP2=VP;VP2.y*=-1.0;vec4 unormWP=invViewMtx*VP2;vec3 WP=(wsNormalizationMtx*unormWP).xyz;vec2 vxNoise=vec2(uint2float(hash(dirId*2u)),uint2float(hash(dirId*2u+1u)));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nVoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,voxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;\n#else\nopacity =\nmax(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));\n#endif\nvec3 VL=(viewMtx*L).xyz;\n#ifdef RIGHT_HANDED\nfloat nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0); \nfloat farPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0);\n#else\nfloat nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0); \nfloat farPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0);\n#endif\nfloat ssShadow=shadowOpacity.y *\nscreenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,\nabs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);\n#ifdef COLOR_SHADOWS\nvec3 light=pdf<1e-6 ? vec3(0.0) : vec3(cosNL)/vec3(pdf)*ibl;shadowedLight+=light*opacity;totalLight+=light;\n#else\nfloat rcos=(1.0-cosNL);shadowAccum+=(1.0-opacity*(1.0-pow(rcos,8.0)));sampleWeight+=1.0;vec3 VR=-(viewMtx*vec4(reflect(-L.xyz,N),0.0)).xyz;specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);\n#endif\n}\nnoise.z=fract(noise.z+GOLD);}\n#ifdef COLOR_SHADOWS\nvec3 shadow=(totalLight-shadowedLight)/totalLight;float maxShadow=max(max(shadow.x,max(shadow.y,shadow.z)),1.0);glFragColor=vec4(shadow/maxShadow,1.0);\n#else\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\ngl_FragColor=vec4(shadowAccum/float(sampleWeight),\nspecShadowAccum/float(sampleWeight),heat/float(sampleWeight),1.0);\n#else\ngl_FragColor=vec4(shadowAccum/float(sampleWeight),specShadowAccum/float(sampleWeight),0.0,1.0);\n#endif\n#endif\n}";bt$1.ShadersStore[n]||(bt$1.ShadersStore[n]=t$3);const i={name:n,shader:t$3};var iblShadowVoxelTracing_fragmentDWNiOx1O_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowVoxelTracingPixelShader:i});const r$5="iblShadowSpatialBlurPixelShader",a$4="#define PI 3.1415927\nvarying vUV: vec2f;var depthSampler: texture_2d<f32>;var worldNormalSampler: texture_2d<f32>;var voxelTracingSampler : texture_2d<f32>;uniform blurParameters: vec4f;\n#define stridef uniforms.blurParameters.x\n#define worldScale uniforms.blurParameters.y\nconst weights=array<f32,5>(0.0625,0.25,0.375,0.25,0.0625);const nbWeights: i32=5;fn max2(v: vec2f,w: vec2f)->vec2f {return vec2f(max(v.x,w.x),max(v.y,w.y));}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var gbufferRes=vec2f(textureDimensions(depthSampler,0));var gbufferPixelCoord= vec2i(fragmentInputs.vUV*gbufferRes);var shadowRes=vec2f(textureDimensions(voxelTracingSampler,0));var shadowPixelCoord= vec2i(fragmentInputs.vUV*shadowRes);var N: vec3f=textureLoad(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}\nvar depth: f32=-textureLoad(depthSampler,gbufferPixelCoord,0).x;var X: vec4f= vec4f(0.0);for(var y: i32=0; y<nbWeights; y++) {for(var x: i32=0; x<nbWeights; x++) {var gBufferCoords: vec2i=gbufferPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var shadowCoords: vec2i=shadowPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var T : vec3f=textureLoad(voxelTracingSampler,shadowCoords,0).xyz;var ddepth: f32=-textureLoad(depthSampler,gBufferCoords,0).x-depth;var dN: vec3f=textureLoad(worldNormalSampler,gBufferCoords,0).xyz-N;var w: f32=weights[x]*weights[y] *\nexp2(max(-1000.0/(worldScale*worldScale),-0.5) *\n(ddepth*ddepth) -\n1e1*dot(dN,dN));X+= vec4f(w*T.x,w*T.y,w*T.z,w);}}\nfragmentOutputs.color= vec4f(X.x/X.w,X.y/X.w,X.z/X.w,1.0);}";bt$1.ShadersStoreWGSL[r$5]||(bt$1.ShadersStoreWGSL[r$5]=a$4);const t$2={name:r$5,shader:a$4};var iblShadowSpatialBlur_fragmentHlETMmY4_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowSpatialBlurPixelShaderWGSL:t$2});const r$4="iblShadowSpatialBlurPixelShader",o$3="precision highp sampler2D;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D voxelTracingSampler;uniform vec4 blurParameters;\n#define stridef blurParameters.x\n#define worldScale blurParameters.y\nconst float weights[5]=float[5](0.0625,0.25,0.375,0.25,0.0625);const int nbWeights=5;vec2 max2(vec2 v,vec2 w) {return vec2(max(v.x,w.x),max(v.y,w.y));}\nvoid main(void)\n{vec2 gbufferRes=vec2(textureSize(depthSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(voxelTracingSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec3 N=texelFetch(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}\nfloat depth=-texelFetch(depthSampler,gbufferPixelCoord,0).x;vec4 X=vec4(0.0);for(int y=0; y<nbWeights; ++y) {for(int x=0; x<nbWeights; ++x) {ivec2 gBufferCoords=gbufferPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));ivec2 shadowCoords=shadowPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));vec4 T=texelFetch(voxelTracingSampler,shadowCoords,0);float ddepth=-texelFetch(depthSampler,gBufferCoords,0).x-depth;vec3 dN=texelFetch(worldNormalSampler,gBufferCoords,0).xyz-N;float w=weights[x]*weights[y] *\nexp2(max(-1000.0/(worldScale*worldScale),-0.5) *\n(ddepth*ddepth) -\n1e1*dot(dN,dN));X+=vec4(w*T.x,w*T.y,w*T.z,w);}}\ngl_FragColor=vec4(X.x/X.w,X.y/X.w,X.z/X.w,1.0);}";bt$1.ShadersStore[r$4]||(bt$1.ShadersStore[r$4]=o$3);const t$1={name:r$4,shader:o$3};var iblShadowSpatialBlur_fragmentBLNNNYdL_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowSpatialBlurPixelShader:t$1});const r$3="iblShadowAccumulationPixelShader",a$3="varying vUV: vec2f;uniform accumulationParameters: vec4f;\n#define remanence uniforms.accumulationParameters.x\n#define resetb uniforms.accumulationParameters.y\n#define sceneSize uniforms.accumulationParameters.z\nvar motionSampler: texture_2d<f32>;var positionSampler: texture_2d<f32>;var spatialBlurSampler : texture_2d<f32>;var oldAccumulationSamplerSampler: sampler;var oldAccumulationSampler: texture_2d<f32>;var prevPositionSamplerSampler: sampler;var prevPositionSampler: texture_2d<f32>;fn max2(v: vec2f,w: vec2f)->vec2f { \nreturn vec2f(max(v.x,w.x),max(v.y,w.y)); }\nfn lessThan(x: vec2f,y: vec2f)->vec2<bool> {return x<y;}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var reset: bool= bool(resetb);var gbufferRes : vec2f=vec2f(textureDimensions(positionSampler,0));var gbufferPixelCoord: vec2i= vec2i(input.vUV*gbufferRes);var shadowRes : vec2f=vec2f(textureDimensions(spatialBlurSampler,0));var shadowPixelCoord: vec2i= vec2i(input.vUV*shadowRes);var LP: vec4f=textureLoad(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {fragmentOutputs.color=vec4f(1.0,0.0,0.0,1.0);return fragmentOutputs;}\nvar velocityColor: vec2f=textureLoad(motionSampler,gbufferPixelCoord,0).xy;var prevCoord: vec2f=input.vUV+velocityColor;var PrevLP: vec3f=textureSampleLevel(prevPositionSampler,prevPositionSamplerSampler,prevCoord,0.0).xyz;var PrevShadows: vec4f=textureSampleLevel(oldAccumulationSampler,oldAccumulationSamplerSampler,prevCoord,0.0);var newShadows : vec3f=textureLoad(spatialBlurSampler,shadowPixelCoord,0).xyz;PrevShadows.a=select(1.0,max(PrevShadows.a/(1.0+PrevShadows.a),1.0-remanence),!reset && all(lessThan(abs(prevCoord- vec2f(0.5)), vec2f(0.5))) &&\ndistance(LP.xyz,PrevLP)<5e-2*sceneSize);PrevShadows=max( vec4f(0.0),PrevShadows);fragmentOutputs.color= vec4f(mix(PrevShadows.x,newShadows.x,PrevShadows.a),\nmix(PrevShadows.y,newShadows.y,PrevShadows.a),\nmix(PrevShadows.z,newShadows.z,PrevShadows.a),PrevShadows.a);}";bt$1.ShadersStoreWGSL[r$3]||(bt$1.ShadersStoreWGSL[r$3]=a$3);const o$2={name:r$3,shader:a$3};var iblShadowAccumulation_fragmentDTJcBrw_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowAccumulationPixelShaderWGSL:o$2});const r$2="iblShadowAccumulationPixelShader",o$1="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec2 vUV;uniform vec4 accumulationParameters;\n#define remanence accumulationParameters.x\n#define resetb accumulationParameters.y\n#define sceneSize accumulationParameters.z\nuniform sampler2D motionSampler;uniform sampler2D positionSampler;uniform sampler2D spatialBlurSampler;uniform sampler2D oldAccumulationSampler;uniform sampler2D prevPositionSampler;vec2 max2(vec2 v,vec2 w) { return vec2(max(v.x,w.x),max(v.y,w.y)); }\nvoid main(void) {bool reset=bool(resetb);vec2 gbufferRes=vec2(textureSize(motionSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(spatialBlurSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec4 LP=texelFetch(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {gl_FragColor=vec4(1.0,0.0,0.0,1.0);return;}\nvec2 velocityColor=texelFetch(motionSampler,gbufferPixelCoord,0).xy;vec2 prevCoord=vUV+velocityColor;vec3 PrevLP=texture(prevPositionSampler,prevCoord).xyz;vec4 PrevShadows=texture(oldAccumulationSampler,prevCoord);vec3 newShadows=texelFetch(spatialBlurSampler,shadowPixelCoord,0).xyz;PrevShadows.a =\n!reset && all(lessThan(abs(prevCoord-vec2(0.5)),vec2(0.5))) &&\ndistance(LP.xyz,PrevLP)<5e-2*sceneSize\n? max(PrevShadows.a/(1.0+PrevShadows.a),1.0-remanence)\n: 1.0;PrevShadows=max(vec4(0.0),PrevShadows);gl_FragColor =\nvec4(mix(PrevShadows.x,newShadows.x,PrevShadows.a),\nmix(PrevShadows.y,newShadows.y,PrevShadows.a),\nmix(PrevShadows.z,newShadows.z,PrevShadows.a),PrevShadows.a);}";bt$1.ShadersStore[r$2]||(bt$1.ShadersStore[r$2]=o$1);const a$2={name:r$2,shader:o$1};var iblShadowAccumulation_fragment6JCuF3du_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowAccumulationPixelShader:a$2});const r$1="iblShadowGBufferDebugPixelShader",a$1="varying vUV : vec2f;var textureSamplerSampler : sampler;var textureSampler : texture_2d<f32>;var depthSamplerSampler : sampler;var depthSampler : texture_2d<f32>;var normalSamplerSampler : sampler;var normalSampler : texture_2d<f32>;var positionSamplerSampler : sampler;var positionSampler : texture_2d<f32>;var velocitySamplerSampler : sampler;var velocitySampler : texture_2d<f32>;uniform sizeParams : vec4f;\n#define offsetX uniforms.sizeParams.x\n#define offsetY uniforms.sizeParams.y\n#define widthScale uniforms.sizeParams.z\n#define heightScale uniforms.sizeParams.w\n@fragment fn main(input : FragmentInputs)->FragmentOutputs {var uv : vec2f=\nvec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var backgroundColour: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgba;var depth : vec4f=textureSample(depthSampler,depthSamplerSampler,input.vUV);var worldNormal: vec4f=textureSample(normalSampler,normalSamplerSampler,input.vUV);var worldPosition : vec4f=textureSample(positionSampler,positionSamplerSampler,input.vUV);var velocityLinear : vec4f=textureSample(velocitySampler,velocitySamplerSampler,input.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=backgroundColour;} else {if (uv.x<=0.25) {fragmentOutputs.color=vec4f(depth.rgb,1.0);} else if (uv.x<=0.5) {velocityLinear =\nvec4f(velocityLinear.r*0.5+0.5,velocityLinear.g*0.5+0.5,\nvelocityLinear.b,velocityLinear.a);fragmentOutputs.color=vec4f(velocityLinear.rgb,1.0);} else if (uv.x<=0.75) {fragmentOutputs.color=vec4f(worldPosition.rgb,1.0);} else {fragmentOutputs.color=vec4f(worldNormal.rgb,1.0);}}}";bt$1.ShadersStoreWGSL[r$1]||(bt$1.ShadersStoreWGSL[r$1]=a$1);const t={name:r$1,shader:a$1};var iblShadowGBufferDebug_fragmentD296cOf0_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowGBufferDebugPixelShaderWGSL:t});const r="iblShadowGBufferDebugPixelShader",o="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;uniform sampler2D velocitySampler;uniform vec4 sizeParams;uniform float maxDepth;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\nvoid main(void) {vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 backgroundColour=texture2D(textureSampler,vUV).rgba;vec4 depth=texture2D(depthSampler,vUV);vec4 worldNormal=texture2D(normalSampler,vUV);vec4 worldPosition=texture2D(positionSampler,vUV);vec4 velocityLinear=texture2D(velocitySampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=backgroundColour;} else {gl_FragColor.a=1.0;if (uv.x<=0.25) {gl_FragColor.rgb=depth.rgb;gl_FragColor.a=1.0;} else if (uv.x<=0.5) {velocityLinear.rg=velocityLinear.rg*0.5+0.5;gl_FragColor.rgb=velocityLinear.rgb;} else if (uv.x<=0.75) {gl_FragColor.rgb=worldPosition.rgb;} else {gl_FragColor.rgb=worldNormal.rgb;}}}";bt$1.ShadersStore[r]||(bt$1.ShadersStore[r]=o);const a={name:r,shader:o};var iblShadowGBufferDebug_fragmentDmLbzf9O_esm_min=/*#__PURE__*/Object.freeze({__proto__:null,iblShadowGBufferDebugPixelShader:a});export{dd as ConfigureCustomViewerElement,yc as CreateHotSpotFromCamera,nd as CreateViewerForCanvas,Ic as DefaultViewerOptions,_d as HTML3DAnnotationElement,ud as HTML3DElement,Pc as Viewer,cd as ViewerElement,vc as ViewerHotSpotResult};